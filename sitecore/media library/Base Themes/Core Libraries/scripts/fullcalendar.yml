---
ID: "aed1c35e-3247-496a-ba13-b3d33cc35b93"
Parent: "e3fbf2bd-14b5-439f-b488-478701f1bae1"
Template: "962b53c4-f93b-4df9-9821-415c867b8903"
Path: /sitecore/media library/Base Themes/Core Libraries/scripts/fullcalendar
DB: master
SharedFields:
- ID: "06d5295c-ed2f-4a54-9bf2-26228d113318"
  Hint: __Icon
  Value: "-/media/AED1C35E3247496ABA13B3D33CC35B93.ashx?h=16&thn=1&w=16"
- ID: "40e50ed9-ba07-4702-992e-a912738d32dc"
  Hint: Blob
  Value: LyohCiAqIEZ1bGxDYWxlbmRhciB2My44LjEKICogRG9jcyAmIExpY2Vuc2U6IGh0dHBzOi8vZnVsbGNhbGVuZGFyLmlvLwogKiAoYykgMjAxNyBBZGFtIFNoYXcKICovCihmdW5jdGlvbiB3ZWJwYWNrVW5pdmVyc2FsTW9kdWxlRGVmaW5pdGlvbihyb290LCBmYWN0b3J5KSB7CglpZih0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcpCgkJbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmUoIm1vbWVudCIpLCByZXF1aXJlKCJqcXVlcnkiKSk7CgllbHNlIGlmKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkKCQlkZWZpbmUoWyJtb21lbnQiLCAianF1ZXJ5Il0sIGZhY3RvcnkpOwoJZWxzZSBpZih0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpCgkJZXhwb3J0c1siRnVsbENhbGVuZGFyIl0gPSBmYWN0b3J5KHJlcXVpcmUoIm1vbWVudCIpLCByZXF1aXJlKCJqcXVlcnkiKSk7CgllbHNlCgkJcm9vdFsiRnVsbENhbGVuZGFyIl0gPSBmYWN0b3J5KHJvb3RbIm1vbWVudCJdLCByb290WyJqUXVlcnkiXSk7Cn0pKHR5cGVvZiBzZWxmICE9PSAndW5kZWZpbmVkJyA/IHNlbGYgOiB0aGlzLCBmdW5jdGlvbihfX1dFQlBBQ0tfRVhURVJOQUxfTU9EVUxFXzBfXywgX19XRUJQQUNLX0VYVEVSTkFMX01PRFVMRV8zX18pIHsKcmV0dXJuIC8qKioqKiovIChmdW5jdGlvbihtb2R1bGVzKSB7IC8vIHdlYnBhY2tCb290c3RyYXAKLyoqKioqKi8gCS8vIFRoZSBtb2R1bGUgY2FjaGUKLyoqKioqKi8gCXZhciBpbnN0YWxsZWRNb2R1bGVzID0ge307Ci8qKioqKiovCi8qKioqKiovIAkvLyBUaGUgcmVxdWlyZSBmdW5jdGlvbgovKioqKioqLyAJZnVuY3Rpb24gX193ZWJwYWNrX3JlcXVpcmVfXyhtb2R1bGVJZCkgewovKioqKioqLwovKioqKioqLyAJCS8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZQovKioqKioqLyAJCWlmKGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdKSB7Ci8qKioqKiovIAkJCXJldHVybiBpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXS5leHBvcnRzOwovKioqKioqLyAJCX0KLyoqKioqKi8gCQkvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIChhbmQgcHV0IGl0IGludG8gdGhlIGNhY2hlKQovKioqKioqLyAJCXZhciBtb2R1bGUgPSBpbnN0YWxsZWRNb2R1bGVzW21vZHVsZUlkXSA9IHsKLyoqKioqKi8gCQkJaTogbW9kdWxlSWQsCi8qKioqKiovIAkJCWw6IGZhbHNlLAovKioqKioqLyAJCQlleHBvcnRzOiB7fQovKioqKioqLyAJCX07Ci8qKioqKiovCi8qKioqKiovIAkJLy8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uCi8qKioqKiovIAkJbW9kdWxlc1ttb2R1bGVJZF0uY2FsbChtb2R1bGUuZXhwb3J0cywgbW9kdWxlLCBtb2R1bGUuZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyk7Ci8qKioqKiovCi8qKioqKiovIAkJLy8gRmxhZyB0aGUgbW9kdWxlIGFzIGxvYWRlZAovKioqKioqLyAJCW1vZHVsZS5sID0gdHJ1ZTsKLyoqKioqKi8KLyoqKioqKi8gCQkvLyBSZXR1cm4gdGhlIGV4cG9ydHMgb2YgdGhlIG1vZHVsZQovKioqKioqLyAJCXJldHVybiBtb2R1bGUuZXhwb3J0czsKLyoqKioqKi8gCX0KLyoqKioqKi8KLyoqKioqKi8KLyoqKioqKi8gCS8vIGV4cG9zZSB0aGUgbW9kdWxlcyBvYmplY3QgKF9fd2VicGFja19tb2R1bGVzX18pCi8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fLm0gPSBtb2R1bGVzOwovKioqKioqLwovKioqKioqLyAJLy8gZXhwb3NlIHRoZSBtb2R1bGUgY2FjaGUKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18uYyA9IGluc3RhbGxlZE1vZHVsZXM7Ci8qKioqKiovCi8qKioqKiovIAkvLyBkZWZpbmUgZ2V0dGVyIGZ1bmN0aW9uIGZvciBoYXJtb255IGV4cG9ydHMKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18uZCA9IGZ1bmN0aW9uKGV4cG9ydHMsIG5hbWUsIGdldHRlcikgewovKioqKioqLyAJCWlmKCFfX3dlYnBhY2tfcmVxdWlyZV9fLm8oZXhwb3J0cywgbmFtZSkpIHsKLyoqKioqKi8gCQkJT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIG5hbWUsIHsKLyoqKioqKi8gCQkJCWNvbmZpZ3VyYWJsZTogZmFsc2UsCi8qKioqKiovIAkJCQllbnVtZXJhYmxlOiB0cnVlLAovKioqKioqLyAJCQkJZ2V0OiBnZXR0ZXIKLyoqKioqKi8gCQkJfSk7Ci8qKioqKiovIAkJfQovKioqKioqLyAJfTsKLyoqKioqKi8KLyoqKioqKi8gCS8vIGdldERlZmF1bHRFeHBvcnQgZnVuY3Rpb24gZm9yIGNvbXBhdGliaWxpdHkgd2l0aCBub24taGFybW9ueSBtb2R1bGVzCi8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fLm4gPSBmdW5jdGlvbihtb2R1bGUpIHsKLyoqKioqKi8gCQl2YXIgZ2V0dGVyID0gbW9kdWxlICYmIG1vZHVsZS5fX2VzTW9kdWxlID8KLyoqKioqKi8gCQkJZnVuY3Rpb24gZ2V0RGVmYXVsdCgpIHsgcmV0dXJuIG1vZHVsZVsnZGVmYXVsdCddOyB9IDoKLyoqKioqKi8gCQkJZnVuY3Rpb24gZ2V0TW9kdWxlRXhwb3J0cygpIHsgcmV0dXJuIG1vZHVsZTsgfTsKLyoqKioqKi8gCQlfX3dlYnBhY2tfcmVxdWlyZV9fLmQoZ2V0dGVyLCAnYScsIGdldHRlcik7Ci8qKioqKiovIAkJcmV0dXJuIGdldHRlcjsKLyoqKioqKi8gCX07Ci8qKioqKiovCi8qKioqKiovIAkvLyBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18ubyA9IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHkpIHsgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIHByb3BlcnR5KTsgfTsKLyoqKioqKi8KLyoqKioqKi8gCS8vIF9fd2VicGFja19wdWJsaWNfcGF0aF9fCi8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fLnAgPSAiIjsKLyoqKioqKi8KLyoqKioqKi8gCS8vIExvYWQgZW50cnkgbW9kdWxlIGFuZCByZXR1cm4gZXhwb3J0cwovKioqKioqLyAJcmV0dXJuIF9fd2VicGFja19yZXF1aXJlX18oX193ZWJwYWNrX3JlcXVpcmVfXy5zID0gMjM2KTsKLyoqKioqKi8gfSkKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKi8gKFsKLyogMCAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzKSB7Cgptb2R1bGUuZXhwb3J0cyA9IF9fV0VCUEFDS19FWFRFUk5BTF9NT0RVTEVfMF9fOwoKLyoqKi8gfSksCi8qIDEgKi8sCi8qIDIgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cykgewoKLyoNCmRlcml2ZWQgZnJvbToNCmh0dHBzOi8vZ2l0aHViLmNvbS9NaWNyb3NvZnQvdHNsaWIvYmxvYi92MS42LjAvdHNsaWIuanMNCgpvbmx5IGluY2x1ZGUgdGhlIGhlbHBlcnMgd2UgbmVlZCwgdG8ga2VlcCBkb3duIGZpbGVzaXplDQoqLw0KdmFyIGV4dGVuZFN0YXRpY3MgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHwNCiAgICAoeyBfX3Byb3RvX186IFtdIH0gaW5zdGFuY2VvZiBBcnJheSAmJiBmdW5jdGlvbiAoZCwgYikgeyBkLl9fcHJvdG9fXyA9IGI7IH0pIHx8DQogICAgZnVuY3Rpb24gKGQsIGIpIHsgZm9yICh2YXIgcCBpbiBiKQ0KICAgICAgICBpZiAoYi5oYXNPd25Qcm9wZXJ0eShwKSkNCiAgICAgICAgICAgIGRbcF0gPSBiW3BdOyB9Ow0KZXhwb3J0cy5fX2V4dGVuZHMgPSBmdW5jdGlvbiAoZCwgYikgew0KICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7DQogICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9DQogICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpOw0KfTsNCgoKLyoqKi8gfSksCi8qIDMgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cykgewoKbW9kdWxlLmV4cG9ydHMgPSBfX1dFQlBBQ0tfRVhURVJOQUxfTU9EVUxFXzNfXzsKCi8qKiovIH0pLAovKiA0ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgbW9tZW50ID0gX193ZWJwYWNrX3JlcXVpcmVfXygwKTsNCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCi8qIEZ1bGxDYWxlbmRhci1zcGVjaWZpYyBET00gVXRpbGl0aWVzDQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCi8vIEdpdmVuIHRoZSBzY3JvbGxiYXIgd2lkdGhzIG9mIHNvbWUgb3RoZXIgY29udGFpbmVyLCBjcmVhdGUgYm9yZGVycy9tYXJnaW5zIG9uIHJvd0VscyBpbiBvcmRlciB0byBtYXRjaCB0aGUgbGVmdA0KLy8gYW5kIHJpZ2h0IHNwYWNlIHRoYXQgd2FzIG9mZnNldCBieSB0aGUgc2Nyb2xsYmFycy4gQSAxLXBpeGVsIGJvcmRlciBmaXJzdCwgdGhlbiBtYXJnaW4gYmV5b25kIHRoYXQuDQpmdW5jdGlvbiBjb21wZW5zYXRlU2Nyb2xsKHJvd0Vscywgc2Nyb2xsYmFyV2lkdGhzKSB7DQogICAgaWYgKHNjcm9sbGJhcldpZHRocy5sZWZ0KSB7DQogICAgICAgIHJvd0Vscy5jc3Moew0KICAgICAgICAgICAgJ2JvcmRlci1sZWZ0LXdpZHRoJzogMSwNCiAgICAgICAgICAgICdtYXJnaW4tbGVmdCc6IHNjcm9sbGJhcldpZHRocy5sZWZ0IC0gMQ0KICAgICAgICB9KTsNCiAgICB9DQogICAgaWYgKHNjcm9sbGJhcldpZHRocy5yaWdodCkgew0KICAgICAgICByb3dFbHMuY3NzKHsNCiAgICAgICAgICAgICdib3JkZXItcmlnaHQtd2lkdGgnOiAxLA0KICAgICAgICAgICAgJ21hcmdpbi1yaWdodCc6IHNjcm9sbGJhcldpZHRocy5yaWdodCAtIDENCiAgICAgICAgfSk7DQogICAgfQ0KfQ0KZXhwb3J0cy5jb21wZW5zYXRlU2Nyb2xsID0gY29tcGVuc2F0ZVNjcm9sbDsNCi8vIFVuZG9lcyBjb21wZW5zYXRlU2Nyb2xsIGFuZCByZXN0b3JlcyBhbGwgYm9yZGVycy9tYXJnaW5zDQpmdW5jdGlvbiB1bmNvbXBlbnNhdGVTY3JvbGwocm93RWxzKSB7DQogICAgcm93RWxzLmNzcyh7DQogICAgICAgICdtYXJnaW4tbGVmdCc6ICcnLA0KICAgICAgICAnbWFyZ2luLXJpZ2h0JzogJycsDQogICAgICAgICdib3JkZXItbGVmdC13aWR0aCc6ICcnLA0KICAgICAgICAnYm9yZGVyLXJpZ2h0LXdpZHRoJzogJycNCiAgICB9KTsNCn0NCmV4cG9ydHMudW5jb21wZW5zYXRlU2Nyb2xsID0gdW5jb21wZW5zYXRlU2Nyb2xsOw0KLy8gTWFrZSB0aGUgbW91c2UgY3Vyc29yIGV4cHJlc3MgdGhhdCBhbiBldmVudCBpcyBub3QgYWxsb3dlZCBpbiB0aGUgY3VycmVudCBhcmVhDQpmdW5jdGlvbiBkaXNhYmxlQ3Vyc29yKCkgew0KICAgICQoJ2JvZHknKS5hZGRDbGFzcygnZmMtbm90LWFsbG93ZWQnKTsNCn0NCmV4cG9ydHMuZGlzYWJsZUN1cnNvciA9IGRpc2FibGVDdXJzb3I7DQovLyBSZXR1cm5zIHRoZSBtb3VzZSBjdXJzb3IgdG8gaXRzIG9yaWdpbmFsIGxvb2sNCmZ1bmN0aW9uIGVuYWJsZUN1cnNvcigpIHsNCiAgICAkKCdib2R5JykucmVtb3ZlQ2xhc3MoJ2ZjLW5vdC1hbGxvd2VkJyk7DQp9DQpleHBvcnRzLmVuYWJsZUN1cnNvciA9IGVuYWJsZUN1cnNvcjsNCi8vIEdpdmVuIGEgdG90YWwgYXZhaWxhYmxlIGhlaWdodCB0byBmaWxsLCBoYXZlIGBlbHNgIChlc3NlbnRpYWxseSBjaGlsZCByb3dzKSBleHBhbmQgdG8gYWNjb21vZGF0ZS4NCi8vIEJ5IGRlZmF1bHQsIGFsbCBlbGVtZW50cyB0aGF0IGFyZSBzaG9ydGVyIHRoYW4gdGhlIHJlY29tbWVuZGVkIGhlaWdodCBhcmUgZXhwYW5kZWQgdW5pZm9ybWx5LCBub3QgY29uc2lkZXJpbmcNCi8vIGFueSBvdGhlciBlbHMgdGhhdCBhcmUgYWxyZWFkeSB0b28gdGFsbC4gaWYgYHNob3VsZFJlZGlzdHJpYnV0ZWAgaXMgb24sIGl0IGNvbnNpZGVycyB0aGVzZSB0YWxsIHJvd3MgYW5kDQovLyByZWR1Y2VzIHRoZSBhdmFpbGFibGUgaGVpZ2h0Lg0KZnVuY3Rpb24gZGlzdHJpYnV0ZUhlaWdodChlbHMsIGF2YWlsYWJsZUhlaWdodCwgc2hvdWxkUmVkaXN0cmlidXRlKSB7DQogICAgLy8gKkZMT09SSU5HIE5PVEUqOiB3ZSBmbG9vciBpbiBjZXJ0YWluIHBsYWNlcyBiZWNhdXNlIHpvb20gY2FuIGdpdmUgaW5hY2N1cmF0ZSBmbG9hdGluZy1wb2ludCBkaW1lbnNpb25zLA0KICAgIC8vIGFuZCBpdCBpcyBiZXR0ZXIgdG8gYmUgc2hvcnRlciB0aGFuIHRhbGxlciwgdG8gYXZvaWQgY3JlYXRpbmcgdW5uZWNlc3Nhcnkgc2Nyb2xsYmFycy4NCiAgICB2YXIgbWluT2Zmc2V0MSA9IE1hdGguZmxvb3IoYXZhaWxhYmxlSGVpZ2h0IC8gZWxzLmxlbmd0aCk7IC8vIGZvciBub24tbGFzdCBlbGVtZW50DQogICAgdmFyIG1pbk9mZnNldDIgPSBNYXRoLmZsb29yKGF2YWlsYWJsZUhlaWdodCAtIG1pbk9mZnNldDEgKiAoZWxzLmxlbmd0aCAtIDEpKTsgLy8gZm9yIGxhc3QgZWxlbWVudCAqRkxPT1JJTkcgTk9URSoNCiAgICB2YXIgZmxleEVscyA9IFtdOyAvLyBlbGVtZW50cyB0aGF0IGFyZSBhbGxvd2VkIHRvIGV4cGFuZC4gYXJyYXkgb2YgRE9NIG5vZGVzDQogICAgdmFyIGZsZXhPZmZzZXRzID0gW107IC8vIGFtb3VudCBvZiB2ZXJ0aWNhbCBzcGFjZSBpdCB0YWtlcyB1cA0KICAgIHZhciBmbGV4SGVpZ2h0cyA9IFtdOyAvLyBhY3R1YWwgY3NzIGhlaWdodA0KICAgIHZhciB1c2VkSGVpZ2h0ID0gMDsNCiAgICB1bmRpc3RyaWJ1dGVIZWlnaHQoZWxzKTsgLy8gZ2l2ZSBhbGwgZWxlbWVudHMgdGhlaXIgbmF0dXJhbCBoZWlnaHQNCiAgICAvLyBmaW5kIGVsZW1lbnRzIHRoYXQgYXJlIGJlbG93IHRoZSByZWNvbW1lbmRlZCBoZWlnaHQgKGV4cGFuZGFibGUpLg0KICAgIC8vIGltcG9ydGFudCB0byBxdWVyeSBmb3IgaGVpZ2h0cyBpbiBhIHNpbmdsZSBmaXJzdCBwYXNzICh0byBhdm9pZCByZWZsb3cgb3NjaWxsYXRpb24pLg0KICAgIGVscy5lYWNoKGZ1bmN0aW9uIChpLCBlbCkgew0KICAgICAgICB2YXIgbWluT2Zmc2V0ID0gaSA9PT0gZWxzLmxlbmd0aCAtIDEgPyBtaW5PZmZzZXQyIDogbWluT2Zmc2V0MTsNCiAgICAgICAgdmFyIG5hdHVyYWxPZmZzZXQgPSAkKGVsKS5vdXRlckhlaWdodCh0cnVlKTsNCiAgICAgICAgaWYgKG5hdHVyYWxPZmZzZXQgPCBtaW5PZmZzZXQpIHsNCiAgICAgICAgICAgIGZsZXhFbHMucHVzaChlbCk7DQogICAgICAgICAgICBmbGV4T2Zmc2V0cy5wdXNoKG5hdHVyYWxPZmZzZXQpOw0KICAgICAgICAgICAgZmxleEhlaWdodHMucHVzaCgkKGVsKS5oZWlnaHQoKSk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAvLyB0aGlzIGVsZW1lbnQgc3RyZXRjaGVzIHBhc3QgcmVjb21tZW5kZWQgaGVpZ2h0IChub24tZXhwYW5kYWJsZSkuIG1hcmsgdGhlIHNwYWNlIGFzIG9jY3VwaWVkLg0KICAgICAgICAgICAgdXNlZEhlaWdodCArPSBuYXR1cmFsT2Zmc2V0Ow0KICAgICAgICB9DQogICAgfSk7DQogICAgLy8gcmVhZGp1c3QgdGhlIHJlY29tbWVuZGVkIGhlaWdodCB0byBvbmx5IGNvbnNpZGVyIHRoZSBoZWlnaHQgYXZhaWxhYmxlIHRvIG5vbi1tYXhlZC1vdXQgcm93cy4NCiAgICBpZiAoc2hvdWxkUmVkaXN0cmlidXRlKSB7DQogICAgICAgIGF2YWlsYWJsZUhlaWdodCAtPSB1c2VkSGVpZ2h0Ow0KICAgICAgICBtaW5PZmZzZXQxID0gTWF0aC5mbG9vcihhdmFpbGFibGVIZWlnaHQgLyBmbGV4RWxzLmxlbmd0aCk7DQogICAgICAgIG1pbk9mZnNldDIgPSBNYXRoLmZsb29yKGF2YWlsYWJsZUhlaWdodCAtIG1pbk9mZnNldDEgKiAoZmxleEVscy5sZW5ndGggLSAxKSk7IC8vICpGTE9PUklORyBOT1RFKg0KICAgIH0NCiAgICAvLyBhc3NpZ24gaGVpZ2h0cyB0byBhbGwgZXhwYW5kYWJsZSBlbGVtZW50cw0KICAgICQoZmxleEVscykuZWFjaChmdW5jdGlvbiAoaSwgZWwpIHsNCiAgICAgICAgdmFyIG1pbk9mZnNldCA9IGkgPT09IGZsZXhFbHMubGVuZ3RoIC0gMSA/IG1pbk9mZnNldDIgOiBtaW5PZmZzZXQxOw0KICAgICAgICB2YXIgbmF0dXJhbE9mZnNldCA9IGZsZXhPZmZzZXRzW2ldOw0KICAgICAgICB2YXIgbmF0dXJhbEhlaWdodCA9IGZsZXhIZWlnaHRzW2ldOw0KICAgICAgICB2YXIgbmV3SGVpZ2h0ID0gbWluT2Zmc2V0IC0gKG5hdHVyYWxPZmZzZXQgLSBuYXR1cmFsSGVpZ2h0KTsgLy8gc3VidHJhY3QgdGhlIG1hcmdpbi9wYWRkaW5nDQogICAgICAgIGlmIChuYXR1cmFsT2Zmc2V0IDwgbWluT2Zmc2V0KSB7DQogICAgICAgICAgICAkKGVsKS5oZWlnaHQobmV3SGVpZ2h0KTsNCiAgICAgICAgfQ0KICAgIH0pOw0KfQ0KZXhwb3J0cy5kaXN0cmlidXRlSGVpZ2h0ID0gZGlzdHJpYnV0ZUhlaWdodDsNCi8vIFVuZG9lcyBkaXN0cnVidXRlSGVpZ2h0LCByZXN0b3JpbmcgYWxsIGVscyB0byB0aGVpciBuYXR1cmFsIGhlaWdodA0KZnVuY3Rpb24gdW5kaXN0cmlidXRlSGVpZ2h0KGVscykgew0KICAgIGVscy5oZWlnaHQoJycpOw0KfQ0KZXhwb3J0cy51bmRpc3RyaWJ1dGVIZWlnaHQgPSB1bmRpc3RyaWJ1dGVIZWlnaHQ7DQovLyBHaXZlbiBgZWxzYCwgYSBqUXVlcnkgc2V0IG9mIDx0ZD4gY2VsbHMsIGZpbmQgdGhlIGNlbGwgd2l0aCB0aGUgbGFyZ2VzdCBuYXR1cmFsIHdpZHRoIGFuZCBzZXQgdGhlIHdpZHRocyBvZiBhbGwgdGhlDQovLyBjZWxscyB0byBiZSB0aGF0IHdpZHRoLg0KLy8gUFJFUkVRVUlTSVRFOiBpZiB5b3Ugd2FudCBhIGNlbGwgdG8gdGFrZSB1cCB3aWR0aCwgaXQgbmVlZHMgdG8gaGF2ZSBhIHNpbmdsZSBpbm5lciBlbGVtZW50IHcvIGRpc3BsYXk6aW5saW5lDQpmdW5jdGlvbiBtYXRjaENlbGxXaWR0aHMoZWxzKSB7DQogICAgdmFyIG1heElubmVyV2lkdGggPSAwOw0KICAgIGVscy5maW5kKCc+IConKS5lYWNoKGZ1bmN0aW9uIChpLCBpbm5lckVsKSB7DQogICAgICAgIHZhciBpbm5lcldpZHRoID0gJChpbm5lckVsKS5vdXRlcldpZHRoKCk7DQogICAgICAgIGlmIChpbm5lcldpZHRoID4gbWF4SW5uZXJXaWR0aCkgew0KICAgICAgICAgICAgbWF4SW5uZXJXaWR0aCA9IGlubmVyV2lkdGg7DQogICAgICAgIH0NCiAgICB9KTsNCiAgICBtYXhJbm5lcldpZHRoKys7IC8vIHNvbWV0aW1lcyBub3QgYWNjdXJhdGUgb2Ygd2lkdGggdGhlIHRleHQgbmVlZHMgdG8gc3RheSBvbiBvbmUgbGluZS4gaW5zdXJhbmNlDQogICAgZWxzLndpZHRoKG1heElubmVyV2lkdGgpOw0KICAgIHJldHVybiBtYXhJbm5lcldpZHRoOw0KfQ0KZXhwb3J0cy5tYXRjaENlbGxXaWR0aHMgPSBtYXRjaENlbGxXaWR0aHM7DQovLyBHaXZlbiBvbmUgZWxlbWVudCB0aGF0IHJlc2lkZXMgaW5zaWRlIGFub3RoZXIsDQovLyBTdWJ0cmFjdHMgdGhlIGhlaWdodCBvZiB0aGUgaW5uZXIgZWxlbWVudCBmcm9tIHRoZSBvdXRlciBlbGVtZW50Lg0KZnVuY3Rpb24gc3VidHJhY3RJbm5lckVsSGVpZ2h0KG91dGVyRWwsIGlubmVyRWwpIHsNCiAgICB2YXIgYm90aCA9IG91dGVyRWwuYWRkKGlubmVyRWwpOw0KICAgIHZhciBkaWZmOw0KICAgIC8vIGVmZmluJyBJRTgvOS8xMC8xMSBzb21ldGltZXMgcmV0dXJucyAwIGZvciBkaW1lbnNpb25zLiB0aGlzIHdlaXJkIGhhY2sgd2FzIHRoZSBvbmx5IHRoaW5nIHRoYXQgd29ya2VkDQogICAgYm90aC5jc3Moew0KICAgICAgICBwb3NpdGlvbjogJ3JlbGF0aXZlJywNCiAgICAgICAgbGVmdDogLTEgLy8gZW5zdXJlIHJlZmxvdyBpbiBjYXNlIHRoZSBlbCB3YXMgYWxyZWFkeSByZWxhdGl2ZS4gbmVnYXRpdmUgaXMgbGVzcyBsaWtlbHkgdG8gY2F1c2UgbmV3IHNjcm9sbA0KICAgIH0pOw0KICAgIGRpZmYgPSBvdXRlckVsLm91dGVySGVpZ2h0KCkgLSBpbm5lckVsLm91dGVySGVpZ2h0KCk7IC8vIGdyYWIgdGhlIGRpbWVuc2lvbnMNCiAgICBib3RoLmNzcyh7IHBvc2l0aW9uOiAnJywgbGVmdDogJycgfSk7IC8vIHVuZG8gaGFjaw0KICAgIHJldHVybiBkaWZmOw0KfQ0KZXhwb3J0cy5zdWJ0cmFjdElubmVyRWxIZWlnaHQgPSBzdWJ0cmFjdElubmVyRWxIZWlnaHQ7DQovKiBFbGVtZW50IEdlb20gVXRpbGl0aWVzDQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCi8vIGJvcnJvd2VkIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktdWkvYmxvYi8xLjExLjAvdWkvY29yZS5qcyNMNTENCmZ1bmN0aW9uIGdldFNjcm9sbFBhcmVudChlbCkgew0KICAgIHZhciBwb3NpdGlvbiA9IGVsLmNzcygncG9zaXRpb24nKTsNCiAgICB2YXIgc2Nyb2xsUGFyZW50ID0gZWwucGFyZW50cygpLmZpbHRlcihmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBwYXJlbnQgPSAkKHRoaXMpOw0KICAgICAgICByZXR1cm4gKC8oYXV0b3xzY3JvbGwpLykudGVzdChwYXJlbnQuY3NzKCdvdmVyZmxvdycpICsgcGFyZW50LmNzcygnb3ZlcmZsb3cteScpICsgcGFyZW50LmNzcygnb3ZlcmZsb3cteCcpKTsNCiAgICB9KS5lcSgwKTsNCiAgICByZXR1cm4gcG9zaXRpb24gPT09ICdmaXhlZCcgfHwgIXNjcm9sbFBhcmVudC5sZW5ndGggPyAkKGVsWzBdLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQpIDogc2Nyb2xsUGFyZW50Ow0KfQ0KZXhwb3J0cy5nZXRTY3JvbGxQYXJlbnQgPSBnZXRTY3JvbGxQYXJlbnQ7DQovLyBRdWVyaWVzIHRoZSBvdXRlciBib3VuZGluZyBhcmVhIG9mIGEgalF1ZXJ5IGVsZW1lbnQuDQovLyBSZXR1cm5zIGEgcmVjdGFuZ2xlIHdpdGggYWJzb2x1dGUgY29vcmRpbmF0ZXM6IGxlZnQsIHJpZ2h0IChleGNsdXNpdmUpLCB0b3AsIGJvdHRvbSAoZXhjbHVzaXZlKS4NCi8vIE9yaWdpbiBpcyBvcHRpb25hbC4NCmZ1bmN0aW9uIGdldE91dGVyUmVjdChlbCwgb3JpZ2luKSB7DQogICAgdmFyIG9mZnNldCA9IGVsLm9mZnNldCgpOw0KICAgIHZhciBsZWZ0ID0gb2Zmc2V0LmxlZnQgLSAob3JpZ2luID8gb3JpZ2luLmxlZnQgOiAwKTsNCiAgICB2YXIgdG9wID0gb2Zmc2V0LnRvcCAtIChvcmlnaW4gPyBvcmlnaW4udG9wIDogMCk7DQogICAgcmV0dXJuIHsNCiAgICAgICAgbGVmdDogbGVmdCwNCiAgICAgICAgcmlnaHQ6IGxlZnQgKyBlbC5vdXRlcldpZHRoKCksDQogICAgICAgIHRvcDogdG9wLA0KICAgICAgICBib3R0b206IHRvcCArIGVsLm91dGVySGVpZ2h0KCkNCiAgICB9Ow0KfQ0KZXhwb3J0cy5nZXRPdXRlclJlY3QgPSBnZXRPdXRlclJlY3Q7DQovLyBRdWVyaWVzIHRoZSBhcmVhIHdpdGhpbiB0aGUgbWFyZ2luL2JvcmRlci9zY3JvbGxiYXJzIG9mIGEgalF1ZXJ5IGVsZW1lbnQuIERvZXMgbm90IGdvIHdpdGhpbiB0aGUgcGFkZGluZy4NCi8vIFJldHVybnMgYSByZWN0YW5nbGUgd2l0aCBhYnNvbHV0ZSBjb29yZGluYXRlczogbGVmdCwgcmlnaHQgKGV4Y2x1c2l2ZSksIHRvcCwgYm90dG9tIChleGNsdXNpdmUpLg0KLy8gT3JpZ2luIGlzIG9wdGlvbmFsLg0KLy8gV0FSTklORzogZ2l2ZW4gZWxlbWVudCBjYW4ndCBoYXZlIGJvcmRlcnMNCi8vIE5PVEU6IHNob3VsZCB1c2UgY2xpZW50TGVmdC9jbGllbnRUb3AsIGJ1dCB2ZXJ5IHVucmVsaWFibGUgY3Jvc3MtYnJvd3Nlci4NCmZ1bmN0aW9uIGdldENsaWVudFJlY3QoZWwsIG9yaWdpbikgew0KICAgIHZhciBvZmZzZXQgPSBlbC5vZmZzZXQoKTsNCiAgICB2YXIgc2Nyb2xsYmFyV2lkdGhzID0gZ2V0U2Nyb2xsYmFyV2lkdGhzKGVsKTsNCiAgICB2YXIgbGVmdCA9IG9mZnNldC5sZWZ0ICsgZ2V0Q3NzRmxvYXQoZWwsICdib3JkZXItbGVmdC13aWR0aCcpICsgc2Nyb2xsYmFyV2lkdGhzLmxlZnQgLSAob3JpZ2luID8gb3JpZ2luLmxlZnQgOiAwKTsNCiAgICB2YXIgdG9wID0gb2Zmc2V0LnRvcCArIGdldENzc0Zsb2F0KGVsLCAnYm9yZGVyLXRvcC13aWR0aCcpICsgc2Nyb2xsYmFyV2lkdGhzLnRvcCAtIChvcmlnaW4gPyBvcmlnaW4udG9wIDogMCk7DQogICAgcmV0dXJuIHsNCiAgICAgICAgbGVmdDogbGVmdCwNCiAgICAgICAgcmlnaHQ6IGxlZnQgKyBlbFswXS5jbGllbnRXaWR0aCwNCiAgICAgICAgdG9wOiB0b3AsDQogICAgICAgIGJvdHRvbTogdG9wICsgZWxbMF0uY2xpZW50SGVpZ2h0IC8vIGNsaWVudEhlaWdodCBpbmNsdWRlcyBwYWRkaW5nIGJ1dCBOT1Qgc2Nyb2xsYmFycw0KICAgIH07DQp9DQpleHBvcnRzLmdldENsaWVudFJlY3QgPSBnZXRDbGllbnRSZWN0Ow0KLy8gUXVlcmllcyB0aGUgYXJlYSB3aXRoaW4gdGhlIG1hcmdpbi9ib3JkZXIvcGFkZGluZyBvZiBhIGpRdWVyeSBlbGVtZW50LiBBc3N1bWVkIG5vdCB0byBoYXZlIHNjcm9sbGJhcnMuDQovLyBSZXR1cm5zIGEgcmVjdGFuZ2xlIHdpdGggYWJzb2x1dGUgY29vcmRpbmF0ZXM6IGxlZnQsIHJpZ2h0IChleGNsdXNpdmUpLCB0b3AsIGJvdHRvbSAoZXhjbHVzaXZlKS4NCi8vIE9yaWdpbiBpcyBvcHRpb25hbC4NCmZ1bmN0aW9uIGdldENvbnRlbnRSZWN0KGVsLCBvcmlnaW4pIHsNCiAgICB2YXIgb2Zmc2V0ID0gZWwub2Zmc2V0KCk7IC8vIGp1c3Qgb3V0c2lkZSBvZiBib3JkZXIsIG1hcmdpbiBub3QgaW5jbHVkZWQNCiAgICB2YXIgbGVmdCA9IG9mZnNldC5sZWZ0ICsgZ2V0Q3NzRmxvYXQoZWwsICdib3JkZXItbGVmdC13aWR0aCcpICsgZ2V0Q3NzRmxvYXQoZWwsICdwYWRkaW5nLWxlZnQnKSAtDQogICAgICAgIChvcmlnaW4gPyBvcmlnaW4ubGVmdCA6IDApOw0KICAgIHZhciB0b3AgPSBvZmZzZXQudG9wICsgZ2V0Q3NzRmxvYXQoZWwsICdib3JkZXItdG9wLXdpZHRoJykgKyBnZXRDc3NGbG9hdChlbCwgJ3BhZGRpbmctdG9wJykgLQ0KICAgICAgICAob3JpZ2luID8gb3JpZ2luLnRvcCA6IDApOw0KICAgIHJldHVybiB7DQogICAgICAgIGxlZnQ6IGxlZnQsDQogICAgICAgIHJpZ2h0OiBsZWZ0ICsgZWwud2lkdGgoKSwNCiAgICAgICAgdG9wOiB0b3AsDQogICAgICAgIGJvdHRvbTogdG9wICsgZWwuaGVpZ2h0KCkNCiAgICB9Ow0KfQ0KZXhwb3J0cy5nZXRDb250ZW50UmVjdCA9IGdldENvbnRlbnRSZWN0Ow0KLy8gUmV0dXJucyB0aGUgY29tcHV0ZWQgbGVmdC9yaWdodC90b3AvYm90dG9tIHNjcm9sbGJhciB3aWR0aHMgZm9yIHRoZSBnaXZlbiBqUXVlcnkgZWxlbWVudC4NCi8vIFdBUk5JTkc6IGdpdmVuIGVsZW1lbnQgY2FuJ3QgaGF2ZSBib3JkZXJzICh3aGljaCB3aWxsIGNhdXNlIG9mZnNldFdpZHRoL29mZnNldEhlaWdodCB0byBiZSBsYXJnZXIpLg0KLy8gTk9URTogc2hvdWxkIHVzZSBjbGllbnRMZWZ0L2NsaWVudFRvcCwgYnV0IHZlcnkgdW5yZWxpYWJsZSBjcm9zcy1icm93c2VyLg0KZnVuY3Rpb24gZ2V0U2Nyb2xsYmFyV2lkdGhzKGVsKSB7DQogICAgdmFyIGxlZnRSaWdodFdpZHRoID0gZWxbMF0ub2Zmc2V0V2lkdGggLSBlbFswXS5jbGllbnRXaWR0aDsNCiAgICB2YXIgYm90dG9tV2lkdGggPSBlbFswXS5vZmZzZXRIZWlnaHQgLSBlbFswXS5jbGllbnRIZWlnaHQ7DQogICAgdmFyIHdpZHRoczsNCiAgICBsZWZ0UmlnaHRXaWR0aCA9IHNhbml0aXplU2Nyb2xsYmFyV2lkdGgobGVmdFJpZ2h0V2lkdGgpOw0KICAgIGJvdHRvbVdpZHRoID0gc2FuaXRpemVTY3JvbGxiYXJXaWR0aChib3R0b21XaWR0aCk7DQogICAgd2lkdGhzID0geyBsZWZ0OiAwLCByaWdodDogMCwgdG9wOiAwLCBib3R0b206IGJvdHRvbVdpZHRoIH07DQogICAgaWYgKGdldElzTGVmdFJ0bFNjcm9sbGJhcnMoKSAmJiBlbC5jc3MoJ2RpcmVjdGlvbicpID09PSAncnRsJykgew0KICAgICAgICB3aWR0aHMubGVmdCA9IGxlZnRSaWdodFdpZHRoOw0KICAgIH0NCiAgICBlbHNlIHsNCiAgICAgICAgd2lkdGhzLnJpZ2h0ID0gbGVmdFJpZ2h0V2lkdGg7DQogICAgfQ0KICAgIHJldHVybiB3aWR0aHM7DQp9DQpleHBvcnRzLmdldFNjcm9sbGJhcldpZHRocyA9IGdldFNjcm9sbGJhcldpZHRoczsNCi8vIFRoZSBzY3JvbGxiYXIgd2lkdGggY29tcHV0YXRpb25zIGluIGdldFNjcm9sbGJhcldpZHRocyBhcmUgc29tZXRpbWVzIGZsYXdlZCB3aGVuIGl0IGNvbWVzIHRvDQovLyByZXRpbmEgZGlzcGxheXMsIHJvdW5kaW5nLCBhbmQgSUUxMS4gTWFzc2FnZSB0aGVtIGludG8gYSB1c2FibGUgdmFsdWUuDQpmdW5jdGlvbiBzYW5pdGl6ZVNjcm9sbGJhcldpZHRoKHdpZHRoKSB7DQogICAgd2lkdGggPSBNYXRoLm1heCgwLCB3aWR0aCk7IC8vIG5vIG5lZ2F0aXZlcw0KICAgIHdpZHRoID0gTWF0aC5yb3VuZCh3aWR0aCk7DQogICAgcmV0dXJuIHdpZHRoOw0KfQ0KLy8gTG9naWMgZm9yIGRldGVybWluaW5nIGlmLCB3aGVuIHRoZSBlbGVtZW50IGlzIHJpZ2h0LXRvLWxlZnQsIHRoZSBzY3JvbGxiYXIgYXBwZWFycyBvbiB0aGUgbGVmdCBzaWRlDQp2YXIgX2lzTGVmdFJ0bFNjcm9sbGJhcnMgPSBudWxsOw0KZnVuY3Rpb24gZ2V0SXNMZWZ0UnRsU2Nyb2xsYmFycygpIHsNCiAgICBpZiAoX2lzTGVmdFJ0bFNjcm9sbGJhcnMgPT09IG51bGwpIHsNCiAgICAgICAgX2lzTGVmdFJ0bFNjcm9sbGJhcnMgPSBjb21wdXRlSXNMZWZ0UnRsU2Nyb2xsYmFycygpOw0KICAgIH0NCiAgICByZXR1cm4gX2lzTGVmdFJ0bFNjcm9sbGJhcnM7DQp9DQpmdW5jdGlvbiBjb21wdXRlSXNMZWZ0UnRsU2Nyb2xsYmFycygpIHsNCiAgICB2YXIgZWwgPSAkKCc8ZGl2PjxkaXYvPjwvZGl2PicpDQogICAgICAgIC5jc3Moew0KICAgICAgICBwb3NpdGlvbjogJ2Fic29sdXRlJywNCiAgICAgICAgdG9wOiAtMTAwMCwNCiAgICAgICAgbGVmdDogMCwNCiAgICAgICAgYm9yZGVyOiAwLA0KICAgICAgICBwYWRkaW5nOiAwLA0KICAgICAgICBvdmVyZmxvdzogJ3Njcm9sbCcsDQogICAgICAgIGRpcmVjdGlvbjogJ3J0bCcNCiAgICB9KQ0KICAgICAgICAuYXBwZW5kVG8oJ2JvZHknKTsNCiAgICB2YXIgaW5uZXJFbCA9IGVsLmNoaWxkcmVuKCk7DQogICAgdmFyIHJlcyA9IGlubmVyRWwub2Zmc2V0KCkubGVmdCA+IGVsLm9mZnNldCgpLmxlZnQ7IC8vIGlzIHRoZSBpbm5lciBkaXYgc2hpZnRlZCB0byBhY2NvbW1vZGF0ZSBhIGxlZnQgc2Nyb2xsYmFyPw0KICAgIGVsLnJlbW92ZSgpOw0KICAgIHJldHVybiByZXM7DQp9DQovLyBSZXRyaWV2ZXMgYSBqUXVlcnkgZWxlbWVudCdzIGNvbXB1dGVkIENTUyB2YWx1ZSBhcyBhIGZsb2F0aW5nLXBvaW50IG51bWJlci4NCi8vIElmIHRoZSBxdWVyaWVkIHZhbHVlIGlzIG5vbi1udW1lcmljIChleDogSUUgY2FuIHJldHVybiAibWVkaXVtIiBmb3IgYm9yZGVyIHdpZHRoKSwgd2lsbCBqdXN0IHJldHVybiB6ZXJvLg0KZnVuY3Rpb24gZ2V0Q3NzRmxvYXQoZWwsIHByb3ApIHsNCiAgICByZXR1cm4gcGFyc2VGbG9hdChlbC5jc3MocHJvcCkpIHx8IDA7DQp9DQovKiBNb3VzZSAvIFRvdWNoIFV0aWxpdGllcw0KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQovLyBSZXR1cm5zIGEgYm9vbGVhbiB3aGV0aGVyIHRoaXMgd2FzIGEgbGVmdCBtb3VzZSBjbGljayBhbmQgbm8gY3RybCBrZXkgKHdoaWNoIG1lYW5zIHJpZ2h0IGNsaWNrIG9uIE1hYykNCmZ1bmN0aW9uIGlzUHJpbWFyeU1vdXNlQnV0dG9uKGV2KSB7DQogICAgcmV0dXJuIGV2LndoaWNoID09PSAxICYmICFldi5jdHJsS2V5Ow0KfQ0KZXhwb3J0cy5pc1ByaW1hcnlNb3VzZUJ1dHRvbiA9IGlzUHJpbWFyeU1vdXNlQnV0dG9uOw0KZnVuY3Rpb24gZ2V0RXZYKGV2KSB7DQogICAgdmFyIHRvdWNoZXMgPSBldi5vcmlnaW5hbEV2ZW50LnRvdWNoZXM7DQogICAgLy8gb24gbW9iaWxlIEZGLCBwYWdlWCBmb3IgdG91Y2ggZXZlbnRzIGlzIHByZXNlbnQsIGJ1dCBpbmNvcnJlY3QsDQogICAgLy8gc28sIGxvb2sgYXQgdG91Y2ggY29vcmRpbmF0ZXMgZmlyc3QuDQogICAgaWYgKHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGgpIHsNCiAgICAgICAgcmV0dXJuIHRvdWNoZXNbMF0ucGFnZVg7DQogICAgfQ0KICAgIHJldHVybiBldi5wYWdlWDsNCn0NCmV4cG9ydHMuZ2V0RXZYID0gZ2V0RXZYOw0KZnVuY3Rpb24gZ2V0RXZZKGV2KSB7DQogICAgdmFyIHRvdWNoZXMgPSBldi5vcmlnaW5hbEV2ZW50LnRvdWNoZXM7DQogICAgLy8gb24gbW9iaWxlIEZGLCBwYWdlWCBmb3IgdG91Y2ggZXZlbnRzIGlzIHByZXNlbnQsIGJ1dCBpbmNvcnJlY3QsDQogICAgLy8gc28sIGxvb2sgYXQgdG91Y2ggY29vcmRpbmF0ZXMgZmlyc3QuDQogICAgaWYgKHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGgpIHsNCiAgICAgICAgcmV0dXJuIHRvdWNoZXNbMF0ucGFnZVk7DQogICAgfQ0KICAgIHJldHVybiBldi5wYWdlWTsNCn0NCmV4cG9ydHMuZ2V0RXZZID0gZ2V0RXZZOw0KZnVuY3Rpb24gZ2V0RXZJc1RvdWNoKGV2KSB7DQogICAgcmV0dXJuIC9edG91Y2gvLnRlc3QoZXYudHlwZSk7DQp9DQpleHBvcnRzLmdldEV2SXNUb3VjaCA9IGdldEV2SXNUb3VjaDsNCmZ1bmN0aW9uIHByZXZlbnRTZWxlY3Rpb24oZWwpIHsNCiAgICBlbC5hZGRDbGFzcygnZmMtdW5zZWxlY3RhYmxlJykNCiAgICAgICAgLm9uKCdzZWxlY3RzdGFydCcsIHByZXZlbnREZWZhdWx0KTsNCn0NCmV4cG9ydHMucHJldmVudFNlbGVjdGlvbiA9IHByZXZlbnRTZWxlY3Rpb247DQpmdW5jdGlvbiBhbGxvd1NlbGVjdGlvbihlbCkgew0KICAgIGVsLnJlbW92ZUNsYXNzKCdmYy11bnNlbGVjdGFibGUnKQ0KICAgICAgICAub2ZmKCdzZWxlY3RzdGFydCcsIHByZXZlbnREZWZhdWx0KTsNCn0NCmV4cG9ydHMuYWxsb3dTZWxlY3Rpb24gPSBhbGxvd1NlbGVjdGlvbjsNCi8vIFN0b3BzIGEgbW91c2UvdG91Y2ggZXZlbnQgZnJvbSBkb2luZyBpdCdzIG5hdGl2ZSBicm93c2VyIGFjdGlvbg0KZnVuY3Rpb24gcHJldmVudERlZmF1bHQoZXYpIHsNCiAgICBldi5wcmV2ZW50RGVmYXVsdCgpOw0KfQ0KZXhwb3J0cy5wcmV2ZW50RGVmYXVsdCA9IHByZXZlbnREZWZhdWx0Ow0KLyogR2VuZXJhbCBHZW9tZXRyeSBVdGlscw0KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQovLyBSZXR1cm5zIGEgbmV3IHJlY3RhbmdsZSB0aGF0IGlzIHRoZSBpbnRlcnNlY3Rpb24gb2YgdGhlIHR3byByZWN0YW5nbGVzLiBJZiB0aGV5IGRvbid0IGludGVyc2VjdCwgcmV0dXJucyBmYWxzZQ0KZnVuY3Rpb24gaW50ZXJzZWN0UmVjdHMocmVjdDEsIHJlY3QyKSB7DQogICAgdmFyIHJlcyA9IHsNCiAgICAgICAgbGVmdDogTWF0aC5tYXgocmVjdDEubGVmdCwgcmVjdDIubGVmdCksDQogICAgICAgIHJpZ2h0OiBNYXRoLm1pbihyZWN0MS5yaWdodCwgcmVjdDIucmlnaHQpLA0KICAgICAgICB0b3A6IE1hdGgubWF4KHJlY3QxLnRvcCwgcmVjdDIudG9wKSwNCiAgICAgICAgYm90dG9tOiBNYXRoLm1pbihyZWN0MS5ib3R0b20sIHJlY3QyLmJvdHRvbSkNCiAgICB9Ow0KICAgIGlmIChyZXMubGVmdCA8IHJlcy5yaWdodCAmJiByZXMudG9wIDwgcmVzLmJvdHRvbSkgew0KICAgICAgICByZXR1cm4gcmVzOw0KICAgIH0NCiAgICByZXR1cm4gZmFsc2U7DQp9DQpleHBvcnRzLmludGVyc2VjdFJlY3RzID0gaW50ZXJzZWN0UmVjdHM7DQovLyBSZXR1cm5zIGEgbmV3IHBvaW50IHRoYXQgd2lsbCBoYXZlIGJlZW4gbW92ZWQgdG8gcmVzaWRlIHdpdGhpbiB0aGUgZ2l2ZW4gcmVjdGFuZ2xlDQpmdW5jdGlvbiBjb25zdHJhaW5Qb2ludChwb2ludCwgcmVjdCkgew0KICAgIHJldHVybiB7DQogICAgICAgIGxlZnQ6IE1hdGgubWluKE1hdGgubWF4KHBvaW50LmxlZnQsIHJlY3QubGVmdCksIHJlY3QucmlnaHQpLA0KICAgICAgICB0b3A6IE1hdGgubWluKE1hdGgubWF4KHBvaW50LnRvcCwgcmVjdC50b3ApLCByZWN0LmJvdHRvbSkNCiAgICB9Ow0KfQ0KZXhwb3J0cy5jb25zdHJhaW5Qb2ludCA9IGNvbnN0cmFpblBvaW50Ow0KLy8gUmV0dXJucyBhIHBvaW50IHRoYXQgaXMgdGhlIGNlbnRlciBvZiB0aGUgZ2l2ZW4gcmVjdGFuZ2xlDQpmdW5jdGlvbiBnZXRSZWN0Q2VudGVyKHJlY3QpIHsNCiAgICByZXR1cm4gew0KICAgICAgICBsZWZ0OiAocmVjdC5sZWZ0ICsgcmVjdC5yaWdodCkgLyAyLA0KICAgICAgICB0b3A6IChyZWN0LnRvcCArIHJlY3QuYm90dG9tKSAvIDINCiAgICB9Ow0KfQ0KZXhwb3J0cy5nZXRSZWN0Q2VudGVyID0gZ2V0UmVjdENlbnRlcjsNCi8vIFN1YnRyYWN0cyBwb2ludDIncyBjb29yZGluYXRlcyBmcm9tIHBvaW50MSdzIGNvb3JkaW5hdGVzLCByZXR1cm5pbmcgYSBkZWx0YQ0KZnVuY3Rpb24gZGlmZlBvaW50cyhwb2ludDEsIHBvaW50Mikgew0KICAgIHJldHVybiB7DQogICAgICAgIGxlZnQ6IHBvaW50MS5sZWZ0IC0gcG9pbnQyLmxlZnQsDQogICAgICAgIHRvcDogcG9pbnQxLnRvcCAtIHBvaW50Mi50b3ANCiAgICB9Ow0KfQ0KZXhwb3J0cy5kaWZmUG9pbnRzID0gZGlmZlBvaW50czsNCi8qIE9iamVjdCBPcmRlcmluZyBieSBGaWVsZA0KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQpmdW5jdGlvbiBwYXJzZUZpZWxkU3BlY3MoaW5wdXQpIHsNCiAgICB2YXIgc3BlY3MgPSBbXTsNCiAgICB2YXIgdG9rZW5zID0gW107DQogICAgdmFyIGk7DQogICAgdmFyIHRva2VuOw0KICAgIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7DQogICAgICAgIHRva2VucyA9IGlucHV0LnNwbGl0KC9ccyosXHMqLyk7DQogICAgfQ0KICAgIGVsc2UgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICB0b2tlbnMgPSBbaW5wdXRdOw0KICAgIH0NCiAgICBlbHNlIGlmICgkLmlzQXJyYXkoaW5wdXQpKSB7DQogICAgICAgIHRva2VucyA9IGlucHV0Ow0KICAgIH0NCiAgICBmb3IgKGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIHRva2VuID0gdG9rZW5zW2ldOw0KICAgICAgICBpZiAodHlwZW9mIHRva2VuID09PSAnc3RyaW5nJykgew0KICAgICAgICAgICAgc3BlY3MucHVzaCh0b2tlbi5jaGFyQXQoMCkgPT09ICctJyA/DQogICAgICAgICAgICAgICAgeyBmaWVsZDogdG9rZW4uc3Vic3RyaW5nKDEpLCBvcmRlcjogLTEgfSA6DQogICAgICAgICAgICAgICAgeyBmaWVsZDogdG9rZW4sIG9yZGVyOiAxIH0pOw0KICAgICAgICB9DQogICAgICAgIGVsc2UgaWYgKHR5cGVvZiB0b2tlbiA9PT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICAgICAgc3BlY3MucHVzaCh7IGZ1bmM6IHRva2VuIH0pOw0KICAgICAgICB9DQogICAgfQ0KICAgIHJldHVybiBzcGVjczsNCn0NCmV4cG9ydHMucGFyc2VGaWVsZFNwZWNzID0gcGFyc2VGaWVsZFNwZWNzOw0KZnVuY3Rpb24gY29tcGFyZUJ5RmllbGRTcGVjcyhvYmoxLCBvYmoyLCBmaWVsZFNwZWNzLCBvYmoxZmFsbGJhY2ssIG9iajJmYWxsYmFjaykgew0KICAgIHZhciBpOw0KICAgIHZhciBjbXA7DQogICAgZm9yIChpID0gMDsgaSA8IGZpZWxkU3BlY3MubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgY21wID0gY29tcGFyZUJ5RmllbGRTcGVjKG9iajEsIG9iajIsIGZpZWxkU3BlY3NbaV0sIG9iajFmYWxsYmFjaywgb2JqMmZhbGxiYWNrKTsNCiAgICAgICAgaWYgKGNtcCkgew0KICAgICAgICAgICAgcmV0dXJuIGNtcDsNCiAgICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gMDsNCn0NCmV4cG9ydHMuY29tcGFyZUJ5RmllbGRTcGVjcyA9IGNvbXBhcmVCeUZpZWxkU3BlY3M7DQpmdW5jdGlvbiBjb21wYXJlQnlGaWVsZFNwZWMob2JqMSwgb2JqMiwgZmllbGRTcGVjLCBvYmoxZmFsbGJhY2ssIG9iajJmYWxsYmFjaykgew0KICAgIGlmIChmaWVsZFNwZWMuZnVuYykgew0KICAgICAgICByZXR1cm4gZmllbGRTcGVjLmZ1bmMob2JqMSwgb2JqMik7DQogICAgfQ0KICAgIHZhciB2YWwxID0gb2JqMVtmaWVsZFNwZWMuZmllbGRdOw0KICAgIHZhciB2YWwyID0gb2JqMltmaWVsZFNwZWMuZmllbGRdOw0KICAgIGlmICh2YWwxID09IG51bGwgJiYgb2JqMWZhbGxiYWNrKSB7DQogICAgICAgIHZhbDEgPSBvYmoxZmFsbGJhY2tbZmllbGRTcGVjLmZpZWxkXTsNCiAgICB9DQogICAgaWYgKHZhbDIgPT0gbnVsbCAmJiBvYmoyZmFsbGJhY2spIHsNCiAgICAgICAgdmFsMiA9IG9iajJmYWxsYmFja1tmaWVsZFNwZWMuZmllbGRdOw0KICAgIH0NCiAgICByZXR1cm4gZmxleGlibGVDb21wYXJlKHZhbDEsIHZhbDIpICogKGZpZWxkU3BlYy5vcmRlciB8fCAxKTsNCn0NCmV4cG9ydHMuY29tcGFyZUJ5RmllbGRTcGVjID0gY29tcGFyZUJ5RmllbGRTcGVjOw0KZnVuY3Rpb24gZmxleGlibGVDb21wYXJlKGEsIGIpIHsNCiAgICBpZiAoIWEgJiYgIWIpIHsNCiAgICAgICAgcmV0dXJuIDA7DQogICAgfQ0KICAgIGlmIChiID09IG51bGwpIHsNCiAgICAgICAgcmV0dXJuIC0xOw0KICAgIH0NCiAgICBpZiAoYSA9PSBudWxsKSB7DQogICAgICAgIHJldHVybiAxOw0KICAgIH0NCiAgICBpZiAoJC50eXBlKGEpID09PSAnc3RyaW5nJyB8fCAkLnR5cGUoYikgPT09ICdzdHJpbmcnKSB7DQogICAgICAgIHJldHVybiBTdHJpbmcoYSkubG9jYWxlQ29tcGFyZShTdHJpbmcoYikpOw0KICAgIH0NCiAgICByZXR1cm4gYSAtIGI7DQp9DQpleHBvcnRzLmZsZXhpYmxlQ29tcGFyZSA9IGZsZXhpYmxlQ29tcGFyZTsNCi8qIERhdGUgVXRpbGl0aWVzDQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCmV4cG9ydHMuZGF5SURzID0gWydzdW4nLCAnbW9uJywgJ3R1ZScsICd3ZWQnLCAndGh1JywgJ2ZyaScsICdzYXQnXTsNCmV4cG9ydHMudW5pdHNEZXNjID0gWyd5ZWFyJywgJ21vbnRoJywgJ3dlZWsnLCAnZGF5JywgJ2hvdXInLCAnbWludXRlJywgJ3NlY29uZCcsICdtaWxsaXNlY29uZCddOyAvLyBkZXNjZW5kaW5nDQovLyBEaWZmcyB0aGUgdHdvIG1vbWVudHMgaW50byBhIER1cmF0aW9uIHdoZXJlIGZ1bGwtZGF5cyBhcmUgcmVjb3JkZWQgZmlyc3QsIHRoZW4gdGhlIHJlbWFpbmluZyB0aW1lLg0KLy8gTW9tZW50cyB3aWxsIGhhdmUgdGhlaXIgdGltZXpvbmVzIG5vcm1hbGl6ZWQuDQpmdW5jdGlvbiBkaWZmRGF5VGltZShhLCBiKSB7DQogICAgcmV0dXJuIG1vbWVudC5kdXJhdGlvbih7DQogICAgICAgIGRheXM6IGEuY2xvbmUoKS5zdHJpcFRpbWUoKS5kaWZmKGIuY2xvbmUoKS5zdHJpcFRpbWUoKSwgJ2RheXMnKSwNCiAgICAgICAgbXM6IGEudGltZSgpIC0gYi50aW1lKCkgLy8gdGltZS1vZi1kYXkgZnJvbSBkYXkgc3RhcnQuIGRpc3JlZ2FyZHMgdGltZXpvbmUNCiAgICB9KTsNCn0NCmV4cG9ydHMuZGlmZkRheVRpbWUgPSBkaWZmRGF5VGltZTsNCi8vIERpZmZzIHRoZSB0d28gbW9tZW50cyB2aWEgdGhlaXIgc3RhcnQtb2YtZGF5IChyZWdhcmRsZXNzIG9mIHRpbWV6b25lKS4gUHJvZHVjZXMgd2hvbGUtZGF5IGR1cmF0aW9ucy4NCmZ1bmN0aW9uIGRpZmZEYXkoYSwgYikgew0KICAgIHJldHVybiBtb21lbnQuZHVyYXRpb24oew0KICAgICAgICBkYXlzOiBhLmNsb25lKCkuc3RyaXBUaW1lKCkuZGlmZihiLmNsb25lKCkuc3RyaXBUaW1lKCksICdkYXlzJykNCiAgICB9KTsNCn0NCmV4cG9ydHMuZGlmZkRheSA9IGRpZmZEYXk7DQovLyBEaWZmcyB0d28gbW9tZW50cywgcHJvZHVjaW5nIGEgZHVyYXRpb24sIG1hZGUgb2YgYSB3aG9sZS11bml0LWluY3JlbWVudCBvZiB0aGUgZ2l2ZW4gdW5pdC4gVXNlcyByb3VuZGluZy4NCmZ1bmN0aW9uIGRpZmZCeVVuaXQoYSwgYiwgdW5pdCkgew0KICAgIHJldHVybiBtb21lbnQuZHVyYXRpb24oTWF0aC5yb3VuZChhLmRpZmYoYiwgdW5pdCwgdHJ1ZSkpLCAvLyByZXR1cm5GbG9hdD10cnVlDQogICAgdW5pdCk7DQp9DQpleHBvcnRzLmRpZmZCeVVuaXQgPSBkaWZmQnlVbml0Ow0KLy8gQ29tcHV0ZXMgdGhlIHVuaXQgbmFtZSBvZiB0aGUgbGFyZ2VzdCB3aG9sZS11bml0IHBlcmlvZCBvZiB0aW1lLg0KLy8gRm9yIGV4YW1wbGUsIDQ4IGhvdXJzIHdpbGwgYmUgImRheXMiIHdoZXJlYXMgNDkgaG91cnMgd2lsbCBiZSAiaG91cnMiLg0KLy8gQWNjZXB0cyBzdGFydC9lbmQsIGEgcmFuZ2Ugb2JqZWN0LCBvciBhbiBvcmlnaW5hbCBkdXJhdGlvbiBvYmplY3QuDQpmdW5jdGlvbiBjb21wdXRlR3JlYXRlc3RVbml0KHN0YXJ0LCBlbmQpIHsNCiAgICB2YXIgaTsNCiAgICB2YXIgdW5pdDsNCiAgICB2YXIgdmFsOw0KICAgIGZvciAoaSA9IDA7IGkgPCBleHBvcnRzLnVuaXRzRGVzYy5sZW5ndGg7IGkrKykgew0KICAgICAgICB1bml0ID0gZXhwb3J0cy51bml0c0Rlc2NbaV07DQogICAgICAgIHZhbCA9IGNvbXB1dGVSYW5nZUFzKHVuaXQsIHN0YXJ0LCBlbmQpOw0KICAgICAgICBpZiAodmFsID49IDEgJiYgaXNJbnQodmFsKSkgew0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHVuaXQ7IC8vIHdpbGwgYmUgIm1pbGxpc2Vjb25kcyIgaWYgbm90aGluZyBlbHNlIG1hdGNoZXMNCn0NCmV4cG9ydHMuY29tcHV0ZUdyZWF0ZXN0VW5pdCA9IGNvbXB1dGVHcmVhdGVzdFVuaXQ7DQovLyBsaWtlIGNvbXB1dGVHcmVhdGVzdFVuaXQsIGJ1dCBoYXMgc3BlY2lhbCBhYmlsaXRpZXMgdG8gaW50ZXJwcmV0IHRoZSBzb3VyY2UgaW5wdXQgZm9yIGNsdWVzDQpmdW5jdGlvbiBjb21wdXRlRHVyYXRpb25HcmVhdGVzdFVuaXQoZHVyYXRpb24sIGR1cmF0aW9uSW5wdXQpIHsNCiAgICB2YXIgdW5pdCA9IGNvbXB1dGVHcmVhdGVzdFVuaXQoZHVyYXRpb24pOw0KICAgIC8vIHByZXZlbnQgZGF5czo3IGZyb20gYmVpbmcgaW50ZXJwcmV0ZWQgYXMgYSB3ZWVrDQogICAgaWYgKHVuaXQgPT09ICd3ZWVrJyAmJiB0eXBlb2YgZHVyYXRpb25JbnB1dCA9PT0gJ29iamVjdCcgJiYgZHVyYXRpb25JbnB1dC5kYXlzKSB7DQogICAgICAgIHVuaXQgPSAnZGF5JzsNCiAgICB9DQogICAgcmV0dXJuIHVuaXQ7DQp9DQpleHBvcnRzLmNvbXB1dGVEdXJhdGlvbkdyZWF0ZXN0VW5pdCA9IGNvbXB1dGVEdXJhdGlvbkdyZWF0ZXN0VW5pdDsNCi8vIENvbXB1dGVzIHRoZSBudW1iZXIgb2YgdW5pdHMgKGxpa2UgImhvdXJzIikgaW4gdGhlIGdpdmVuIHJhbmdlLg0KLy8gUmFuZ2UgY2FuIGJlIGEge3N0YXJ0LGVuZH0gb2JqZWN0LCBzZXBhcmF0ZSBzdGFydC9lbmQgYXJncywgb3IgYSBEdXJhdGlvbi4NCi8vIFJlc3VsdHMgYXJlIGJhc2VkIG9uIE1vbWVudCdzIC5hcygpIGFuZCAuZGlmZigpIG1ldGhvZHMsIHNvIHJlc3VsdHMgY2FuIGRlcGVuZCBvbiBpbnRlcm5hbCBoYW5kbGluZw0KLy8gb2YgbW9udGgtZGlmZmluZyBsb2dpYyAod2hpY2ggdGVuZHMgdG8gdmFyeSBmcm9tIHZlcnNpb24gdG8gdmVyc2lvbikuDQpmdW5jdGlvbiBjb21wdXRlUmFuZ2VBcyh1bml0LCBzdGFydCwgZW5kKSB7DQogICAgaWYgKGVuZCAhPSBudWxsKSB7DQogICAgICAgIHJldHVybiBlbmQuZGlmZihzdGFydCwgdW5pdCwgdHJ1ZSk7DQogICAgfQ0KICAgIGVsc2UgaWYgKG1vbWVudC5pc0R1cmF0aW9uKHN0YXJ0KSkgew0KICAgICAgICByZXR1cm4gc3RhcnQuYXModW5pdCk7DQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICByZXR1cm4gc3RhcnQuZW5kLmRpZmYoc3RhcnQuc3RhcnQsIHVuaXQsIHRydWUpOw0KICAgIH0NCn0NCi8vIEludGVsbGlnZW50bHkgZGl2aWRlcyBhIHJhbmdlIChzcGVjaWZpZWQgYnkgYSBzdGFydC9lbmQgcGFyYW1zKSBieSBhIGR1cmF0aW9uDQpmdW5jdGlvbiBkaXZpZGVSYW5nZUJ5RHVyYXRpb24oc3RhcnQsIGVuZCwgZHVyKSB7DQogICAgdmFyIG1vbnRoczsNCiAgICBpZiAoZHVyYXRpb25IYXNUaW1lKGR1cikpIHsNCiAgICAgICAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXI7DQogICAgfQ0KICAgIG1vbnRocyA9IGR1ci5hc01vbnRocygpOw0KICAgIGlmIChNYXRoLmFicyhtb250aHMpID49IDEgJiYgaXNJbnQobW9udGhzKSkgew0KICAgICAgICByZXR1cm4gZW5kLmRpZmYoc3RhcnQsICdtb250aHMnLCB0cnVlKSAvIG1vbnRoczsNCiAgICB9DQogICAgcmV0dXJuIGVuZC5kaWZmKHN0YXJ0LCAnZGF5cycsIHRydWUpIC8gZHVyLmFzRGF5cygpOw0KfQ0KZXhwb3J0cy5kaXZpZGVSYW5nZUJ5RHVyYXRpb24gPSBkaXZpZGVSYW5nZUJ5RHVyYXRpb247DQovLyBJbnRlbGxpZ2VudGx5IGRpdmlkZXMgb25lIGR1cmF0aW9uIGJ5IGFub3RoZXINCmZ1bmN0aW9uIGRpdmlkZUR1cmF0aW9uQnlEdXJhdGlvbihkdXIxLCBkdXIyKSB7DQogICAgdmFyIG1vbnRoczE7DQogICAgdmFyIG1vbnRoczI7DQogICAgaWYgKGR1cmF0aW9uSGFzVGltZShkdXIxKSB8fCBkdXJhdGlvbkhhc1RpbWUoZHVyMikpIHsNCiAgICAgICAgcmV0dXJuIGR1cjEgLyBkdXIyOw0KICAgIH0NCiAgICBtb250aHMxID0gZHVyMS5hc01vbnRocygpOw0KICAgIG1vbnRoczIgPSBkdXIyLmFzTW9udGhzKCk7DQogICAgaWYgKE1hdGguYWJzKG1vbnRoczEpID49IDEgJiYgaXNJbnQobW9udGhzMSkgJiYNCiAgICAgICAgTWF0aC5hYnMobW9udGhzMikgPj0gMSAmJiBpc0ludChtb250aHMyKSkgew0KICAgICAgICByZXR1cm4gbW9udGhzMSAvIG1vbnRoczI7DQogICAgfQ0KICAgIHJldHVybiBkdXIxLmFzRGF5cygpIC8gZHVyMi5hc0RheXMoKTsNCn0NCmV4cG9ydHMuZGl2aWRlRHVyYXRpb25CeUR1cmF0aW9uID0gZGl2aWRlRHVyYXRpb25CeUR1cmF0aW9uOw0KLy8gSW50ZWxsaWdlbnRseSBtdWx0aXBsaWVzIGEgZHVyYXRpb24gYnkgYSBudW1iZXINCmZ1bmN0aW9uIG11bHRpcGx5RHVyYXRpb24oZHVyLCBuKSB7DQogICAgdmFyIG1vbnRoczsNCiAgICBpZiAoZHVyYXRpb25IYXNUaW1lKGR1cikpIHsNCiAgICAgICAgcmV0dXJuIG1vbWVudC5kdXJhdGlvbihkdXIgKiBuKTsNCiAgICB9DQogICAgbW9udGhzID0gZHVyLmFzTW9udGhzKCk7DQogICAgaWYgKE1hdGguYWJzKG1vbnRocykgPj0gMSAmJiBpc0ludChtb250aHMpKSB7DQogICAgICAgIHJldHVybiBtb21lbnQuZHVyYXRpb24oeyBtb250aHM6IG1vbnRocyAqIG4gfSk7DQogICAgfQ0KICAgIHJldHVybiBtb21lbnQuZHVyYXRpb24oeyBkYXlzOiBkdXIuYXNEYXlzKCkgKiBuIH0pOw0KfQ0KZXhwb3J0cy5tdWx0aXBseUR1cmF0aW9uID0gbXVsdGlwbHlEdXJhdGlvbjsNCi8vIFJldHVybnMgYSBib29sZWFuIGFib3V0IHdoZXRoZXIgdGhlIGdpdmVuIGR1cmF0aW9uIGhhcyBhbnkgdGltZSBwYXJ0cyAoaG91cnMvbWludXRlcy9zZWNvbmRzL21zKQ0KZnVuY3Rpb24gZHVyYXRpb25IYXNUaW1lKGR1cikgew0KICAgIHJldHVybiBCb29sZWFuKGR1ci5ob3VycygpIHx8IGR1ci5taW51dGVzKCkgfHwgZHVyLnNlY29uZHMoKSB8fCBkdXIubWlsbGlzZWNvbmRzKCkpOw0KfQ0KZXhwb3J0cy5kdXJhdGlvbkhhc1RpbWUgPSBkdXJhdGlvbkhhc1RpbWU7DQpmdW5jdGlvbiBpc05hdGl2ZURhdGUoaW5wdXQpIHsNCiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGlucHV0KSA9PT0gJ1tvYmplY3QgRGF0ZV0nIHx8IGlucHV0IGluc3RhbmNlb2YgRGF0ZTsNCn0NCmV4cG9ydHMuaXNOYXRpdmVEYXRlID0gaXNOYXRpdmVEYXRlOw0KLy8gUmV0dXJucyBhIGJvb2xlYW4gYWJvdXQgd2hldGhlciB0aGUgZ2l2ZW4gaW5wdXQgaXMgYSB0aW1lIHN0cmluZywgbGlrZSAiMDY6NDA6MDAiIG9yICIwNjowMCINCmZ1bmN0aW9uIGlzVGltZVN0cmluZyhzdHIpIHsNCiAgICByZXR1cm4gdHlwZW9mIHN0ciA9PT0gJ3N0cmluZycgJiYNCiAgICAgICAgL15cZCtcOlxkKyg/Olw6XGQrXC4/KD86XGR7M30pPyk/JC8udGVzdChzdHIpOw0KfQ0KZXhwb3J0cy5pc1RpbWVTdHJpbmcgPSBpc1RpbWVTdHJpbmc7DQovKiBMb2dnaW5nIGFuZCBEZWJ1Zw0KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQpmdW5jdGlvbiBsb2coKSB7DQogICAgdmFyIGFyZ3MgPSBbXTsNCiAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykgew0KICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07DQogICAgfQ0KICAgIHZhciBjb25zb2xlID0gd2luZG93LmNvbnNvbGU7DQogICAgaWYgKGNvbnNvbGUgJiYgY29uc29sZS5sb2cpIHsNCiAgICAgICAgcmV0dXJuIGNvbnNvbGUubG9nLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOw0KICAgIH0NCn0NCmV4cG9ydHMubG9nID0gbG9nOw0KZnVuY3Rpb24gd2FybigpIHsNCiAgICB2YXIgYXJncyA9IFtdOw0KICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7DQogICAgICAgIGFyZ3NbX2ldID0gYXJndW1lbnRzW19pXTsNCiAgICB9DQogICAgdmFyIGNvbnNvbGUgPSB3aW5kb3cuY29uc29sZTsNCiAgICBpZiAoY29uc29sZSAmJiBjb25zb2xlLndhcm4pIHsNCiAgICAgICAgcmV0dXJuIGNvbnNvbGUud2Fybi5hcHBseShjb25zb2xlLCBhcmdzKTsNCiAgICB9DQogICAgZWxzZSB7DQogICAgICAgIHJldHVybiBsb2cuYXBwbHkobnVsbCwgYXJncyk7DQogICAgfQ0KfQ0KZXhwb3J0cy53YXJuID0gd2FybjsNCi8qIEdlbmVyYWwgVXRpbGl0aWVzDQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCnZhciBoYXNPd25Qcm9wTWV0aG9kID0ge30uaGFzT3duUHJvcGVydHk7DQovLyBNZXJnZXMgYW4gYXJyYXkgb2Ygb2JqZWN0cyBpbnRvIGEgc2luZ2xlIG9iamVjdC4NCi8vIFRoZSBzZWNvbmQgYXJndW1lbnQgYWxsb3dzIGZvciBhbiBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcyB3aG8ncyBvYmplY3QgdmFsdWVzIHdpbGwgYmUgbWVyZ2VkIHRvZ2V0aGVyLg0KZnVuY3Rpb24gbWVyZ2VQcm9wcyhwcm9wT2JqcywgY29tcGxleFByb3BzKSB7DQogICAgdmFyIGRlc3QgPSB7fTsNCiAgICB2YXIgaTsNCiAgICB2YXIgbmFtZTsNCiAgICB2YXIgY29tcGxleE9ianM7DQogICAgdmFyIGo7DQogICAgdmFyIHZhbDsNCiAgICB2YXIgcHJvcHM7DQogICAgaWYgKGNvbXBsZXhQcm9wcykgew0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29tcGxleFByb3BzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBuYW1lID0gY29tcGxleFByb3BzW2ldOw0KICAgICAgICAgICAgY29tcGxleE9ianMgPSBbXTsNCiAgICAgICAgICAgIC8vIGNvbGxlY3QgdGhlIHRyYWlsaW5nIG9iamVjdCB2YWx1ZXMsIHN0b3BwaW5nIHdoZW4gYSBub24tb2JqZWN0IGlzIGRpc2NvdmVyZWQNCiAgICAgICAgICAgIGZvciAoaiA9IHByb3BPYmpzLmxlbmd0aCAtIDE7IGogPj0gMDsgai0tKSB7DQogICAgICAgICAgICAgICAgdmFsID0gcHJvcE9ianNbal1bbmFtZV07DQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICdvYmplY3QnKSB7DQogICAgICAgICAgICAgICAgICAgIGNvbXBsZXhPYmpzLnVuc2hpZnQodmFsKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSBpZiAodmFsICE9PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgICAgICAgICAgZGVzdFtuYW1lXSA9IHZhbDsgLy8gaWYgdGhlcmUgd2VyZSBubyBvYmplY3RzLCB0aGlzIHZhbHVlIHdpbGwgYmUgdXNlZA0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICAvLyBpZiB0aGUgdHJhaWxpbmcgdmFsdWVzIHdlcmUgb2JqZWN0cywgdXNlIHRoZSBtZXJnZWQgdmFsdWUNCiAgICAgICAgICAgIGlmIChjb21wbGV4T2Jqcy5sZW5ndGgpIHsNCiAgICAgICAgICAgICAgICBkZXN0W25hbWVdID0gbWVyZ2VQcm9wcyhjb21wbGV4T2Jqcyk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQogICAgLy8gY29weSB2YWx1ZXMgaW50byB0aGUgZGVzdGluYXRpb24sIGdvaW5nIGZyb20gbGFzdCB0byBmaXJzdA0KICAgIGZvciAoaSA9IHByb3BPYmpzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7DQogICAgICAgIHByb3BzID0gcHJvcE9ianNbaV07DQogICAgICAgIGZvciAobmFtZSBpbiBwcm9wcykgew0KICAgICAgICAgICAgaWYgKCEobmFtZSBpbiBkZXN0KSkgew0KICAgICAgICAgICAgICAgIGRlc3RbbmFtZV0gPSBwcm9wc1tuYW1lXTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gZGVzdDsNCn0NCmV4cG9ydHMubWVyZ2VQcm9wcyA9IG1lcmdlUHJvcHM7DQpmdW5jdGlvbiBjb3B5T3duUHJvcHMoc3JjLCBkZXN0KSB7DQogICAgZm9yICh2YXIgbmFtZV8xIGluIHNyYykgew0KICAgICAgICBpZiAoaGFzT3duUHJvcChzcmMsIG5hbWVfMSkpIHsNCiAgICAgICAgICAgIGRlc3RbbmFtZV8xXSA9IHNyY1tuYW1lXzFdOw0KICAgICAgICB9DQogICAgfQ0KfQ0KZXhwb3J0cy5jb3B5T3duUHJvcHMgPSBjb3B5T3duUHJvcHM7DQpmdW5jdGlvbiBoYXNPd25Qcm9wKG9iaiwgbmFtZSkgew0KICAgIHJldHVybiBoYXNPd25Qcm9wTWV0aG9kLmNhbGwob2JqLCBuYW1lKTsNCn0NCmV4cG9ydHMuaGFzT3duUHJvcCA9IGhhc093blByb3A7DQpmdW5jdGlvbiBhcHBseUFsbChmdW5jdGlvbnMsIHRoaXNPYmosIGFyZ3MpIHsNCiAgICBpZiAoJC5pc0Z1bmN0aW9uKGZ1bmN0aW9ucykpIHsNCiAgICAgICAgZnVuY3Rpb25zID0gW2Z1bmN0aW9uc107DQogICAgfQ0KICAgIGlmIChmdW5jdGlvbnMpIHsNCiAgICAgICAgdmFyIGkgPSB2b2lkIDA7DQogICAgICAgIHZhciByZXQgPSB2b2lkIDA7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBmdW5jdGlvbnMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIHJldCA9IGZ1bmN0aW9uc1tpXS5hcHBseSh0aGlzT2JqLCBhcmdzKSB8fCByZXQ7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHJldDsNCiAgICB9DQp9DQpleHBvcnRzLmFwcGx5QWxsID0gYXBwbHlBbGw7DQpmdW5jdGlvbiByZW1vdmVNYXRjaGluZyhhcnJheSwgdGVzdEZ1bmMpIHsNCiAgICB2YXIgcmVtb3ZlQ250ID0gMDsNCiAgICB2YXIgaSA9IDA7DQogICAgd2hpbGUgKGkgPCBhcnJheS5sZW5ndGgpIHsNCiAgICAgICAgaWYgKHRlc3RGdW5jKGFycmF5W2ldKSkgew0KICAgICAgICAgICAgYXJyYXkuc3BsaWNlKGksIDEpOw0KICAgICAgICAgICAgcmVtb3ZlQ250Kys7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBpKys7DQogICAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHJlbW92ZUNudDsNCn0NCmV4cG9ydHMucmVtb3ZlTWF0Y2hpbmcgPSByZW1vdmVNYXRjaGluZzsNCmZ1bmN0aW9uIHJlbW92ZUV4YWN0KGFycmF5LCBleGFjdFZhbCkgew0KICAgIHZhciByZW1vdmVDbnQgPSAwOw0KICAgIHZhciBpID0gMDsNCiAgICB3aGlsZSAoaSA8IGFycmF5Lmxlbmd0aCkgew0KICAgICAgICBpZiAoYXJyYXlbaV0gPT09IGV4YWN0VmFsKSB7DQogICAgICAgICAgICBhcnJheS5zcGxpY2UoaSwgMSk7DQogICAgICAgICAgICByZW1vdmVDbnQrKzsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIGkrKzsNCiAgICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gcmVtb3ZlQ250Ow0KfQ0KZXhwb3J0cy5yZW1vdmVFeGFjdCA9IHJlbW92ZUV4YWN0Ow0KZnVuY3Rpb24gaXNBcnJheXNFcXVhbChhMCwgYTEpIHsNCiAgICB2YXIgbGVuID0gYTAubGVuZ3RoOw0KICAgIHZhciBpOw0KICAgIGlmIChsZW4gPT0gbnVsbCB8fCBsZW4gIT09IGExLmxlbmd0aCkgew0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgew0KICAgICAgICBpZiAoYTBbaV0gIT09IGExW2ldKSB7DQogICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHRydWU7DQp9DQpleHBvcnRzLmlzQXJyYXlzRXF1YWwgPSBpc0FycmF5c0VxdWFsOw0KZnVuY3Rpb24gZmlyc3REZWZpbmVkKCkgew0KICAgIHZhciBhcmdzID0gW107DQogICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHsNCiAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2ldOw0KICAgIH0NCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgaWYgKGFyZ3NbaV0gIT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgcmV0dXJuIGFyZ3NbaV07DQogICAgICAgIH0NCiAgICB9DQp9DQpleHBvcnRzLmZpcnN0RGVmaW5lZCA9IGZpcnN0RGVmaW5lZDsNCmZ1bmN0aW9uIGh0bWxFc2NhcGUocykgew0KICAgIHJldHVybiAocyArICcnKS5yZXBsYWNlKC8mL2csICcmYW1wOycpDQogICAgICAgIC5yZXBsYWNlKC88L2csICcmbHQ7JykNCiAgICAgICAgLnJlcGxhY2UoLz4vZywgJyZndDsnKQ0KICAgICAgICAucmVwbGFjZSgvJy9nLCAnJiMwMzk7JykNCiAgICAgICAgLnJlcGxhY2UoLyIvZywgJyZxdW90OycpDQogICAgICAgIC5yZXBsYWNlKC9cbi9nLCAnPGJyIC8+Jyk7DQp9DQpleHBvcnRzLmh0bWxFc2NhcGUgPSBodG1sRXNjYXBlOw0KZnVuY3Rpb24gc3RyaXBIdG1sRW50aXRpZXModGV4dCkgew0KICAgIHJldHVybiB0ZXh0LnJlcGxhY2UoLyYuKj87L2csICcnKTsNCn0NCmV4cG9ydHMuc3RyaXBIdG1sRW50aXRpZXMgPSBzdHJpcEh0bWxFbnRpdGllczsNCi8vIEdpdmVuIGEgaGFzaCBvZiBDU1MgcHJvcGVydGllcywgcmV0dXJucyBhIHN0cmluZyBvZiBDU1MuDQovLyBVc2VzIHByb3BlcnR5IG5hbWVzIGFzLWlzIChubyBjYW1lbC1jYXNlIGNvbnZlcnNpb24pLiBXaWxsIG5vdCBtYWtlIHN0YXRlbWVudHMgZm9yIG51bGwvdW5kZWZpbmVkIHZhbHVlcy4NCmZ1bmN0aW9uIGNzc1RvU3RyKGNzc1Byb3BzKSB7DQogICAgdmFyIHN0YXRlbWVudHMgPSBbXTsNCiAgICAkLmVhY2goY3NzUHJvcHMsIGZ1bmN0aW9uIChuYW1lLCB2YWwpIHsNCiAgICAgICAgaWYgKHZhbCAhPSBudWxsKSB7DQogICAgICAgICAgICBzdGF0ZW1lbnRzLnB1c2gobmFtZSArICc6JyArIHZhbCk7DQogICAgICAgIH0NCiAgICB9KTsNCiAgICByZXR1cm4gc3RhdGVtZW50cy5qb2luKCc7Jyk7DQp9DQpleHBvcnRzLmNzc1RvU3RyID0gY3NzVG9TdHI7DQovLyBHaXZlbiBhbiBvYmplY3QgaGFzaCBvZiBIVE1MIGF0dHJpYnV0ZSBuYW1lcyB0byB2YWx1ZXMsDQovLyBnZW5lcmF0ZXMgYSBzdHJpbmcgdGhhdCBjYW4gYmUgaW5qZWN0ZWQgYmV0d2VlbiA8ID4gaW4gSFRNTA0KZnVuY3Rpb24gYXR0cnNUb1N0cihhdHRycykgew0KICAgIHZhciBwYXJ0cyA9IFtdOw0KICAgICQuZWFjaChhdHRycywgZnVuY3Rpb24gKG5hbWUsIHZhbCkgew0KICAgICAgICBpZiAodmFsICE9IG51bGwpIHsNCiAgICAgICAgICAgIHBhcnRzLnB1c2gobmFtZSArICc9IicgKyBodG1sRXNjYXBlKHZhbCkgKyAnIicpOw0KICAgICAgICB9DQogICAgfSk7DQogICAgcmV0dXJuIHBhcnRzLmpvaW4oJyAnKTsNCn0NCmV4cG9ydHMuYXR0cnNUb1N0ciA9IGF0dHJzVG9TdHI7DQpmdW5jdGlvbiBjYXBpdGFsaXNlRmlyc3RMZXR0ZXIoc3RyKSB7DQogICAgcmV0dXJuIHN0ci5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHN0ci5zbGljZSgxKTsNCn0NCmV4cG9ydHMuY2FwaXRhbGlzZUZpcnN0TGV0dGVyID0gY2FwaXRhbGlzZUZpcnN0TGV0dGVyOw0KZnVuY3Rpb24gY29tcGFyZU51bWJlcnMoYSwgYikgew0KICAgIHJldHVybiBhIC0gYjsNCn0NCmV4cG9ydHMuY29tcGFyZU51bWJlcnMgPSBjb21wYXJlTnVtYmVyczsNCmZ1bmN0aW9uIGlzSW50KG4pIHsNCiAgICByZXR1cm4gbiAlIDEgPT09IDA7DQp9DQpleHBvcnRzLmlzSW50ID0gaXNJbnQ7DQovLyBSZXR1cm5zIGEgbWV0aG9kIGJvdW5kIHRvIHRoZSBnaXZlbiBvYmplY3QgY29udGV4dC4NCi8vIEp1c3QgbGlrZSBvbmUgb2YgdGhlIGpRdWVyeS5wcm94eSBzaWduYXR1cmVzLCBidXQgd2l0aG91dCB0aGUgdW5kZXNpcmVkIGJlaGF2aW9yIG9mIHRyZWF0aW5nIHRoZSBzYW1lIG1ldGhvZCB3aXRoDQovLyBkaWZmZXJlbnQgY29udGV4dHMgYXMgaWRlbnRpY2FsIHdoZW4gYmluZGluZy91bmJpbmRpbmcgZXZlbnRzLg0KZnVuY3Rpb24gcHJveHkob2JqLCBtZXRob2ROYW1lKSB7DQogICAgdmFyIG1ldGhvZCA9IG9ialttZXRob2ROYW1lXTsNCiAgICByZXR1cm4gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KG9iaiwgYXJndW1lbnRzKTsNCiAgICB9Ow0KfQ0KZXhwb3J0cy5wcm94eSA9IHByb3h5Ow0KLy8gUmV0dXJucyBhIGZ1bmN0aW9uLCB0aGF0LCBhcyBsb25nIGFzIGl0IGNvbnRpbnVlcyB0byBiZSBpbnZva2VkLCB3aWxsIG5vdA0KLy8gYmUgdHJpZ2dlcmVkLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgaXQgc3RvcHMgYmVpbmcgY2FsbGVkIGZvcg0KLy8gTiBtaWxsaXNlY29uZHMuIElmIGBpbW1lZGlhdGVgIGlzIHBhc3NlZCwgdHJpZ2dlciB0aGUgZnVuY3Rpb24gb24gdGhlDQovLyBsZWFkaW5nIGVkZ2UsIGluc3RlYWQgb2YgdGhlIHRyYWlsaW5nLg0KLy8gaHR0cHM6Ly9naXRodWIuY29tL2phc2hrZW5hcy91bmRlcnNjb3JlL2Jsb2IvMS42LjAvdW5kZXJzY29yZS5qcyNMNzE0DQpmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsNCiAgICBpZiAoaW1tZWRpYXRlID09PSB2b2lkIDApIHsgaW1tZWRpYXRlID0gZmFsc2U7IH0NCiAgICB2YXIgdGltZW91dDsNCiAgICB2YXIgYXJnczsNCiAgICB2YXIgY29udGV4dDsNCiAgICB2YXIgdGltZXN0YW1wOw0KICAgIHZhciByZXN1bHQ7DQogICAgdmFyIGxhdGVyID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgbGFzdCA9ICtuZXcgRGF0ZSgpIC0gdGltZXN0YW1wOw0KICAgICAgICBpZiAobGFzdCA8IHdhaXQpIHsNCiAgICAgICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0IC0gbGFzdCk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsNCiAgICAgICAgICAgIGlmICghaW1tZWRpYXRlKSB7DQogICAgICAgICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsNCiAgICAgICAgICAgICAgICBjb250ZXh0ID0gYXJncyA9IG51bGw7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9Ow0KICAgIHJldHVybiBmdW5jdGlvbiAoKSB7DQogICAgICAgIGNvbnRleHQgPSB0aGlzOw0KICAgICAgICBhcmdzID0gYXJndW1lbnRzOw0KICAgICAgICB0aW1lc3RhbXAgPSArbmV3IERhdGUoKTsNCiAgICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7DQogICAgICAgIGlmICghdGltZW91dCkgew0KICAgICAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOw0KICAgICAgICB9DQogICAgICAgIGlmIChjYWxsTm93KSB7DQogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOw0KICAgICAgICAgICAgY29udGV4dCA9IGFyZ3MgPSBudWxsOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiByZXN1bHQ7DQogICAgfTsNCn0NCmV4cG9ydHMuZGVib3VuY2UgPSBkZWJvdW5jZTsNCgoKLyoqKi8gfSksCi8qIDUgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciBtb21lbnQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDApOw0KdmFyIG1vbWVudF9leHRfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTApOw0KdmFyIFVuem9uZWRSYW5nZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsNCiAgICBmdW5jdGlvbiBVbnpvbmVkUmFuZ2Uoc3RhcnRJbnB1dCwgZW5kSW5wdXQpIHsNCiAgICAgICAgLy8gVE9ETzogbW92ZSB0aGVzZSBpbnRvIGZvb3RwcmludC4NCiAgICAgICAgLy8gRXNwZWNpYWxseSwgZG9lc24ndCBtYWtlIHNlbnNlIGZvciBudWxsIHN0YXJ0TXMvZW5kTXMuDQogICAgICAgIHRoaXMuaXNTdGFydCA9IHRydWU7DQogICAgICAgIHRoaXMuaXNFbmQgPSB0cnVlOw0KICAgICAgICBpZiAobW9tZW50LmlzTW9tZW50KHN0YXJ0SW5wdXQpKSB7DQogICAgICAgICAgICBzdGFydElucHV0ID0gc3RhcnRJbnB1dC5jbG9uZSgpLnN0cmlwWm9uZSgpOw0KICAgICAgICB9DQogICAgICAgIGlmIChtb21lbnQuaXNNb21lbnQoZW5kSW5wdXQpKSB7DQogICAgICAgICAgICBlbmRJbnB1dCA9IGVuZElucHV0LmNsb25lKCkuc3RyaXBab25lKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHN0YXJ0SW5wdXQpIHsNCiAgICAgICAgICAgIHRoaXMuc3RhcnRNcyA9IHN0YXJ0SW5wdXQudmFsdWVPZigpOw0KICAgICAgICB9DQogICAgICAgIGlmIChlbmRJbnB1dCkgew0KICAgICAgICAgICAgdGhpcy5lbmRNcyA9IGVuZElucHV0LnZhbHVlT2YoKTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICAvKg0KICAgIFNJREVFRkZFQ1Q6IHdpbGwgbXV0YXRlIGV2ZW50UmFuZ2VzLg0KICAgIFdpbGwgcmV0dXJuIGEgbmV3IGFycmF5IHJlc3VsdC4NCiAgICBPbmx5IHdvcmtzIGZvciBub24tb3Blbi1lbmRlZCByYW5nZXMuDQogICAgKi8NCiAgICBVbnpvbmVkUmFuZ2UuaW52ZXJ0UmFuZ2VzID0gZnVuY3Rpb24gKHJhbmdlcywgY29uc3RyYWludFJhbmdlKSB7DQogICAgICAgIHZhciBpbnZlcnRlZFJhbmdlcyA9IFtdOw0KICAgICAgICB2YXIgc3RhcnRNcyA9IGNvbnN0cmFpbnRSYW5nZS5zdGFydE1zOyAvLyB0aGUgZW5kIG9mIHRoZSBwcmV2aW91cyByYW5nZS4gdGhlIHN0YXJ0IG9mIHRoZSBuZXcgcmFuZ2UNCiAgICAgICAgdmFyIGk7DQogICAgICAgIHZhciBkYXRlUmFuZ2U7DQogICAgICAgIC8vIHJhbmdlcyBuZWVkIHRvIGJlIGluIG9yZGVyLiByZXF1aXJlZCBmb3Igb3VyIGRhdGUtd2Fsa2luZyBhbGdvcml0aG0NCiAgICAgICAgcmFuZ2VzLnNvcnQoY29tcGFyZVVuem9uZWRSYW5nZXMpOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcmFuZ2VzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBkYXRlUmFuZ2UgPSByYW5nZXNbaV07DQogICAgICAgICAgICAvLyBhZGQgdGhlIHNwYW4gb2YgdGltZSBiZWZvcmUgdGhlIGV2ZW50IChpZiB0aGVyZSBpcyBhbnkpDQogICAgICAgICAgICBpZiAoZGF0ZVJhbmdlLnN0YXJ0TXMgPiBzdGFydE1zKSB7DQogICAgICAgICAgICAgICAgaW52ZXJ0ZWRSYW5nZXMucHVzaChuZXcgVW56b25lZFJhbmdlKHN0YXJ0TXMsIGRhdGVSYW5nZS5zdGFydE1zKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoZGF0ZVJhbmdlLmVuZE1zID4gc3RhcnRNcykgew0KICAgICAgICAgICAgICAgIHN0YXJ0TXMgPSBkYXRlUmFuZ2UuZW5kTXM7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgLy8gYWRkIHRoZSBzcGFuIG9mIHRpbWUgYWZ0ZXIgdGhlIGxhc3QgZXZlbnQgKGlmIHRoZXJlIGlzIGFueSkNCiAgICAgICAgaWYgKHN0YXJ0TXMgPCBjb25zdHJhaW50UmFuZ2UuZW5kTXMpIHsNCiAgICAgICAgICAgIGludmVydGVkUmFuZ2VzLnB1c2gobmV3IFVuem9uZWRSYW5nZShzdGFydE1zLCBjb25zdHJhaW50UmFuZ2UuZW5kTXMpKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gaW52ZXJ0ZWRSYW5nZXM7DQogICAgfTsNCiAgICBVbnpvbmVkUmFuZ2UucHJvdG90eXBlLmludGVyc2VjdCA9IGZ1bmN0aW9uIChvdGhlclJhbmdlKSB7DQogICAgICAgIHZhciBzdGFydE1zID0gdGhpcy5zdGFydE1zOw0KICAgICAgICB2YXIgZW5kTXMgPSB0aGlzLmVuZE1zOw0KICAgICAgICB2YXIgbmV3UmFuZ2UgPSBudWxsOw0KICAgICAgICBpZiAob3RoZXJSYW5nZS5zdGFydE1zICE9IG51bGwpIHsNCiAgICAgICAgICAgIGlmIChzdGFydE1zID09IG51bGwpIHsNCiAgICAgICAgICAgICAgICBzdGFydE1zID0gb3RoZXJSYW5nZS5zdGFydE1zOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgc3RhcnRNcyA9IE1hdGgubWF4KHN0YXJ0TXMsIG90aGVyUmFuZ2Uuc3RhcnRNcyk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyUmFuZ2UuZW5kTXMgIT0gbnVsbCkgew0KICAgICAgICAgICAgaWYgKGVuZE1zID09IG51bGwpIHsNCiAgICAgICAgICAgICAgICBlbmRNcyA9IG90aGVyUmFuZ2UuZW5kTXM7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICBlbmRNcyA9IE1hdGgubWluKGVuZE1zLCBvdGhlclJhbmdlLmVuZE1zKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBpZiAoc3RhcnRNcyA9PSBudWxsIHx8IGVuZE1zID09IG51bGwgfHwgc3RhcnRNcyA8IGVuZE1zKSB7DQogICAgICAgICAgICBuZXdSYW5nZSA9IG5ldyBVbnpvbmVkUmFuZ2Uoc3RhcnRNcywgZW5kTXMpOw0KICAgICAgICAgICAgbmV3UmFuZ2UuaXNTdGFydCA9IHRoaXMuaXNTdGFydCAmJiBzdGFydE1zID09PSB0aGlzLnN0YXJ0TXM7DQogICAgICAgICAgICBuZXdSYW5nZS5pc0VuZCA9IHRoaXMuaXNFbmQgJiYgZW5kTXMgPT09IHRoaXMuZW5kTXM7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIG5ld1JhbmdlOw0KICAgIH07DQogICAgVW56b25lZFJhbmdlLnByb3RvdHlwZS5pbnRlcnNlY3RzV2l0aCA9IGZ1bmN0aW9uIChvdGhlclJhbmdlKSB7DQogICAgICAgIHJldHVybiAodGhpcy5lbmRNcyA9PSBudWxsIHx8IG90aGVyUmFuZ2Uuc3RhcnRNcyA9PSBudWxsIHx8IHRoaXMuZW5kTXMgPiBvdGhlclJhbmdlLnN0YXJ0TXMpICYmDQogICAgICAgICAgICAodGhpcy5zdGFydE1zID09IG51bGwgfHwgb3RoZXJSYW5nZS5lbmRNcyA9PSBudWxsIHx8IHRoaXMuc3RhcnRNcyA8IG90aGVyUmFuZ2UuZW5kTXMpOw0KICAgIH07DQogICAgVW56b25lZFJhbmdlLnByb3RvdHlwZS5jb250YWluc1JhbmdlID0gZnVuY3Rpb24gKGlubmVyUmFuZ2UpIHsNCiAgICAgICAgcmV0dXJuICh0aGlzLnN0YXJ0TXMgPT0gbnVsbCB8fCAoaW5uZXJSYW5nZS5zdGFydE1zICE9IG51bGwgJiYgaW5uZXJSYW5nZS5zdGFydE1zID49IHRoaXMuc3RhcnRNcykpICYmDQogICAgICAgICAgICAodGhpcy5lbmRNcyA9PSBudWxsIHx8IChpbm5lclJhbmdlLmVuZE1zICE9IG51bGwgJiYgaW5uZXJSYW5nZS5lbmRNcyA8PSB0aGlzLmVuZE1zKSk7DQogICAgfTsNCiAgICAvLyBgZGF0ZWAgY2FuIGJlIGEgbW9tZW50LCBhIERhdGUsIG9yIGEgbWlsbGlzZWNvbmQgdGltZS4NCiAgICBVbnpvbmVkUmFuZ2UucHJvdG90eXBlLmNvbnRhaW5zRGF0ZSA9IGZ1bmN0aW9uIChkYXRlKSB7DQogICAgICAgIHZhciBtcyA9IGRhdGUudmFsdWVPZigpOw0KICAgICAgICByZXR1cm4gKHRoaXMuc3RhcnRNcyA9PSBudWxsIHx8IG1zID49IHRoaXMuc3RhcnRNcykgJiYNCiAgICAgICAgICAgICh0aGlzLmVuZE1zID09IG51bGwgfHwgbXMgPCB0aGlzLmVuZE1zKTsNCiAgICB9Ow0KICAgIC8vIElmIHRoZSBnaXZlbiBkYXRlIGlzIG5vdCB3aXRoaW4gdGhlIGdpdmVuIHJhbmdlLCBtb3ZlIGl0IGluc2lkZS4NCiAgICAvLyAoSWYgaXQncyBwYXN0IHRoZSBlbmQsIG1ha2UgaXQgb25lIG1pbGxpc2Vjb25kIGJlZm9yZSB0aGUgZW5kKS4NCiAgICAvLyBgZGF0ZWAgY2FuIGJlIGEgbW9tZW50LCBhIERhdGUsIG9yIGEgbWlsbGlzZWNvbmQgdGltZS4NCiAgICAvLyBSZXR1cm5zIGEgTVMtdGltZS4NCiAgICBVbnpvbmVkUmFuZ2UucHJvdG90eXBlLmNvbnN0cmFpbkRhdGUgPSBmdW5jdGlvbiAoZGF0ZSkgew0KICAgICAgICB2YXIgbXMgPSBkYXRlLnZhbHVlT2YoKTsNCiAgICAgICAgaWYgKHRoaXMuc3RhcnRNcyAhPSBudWxsICYmIG1zIDwgdGhpcy5zdGFydE1zKSB7DQogICAgICAgICAgICBtcyA9IHRoaXMuc3RhcnRNczsNCiAgICAgICAgfQ0KICAgICAgICBpZiAodGhpcy5lbmRNcyAhPSBudWxsICYmIG1zID49IHRoaXMuZW5kTXMpIHsNCiAgICAgICAgICAgIG1zID0gdGhpcy5lbmRNcyAtIDE7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIG1zOw0KICAgIH07DQogICAgVW56b25lZFJhbmdlLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbiAob3RoZXJSYW5nZSkgew0KICAgICAgICByZXR1cm4gdGhpcy5zdGFydE1zID09PSBvdGhlclJhbmdlLnN0YXJ0TXMgJiYgdGhpcy5lbmRNcyA9PT0gb3RoZXJSYW5nZS5lbmRNczsNCiAgICB9Ow0KICAgIFVuem9uZWRSYW5nZS5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciByYW5nZSA9IG5ldyBVbnpvbmVkUmFuZ2UodGhpcy5zdGFydE1zLCB0aGlzLmVuZE1zKTsNCiAgICAgICAgcmFuZ2UuaXNTdGFydCA9IHRoaXMuaXNTdGFydDsNCiAgICAgICAgcmFuZ2UuaXNFbmQgPSB0aGlzLmlzRW5kOw0KICAgICAgICByZXR1cm4gcmFuZ2U7DQogICAgfTsNCiAgICAvLyBSZXR1cm5zIGFuIGFtYmlnLXpvbmVkIG1vbWVudCBmcm9tIHN0YXJ0TXMuDQogICAgLy8gQkVXQVJFOiByZXR1cm5lZCBtb21lbnQgaXMgbm90IGxvY2FsaXplZC4NCiAgICAvLyBGb3JtYXR0aW5nIGFuZCBzdGFydC1vZi13ZWVrIHdpbGwgYmUgZGVmYXVsdC4NCiAgICBVbnpvbmVkUmFuZ2UucHJvdG90eXBlLmdldFN0YXJ0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5zdGFydE1zICE9IG51bGwpIHsNCiAgICAgICAgICAgIHJldHVybiBtb21lbnRfZXh0XzEuZGVmYXVsdC51dGModGhpcy5zdGFydE1zKS5zdHJpcFpvbmUoKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gbnVsbDsNCiAgICB9Ow0KICAgIC8vIFJldHVybnMgYW4gYW1iaWctem9uZWQgbW9tZW50IGZyb20gc3RhcnRNcy4NCiAgICAvLyBCRVdBUkU6IHJldHVybmVkIG1vbWVudCBpcyBub3QgbG9jYWxpemVkLg0KICAgIC8vIEZvcm1hdHRpbmcgYW5kIHN0YXJ0LW9mLXdlZWsgd2lsbCBiZSBkZWZhdWx0Lg0KICAgIFVuem9uZWRSYW5nZS5wcm90b3R5cGUuZ2V0RW5kID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5lbmRNcyAhPSBudWxsKSB7DQogICAgICAgICAgICByZXR1cm4gbW9tZW50X2V4dF8xLmRlZmF1bHQudXRjKHRoaXMuZW5kTXMpLnN0cmlwWm9uZSgpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBudWxsOw0KICAgIH07DQogICAgVW56b25lZFJhbmdlLnByb3RvdHlwZS5hcyA9IGZ1bmN0aW9uICh1bml0KSB7DQogICAgICAgIHJldHVybiBtb21lbnQudXRjKHRoaXMuZW5kTXMpLmRpZmYobW9tZW50LnV0Yyh0aGlzLnN0YXJ0TXMpLCB1bml0LCB0cnVlKTsNCiAgICB9Ow0KICAgIHJldHVybiBVbnpvbmVkUmFuZ2U7DQp9KCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gVW56b25lZFJhbmdlOw0KLyoNCk9ubHkgd29ya3MgZm9yIG5vbi1vcGVuLWVuZGVkIHJhbmdlcy4NCiovDQpmdW5jdGlvbiBjb21wYXJlVW56b25lZFJhbmdlcyhyYW5nZTEsIHJhbmdlMikgew0KICAgIHJldHVybiByYW5nZTEuc3RhcnRNcyAtIHJhbmdlMi5zdGFydE1zOyAvLyBlYXJsaWVyIHJhbmdlcyBnbyBmaXJzdA0KfQ0KCgovKioqLyB9KSwKLyogNiAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIHRzbGliXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIpOw0KdmFyICQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOw0KdmFyIFBhcnNhYmxlTW9kZWxNaXhpbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMDgpOw0KdmFyIENsYXNzXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMyKTsNCnZhciBFdmVudERlZlBhcnNlcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0OSk7DQp2YXIgRXZlbnRTb3VyY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoRXZlbnRTb3VyY2UsIF9zdXBlcik7DQogICAgLy8gY2FuIHdlIGRvIGF3YXkgd2l0aCBjYWxlbmRhcj8gYXQgbGVhc3QgZm9yIHRoZSBhYnN0cmFjdD8NCiAgICAvLyB1c2VmdWwgZm9yIGJ1aWxkRXZlbnREZWYNCiAgICBmdW5jdGlvbiBFdmVudFNvdXJjZShjYWxlbmRhcikgew0KICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzOw0KICAgICAgICBfdGhpcy5jYWxlbmRhciA9IGNhbGVuZGFyOw0KICAgICAgICBfdGhpcy5jbGFzc05hbWUgPSBbXTsNCiAgICAgICAgX3RoaXMudWlkID0gU3RyaW5nKEV2ZW50U291cmNlLnV1aWQrKyk7DQogICAgICAgIHJldHVybiBfdGhpczsNCiAgICB9DQogICAgLyoNCiAgICByYXdJbnB1dCBjYW4gYmUgYW55IGRhdGEgdHlwZSENCiAgICAqLw0KICAgIEV2ZW50U291cmNlLnBhcnNlID0gZnVuY3Rpb24gKHJhd0lucHV0LCBjYWxlbmRhcikgew0KICAgICAgICB2YXIgc291cmNlID0gbmV3IHRoaXMoY2FsZW5kYXIpOw0KICAgICAgICBpZiAodHlwZW9mIHJhd0lucHV0ID09PSAnb2JqZWN0Jykgew0KICAgICAgICAgICAgaWYgKHNvdXJjZS5hcHBseVByb3BzKHJhd0lucHV0KSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBzb3VyY2U7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH07DQogICAgRXZlbnRTb3VyY2Uubm9ybWFsaXplSWQgPSBmdW5jdGlvbiAoaWQpIHsNCiAgICAgICAgaWYgKGlkKSB7DQogICAgICAgICAgICByZXR1cm4gU3RyaW5nKGlkKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gbnVsbDsNCiAgICB9Ow0KICAgIEV2ZW50U291cmNlLnByb3RvdHlwZS5mZXRjaCA9IGZ1bmN0aW9uIChzdGFydCwgZW5kLCB0aW1lem9uZSkgew0KICAgICAgICAvLyBzdWJjbGFzc2VzIG11c3QgaW1wbGVtZW50LiBtdXN0IHJldHVybiBhIHByb21pc2UuDQogICAgfTsNCiAgICBFdmVudFNvdXJjZS5wcm90b3R5cGUucmVtb3ZlRXZlbnREZWZzQnlJZCA9IGZ1bmN0aW9uIChldmVudERlZklkKSB7DQogICAgICAgIC8vIG9wdGlvbmFsIGZvciBzdWJjbGFzc2VzIHRvIGltcGxlbWVudA0KICAgIH07DQogICAgRXZlbnRTb3VyY2UucHJvdG90eXBlLnJlbW92ZUFsbEV2ZW50RGVmcyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgLy8gb3B0aW9uYWwgZm9yIHN1YmNsYXNzZXMgdG8gaW1wbGVtZW50DQogICAgfTsNCiAgICAvKg0KICAgIEZvciBjb21wYWlyaW5nL21hdGNoaW5nDQogICAgKi8NCiAgICBFdmVudFNvdXJjZS5wcm90b3R5cGUuZ2V0UHJpbWl0aXZlID0gZnVuY3Rpb24gKG90aGVyU291cmNlKSB7DQogICAgICAgIC8vIHN1YmNsYXNzZXMgbXVzdCBpbXBsZW1lbnQNCiAgICB9Ow0KICAgIEV2ZW50U291cmNlLnByb3RvdHlwZS5wYXJzZUV2ZW50RGVmcyA9IGZ1bmN0aW9uIChyYXdFdmVudERlZnMpIHsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIHZhciBldmVudERlZjsNCiAgICAgICAgdmFyIGV2ZW50RGVmcyA9IFtdOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcmF3RXZlbnREZWZzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBldmVudERlZiA9IHRoaXMucGFyc2VFdmVudERlZihyYXdFdmVudERlZnNbaV0pOw0KICAgICAgICAgICAgaWYgKGV2ZW50RGVmKSB7DQogICAgICAgICAgICAgICAgZXZlbnREZWZzLnB1c2goZXZlbnREZWYpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiBldmVudERlZnM7DQogICAgfTsNCiAgICBFdmVudFNvdXJjZS5wcm90b3R5cGUucGFyc2VFdmVudERlZiA9IGZ1bmN0aW9uIChyYXdJbnB1dCkgew0KICAgICAgICB2YXIgY2FsZW5kYXJUcmFuc2Zvcm0gPSB0aGlzLmNhbGVuZGFyLm9wdCgnZXZlbnREYXRhVHJhbnNmb3JtJyk7DQogICAgICAgIHZhciBzb3VyY2VUcmFuc2Zvcm0gPSB0aGlzLmV2ZW50RGF0YVRyYW5zZm9ybTsNCiAgICAgICAgaWYgKGNhbGVuZGFyVHJhbnNmb3JtKSB7DQogICAgICAgICAgICByYXdJbnB1dCA9IGNhbGVuZGFyVHJhbnNmb3JtKHJhd0lucHV0LCB0aGlzLmNhbGVuZGFyKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoc291cmNlVHJhbnNmb3JtKSB7DQogICAgICAgICAgICByYXdJbnB1dCA9IHNvdXJjZVRyYW5zZm9ybShyYXdJbnB1dCwgdGhpcy5jYWxlbmRhcik7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIEV2ZW50RGVmUGFyc2VyXzEuZGVmYXVsdC5wYXJzZShyYXdJbnB1dCwgdGhpcyk7DQogICAgfTsNCiAgICBFdmVudFNvdXJjZS5wcm90b3R5cGUuYXBwbHlNYW51YWxTdGFuZGFyZFByb3BzID0gZnVuY3Rpb24gKHJhd1Byb3BzKSB7DQogICAgICAgIGlmIChyYXdQcm9wcy5pZCAhPSBudWxsKSB7DQogICAgICAgICAgICB0aGlzLmlkID0gRXZlbnRTb3VyY2Uubm9ybWFsaXplSWQocmF3UHJvcHMuaWQpOw0KICAgICAgICB9DQogICAgICAgIC8vIFRPRE86IGNvbnZlcmdlIHdpdGggRXZlbnREZWYNCiAgICAgICAgaWYgKCQuaXNBcnJheShyYXdQcm9wcy5jbGFzc05hbWUpKSB7DQogICAgICAgICAgICB0aGlzLmNsYXNzTmFtZSA9IHJhd1Byb3BzLmNsYXNzTmFtZTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICh0eXBlb2YgcmF3UHJvcHMuY2xhc3NOYW1lID09PSAnc3RyaW5nJykgew0KICAgICAgICAgICAgdGhpcy5jbGFzc05hbWUgPSByYXdQcm9wcy5jbGFzc05hbWUuc3BsaXQoL1xzKy8pOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgIH07DQogICAgRXZlbnRTb3VyY2UudXVpZCA9IDA7DQogICAgRXZlbnRTb3VyY2UuZGVmaW5lU3RhbmRhcmRQcm9wcyA9IFBhcnNhYmxlTW9kZWxNaXhpbl8xLmRlZmF1bHQuZGVmaW5lU3RhbmRhcmRQcm9wczsNCiAgICBFdmVudFNvdXJjZS5jb3B5VmVyYmF0aW1TdGFuZGFyZFByb3BzID0gUGFyc2FibGVNb2RlbE1peGluXzEuZGVmYXVsdC5jb3B5VmVyYmF0aW1TdGFuZGFyZFByb3BzOw0KICAgIHJldHVybiBFdmVudFNvdXJjZTsNCn0oQ2xhc3NfMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBFdmVudFNvdXJjZTsNClBhcnNhYmxlTW9kZWxNaXhpbl8xLmRlZmF1bHQubWl4SW50byhFdmVudFNvdXJjZSk7DQovLyBQYXJzaW5nDQovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCkV2ZW50U291cmNlLmRlZmluZVN0YW5kYXJkUHJvcHMoew0KICAgIC8vIG1hbnVhbGx5IHByb2Nlc3MuLi4NCiAgICBpZDogZmFsc2UsDQogICAgY2xhc3NOYW1lOiBmYWxzZSwNCiAgICAvLyBhdXRvbWF0aWNhbGx5IHRyYW5zZmVyLi4uDQogICAgY29sb3I6IHRydWUsDQogICAgYmFja2dyb3VuZENvbG9yOiB0cnVlLA0KICAgIGJvcmRlckNvbG9yOiB0cnVlLA0KICAgIHRleHRDb2xvcjogdHJ1ZSwNCiAgICBlZGl0YWJsZTogdHJ1ZSwNCiAgICBzdGFydEVkaXRhYmxlOiB0cnVlLA0KICAgIGR1cmF0aW9uRWRpdGFibGU6IHRydWUsDQogICAgcmVuZGVyaW5nOiB0cnVlLA0KICAgIG92ZXJsYXA6IHRydWUsDQogICAgY29uc3RyYWludDogdHJ1ZSwNCiAgICBhbGxEYXlEZWZhdWx0OiB0cnVlLA0KICAgIGV2ZW50RGF0YVRyYW5zZm9ybTogdHJ1ZQ0KfSk7DQoKCi8qKiovIH0pLAovKiA3ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCi8qDQpVdGlsaXR5IG1ldGhvZHMgZm9yIGVhc2lseSBsaXN0ZW5pbmcgdG8gZXZlbnRzIG9uIGFub3RoZXIgb2JqZWN0LA0KYW5kIG1vcmUgaW1wb3J0YW50bHksIGVhc2lseSB1bmxpc3RlbmluZyBmcm9tIHRoZW0uDQoKVVNBR0U6DQogIGltcG9ydCB7IGRlZmF1bHQgYXMgTGlzdGVuZXJNaXhpbiwgTGlzdGVuZXJJbnRlcmZhY2UgfSBmcm9tICcuL0xpc3RlbmVyTWl4aW4nDQppbiBjbGFzczoNCiAgbGlzdGVuVG86IExpc3RlbmVySW50ZXJmYWNlWydsaXN0ZW5UbyddDQogIHN0b3BMaXN0ZW5pbmdUbzogTGlzdGVuZXJJbnRlcmZhY2VbJ3N0b3BMaXN0ZW5pbmdUbyddDQphZnRlciBjbGFzczoNCiAgTGlzdGVuZXJNaXhpbi5taXhJbnRvKFRoZUNsYXNzKQ0KKi8NCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdHNsaWJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgTWl4aW5fMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTQpOw0KdmFyIGd1aWQgPSAwOw0KdmFyIExpc3RlbmVyTWl4aW4gPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoTGlzdGVuZXJNaXhpbiwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBMaXN0ZW5lck1peGluKCkgew0KICAgICAgICByZXR1cm4gX3N1cGVyICE9PSBudWxsICYmIF9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7DQogICAgfQ0KICAgIC8qDQogICAgR2l2ZW4gYW4gYG90aGVyYCBvYmplY3QgdGhhdCBoYXMgb24vb2ZmIG1ldGhvZHMsIGJpbmQgdGhlIGdpdmVuIGBjYWxsYmFja2AgdG8gYW4gZXZlbnQgYnkgdGhlIGdpdmVuIG5hbWUuDQogICAgVGhlIGBjYWxsYmFja2Agd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgYHRoaXNgIGNvbnRleHQgb2YgdGhlIG9iamVjdCB0aGF0IC5saXN0ZW5UbyBpcyBiZWluZyBjYWxsZWQgb24uDQogICAgQ2FuIGJlIGNhbGxlZDoNCiAgICAgIC5saXN0ZW5UbyhvdGhlciwgZXZlbnROYW1lLCBjYWxsYmFjaykNCiAgICBPUg0KICAgICAgLmxpc3RlblRvKG90aGVyLCB7DQogICAgICAgIGV2ZW50TmFtZTE6IGNhbGxiYWNrMSwNCiAgICAgICAgZXZlbnROYW1lMjogY2FsbGJhY2syDQogICAgICB9KQ0KICAgICovDQogICAgTGlzdGVuZXJNaXhpbi5wcm90b3R5cGUubGlzdGVuVG8gPSBmdW5jdGlvbiAob3RoZXIsIGFyZywgY2FsbGJhY2spIHsNCiAgICAgICAgaWYgKHR5cGVvZiBhcmcgPT09ICdvYmplY3QnKSB7DQogICAgICAgICAgICBmb3IgKHZhciBldmVudE5hbWUgaW4gYXJnKSB7DQogICAgICAgICAgICAgICAgaWYgKGFyZy5oYXNPd25Qcm9wZXJ0eShldmVudE5hbWUpKSB7DQogICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuVG8ob3RoZXIsIGV2ZW50TmFtZSwgYXJnW2V2ZW50TmFtZV0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICh0eXBlb2YgYXJnID09PSAnc3RyaW5nJykgew0KICAgICAgICAgICAgb3RoZXIub24oYXJnICsgJy4nICsgdGhpcy5nZXRMaXN0ZW5lck5hbWVzcGFjZSgpLCAvLyB1c2UgZXZlbnQgbmFtZXNwYWNpbmcgdG8gaWRlbnRpZnkgdGhpcyBvYmplY3QNCiAgICAgICAgICAgICQucHJveHkoY2FsbGJhY2ssIHRoaXMpIC8vIGFsd2F5cyB1c2UgYHRoaXNgIGNvbnRleHQNCiAgICAgICAgICAgIC8vIHRoZSB1c3VhbGx5LXVuZGVzaXJlZCBqUXVlcnkgZ3VpZCBiZWhhdmlvciBkb2Vzbid0IG1hdHRlciwNCiAgICAgICAgICAgIC8vIGJlY2F1c2Ugd2UgYWx3YXlzIHVuYmluZCB2aWEgbmFtZXNwYWNlDQogICAgICAgICAgICApOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvKg0KICAgIENhdXNlcyB0aGUgY3VycmVudCBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZXZlbnRzIG9uIHRoZSBgb3RoZXJgIG9iamVjdC4NCiAgICBgZXZlbnROYW1lYCBpcyBvcHRpb25hbC4gSWYgb21pdHRlZCwgd2lsbCBzdG9wIGxpc3RlbmluZyB0byBBTEwgZXZlbnRzIG9uIGBvdGhlcmAuDQogICAgKi8NCiAgICBMaXN0ZW5lck1peGluLnByb3RvdHlwZS5zdG9wTGlzdGVuaW5nVG8gPSBmdW5jdGlvbiAob3RoZXIsIGV2ZW50TmFtZSkgew0KICAgICAgICBvdGhlci5vZmYoKGV2ZW50TmFtZSB8fCAnJykgKyAnLicgKyB0aGlzLmdldExpc3RlbmVyTmFtZXNwYWNlKCkpOw0KICAgIH07DQogICAgLyoNCiAgICBSZXR1cm5zIGEgc3RyaW5nLCB1bmlxdWUgdG8gdGhpcyBvYmplY3QsIHRvIGJlIHVzZWQgZm9yIGV2ZW50IG5hbWVzcGFjaW5nDQogICAgKi8NCiAgICBMaXN0ZW5lck1peGluLnByb3RvdHlwZS5nZXRMaXN0ZW5lck5hbWVzcGFjZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMubGlzdGVuZXJJZCA9PSBudWxsKSB7DQogICAgICAgICAgICB0aGlzLmxpc3RlbmVySWQgPSBndWlkKys7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuICdfbGlzdGVuZXInICsgdGhpcy5saXN0ZW5lcklkOw0KICAgIH07DQogICAgcmV0dXJuIExpc3RlbmVyTWl4aW47DQp9KE1peGluXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gTGlzdGVuZXJNaXhpbjsNCgoKLyoqKi8gfSksCi8qIDggKi8sCi8qIDkgKi8sCi8qIDEwICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgbW9tZW50ID0gX193ZWJwYWNrX3JlcXVpcmVfXygwKTsNCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCnZhciB1dGlsXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQpOw0KdmFyIGFtYmlnRGF0ZU9mTW9udGhSZWdleCA9IC9eXHMqXGR7NH0tXGRcZCQvOw0KdmFyIGFtYmlnVGltZU9yWm9uZVJlZ2V4ID0gL15ccypcZHs0fS0oPzooXGRcZC1cZFxkKXwoV1xkXGQkKXwoV1xkXGQtXGQpfChcZFxkXGQpKSgoVHwgKShcZFxkKDpcZFxkKDpcZFxkKFwuXGQrKT8pPyk/KT8pPyQvOw0KdmFyIG5ld01vbWVudFByb3RvID0gbW9tZW50LmZuOyAvLyB3aGVyZSB3ZSB3aWxsIGF0dGFjaCBvdXIgbmV3IG1ldGhvZHMNCmV4cG9ydHMubmV3TW9tZW50UHJvdG8gPSBuZXdNb21lbnRQcm90bzsNCnZhciBvbGRNb21lbnRQcm90byA9ICQuZXh0ZW5kKHt9LCBuZXdNb21lbnRQcm90byk7IC8vIGNvcHkgb2Ygb3JpZ2luYWwgbW9tZW50IG1ldGhvZHMNCmV4cG9ydHMub2xkTW9tZW50UHJvdG8gPSBvbGRNb21lbnRQcm90bzsNCi8vIHRlbGwgbW9tZW50anMgdG8gdHJhbnNmZXIgdGhlc2UgcHJvcGVydGllcyB1cG9uIGNsb25lDQp2YXIgbW9tZW50UHJvcGVydGllcyA9IG1vbWVudC5tb21lbnRQcm9wZXJ0aWVzOw0KbW9tZW50UHJvcGVydGllcy5wdXNoKCdfZnVsbENhbGVuZGFyJyk7DQptb21lbnRQcm9wZXJ0aWVzLnB1c2goJ19hbWJpZ1RpbWUnKTsNCm1vbWVudFByb3BlcnRpZXMucHVzaCgnX2FtYmlnWm9uZScpOw0KLyoNCkNhbGwgdGhpcyBpZiB5b3Ugd2FudCBNb21lbnQncyBvcmlnaW5hbCBmb3JtYXQgbWV0aG9kIHRvIGJlIHVzZWQNCiovDQpmdW5jdGlvbiBvbGRNb21lbnRGb3JtYXQobW9tLCBmb3JtYXRTdHIpIHsNCiAgICByZXR1cm4gb2xkTW9tZW50UHJvdG8uZm9ybWF0LmNhbGwobW9tLCBmb3JtYXRTdHIpOyAvLyBvbGRNb21lbnRQcm90byBkZWZpbmVkIGluIG1vbWVudC1leHQuanMNCn0NCmV4cG9ydHMub2xkTW9tZW50Rm9ybWF0ID0gb2xkTW9tZW50Rm9ybWF0Ow0KLy8gQ3JlYXRpbmcNCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCi8vIENyZWF0ZXMgYSBuZXcgbW9tZW50LCBzaW1pbGFyIHRvIHRoZSB2YW5pbGxhIG1vbWVudCguLi4pIGNvbnN0cnVjdG9yLCBidXQgd2l0aA0KLy8gZXh0cmEgZmVhdHVyZXMgKGFtYmlndW91cyB0aW1lLCBlbmhhbmNlZCBmb3JtYXR0aW5nKS4gV2hlbiBnaXZlbiBhbiBleGlzdGluZyBtb21lbnQsDQovLyBpdCB3aWxsIGZ1bmN0aW9uIGFzIGEgY2xvbmUgKGFuZCByZXRhaW4gdGhlIHpvbmUgb2YgdGhlIG1vbWVudCkuIEFueXRoaW5nIGVsc2Ugd2lsbA0KLy8gcmVzdWx0IGluIGEgbW9tZW50IGluIHRoZSBsb2NhbCB6b25lLg0KdmFyIG1vbWVudEV4dCA9IGZ1bmN0aW9uICgpIHsNCiAgICByZXR1cm4gbWFrZU1vbWVudChhcmd1bWVudHMpOw0KfTsNCmV4cG9ydHMuZGVmYXVsdCA9IG1vbWVudEV4dDsNCi8vIFNhbWVzIGFzIG1vbWVudEV4dCwgYnV0IGZvcmNlcyB0aGUgcmVzdWx0aW5nIG1vbWVudCB0byBiZSBpbiB0aGUgVVRDIHRpbWV6b25lLg0KbW9tZW50RXh0LnV0YyA9IGZ1bmN0aW9uICgpIHsNCiAgICB2YXIgbW9tID0gbWFrZU1vbWVudChhcmd1bWVudHMsIHRydWUpOw0KICAgIC8vIEZvcmNlIGl0IGludG8gVVRDIGJlY2F1c2UgbWFrZU1vbWVudCBkb2Vzbid0IGd1YXJhbnRlZSBpdA0KICAgIC8vIChpZiBnaXZlbiBhIHByZS1leGlzdGluZyBtb21lbnQgZm9yIGV4YW1wbGUpDQogICAgaWYgKG1vbS5oYXNUaW1lKCkpIHsNCiAgICAgICAgbW9tLnV0YygpOw0KICAgIH0NCiAgICByZXR1cm4gbW9tOw0KfTsNCi8vIFNhbWUgYXMgbW9tZW50RXh0LCBidXQgd2hlbiBnaXZlbiBhbiBJU084NjAxIHN0cmluZywgdGhlIHRpbWV6b25lIG9mZnNldCBpcyBwcmVzZXJ2ZWQuDQovLyBJU084NjAxIHN0cmluZ3Mgd2l0aCBubyB0aW1lem9uZSBvZmZzZXQgd2lsbCBiZWNvbWUgYW1iaWd1b3VzbHkgem9uZWQuDQptb21lbnRFeHQucGFyc2Vab25lID0gZnVuY3Rpb24gKCkgew0KICAgIHJldHVybiBtYWtlTW9tZW50KGFyZ3VtZW50cywgdHJ1ZSwgdHJ1ZSk7DQp9Ow0KLy8gQnVpbGRzIGFuIGVuaGFuY2VkIG1vbWVudCBmcm9tIGFyZ3MuIFdoZW4gZ2l2ZW4gYW4gZXhpc3RpbmcgbW9tZW50LCBpdCBjbG9uZXMuIFdoZW4gZ2l2ZW4gYQ0KLy8gbmF0aXZlIERhdGUsIG9yIGNhbGxlZCB3aXRoIG5vIGFyZ3VtZW50cyAodGhlIGN1cnJlbnQgdGltZSksIHRoZSByZXN1bHRpbmcgbW9tZW50IHdpbGwgYmUgbG9jYWwuDQovLyBBbnl0aGluZyBlbHNlIG5lZWRzIHRvIGJlICJwYXJzZWQiIChhIHN0cmluZyBvciBhbiBhcnJheSksIGFuZCB3aWxsIGJlIGFmZmVjdGVkIGJ5Og0KLy8gICAgcGFyc2VBc1VUQyAtIGlmIHRoZXJlIGlzIG5vIHpvbmUgaW5mb3JtYXRpb24sIHNob3VsZCB3ZSBwYXJzZSB0aGUgaW5wdXQgaW4gVVRDPw0KLy8gICAgcGFyc2Vab25lIC0gaWYgdGhlcmUgaXMgem9uZSBpbmZvcm1hdGlvbiwgc2hvdWxkIHdlIGZvcmNlIHRoZSB6b25lIG9mIHRoZSBtb21lbnQ/DQpmdW5jdGlvbiBtYWtlTW9tZW50KGFyZ3MsIHBhcnNlQXNVVEMsIHBhcnNlWm9uZSkgew0KICAgIGlmIChwYXJzZUFzVVRDID09PSB2b2lkIDApIHsgcGFyc2VBc1VUQyA9IGZhbHNlOyB9DQogICAgaWYgKHBhcnNlWm9uZSA9PT0gdm9pZCAwKSB7IHBhcnNlWm9uZSA9IGZhbHNlOyB9DQogICAgdmFyIGlucHV0ID0gYXJnc1swXTsNCiAgICB2YXIgaXNTaW5nbGVTdHJpbmcgPSBhcmdzLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnOw0KICAgIHZhciBpc0FtYmlnVGltZTsNCiAgICB2YXIgaXNBbWJpZ1pvbmU7DQogICAgdmFyIGFtYmlnTWF0Y2g7DQogICAgdmFyIG1vbTsNCiAgICBpZiAobW9tZW50LmlzTW9tZW50KGlucHV0KSB8fCB1dGlsXzEuaXNOYXRpdmVEYXRlKGlucHV0KSB8fCBpbnB1dCA9PT0gdW5kZWZpbmVkKSB7DQogICAgICAgIG1vbSA9IG1vbWVudC5hcHBseShudWxsLCBhcmdzKTsNCiAgICB9DQogICAgZWxzZSB7DQogICAgICAgIGlzQW1iaWdUaW1lID0gZmFsc2U7DQogICAgICAgIGlzQW1iaWdab25lID0gZmFsc2U7DQogICAgICAgIGlmIChpc1NpbmdsZVN0cmluZykgew0KICAgICAgICAgICAgaWYgKGFtYmlnRGF0ZU9mTW9udGhSZWdleC50ZXN0KGlucHV0KSkgew0KICAgICAgICAgICAgICAgIC8vIGFjY2VwdCBzdHJpbmdzIGxpa2UgJzIwMTQtMDUnLCBidXQgY29udmVydCB0byB0aGUgZmlyc3Qgb2YgdGhlIG1vbnRoDQogICAgICAgICAgICAgICAgaW5wdXQgKz0gJy0wMSc7DQogICAgICAgICAgICAgICAgYXJncyA9IFtpbnB1dF07IC8vIGZvciB3aGVuIHdlIHBhc3MgaXQgb24gdG8gbW9tZW50J3MgY29uc3RydWN0b3INCiAgICAgICAgICAgICAgICBpc0FtYmlnVGltZSA9IHRydWU7DQogICAgICAgICAgICAgICAgaXNBbWJpZ1pvbmUgPSB0cnVlOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAoKGFtYmlnTWF0Y2ggPSBhbWJpZ1RpbWVPclpvbmVSZWdleC5leGVjKGlucHV0KSkpIHsNCiAgICAgICAgICAgICAgICBpc0FtYmlnVGltZSA9ICFhbWJpZ01hdGNoWzVdOyAvLyBubyB0aW1lIHBhcnQ/DQogICAgICAgICAgICAgICAgaXNBbWJpZ1pvbmUgPSB0cnVlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGVsc2UgaWYgKCQuaXNBcnJheShpbnB1dCkpIHsNCiAgICAgICAgICAgIC8vIGFycmF5cyBoYXZlIG5vIHRpbWV6b25lIGluZm9ybWF0aW9uLCBzbyBhc3N1bWUgYW1iaWd1b3VzIHpvbmUNCiAgICAgICAgICAgIGlzQW1iaWdab25lID0gdHJ1ZTsNCiAgICAgICAgfQ0KICAgICAgICAvLyBvdGhlcndpc2UsIHByb2JhYmx5IGEgc3RyaW5nIHdpdGggYSBmb3JtYXQNCiAgICAgICAgaWYgKHBhcnNlQXNVVEMgfHwgaXNBbWJpZ1RpbWUpIHsNCiAgICAgICAgICAgIG1vbSA9IG1vbWVudC51dGMuYXBwbHkobW9tZW50LCBhcmdzKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIG1vbSA9IG1vbWVudC5hcHBseShudWxsLCBhcmdzKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoaXNBbWJpZ1RpbWUpIHsNCiAgICAgICAgICAgIG1vbS5fYW1iaWdUaW1lID0gdHJ1ZTsNCiAgICAgICAgICAgIG1vbS5fYW1iaWdab25lID0gdHJ1ZTsgLy8gYW1iaWd1b3VzIHRpbWUgYWx3YXlzIG1lYW5zIGFtYmlndW91cyB6b25lDQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAocGFyc2Vab25lKSB7DQogICAgICAgICAgICBpZiAoaXNBbWJpZ1pvbmUpIHsNCiAgICAgICAgICAgICAgICBtb20uX2FtYmlnWm9uZSA9IHRydWU7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIGlmIChpc1NpbmdsZVN0cmluZykgew0KICAgICAgICAgICAgICAgIG1vbS51dGNPZmZzZXQoaW5wdXQpOyAvLyBpZiBub3QgYSB2YWxpZCB6b25lLCB3aWxsIGFzc2lnbiBVVEMNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCiAgICBtb20uX2Z1bGxDYWxlbmRhciA9IHRydWU7IC8vIGZsYWcgZm9yIGV4dGVuZGVkIGZ1bmN0aW9uYWxpdHkNCiAgICByZXR1cm4gbW9tOw0KfQ0KLy8gV2VlayBOdW1iZXINCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCi8vIFJldHVybnMgdGhlIHdlZWsgbnVtYmVyLCBjb25zaWRlcmluZyB0aGUgbG9jYWxlJ3MgY3VzdG9tIHdlZWsgbnVtYmVyIGNhbGN1YXRpb24NCi8vIGB3ZWVrc2AgaXMgYW4gYWxpYXMgZm9yIGB3ZWVrYA0KbmV3TW9tZW50UHJvdG8ud2VlayA9IG5ld01vbWVudFByb3RvLndlZWtzID0gZnVuY3Rpb24gKGlucHV0KSB7DQogICAgdmFyIHdlZWtDYWxjID0gdGhpcy5fbG9jYWxlLl9mdWxsQ2FsZW5kYXJfd2Vla0NhbGM7DQogICAgaWYgKGlucHV0ID09IG51bGwgJiYgdHlwZW9mIHdlZWtDYWxjID09PSAnZnVuY3Rpb24nKSB7DQogICAgICAgIHJldHVybiB3ZWVrQ2FsYyh0aGlzKTsNCiAgICB9DQogICAgZWxzZSBpZiAod2Vla0NhbGMgPT09ICdJU08nKSB7DQogICAgICAgIHJldHVybiBvbGRNb21lbnRQcm90by5pc29XZWVrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IC8vIElTTyBnZXR0ZXIvc2V0dGVyDQogICAgfQ0KICAgIHJldHVybiBvbGRNb21lbnRQcm90by53ZWVrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IC8vIGxvY2FsIGdldHRlci9zZXR0ZXINCn07DQovLyBUaW1lLW9mLWRheQ0KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KLy8gR0VUVEVSDQovLyBSZXR1cm5zIGEgRHVyYXRpb24gd2l0aCB0aGUgaG91cnMvbWludXRlcy9zZWNvbmRzL21zIHZhbHVlcyBvZiB0aGUgbW9tZW50Lg0KLy8gSWYgdGhlIG1vbWVudCBoYXMgYW4gYW1iaWd1b3VzIHRpbWUsIGEgZHVyYXRpb24gb2YgMDA6MDAgd2lsbCBiZSByZXR1cm5lZC4NCi8vDQovLyBTRVRURVINCi8vIFlvdSBjYW4gc3VwcGx5IGEgRHVyYXRpb24sIGEgTW9tZW50LCBvciBhIER1cmF0aW9uLWxpa2UgYXJndW1lbnQuDQovLyBXaGVuIHNldHRpbmcgdGhlIHRpbWUsIGFuZCB0aGUgbW9tZW50IGhhcyBhbiBhbWJpZ3VvdXMgdGltZSwgaXQgdGhlbiBiZWNvbWVzIHVuYW1iaWd1b3VzLg0KbmV3TW9tZW50UHJvdG8udGltZSA9IGZ1bmN0aW9uICh0aW1lKSB7DQogICAgLy8gRmFsbGJhY2sgdG8gdGhlIG9yaWdpbmFsIG1ldGhvZCAoaWYgdGhlcmUgaXMgb25lKSBpZiB0aGlzIG1vbWVudCB3YXNuJ3QgY3JlYXRlZCB2aWEgRnVsbENhbGVuZGFyLg0KICAgIC8vIGB0aW1lYCBpcyBhIGdlbmVyaWMgZW5vdWdoIG1ldGhvZCBuYW1lIHdoZXJlIHRoaXMgcHJlY2F1dGlvbiBpcyBuZWNlc3NhcnkgdG8gYXZvaWQgY29sbGlzaW9ucyB3LyBvdGhlciBwbHVnaW5zLg0KICAgIGlmICghdGhpcy5fZnVsbENhbGVuZGFyKSB7DQogICAgICAgIHJldHVybiBvbGRNb21lbnRQcm90by50aW1lLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7DQogICAgfQ0KICAgIGlmICh0aW1lID09IG51bGwpIHsNCiAgICAgICAgcmV0dXJuIG1vbWVudC5kdXJhdGlvbih7DQogICAgICAgICAgICBob3VyczogdGhpcy5ob3VycygpLA0KICAgICAgICAgICAgbWludXRlczogdGhpcy5taW51dGVzKCksDQogICAgICAgICAgICBzZWNvbmRzOiB0aGlzLnNlY29uZHMoKSwNCiAgICAgICAgICAgIG1pbGxpc2Vjb25kczogdGhpcy5taWxsaXNlY29uZHMoKQ0KICAgICAgICB9KTsNCiAgICB9DQogICAgZWxzZSB7DQogICAgICAgIHRoaXMuX2FtYmlnVGltZSA9IGZhbHNlOyAvLyBtYXJrIHRoYXQgdGhlIG1vbWVudCBub3cgaGFzIGEgdGltZQ0KICAgICAgICBpZiAoIW1vbWVudC5pc0R1cmF0aW9uKHRpbWUpICYmICFtb21lbnQuaXNNb21lbnQodGltZSkpIHsNCiAgICAgICAgICAgIHRpbWUgPSBtb21lbnQuZHVyYXRpb24odGltZSk7DQogICAgICAgIH0NCiAgICAgICAgLy8gVGhlIGRheSB2YWx1ZSBzaG91bGQgY2F1c2Ugb3ZlcmZsb3cgKHNvIDI0IGhvdXJzIGJlY29tZXMgMDA6MDA6MDAgb2YgbmV4dCBkYXkpLg0KICAgICAgICAvLyBPbmx5IGZvciBEdXJhdGlvbiB0aW1lcywgbm90IE1vbWVudCB0aW1lcy4NCiAgICAgICAgdmFyIGRheUhvdXJzID0gMDsNCiAgICAgICAgaWYgKG1vbWVudC5pc0R1cmF0aW9uKHRpbWUpKSB7DQogICAgICAgICAgICBkYXlIb3VycyA9IE1hdGguZmxvb3IodGltZS5hc0RheXMoKSkgKiAyNDsNCiAgICAgICAgfQ0KICAgICAgICAvLyBXZSBuZWVkIHRvIHNldCB0aGUgaW5kaXZpZHVhbCBmaWVsZHMuDQogICAgICAgIC8vIENhbid0IHVzZSBzdGFydE9mKCdkYXknKSB0aGVuIGFkZCBkdXJhdGlvbi4gSW4gY2FzZSBvZiBEU1QgYXQgc3RhcnQgb2YgZGF5Lg0KICAgICAgICByZXR1cm4gdGhpcy5ob3VycyhkYXlIb3VycyArIHRpbWUuaG91cnMoKSkNCiAgICAgICAgICAgIC5taW51dGVzKHRpbWUubWludXRlcygpKQ0KICAgICAgICAgICAgLnNlY29uZHModGltZS5zZWNvbmRzKCkpDQogICAgICAgICAgICAubWlsbGlzZWNvbmRzKHRpbWUubWlsbGlzZWNvbmRzKCkpOw0KICAgIH0NCn07DQovLyBDb252ZXJ0cyB0aGUgbW9tZW50IHRvIFVUQywgc3RyaXBwaW5nIG91dCBpdHMgdGltZS1vZi1kYXkgYW5kIHRpbWV6b25lIG9mZnNldCwNCi8vIGJ1dCBwcmVzZXJ2aW5nIGl0cyBZTUQuIEEgbW9tZW50IHdpdGggYSBzdHJpcHBlZCB0aW1lIHdpbGwgZGlzcGxheSBubyB0aW1lDQovLyBub3IgdGltZXpvbmUgb2Zmc2V0IHdoZW4gLmZvcm1hdCgpIGlzIGNhbGxlZC4NCm5ld01vbWVudFByb3RvLnN0cmlwVGltZSA9IGZ1bmN0aW9uICgpIHsNCiAgICBpZiAoIXRoaXMuX2FtYmlnVGltZSkgew0KICAgICAgICB0aGlzLnV0Yyh0cnVlKTsgLy8ga2VlcExvY2FsVGltZT10cnVlIChmb3Iga2VlcGluZyAqZGF0ZSogdmFsdWUpDQogICAgICAgIC8vIHNldCB0aW1lIHRvIHplcm8NCiAgICAgICAgdGhpcy5zZXQoew0KICAgICAgICAgICAgaG91cnM6IDAsDQogICAgICAgICAgICBtaW51dGVzOiAwLA0KICAgICAgICAgICAgc2Vjb25kczogMCwNCiAgICAgICAgICAgIG1zOiAwDQogICAgICAgIH0pOw0KICAgICAgICAvLyBNYXJrIHRoZSB0aW1lIGFzIGFtYmlndW91cy4gVGhpcyBuZWVkcyB0byBoYXBwZW4gYWZ0ZXIgdGhlIC51dGMoKSBjYWxsLCB3aGljaCBtaWdodCBjYWxsIC51dGNPZmZzZXQoKSwNCiAgICAgICAgLy8gd2hpY2ggY2xlYXJzIGFsbCBhbWJpZyBmbGFncy4NCiAgICAgICAgdGhpcy5fYW1iaWdUaW1lID0gdHJ1ZTsNCiAgICAgICAgdGhpcy5fYW1iaWdab25lID0gdHJ1ZTsgLy8gaWYgYW1iaWd1b3VzIHRpbWUsIGFsc28gYW1iaWd1b3VzIHRpbWV6b25lIG9mZnNldA0KICAgIH0NCiAgICByZXR1cm4gdGhpczsgLy8gZm9yIGNoYWluaW5nDQp9Ow0KLy8gUmV0dXJucyBpZiB0aGUgbW9tZW50IGhhcyBhIG5vbi1hbWJpZ3VvdXMgdGltZSAoYm9vbGVhbikNCm5ld01vbWVudFByb3RvLmhhc1RpbWUgPSBmdW5jdGlvbiAoKSB7DQogICAgcmV0dXJuICF0aGlzLl9hbWJpZ1RpbWU7DQp9Ow0KLy8gVGltZXpvbmUNCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCi8vIENvbnZlcnRzIHRoZSBtb21lbnQgdG8gVVRDLCBzdHJpcHBpbmcgb3V0IGl0cyB0aW1lem9uZSBvZmZzZXQsIGJ1dCBwcmVzZXJ2aW5nIGl0cw0KLy8gWU1EIGFuZCB0aW1lLW9mLWRheS4gQSBtb21lbnQgd2l0aCBhIHN0cmlwcGVkIHRpbWV6b25lIG9mZnNldCB3aWxsIGRpc3BsYXkgbm8NCi8vIHRpbWV6b25lIG9mZnNldCB3aGVuIC5mb3JtYXQoKSBpcyBjYWxsZWQuDQpuZXdNb21lbnRQcm90by5zdHJpcFpvbmUgPSBmdW5jdGlvbiAoKSB7DQogICAgdmFyIHdhc0FtYmlnVGltZTsNCiAgICBpZiAoIXRoaXMuX2FtYmlnWm9uZSkgew0KICAgICAgICB3YXNBbWJpZ1RpbWUgPSB0aGlzLl9hbWJpZ1RpbWU7DQogICAgICAgIHRoaXMudXRjKHRydWUpOyAvLyBrZWVwTG9jYWxUaW1lPXRydWUgKGZvciBrZWVwaW5nIGRhdGUgYW5kIHRpbWUgdmFsdWVzKQ0KICAgICAgICAvLyB0aGUgYWJvdmUgY2FsbCB0byAudXRjKCkvLnV0Y09mZnNldCgpIHVuZm9ydHVuYXRlbHkgbWlnaHQgY2xlYXIgdGhlIGFtYmlnIGZsYWdzLCBzbyByZXN0b3JlDQogICAgICAgIHRoaXMuX2FtYmlnVGltZSA9IHdhc0FtYmlnVGltZSB8fCBmYWxzZTsNCiAgICAgICAgLy8gTWFyayB0aGUgem9uZSBhcyBhbWJpZ3VvdXMuIFRoaXMgbmVlZHMgdG8gaGFwcGVuIGFmdGVyIHRoZSAudXRjKCkgY2FsbCwgd2hpY2ggbWlnaHQgY2FsbCAudXRjT2Zmc2V0KCksDQogICAgICAgIC8vIHdoaWNoIGNsZWFycyB0aGUgYW1iaWcgZmxhZ3MuDQogICAgICAgIHRoaXMuX2FtYmlnWm9uZSA9IHRydWU7DQogICAgfQ0KICAgIHJldHVybiB0aGlzOyAvLyBmb3IgY2hhaW5pbmcNCn07DQovLyBSZXR1cm5zIG9mIHRoZSBtb21lbnQgaGFzIGEgbm9uLWFtYmlndW91cyB0aW1lem9uZSBvZmZzZXQgKGJvb2xlYW4pDQpuZXdNb21lbnRQcm90by5oYXNab25lID0gZnVuY3Rpb24gKCkgew0KICAgIHJldHVybiAhdGhpcy5fYW1iaWdab25lOw0KfTsNCi8vIGltcGxpY2l0bHkgbWFya3MgYSB6b25lDQpuZXdNb21lbnRQcm90by5sb2NhbCA9IGZ1bmN0aW9uIChrZWVwTG9jYWxUaW1lKSB7DQogICAgLy8gZm9yIHdoZW4gY29udmVydGluZyBmcm9tIGFtYmlndW91c2x5LXpvbmVkIHRvIGxvY2FsLA0KICAgIC8vIGtlZXAgdGhlIHRpbWUgdmFsdWVzIHdoZW4gY29udmVydGluZyBmcm9tIFVUQyAtPiBsb2NhbA0KICAgIG9sZE1vbWVudFByb3RvLmxvY2FsLmNhbGwodGhpcywgdGhpcy5fYW1iaWdab25lIHx8IGtlZXBMb2NhbFRpbWUpOw0KICAgIC8vIGVuc3VyZSBub24tYW1iaWd1b3VzDQogICAgLy8gdGhpcyBwcm9iYWJseSBhbHJlYWR5IGhhcHBlbmVkIHZpYSBsb2NhbCgpIC0+IHV0Y09mZnNldCgpLCBidXQgZG9uJ3QgcmVseSBvbiBNb21lbnQncyBpbnRlcm5hbHMNCiAgICB0aGlzLl9hbWJpZ1RpbWUgPSBmYWxzZTsNCiAgICB0aGlzLl9hbWJpZ1pvbmUgPSBmYWxzZTsNCiAgICByZXR1cm4gdGhpczsgLy8gZm9yIGNoYWluaW5nDQp9Ow0KLy8gaW1wbGljaXRseSBtYXJrcyBhIHpvbmUNCm5ld01vbWVudFByb3RvLnV0YyA9IGZ1bmN0aW9uIChrZWVwTG9jYWxUaW1lKSB7DQogICAgb2xkTW9tZW50UHJvdG8udXRjLmNhbGwodGhpcywga2VlcExvY2FsVGltZSk7DQogICAgLy8gZW5zdXJlIG5vbi1hbWJpZ3VvdXMNCiAgICAvLyB0aGlzIHByb2JhYmx5IGFscmVhZHkgaGFwcGVuZWQgdmlhIHV0YygpIC0+IHV0Y09mZnNldCgpLCBidXQgZG9uJ3QgcmVseSBvbiBNb21lbnQncyBpbnRlcm5hbHMNCiAgICB0aGlzLl9hbWJpZ1RpbWUgPSBmYWxzZTsNCiAgICB0aGlzLl9hbWJpZ1pvbmUgPSBmYWxzZTsNCiAgICByZXR1cm4gdGhpczsNCn07DQovLyBpbXBsaWNpdGx5IG1hcmtzIGEgem9uZSAod2lsbCBwcm9iYWJseSBnZXQgY2FsbGVkIHVwb24gLnV0YygpIGFuZCAubG9jYWwoKSkNCm5ld01vbWVudFByb3RvLnV0Y09mZnNldCA9IGZ1bmN0aW9uICh0em8pIHsNCiAgICBpZiAodHpvICE9IG51bGwpIHsNCiAgICAgICAgLy8gdGhlc2UgYXNzaWdubWVudHMgbmVlZHMgdG8gaGFwcGVuIGJlZm9yZSB0aGUgb3JpZ2luYWwgem9uZSBtZXRob2QgaXMgY2FsbGVkLg0KICAgICAgICAvLyBJIGZvcmdldCB3aHksIHNvbWV0aGluZyB0byBkbyB3aXRoIGEgYnJvd3NlciBjcmFzaC4NCiAgICAgICAgdGhpcy5fYW1iaWdUaW1lID0gZmFsc2U7DQogICAgICAgIHRoaXMuX2FtYmlnWm9uZSA9IGZhbHNlOw0KICAgIH0NCiAgICByZXR1cm4gb2xkTW9tZW50UHJvdG8udXRjT2Zmc2V0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7DQp9Ow0KCgovKioqLyB9KSwKLyogMTEgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKLyoNClVTQUdFOg0KICBpbXBvcnQgeyBkZWZhdWx0IGFzIEVtaXR0ZXJNaXhpbiwgRW1pdHRlckludGVyZmFjZSB9IGZyb20gJy4vRW1pdHRlck1peGluJw0KaW4gY2xhc3M6DQogIG9uOiBFbWl0dGVySW50ZXJmYWNlWydvbiddDQogIG9uZTogRW1pdHRlckludGVyZmFjZVsnb25lJ10NCiAgb2ZmOiBFbWl0dGVySW50ZXJmYWNlWydvZmYnXQ0KICB0cmlnZ2VyOiBFbWl0dGVySW50ZXJmYWNlWyd0cmlnZ2VyJ10NCiAgdHJpZ2dlcldpdGg6IEVtaXR0ZXJJbnRlcmZhY2VbJ3RyaWdnZXJXaXRoJ10NCiAgaGFzSGFuZGxlcnM6IEVtaXR0ZXJJbnRlcmZhY2VbJ2hhc0hhbmRsZXJzJ10NCmFmdGVyIGNsYXNzOg0KICBFbWl0dGVyTWl4aW4ubWl4SW50byhUaGVDbGFzcykNCiovDQpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIHRzbGliXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIpOw0KdmFyICQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOw0KdmFyIE1peGluXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE0KTsNCnZhciBFbWl0dGVyTWl4aW4gPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoRW1pdHRlck1peGluLCBfc3VwZXIpOw0KICAgIGZ1bmN0aW9uIEVtaXR0ZXJNaXhpbigpIHsNCiAgICAgICAgcmV0dXJuIF9zdXBlciAhPT0gbnVsbCAmJiBfc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOw0KICAgIH0NCiAgICAvLyBqUXVlcnktaWZpY2F0aW9uIHZpYSAkKHRoaXMpIGFsbG93cyBhIG5vbi1ET00gb2JqZWN0IHRvIGhhdmUNCiAgICAvLyB0aGUgc2FtZSBldmVudCBoYW5kbGluZyBjYXBhYmlsaXRpZXMgKGluY2x1ZGluZyBuYW1lc3BhY2VzKS4NCiAgICBFbWl0dGVyTWl4aW4ucHJvdG90eXBlLm9uID0gZnVuY3Rpb24gKHR5cGVzLCBoYW5kbGVyKSB7DQogICAgICAgICQodGhpcykub24odHlwZXMsIHRoaXMuX3ByZXBhcmVJbnRlcmNlcHQoaGFuZGxlcikpOw0KICAgICAgICByZXR1cm4gdGhpczsgLy8gZm9yIGNoYWluaW5nDQogICAgfTsNCiAgICBFbWl0dGVyTWl4aW4ucHJvdG90eXBlLm9uZSA9IGZ1bmN0aW9uICh0eXBlcywgaGFuZGxlcikgew0KICAgICAgICAkKHRoaXMpLm9uZSh0eXBlcywgdGhpcy5fcHJlcGFyZUludGVyY2VwdChoYW5kbGVyKSk7DQogICAgICAgIHJldHVybiB0aGlzOyAvLyBmb3IgY2hhaW5pbmcNCiAgICB9Ow0KICAgIEVtaXR0ZXJNaXhpbi5wcm90b3R5cGUuX3ByZXBhcmVJbnRlcmNlcHQgPSBmdW5jdGlvbiAoaGFuZGxlcikgew0KICAgICAgICAvLyBoYW5kbGVycyBhcmUgYWx3YXlzIGNhbGxlZCB3aXRoIGFuICJldmVudCIgb2JqZWN0IGFzIHRoZWlyIGZpcnN0IHBhcmFtLg0KICAgICAgICAvLyBzbmVhayB0aGUgYHRoaXNgIGNvbnRleHQgYW5kIGFyZ3VtZW50cyBpbnRvIHRoZSBleHRyYSBwYXJhbWV0ZXIgb2JqZWN0DQogICAgICAgIC8vIGFuZCBmb3J3YXJkIHRoZW0gb24gdG8gdGhlIG9yaWdpbmFsIGhhbmRsZXIuDQogICAgICAgIHZhciBpbnRlcmNlcHQgPSBmdW5jdGlvbiAoZXYsIGV4dHJhKSB7DQogICAgICAgICAgICByZXR1cm4gaGFuZGxlci5hcHBseShleHRyYS5jb250ZXh0IHx8IHRoaXMsIGV4dHJhLmFyZ3MgfHwgW10pOw0KICAgICAgICB9Ow0KICAgICAgICAvLyBtaW1pY2sgalF1ZXJ5J3MgaW50ZXJuYWwgInByb3h5IiBzeXN0ZW0gKHJpc2t5LCBJIGtub3cpDQogICAgICAgIC8vIGNhdXNpbmcgYWxsIGZ1bmN0aW9ucyB3aXRoIHRoZSBzYW1lIC5ndWlkIHRvIGFwcGVhciB0byBiZSB0aGUgc2FtZS4NCiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnkvYmxvYi8yLjIuNC9zcmMvY29yZS5qcyNMNDQ4DQogICAgICAgIC8vIHRoaXMgaXMgbmVlZGVkIGZvciBjYWxsaW5nIC5vZmYgd2l0aCB0aGUgb3JpZ2luYWwgbm9uLWludGVyY2VwdCBoYW5kbGVyLg0KICAgICAgICBpZiAoIWhhbmRsZXIuZ3VpZCkgew0KICAgICAgICAgICAgaGFuZGxlci5ndWlkID0gJC5ndWlkKys7DQogICAgICAgIH0NCiAgICAgICAgaW50ZXJjZXB0Lmd1aWQgPSBoYW5kbGVyLmd1aWQ7DQogICAgICAgIHJldHVybiBpbnRlcmNlcHQ7DQogICAgfTsNCiAgICBFbWl0dGVyTWl4aW4ucHJvdG90eXBlLm9mZiA9IGZ1bmN0aW9uICh0eXBlcywgaGFuZGxlcikgew0KICAgICAgICAkKHRoaXMpLm9mZih0eXBlcywgaGFuZGxlcik7DQogICAgICAgIHJldHVybiB0aGlzOyAvLyBmb3IgY2hhaW5pbmcNCiAgICB9Ow0KICAgIEVtaXR0ZXJNaXhpbi5wcm90b3R5cGUudHJpZ2dlciA9IGZ1bmN0aW9uICh0eXBlcykgew0KICAgICAgICB2YXIgYXJncyA9IFtdOw0KICAgICAgICBmb3IgKHZhciBfaSA9IDE7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykgew0KICAgICAgICAgICAgYXJnc1tfaSAtIDFdID0gYXJndW1lbnRzW19pXTsNCiAgICAgICAgfQ0KICAgICAgICAvLyBwYXNzIGluICJleHRyYSIgaW5mbyB0byB0aGUgaW50ZXJjZXB0DQogICAgICAgICQodGhpcykudHJpZ2dlckhhbmRsZXIodHlwZXMsIHsgYXJnczogYXJncyB9KTsNCiAgICAgICAgcmV0dXJuIHRoaXM7IC8vIGZvciBjaGFpbmluZw0KICAgIH07DQogICAgRW1pdHRlck1peGluLnByb3RvdHlwZS50cmlnZ2VyV2l0aCA9IGZ1bmN0aW9uICh0eXBlcywgY29udGV4dCwgYXJncykgew0KICAgICAgICAvLyBgdHJpZ2dlckhhbmRsZXJgIGlzIGxlc3MgcmVsaWFudCBvbiB0aGUgRE9NIGNvbXBhcmVkIHRvIGB0cmlnZ2VyYC4NCiAgICAgICAgLy8gcGFzcyBpbiAiZXh0cmEiIGluZm8gdG8gdGhlIGludGVyY2VwdC4NCiAgICAgICAgJCh0aGlzKS50cmlnZ2VySGFuZGxlcih0eXBlcywgeyBjb250ZXh0OiBjb250ZXh0LCBhcmdzOiBhcmdzIH0pOw0KICAgICAgICByZXR1cm4gdGhpczsgLy8gZm9yIGNoYWluaW5nDQogICAgfTsNCiAgICBFbWl0dGVyTWl4aW4ucHJvdG90eXBlLmhhc0hhbmRsZXJzID0gZnVuY3Rpb24gKHR5cGUpIHsNCiAgICAgICAgdmFyIGhhc2ggPSAkLl9kYXRhKHRoaXMsICdldmVudHMnKTsgLy8gaHR0cDovL2Jsb2cuanF1ZXJ5LmNvbS8yMDEyLzA4LzA5L2pxdWVyeS0xLTgtcmVsZWFzZWQvDQogICAgICAgIHJldHVybiBoYXNoICYmIGhhc2hbdHlwZV0gJiYgaGFzaFt0eXBlXS5sZW5ndGggPiAwOw0KICAgIH07DQogICAgcmV0dXJuIEVtaXR0ZXJNaXhpbjsNCn0oTWl4aW5fMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBFbWl0dGVyTWl4aW47DQoKCi8qKiovIH0pLAovKiAxMiAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KLyoNCk1lYW50IHRvIGJlIGltbXV0YWJsZQ0KKi8NCnZhciBDb21wb25lbnRGb290cHJpbnQgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7DQogICAgZnVuY3Rpb24gQ29tcG9uZW50Rm9vdHByaW50KHVuem9uZWRSYW5nZSwgaXNBbGxEYXkpIHsNCiAgICAgICAgdGhpcy5pc0FsbERheSA9IGZhbHNlOyAvLyBjb21wb25lbnQgY2FuIGNob29zZSB0byBpZ25vcmUgdGhpcw0KICAgICAgICB0aGlzLnVuem9uZWRSYW5nZSA9IHVuem9uZWRSYW5nZTsNCiAgICAgICAgdGhpcy5pc0FsbERheSA9IGlzQWxsRGF5Ow0KICAgIH0NCiAgICAvKg0KICAgIE9ubHkgd29ya3MgZm9yIG5vbi1vcGVuLWVuZGVkIHJhbmdlcy4NCiAgICAqLw0KICAgIENvbXBvbmVudEZvb3RwcmludC5wcm90b3R5cGUudG9MZWdhY3kgPSBmdW5jdGlvbiAoY2FsZW5kYXIpIHsNCiAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgIHN0YXJ0OiBjYWxlbmRhci5tc1RvTW9tZW50KHRoaXMudW56b25lZFJhbmdlLnN0YXJ0TXMsIHRoaXMuaXNBbGxEYXkpLA0KICAgICAgICAgICAgZW5kOiBjYWxlbmRhci5tc1RvTW9tZW50KHRoaXMudW56b25lZFJhbmdlLmVuZE1zLCB0aGlzLmlzQWxsRGF5KQ0KICAgICAgICB9Ow0KICAgIH07DQogICAgcmV0dXJuIENvbXBvbmVudEZvb3RwcmludDsNCn0oKSk7DQpleHBvcnRzLmRlZmF1bHQgPSBDb21wb25lbnRGb290cHJpbnQ7DQoKCi8qKiovIH0pLAovKiAxMyAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIHRzbGliXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIpOw0KdmFyIEV2ZW50RGVmXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMzKTsNCnZhciBFdmVudEluc3RhbmNlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIwOSk7DQp2YXIgRXZlbnREYXRlUHJvZmlsZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxOCk7DQp2YXIgU2luZ2xlRXZlbnREZWYgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoU2luZ2xlRXZlbnREZWYsIF9zdXBlcik7DQogICAgZnVuY3Rpb24gU2luZ2xlRXZlbnREZWYoKSB7DQogICAgICAgIHJldHVybiBfc3VwZXIgIT09IG51bGwgJiYgX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsNCiAgICB9DQogICAgLyoNCiAgICBXaWxsIHJlY2VpdmUgc3RhcnQvZW5kIHBhcmFtcywgYnV0IHdpbGwgYmUgaWdub3JlZC4NCiAgICAqLw0KICAgIFNpbmdsZUV2ZW50RGVmLnByb3RvdHlwZS5idWlsZEluc3RhbmNlcyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIFt0aGlzLmJ1aWxkSW5zdGFuY2UoKV07DQogICAgfTsNCiAgICBTaW5nbGVFdmVudERlZi5wcm90b3R5cGUuYnVpbGRJbnN0YW5jZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIG5ldyBFdmVudEluc3RhbmNlXzEuZGVmYXVsdCh0aGlzLCAvLyBkZWZpbml0aW9uDQogICAgICAgIHRoaXMuZGF0ZVByb2ZpbGUpOw0KICAgIH07DQogICAgU2luZ2xlRXZlbnREZWYucHJvdG90eXBlLmlzQWxsRGF5ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gdGhpcy5kYXRlUHJvZmlsZS5pc0FsbERheSgpOw0KICAgIH07DQogICAgU2luZ2xlRXZlbnREZWYucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgZGVmID0gX3N1cGVyLnByb3RvdHlwZS5jbG9uZS5jYWxsKHRoaXMpOw0KICAgICAgICBkZWYuZGF0ZVByb2ZpbGUgPSB0aGlzLmRhdGVQcm9maWxlOw0KICAgICAgICByZXR1cm4gZGVmOw0KICAgIH07DQogICAgU2luZ2xlRXZlbnREZWYucHJvdG90eXBlLnJlem9uZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIGNhbGVuZGFyID0gdGhpcy5zb3VyY2UuY2FsZW5kYXI7DQogICAgICAgIHZhciBkYXRlUHJvZmlsZSA9IHRoaXMuZGF0ZVByb2ZpbGU7DQogICAgICAgIHRoaXMuZGF0ZVByb2ZpbGUgPSBuZXcgRXZlbnREYXRlUHJvZmlsZV8xLmRlZmF1bHQoY2FsZW5kYXIubW9tZW50KGRhdGVQcm9maWxlLnN0YXJ0KSwgZGF0ZVByb2ZpbGUuZW5kID8gY2FsZW5kYXIubW9tZW50KGRhdGVQcm9maWxlLmVuZCkgOiBudWxsLCBjYWxlbmRhcik7DQogICAgfTsNCiAgICAvKg0KICAgIE5PVEU6IGlmIHN1cGVyLW1ldGhvZCBmYWlscywgc2hvdWxkIHN0aWxsIGF0dGVtcHQgdG8gYXBwbHkNCiAgICAqLw0KICAgIFNpbmdsZUV2ZW50RGVmLnByb3RvdHlwZS5hcHBseU1hbnVhbFN0YW5kYXJkUHJvcHMgPSBmdW5jdGlvbiAocmF3UHJvcHMpIHsNCiAgICAgICAgdmFyIHN1cGVyU3VjY2VzcyA9IF9zdXBlci5wcm90b3R5cGUuYXBwbHlNYW51YWxTdGFuZGFyZFByb3BzLmNhbGwodGhpcywgcmF3UHJvcHMpOw0KICAgICAgICB2YXIgZGF0ZVByb2ZpbGUgPSBFdmVudERhdGVQcm9maWxlXzEuZGVmYXVsdC5wYXJzZShyYXdQcm9wcywgdGhpcy5zb3VyY2UpOyAvLyByZXR1cm5zIG51bGwgb24gZmFpbHVyZQ0KICAgICAgICBpZiAoZGF0ZVByb2ZpbGUpIHsNCiAgICAgICAgICAgIHRoaXMuZGF0ZVByb2ZpbGUgPSBkYXRlUHJvZmlsZTsNCiAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSBgZGF0ZWAgc2hvd3MgdXAgaW4gdGhlIGxlZ2FjeSBldmVudCBvYmplY3RzIGFzLWlzDQogICAgICAgICAgICBpZiAocmF3UHJvcHMuZGF0ZSAhPSBudWxsKSB7DQogICAgICAgICAgICAgICAgdGhpcy5taXNjUHJvcHMuZGF0ZSA9IHJhd1Byb3BzLmRhdGU7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gc3VwZXJTdWNjZXNzOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICB9DQogICAgfTsNCiAgICByZXR1cm4gU2luZ2xlRXZlbnREZWY7DQp9KEV2ZW50RGVmXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gU2luZ2xlRXZlbnREZWY7DQovLyBQYXJzaW5nDQovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NClNpbmdsZUV2ZW50RGVmLmRlZmluZVN0YW5kYXJkUHJvcHMoew0KICAgIHN0YXJ0OiBmYWxzZSwNCiAgICBkYXRlOiBmYWxzZSwNCiAgICBlbmQ6IGZhbHNlLA0KICAgIGFsbERheTogZmFsc2UNCn0pOw0KCgovKioqLyB9KSwKLyogMTQgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciBNaXhpbiA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsNCiAgICBmdW5jdGlvbiBNaXhpbigpIHsNCiAgICB9DQogICAgTWl4aW4ubWl4SW50byA9IGZ1bmN0aW9uIChkZXN0Q2xhc3MpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModGhpcy5wcm90b3R5cGUpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsNCiAgICAgICAgICAgIGlmICghZGVzdENsYXNzLnByb3RvdHlwZVtuYW1lXSkgew0KICAgICAgICAgICAgICAgIGRlc3RDbGFzcy5wcm90b3R5cGVbbmFtZV0gPSBfdGhpcy5wcm90b3R5cGVbbmFtZV07DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgIH07DQogICAgLyoNCiAgICB3aWxsIG92ZXJyaWRlIGV4aXN0aW5nIG1ldGhvZHMNCiAgICBUT0RPOiByZW1vdmUhIG5vdCB1c2VkIGFueW1vcmUNCiAgICAqLw0KICAgIE1peGluLm1peE92ZXIgPSBmdW5jdGlvbiAoZGVzdENsYXNzKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHRoaXMucHJvdG90eXBlKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7DQogICAgICAgICAgICBkZXN0Q2xhc3MucHJvdG90eXBlW25hbWVdID0gX3RoaXMucHJvdG90eXBlW25hbWVdOw0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIHJldHVybiBNaXhpbjsNCn0oKSk7DQpleHBvcnRzLmRlZmF1bHQgPSBNaXhpbjsNCgoKLyoqKi8gfSksCi8qIDE1ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgZXhwb3J0SG9va3MgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE3KTsNCnZhciBFbWl0dGVyTWl4aW5fMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTEpOw0KdmFyIExpc3RlbmVyTWl4aW5fMSA9IF9fd2VicGFja19yZXF1aXJlX18oNyk7DQpleHBvcnRIb29rcy50b3VjaE1vdXNlSWdub3JlV2FpdCA9IDUwMDsNCnZhciBnbG9iYWxFbWl0dGVyID0gbnVsbDsNCnZhciBuZWVkZWRDb3VudCA9IDA7DQovKg0KTGlzdGVucyB0byBkb2N1bWVudCBhbmQgd2luZG93LWxldmVsIHVzZXItaW50ZXJhY3Rpb24gZXZlbnRzLCBsaWtlIHRvdWNoIGV2ZW50cyBhbmQgbW91c2UgZXZlbnRzLA0KYW5kIGZpcmVzIHRoZXNlIGV2ZW50cyBhcy1pcyB0byB3aG9ldmVyIGlzIG9ic2VydmluZyBhIEdsb2JhbEVtaXR0ZXIuDQpCZXN0IHdoZW4gdXNlZCBhcyBhIHNpbmdsZXRvbiB2aWEgR2xvYmFsRW1pdHRlci5nZXQoKQ0KCk5vcm1hbGl6ZXMgbW91c2UvdG91Y2ggZXZlbnRzLiBGb3IgZXhhbXBsZXM6DQotIGlnbm9yZXMgdGhlIHRoZSBzaW11bGF0ZWQgbW91c2UgZXZlbnRzIHRoYXQgaGFwcGVuIGFmdGVyIGEgcXVpY2sgdGFwOiBtb3VzZW1vdmUrbW91c2Vkb3duK21vdXNldXArY2xpY2sNCi0gY29tcGVuc2F0ZXMgZm9yIHZhcmlvdXMgYnVnZ3kgc2NlbmFyaW9zIHdoZXJlIGEgdG91Y2hlbmQgZG9lcyBub3QgZmlyZQ0KKi8NCnZhciBHbG9iYWxFbWl0dGVyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgew0KICAgIGZ1bmN0aW9uIEdsb2JhbEVtaXR0ZXIoKSB7DQogICAgICAgIHRoaXMuaXNUb3VjaGluZyA9IGZhbHNlOw0KICAgICAgICB0aGlzLm1vdXNlSWdub3JlRGVwdGggPSAwOw0KICAgIH0NCiAgICAvLyBnZXRzIHRoZSBzaW5nbGV0b24NCiAgICBHbG9iYWxFbWl0dGVyLmdldCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKCFnbG9iYWxFbWl0dGVyKSB7DQogICAgICAgICAgICBnbG9iYWxFbWl0dGVyID0gbmV3IEdsb2JhbEVtaXR0ZXIoKTsNCiAgICAgICAgICAgIGdsb2JhbEVtaXR0ZXIuYmluZCgpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBnbG9iYWxFbWl0dGVyOw0KICAgIH07DQogICAgLy8gY2FsbGVkIHdoZW4gYW4gb2JqZWN0IGtub3dzIGl0IHdpbGwgbmVlZCBhIEdsb2JhbEVtaXR0ZXIgaW4gdGhlIG5lYXIgZnV0dXJlLg0KICAgIEdsb2JhbEVtaXR0ZXIubmVlZGVkID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBHbG9iYWxFbWl0dGVyLmdldCgpOyAvLyBlbnN1cmVzIGdsb2JhbEVtaXR0ZXINCiAgICAgICAgbmVlZGVkQ291bnQrKzsNCiAgICB9Ow0KICAgIC8vIGNhbGxlZCB3aGVuIHRoZSBvYmplY3QgdGhhdCBvcmlnaW5hbGx5IGNhbGxlZCBuZWVkZWQoKSBkb2Vzbid0IG5lZWQgYSBHbG9iYWxFbWl0dGVyIGFueW1vcmUuDQogICAgR2xvYmFsRW1pdHRlci51bm5lZWRlZCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgbmVlZGVkQ291bnQtLTsNCiAgICAgICAgaWYgKCFuZWVkZWRDb3VudCkgew0KICAgICAgICAgICAgZ2xvYmFsRW1pdHRlci51bmJpbmQoKTsNCiAgICAgICAgICAgIGdsb2JhbEVtaXR0ZXIgPSBudWxsOw0KICAgICAgICB9DQogICAgfTsNCiAgICBHbG9iYWxFbWl0dGVyLnByb3RvdHlwZS5iaW5kID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICB0aGlzLmxpc3RlblRvKCQoZG9jdW1lbnQpLCB7DQogICAgICAgICAgICB0b3VjaHN0YXJ0OiB0aGlzLmhhbmRsZVRvdWNoU3RhcnQsDQogICAgICAgICAgICB0b3VjaGNhbmNlbDogdGhpcy5oYW5kbGVUb3VjaENhbmNlbCwNCiAgICAgICAgICAgIHRvdWNoZW5kOiB0aGlzLmhhbmRsZVRvdWNoRW5kLA0KICAgICAgICAgICAgbW91c2Vkb3duOiB0aGlzLmhhbmRsZU1vdXNlRG93biwNCiAgICAgICAgICAgIG1vdXNlbW92ZTogdGhpcy5oYW5kbGVNb3VzZU1vdmUsDQogICAgICAgICAgICBtb3VzZXVwOiB0aGlzLmhhbmRsZU1vdXNlVXAsDQogICAgICAgICAgICBjbGljazogdGhpcy5oYW5kbGVDbGljaywNCiAgICAgICAgICAgIHNlbGVjdHN0YXJ0OiB0aGlzLmhhbmRsZVNlbGVjdFN0YXJ0LA0KICAgICAgICAgICAgY29udGV4dG1lbnU6IHRoaXMuaGFuZGxlQ29udGV4dE1lbnUNCiAgICAgICAgfSk7DQogICAgICAgIC8vIGJlY2F1c2Ugd2UgbmVlZCB0byBjYWxsIHByZXZlbnREZWZhdWx0DQogICAgICAgIC8vIGJlY2F1c2UgaHR0cHM6Ly93d3cuY2hyb21lc3RhdHVzLmNvbS9mZWF0dXJlcy81MDkzNTY2MDA3MjE0MDgwDQogICAgICAgIC8vIFRPRE86IGludmVzdGlnYXRlIHBlcmZvcm1hbmNlIGJlY2F1c2UgdGhpcyBpcyBhIGdsb2JhbCBoYW5kbGVyDQogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLmhhbmRsZVRvdWNoTW92ZVByb3h5ID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgICAgICBfdGhpcy5oYW5kbGVUb3VjaE1vdmUoJC5FdmVudChldikpOw0KICAgICAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0gLy8gYWxsb3dzIHByZXZlbnREZWZhdWx0KCkNCiAgICAgICAgKTsNCiAgICAgICAgLy8gYXR0YWNoIGEgaGFuZGxlciB0byBnZXQgY2FsbGVkIHdoZW4gQU5ZIHNjcm9sbCBhY3Rpb24gaGFwcGVucyBvbiB0aGUgcGFnZS4NCiAgICAgICAgLy8gdGhpcyB3YXMgaW1wb3NzaWJsZSB0byBkbyB3aXRoIG5vcm1hbCBvbi9vZmYgYmVjYXVzZSAnc2Nyb2xsJyBkb2Vzbid0IGJ1YmJsZS4NCiAgICAgICAgLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMzI5NTQ1NjUvOTYzNDINCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMuaGFuZGxlU2Nyb2xsUHJveHkgPSBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgICAgIF90aGlzLmhhbmRsZVNjcm9sbCgkLkV2ZW50KGV2KSk7DQogICAgICAgIH0sIHRydWUgLy8gdXNlQ2FwdHVyZQ0KICAgICAgICApOw0KICAgIH07DQogICAgR2xvYmFsRW1pdHRlci5wcm90b3R5cGUudW5iaW5kID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLnN0b3BMaXN0ZW5pbmdUbygkKGRvY3VtZW50KSk7DQogICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLmhhbmRsZVRvdWNoTW92ZVByb3h5KTsNCiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMuaGFuZGxlU2Nyb2xsUHJveHksIHRydWUgLy8gdXNlQ2FwdHVyZQ0KICAgICAgICApOw0KICAgIH07DQogICAgLy8gVG91Y2ggSGFuZGxlcnMNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIEdsb2JhbEVtaXR0ZXIucHJvdG90eXBlLmhhbmRsZVRvdWNoU3RhcnQgPSBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgLy8gaWYgYSBwcmV2aW91cyB0b3VjaCBpbnRlcmFjdGlvbiBuZXZlciBlbmRlZCB3aXRoIGEgdG91Y2hlbmQsIHRoZW4gaW1wbGljaXRseSBlbmQgaXQsDQogICAgICAgIC8vIGJ1dCBzaW5jZSBhIG5ldyB0b3VjaCBpbnRlcmFjdGlvbiBpcyBhYm91dCB0byBiZWdpbiwgZG9uJ3Qgc3RhcnQgdGhlIG1vdXNlIGlnbm9yZSBwZXJpb2QuDQogICAgICAgIHRoaXMuc3RvcFRvdWNoKGV2LCB0cnVlKTsgLy8gc2tpcE1vdXNlSWdub3JlPXRydWUNCiAgICAgICAgdGhpcy5pc1RvdWNoaW5nID0gdHJ1ZTsNCiAgICAgICAgdGhpcy50cmlnZ2VyKCd0b3VjaHN0YXJ0JywgZXYpOw0KICAgIH07DQogICAgR2xvYmFsRW1pdHRlci5wcm90b3R5cGUuaGFuZGxlVG91Y2hNb3ZlID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIGlmICh0aGlzLmlzVG91Y2hpbmcpIHsNCiAgICAgICAgICAgIHRoaXMudHJpZ2dlcigndG91Y2htb3ZlJywgZXYpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBHbG9iYWxFbWl0dGVyLnByb3RvdHlwZS5oYW5kbGVUb3VjaENhbmNlbCA9IGZ1bmN0aW9uIChldikgew0KICAgICAgICBpZiAodGhpcy5pc1RvdWNoaW5nKSB7DQogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ3RvdWNoY2FuY2VsJywgZXYpOw0KICAgICAgICAgICAgLy8gSGF2ZSB0b3VjaGNhbmNlbCBmaXJlIGFuIGFydGlmaWNpYWwgdG91Y2hlbmQuIFRoYXQgd2F5LCBoYW5kbGVycyB3b24ndCBuZWVkIHRvIGxpc3RlbiB0byBib3RoLg0KICAgICAgICAgICAgLy8gSWYgdG91Y2hlbmQgZmlyZXMgbGF0ZXIsIGl0IHdvbid0IGhhdmUgYW55IGVmZmVjdCBiL2MgaXNUb3VjaGluZyB3aWxsIGJlIGZhbHNlLg0KICAgICAgICAgICAgdGhpcy5zdG9wVG91Y2goZXYpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBHbG9iYWxFbWl0dGVyLnByb3RvdHlwZS5oYW5kbGVUb3VjaEVuZCA9IGZ1bmN0aW9uIChldikgew0KICAgICAgICB0aGlzLnN0b3BUb3VjaChldik7DQogICAgfTsNCiAgICAvLyBNb3VzZSBIYW5kbGVycw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgR2xvYmFsRW1pdHRlci5wcm90b3R5cGUuaGFuZGxlTW91c2VEb3duID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIGlmICghdGhpcy5zaG91bGRJZ25vcmVNb3VzZSgpKSB7DQogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ21vdXNlZG93bicsIGV2KTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgR2xvYmFsRW1pdHRlci5wcm90b3R5cGUuaGFuZGxlTW91c2VNb3ZlID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIGlmICghdGhpcy5zaG91bGRJZ25vcmVNb3VzZSgpKSB7DQogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ21vdXNlbW92ZScsIGV2KTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgR2xvYmFsRW1pdHRlci5wcm90b3R5cGUuaGFuZGxlTW91c2VVcCA9IGZ1bmN0aW9uIChldikgew0KICAgICAgICBpZiAoIXRoaXMuc2hvdWxkSWdub3JlTW91c2UoKSkgew0KICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdtb3VzZXVwJywgZXYpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBHbG9iYWxFbWl0dGVyLnByb3RvdHlwZS5oYW5kbGVDbGljayA9IGZ1bmN0aW9uIChldikgew0KICAgICAgICBpZiAoIXRoaXMuc2hvdWxkSWdub3JlTW91c2UoKSkgew0KICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdjbGljaycsIGV2KTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gTWlzYyBIYW5kbGVycw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgR2xvYmFsRW1pdHRlci5wcm90b3R5cGUuaGFuZGxlU2VsZWN0U3RhcnQgPSBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgdGhpcy50cmlnZ2VyKCdzZWxlY3RzdGFydCcsIGV2KTsNCiAgICB9Ow0KICAgIEdsb2JhbEVtaXR0ZXIucHJvdG90eXBlLmhhbmRsZUNvbnRleHRNZW51ID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIHRoaXMudHJpZ2dlcignY29udGV4dG1lbnUnLCBldik7DQogICAgfTsNCiAgICBHbG9iYWxFbWl0dGVyLnByb3RvdHlwZS5oYW5kbGVTY3JvbGwgPSBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgdGhpcy50cmlnZ2VyKCdzY3JvbGwnLCBldik7DQogICAgfTsNCiAgICAvLyBVdGlscw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgR2xvYmFsRW1pdHRlci5wcm90b3R5cGUuc3RvcFRvdWNoID0gZnVuY3Rpb24gKGV2LCBza2lwTW91c2VJZ25vcmUpIHsNCiAgICAgICAgaWYgKHNraXBNb3VzZUlnbm9yZSA9PT0gdm9pZCAwKSB7IHNraXBNb3VzZUlnbm9yZSA9IGZhbHNlOyB9DQogICAgICAgIGlmICh0aGlzLmlzVG91Y2hpbmcpIHsNCiAgICAgICAgICAgIHRoaXMuaXNUb3VjaGluZyA9IGZhbHNlOw0KICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCd0b3VjaGVuZCcsIGV2KTsNCiAgICAgICAgICAgIGlmICghc2tpcE1vdXNlSWdub3JlKSB7DQogICAgICAgICAgICAgICAgdGhpcy5zdGFydFRvdWNoTW91c2VJZ25vcmUoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH07DQogICAgR2xvYmFsRW1pdHRlci5wcm90b3R5cGUuc3RhcnRUb3VjaE1vdXNlSWdub3JlID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICB2YXIgd2FpdCA9IGV4cG9ydEhvb2tzLnRvdWNoTW91c2VJZ25vcmVXYWl0Ow0KICAgICAgICBpZiAod2FpdCkgew0KICAgICAgICAgICAgdGhpcy5tb3VzZUlnbm9yZURlcHRoKys7DQogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICBfdGhpcy5tb3VzZUlnbm9yZURlcHRoLS07DQogICAgICAgICAgICB9LCB3YWl0KTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgR2xvYmFsRW1pdHRlci5wcm90b3R5cGUuc2hvdWxkSWdub3JlTW91c2UgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHJldHVybiB0aGlzLmlzVG91Y2hpbmcgfHwgQm9vbGVhbih0aGlzLm1vdXNlSWdub3JlRGVwdGgpOw0KICAgIH07DQogICAgcmV0dXJuIEdsb2JhbEVtaXR0ZXI7DQp9KCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gR2xvYmFsRW1pdHRlcjsNCkxpc3RlbmVyTWl4aW5fMS5kZWZhdWx0Lm1peEludG8oR2xvYmFsRW1pdHRlcik7DQpFbWl0dGVyTWl4aW5fMS5kZWZhdWx0Lm1peEludG8oR2xvYmFsRW1pdHRlcik7DQoKCi8qKiovIH0pLAovKiAxNiAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIEludGVyYWN0aW9uID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgew0KICAgIGZ1bmN0aW9uIEludGVyYWN0aW9uKGNvbXBvbmVudCkgew0KICAgICAgICB0aGlzLnZpZXcgPSBjb21wb25lbnQuX2dldFZpZXcoKTsNCiAgICAgICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7DQogICAgfQ0KICAgIEludGVyYWN0aW9uLnByb3RvdHlwZS5vcHQgPSBmdW5jdGlvbiAobmFtZSkgew0KICAgICAgICByZXR1cm4gdGhpcy52aWV3Lm9wdChuYW1lKTsNCiAgICB9Ow0KICAgIEludGVyYWN0aW9uLnByb3RvdHlwZS5lbmQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIC8vIHN1YmNsYXNzZXMgY2FuIGltcGxlbWVudA0KICAgIH07DQogICAgcmV0dXJuIEludGVyYWN0aW9uOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IEludGVyYWN0aW9uOw0KCgovKioqLyB9KSwKLyogMTcgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCmV4cG9ydHMudmVyc2lvbiA9ICczLjguMSc7DQovLyBXaGVuIGludHJvZHVjaW5nIGludGVybmFsIEFQSSBpbmNvbXBhdGliaWxpdGllcyAod2hlcmUgZnVsbGNhbGVuZGFyIHBsdWdpbnMgd291bGQgYnJlYWspLA0KLy8gdGhlIG1pbm9yIHZlcnNpb24gb2YgdGhlIGNhbGVuZGFyIHNob3VsZCBiZSB1cHBlZCAoZXg6IDIuNy4yIC0+IDIuOC4wKQ0KLy8gYW5kIHRoZSBiZWxvdyBpbnRlZ2VyIHNob3VsZCBiZSBpbmNyZW1lbnRlZC4NCmV4cG9ydHMuaW50ZXJuYWxBcGlWZXJzaW9uID0gMTI7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCmV4cG9ydHMuYXBwbHlBbGwgPSB1dGlsXzEuYXBwbHlBbGw7DQpleHBvcnRzLmRlYm91bmNlID0gdXRpbF8xLmRlYm91bmNlOw0KZXhwb3J0cy5pc0ludCA9IHV0aWxfMS5pc0ludDsNCmV4cG9ydHMuaHRtbEVzY2FwZSA9IHV0aWxfMS5odG1sRXNjYXBlOw0KZXhwb3J0cy5jc3NUb1N0ciA9IHV0aWxfMS5jc3NUb1N0cjsNCmV4cG9ydHMucHJveHkgPSB1dGlsXzEucHJveHk7DQpleHBvcnRzLmNhcGl0YWxpc2VGaXJzdExldHRlciA9IHV0aWxfMS5jYXBpdGFsaXNlRmlyc3RMZXR0ZXI7DQpleHBvcnRzLmdldE91dGVyUmVjdCA9IHV0aWxfMS5nZXRPdXRlclJlY3Q7DQpleHBvcnRzLmdldENsaWVudFJlY3QgPSB1dGlsXzEuZ2V0Q2xpZW50UmVjdDsNCmV4cG9ydHMuZ2V0Q29udGVudFJlY3QgPSB1dGlsXzEuZ2V0Q29udGVudFJlY3Q7DQpleHBvcnRzLmdldFNjcm9sbGJhcldpZHRocyA9IHV0aWxfMS5nZXRTY3JvbGxiYXJXaWR0aHM7DQpleHBvcnRzLnByZXZlbnREZWZhdWx0ID0gdXRpbF8xLnByZXZlbnREZWZhdWx0Ow0KZXhwb3J0cy5wYXJzZUZpZWxkU3BlY3MgPSB1dGlsXzEucGFyc2VGaWVsZFNwZWNzOw0KZXhwb3J0cy5jb21wYXJlQnlGaWVsZFNwZWNzID0gdXRpbF8xLmNvbXBhcmVCeUZpZWxkU3BlY3M7DQpleHBvcnRzLmNvbXBhcmVCeUZpZWxkU3BlYyA9IHV0aWxfMS5jb21wYXJlQnlGaWVsZFNwZWM7DQpleHBvcnRzLmZsZXhpYmxlQ29tcGFyZSA9IHV0aWxfMS5mbGV4aWJsZUNvbXBhcmU7DQpleHBvcnRzLmNvbXB1dGVHcmVhdGVzdFVuaXQgPSB1dGlsXzEuY29tcHV0ZUdyZWF0ZXN0VW5pdDsNCmV4cG9ydHMuZGl2aWRlUmFuZ2VCeUR1cmF0aW9uID0gdXRpbF8xLmRpdmlkZVJhbmdlQnlEdXJhdGlvbjsNCmV4cG9ydHMuZGl2aWRlRHVyYXRpb25CeUR1cmF0aW9uID0gdXRpbF8xLmRpdmlkZUR1cmF0aW9uQnlEdXJhdGlvbjsNCmV4cG9ydHMubXVsdGlwbHlEdXJhdGlvbiA9IHV0aWxfMS5tdWx0aXBseUR1cmF0aW9uOw0KZXhwb3J0cy5kdXJhdGlvbkhhc1RpbWUgPSB1dGlsXzEuZHVyYXRpb25IYXNUaW1lOw0KZXhwb3J0cy5sb2cgPSB1dGlsXzEubG9nOw0KZXhwb3J0cy53YXJuID0gdXRpbF8xLndhcm47DQpleHBvcnRzLnJlbW92ZUV4YWN0ID0gdXRpbF8xLnJlbW92ZUV4YWN0Ow0KZXhwb3J0cy5pbnRlcnNlY3RSZWN0cyA9IHV0aWxfMS5pbnRlcnNlY3RSZWN0czsNCnZhciBkYXRlX2Zvcm1hdHRpbmdfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNDcpOw0KZXhwb3J0cy5mb3JtYXREYXRlID0gZGF0ZV9mb3JtYXR0aW5nXzEuZm9ybWF0RGF0ZTsNCmV4cG9ydHMuZm9ybWF0UmFuZ2UgPSBkYXRlX2Zvcm1hdHRpbmdfMS5mb3JtYXRSYW5nZTsNCmV4cG9ydHMucXVlcnlNb3N0R3JhbnVsYXJGb3JtYXRVbml0ID0gZGF0ZV9mb3JtYXR0aW5nXzEucXVlcnlNb3N0R3JhbnVsYXJGb3JtYXRVbml0Ow0KdmFyIGxvY2FsZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzMCk7DQpleHBvcnRzLmRhdGVwaWNrZXJMb2NhbGUgPSBsb2NhbGVfMS5kYXRlcGlja2VyTG9jYWxlOw0KZXhwb3J0cy5sb2NhbGUgPSBsb2NhbGVfMS5sb2NhbGU7DQp2YXIgbW9tZW50X2V4dF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMCk7DQpleHBvcnRzLm1vbWVudCA9IG1vbWVudF9leHRfMS5kZWZhdWx0Ow0KdmFyIEVtaXR0ZXJNaXhpbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMSk7DQpleHBvcnRzLkVtaXR0ZXJNaXhpbiA9IEVtaXR0ZXJNaXhpbl8xLmRlZmF1bHQ7DQp2YXIgTGlzdGVuZXJNaXhpbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg3KTsNCmV4cG9ydHMuTGlzdGVuZXJNaXhpbiA9IExpc3RlbmVyTWl4aW5fMS5kZWZhdWx0Ow0KdmFyIE1vZGVsXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQ4KTsNCmV4cG9ydHMuTW9kZWwgPSBNb2RlbF8xLmRlZmF1bHQ7DQp2YXIgQ29uc3RyYWludHNfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjA3KTsNCmV4cG9ydHMuQ29uc3RyYWludHMgPSBDb25zdHJhaW50c18xLmRlZmF1bHQ7DQp2YXIgVW56b25lZFJhbmdlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUpOw0KZXhwb3J0cy5VbnpvbmVkUmFuZ2UgPSBVbnpvbmVkUmFuZ2VfMS5kZWZhdWx0Ow0KdmFyIENvbXBvbmVudEZvb3RwcmludF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMik7DQpleHBvcnRzLkNvbXBvbmVudEZvb3RwcmludCA9IENvbXBvbmVudEZvb3RwcmludF8xLmRlZmF1bHQ7DQp2YXIgQnVzaW5lc3NIb3VyR2VuZXJhdG9yXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIxMik7DQpleHBvcnRzLkJ1c2luZXNzSG91ckdlbmVyYXRvciA9IEJ1c2luZXNzSG91ckdlbmVyYXRvcl8xLmRlZmF1bHQ7DQp2YXIgRXZlbnREZWZfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMzMpOw0KZXhwb3J0cy5FdmVudERlZiA9IEV2ZW50RGVmXzEuZGVmYXVsdDsNCnZhciBFdmVudERlZk11dGF0aW9uXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM2KTsNCmV4cG9ydHMuRXZlbnREZWZNdXRhdGlvbiA9IEV2ZW50RGVmTXV0YXRpb25fMS5kZWZhdWx0Ow0KdmFyIEV2ZW50U291cmNlUGFyc2VyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM3KTsNCmV4cG9ydHMuRXZlbnRTb3VyY2VQYXJzZXIgPSBFdmVudFNvdXJjZVBhcnNlcl8xLmRlZmF1bHQ7DQp2YXIgRXZlbnRTb3VyY2VfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNik7DQpleHBvcnRzLkV2ZW50U291cmNlID0gRXZlbnRTb3VyY2VfMS5kZWZhdWx0Ow0KdmFyIFRoZW1lUmVnaXN0cnlfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNTEpOw0KZXhwb3J0cy5kZWZpbmVUaGVtZVN5c3RlbSA9IFRoZW1lUmVnaXN0cnlfMS5kZWZpbmVUaGVtZVN5c3RlbTsNCnZhciBFdmVudEluc3RhbmNlR3JvdXBfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTkpOw0KZXhwb3J0cy5FdmVudEluc3RhbmNlR3JvdXAgPSBFdmVudEluc3RhbmNlR3JvdXBfMS5kZWZhdWx0Ow0KdmFyIEFycmF5RXZlbnRTb3VyY2VfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNTIpOw0KZXhwb3J0cy5BcnJheUV2ZW50U291cmNlID0gQXJyYXlFdmVudFNvdXJjZV8xLmRlZmF1bHQ7DQp2YXIgRnVuY0V2ZW50U291cmNlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIxNSk7DQpleHBvcnRzLkZ1bmNFdmVudFNvdXJjZSA9IEZ1bmNFdmVudFNvdXJjZV8xLmRlZmF1bHQ7DQp2YXIgSnNvbkZlZWRFdmVudFNvdXJjZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMTYpOw0KZXhwb3J0cy5Kc29uRmVlZEV2ZW50U291cmNlID0gSnNvbkZlZWRFdmVudFNvdXJjZV8xLmRlZmF1bHQ7DQp2YXIgRXZlbnRGb290cHJpbnRfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMzUpOw0KZXhwb3J0cy5FdmVudEZvb3RwcmludCA9IEV2ZW50Rm9vdHByaW50XzEuZGVmYXVsdDsNCnZhciBDbGFzc18xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzMik7DQpleHBvcnRzLkNsYXNzID0gQ2xhc3NfMS5kZWZhdWx0Ow0KdmFyIE1peGluXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE0KTsNCmV4cG9ydHMuTWl4aW4gPSBNaXhpbl8xLmRlZmF1bHQ7DQp2YXIgQ29vcmRDYWNoZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1Myk7DQpleHBvcnRzLkNvb3JkQ2FjaGUgPSBDb29yZENhY2hlXzEuZGVmYXVsdDsNCnZhciBEcmFnTGlzdGVuZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNTQpOw0KZXhwb3J0cy5EcmFnTGlzdGVuZXIgPSBEcmFnTGlzdGVuZXJfMS5kZWZhdWx0Ow0KdmFyIFByb21pc2VfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjApOw0KZXhwb3J0cy5Qcm9taXNlID0gUHJvbWlzZV8xLmRlZmF1bHQ7DQp2YXIgVGFza1F1ZXVlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIxNyk7DQpleHBvcnRzLlRhc2tRdWV1ZSA9IFRhc2tRdWV1ZV8xLmRlZmF1bHQ7DQp2YXIgUmVuZGVyUXVldWVfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjE4KTsNCmV4cG9ydHMuUmVuZGVyUXVldWUgPSBSZW5kZXJRdWV1ZV8xLmRlZmF1bHQ7DQp2YXIgU2Nyb2xsZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMzkpOw0KZXhwb3J0cy5TY3JvbGxlciA9IFNjcm9sbGVyXzEuZGVmYXVsdDsNCnZhciBUaGVtZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzOCk7DQpleHBvcnRzLlRoZW1lID0gVGhlbWVfMS5kZWZhdWx0Ow0KdmFyIERhdGVDb21wb25lbnRfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjE5KTsNCmV4cG9ydHMuRGF0ZUNvbXBvbmVudCA9IERhdGVDb21wb25lbnRfMS5kZWZhdWx0Ow0KdmFyIEludGVyYWN0aXZlRGF0ZUNvbXBvbmVudF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0MCk7DQpleHBvcnRzLkludGVyYWN0aXZlRGF0ZUNvbXBvbmVudCA9IEludGVyYWN0aXZlRGF0ZUNvbXBvbmVudF8xLmRlZmF1bHQ7DQp2YXIgQ2FsZW5kYXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjIwKTsNCmV4cG9ydHMuQ2FsZW5kYXIgPSBDYWxlbmRhcl8xLmRlZmF1bHQ7DQp2YXIgVmlld18xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0MSk7DQpleHBvcnRzLlZpZXcgPSBWaWV3XzEuZGVmYXVsdDsNCnZhciBWaWV3UmVnaXN0cnlfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjEpOw0KZXhwb3J0cy5kZWZpbmVWaWV3ID0gVmlld1JlZ2lzdHJ5XzEuZGVmaW5lVmlldzsNCmV4cG9ydHMuZ2V0Vmlld0NvbmZpZyA9IFZpZXdSZWdpc3RyeV8xLmdldFZpZXdDb25maWc7DQp2YXIgRGF5VGFibGVNaXhpbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1NSk7DQpleHBvcnRzLkRheVRhYmxlTWl4aW4gPSBEYXlUYWJsZU1peGluXzEuZGVmYXVsdDsNCnZhciBCdXNpbmVzc0hvdXJSZW5kZXJlcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1Nik7DQpleHBvcnRzLkJ1c2luZXNzSG91clJlbmRlcmVyID0gQnVzaW5lc3NIb3VyUmVuZGVyZXJfMS5kZWZhdWx0Ow0KdmFyIEV2ZW50UmVuZGVyZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNDIpOw0KZXhwb3J0cy5FdmVudFJlbmRlcmVyID0gRXZlbnRSZW5kZXJlcl8xLmRlZmF1bHQ7DQp2YXIgRmlsbFJlbmRlcmVyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDU3KTsNCmV4cG9ydHMuRmlsbFJlbmRlcmVyID0gRmlsbFJlbmRlcmVyXzEuZGVmYXVsdDsNCnZhciBIZWxwZXJSZW5kZXJlcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1OCk7DQpleHBvcnRzLkhlbHBlclJlbmRlcmVyID0gSGVscGVyUmVuZGVyZXJfMS5kZWZhdWx0Ow0KdmFyIEV4dGVybmFsRHJvcHBpbmdfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjIyKTsNCmV4cG9ydHMuRXh0ZXJuYWxEcm9wcGluZyA9IEV4dGVybmFsRHJvcHBpbmdfMS5kZWZhdWx0Ow0KdmFyIEV2ZW50UmVzaXppbmdfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjIzKTsNCmV4cG9ydHMuRXZlbnRSZXNpemluZyA9IEV2ZW50UmVzaXppbmdfMS5kZWZhdWx0Ow0KdmFyIEV2ZW50UG9pbnRpbmdfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNTkpOw0KZXhwb3J0cy5FdmVudFBvaW50aW5nID0gRXZlbnRQb2ludGluZ18xLmRlZmF1bHQ7DQp2YXIgRXZlbnREcmFnZ2luZ18xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMjQpOw0KZXhwb3J0cy5FdmVudERyYWdnaW5nID0gRXZlbnREcmFnZ2luZ18xLmRlZmF1bHQ7DQp2YXIgRGF0ZVNlbGVjdGluZ18xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMjUpOw0KZXhwb3J0cy5EYXRlU2VsZWN0aW5nID0gRGF0ZVNlbGVjdGluZ18xLmRlZmF1bHQ7DQp2YXIgU3RhbmRhcmRJbnRlcmFjdGlvbnNNaXhpbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2MCk7DQpleHBvcnRzLlN0YW5kYXJkSW50ZXJhY3Rpb25zTWl4aW4gPSBTdGFuZGFyZEludGVyYWN0aW9uc01peGluXzEuZGVmYXVsdDsNCnZhciBBZ2VuZGFWaWV3XzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIyNik7DQpleHBvcnRzLkFnZW5kYVZpZXcgPSBBZ2VuZGFWaWV3XzEuZGVmYXVsdDsNCnZhciBUaW1lR3JpZF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMjcpOw0KZXhwb3J0cy5UaW1lR3JpZCA9IFRpbWVHcmlkXzEuZGVmYXVsdDsNCnZhciBEYXlHcmlkXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYxKTsNCmV4cG9ydHMuRGF5R3JpZCA9IERheUdyaWRfMS5kZWZhdWx0Ow0KdmFyIEJhc2ljVmlld18xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2Mik7DQpleHBvcnRzLkJhc2ljVmlldyA9IEJhc2ljVmlld18xLmRlZmF1bHQ7DQp2YXIgTW9udGhWaWV3XzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIyOSk7DQpleHBvcnRzLk1vbnRoVmlldyA9IE1vbnRoVmlld18xLmRlZmF1bHQ7DQp2YXIgTGlzdFZpZXdfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjMwKTsNCmV4cG9ydHMuTGlzdFZpZXcgPSBMaXN0Vmlld18xLmRlZmF1bHQ7DQoKCi8qKiovIH0pLAovKiAxOCAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIFVuem9uZWRSYW5nZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1KTsNCi8qDQpNZWFudCB0byBiZSBpbW11dGFibGUNCiovDQp2YXIgRXZlbnREYXRlUHJvZmlsZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsNCiAgICBmdW5jdGlvbiBFdmVudERhdGVQcm9maWxlKHN0YXJ0LCBlbmQsIGNhbGVuZGFyKSB7DQogICAgICAgIHRoaXMuc3RhcnQgPSBzdGFydDsNCiAgICAgICAgdGhpcy5lbmQgPSBlbmQgfHwgbnVsbDsNCiAgICAgICAgdGhpcy51bnpvbmVkUmFuZ2UgPSB0aGlzLmJ1aWxkVW56b25lZFJhbmdlKGNhbGVuZGFyKTsNCiAgICB9DQogICAgLyoNCiAgICBOZWVkcyBhbiBFdmVudFNvdXJjZSBvYmplY3QNCiAgICAqLw0KICAgIEV2ZW50RGF0ZVByb2ZpbGUucGFyc2UgPSBmdW5jdGlvbiAocmF3UHJvcHMsIHNvdXJjZSkgew0KICAgICAgICB2YXIgc3RhcnRJbnB1dCA9IHJhd1Byb3BzLnN0YXJ0IHx8IHJhd1Byb3BzLmRhdGU7DQogICAgICAgIHZhciBlbmRJbnB1dCA9IHJhd1Byb3BzLmVuZDsNCiAgICAgICAgaWYgKCFzdGFydElucHV0KSB7DQogICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0NCiAgICAgICAgdmFyIGNhbGVuZGFyID0gc291cmNlLmNhbGVuZGFyOw0KICAgICAgICB2YXIgc3RhcnQgPSBjYWxlbmRhci5tb21lbnQoc3RhcnRJbnB1dCk7DQogICAgICAgIHZhciBlbmQgPSBlbmRJbnB1dCA/IGNhbGVuZGFyLm1vbWVudChlbmRJbnB1dCkgOiBudWxsOw0KICAgICAgICB2YXIgZm9yY2VkQWxsRGF5ID0gcmF3UHJvcHMuYWxsRGF5Ow0KICAgICAgICB2YXIgZm9yY2VFdmVudER1cmF0aW9uID0gY2FsZW5kYXIub3B0KCdmb3JjZUV2ZW50RHVyYXRpb24nKTsNCiAgICAgICAgaWYgKCFzdGFydC5pc1ZhbGlkKCkpIHsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoZW5kICYmICghZW5kLmlzVmFsaWQoKSB8fCAhZW5kLmlzQWZ0ZXIoc3RhcnQpKSkgew0KICAgICAgICAgICAgZW5kID0gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoZm9yY2VkQWxsRGF5ID09IG51bGwpIHsNCiAgICAgICAgICAgIGZvcmNlZEFsbERheSA9IHNvdXJjZS5hbGxEYXlEZWZhdWx0Ow0KICAgICAgICAgICAgaWYgKGZvcmNlZEFsbERheSA9PSBudWxsKSB7DQogICAgICAgICAgICAgICAgZm9yY2VkQWxsRGF5ID0gY2FsZW5kYXIub3B0KCdhbGxEYXlEZWZhdWx0Jyk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgaWYgKGZvcmNlZEFsbERheSA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgc3RhcnQuc3RyaXBUaW1lKCk7DQogICAgICAgICAgICBpZiAoZW5kKSB7DQogICAgICAgICAgICAgICAgZW5kLnN0cmlwVGltZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGVsc2UgaWYgKGZvcmNlZEFsbERheSA9PT0gZmFsc2UpIHsNCiAgICAgICAgICAgIGlmICghc3RhcnQuaGFzVGltZSgpKSB7DQogICAgICAgICAgICAgICAgc3RhcnQudGltZSgwKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChlbmQgJiYgIWVuZC5oYXNUaW1lKCkpIHsNCiAgICAgICAgICAgICAgICBlbmQudGltZSgwKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBpZiAoIWVuZCAmJiBmb3JjZUV2ZW50RHVyYXRpb24pIHsNCiAgICAgICAgICAgIGVuZCA9IGNhbGVuZGFyLmdldERlZmF1bHRFdmVudEVuZCghc3RhcnQuaGFzVGltZSgpLCBzdGFydCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIG5ldyBFdmVudERhdGVQcm9maWxlKHN0YXJ0LCBlbmQsIGNhbGVuZGFyKTsNCiAgICB9Ow0KICAgIEV2ZW50RGF0ZVByb2ZpbGUuaXNTdGFuZGFyZFByb3AgPSBmdW5jdGlvbiAocHJvcE5hbWUpIHsNCiAgICAgICAgcmV0dXJuIHByb3BOYW1lID09PSAnc3RhcnQnIHx8IHByb3BOYW1lID09PSAnZGF0ZScgfHwgcHJvcE5hbWUgPT09ICdlbmQnIHx8IHByb3BOYW1lID09PSAnYWxsRGF5JzsNCiAgICB9Ow0KICAgIEV2ZW50RGF0ZVByb2ZpbGUucHJvdG90eXBlLmlzQWxsRGF5ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gISh0aGlzLnN0YXJ0Lmhhc1RpbWUoKSB8fCAodGhpcy5lbmQgJiYgdGhpcy5lbmQuaGFzVGltZSgpKSk7DQogICAgfTsNCiAgICAvKg0KICAgIE5lZWRzIGEgQ2FsZW5kYXIgb2JqZWN0DQogICAgKi8NCiAgICBFdmVudERhdGVQcm9maWxlLnByb3RvdHlwZS5idWlsZFVuem9uZWRSYW5nZSA9IGZ1bmN0aW9uIChjYWxlbmRhcikgew0KICAgICAgICB2YXIgc3RhcnRNcyA9IHRoaXMuc3RhcnQuY2xvbmUoKS5zdHJpcFpvbmUoKS52YWx1ZU9mKCk7DQogICAgICAgIHZhciBlbmRNcyA9IHRoaXMuZ2V0RW5kKGNhbGVuZGFyKS5zdHJpcFpvbmUoKS52YWx1ZU9mKCk7DQogICAgICAgIHJldHVybiBuZXcgVW56b25lZFJhbmdlXzEuZGVmYXVsdChzdGFydE1zLCBlbmRNcyk7DQogICAgfTsNCiAgICAvKg0KICAgIE5lZWRzIGEgQ2FsZW5kYXIgb2JqZWN0DQogICAgKi8NCiAgICBFdmVudERhdGVQcm9maWxlLnByb3RvdHlwZS5nZXRFbmQgPSBmdW5jdGlvbiAoY2FsZW5kYXIpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZW5kID8NCiAgICAgICAgICAgIHRoaXMuZW5kLmNsb25lKCkgOg0KICAgICAgICAgICAgLy8gZGVyaXZlIHRoZSBlbmQgZnJvbSB0aGUgc3RhcnQgYW5kIGFsbERheS4gY29tcHV0ZSBhbGxEYXkgaWYgbmVjZXNzYXJ5DQogICAgICAgICAgICBjYWxlbmRhci5nZXREZWZhdWx0RXZlbnRFbmQodGhpcy5pc0FsbERheSgpLCB0aGlzLnN0YXJ0KTsNCiAgICB9Ow0KICAgIHJldHVybiBFdmVudERhdGVQcm9maWxlOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IEV2ZW50RGF0ZVByb2ZpbGU7DQoKCi8qKiovIH0pLAovKiAxOSAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIFVuem9uZWRSYW5nZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1KTsNCnZhciB1dGlsXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM0KTsNCnZhciBFdmVudFJhbmdlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIxMSk7DQovKg0KSXQncyBleHBlY3RlZCB0aGF0IHRoZXJlIHdpbGwgYmUgYXQgbGVhc3Qgb25lIEV2ZW50SW5zdGFuY2UsDQpPUiB0aGF0IGFuIGV4cGxpY2l0RXZlbnREZWYgaXMgYXNzaWduZWQuDQoqLw0KdmFyIEV2ZW50SW5zdGFuY2VHcm91cCA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsNCiAgICBmdW5jdGlvbiBFdmVudEluc3RhbmNlR3JvdXAoZXZlbnRJbnN0YW5jZXMpIHsNCiAgICAgICAgdGhpcy5ldmVudEluc3RhbmNlcyA9IGV2ZW50SW5zdGFuY2VzIHx8IFtdOw0KICAgIH0NCiAgICBFdmVudEluc3RhbmNlR3JvdXAucHJvdG90eXBlLmdldEFsbEV2ZW50UmFuZ2VzID0gZnVuY3Rpb24gKGNvbnN0cmFpbnRSYW5nZSkgew0KICAgICAgICBpZiAoY29uc3RyYWludFJhbmdlKSB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5zbGljZU5vcm1hbFJlbmRlclJhbmdlcyhjb25zdHJhaW50UmFuZ2UpOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRJbnN0YW5jZXMubWFwKHV0aWxfMS5ldmVudEluc3RhbmNlVG9FdmVudFJhbmdlKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgRXZlbnRJbnN0YW5jZUdyb3VwLnByb3RvdHlwZS5zbGljZVJlbmRlclJhbmdlcyA9IGZ1bmN0aW9uIChjb25zdHJhaW50UmFuZ2UpIHsNCiAgICAgICAgaWYgKHRoaXMuaXNJbnZlcnNlKCkpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLnNsaWNlSW52ZXJzZVJlbmRlclJhbmdlcyhjb25zdHJhaW50UmFuZ2UpOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2xpY2VOb3JtYWxSZW5kZXJSYW5nZXMoY29uc3RyYWludFJhbmdlKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgRXZlbnRJbnN0YW5jZUdyb3VwLnByb3RvdHlwZS5zbGljZU5vcm1hbFJlbmRlclJhbmdlcyA9IGZ1bmN0aW9uIChjb25zdHJhaW50UmFuZ2UpIHsNCiAgICAgICAgdmFyIGV2ZW50SW5zdGFuY2VzID0gdGhpcy5ldmVudEluc3RhbmNlczsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIHZhciBldmVudEluc3RhbmNlOw0KICAgICAgICB2YXIgc2xpY2VkUmFuZ2U7DQogICAgICAgIHZhciBzbGljZWRFdmVudFJhbmdlcyA9IFtdOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZXZlbnRJbnN0YW5jZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIGV2ZW50SW5zdGFuY2UgPSBldmVudEluc3RhbmNlc1tpXTsNCiAgICAgICAgICAgIHNsaWNlZFJhbmdlID0gZXZlbnRJbnN0YW5jZS5kYXRlUHJvZmlsZS51bnpvbmVkUmFuZ2UuaW50ZXJzZWN0KGNvbnN0cmFpbnRSYW5nZSk7DQogICAgICAgICAgICBpZiAoc2xpY2VkUmFuZ2UpIHsNCiAgICAgICAgICAgICAgICBzbGljZWRFdmVudFJhbmdlcy5wdXNoKG5ldyBFdmVudFJhbmdlXzEuZGVmYXVsdChzbGljZWRSYW5nZSwgZXZlbnRJbnN0YW5jZS5kZWYsIGV2ZW50SW5zdGFuY2UpKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gc2xpY2VkRXZlbnRSYW5nZXM7DQogICAgfTsNCiAgICBFdmVudEluc3RhbmNlR3JvdXAucHJvdG90eXBlLnNsaWNlSW52ZXJzZVJlbmRlclJhbmdlcyA9IGZ1bmN0aW9uIChjb25zdHJhaW50UmFuZ2UpIHsNCiAgICAgICAgdmFyIHVuem9uZWRSYW5nZXMgPSB0aGlzLmV2ZW50SW5zdGFuY2VzLm1hcCh1dGlsXzEuZXZlbnRJbnN0YW5jZVRvVW56b25lZFJhbmdlKTsNCiAgICAgICAgdmFyIG93bmVyRGVmID0gdGhpcy5nZXRFdmVudERlZigpOw0KICAgICAgICB1bnpvbmVkUmFuZ2VzID0gVW56b25lZFJhbmdlXzEuZGVmYXVsdC5pbnZlcnRSYW5nZXModW56b25lZFJhbmdlcywgY29uc3RyYWludFJhbmdlKTsNCiAgICAgICAgcmV0dXJuIHVuem9uZWRSYW5nZXMubWFwKGZ1bmN0aW9uICh1bnpvbmVkUmFuZ2UpIHsNCiAgICAgICAgICAgIHJldHVybiBuZXcgRXZlbnRSYW5nZV8xLmRlZmF1bHQodW56b25lZFJhbmdlLCBvd25lckRlZik7IC8vIGRvbid0IGdpdmUgYW4gRXZlbnRJbnN0YW5jZQ0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIEV2ZW50SW5zdGFuY2VHcm91cC5wcm90b3R5cGUuaXNJbnZlcnNlID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gdGhpcy5nZXRFdmVudERlZigpLmhhc0ludmVyc2VSZW5kZXJpbmcoKTsNCiAgICB9Ow0KICAgIEV2ZW50SW5zdGFuY2VHcm91cC5wcm90b3R5cGUuZ2V0RXZlbnREZWYgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHJldHVybiB0aGlzLmV4cGxpY2l0RXZlbnREZWYgfHwgdGhpcy5ldmVudEluc3RhbmNlc1swXS5kZWY7DQogICAgfTsNCiAgICByZXR1cm4gRXZlbnRJbnN0YW5jZUdyb3VwOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IEV2ZW50SW5zdGFuY2VHcm91cDsNCgoKLyoqKi8gfSksCi8qIDIwICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgUHJvbWlzZVN0dWIgPSB7DQogICAgY29uc3RydWN0OiBmdW5jdGlvbiAoZXhlY3V0b3IpIHsNCiAgICAgICAgdmFyIGRlZmVycmVkID0gJC5EZWZlcnJlZCgpOw0KICAgICAgICB2YXIgcHJvbWlzZSA9IGRlZmVycmVkLnByb21pc2UoKTsNCiAgICAgICAgaWYgKHR5cGVvZiBleGVjdXRvciA9PT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICAgICAgZXhlY3V0b3IoZnVuY3Rpb24gKHZhbCkgew0KICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUodmFsKTsNCiAgICAgICAgICAgICAgICBhdHRhY2hJbW1lZGlhdGVseVJlc29sdmluZ1RoZW4ocHJvbWlzZSwgdmFsKTsNCiAgICAgICAgICAgIH0sIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoKTsNCiAgICAgICAgICAgICAgICBhdHRhY2hJbW1lZGlhdGVseVJlamVjdGluZ1RoZW4ocHJvbWlzZSk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcHJvbWlzZTsNCiAgICB9LA0KICAgIHJlc29sdmU6IGZ1bmN0aW9uICh2YWwpIHsNCiAgICAgICAgdmFyIGRlZmVycmVkID0gJC5EZWZlcnJlZCgpLnJlc29sdmUodmFsKTsNCiAgICAgICAgdmFyIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlKCk7DQogICAgICAgIGF0dGFjaEltbWVkaWF0ZWx5UmVzb2x2aW5nVGhlbihwcm9taXNlLCB2YWwpOw0KICAgICAgICByZXR1cm4gcHJvbWlzZTsNCiAgICB9LA0KICAgIHJlamVjdDogZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgZGVmZXJyZWQgPSAkLkRlZmVycmVkKCkucmVqZWN0KCk7DQogICAgICAgIHZhciBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSgpOw0KICAgICAgICBhdHRhY2hJbW1lZGlhdGVseVJlamVjdGluZ1RoZW4ocHJvbWlzZSk7DQogICAgICAgIHJldHVybiBwcm9taXNlOw0KICAgIH0NCn07DQpleHBvcnRzLmRlZmF1bHQgPSBQcm9taXNlU3R1YjsNCmZ1bmN0aW9uIGF0dGFjaEltbWVkaWF0ZWx5UmVzb2x2aW5nVGhlbihwcm9taXNlLCB2YWwpIHsNCiAgICBwcm9taXNlLnRoZW4gPSBmdW5jdGlvbiAob25SZXNvbHZlKSB7DQogICAgICAgIGlmICh0eXBlb2Ygb25SZXNvbHZlID09PSAnZnVuY3Rpb24nKSB7DQogICAgICAgICAgICByZXR1cm4gUHJvbWlzZVN0dWIucmVzb2x2ZShvblJlc29sdmUodmFsKSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHByb21pc2U7DQogICAgfTsNCn0NCmZ1bmN0aW9uIGF0dGFjaEltbWVkaWF0ZWx5UmVqZWN0aW5nVGhlbihwcm9taXNlKSB7DQogICAgcHJvbWlzZS50aGVuID0gZnVuY3Rpb24gKG9uUmVzb2x2ZSwgb25SZWplY3QpIHsNCiAgICAgICAgaWYgKHR5cGVvZiBvblJlamVjdCA9PT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICAgICAgb25SZWplY3QoKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcHJvbWlzZTsNCiAgICB9Ow0KfQ0KCgovKioqLyB9KSwKLyogMjEgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciBleHBvcnRIb29rcyA9IF9fd2VicGFja19yZXF1aXJlX18oMTcpOw0KZXhwb3J0cy52aWV3SGFzaCA9IHt9Ow0KZXhwb3J0SG9va3Mudmlld3MgPSBleHBvcnRzLnZpZXdIYXNoOw0KZnVuY3Rpb24gZGVmaW5lVmlldyh2aWV3TmFtZSwgdmlld0NvbmZpZykgew0KICAgIGV4cG9ydHMudmlld0hhc2hbdmlld05hbWVdID0gdmlld0NvbmZpZzsNCn0NCmV4cG9ydHMuZGVmaW5lVmlldyA9IGRlZmluZVZpZXc7DQpmdW5jdGlvbiBnZXRWaWV3Q29uZmlnKHZpZXdOYW1lKSB7DQogICAgcmV0dXJuIGV4cG9ydHMudmlld0hhc2hbdmlld05hbWVdOw0KfQ0KZXhwb3J0cy5nZXRWaWV3Q29uZmlnID0gZ2V0Vmlld0NvbmZpZzsNCgoKLyoqKi8gfSksCi8qIDIyICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdHNsaWJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCnZhciBEcmFnTGlzdGVuZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNTQpOw0KLyogVHJhY2tzIG1vdXNlIG1vdmVtZW50cyBvdmVyIGEgY29tcG9uZW50IGFuZCByYWlzZXMgZXZlbnRzIGFib3V0IHdoaWNoIGhpdCB0aGUgbW91c2UgaXMgb3Zlci4NCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0Kb3B0aW9uczoNCi0gc3ViamVjdEVsDQotIHN1YmplY3RDZW50ZXINCiovDQp2YXIgSGl0RHJhZ0xpc3RlbmVyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKEhpdERyYWdMaXN0ZW5lciwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBIaXREcmFnTGlzdGVuZXIoY29tcG9uZW50LCBvcHRpb25zKSB7DQogICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMsIG9wdGlvbnMpIHx8IHRoaXM7DQogICAgICAgIF90aGlzLmNvbXBvbmVudCA9IGNvbXBvbmVudDsNCiAgICAgICAgcmV0dXJuIF90aGlzOw0KICAgIH0NCiAgICAvLyBDYWxsZWQgd2hlbiBkcmFnIGxpc3RlbmluZyBzdGFydHMgKGJ1dCBhIHJlYWwgZHJhZyBoYXMgbm90IG5lY2Vzc2FyaWx5IGJlZ2FuKS4NCiAgICAvLyBldiBtaWdodCBiZSB1bmRlZmluZWQgaWYgZHJhZ2dpbmcgd2FzIHN0YXJ0ZWQgbWFudWFsbHkuDQogICAgSGl0RHJhZ0xpc3RlbmVyLnByb3RvdHlwZS5oYW5kbGVJbnRlcmFjdGlvblN0YXJ0ID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIHZhciBzdWJqZWN0RWwgPSB0aGlzLnN1YmplY3RFbDsNCiAgICAgICAgdmFyIHN1YmplY3RSZWN0Ow0KICAgICAgICB2YXIgb3JpZ1BvaW50Ow0KICAgICAgICB2YXIgcG9pbnQ7DQogICAgICAgIHRoaXMuY29tcG9uZW50LmhpdHNOZWVkZWQoKTsNCiAgICAgICAgdGhpcy5jb21wdXRlU2Nyb2xsQm91bmRzKCk7IC8vIGZvciBhdXRvc2Nyb2xsDQogICAgICAgIGlmIChldikgew0KICAgICAgICAgICAgb3JpZ1BvaW50ID0geyBsZWZ0OiB1dGlsXzEuZ2V0RXZYKGV2KSwgdG9wOiB1dGlsXzEuZ2V0RXZZKGV2KSB9Ow0KICAgICAgICAgICAgcG9pbnQgPSBvcmlnUG9pbnQ7DQogICAgICAgICAgICAvLyBjb25zdHJhaW4gdGhlIHBvaW50IHRvIGJvdW5kcyBvZiB0aGUgZWxlbWVudCBiZWluZyBkcmFnZ2VkDQogICAgICAgICAgICBpZiAoc3ViamVjdEVsKSB7DQogICAgICAgICAgICAgICAgc3ViamVjdFJlY3QgPSB1dGlsXzEuZ2V0T3V0ZXJSZWN0KHN1YmplY3RFbCk7IC8vIHVzZWQgZm9yIGNlbnRlcmluZyBhcyB3ZWxsDQogICAgICAgICAgICAgICAgcG9pbnQgPSB1dGlsXzEuY29uc3RyYWluUG9pbnQocG9pbnQsIHN1YmplY3RSZWN0KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMub3JpZ0hpdCA9IHRoaXMucXVlcnlIaXQocG9pbnQubGVmdCwgcG9pbnQudG9wKTsNCiAgICAgICAgICAgIC8vIHRyZWF0IHRoZSBjZW50ZXIgb2YgdGhlIHN1YmplY3QgYXMgdGhlIGNvbGxpc2lvbiBwb2ludD8NCiAgICAgICAgICAgIGlmIChzdWJqZWN0RWwgJiYgdGhpcy5vcHRpb25zLnN1YmplY3RDZW50ZXIpIHsNCiAgICAgICAgICAgICAgICAvLyBvbmx5IGNvbnNpZGVyIHRoZSBhcmVhIHRoZSBzdWJqZWN0IG92ZXJsYXBzIHRoZSBoaXQuIGJlc3QgZm9yIGxhcmdlIHN1YmplY3RzLg0KICAgICAgICAgICAgICAgIC8vIFRPRE86IHNraXAgdGhpcyBpZiBoaXQgZGlkbid0IHN1cHBseSBsZWZ0L3JpZ2h0L3RvcC9ib3R0b20NCiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcmlnSGl0KSB7DQogICAgICAgICAgICAgICAgICAgIHN1YmplY3RSZWN0ID0gdXRpbF8xLmludGVyc2VjdFJlY3RzKHRoaXMub3JpZ0hpdCwgc3ViamVjdFJlY3QpIHx8DQogICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0UmVjdDsgLy8gaW4gY2FzZSB0aGVyZSBpcyBubyBpbnRlcnNlY3Rpb24NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcG9pbnQgPSB1dGlsXzEuZ2V0UmVjdENlbnRlcihzdWJqZWN0UmVjdCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLmNvb3JkQWRqdXN0ID0gdXRpbF8xLmRpZmZQb2ludHMocG9pbnQsIG9yaWdQb2ludCk7IC8vIHBvaW50IC0gb3JpZ1BvaW50DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICB0aGlzLm9yaWdIaXQgPSBudWxsOw0KICAgICAgICAgICAgdGhpcy5jb29yZEFkanVzdCA9IG51bGw7DQogICAgICAgIH0NCiAgICAgICAgLy8gY2FsbCB0aGUgc3VwZXItbWV0aG9kLiBkbyBpdCBhZnRlciBvcmlnSGl0IGhhcyBiZWVuIGNvbXB1dGVkDQogICAgICAgIF9zdXBlci5wcm90b3R5cGUuaGFuZGxlSW50ZXJhY3Rpb25TdGFydC5jYWxsKHRoaXMsIGV2KTsNCiAgICB9Ow0KICAgIC8vIENhbGxlZCB3aGVuIHRoZSBhY3R1YWwgZHJhZyBoYXMgc3RhcnRlZA0KICAgIEhpdERyYWdMaXN0ZW5lci5wcm90b3R5cGUuaGFuZGxlRHJhZ1N0YXJ0ID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIHZhciBoaXQ7DQogICAgICAgIF9zdXBlci5wcm90b3R5cGUuaGFuZGxlRHJhZ1N0YXJ0LmNhbGwodGhpcywgZXYpOw0KICAgICAgICAvLyBtaWdodCBiZSBkaWZmZXJlbnQgZnJvbSB0aGlzLm9yaWdIaXQgaWYgdGhlIG1pbi1kaXN0YW5jZSBpcyBsYXJnZQ0KICAgICAgICBoaXQgPSB0aGlzLnF1ZXJ5SGl0KHV0aWxfMS5nZXRFdlgoZXYpLCB1dGlsXzEuZ2V0RXZZKGV2KSk7DQogICAgICAgIC8vIHJlcG9ydCB0aGUgaW5pdGlhbCBoaXQgdGhlIG1vdXNlIGlzIG92ZXINCiAgICAgICAgLy8gZXNwZWNpYWxseSBpbXBvcnRhbnQgaWYgbm8gbWluLWRpc3RhbmNlIGFuZCBkcmFnIHN0YXJ0cyBpbW1lZGlhdGVseQ0KICAgICAgICBpZiAoaGl0KSB7DQogICAgICAgICAgICB0aGlzLmhhbmRsZUhpdE92ZXIoaGl0KTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gQ2FsbGVkIHdoZW4gdGhlIGRyYWcgbW92ZXMNCiAgICBIaXREcmFnTGlzdGVuZXIucHJvdG90eXBlLmhhbmRsZURyYWcgPSBmdW5jdGlvbiAoZHgsIGR5LCBldikgew0KICAgICAgICB2YXIgaGl0Ow0KICAgICAgICBfc3VwZXIucHJvdG90eXBlLmhhbmRsZURyYWcuY2FsbCh0aGlzLCBkeCwgZHksIGV2KTsNCiAgICAgICAgaGl0ID0gdGhpcy5xdWVyeUhpdCh1dGlsXzEuZ2V0RXZYKGV2KSwgdXRpbF8xLmdldEV2WShldikpOw0KICAgICAgICBpZiAoIWlzSGl0c0VxdWFsKGhpdCwgdGhpcy5oaXQpKSB7DQogICAgICAgICAgICBpZiAodGhpcy5oaXQpIHsNCiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUhpdE91dCgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKGhpdCkgew0KICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlSGl0T3ZlcihoaXQpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBDYWxsZWQgd2hlbiBkcmFnZ2luZyBoYXMgYmVlbiBzdG9wcGVkDQogICAgSGl0RHJhZ0xpc3RlbmVyLnByb3RvdHlwZS5oYW5kbGVEcmFnRW5kID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIHRoaXMuaGFuZGxlSGl0RG9uZSgpOw0KICAgICAgICBfc3VwZXIucHJvdG90eXBlLmhhbmRsZURyYWdFbmQuY2FsbCh0aGlzLCBldik7DQogICAgfTsNCiAgICAvLyBDYWxsZWQgd2hlbiBhIHRoZSBtb3VzZSBoYXMganVzdCBtb3ZlZCBvdmVyIGEgbmV3IGhpdA0KICAgIEhpdERyYWdMaXN0ZW5lci5wcm90b3R5cGUuaGFuZGxlSGl0T3ZlciA9IGZ1bmN0aW9uIChoaXQpIHsNCiAgICAgICAgdmFyIGlzT3JpZyA9IGlzSGl0c0VxdWFsKGhpdCwgdGhpcy5vcmlnSGl0KTsNCiAgICAgICAgdGhpcy5oaXQgPSBoaXQ7DQogICAgICAgIHRoaXMudHJpZ2dlcignaGl0T3ZlcicsIHRoaXMuaGl0LCBpc09yaWcsIHRoaXMub3JpZ0hpdCk7DQogICAgfTsNCiAgICAvLyBDYWxsZWQgd2hlbiB0aGUgbW91c2UgaGFzIGp1c3QgbW92ZWQgb3V0IG9mIGEgaGl0DQogICAgSGl0RHJhZ0xpc3RlbmVyLnByb3RvdHlwZS5oYW5kbGVIaXRPdXQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICh0aGlzLmhpdCkgew0KICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdoaXRPdXQnLCB0aGlzLmhpdCk7DQogICAgICAgICAgICB0aGlzLmhhbmRsZUhpdERvbmUoKTsNCiAgICAgICAgICAgIHRoaXMuaGl0ID0gbnVsbDsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gQ2FsbGVkIGFmdGVyIGEgaGl0T3V0LiBBbHNvIGNhbGxlZCBiZWZvcmUgYSBkcmFnU3RvcA0KICAgIEhpdERyYWdMaXN0ZW5lci5wcm90b3R5cGUuaGFuZGxlSGl0RG9uZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMuaGl0KSB7DQogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2hpdERvbmUnLCB0aGlzLmhpdCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIENhbGxlZCB3aGVuIHRoZSBpbnRlcmFjdGlvbiBlbmRzLCB3aGV0aGVyIHRoZXJlIHdhcyBhIHJlYWwgZHJhZyBvciBub3QNCiAgICBIaXREcmFnTGlzdGVuZXIucHJvdG90eXBlLmhhbmRsZUludGVyYWN0aW9uRW5kID0gZnVuY3Rpb24gKGV2LCBpc0NhbmNlbGxlZCkgew0KICAgICAgICBfc3VwZXIucHJvdG90eXBlLmhhbmRsZUludGVyYWN0aW9uRW5kLmNhbGwodGhpcywgZXYsIGlzQ2FuY2VsbGVkKTsNCiAgICAgICAgdGhpcy5vcmlnSGl0ID0gbnVsbDsNCiAgICAgICAgdGhpcy5oaXQgPSBudWxsOw0KICAgICAgICB0aGlzLmNvbXBvbmVudC5oaXRzTm90TmVlZGVkKCk7DQogICAgfTsNCiAgICAvLyBDYWxsZWQgd2hlbiBzY3JvbGxpbmcgaGFzIHN0b3BwZWQsIHdoZXRoZXIgdGhyb3VnaCBhdXRvIHNjcm9sbCwgb3IgdGhlIHVzZXIgc2Nyb2xsaW5nDQogICAgSGl0RHJhZ0xpc3RlbmVyLnByb3RvdHlwZS5oYW5kbGVTY3JvbGxFbmQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIF9zdXBlci5wcm90b3R5cGUuaGFuZGxlU2Nyb2xsRW5kLmNhbGwodGhpcyk7DQogICAgICAgIC8vIGhpdHMnIGFic29sdXRlIHBvc2l0aW9ucyB3aWxsIGJlIGluIG5ldyBwbGFjZXMgYWZ0ZXIgYSB1c2VyJ3Mgc2Nyb2xsLg0KICAgICAgICAvLyBIQUNLIGZvciByZWNvbXB1dGluZy4NCiAgICAgICAgaWYgKHRoaXMuaXNEcmFnZ2luZykgew0KICAgICAgICAgICAgdGhpcy5jb21wb25lbnQucmVsZWFzZUhpdHMoKTsNCiAgICAgICAgICAgIHRoaXMuY29tcG9uZW50LnByZXBhcmVIaXRzKCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIEdldHMgdGhlIGhpdCB1bmRlcm5lYXRoIHRoZSBjb29yZGluYXRlcyBmb3IgdGhlIGdpdmVuIG1vdXNlIGV2ZW50DQogICAgSGl0RHJhZ0xpc3RlbmVyLnByb3RvdHlwZS5xdWVyeUhpdCA9IGZ1bmN0aW9uIChsZWZ0LCB0b3ApIHsNCiAgICAgICAgaWYgKHRoaXMuY29vcmRBZGp1c3QpIHsNCiAgICAgICAgICAgIGxlZnQgKz0gdGhpcy5jb29yZEFkanVzdC5sZWZ0Ow0KICAgICAgICAgICAgdG9wICs9IHRoaXMuY29vcmRBZGp1c3QudG9wOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzLmNvbXBvbmVudC5xdWVyeUhpdChsZWZ0LCB0b3ApOw0KICAgIH07DQogICAgcmV0dXJuIEhpdERyYWdMaXN0ZW5lcjsNCn0oRHJhZ0xpc3RlbmVyXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gSGl0RHJhZ0xpc3RlbmVyOw0KLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGhpdHMgYXJlIGlkZW50aWNhbGx5IGVxdWFsLiBgZmFsc2VgIG90aGVyd2lzZS4gTXVzdCBiZSBmcm9tIHRoZSBzYW1lIGNvbXBvbmVudC4NCi8vIFR3byBudWxsIHZhbHVlcyB3aWxsIGJlIGNvbnNpZGVyZWQgZXF1YWwsIGFzIHR3byAib3V0IG9mIHRoZSBjb21wb25lbnQiIHN0YXRlcyBhcmUgdGhlIHNhbWUuDQpmdW5jdGlvbiBpc0hpdHNFcXVhbChoaXQwLCBoaXQxKSB7DQogICAgaWYgKCFoaXQwICYmICFoaXQxKSB7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgICBpZiAoaGl0MCAmJiBoaXQxKSB7DQogICAgICAgIHJldHVybiBoaXQwLmNvbXBvbmVudCA9PT0gaGl0MS5jb21wb25lbnQgJiYNCiAgICAgICAgICAgIGlzSGl0UHJvcHNXaXRoaW4oaGl0MCwgaGl0MSkgJiYNCiAgICAgICAgICAgIGlzSGl0UHJvcHNXaXRoaW4oaGl0MSwgaGl0MCk7IC8vIGVuc3VyZXMgYWxsIHByb3BzIGFyZSBpZGVudGljYWwNCiAgICB9DQogICAgcmV0dXJuIGZhbHNlOw0KfQ0KLy8gUmV0dXJucyB0cnVlIGlmIGFsbCBvZiBzdWJIaXQncyBub24tc3RhbmRhcmQgcHJvcGVydGllcyBhcmUgd2l0aGluIHN1cGVySGl0DQpmdW5jdGlvbiBpc0hpdFByb3BzV2l0aGluKHN1YkhpdCwgc3VwZXJIaXQpIHsNCiAgICBmb3IgKHZhciBwcm9wTmFtZSBpbiBzdWJIaXQpIHsNCiAgICAgICAgaWYgKCEvXihjb21wb25lbnR8bGVmdHxyaWdodHx0b3B8Ym90dG9tKSQvLnRlc3QocHJvcE5hbWUpKSB7DQogICAgICAgICAgICBpZiAoc3ViSGl0W3Byb3BOYW1lXSAhPT0gc3VwZXJIaXRbcHJvcE5hbWVdKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KICAgIHJldHVybiB0cnVlOw0KfQ0KCgovKioqLyB9KSwKLyogMjMgKi8sCi8qIDI0ICovLAovKiAyNSAqLywKLyogMjYgKi8sCi8qIDI3ICovLAovKiAyOCAqLywKLyogMjkgKi8sCi8qIDMwICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgbW9tZW50ID0gX193ZWJwYWNrX3JlcXVpcmVfXygwKTsNCnZhciBleHBvcnRIb29rcyA9IF9fd2VicGFja19yZXF1aXJlX18oMTcpOw0KdmFyIG9wdGlvbnNfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMzEpOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQpleHBvcnRzLmxvY2FsZU9wdGlvbkhhc2ggPSB7fTsNCmV4cG9ydEhvb2tzLmxvY2FsZXMgPSBleHBvcnRzLmxvY2FsZU9wdGlvbkhhc2g7DQovLyBOT1RFOiBjYW4ndCBndWFyYW50ZWUgYW55IG9mIHRoZXNlIGNvbXB1dGF0aW9ucyB3aWxsIHJ1biBiZWNhdXNlIG5vdCBldmVyeSBsb2NhbGUgaGFzIGRhdGVwaWNrZXINCi8vIGNvbmZpZ3MsIHNvIG1ha2Ugc3VyZSB0aGVyZSBhcmUgRW5nbGlzaCBmYWxsYmFja3MgZm9yIHRoZXNlIGluIHRoZSBkZWZhdWx0cyBmaWxlLg0KdmFyIGRwQ29tcHV0YWJsZU9wdGlvbnMgPSB7DQogICAgYnV0dG9uVGV4dDogZnVuY3Rpb24gKGRwT3B0aW9ucykgew0KICAgICAgICByZXR1cm4gew0KICAgICAgICAgICAgLy8gdGhlIHRyYW5zbGF0aW9ucyBzb21ldGltZXMgd3JvbmdseSBjb250YWluIEhUTUwgZW50aXRpZXMNCiAgICAgICAgICAgIHByZXY6IHV0aWxfMS5zdHJpcEh0bWxFbnRpdGllcyhkcE9wdGlvbnMucHJldlRleHQpLA0KICAgICAgICAgICAgbmV4dDogdXRpbF8xLnN0cmlwSHRtbEVudGl0aWVzKGRwT3B0aW9ucy5uZXh0VGV4dCksDQogICAgICAgICAgICB0b2RheTogdXRpbF8xLnN0cmlwSHRtbEVudGl0aWVzKGRwT3B0aW9ucy5jdXJyZW50VGV4dCkNCiAgICAgICAgfTsNCiAgICB9LA0KICAgIC8vIFByb2R1Y2VzIGZvcm1hdCBzdHJpbmdzIGxpa2UgIk1NTU0gWVlZWSIgLT4gIlNlcHRlbWJlciAyMDE0Ig0KICAgIG1vbnRoWWVhckZvcm1hdDogZnVuY3Rpb24gKGRwT3B0aW9ucykgew0KICAgICAgICByZXR1cm4gZHBPcHRpb25zLnNob3dNb250aEFmdGVyWWVhciA/DQogICAgICAgICAgICAnWVlZWVsnICsgZHBPcHRpb25zLnllYXJTdWZmaXggKyAnXSBNTU1NJyA6DQogICAgICAgICAgICAnTU1NTSBZWVlZWycgKyBkcE9wdGlvbnMueWVhclN1ZmZpeCArICddJzsNCiAgICB9DQp9Ow0KdmFyIG1vbUNvbXB1dGFibGVPcHRpb25zID0gew0KICAgIC8vIFByb2R1Y2VzIGZvcm1hdCBzdHJpbmdzIGxpa2UgImRkZCBNL0QiIC0+ICJGcmkgOS8xNSINCiAgICBkYXlPZk1vbnRoRm9ybWF0OiBmdW5jdGlvbiAobW9tT3B0aW9ucywgZmNPcHRpb25zKSB7DQogICAgICAgIHZhciBmb3JtYXQgPSBtb21PcHRpb25zLmxvbmdEYXRlRm9ybWF0KCdsJyk7IC8vIGZvciB0aGUgZm9ybWF0IGxpa2UgIk0vRC9ZWVlZIg0KICAgICAgICAvLyBzdHJpcCB0aGUgeWVhciBvZmYgdGhlIGVkZ2UsIGFzIHdlbGwgYXMgb3RoZXIgbWlzYyBub24td2hpdGVzcGFjZSBjaGFycw0KICAgICAgICBmb3JtYXQgPSBmb3JtYXQucmVwbGFjZSgvXlkrW15cd1xzXSp8W15cd1xzXSpZKyQvZywgJycpOw0KICAgICAgICBpZiAoZmNPcHRpb25zLmlzUlRMKSB7DQogICAgICAgICAgICBmb3JtYXQgKz0gJyBkZGQnOyAvLyBmb3IgUlRMLCBhZGQgZGF5LW9mLXdlZWsgdG8gZW5kDQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBmb3JtYXQgPSAnZGRkICcgKyBmb3JtYXQ7IC8vIGZvciBMVFIsIGFkZCBkYXktb2Ytd2VlayB0byBiZWdpbm5pbmcNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZm9ybWF0Ow0KICAgIH0sDQogICAgLy8gUHJvZHVjZXMgZm9ybWF0IHN0cmluZ3MgbGlrZSAiaDptbWEiIC0+ICI2OjAwcG0iDQogICAgbWVkaXVtVGltZUZvcm1hdDogZnVuY3Rpb24gKG1vbU9wdGlvbnMpIHsNCiAgICAgICAgcmV0dXJuIG1vbU9wdGlvbnMubG9uZ0RhdGVGb3JtYXQoJ0xUJykNCiAgICAgICAgICAgIC5yZXBsYWNlKC9ccyphJC9pLCAnYScpOyAvLyBjb252ZXJ0IEFNL1BNL2FtL3BtIHRvIGxvd2VyY2FzZS4gcmVtb3ZlIGFueSBzcGFjZXMgYmVmb3JlaGFuZA0KICAgIH0sDQogICAgLy8gUHJvZHVjZXMgZm9ybWF0IHN0cmluZ3MgbGlrZSAiaCg6bW0pYSIgLT4gIjZwbSIgLyAiNjozMHBtIg0KICAgIHNtYWxsVGltZUZvcm1hdDogZnVuY3Rpb24gKG1vbU9wdGlvbnMpIHsNCiAgICAgICAgcmV0dXJuIG1vbU9wdGlvbnMubG9uZ0RhdGVGb3JtYXQoJ0xUJykNCiAgICAgICAgICAgIC5yZXBsYWNlKCc6bW0nLCAnKDptbSknKQ0KICAgICAgICAgICAgLnJlcGxhY2UoLyhcV21tKSQvLCAnKCQxKScpIC8vIGxpa2UgYWJvdmUsIGJ1dCBmb3IgZm9yZWlnbiBsb2NhbGVzDQogICAgICAgICAgICAucmVwbGFjZSgvXHMqYSQvaSwgJ2EnKTsgLy8gY29udmVydCBBTS9QTS9hbS9wbSB0byBsb3dlcmNhc2UuIHJlbW92ZSBhbnkgc3BhY2VzIGJlZm9yZWhhbmQNCiAgICB9LA0KICAgIC8vIFByb2R1Y2VzIGZvcm1hdCBzdHJpbmdzIGxpa2UgImgoOm1tKXQiIC0+ICI2cCIgLyAiNjozMHAiDQogICAgZXh0cmFTbWFsbFRpbWVGb3JtYXQ6IGZ1bmN0aW9uIChtb21PcHRpb25zKSB7DQogICAgICAgIHJldHVybiBtb21PcHRpb25zLmxvbmdEYXRlRm9ybWF0KCdMVCcpDQogICAgICAgICAgICAucmVwbGFjZSgnOm1tJywgJyg6bW0pJykNCiAgICAgICAgICAgIC5yZXBsYWNlKC8oXFdtbSkkLywgJygkMSknKSAvLyBsaWtlIGFib3ZlLCBidXQgZm9yIGZvcmVpZ24gbG9jYWxlcw0KICAgICAgICAgICAgLnJlcGxhY2UoL1xzKmEkL2ksICd0Jyk7IC8vIGNvbnZlcnQgdG8gQU0vUE0vYW0vcG0gdG8gbG93ZXJjYXNlIG9uZS1sZXR0ZXIuIHJlbW92ZSBhbnkgc3BhY2VzIGJlZm9yZWhhbmQNCiAgICB9LA0KICAgIC8vIFByb2R1Y2VzIGZvcm1hdCBzdHJpbmdzIGxpa2UgImhhIiAvICJIIiAtPiAiNnBtIiAvICIxOCINCiAgICBob3VyRm9ybWF0OiBmdW5jdGlvbiAobW9tT3B0aW9ucykgew0KICAgICAgICByZXR1cm4gbW9tT3B0aW9ucy5sb25nRGF0ZUZvcm1hdCgnTFQnKQ0KICAgICAgICAgICAgLnJlcGxhY2UoJzptbScsICcnKQ0KICAgICAgICAgICAgLnJlcGxhY2UoLyhcV21tKSQvLCAnJykgLy8gbGlrZSBhYm92ZSwgYnV0IGZvciBmb3JlaWduIGxvY2FsZXMNCiAgICAgICAgICAgIC5yZXBsYWNlKC9ccyphJC9pLCAnYScpOyAvLyBjb252ZXJ0IEFNL1BNL2FtL3BtIHRvIGxvd2VyY2FzZS4gcmVtb3ZlIGFueSBzcGFjZXMgYmVmb3JlaGFuZA0KICAgIH0sDQogICAgLy8gUHJvZHVjZXMgZm9ybWF0IHN0cmluZ3MgbGlrZSAiaDptbSIgLT4gIjY6MzAiICh3aXRoIG5vIEFNL1BNKQ0KICAgIG5vTWVyaWRpZW1UaW1lRm9ybWF0OiBmdW5jdGlvbiAobW9tT3B0aW9ucykgew0KICAgICAgICByZXR1cm4gbW9tT3B0aW9ucy5sb25nRGF0ZUZvcm1hdCgnTFQnKQ0KICAgICAgICAgICAgLnJlcGxhY2UoL1xzKmEkL2ksICcnKTsgLy8gcmVtb3ZlIHRyYWlsaW5nIEFNL1BNDQogICAgfQ0KfTsNCi8vIG9wdGlvbnMgdGhhdCBzaG91bGQgYmUgY29tcHV0ZWQgb2ZmIGxpdmUgY2FsZW5kYXIgb3B0aW9ucyAoY29uc2lkZXJzIG92ZXJyaWRlIG9wdGlvbnMpDQovLyBUT0RPOiBiZXN0IHBsYWNlIGZvciB0aGlzPyByZWxhdGVkIHRvIGxvY2FsZT8NCi8vIFRPRE86IGZsaXBwaW5nIHRleHQgYmFzZWQgb24gaXNSVEwgaXMgYSBiYWQgaWRlYSBiZWNhdXNlIHRoZSBDU1MgYGRpcmVjdGlvbmAgbWlnaHQgd2FudCB0byBoYW5kbGUgaXQNCnZhciBpbnN0YW5jZUNvbXB1dGFibGVPcHRpb25zID0gew0KICAgIC8vIFByb2R1Y2VzIGZvcm1hdCBzdHJpbmdzIGZvciByZXN1bHRzIGxpa2UgIk1vIDE2Ig0KICAgIHNtYWxsRGF5RGF0ZUZvcm1hdDogZnVuY3Rpb24gKG9wdGlvbnMpIHsNCiAgICAgICAgcmV0dXJuIG9wdGlvbnMuaXNSVEwgPw0KICAgICAgICAgICAgJ0QgZGQnIDoNCiAgICAgICAgICAgICdkZCBEJzsNCiAgICB9LA0KICAgIC8vIFByb2R1Y2VzIGZvcm1hdCBzdHJpbmdzIGZvciByZXN1bHRzIGxpa2UgIldrIDUiDQogICAgd2Vla0Zvcm1hdDogZnVuY3Rpb24gKG9wdGlvbnMpIHsNCiAgICAgICAgcmV0dXJuIG9wdGlvbnMuaXNSVEwgPw0KICAgICAgICAgICAgJ3dbICcgKyBvcHRpb25zLndlZWtOdW1iZXJUaXRsZSArICddJyA6DQogICAgICAgICAgICAnWycgKyBvcHRpb25zLndlZWtOdW1iZXJUaXRsZSArICcgXXcnOw0KICAgIH0sDQogICAgLy8gUHJvZHVjZXMgZm9ybWF0IHN0cmluZ3MgZm9yIHJlc3VsdHMgbGlrZSAiV2s1Ig0KICAgIHNtYWxsV2Vla0Zvcm1hdDogZnVuY3Rpb24gKG9wdGlvbnMpIHsNCiAgICAgICAgcmV0dXJuIG9wdGlvbnMuaXNSVEwgPw0KICAgICAgICAgICAgJ3dbJyArIG9wdGlvbnMud2Vla051bWJlclRpdGxlICsgJ10nIDoNCiAgICAgICAgICAgICdbJyArIG9wdGlvbnMud2Vla051bWJlclRpdGxlICsgJ113JzsNCiAgICB9DQp9Ow0KLy8gVE9ETzogbWFrZSB0aGVzZSBjb21wdXRhYmxlIHByb3BlcnRpZXMgaW4gb3B0aW9uc01hbmFnZXINCmZ1bmN0aW9uIHBvcHVsYXRlSW5zdGFuY2VDb21wdXRhYmxlT3B0aW9ucyhvcHRpb25zKSB7DQogICAgJC5lYWNoKGluc3RhbmNlQ29tcHV0YWJsZU9wdGlvbnMsIGZ1bmN0aW9uIChuYW1lLCBmdW5jKSB7DQogICAgICAgIGlmIChvcHRpb25zW25hbWVdID09IG51bGwpIHsNCiAgICAgICAgICAgIG9wdGlvbnNbbmFtZV0gPSBmdW5jKG9wdGlvbnMpOw0KICAgICAgICB9DQogICAgfSk7DQp9DQpleHBvcnRzLnBvcHVsYXRlSW5zdGFuY2VDb21wdXRhYmxlT3B0aW9ucyA9IHBvcHVsYXRlSW5zdGFuY2VDb21wdXRhYmxlT3B0aW9uczsNCi8vIEluaXRpYWxpemUgalF1ZXJ5IFVJIGRhdGVwaWNrZXIgdHJhbnNsYXRpb25zIHdoaWxlIHVzaW5nIHNvbWUgb2YgdGhlIHRyYW5zbGF0aW9ucw0KLy8gV2lsbCBzZXQgdGhpcyBhcyB0aGUgZGVmYXVsdCBsb2NhbGVzIGZvciBkYXRlcGlja2VyLg0KZnVuY3Rpb24gZGF0ZXBpY2tlckxvY2FsZShsb2NhbGVDb2RlLCBkcExvY2FsZUNvZGUsIGRwT3B0aW9ucykgew0KICAgIC8vIGdldCB0aGUgRnVsbENhbGVuZGFyIGludGVybmFsIG9wdGlvbiBoYXNoIGZvciB0aGlzIGxvY2FsZS4gY3JlYXRlIGlmIG5lY2Vzc2FyeQ0KICAgIHZhciBmY09wdGlvbnMgPSBleHBvcnRzLmxvY2FsZU9wdGlvbkhhc2hbbG9jYWxlQ29kZV0gfHwgKGV4cG9ydHMubG9jYWxlT3B0aW9uSGFzaFtsb2NhbGVDb2RlXSA9IHt9KTsNCiAgICAvLyB0cmFuc2ZlciBzb21lIHNpbXBsZSBvcHRpb25zIGZyb20gZGF0ZXBpY2tlciB0byBmYw0KICAgIGZjT3B0aW9ucy5pc1JUTCA9IGRwT3B0aW9ucy5pc1JUTDsNCiAgICBmY09wdGlvbnMud2Vla051bWJlclRpdGxlID0gZHBPcHRpb25zLndlZWtIZWFkZXI7DQogICAgLy8gY29tcHV0ZSBzb21lIG1vcmUgY29tcGxleCBvcHRpb25zIGZyb20gZGF0ZXBpY2tlcg0KICAgICQuZWFjaChkcENvbXB1dGFibGVPcHRpb25zLCBmdW5jdGlvbiAobmFtZSwgZnVuYykgew0KICAgICAgICBmY09wdGlvbnNbbmFtZV0gPSBmdW5jKGRwT3B0aW9ucyk7DQogICAgfSk7DQogICAgdmFyIGpxRGF0ZVBpY2tlciA9ICQuZGF0ZXBpY2tlcjsNCiAgICAvLyBpcyBqUXVlcnkgVUkgRGF0ZXBpY2tlciBpcyBvbiB0aGUgcGFnZT8NCiAgICBpZiAoanFEYXRlUGlja2VyKSB7DQogICAgICAgIC8vIFJlZ2lzdGVyIHRoZSBsb2NhbGUgZGF0YS4NCiAgICAgICAgLy8gRnVsbENhbGVuZGFyIGFuZCBNb21lbnRKUyB1c2UgbG9jYWxlIGNvZGVzIGxpa2UgInB0LWJyIiBidXQgRGF0ZXBpY2tlcg0KICAgICAgICAvLyBkb2VzIGl0IGxpa2UgInB0LUJSIiBvciBpZiBpdCBkb2Vzbid0IGhhdmUgdGhlIGxvY2FsZSwgbWF5YmUganVzdCAicHQiLg0KICAgICAgICAvLyBNYWtlIGFuIGFsaWFzIHNvIHRoZSBsb2NhbGUgY2FuIGJlIHJlZmVyZW5jZWQgZWl0aGVyIHdheS4NCiAgICAgICAganFEYXRlUGlja2VyLnJlZ2lvbmFsW2RwTG9jYWxlQ29kZV0gPQ0KICAgICAgICAgICAganFEYXRlUGlja2VyLnJlZ2lvbmFsW2xvY2FsZUNvZGVdID0gLy8gYWxpYXMNCiAgICAgICAgICAgICAgICBkcE9wdGlvbnM7DQogICAgICAgIC8vIEFsaWFzICdlbicgdG8gdGhlIGRlZmF1bHQgbG9jYWxlIGRhdGEuIERvIHRoaXMgZXZlcnkgdGltZS4NCiAgICAgICAganFEYXRlUGlja2VyLnJlZ2lvbmFsLmVuID0ganFEYXRlUGlja2VyLnJlZ2lvbmFsWycnXTsNCiAgICAgICAgLy8gU2V0IGFzIERhdGVwaWNrZXIncyBnbG9iYWwgZGVmYXVsdHMuDQogICAgICAgIGpxRGF0ZVBpY2tlci5zZXREZWZhdWx0cyhkcE9wdGlvbnMpOw0KICAgIH0NCn0NCmV4cG9ydHMuZGF0ZXBpY2tlckxvY2FsZSA9IGRhdGVwaWNrZXJMb2NhbGU7DQovLyBTZXRzIEZ1bGxDYWxlbmRhci1zcGVjaWZpYyB0cmFuc2xhdGlvbnMuIFdpbGwgc2V0IHRoZSBsb2NhbGVzIGFzIHRoZSBnbG9iYWwgZGVmYXVsdC4NCmZ1bmN0aW9uIGxvY2FsZShsb2NhbGVDb2RlLCBuZXdGY09wdGlvbnMpIHsNCiAgICB2YXIgZmNPcHRpb25zOw0KICAgIHZhciBtb21PcHRpb25zOw0KICAgIC8vIGdldCB0aGUgRnVsbENhbGVuZGFyIGludGVybmFsIG9wdGlvbiBoYXNoIGZvciB0aGlzIGxvY2FsZS4gY3JlYXRlIGlmIG5lY2Vzc2FyeQ0KICAgIGZjT3B0aW9ucyA9IGV4cG9ydHMubG9jYWxlT3B0aW9uSGFzaFtsb2NhbGVDb2RlXSB8fCAoZXhwb3J0cy5sb2NhbGVPcHRpb25IYXNoW2xvY2FsZUNvZGVdID0ge30pOw0KICAgIC8vIHByb3ZpZGVkIG5ldyBvcHRpb25zIGZvciB0aGlzIGxvY2FsZXM/IG1lcmdlIHRoZW0gaW4NCiAgICBpZiAobmV3RmNPcHRpb25zKSB7DQogICAgICAgIGZjT3B0aW9ucyA9IGV4cG9ydHMubG9jYWxlT3B0aW9uSGFzaFtsb2NhbGVDb2RlXSA9IG9wdGlvbnNfMS5tZXJnZU9wdGlvbnMoW2ZjT3B0aW9ucywgbmV3RmNPcHRpb25zXSk7DQogICAgfQ0KICAgIC8vIGNvbXB1dGUgbG9jYWxlIG9wdGlvbnMgdGhhdCB3ZXJlbid0IGRlZmluZWQuDQogICAgLy8gYWx3YXlzIGRvIHRoaXMuIG5ld0ZjT3B0aW9ucyBjYW4gYmUgdW5kZWZpbmVkIHdoZW4gaW5pdGlhbGl6aW5nIGZyb20gaTE4biBmaWxlLA0KICAgIC8vIHNvIG5vIHdheSB0byB0ZWxsIGlmIHRoaXMgaXMgYW4gaW5pdGlhbGl6YXRpb24gb3IgYSBkZWZhdWx0LXNldHRpbmcuDQogICAgbW9tT3B0aW9ucyA9IGdldE1vbWVudExvY2FsZURhdGEobG9jYWxlQ29kZSk7IC8vIHdpbGwgZmFsbCBiYWNrIHRvIGVuDQogICAgJC5lYWNoKG1vbUNvbXB1dGFibGVPcHRpb25zLCBmdW5jdGlvbiAobmFtZSwgZnVuYykgew0KICAgICAgICBpZiAoZmNPcHRpb25zW25hbWVdID09IG51bGwpIHsNCiAgICAgICAgICAgIGZjT3B0aW9uc1tuYW1lXSA9IChmdW5jKShtb21PcHRpb25zLCBmY09wdGlvbnMpOw0KICAgICAgICB9DQogICAgfSk7DQogICAgLy8gc2V0IGl0IGFzIHRoZSBkZWZhdWx0IGxvY2FsZSBmb3IgRnVsbENhbGVuZGFyDQogICAgb3B0aW9uc18xLmdsb2JhbERlZmF1bHRzLmxvY2FsZSA9IGxvY2FsZUNvZGU7DQp9DQpleHBvcnRzLmxvY2FsZSA9IGxvY2FsZTsNCi8vIFJldHVybnMgbW9tZW50J3MgaW50ZXJuYWwgbG9jYWxlIGRhdGEuIElmIGRvZXNuJ3QgZXhpc3QsIHJldHVybnMgRW5nbGlzaC4NCmZ1bmN0aW9uIGdldE1vbWVudExvY2FsZURhdGEobG9jYWxlQ29kZSkgew0KICAgIHJldHVybiBtb21lbnQubG9jYWxlRGF0YShsb2NhbGVDb2RlKSB8fCBtb21lbnQubG9jYWxlRGF0YSgnZW4nKTsNCn0NCmV4cG9ydHMuZ2V0TW9tZW50TG9jYWxlRGF0YSA9IGdldE1vbWVudExvY2FsZURhdGE7DQovLyBJbml0aWFsaXplIEVuZ2xpc2ggYnkgZm9yY2luZyBjb21wdXRhdGlvbiBvZiBtb21lbnQtZGVyaXZlZCBvcHRpb25zLg0KLy8gQWxzbywgc2V0cyBpdCBhcyB0aGUgZGVmYXVsdC4NCmxvY2FsZSgnZW4nLCBvcHRpb25zXzEuZW5nbGlzaERlZmF1bHRzKTsNCgoKLyoqKi8gfSksCi8qIDMxICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCmV4cG9ydHMuZ2xvYmFsRGVmYXVsdHMgPSB7DQogICAgdGl0bGVSYW5nZVNlcGFyYXRvcjogJyBcdTIwMTMgJywNCiAgICBtb250aFllYXJGb3JtYXQ6ICdNTU1NIFlZWVknLA0KICAgIGRlZmF1bHRUaW1lZEV2ZW50RHVyYXRpb246ICcwMjowMDowMCcsDQogICAgZGVmYXVsdEFsbERheUV2ZW50RHVyYXRpb246IHsgZGF5czogMSB9LA0KICAgIGZvcmNlRXZlbnREdXJhdGlvbjogZmFsc2UsDQogICAgbmV4dERheVRocmVzaG9sZDogJzA5OjAwOjAwJywNCiAgICAvLyBkaXNwbGF5DQogICAgY29sdW1uSGVhZGVyOiB0cnVlLA0KICAgIGRlZmF1bHRWaWV3OiAnbW9udGgnLA0KICAgIGFzcGVjdFJhdGlvOiAxLjM1LA0KICAgIGhlYWRlcjogew0KICAgICAgICBsZWZ0OiAndGl0bGUnLA0KICAgICAgICBjZW50ZXI6ICcnLA0KICAgICAgICByaWdodDogJ3RvZGF5IHByZXYsbmV4dCcNCiAgICB9LA0KICAgIHdlZWtlbmRzOiB0cnVlLA0KICAgIHdlZWtOdW1iZXJzOiBmYWxzZSwNCiAgICB3ZWVrTnVtYmVyVGl0bGU6ICdXJywNCiAgICB3ZWVrTnVtYmVyQ2FsY3VsYXRpb246ICdsb2NhbCcsDQogICAgLy8gZWRpdGFibGU6IGZhbHNlLA0KICAgIC8vIG5vd0luZGljYXRvcjogZmFsc2UsDQogICAgc2Nyb2xsVGltZTogJzA2OjAwOjAwJywNCiAgICBtaW5UaW1lOiAnMDA6MDA6MDAnLA0KICAgIG1heFRpbWU6ICcyNDowMDowMCcsDQogICAgc2hvd05vbkN1cnJlbnREYXRlczogdHJ1ZSwNCiAgICAvLyBldmVudCBhamF4DQogICAgbGF6eUZldGNoaW5nOiB0cnVlLA0KICAgIHN0YXJ0UGFyYW06ICdzdGFydCcsDQogICAgZW5kUGFyYW06ICdlbmQnLA0KICAgIHRpbWV6b25lUGFyYW06ICd0aW1lem9uZScsDQogICAgdGltZXpvbmU6IGZhbHNlLA0KICAgIC8vIGFsbERheURlZmF1bHQ6IHVuZGVmaW5lZCwNCiAgICAvLyBsb2NhbGUNCiAgICBsb2NhbGU6IG51bGwsDQogICAgaXNSVEw6IGZhbHNlLA0KICAgIGJ1dHRvblRleHQ6IHsNCiAgICAgICAgcHJldjogJ3ByZXYnLA0KICAgICAgICBuZXh0OiAnbmV4dCcsDQogICAgICAgIHByZXZZZWFyOiAncHJldiB5ZWFyJywNCiAgICAgICAgbmV4dFllYXI6ICduZXh0IHllYXInLA0KICAgICAgICB5ZWFyOiAneWVhcicsDQogICAgICAgIHRvZGF5OiAndG9kYXknLA0KICAgICAgICBtb250aDogJ21vbnRoJywNCiAgICAgICAgd2VlazogJ3dlZWsnLA0KICAgICAgICBkYXk6ICdkYXknDQogICAgfSwNCiAgICAvLyBidXR0b25JY29uczogbnVsbCwNCiAgICBhbGxEYXlUZXh0OiAnYWxsLWRheScsDQogICAgLy8gYWxsb3dzIHNldHRpbmcgYSBtaW4taGVpZ2h0IHRvIHRoZSBldmVudCBzZWdtZW50IHRvIHByZXZlbnQgc2hvcnQgZXZlbnRzIG92ZXJsYXBwaW5nIGVhY2ggb3RoZXINCiAgICBhZ2VuZGFFdmVudE1pbkhlaWdodDogMCwNCiAgICAvLyBqcXVlcnktdWkgdGhlbWluZw0KICAgIHRoZW1lOiBmYWxzZSwNCiAgICAvLyB0aGVtZUJ1dHRvbkljb25zOiBudWxsLA0KICAgIC8vIGV2ZW50UmVzaXphYmxlRnJvbVN0YXJ0OiBmYWxzZSwNCiAgICBkcmFnT3BhY2l0eTogLjc1LA0KICAgIGRyYWdSZXZlcnREdXJhdGlvbjogNTAwLA0KICAgIGRyYWdTY3JvbGw6IHRydWUsDQogICAgLy8gc2VsZWN0YWJsZTogZmFsc2UsDQogICAgdW5zZWxlY3RBdXRvOiB0cnVlLA0KICAgIC8vIHNlbGVjdE1pbkRpc3RhbmNlOiAwLA0KICAgIGRyb3BBY2NlcHQ6ICcqJywNCiAgICBldmVudE9yZGVyOiAndGl0bGUnLA0KICAgIC8vIGV2ZW50UmVuZGVyV2FpdDogbnVsbCwNCiAgICBldmVudExpbWl0OiBmYWxzZSwNCiAgICBldmVudExpbWl0VGV4dDogJ21vcmUnLA0KICAgIGV2ZW50TGltaXRDbGljazogJ3BvcG92ZXInLA0KICAgIGRheVBvcG92ZXJGb3JtYXQ6ICdMTCcsDQogICAgaGFuZGxlV2luZG93UmVzaXplOiB0cnVlLA0KICAgIHdpbmRvd1Jlc2l6ZURlbGF5OiAxMDAsDQogICAgbG9uZ1ByZXNzRGVsYXk6IDEwMDANCn07DQpleHBvcnRzLmVuZ2xpc2hEZWZhdWx0cyA9IHsNCiAgICBkYXlQb3BvdmVyRm9ybWF0OiAnZGRkZCwgTU1NTSBEJw0KfTsNCmV4cG9ydHMucnRsRGVmYXVsdHMgPSB7DQogICAgaGVhZGVyOiB7DQogICAgICAgIGxlZnQ6ICduZXh0LHByZXYgdG9kYXknLA0KICAgICAgICBjZW50ZXI6ICcnLA0KICAgICAgICByaWdodDogJ3RpdGxlJw0KICAgIH0sDQogICAgYnV0dG9uSWNvbnM6IHsNCiAgICAgICAgcHJldjogJ3JpZ2h0LXNpbmdsZS1hcnJvdycsDQogICAgICAgIG5leHQ6ICdsZWZ0LXNpbmdsZS1hcnJvdycsDQogICAgICAgIHByZXZZZWFyOiAncmlnaHQtZG91YmxlLWFycm93JywNCiAgICAgICAgbmV4dFllYXI6ICdsZWZ0LWRvdWJsZS1hcnJvdycNCiAgICB9LA0KICAgIHRoZW1lQnV0dG9uSWNvbnM6IHsNCiAgICAgICAgcHJldjogJ2NpcmNsZS10cmlhbmdsZS1lJywNCiAgICAgICAgbmV4dDogJ2NpcmNsZS10cmlhbmdsZS13JywNCiAgICAgICAgbmV4dFllYXI6ICdzZWVrLXByZXYnLA0KICAgICAgICBwcmV2WWVhcjogJ3NlZWstbmV4dCcNCiAgICB9DQp9Ow0KdmFyIGNvbXBsZXhPcHRpb25zID0gWw0KICAgICdoZWFkZXInLA0KICAgICdmb290ZXInLA0KICAgICdidXR0b25UZXh0JywNCiAgICAnYnV0dG9uSWNvbnMnLA0KICAgICd0aGVtZUJ1dHRvbkljb25zJw0KXTsNCi8vIE1lcmdlcyBhbiBhcnJheSBvZiBvcHRpb24gb2JqZWN0cyBpbnRvIGEgc2luZ2xlIG9iamVjdA0KZnVuY3Rpb24gbWVyZ2VPcHRpb25zKG9wdGlvbk9ianMpIHsNCiAgICByZXR1cm4gdXRpbF8xLm1lcmdlUHJvcHMob3B0aW9uT2JqcywgY29tcGxleE9wdGlvbnMpOw0KfQ0KZXhwb3J0cy5tZXJnZU9wdGlvbnMgPSBtZXJnZU9wdGlvbnM7DQoKCi8qKiovIH0pLAovKiAzMiAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIHRzbGliXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIpOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQovLyBDbGFzcyB0aGF0IGFsbCBvdGhlciBjbGFzc2VzIHdpbGwgaW5oZXJpdCBmcm9tDQp2YXIgQ2xhc3MgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7DQogICAgZnVuY3Rpb24gQ2xhc3MoKSB7DQogICAgfQ0KICAgIC8vIENhbGxlZCBvbiBhIGNsYXNzIHRvIGNyZWF0ZSBhIHN1YmNsYXNzLg0KICAgIC8vIExJTUlUQVRJT046IGNhbm5vdCBwcm92aWRlIGEgY29uc3RydWN0b3IhDQogICAgQ2xhc3MuZXh0ZW5kID0gZnVuY3Rpb24gKG1lbWJlcnMpIHsNCiAgICAgICAgdmFyIFN1YkNsYXNzID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgICAgICAgICAgdHNsaWJfMS5fX2V4dGVuZHMoU3ViQ2xhc3MsIF9zdXBlcik7DQogICAgICAgICAgICBmdW5jdGlvbiBTdWJDbGFzcygpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gX3N1cGVyICE9PSBudWxsICYmIF9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gU3ViQ2xhc3M7DQogICAgICAgIH0odGhpcykpOw0KICAgICAgICB1dGlsXzEuY29weU93blByb3BzKG1lbWJlcnMsIFN1YkNsYXNzLnByb3RvdHlwZSk7DQogICAgICAgIHJldHVybiBTdWJDbGFzczsNCiAgICB9Ow0KICAgIC8vIEFkZHMgbmV3IG1lbWJlciB2YXJpYWJsZXMvbWV0aG9kcyB0byB0aGUgY2xhc3MncyBwcm90b3R5cGUuDQogICAgLy8gQ2FuIGJlIGNhbGxlZCB3aXRoIGFub3RoZXIgY2xhc3MsIG9yIGEgcGxhaW4gb2JqZWN0IGhhc2ggY29udGFpbmluZyBuZXcgbWVtYmVycy4NCiAgICBDbGFzcy5taXhpbiA9IGZ1bmN0aW9uIChtZW1iZXJzKSB7DQogICAgICAgIHV0aWxfMS5jb3B5T3duUHJvcHMobWVtYmVycywgdGhpcy5wcm90b3R5cGUpOw0KICAgIH07DQogICAgcmV0dXJuIENsYXNzOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IENsYXNzOw0KCgovKioqLyB9KSwKLyogMzMgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCnZhciBQYXJzYWJsZU1vZGVsTWl4aW5fMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjA4KTsNCnZhciBFdmVudERlZiA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsNCiAgICBmdW5jdGlvbiBFdmVudERlZihzb3VyY2UpIHsNCiAgICAgICAgdGhpcy5zb3VyY2UgPSBzb3VyY2U7DQogICAgICAgIHRoaXMuY2xhc3NOYW1lID0gW107DQogICAgICAgIHRoaXMubWlzY1Byb3BzID0ge307DQogICAgfQ0KICAgIEV2ZW50RGVmLnBhcnNlID0gZnVuY3Rpb24gKHJhd0lucHV0LCBzb3VyY2UpIHsNCiAgICAgICAgdmFyIGRlZiA9IG5ldyB0aGlzKHNvdXJjZSk7DQogICAgICAgIGlmIChkZWYuYXBwbHlQcm9wcyhyYXdJbnB1dCkpIHsNCiAgICAgICAgICAgIHJldHVybiBkZWY7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH07DQogICAgRXZlbnREZWYubm9ybWFsaXplSWQgPSBmdW5jdGlvbiAoaWQpIHsNCiAgICAgICAgcmV0dXJuIFN0cmluZyhpZCk7DQogICAgfTsNCiAgICBFdmVudERlZi5nZW5lcmF0ZUlkID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gJ19mYycgKyAoRXZlbnREZWYudXVpZCsrKTsNCiAgICB9Ow0KICAgIEV2ZW50RGVmLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIGNvcHkgPSBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLnNvdXJjZSk7DQogICAgICAgIGNvcHkuaWQgPSB0aGlzLmlkOw0KICAgICAgICBjb3B5LnJhd0lkID0gdGhpcy5yYXdJZDsNCiAgICAgICAgY29weS51aWQgPSB0aGlzLnVpZDsgLy8gbm90IHJlYWxseSB1bmlxdWUgYW55bW9yZSA6KA0KICAgICAgICBFdmVudERlZi5jb3B5VmVyYmF0aW1TdGFuZGFyZFByb3BzKHRoaXMsIGNvcHkpOw0KICAgICAgICBjb3B5LmNsYXNzTmFtZSA9IHRoaXMuY2xhc3NOYW1lLnNsaWNlKCk7IC8vIGNvcHkNCiAgICAgICAgY29weS5taXNjUHJvcHMgPSAkLmV4dGVuZCh7fSwgdGhpcy5taXNjUHJvcHMpOw0KICAgICAgICByZXR1cm4gY29weTsNCiAgICB9Ow0KICAgIEV2ZW50RGVmLnByb3RvdHlwZS5oYXNJbnZlcnNlUmVuZGVyaW5nID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gdGhpcy5nZXRSZW5kZXJpbmcoKSA9PT0gJ2ludmVyc2UtYmFja2dyb3VuZCc7DQogICAgfTsNCiAgICBFdmVudERlZi5wcm90b3R5cGUuaGFzQmdSZW5kZXJpbmcgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciByZW5kZXJpbmcgPSB0aGlzLmdldFJlbmRlcmluZygpOw0KICAgICAgICByZXR1cm4gcmVuZGVyaW5nID09PSAnaW52ZXJzZS1iYWNrZ3JvdW5kJyB8fCByZW5kZXJpbmcgPT09ICdiYWNrZ3JvdW5kJzsNCiAgICB9Ow0KICAgIEV2ZW50RGVmLnByb3RvdHlwZS5nZXRSZW5kZXJpbmcgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICh0aGlzLnJlbmRlcmluZyAhPSBudWxsKSB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5yZW5kZXJpbmc7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXMuc291cmNlLnJlbmRlcmluZzsNCiAgICB9Ow0KICAgIEV2ZW50RGVmLnByb3RvdHlwZS5nZXRDb25zdHJhaW50ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5jb25zdHJhaW50ICE9IG51bGwpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnN0cmFpbnQ7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHRoaXMuc291cmNlLmNvbnN0cmFpbnQgIT0gbnVsbCkgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuc291cmNlLmNvbnN0cmFpbnQ7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXMuc291cmNlLmNhbGVuZGFyLm9wdCgnZXZlbnRDb25zdHJhaW50Jyk7IC8vIHdoYXQgYWJvdXQgVmlldyBvcHRpb24/DQogICAgfTsNCiAgICBFdmVudERlZi5wcm90b3R5cGUuZ2V0T3ZlcmxhcCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMub3ZlcmxhcCAhPSBudWxsKSB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5vdmVybGFwOw0KICAgICAgICB9DQogICAgICAgIGlmICh0aGlzLnNvdXJjZS5vdmVybGFwICE9IG51bGwpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLnNvdXJjZS5vdmVybGFwOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzLnNvdXJjZS5jYWxlbmRhci5vcHQoJ2V2ZW50T3ZlcmxhcCcpOyAvLyB3aGF0IGFib3V0IFZpZXcgb3B0aW9uPw0KICAgIH07DQogICAgRXZlbnREZWYucHJvdG90eXBlLmlzU3RhcnRFeHBsaWNpdGx5RWRpdGFibGUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICh0aGlzLnN0YXJ0RWRpdGFibGUgIT0gbnVsbCkgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RhcnRFZGl0YWJsZTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpcy5zb3VyY2Uuc3RhcnRFZGl0YWJsZTsNCiAgICB9Ow0KICAgIEV2ZW50RGVmLnByb3RvdHlwZS5pc0R1cmF0aW9uRXhwbGljaXRseUVkaXRhYmxlID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5kdXJhdGlvbkVkaXRhYmxlICE9IG51bGwpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLmR1cmF0aW9uRWRpdGFibGU7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXMuc291cmNlLmR1cmF0aW9uRWRpdGFibGU7DQogICAgfTsNCiAgICBFdmVudERlZi5wcm90b3R5cGUuaXNFeHBsaWNpdGx5RWRpdGFibGUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICh0aGlzLmVkaXRhYmxlICE9IG51bGwpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLmVkaXRhYmxlOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzLnNvdXJjZS5lZGl0YWJsZTsNCiAgICB9Ow0KICAgIEV2ZW50RGVmLnByb3RvdHlwZS50b0xlZ2FjeSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIG9iaiA9ICQuZXh0ZW5kKHt9LCB0aGlzLm1pc2NQcm9wcyk7DQogICAgICAgIG9iai5faWQgPSB0aGlzLnVpZDsNCiAgICAgICAgb2JqLnNvdXJjZSA9IHRoaXMuc291cmNlOw0KICAgICAgICBvYmouY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUuc2xpY2UoKTsgLy8gY29weQ0KICAgICAgICBvYmouYWxsRGF5ID0gdGhpcy5pc0FsbERheSgpOw0KICAgICAgICBpZiAodGhpcy5yYXdJZCAhPSBudWxsKSB7DQogICAgICAgICAgICBvYmouaWQgPSB0aGlzLnJhd0lkOw0KICAgICAgICB9DQogICAgICAgIEV2ZW50RGVmLmNvcHlWZXJiYXRpbVN0YW5kYXJkUHJvcHModGhpcywgb2JqKTsNCiAgICAgICAgcmV0dXJuIG9iajsNCiAgICB9Ow0KICAgIEV2ZW50RGVmLnByb3RvdHlwZS5hcHBseU1hbnVhbFN0YW5kYXJkUHJvcHMgPSBmdW5jdGlvbiAocmF3UHJvcHMpIHsNCiAgICAgICAgaWYgKHJhd1Byb3BzLmlkICE9IG51bGwpIHsNCiAgICAgICAgICAgIHRoaXMuaWQgPSBFdmVudERlZi5ub3JtYWxpemVJZCgodGhpcy5yYXdJZCA9IHJhd1Byb3BzLmlkKSk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICB0aGlzLmlkID0gRXZlbnREZWYuZ2VuZXJhdGVJZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmIChyYXdQcm9wcy5faWQgIT0gbnVsbCkgew0KICAgICAgICAgICAgdGhpcy51aWQgPSBTdHJpbmcocmF3UHJvcHMuX2lkKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHRoaXMudWlkID0gRXZlbnREZWYuZ2VuZXJhdGVJZCgpOw0KICAgICAgICB9DQogICAgICAgIC8vIFRPRE86IGNvbnZlcmdlIHdpdGggRXZlbnRTb3VyY2UNCiAgICAgICAgaWYgKCQuaXNBcnJheShyYXdQcm9wcy5jbGFzc05hbWUpKSB7DQogICAgICAgICAgICB0aGlzLmNsYXNzTmFtZSA9IHJhd1Byb3BzLmNsYXNzTmFtZTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAodHlwZW9mIHJhd1Byb3BzLmNsYXNzTmFtZSA9PT0gJ3N0cmluZycpIHsNCiAgICAgICAgICAgIHRoaXMuY2xhc3NOYW1lID0gcmF3UHJvcHMuY2xhc3NOYW1lLnNwbGl0KC9ccysvKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9Ow0KICAgIEV2ZW50RGVmLnByb3RvdHlwZS5hcHBseU1pc2NQcm9wcyA9IGZ1bmN0aW9uIChyYXdQcm9wcykgew0KICAgICAgICAkLmV4dGVuZCh0aGlzLm1pc2NQcm9wcywgcmF3UHJvcHMpOw0KICAgIH07DQogICAgRXZlbnREZWYudXVpZCA9IDA7DQogICAgRXZlbnREZWYuZGVmaW5lU3RhbmRhcmRQcm9wcyA9IFBhcnNhYmxlTW9kZWxNaXhpbl8xLmRlZmF1bHQuZGVmaW5lU3RhbmRhcmRQcm9wczsNCiAgICBFdmVudERlZi5jb3B5VmVyYmF0aW1TdGFuZGFyZFByb3BzID0gUGFyc2FibGVNb2RlbE1peGluXzEuZGVmYXVsdC5jb3B5VmVyYmF0aW1TdGFuZGFyZFByb3BzOw0KICAgIHJldHVybiBFdmVudERlZjsNCn0oKSk7DQpleHBvcnRzLmRlZmF1bHQgPSBFdmVudERlZjsNClBhcnNhYmxlTW9kZWxNaXhpbl8xLmRlZmF1bHQubWl4SW50byhFdmVudERlZik7DQpFdmVudERlZi5kZWZpbmVTdGFuZGFyZFByb3BzKHsNCiAgICAvLyBub3QgYXV0b21hdGljYWxseSBhc3NpZ25lZCAoYGZhbHNlYCkNCiAgICBfaWQ6IGZhbHNlLA0KICAgIGlkOiBmYWxzZSwNCiAgICBjbGFzc05hbWU6IGZhbHNlLA0KICAgIHNvdXJjZTogZmFsc2UsDQogICAgLy8gYXV0b21hdGljYWxseSBhc3NpZ25lZCAoYHRydWVgKQ0KICAgIHRpdGxlOiB0cnVlLA0KICAgIHVybDogdHJ1ZSwNCiAgICByZW5kZXJpbmc6IHRydWUsDQogICAgY29uc3RyYWludDogdHJ1ZSwNCiAgICBvdmVybGFwOiB0cnVlLA0KICAgIGVkaXRhYmxlOiB0cnVlLA0KICAgIHN0YXJ0RWRpdGFibGU6IHRydWUsDQogICAgZHVyYXRpb25FZGl0YWJsZTogdHJ1ZSwNCiAgICBjb2xvcjogdHJ1ZSwNCiAgICBiYWNrZ3JvdW5kQ29sb3I6IHRydWUsDQogICAgYm9yZGVyQ29sb3I6IHRydWUsDQogICAgdGV4dENvbG9yOiB0cnVlDQp9KTsNCgoKLyoqKi8gfSksCi8qIDM0ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgRXZlbnRSYW5nZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMTEpOw0KdmFyIEV2ZW50Rm9vdHByaW50XzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM1KTsNCnZhciBDb21wb25lbnRGb290cHJpbnRfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTIpOw0KZnVuY3Rpb24gZXZlbnREZWZzVG9FdmVudEluc3RhbmNlcyhldmVudERlZnMsIHVuem9uZWRSYW5nZSkgew0KICAgIHZhciBldmVudEluc3RhbmNlcyA9IFtdOw0KICAgIHZhciBpOw0KICAgIGZvciAoaSA9IDA7IGkgPCBldmVudERlZnMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgZXZlbnRJbnN0YW5jZXMucHVzaC5hcHBseShldmVudEluc3RhbmNlcywgLy8gYXBwZW5kDQogICAgICAgIGV2ZW50RGVmc1tpXS5idWlsZEluc3RhbmNlcyh1bnpvbmVkUmFuZ2UpKTsNCiAgICB9DQogICAgcmV0dXJuIGV2ZW50SW5zdGFuY2VzOw0KfQ0KZXhwb3J0cy5ldmVudERlZnNUb0V2ZW50SW5zdGFuY2VzID0gZXZlbnREZWZzVG9FdmVudEluc3RhbmNlczsNCmZ1bmN0aW9uIGV2ZW50SW5zdGFuY2VUb0V2ZW50UmFuZ2UoZXZlbnRJbnN0YW5jZSkgew0KICAgIHJldHVybiBuZXcgRXZlbnRSYW5nZV8xLmRlZmF1bHQoZXZlbnRJbnN0YW5jZS5kYXRlUHJvZmlsZS51bnpvbmVkUmFuZ2UsIGV2ZW50SW5zdGFuY2UuZGVmLCBldmVudEluc3RhbmNlKTsNCn0NCmV4cG9ydHMuZXZlbnRJbnN0YW5jZVRvRXZlbnRSYW5nZSA9IGV2ZW50SW5zdGFuY2VUb0V2ZW50UmFuZ2U7DQpmdW5jdGlvbiBldmVudFJhbmdlVG9FdmVudEZvb3RwcmludChldmVudFJhbmdlKSB7DQogICAgcmV0dXJuIG5ldyBFdmVudEZvb3RwcmludF8xLmRlZmF1bHQobmV3IENvbXBvbmVudEZvb3RwcmludF8xLmRlZmF1bHQoZXZlbnRSYW5nZS51bnpvbmVkUmFuZ2UsIGV2ZW50UmFuZ2UuZXZlbnREZWYuaXNBbGxEYXkoKSksIGV2ZW50UmFuZ2UuZXZlbnREZWYsIGV2ZW50UmFuZ2UuZXZlbnRJbnN0YW5jZSAvLyBtaWdodCBub3QgZXhpc3QNCiAgICApOw0KfQ0KZXhwb3J0cy5ldmVudFJhbmdlVG9FdmVudEZvb3RwcmludCA9IGV2ZW50UmFuZ2VUb0V2ZW50Rm9vdHByaW50Ow0KZnVuY3Rpb24gZXZlbnRJbnN0YW5jZVRvVW56b25lZFJhbmdlKGV2ZW50SW5zdGFuY2UpIHsNCiAgICByZXR1cm4gZXZlbnRJbnN0YW5jZS5kYXRlUHJvZmlsZS51bnpvbmVkUmFuZ2U7DQp9DQpleHBvcnRzLmV2ZW50SW5zdGFuY2VUb1Vuem9uZWRSYW5nZSA9IGV2ZW50SW5zdGFuY2VUb1Vuem9uZWRSYW5nZTsNCmZ1bmN0aW9uIGV2ZW50Rm9vdHByaW50VG9Db21wb25lbnRGb290cHJpbnQoZXZlbnRGb290cHJpbnQpIHsNCiAgICByZXR1cm4gZXZlbnRGb290cHJpbnQuY29tcG9uZW50Rm9vdHByaW50Ow0KfQ0KZXhwb3J0cy5ldmVudEZvb3RwcmludFRvQ29tcG9uZW50Rm9vdHByaW50ID0gZXZlbnRGb290cHJpbnRUb0NvbXBvbmVudEZvb3RwcmludDsNCgoKLyoqKi8gfSksCi8qIDM1ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMpIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgRXZlbnRGb290cHJpbnQgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7DQogICAgZnVuY3Rpb24gRXZlbnRGb290cHJpbnQoY29tcG9uZW50Rm9vdHByaW50LCBldmVudERlZiwgZXZlbnRJbnN0YW5jZSkgew0KICAgICAgICB0aGlzLmNvbXBvbmVudEZvb3RwcmludCA9IGNvbXBvbmVudEZvb3RwcmludDsNCiAgICAgICAgdGhpcy5ldmVudERlZiA9IGV2ZW50RGVmOw0KICAgICAgICBpZiAoZXZlbnRJbnN0YW5jZSkgew0KICAgICAgICAgICAgdGhpcy5ldmVudEluc3RhbmNlID0gZXZlbnRJbnN0YW5jZTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICBFdmVudEZvb3RwcmludC5wcm90b3R5cGUuZ2V0RXZlbnRMZWdhY3kgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHJldHVybiAodGhpcy5ldmVudEluc3RhbmNlIHx8IHRoaXMuZXZlbnREZWYpLnRvTGVnYWN5KCk7DQogICAgfTsNCiAgICByZXR1cm4gRXZlbnRGb290cHJpbnQ7DQp9KCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gRXZlbnRGb290cHJpbnQ7DQoKCi8qKiovIH0pLAovKiAzNiAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgRXZlbnREYXRlUHJvZmlsZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxOCk7DQp2YXIgRXZlbnREZWZfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMzMpOw0KdmFyIEV2ZW50RGVmRGF0ZU11dGF0aW9uXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUwKTsNCnZhciBTaW5nbGVFdmVudERlZl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMyk7DQp2YXIgRXZlbnREZWZNdXRhdGlvbiA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsNCiAgICBmdW5jdGlvbiBFdmVudERlZk11dGF0aW9uKCkgew0KICAgIH0NCiAgICBFdmVudERlZk11dGF0aW9uLmNyZWF0ZUZyb21SYXdQcm9wcyA9IGZ1bmN0aW9uIChldmVudEluc3RhbmNlLCByYXdQcm9wcywgbGFyZ2VVbml0KSB7DQogICAgICAgIHZhciBldmVudERlZiA9IGV2ZW50SW5zdGFuY2UuZGVmOw0KICAgICAgICB2YXIgZGF0ZVByb3BzID0ge307DQogICAgICAgIHZhciBzdGFuZGFyZFByb3BzID0ge307DQogICAgICAgIHZhciBtaXNjUHJvcHMgPSB7fTsNCiAgICAgICAgdmFyIHZlcmJhdGltU3RhbmRhcmRQcm9wcyA9IHt9Ow0KICAgICAgICB2YXIgZXZlbnREZWZJZCA9IG51bGw7DQogICAgICAgIHZhciBjbGFzc05hbWUgPSBudWxsOw0KICAgICAgICB2YXIgcHJvcE5hbWU7DQogICAgICAgIHZhciBkYXRlUHJvZmlsZTsNCiAgICAgICAgdmFyIGRhdGVNdXRhdGlvbjsNCiAgICAgICAgdmFyIGRlZk11dGF0aW9uOw0KICAgICAgICBmb3IgKHByb3BOYW1lIGluIHJhd1Byb3BzKSB7DQogICAgICAgICAgICBpZiAoRXZlbnREYXRlUHJvZmlsZV8xLmRlZmF1bHQuaXNTdGFuZGFyZFByb3AocHJvcE5hbWUpKSB7DQogICAgICAgICAgICAgICAgZGF0ZVByb3BzW3Byb3BOYW1lXSA9IHJhd1Byb3BzW3Byb3BOYW1lXTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2UgaWYgKGV2ZW50RGVmLmlzU3RhbmRhcmRQcm9wKHByb3BOYW1lKSkgew0KICAgICAgICAgICAgICAgIHN0YW5kYXJkUHJvcHNbcHJvcE5hbWVdID0gcmF3UHJvcHNbcHJvcE5hbWVdOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAoZXZlbnREZWYubWlzY1Byb3BzW3Byb3BOYW1lXSAhPT0gcmF3UHJvcHNbcHJvcE5hbWVdKSB7DQogICAgICAgICAgICAgICAgbWlzY1Byb3BzW3Byb3BOYW1lXSA9IHJhd1Byb3BzW3Byb3BOYW1lXTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBkYXRlUHJvZmlsZSA9IEV2ZW50RGF0ZVByb2ZpbGVfMS5kZWZhdWx0LnBhcnNlKGRhdGVQcm9wcywgZXZlbnREZWYuc291cmNlKTsNCiAgICAgICAgaWYgKGRhdGVQcm9maWxlKSB7DQogICAgICAgICAgICBkYXRlTXV0YXRpb24gPSBFdmVudERlZkRhdGVNdXRhdGlvbl8xLmRlZmF1bHQuY3JlYXRlRnJvbURpZmYoZXZlbnRJbnN0YW5jZS5kYXRlUHJvZmlsZSwgZGF0ZVByb2ZpbGUsIGxhcmdlVW5pdCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHN0YW5kYXJkUHJvcHMuaWQgIT09IGV2ZW50RGVmLmlkKSB7DQogICAgICAgICAgICBldmVudERlZklkID0gc3RhbmRhcmRQcm9wcy5pZDsgLy8gb25seSBhcHBseSBpZiB0aGVyZSdzIGEgY2hhbmdlDQogICAgICAgIH0NCiAgICAgICAgaWYgKCF1dGlsXzEuaXNBcnJheXNFcXVhbChzdGFuZGFyZFByb3BzLmNsYXNzTmFtZSwgZXZlbnREZWYuY2xhc3NOYW1lKSkgew0KICAgICAgICAgICAgY2xhc3NOYW1lID0gc3RhbmRhcmRQcm9wcy5jbGFzc05hbWU7IC8vIG9ubHkgYXBwbHkgaWYgdGhlcmUncyBhIGNoYW5nZQ0KICAgICAgICB9DQogICAgICAgIEV2ZW50RGVmXzEuZGVmYXVsdC5jb3B5VmVyYmF0aW1TdGFuZGFyZFByb3BzKHN0YW5kYXJkUHJvcHMsIC8vIHNyYw0KICAgICAgICB2ZXJiYXRpbVN0YW5kYXJkUHJvcHMgLy8gZGVzdA0KICAgICAgICApOw0KICAgICAgICBkZWZNdXRhdGlvbiA9IG5ldyBFdmVudERlZk11dGF0aW9uKCk7DQogICAgICAgIGRlZk11dGF0aW9uLmV2ZW50RGVmSWQgPSBldmVudERlZklkOw0KICAgICAgICBkZWZNdXRhdGlvbi5jbGFzc05hbWUgPSBjbGFzc05hbWU7DQogICAgICAgIGRlZk11dGF0aW9uLnZlcmJhdGltU3RhbmRhcmRQcm9wcyA9IHZlcmJhdGltU3RhbmRhcmRQcm9wczsNCiAgICAgICAgZGVmTXV0YXRpb24ubWlzY1Byb3BzID0gbWlzY1Byb3BzOw0KICAgICAgICBpZiAoZGF0ZU11dGF0aW9uKSB7DQogICAgICAgICAgICBkZWZNdXRhdGlvbi5kYXRlTXV0YXRpb24gPSBkYXRlTXV0YXRpb247DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGRlZk11dGF0aW9uOw0KICAgIH07DQogICAgLyoNCiAgICBldmVudERlZiBhc3N1bWVkIHRvIGJlIGEgU2luZ2xlRXZlbnREZWYuDQogICAgcmV0dXJucyBhbiB1bmRvIGZ1bmN0aW9uLg0KICAgICovDQogICAgRXZlbnREZWZNdXRhdGlvbi5wcm90b3R5cGUubXV0YXRlU2luZ2xlID0gZnVuY3Rpb24gKGV2ZW50RGVmKSB7DQogICAgICAgIHZhciBvcmlnRGF0ZVByb2ZpbGU7DQogICAgICAgIGlmICh0aGlzLmRhdGVNdXRhdGlvbikgew0KICAgICAgICAgICAgb3JpZ0RhdGVQcm9maWxlID0gZXZlbnREZWYuZGF0ZVByb2ZpbGU7DQogICAgICAgICAgICBldmVudERlZi5kYXRlUHJvZmlsZSA9IHRoaXMuZGF0ZU11dGF0aW9uLmJ1aWxkTmV3RGF0ZVByb2ZpbGUob3JpZ0RhdGVQcm9maWxlLCBldmVudERlZi5zb3VyY2UuY2FsZW5kYXIpOw0KICAgICAgICB9DQogICAgICAgIC8vIGNhbid0IHVuZG8NCiAgICAgICAgLy8gVE9ETzogbW9yZSBEUlkgd2l0aCBFdmVudERlZjo6YXBwbHlNYW51YWxTdGFuZGFyZFByb3BzDQogICAgICAgIGlmICh0aGlzLmV2ZW50RGVmSWQgIT0gbnVsbCkgew0KICAgICAgICAgICAgZXZlbnREZWYuaWQgPSBFdmVudERlZl8xLmRlZmF1bHQubm9ybWFsaXplSWQoKGV2ZW50RGVmLnJhd0lkID0gdGhpcy5ldmVudERlZklkKSk7DQogICAgICAgIH0NCiAgICAgICAgLy8gY2FuJ3QgdW5kbw0KICAgICAgICAvLyBUT0RPOiBtb3JlIERSWSB3aXRoIEV2ZW50RGVmOjphcHBseU1hbnVhbFN0YW5kYXJkUHJvcHMNCiAgICAgICAgaWYgKHRoaXMuY2xhc3NOYW1lKSB7DQogICAgICAgICAgICBldmVudERlZi5jbGFzc05hbWUgPSB0aGlzLmNsYXNzTmFtZTsNCiAgICAgICAgfQ0KICAgICAgICAvLyBjYW4ndCB1bmRvDQogICAgICAgIGlmICh0aGlzLnZlcmJhdGltU3RhbmRhcmRQcm9wcykgew0KICAgICAgICAgICAgU2luZ2xlRXZlbnREZWZfMS5kZWZhdWx0LmNvcHlWZXJiYXRpbVN0YW5kYXJkUHJvcHModGhpcy52ZXJiYXRpbVN0YW5kYXJkUHJvcHMsIC8vIHNyYw0KICAgICAgICAgICAgZXZlbnREZWYgLy8gZGVzdA0KICAgICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgICAgICAvLyBjYW4ndCB1bmRvDQogICAgICAgIGlmICh0aGlzLm1pc2NQcm9wcykgew0KICAgICAgICAgICAgZXZlbnREZWYuYXBwbHlNaXNjUHJvcHModGhpcy5taXNjUHJvcHMpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvcmlnRGF0ZVByb2ZpbGUpIHsNCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgZXZlbnREZWYuZGF0ZVByb2ZpbGUgPSBvcmlnRGF0ZVByb2ZpbGU7DQogICAgICAgICAgICB9Ow0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsgfTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgRXZlbnREZWZNdXRhdGlvbi5wcm90b3R5cGUuc2V0RGF0ZU11dGF0aW9uID0gZnVuY3Rpb24gKGRhdGVNdXRhdGlvbikgew0KICAgICAgICBpZiAoZGF0ZU11dGF0aW9uICYmICFkYXRlTXV0YXRpb24uaXNFbXB0eSgpKSB7DQogICAgICAgICAgICB0aGlzLmRhdGVNdXRhdGlvbiA9IGRhdGVNdXRhdGlvbjsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHRoaXMuZGF0ZU11dGF0aW9uID0gbnVsbDsNCiAgICAgICAgfQ0KICAgIH07DQogICAgRXZlbnREZWZNdXRhdGlvbi5wcm90b3R5cGUuaXNFbXB0eSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuICF0aGlzLmRhdGVNdXRhdGlvbjsNCiAgICB9Ow0KICAgIHJldHVybiBFdmVudERlZk11dGF0aW9uOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IEV2ZW50RGVmTXV0YXRpb247DQoKCi8qKiovIH0pLAovKiAzNyAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KZXhwb3J0cy5kZWZhdWx0ID0gew0KICAgIHNvdXJjZUNsYXNzZXM6IFtdLA0KICAgIHJlZ2lzdGVyQ2xhc3M6IGZ1bmN0aW9uIChFdmVudFNvdXJjZUNsYXNzKSB7DQogICAgICAgIHRoaXMuc291cmNlQ2xhc3Nlcy51bnNoaWZ0KEV2ZW50U291cmNlQ2xhc3MpOyAvLyBnaXZlIGhpZ2hlc3QgcHJpb3JpdHkNCiAgICB9LA0KICAgIHBhcnNlOiBmdW5jdGlvbiAocmF3SW5wdXQsIGNhbGVuZGFyKSB7DQogICAgICAgIHZhciBzb3VyY2VDbGFzc2VzID0gdGhpcy5zb3VyY2VDbGFzc2VzOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgdmFyIGV2ZW50U291cmNlOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc291cmNlQ2xhc3Nlcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgZXZlbnRTb3VyY2UgPSBzb3VyY2VDbGFzc2VzW2ldLnBhcnNlKHJhd0lucHV0LCBjYWxlbmRhcik7DQogICAgICAgICAgICBpZiAoZXZlbnRTb3VyY2UpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnRTb3VyY2U7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQp9Ow0KCgovKioqLyB9KSwKLyogMzggKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCnZhciBUaGVtZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsNCiAgICBmdW5jdGlvbiBUaGVtZShvcHRpb25zTWFuYWdlcikgew0KICAgICAgICB0aGlzLm9wdGlvbnNNYW5hZ2VyID0gb3B0aW9uc01hbmFnZXI7DQogICAgICAgIHRoaXMucHJvY2Vzc0ljb25PdmVycmlkZSgpOw0KICAgIH0NCiAgICBUaGVtZS5wcm90b3R5cGUucHJvY2Vzc0ljb25PdmVycmlkZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMuaWNvbk92ZXJyaWRlT3B0aW9uKSB7DQogICAgICAgICAgICB0aGlzLnNldEljb25PdmVycmlkZSh0aGlzLm9wdGlvbnNNYW5hZ2VyLmdldCh0aGlzLmljb25PdmVycmlkZU9wdGlvbikpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBUaGVtZS5wcm90b3R5cGUuc2V0SWNvbk92ZXJyaWRlID0gZnVuY3Rpb24gKGljb25PdmVycmlkZUhhc2gpIHsNCiAgICAgICAgdmFyIGljb25DbGFzc2VzQ29weTsNCiAgICAgICAgdmFyIGJ1dHRvbk5hbWU7DQogICAgICAgIGlmICgkLmlzUGxhaW5PYmplY3QoaWNvbk92ZXJyaWRlSGFzaCkpIHsNCiAgICAgICAgICAgIGljb25DbGFzc2VzQ29weSA9ICQuZXh0ZW5kKHt9LCB0aGlzLmljb25DbGFzc2VzKTsNCiAgICAgICAgICAgIGZvciAoYnV0dG9uTmFtZSBpbiBpY29uT3ZlcnJpZGVIYXNoKSB7DQogICAgICAgICAgICAgICAgaWNvbkNsYXNzZXNDb3B5W2J1dHRvbk5hbWVdID0gdGhpcy5hcHBseUljb25PdmVycmlkZVByZWZpeChpY29uT3ZlcnJpZGVIYXNoW2J1dHRvbk5hbWVdKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMuaWNvbkNsYXNzZXMgPSBpY29uQ2xhc3Nlc0NvcHk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAoaWNvbk92ZXJyaWRlSGFzaCA9PT0gZmFsc2UpIHsNCiAgICAgICAgICAgIHRoaXMuaWNvbkNsYXNzZXMgPSB7fTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgVGhlbWUucHJvdG90eXBlLmFwcGx5SWNvbk92ZXJyaWRlUHJlZml4ID0gZnVuY3Rpb24gKGNsYXNzTmFtZSkgew0KICAgICAgICB2YXIgcHJlZml4ID0gdGhpcy5pY29uT3ZlcnJpZGVQcmVmaXg7DQogICAgICAgIGlmIChwcmVmaXggJiYgY2xhc3NOYW1lLmluZGV4T2YocHJlZml4KSAhPT0gMCkgew0KICAgICAgICAgICAgY2xhc3NOYW1lID0gcHJlZml4ICsgY2xhc3NOYW1lOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBjbGFzc05hbWU7DQogICAgfTsNCiAgICBUaGVtZS5wcm90b3R5cGUuZ2V0Q2xhc3MgPSBmdW5jdGlvbiAoa2V5KSB7DQogICAgICAgIHJldHVybiB0aGlzLmNsYXNzZXNba2V5XSB8fCAnJzsNCiAgICB9Ow0KICAgIFRoZW1lLnByb3RvdHlwZS5nZXRJY29uQ2xhc3MgPSBmdW5jdGlvbiAoYnV0dG9uTmFtZSkgew0KICAgICAgICB2YXIgY2xhc3NOYW1lID0gdGhpcy5pY29uQ2xhc3Nlc1tidXR0b25OYW1lXTsNCiAgICAgICAgaWYgKGNsYXNzTmFtZSkgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmFzZUljb25DbGFzcyArICcgJyArIGNsYXNzTmFtZTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gJyc7DQogICAgfTsNCiAgICBUaGVtZS5wcm90b3R5cGUuZ2V0Q3VzdG9tQnV0dG9uSWNvbkNsYXNzID0gZnVuY3Rpb24gKGN1c3RvbUJ1dHRvblByb3BzKSB7DQogICAgICAgIHZhciBjbGFzc05hbWU7DQogICAgICAgIGlmICh0aGlzLmljb25PdmVycmlkZUN1c3RvbUJ1dHRvbk9wdGlvbikgew0KICAgICAgICAgICAgY2xhc3NOYW1lID0gY3VzdG9tQnV0dG9uUHJvcHNbdGhpcy5pY29uT3ZlcnJpZGVDdXN0b21CdXR0b25PcHRpb25dOw0KICAgICAgICAgICAgaWYgKGNsYXNzTmFtZSkgew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmJhc2VJY29uQ2xhc3MgKyAnICcgKyB0aGlzLmFwcGx5SWNvbk92ZXJyaWRlUHJlZml4KGNsYXNzTmFtZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuICcnOw0KICAgIH07DQogICAgcmV0dXJuIFRoZW1lOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IFRoZW1lOw0KVGhlbWUucHJvdG90eXBlLmNsYXNzZXMgPSB7fTsNClRoZW1lLnByb3RvdHlwZS5pY29uQ2xhc3NlcyA9IHt9Ow0KVGhlbWUucHJvdG90eXBlLmJhc2VJY29uQ2xhc3MgPSAnJzsNClRoZW1lLnByb3RvdHlwZS5pY29uT3ZlcnJpZGVQcmVmaXggPSAnJzsNCgoKLyoqKi8gfSksCi8qIDM5ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdHNsaWJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCnZhciBDbGFzc18xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzMik7DQovKg0KRW1ib2RpZXMgYSBkaXYgdGhhdCBoYXMgcG90ZW50aWFsIHNjcm9sbGJhcnMNCiovDQp2YXIgU2Nyb2xsZXIgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoU2Nyb2xsZXIsIF9zdXBlcik7DQogICAgZnVuY3Rpb24gU2Nyb2xsZXIob3B0aW9ucykgew0KICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzOw0KICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsNCiAgICAgICAgX3RoaXMub3ZlcmZsb3dYID0gb3B0aW9ucy5vdmVyZmxvd1ggfHwgb3B0aW9ucy5vdmVyZmxvdyB8fCAnYXV0byc7DQogICAgICAgIF90aGlzLm92ZXJmbG93WSA9IG9wdGlvbnMub3ZlcmZsb3dZIHx8IG9wdGlvbnMub3ZlcmZsb3cgfHwgJ2F1dG8nOw0KICAgICAgICByZXR1cm4gX3RoaXM7DQogICAgfQ0KICAgIFNjcm9sbGVyLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMuZWwgPSB0aGlzLnJlbmRlckVsKCk7DQogICAgICAgIHRoaXMuYXBwbHlPdmVyZmxvdygpOw0KICAgIH07DQogICAgU2Nyb2xsZXIucHJvdG90eXBlLnJlbmRlckVsID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gKHRoaXMuc2Nyb2xsRWwgPSAkKCc8ZGl2IGNsYXNzPSJmYy1zY3JvbGxlciI+PC9kaXY+JykpOw0KICAgIH07DQogICAgLy8gc2V0cyB0byBuYXR1cmFsIGhlaWdodCwgdW5sb2NrcyBvdmVyZmxvdw0KICAgIFNjcm9sbGVyLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5zZXRIZWlnaHQoJ2F1dG8nKTsNCiAgICAgICAgdGhpcy5hcHBseU92ZXJmbG93KCk7DQogICAgfTsNCiAgICBTY3JvbGxlci5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5lbC5yZW1vdmUoKTsNCiAgICB9Ow0KICAgIC8vIE92ZXJmbG93DQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICBTY3JvbGxlci5wcm90b3R5cGUuYXBwbHlPdmVyZmxvdyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5zY3JvbGxFbC5jc3Moew0KICAgICAgICAgICAgJ292ZXJmbG93LXgnOiB0aGlzLm92ZXJmbG93WCwNCiAgICAgICAgICAgICdvdmVyZmxvdy15JzogdGhpcy5vdmVyZmxvd1kNCiAgICAgICAgfSk7DQogICAgfTsNCiAgICAvLyBDYXVzZXMgYW55ICdhdXRvJyBvdmVyZmxvdyB2YWx1ZXMgdG8gcmVzb2x2ZXMgdG8gJ3Njcm9sbCcgb3IgJ2hpZGRlbicuDQogICAgLy8gVXNlZnVsIGZvciBwcmVzZXJ2aW5nIHNjcm9sbGJhciB3aWR0aHMgcmVnYXJkbGVzcyBvZiBmdXR1cmUgcmVzaXplcy4NCiAgICAvLyBDYW4gcGFzcyBpbiBzY3JvbGxiYXJXaWR0aHMgZm9yIG9wdGltaXphdGlvbi4NCiAgICBTY3JvbGxlci5wcm90b3R5cGUubG9ja092ZXJmbG93ID0gZnVuY3Rpb24gKHNjcm9sbGJhcldpZHRocykgew0KICAgICAgICB2YXIgb3ZlcmZsb3dYID0gdGhpcy5vdmVyZmxvd1g7DQogICAgICAgIHZhciBvdmVyZmxvd1kgPSB0aGlzLm92ZXJmbG93WTsNCiAgICAgICAgc2Nyb2xsYmFyV2lkdGhzID0gc2Nyb2xsYmFyV2lkdGhzIHx8IHRoaXMuZ2V0U2Nyb2xsYmFyV2lkdGhzKCk7DQogICAgICAgIGlmIChvdmVyZmxvd1ggPT09ICdhdXRvJykgew0KICAgICAgICAgICAgb3ZlcmZsb3dYID0gKHNjcm9sbGJhcldpZHRocy50b3AgfHwgc2Nyb2xsYmFyV2lkdGhzLmJvdHRvbSB8fCAvLyBob3Jpem9udGFsIHNjcm9sbGJhcnM/DQogICAgICAgICAgICAgICAgLy8gT1Igc2Nyb2xsaW5nIHBhbmUgd2l0aCBtYXNzbGVzcyBzY3JvbGxiYXJzPw0KICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsRWxbMF0uc2Nyb2xsV2lkdGggLSAxID4gdGhpcy5zY3JvbGxFbFswXS5jbGllbnRXaWR0aCkgPyAnc2Nyb2xsJyA6ICdoaWRkZW4nOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdmVyZmxvd1kgPT09ICdhdXRvJykgew0KICAgICAgICAgICAgb3ZlcmZsb3dZID0gKHNjcm9sbGJhcldpZHRocy5sZWZ0IHx8IHNjcm9sbGJhcldpZHRocy5yaWdodCB8fCAvLyB2ZXJ0aWNhbCBzY3JvbGxiYXJzPw0KICAgICAgICAgICAgICAgIC8vIE9SIHNjcm9sbGluZyBwYW5lIHdpdGggbWFzc2xlc3Mgc2Nyb2xsYmFycz8NCiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbEVsWzBdLnNjcm9sbEhlaWdodCAtIDEgPiB0aGlzLnNjcm9sbEVsWzBdLmNsaWVudEhlaWdodCkgPyAnc2Nyb2xsJyA6ICdoaWRkZW4nOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuc2Nyb2xsRWwuY3NzKHsgJ292ZXJmbG93LXgnOiBvdmVyZmxvd1gsICdvdmVyZmxvdy15Jzogb3ZlcmZsb3dZIH0pOw0KICAgIH07DQogICAgLy8gR2V0dGVycyAvIFNldHRlcnMNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIFNjcm9sbGVyLnByb3RvdHlwZS5zZXRIZWlnaHQgPSBmdW5jdGlvbiAoaGVpZ2h0KSB7DQogICAgICAgIHRoaXMuc2Nyb2xsRWwuaGVpZ2h0KGhlaWdodCk7DQogICAgfTsNCiAgICBTY3JvbGxlci5wcm90b3R5cGUuZ2V0U2Nyb2xsVG9wID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxFbC5zY3JvbGxUb3AoKTsNCiAgICB9Ow0KICAgIFNjcm9sbGVyLnByb3RvdHlwZS5zZXRTY3JvbGxUb3AgPSBmdW5jdGlvbiAodG9wKSB7DQogICAgICAgIHRoaXMuc2Nyb2xsRWwuc2Nyb2xsVG9wKHRvcCk7DQogICAgfTsNCiAgICBTY3JvbGxlci5wcm90b3R5cGUuZ2V0Q2xpZW50V2lkdGggPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHJldHVybiB0aGlzLnNjcm9sbEVsWzBdLmNsaWVudFdpZHRoOw0KICAgIH07DQogICAgU2Nyb2xsZXIucHJvdG90eXBlLmdldENsaWVudEhlaWdodCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsRWxbMF0uY2xpZW50SGVpZ2h0Ow0KICAgIH07DQogICAgU2Nyb2xsZXIucHJvdG90eXBlLmdldFNjcm9sbGJhcldpZHRocyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHV0aWxfMS5nZXRTY3JvbGxiYXJXaWR0aHModGhpcy5zY3JvbGxFbCk7DQogICAgfTsNCiAgICByZXR1cm4gU2Nyb2xsZXI7DQp9KENsYXNzXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gU2Nyb2xsZXI7DQoKCi8qKiovIH0pLAovKiA0MCAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIHRzbGliXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIpOw0KdmFyICQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgRGF0ZUNvbXBvbmVudF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMTkpOw0KdmFyIEdsb2JhbEVtaXR0ZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTUpOw0KdmFyIEludGVyYWN0aXZlRGF0ZUNvbXBvbmVudCA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHsNCiAgICB0c2xpYl8xLl9fZXh0ZW5kcyhJbnRlcmFjdGl2ZURhdGVDb21wb25lbnQsIF9zdXBlcik7DQogICAgZnVuY3Rpb24gSW50ZXJhY3RpdmVEYXRlQ29tcG9uZW50KF92aWV3LCBfb3B0aW9ucykgew0KICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzLCBfdmlldywgX29wdGlvbnMpIHx8IHRoaXM7DQogICAgICAgIC8vIHNlbGYtY29uZmlnLCBvdmVycmlkYWJsZSBieSBzdWJjbGFzc2VzDQogICAgICAgIF90aGlzLnNlZ1NlbGVjdG9yID0gJy5mYy1ldmVudC1jb250YWluZXIgPiAqJzsgLy8gd2hhdCBjb25zdGl0dXRlcyBhbiBldmVudCBlbGVtZW50Pw0KICAgICAgICBpZiAoX3RoaXMuZGF0ZVNlbGVjdGluZ0NsYXNzKSB7DQogICAgICAgICAgICBfdGhpcy5kYXRlQ2xpY2tpbmcgPSBuZXcgX3RoaXMuZGF0ZUNsaWNraW5nQ2xhc3MoX3RoaXMpOw0KICAgICAgICB9DQogICAgICAgIGlmIChfdGhpcy5kYXRlU2VsZWN0aW5nQ2xhc3MpIHsNCiAgICAgICAgICAgIF90aGlzLmRhdGVTZWxlY3RpbmcgPSBuZXcgX3RoaXMuZGF0ZVNlbGVjdGluZ0NsYXNzKF90aGlzKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoX3RoaXMuZXZlbnRQb2ludGluZ0NsYXNzKSB7DQogICAgICAgICAgICBfdGhpcy5ldmVudFBvaW50aW5nID0gbmV3IF90aGlzLmV2ZW50UG9pbnRpbmdDbGFzcyhfdGhpcyk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKF90aGlzLmV2ZW50RHJhZ2dpbmdDbGFzcyAmJiBfdGhpcy5ldmVudFBvaW50aW5nKSB7DQogICAgICAgICAgICBfdGhpcy5ldmVudERyYWdnaW5nID0gbmV3IF90aGlzLmV2ZW50RHJhZ2dpbmdDbGFzcyhfdGhpcywgX3RoaXMuZXZlbnRQb2ludGluZyk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKF90aGlzLmV2ZW50UmVzaXppbmdDbGFzcyAmJiBfdGhpcy5ldmVudFBvaW50aW5nKSB7DQogICAgICAgICAgICBfdGhpcy5ldmVudFJlc2l6aW5nID0gbmV3IF90aGlzLmV2ZW50UmVzaXppbmdDbGFzcyhfdGhpcywgX3RoaXMuZXZlbnRQb2ludGluZyk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKF90aGlzLmV4dGVybmFsRHJvcHBpbmdDbGFzcykgew0KICAgICAgICAgICAgX3RoaXMuZXh0ZXJuYWxEcm9wcGluZyA9IG5ldyBfdGhpcy5leHRlcm5hbERyb3BwaW5nQ2xhc3MoX3RoaXMpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBfdGhpczsNCiAgICB9DQogICAgLy8gU2V0cyB0aGUgY29udGFpbmVyIGVsZW1lbnQgdGhhdCB0aGUgdmlldyBzaG91bGQgcmVuZGVyIGluc2lkZSBvZiwgZG9lcyBnbG9iYWwgRE9NLXJlbGF0ZWQgaW5pdGlhbGl6YXRpb25zLA0KICAgIC8vIGFuZCByZW5kZXJzIGFsbCB0aGUgbm9uLWRhdGUtcmVsYXRlZCBjb250ZW50IGluc2lkZS4NCiAgICBJbnRlcmFjdGl2ZURhdGVDb21wb25lbnQucHJvdG90eXBlLnNldEVsZW1lbnQgPSBmdW5jdGlvbiAoZWwpIHsNCiAgICAgICAgX3N1cGVyLnByb3RvdHlwZS5zZXRFbGVtZW50LmNhbGwodGhpcywgZWwpOw0KICAgICAgICBpZiAodGhpcy5kYXRlQ2xpY2tpbmcpIHsNCiAgICAgICAgICAgIHRoaXMuZGF0ZUNsaWNraW5nLmJpbmRUb0VsKGVsKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAodGhpcy5kYXRlU2VsZWN0aW5nKSB7DQogICAgICAgICAgICB0aGlzLmRhdGVTZWxlY3RpbmcuYmluZFRvRWwoZWwpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuYmluZEFsbFNlZ0hhbmRsZXJzVG9FbChlbCk7DQogICAgfTsNCiAgICBJbnRlcmFjdGl2ZURhdGVDb21wb25lbnQucHJvdG90eXBlLnJlbW92ZUVsZW1lbnQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMuZW5kSW50ZXJhY3Rpb25zKCk7DQogICAgICAgIF9zdXBlci5wcm90b3R5cGUucmVtb3ZlRWxlbWVudC5jYWxsKHRoaXMpOw0KICAgIH07DQogICAgSW50ZXJhY3RpdmVEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5leGVjdXRlRXZlbnRVbnJlbmRlciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5lbmRJbnRlcmFjdGlvbnMoKTsNCiAgICAgICAgX3N1cGVyLnByb3RvdHlwZS5leGVjdXRlRXZlbnRVbnJlbmRlci5jYWxsKHRoaXMpOw0KICAgIH07DQogICAgSW50ZXJhY3RpdmVEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5iaW5kR2xvYmFsSGFuZGxlcnMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIF9zdXBlci5wcm90b3R5cGUuYmluZEdsb2JhbEhhbmRsZXJzLmNhbGwodGhpcyk7DQogICAgICAgIGlmICh0aGlzLmV4dGVybmFsRHJvcHBpbmcpIHsNCiAgICAgICAgICAgIHRoaXMuZXh0ZXJuYWxEcm9wcGluZy5iaW5kVG9Eb2N1bWVudCgpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBJbnRlcmFjdGl2ZURhdGVDb21wb25lbnQucHJvdG90eXBlLnVuYmluZEdsb2JhbEhhbmRsZXJzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBfc3VwZXIucHJvdG90eXBlLnVuYmluZEdsb2JhbEhhbmRsZXJzLmNhbGwodGhpcyk7DQogICAgICAgIGlmICh0aGlzLmV4dGVybmFsRHJvcHBpbmcpIHsNCiAgICAgICAgICAgIHRoaXMuZXh0ZXJuYWxEcm9wcGluZy51bmJpbmRGcm9tRG9jdW1lbnQoKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgSW50ZXJhY3RpdmVEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5iaW5kRGF0ZUhhbmRsZXJUb0VsID0gZnVuY3Rpb24gKGVsLCBuYW1lLCBoYW5kbGVyKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIC8vIGF0dGFjaCBhIGhhbmRsZXIgdG8gdGhlIGdyaWQncyByb290IGVsZW1lbnQuDQogICAgICAgIC8vIGpRdWVyeSB3aWxsIHRha2UgY2FyZSBvZiB1bnJlZ2lzdGVyaW5nIHRoZW0gd2hlbiByZW1vdmVFbGVtZW50IGdldHMgY2FsbGVkLg0KICAgICAgICB0aGlzLmVsLm9uKG5hbWUsIGZ1bmN0aW9uIChldikgew0KICAgICAgICAgICAgaWYgKCEkKGV2LnRhcmdldCkuaXMoX3RoaXMuc2VnU2VsZWN0b3IgKyAnOm5vdCguZmMtaGVscGVyKSwnICsgLy8gZGlyZWN0bHkgb24gYW4gZXZlbnQgZWxlbWVudA0KICAgICAgICAgICAgICAgIF90aGlzLnNlZ1NlbGVjdG9yICsgJzpub3QoLmZjLWhlbHBlcikgKiwnICsgLy8gd2l0aGluIGFuIGV2ZW50IGVsZW1lbnQNCiAgICAgICAgICAgICAgICAnLmZjLW1vcmUsJyArIC8vIGEgIm1vcmUuLiIgbGluaw0KICAgICAgICAgICAgICAgICdhW2RhdGEtZ290b10nIC8vIGEgY2xpY2thYmxlIG5hdiBsaW5rDQogICAgICAgICAgICApKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZXIuY2FsbChfdGhpcywgZXYpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIEludGVyYWN0aXZlRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuYmluZEFsbFNlZ0hhbmRsZXJzVG9FbCA9IGZ1bmN0aW9uIChlbCkgew0KICAgICAgICBbDQogICAgICAgICAgICB0aGlzLmV2ZW50UG9pbnRpbmcsDQogICAgICAgICAgICB0aGlzLmV2ZW50RHJhZ2dpbmcsDQogICAgICAgICAgICB0aGlzLmV2ZW50UmVzaXppbmcNCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudEludGVyYWN0aW9uKSB7DQogICAgICAgICAgICBpZiAoZXZlbnRJbnRlcmFjdGlvbikgew0KICAgICAgICAgICAgICAgIGV2ZW50SW50ZXJhY3Rpb24uYmluZFRvRWwoZWwpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIEludGVyYWN0aXZlRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuYmluZFNlZ0hhbmRsZXJUb0VsID0gZnVuY3Rpb24gKGVsLCBuYW1lLCBoYW5kbGVyKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIGVsLm9uKG5hbWUsIHRoaXMuc2VnU2VsZWN0b3IsIGZ1bmN0aW9uIChldikgew0KICAgICAgICAgICAgdmFyIHNlZ0VsID0gJChldi5jdXJyZW50VGFyZ2V0KTsNCiAgICAgICAgICAgIGlmICghc2VnRWwuaXMoJy5mYy1oZWxwZXInKSkgew0KICAgICAgICAgICAgICAgIHZhciBzZWcgPSBzZWdFbC5kYXRhKCdmYy1zZWcnKTsgLy8gZ3JhYiBzZWdtZW50IGRhdGEuIHB1dCB0aGVyZSBieSBWaWV3OjpyZW5kZXJFdmVudHNQYXlsb2FkDQogICAgICAgICAgICAgICAgaWYgKHNlZyAmJiAhX3RoaXMuc2hvdWxkSWdub3JlRXZlbnRQb2ludGluZygpKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGVyLmNhbGwoX3RoaXMsIHNlZywgZXYpOyAvLyBjb250ZXh0IHdpbGwgYmUgdGhlIEdyaWQNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgIH07DQogICAgSW50ZXJhY3RpdmVEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5zaG91bGRJZ25vcmVNb3VzZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgLy8gSEFDSw0KICAgICAgICAvLyBUaGlzIHdpbGwgc3RpbGwgd29yayBldmVuIHRob3VnaCBiaW5kRGF0ZUhhbmRsZXJUb0VsIGRvZXNuJ3QgdXNlIEdsb2JhbEVtaXR0ZXIuDQogICAgICAgIHJldHVybiBHbG9iYWxFbWl0dGVyXzEuZGVmYXVsdC5nZXQoKS5zaG91bGRJZ25vcmVNb3VzZSgpOw0KICAgIH07DQogICAgSW50ZXJhY3RpdmVEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5zaG91bGRJZ25vcmVUb3VjaCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLl9nZXRWaWV3KCk7DQogICAgICAgIC8vIE9uIGlPUyAoYW5kIEFuZHJvaWQ/KSB3aGVuIGEgbmV3IHNlbGVjdGlvbiBpcyBpbml0aWF0ZWQgb3ZlcnRvcCBhbm90aGVyIHNlbGVjdGlvbiwNCiAgICAgICAgLy8gdGhlIHRvdWNoZW5kIG5ldmVyIGZpcmVzIGJlY2F1c2UgdGhlIGVsZW1lbnRzIGdldHMgcmVtb3ZlZCBtaWQtdG91Y2gtaW50ZXJhY3Rpb24gKG15IHRoZW9yeSkuDQogICAgICAgIC8vIEhBQ0s6IHNpbXBseSBkb24ndCBhbGxvdyB0aGlzIHRvIGhhcHBlbi4NCiAgICAgICAgLy8gQUxTTzogcHJldmVudCBzZWxlY3Rpb24gd2hlbiBhbiAqZXZlbnQqIGlzIGFscmVhZHkgcmFpc2VkLg0KICAgICAgICByZXR1cm4gdmlldy5pc1NlbGVjdGVkIHx8IHZpZXcuc2VsZWN0ZWRFdmVudDsNCiAgICB9Ow0KICAgIEludGVyYWN0aXZlRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuc2hvdWxkSWdub3JlRXZlbnRQb2ludGluZyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgLy8gb25seSBjYWxsIHRoZSBoYW5kbGVycyBpZiB0aGVyZSBpcyBub3QgYSBkcmFnL3Jlc2l6ZSBpbiBwcm9ncmVzcw0KICAgICAgICByZXR1cm4gKHRoaXMuZXZlbnREcmFnZ2luZyAmJiB0aGlzLmV2ZW50RHJhZ2dpbmcuaXNEcmFnZ2luZykgfHwNCiAgICAgICAgICAgICh0aGlzLmV2ZW50UmVzaXppbmcgJiYgdGhpcy5ldmVudFJlc2l6aW5nLmlzUmVzaXppbmcpOw0KICAgIH07DQogICAgSW50ZXJhY3RpdmVEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5jYW5TdGFydFNlbGVjdGlvbiA9IGZ1bmN0aW9uIChzZWcsIGV2KSB7DQogICAgICAgIHJldHVybiB1dGlsXzEuZ2V0RXZJc1RvdWNoKGV2KSAmJg0KICAgICAgICAgICAgIXRoaXMuY2FuU3RhcnRSZXNpemUoc2VnLCBldikgJiYNCiAgICAgICAgICAgICh0aGlzLmlzRXZlbnREZWZEcmFnZ2FibGUoc2VnLmZvb3RwcmludC5ldmVudERlZikgfHwNCiAgICAgICAgICAgICAgICB0aGlzLmlzRXZlbnREZWZSZXNpemFibGUoc2VnLmZvb3RwcmludC5ldmVudERlZikpOw0KICAgIH07DQogICAgSW50ZXJhY3RpdmVEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5jYW5TdGFydERyYWcgPSBmdW5jdGlvbiAoc2VnLCBldikgew0KICAgICAgICByZXR1cm4gIXRoaXMuY2FuU3RhcnRSZXNpemUoc2VnLCBldikgJiYNCiAgICAgICAgICAgIHRoaXMuaXNFdmVudERlZkRyYWdnYWJsZShzZWcuZm9vdHByaW50LmV2ZW50RGVmKTsNCiAgICB9Ow0KICAgIEludGVyYWN0aXZlRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuY2FuU3RhcnRSZXNpemUgPSBmdW5jdGlvbiAoc2VnLCBldikgew0KICAgICAgICB2YXIgdmlldyA9IHRoaXMuX2dldFZpZXcoKTsNCiAgICAgICAgdmFyIGV2ZW50RGVmID0gc2VnLmZvb3RwcmludC5ldmVudERlZjsNCiAgICAgICAgcmV0dXJuICghdXRpbF8xLmdldEV2SXNUb3VjaChldikgfHwgdmlldy5pc0V2ZW50RGVmU2VsZWN0ZWQoZXZlbnREZWYpKSAmJg0KICAgICAgICAgICAgdGhpcy5pc0V2ZW50RGVmUmVzaXphYmxlKGV2ZW50RGVmKSAmJg0KICAgICAgICAgICAgJChldi50YXJnZXQpLmlzKCcuZmMtcmVzaXplcicpOw0KICAgIH07DQogICAgLy8gS2lsbHMgYWxsIGluLXByb2dyZXNzIGRyYWdnaW5nLg0KICAgIC8vIFVzZWZ1bCBmb3Igd2hlbiBwdWJsaWMgQVBJIG1ldGhvZHMgdGhhdCByZXN1bHQgaW4gcmUtcmVuZGVyaW5nIGFyZSBpbnZva2VkIGR1cmluZyBhIGRyYWcuDQogICAgLy8gQWxzbyB1c2VmdWwgZm9yIHdoZW4gdG91Y2ggZGV2aWNlcyBtaXNiZWhhdmUgYW5kIGRvbid0IGZpcmUgdGhlaXIgdG91Y2hlbmQuDQogICAgSW50ZXJhY3RpdmVEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5lbmRJbnRlcmFjdGlvbnMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIFsNCiAgICAgICAgICAgIHRoaXMuZGF0ZUNsaWNraW5nLA0KICAgICAgICAgICAgdGhpcy5kYXRlU2VsZWN0aW5nLA0KICAgICAgICAgICAgdGhpcy5ldmVudFBvaW50aW5nLA0KICAgICAgICAgICAgdGhpcy5ldmVudERyYWdnaW5nLA0KICAgICAgICAgICAgdGhpcy5ldmVudFJlc2l6aW5nDQogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbiAoaW50ZXJhY3Rpb24pIHsNCiAgICAgICAgICAgIGlmIChpbnRlcmFjdGlvbikgew0KICAgICAgICAgICAgICAgIGludGVyYWN0aW9uLmVuZCgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIC8vIEV2ZW50IERyYWctbi1Ecm9wDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgLy8gQ29tcHV0ZXMgaWYgdGhlIGdpdmVuIGV2ZW50IGlzIGFsbG93ZWQgdG8gYmUgZHJhZ2dlZCBieSB0aGUgdXNlcg0KICAgIEludGVyYWN0aXZlRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuaXNFdmVudERlZkRyYWdnYWJsZSA9IGZ1bmN0aW9uIChldmVudERlZikgew0KICAgICAgICByZXR1cm4gdGhpcy5pc0V2ZW50RGVmU3RhcnRFZGl0YWJsZShldmVudERlZik7DQogICAgfTsNCiAgICBJbnRlcmFjdGl2ZURhdGVDb21wb25lbnQucHJvdG90eXBlLmlzRXZlbnREZWZTdGFydEVkaXRhYmxlID0gZnVuY3Rpb24gKGV2ZW50RGVmKSB7DQogICAgICAgIHZhciBpc0VkaXRhYmxlID0gZXZlbnREZWYuaXNTdGFydEV4cGxpY2l0bHlFZGl0YWJsZSgpOw0KICAgICAgICBpZiAoaXNFZGl0YWJsZSA9PSBudWxsKSB7DQogICAgICAgICAgICBpc0VkaXRhYmxlID0gdGhpcy5vcHQoJ2V2ZW50U3RhcnRFZGl0YWJsZScpOw0KICAgICAgICAgICAgaWYgKGlzRWRpdGFibGUgPT0gbnVsbCkgew0KICAgICAgICAgICAgICAgIGlzRWRpdGFibGUgPSB0aGlzLmlzRXZlbnREZWZHZW5lcmFsbHlFZGl0YWJsZShldmVudERlZik7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGlzRWRpdGFibGU7DQogICAgfTsNCiAgICBJbnRlcmFjdGl2ZURhdGVDb21wb25lbnQucHJvdG90eXBlLmlzRXZlbnREZWZHZW5lcmFsbHlFZGl0YWJsZSA9IGZ1bmN0aW9uIChldmVudERlZikgew0KICAgICAgICB2YXIgaXNFZGl0YWJsZSA9IGV2ZW50RGVmLmlzRXhwbGljaXRseUVkaXRhYmxlKCk7DQogICAgICAgIGlmIChpc0VkaXRhYmxlID09IG51bGwpIHsNCiAgICAgICAgICAgIGlzRWRpdGFibGUgPSB0aGlzLm9wdCgnZWRpdGFibGUnKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gaXNFZGl0YWJsZTsNCiAgICB9Ow0KICAgIC8vIEV2ZW50IFJlc2l6aW5nDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgLy8gQ29tcHV0ZXMgaWYgdGhlIGdpdmVuIGV2ZW50IGlzIGFsbG93ZWQgdG8gYmUgcmVzaXplZCBmcm9tIGl0cyBzdGFydGluZyBlZGdlDQogICAgSW50ZXJhY3RpdmVEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5pc0V2ZW50RGVmUmVzaXphYmxlRnJvbVN0YXJ0ID0gZnVuY3Rpb24gKGV2ZW50RGVmKSB7DQogICAgICAgIHJldHVybiB0aGlzLm9wdCgnZXZlbnRSZXNpemFibGVGcm9tU3RhcnQnKSAmJiB0aGlzLmlzRXZlbnREZWZSZXNpemFibGUoZXZlbnREZWYpOw0KICAgIH07DQogICAgLy8gQ29tcHV0ZXMgaWYgdGhlIGdpdmVuIGV2ZW50IGlzIGFsbG93ZWQgdG8gYmUgcmVzaXplZCBmcm9tIGl0cyBlbmRpbmcgZWRnZQ0KICAgIEludGVyYWN0aXZlRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuaXNFdmVudERlZlJlc2l6YWJsZUZyb21FbmQgPSBmdW5jdGlvbiAoZXZlbnREZWYpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuaXNFdmVudERlZlJlc2l6YWJsZShldmVudERlZik7DQogICAgfTsNCiAgICAvLyBDb21wdXRlcyBpZiB0aGUgZ2l2ZW4gZXZlbnQgaXMgYWxsb3dlZCB0byBiZSByZXNpemVkIGJ5IHRoZSB1c2VyIGF0IGFsbA0KICAgIEludGVyYWN0aXZlRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuaXNFdmVudERlZlJlc2l6YWJsZSA9IGZ1bmN0aW9uIChldmVudERlZikgew0KICAgICAgICB2YXIgaXNSZXNpemFibGUgPSBldmVudERlZi5pc0R1cmF0aW9uRXhwbGljaXRseUVkaXRhYmxlKCk7DQogICAgICAgIGlmIChpc1Jlc2l6YWJsZSA9PSBudWxsKSB7DQogICAgICAgICAgICBpc1Jlc2l6YWJsZSA9IHRoaXMub3B0KCdldmVudER1cmF0aW9uRWRpdGFibGUnKTsNCiAgICAgICAgICAgIGlmIChpc1Jlc2l6YWJsZSA9PSBudWxsKSB7DQogICAgICAgICAgICAgICAgaXNSZXNpemFibGUgPSB0aGlzLmlzRXZlbnREZWZHZW5lcmFsbHlFZGl0YWJsZShldmVudERlZik7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGlzUmVzaXphYmxlOw0KICAgIH07DQogICAgLy8gRXZlbnQgTXV0YXRpb24gLyBDb25zdHJhaW50cw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIC8vIERpZmZzIHRoZSB0d28gZGF0ZXMsIHJldHVybmluZyBhIGR1cmF0aW9uLCBiYXNlZCBvbiBncmFudWxhcml0eSBvZiB0aGUgZ3JpZA0KICAgIC8vIFRPRE86IHBvcnQgaXNUaW1lU2NhbGUgaW50byB0aGlzIHN5c3RlbT8NCiAgICBJbnRlcmFjdGl2ZURhdGVDb21wb25lbnQucHJvdG90eXBlLmRpZmZEYXRlcyA9IGZ1bmN0aW9uIChhLCBiKSB7DQogICAgICAgIGlmICh0aGlzLmxhcmdlVW5pdCkgew0KICAgICAgICAgICAgcmV0dXJuIHV0aWxfMS5kaWZmQnlVbml0KGEsIGIsIHRoaXMubGFyZ2VVbml0KTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHJldHVybiB1dGlsXzEuZGlmZkRheVRpbWUoYSwgYik7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIGlzIGl0IGFsbG93ZWQsIGluIHJlbGF0aW9uIHRvIHRoZSB2aWV3J3MgdmFsaWRSYW5nZT8NCiAgICAvLyBOT1RFOiB2ZXJ5IHNpbWlsYXIgdG8gaXNFeHRlcm5hbEluc3RhbmNlR3JvdXBBbGxvd2VkDQogICAgSW50ZXJhY3RpdmVEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5pc0V2ZW50SW5zdGFuY2VHcm91cEFsbG93ZWQgPSBmdW5jdGlvbiAoZXZlbnRJbnN0YW5jZUdyb3VwKSB7DQogICAgICAgIHZhciB2aWV3ID0gdGhpcy5fZ2V0VmlldygpOw0KICAgICAgICB2YXIgZGF0ZVByb2ZpbGUgPSB0aGlzLmRhdGVQcm9maWxlOw0KICAgICAgICB2YXIgZXZlbnRGb290cHJpbnRzID0gdGhpcy5ldmVudFJhbmdlc1RvRXZlbnRGb290cHJpbnRzKGV2ZW50SW5zdGFuY2VHcm91cC5nZXRBbGxFdmVudFJhbmdlcygpKTsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBldmVudEZvb3RwcmludHMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIC8vIFRPRE86IGp1c3QgdXNlIGdldEFsbEV2ZW50UmFuZ2VzIGRpcmVjdGx5DQogICAgICAgICAgICBpZiAoIWRhdGVQcm9maWxlLnZhbGlkVW56b25lZFJhbmdlLmNvbnRhaW5zUmFuZ2UoZXZlbnRGb290cHJpbnRzW2ldLmNvbXBvbmVudEZvb3RwcmludC51bnpvbmVkUmFuZ2UpKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiB2aWV3LmNhbGVuZGFyLmNvbnN0cmFpbnRzLmlzRXZlbnRJbnN0YW5jZUdyb3VwQWxsb3dlZChldmVudEluc3RhbmNlR3JvdXApOw0KICAgIH07DQogICAgLy8gTk9URTogdmVyeSBzaW1pbGFyIHRvIGlzRXZlbnRJbnN0YW5jZUdyb3VwQWxsb3dlZA0KICAgIC8vIHdoZW4gaXQncyBhIGNvbXBsZXRlbHkgYW5vbnltb3VzIGV4dGVybmFsIGRyYWcsIG5vIGV2ZW50Lg0KICAgIEludGVyYWN0aXZlRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuaXNFeHRlcm5hbEluc3RhbmNlR3JvdXBBbGxvd2VkID0gZnVuY3Rpb24gKGV2ZW50SW5zdGFuY2VHcm91cCkgew0KICAgICAgICB2YXIgdmlldyA9IHRoaXMuX2dldFZpZXcoKTsNCiAgICAgICAgdmFyIGRhdGVQcm9maWxlID0gdGhpcy5kYXRlUHJvZmlsZTsNCiAgICAgICAgdmFyIGV2ZW50Rm9vdHByaW50cyA9IHRoaXMuZXZlbnRSYW5nZXNUb0V2ZW50Rm9vdHByaW50cyhldmVudEluc3RhbmNlR3JvdXAuZ2V0QWxsRXZlbnRSYW5nZXMoKSk7DQogICAgICAgIHZhciBpOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZXZlbnRGb290cHJpbnRzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBpZiAoIWRhdGVQcm9maWxlLnZhbGlkVW56b25lZFJhbmdlLmNvbnRhaW5zUmFuZ2UoZXZlbnRGb290cHJpbnRzW2ldLmNvbXBvbmVudEZvb3RwcmludC51bnpvbmVkUmFuZ2UpKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBldmVudEZvb3RwcmludHMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIC8vIHRyZWF0IGl0IGFzIGEgc2VsZWN0aW9uDQogICAgICAgICAgICAvLyBUT0RPOiBwYXNzIGluIGV2ZW50SW5zdGFuY2VHcm91cCBpbnN0ZWFkDQogICAgICAgICAgICAvLyAgYmVjYXVzZSB3ZSBkb24ndCB3YW50IGNhbGVuZGFyJ3MgY29uc3RyYWludCBzeXN0ZW0gdG8gZGVwZW5kIG9uIGEgY29tcG9uZW50J3MNCiAgICAgICAgICAgIC8vICBkZXRlcm1pbmF0aW9uIG9mIGZvb3RwcmludHMuDQogICAgICAgICAgICBpZiAoIXZpZXcuY2FsZW5kYXIuY29uc3RyYWludHMuaXNTZWxlY3Rpb25Gb290cHJpbnRBbGxvd2VkKGV2ZW50Rm9vdHByaW50c1tpXS5jb21wb25lbnRGb290cHJpbnQpKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgIH07DQogICAgcmV0dXJuIEludGVyYWN0aXZlRGF0ZUNvbXBvbmVudDsNCn0oRGF0ZUNvbXBvbmVudF8xLmRlZmF1bHQpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IEludGVyYWN0aXZlRGF0ZUNvbXBvbmVudDsNCgoKLyoqKi8gfSksCi8qIDQxICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdHNsaWJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgbW9tZW50ID0gX193ZWJwYWNrX3JlcXVpcmVfXygwKTsNCnZhciB1dGlsXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQpOw0KdmFyIFJlbmRlclF1ZXVlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIxOCk7DQp2YXIgRGF0ZVByb2ZpbGVHZW5lcmF0b3JfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjIxKTsNCnZhciBJbnRlcmFjdGl2ZURhdGVDb21wb25lbnRfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNDApOw0KdmFyIEdsb2JhbEVtaXR0ZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTUpOw0KdmFyIFVuem9uZWRSYW5nZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1KTsNCi8qIEFuIGFic3RyYWN0IGNsYXNzIGZyb20gd2hpY2ggb3RoZXIgdmlld3MgaW5oZXJpdCBmcm9tDQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCnZhciBWaWV3ID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKFZpZXcsIF9zdXBlcik7DQogICAgZnVuY3Rpb24gVmlldyhjYWxlbmRhciwgdmlld1NwZWMpIHsNCiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgbnVsbCwgdmlld1NwZWMub3B0aW9ucykgfHwgdGhpczsNCiAgICAgICAgX3RoaXMuYmF0Y2hSZW5kZXJEZXB0aCA9IDA7DQogICAgICAgIF90aGlzLmlzU2VsZWN0ZWQgPSBmYWxzZTsgLy8gYm9vbGVhbiB3aGV0aGVyIGEgcmFuZ2Ugb2YgdGltZSBpcyB1c2VyLXNlbGVjdGVkIG9yIG5vdA0KICAgICAgICBfdGhpcy5jYWxlbmRhciA9IGNhbGVuZGFyOw0KICAgICAgICBfdGhpcy52aWV3U3BlYyA9IHZpZXdTcGVjOw0KICAgICAgICAvLyBzaG9ydGN1dHMNCiAgICAgICAgX3RoaXMudHlwZSA9IHZpZXdTcGVjLnR5cGU7DQogICAgICAgIC8vIC5uYW1lIGlzIGRlcHJlY2F0ZWQNCiAgICAgICAgX3RoaXMubmFtZSA9IF90aGlzLnR5cGU7DQogICAgICAgIF90aGlzLmluaXRSZW5kZXJRdWV1ZSgpOw0KICAgICAgICBfdGhpcy5pbml0SGlkZGVuRGF5cygpOw0KICAgICAgICBfdGhpcy5kYXRlUHJvZmlsZUdlbmVyYXRvciA9IG5ldyBfdGhpcy5kYXRlUHJvZmlsZUdlbmVyYXRvckNsYXNzKF90aGlzKTsNCiAgICAgICAgX3RoaXMuYmluZEJhc2VSZW5kZXJIYW5kbGVycygpOw0KICAgICAgICBfdGhpcy5ldmVudE9yZGVyU3BlY3MgPSB1dGlsXzEucGFyc2VGaWVsZFNwZWNzKF90aGlzLm9wdCgnZXZlbnRPcmRlcicpKTsNCiAgICAgICAgLy8gbGVnYWN5DQogICAgICAgIGlmIChfdGhpc1snaW5pdGlhbGl6ZSddKSB7DQogICAgICAgICAgICBfdGhpc1snaW5pdGlhbGl6ZSddKCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIF90aGlzOw0KICAgIH0NCiAgICBWaWV3LnByb3RvdHlwZS5fZ2V0VmlldyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgfTsNCiAgICAvLyBSZXRyaWV2ZXMgYW4gb3B0aW9uIHdpdGggdGhlIGdpdmVuIG5hbWUNCiAgICBWaWV3LnByb3RvdHlwZS5vcHQgPSBmdW5jdGlvbiAobmFtZSkgew0KICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zW25hbWVdOw0KICAgIH07DQogICAgLyogUmVuZGVyIFF1ZXVlDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICBWaWV3LnByb3RvdHlwZS5pbml0UmVuZGVyUXVldWUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMucmVuZGVyUXVldWUgPSBuZXcgUmVuZGVyUXVldWVfMS5kZWZhdWx0KHsNCiAgICAgICAgICAgIGV2ZW50OiB0aGlzLm9wdCgnZXZlbnRSZW5kZXJXYWl0JykNCiAgICAgICAgfSk7DQogICAgICAgIHRoaXMucmVuZGVyUXVldWUub24oJ3N0YXJ0JywgdGhpcy5vblJlbmRlclF1ZXVlU3RhcnQuYmluZCh0aGlzKSk7DQogICAgICAgIHRoaXMucmVuZGVyUXVldWUub24oJ3N0b3AnLCB0aGlzLm9uUmVuZGVyUXVldWVTdG9wLmJpbmQodGhpcykpOw0KICAgICAgICB0aGlzLm9uKCdiZWZvcmU6Y2hhbmdlJywgdGhpcy5zdGFydEJhdGNoUmVuZGVyKTsNCiAgICAgICAgdGhpcy5vbignY2hhbmdlJywgdGhpcy5zdG9wQmF0Y2hSZW5kZXIpOw0KICAgIH07DQogICAgVmlldy5wcm90b3R5cGUub25SZW5kZXJRdWV1ZVN0YXJ0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLmNhbGVuZGFyLmZyZWV6ZUNvbnRlbnRIZWlnaHQoKTsNCiAgICAgICAgdGhpcy5hZGRTY3JvbGwodGhpcy5xdWVyeVNjcm9sbCgpKTsNCiAgICB9Ow0KICAgIFZpZXcucHJvdG90eXBlLm9uUmVuZGVyUXVldWVTdG9wID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5jYWxlbmRhci51cGRhdGVWaWV3U2l6ZSgpKSB7DQogICAgICAgICAgICB0aGlzLnBvcFNjcm9sbCgpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuY2FsZW5kYXIudGhhd0NvbnRlbnRIZWlnaHQoKTsNCiAgICB9Ow0KICAgIFZpZXcucHJvdG90eXBlLnN0YXJ0QmF0Y2hSZW5kZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICghKHRoaXMuYmF0Y2hSZW5kZXJEZXB0aCsrKSkgew0KICAgICAgICAgICAgdGhpcy5yZW5kZXJRdWV1ZS5wYXVzZSgpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBWaWV3LnByb3RvdHlwZS5zdG9wQmF0Y2hSZW5kZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICghKC0tdGhpcy5iYXRjaFJlbmRlckRlcHRoKSkgew0KICAgICAgICAgICAgdGhpcy5yZW5kZXJRdWV1ZS5yZXN1bWUoKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgVmlldy5wcm90b3R5cGUucmVxdWVzdFJlbmRlciA9IGZ1bmN0aW9uIChmdW5jLCBuYW1lc3BhY2UsIGFjdGlvblR5cGUpIHsNCiAgICAgICAgdGhpcy5yZW5kZXJRdWV1ZS5xdWV1ZShmdW5jLCBuYW1lc3BhY2UsIGFjdGlvblR5cGUpOw0KICAgIH07DQogICAgLy8gZ2l2ZW4gZnVuYyB3aWxsIGF1dG8tYmluZCB0byBgdGhpc2ANCiAgICBWaWV3LnByb3RvdHlwZS53aGVuU2l6ZVVwZGF0ZWQgPSBmdW5jdGlvbiAoZnVuYykgew0KICAgICAgICBpZiAodGhpcy5yZW5kZXJRdWV1ZS5pc1J1bm5pbmcpIHsNCiAgICAgICAgICAgIHRoaXMucmVuZGVyUXVldWUub25lKCdzdG9wJywgZnVuYy5iaW5kKHRoaXMpKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIGZ1bmMuY2FsbCh0aGlzKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLyogVGl0bGUgYW5kIERhdGUgRm9ybWF0dGluZw0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgLy8gQ29tcHV0ZXMgd2hhdCB0aGUgdGl0bGUgYXQgdGhlIHRvcCBvZiB0aGUgY2FsZW5kYXIgc2hvdWxkIGJlIGZvciB0aGlzIHZpZXcNCiAgICBWaWV3LnByb3RvdHlwZS5jb21wdXRlVGl0bGUgPSBmdW5jdGlvbiAoZGF0ZVByb2ZpbGUpIHsNCiAgICAgICAgdmFyIHVuem9uZWRSYW5nZTsNCiAgICAgICAgLy8gZm9yIHZpZXdzIHRoYXQgc3BhbiBhIGxhcmdlIHVuaXQgb2YgdGltZSwgc2hvdyB0aGUgcHJvcGVyIGludGVydmFsLCBpZ25vcmluZyBzdHJheSBkYXlzIGJlZm9yZSBhbmQgYWZ0ZXINCiAgICAgICAgaWYgKC9eKHllYXJ8bW9udGgpJC8udGVzdChkYXRlUHJvZmlsZS5jdXJyZW50UmFuZ2VVbml0KSkgew0KICAgICAgICAgICAgdW56b25lZFJhbmdlID0gZGF0ZVByb2ZpbGUuY3VycmVudFVuem9uZWRSYW5nZTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHVuem9uZWRSYW5nZSA9IGRhdGVQcm9maWxlLmFjdGl2ZVVuem9uZWRSYW5nZTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXRSYW5nZSh7DQogICAgICAgICAgICBzdGFydDogdGhpcy5jYWxlbmRhci5tc1RvTW9tZW50KHVuem9uZWRSYW5nZS5zdGFydE1zLCBkYXRlUHJvZmlsZS5pc1JhbmdlQWxsRGF5KSwNCiAgICAgICAgICAgIGVuZDogdGhpcy5jYWxlbmRhci5tc1RvTW9tZW50KHVuem9uZWRSYW5nZS5lbmRNcywgZGF0ZVByb2ZpbGUuaXNSYW5nZUFsbERheSkNCiAgICAgICAgfSwgZGF0ZVByb2ZpbGUuaXNSYW5nZUFsbERheSwgdGhpcy5vcHQoJ3RpdGxlRm9ybWF0JykgfHwgdGhpcy5jb21wdXRlVGl0bGVGb3JtYXQoZGF0ZVByb2ZpbGUpLCB0aGlzLm9wdCgndGl0bGVSYW5nZVNlcGFyYXRvcicpKTsNCiAgICB9Ow0KICAgIC8vIEdlbmVyYXRlcyB0aGUgZm9ybWF0IHN0cmluZyB0aGF0IHNob3VsZCBiZSB1c2VkIHRvIGdlbmVyYXRlIHRoZSB0aXRsZSBmb3IgdGhlIGN1cnJlbnQgZGF0ZSByYW5nZS4NCiAgICAvLyBBdHRlbXB0cyB0byBjb21wdXRlIHRoZSBtb3N0IGFwcHJvcHJpYXRlIGZvcm1hdCBpZiBub3QgZXhwbGljaXRseSBzcGVjaWZpZWQgd2l0aCBgdGl0bGVGb3JtYXRgLg0KICAgIFZpZXcucHJvdG90eXBlLmNvbXB1dGVUaXRsZUZvcm1hdCA9IGZ1bmN0aW9uIChkYXRlUHJvZmlsZSkgew0KICAgICAgICB2YXIgY3VycmVudFJhbmdlVW5pdCA9IGRhdGVQcm9maWxlLmN1cnJlbnRSYW5nZVVuaXQ7DQogICAgICAgIGlmIChjdXJyZW50UmFuZ2VVbml0ID09PSAneWVhcicpIHsNCiAgICAgICAgICAgIHJldHVybiAnWVlZWSc7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAoY3VycmVudFJhbmdlVW5pdCA9PT0gJ21vbnRoJykgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMub3B0KCdtb250aFllYXJGb3JtYXQnKTsgLy8gbGlrZSAiU2VwdGVtYmVyIDIwMTQiDQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAoZGF0ZVByb2ZpbGUuY3VycmVudFVuem9uZWRSYW5nZS5hcygnZGF5cycpID4gMSkgew0KICAgICAgICAgICAgcmV0dXJuICdsbCc7IC8vIG11bHRpLWRheSByYW5nZS4gc2hvcnRlciwgbGlrZSAiU2VwIDkgLSAxMCAyMDE0Ig0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuICdMTCc7IC8vIG9uZSBkYXkuIGxvbmdlciwgbGlrZSAiU2VwdGVtYmVyIDkgMjAxNCINCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gRGF0ZSBTZXR0aW5nL1Vuc2V0dGluZw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgVmlldy5wcm90b3R5cGUuc2V0RGF0ZSA9IGZ1bmN0aW9uIChkYXRlKSB7DQogICAgICAgIHZhciBjdXJyZW50RGF0ZVByb2ZpbGUgPSB0aGlzLmdldCgnZGF0ZVByb2ZpbGUnKTsNCiAgICAgICAgdmFyIG5ld0RhdGVQcm9maWxlID0gdGhpcy5kYXRlUHJvZmlsZUdlbmVyYXRvci5idWlsZChkYXRlLCB1bmRlZmluZWQsIHRydWUpOyAvLyBmb3JjZVRvVmFsaWQ9dHJ1ZQ0KICAgICAgICBpZiAoIWN1cnJlbnREYXRlUHJvZmlsZSB8fA0KICAgICAgICAgICAgIWN1cnJlbnREYXRlUHJvZmlsZS5hY3RpdmVVbnpvbmVkUmFuZ2UuZXF1YWxzKG5ld0RhdGVQcm9maWxlLmFjdGl2ZVVuem9uZWRSYW5nZSkpIHsNCiAgICAgICAgICAgIHRoaXMuc2V0KCdkYXRlUHJvZmlsZScsIG5ld0RhdGVQcm9maWxlKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgVmlldy5wcm90b3R5cGUudW5zZXREYXRlID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLnVuc2V0KCdkYXRlUHJvZmlsZScpOw0KICAgIH07DQogICAgLy8gRXZlbnQgRGF0YQ0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgVmlldy5wcm90b3R5cGUuZmV0Y2hJbml0aWFsRXZlbnRzID0gZnVuY3Rpb24gKGRhdGVQcm9maWxlKSB7DQogICAgICAgIHZhciBjYWxlbmRhciA9IHRoaXMuY2FsZW5kYXI7DQogICAgICAgIHZhciBmb3JjZUFsbERheSA9IGRhdGVQcm9maWxlLmlzUmFuZ2VBbGxEYXkgJiYgIXRoaXMudXNlc01pbk1heFRpbWU7DQogICAgICAgIHJldHVybiBjYWxlbmRhci5yZXF1ZXN0RXZlbnRzKGNhbGVuZGFyLm1zVG9Nb21lbnQoZGF0ZVByb2ZpbGUuYWN0aXZlVW56b25lZFJhbmdlLnN0YXJ0TXMsIGZvcmNlQWxsRGF5KSwgY2FsZW5kYXIubXNUb01vbWVudChkYXRlUHJvZmlsZS5hY3RpdmVVbnpvbmVkUmFuZ2UuZW5kTXMsIGZvcmNlQWxsRGF5KSk7DQogICAgfTsNCiAgICBWaWV3LnByb3RvdHlwZS5iaW5kRXZlbnRDaGFuZ2VzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY2FsZW5kYXIsICdldmVudHNSZXNldCcsIHRoaXMucmVzZXRFdmVudHMpOyAvLyBUT0RPOiBtYWtlIHRoaXMgYSByZWFsIGV2ZW50DQogICAgfTsNCiAgICBWaWV3LnByb3RvdHlwZS51bmJpbmRFdmVudENoYW5nZXMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMuc3RvcExpc3RlbmluZ1RvKHRoaXMuY2FsZW5kYXIsICdldmVudHNSZXNldCcpOw0KICAgIH07DQogICAgVmlldy5wcm90b3R5cGUuc2V0RXZlbnRzID0gZnVuY3Rpb24gKGV2ZW50c1BheWxvYWQpIHsNCiAgICAgICAgdGhpcy5zZXQoJ2N1cnJlbnRFdmVudHMnLCBldmVudHNQYXlsb2FkKTsNCiAgICAgICAgdGhpcy5zZXQoJ2hhc0V2ZW50cycsIHRydWUpOw0KICAgIH07DQogICAgVmlldy5wcm90b3R5cGUudW5zZXRFdmVudHMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMudW5zZXQoJ2N1cnJlbnRFdmVudHMnKTsNCiAgICAgICAgdGhpcy51bnNldCgnaGFzRXZlbnRzJyk7DQogICAgfTsNCiAgICBWaWV3LnByb3RvdHlwZS5yZXNldEV2ZW50cyA9IGZ1bmN0aW9uIChldmVudHNQYXlsb2FkKSB7DQogICAgICAgIHRoaXMuc3RhcnRCYXRjaFJlbmRlcigpOw0KICAgICAgICB0aGlzLnVuc2V0RXZlbnRzKCk7DQogICAgICAgIHRoaXMuc2V0RXZlbnRzKGV2ZW50c1BheWxvYWQpOw0KICAgICAgICB0aGlzLnN0b3BCYXRjaFJlbmRlcigpOw0KICAgIH07DQogICAgLy8gRGF0ZSBIaWdoLWxldmVsIFJlbmRlcmluZw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgVmlldy5wcm90b3R5cGUucmVxdWVzdERhdGVSZW5kZXIgPSBmdW5jdGlvbiAoZGF0ZVByb2ZpbGUpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgdGhpcy5yZXF1ZXN0UmVuZGVyKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIF90aGlzLmV4ZWN1dGVEYXRlUmVuZGVyKGRhdGVQcm9maWxlKTsNCiAgICAgICAgfSwgJ2RhdGUnLCAnaW5pdCcpOw0KICAgIH07DQogICAgVmlldy5wcm90b3R5cGUucmVxdWVzdERhdGVVbnJlbmRlciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgdGhpcy5yZXF1ZXN0UmVuZGVyKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIF90aGlzLmV4ZWN1dGVEYXRlVW5yZW5kZXIoKTsNCiAgICAgICAgfSwgJ2RhdGUnLCAnZGVzdHJveScpOw0KICAgIH07DQogICAgLy8gaWYgZGF0ZVByb2ZpbGUgbm90IHNwZWNpZmllZCwgdXNlcyBjdXJyZW50DQogICAgVmlldy5wcm90b3R5cGUuZXhlY3V0ZURhdGVSZW5kZXIgPSBmdW5jdGlvbiAoZGF0ZVByb2ZpbGUpIHsNCiAgICAgICAgX3N1cGVyLnByb3RvdHlwZS5leGVjdXRlRGF0ZVJlbmRlci5jYWxsKHRoaXMsIGRhdGVQcm9maWxlKTsNCiAgICAgICAgaWYgKHRoaXNbJ3JlbmRlciddKSB7DQogICAgICAgICAgICB0aGlzWydyZW5kZXInXSgpOyAvLyBUT0RPOiBkZXByZWNhdGUNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLnRyaWdnZXIoJ2RhdGVzUmVuZGVyZWQnKTsNCiAgICAgICAgdGhpcy5hZGRTY3JvbGwoeyBpc0RhdGVJbml0OiB0cnVlIH0pOw0KICAgICAgICB0aGlzLnN0YXJ0Tm93SW5kaWNhdG9yKCk7IC8vIHNob3VsZG4ndCByZW5kZXIgeWV0IGJlY2F1c2UgdXBkYXRlU2l6ZSB3aWxsIGJlIGNhbGxlZCBzb29uDQogICAgfTsNCiAgICBWaWV3LnByb3RvdHlwZS5leGVjdXRlRGF0ZVVucmVuZGVyID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLnVuc2VsZWN0KCk7DQogICAgICAgIHRoaXMuc3RvcE5vd0luZGljYXRvcigpOw0KICAgICAgICB0aGlzLnRyaWdnZXIoJ2JlZm9yZTpkYXRlc1VucmVuZGVyZWQnKTsNCiAgICAgICAgaWYgKHRoaXNbJ2Rlc3Ryb3knXSkgew0KICAgICAgICAgICAgdGhpc1snZGVzdHJveSddKCk7IC8vIFRPRE86IGRlcHJlY2F0ZQ0KICAgICAgICB9DQogICAgICAgIF9zdXBlci5wcm90b3R5cGUuZXhlY3V0ZURhdGVVbnJlbmRlci5jYWxsKHRoaXMpOw0KICAgIH07DQogICAgLy8gIkJhc2UiIHJlbmRlcmluZw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgVmlldy5wcm90b3R5cGUuYmluZEJhc2VSZW5kZXJIYW5kbGVycyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgdGhpcy5vbignZGF0ZXNSZW5kZXJlZCcsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIF90aGlzLndoZW5TaXplVXBkYXRlZChfdGhpcy50cmlnZ2VyVmlld1JlbmRlcik7DQogICAgICAgIH0pOw0KICAgICAgICB0aGlzLm9uKCdiZWZvcmU6ZGF0ZXNVbnJlbmRlcmVkJywgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgX3RoaXMudHJpZ2dlclZpZXdEZXN0cm95KCk7DQogICAgICAgIH0pOw0KICAgIH07DQogICAgVmlldy5wcm90b3R5cGUudHJpZ2dlclZpZXdSZW5kZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMucHVibGljbHlUcmlnZ2VyKCd2aWV3UmVuZGVyJywgew0KICAgICAgICAgICAgY29udGV4dDogdGhpcywNCiAgICAgICAgICAgIGFyZ3M6IFt0aGlzLCB0aGlzLmVsXQ0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIFZpZXcucHJvdG90eXBlLnRyaWdnZXJWaWV3RGVzdHJveSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5wdWJsaWNseVRyaWdnZXIoJ3ZpZXdEZXN0cm95Jywgew0KICAgICAgICAgICAgY29udGV4dDogdGhpcywNCiAgICAgICAgICAgIGFyZ3M6IFt0aGlzLCB0aGlzLmVsXQ0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIC8vIEV2ZW50IEhpZ2gtbGV2ZWwgUmVuZGVyaW5nDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICBWaWV3LnByb3RvdHlwZS5yZXF1ZXN0RXZlbnRzUmVuZGVyID0gZnVuY3Rpb24gKGV2ZW50c1BheWxvYWQpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgdGhpcy5yZXF1ZXN0UmVuZGVyKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIF90aGlzLmV4ZWN1dGVFdmVudFJlbmRlcihldmVudHNQYXlsb2FkKTsNCiAgICAgICAgICAgIF90aGlzLndoZW5TaXplVXBkYXRlZChfdGhpcy50cmlnZ2VyQWZ0ZXJFdmVudHNSZW5kZXJlZCk7DQogICAgICAgIH0sICdldmVudCcsICdpbml0Jyk7DQogICAgfTsNCiAgICBWaWV3LnByb3RvdHlwZS5yZXF1ZXN0RXZlbnRzVW5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIHRoaXMucmVxdWVzdFJlbmRlcihmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICBfdGhpcy50cmlnZ2VyQmVmb3JlRXZlbnRzRGVzdHJveWVkKCk7DQogICAgICAgICAgICBfdGhpcy5leGVjdXRlRXZlbnRVbnJlbmRlcigpOw0KICAgICAgICB9LCAnZXZlbnQnLCAnZGVzdHJveScpOw0KICAgIH07DQogICAgLy8gQnVzaW5lc3MgSG91ciBIaWdoLWxldmVsIFJlbmRlcmluZw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgVmlldy5wcm90b3R5cGUucmVxdWVzdEJ1c2luZXNzSG91cnNSZW5kZXIgPSBmdW5jdGlvbiAoYnVzaW5lc3NIb3VyR2VuZXJhdG9yKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIHRoaXMucmVxdWVzdFJlbmRlcihmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICBfdGhpcy5yZW5kZXJCdXNpbmVzc0hvdXJzKGJ1c2luZXNzSG91ckdlbmVyYXRvcik7DQogICAgICAgIH0sICdidXNpbmVzc0hvdXJzJywgJ2luaXQnKTsNCiAgICB9Ow0KICAgIFZpZXcucHJvdG90eXBlLnJlcXVlc3RCdXNpbmVzc0hvdXJzVW5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIHRoaXMucmVxdWVzdFJlbmRlcihmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICBfdGhpcy51bnJlbmRlckJ1c2luZXNzSG91cnMoKTsNCiAgICAgICAgfSwgJ2J1c2luZXNzSG91cnMnLCAnZGVzdHJveScpOw0KICAgIH07DQogICAgLy8gTWlzYyB2aWV3IHJlbmRlcmluZyB1dGlscw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgLy8gQmluZHMgRE9NIGhhbmRsZXJzIHRvIGVsZW1lbnRzIHRoYXQgcmVzaWRlIG91dHNpZGUgdGhlIHZpZXcgY29udGFpbmVyLCBzdWNoIGFzIHRoZSBkb2N1bWVudA0KICAgIFZpZXcucHJvdG90eXBlLmJpbmRHbG9iYWxIYW5kbGVycyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgX3N1cGVyLnByb3RvdHlwZS5iaW5kR2xvYmFsSGFuZGxlcnMuY2FsbCh0aGlzKTsNCiAgICAgICAgdGhpcy5saXN0ZW5UbyhHbG9iYWxFbWl0dGVyXzEuZGVmYXVsdC5nZXQoKSwgew0KICAgICAgICAgICAgdG91Y2hzdGFydDogdGhpcy5wcm9jZXNzVW5zZWxlY3QsDQogICAgICAgICAgICBtb3VzZWRvd246IHRoaXMuaGFuZGxlRG9jdW1lbnRNb3VzZWRvd24NCiAgICAgICAgfSk7DQogICAgfTsNCiAgICAvLyBVbmJpbmRzIERPTSBoYW5kbGVycyBmcm9tIGVsZW1lbnRzIHRoYXQgcmVzaWRlIG91dHNpZGUgdGhlIHZpZXcgY29udGFpbmVyDQogICAgVmlldy5wcm90b3R5cGUudW5iaW5kR2xvYmFsSGFuZGxlcnMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIF9zdXBlci5wcm90b3R5cGUudW5iaW5kR2xvYmFsSGFuZGxlcnMuY2FsbCh0aGlzKTsNCiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nVG8oR2xvYmFsRW1pdHRlcl8xLmRlZmF1bHQuZ2V0KCkpOw0KICAgIH07DQogICAgLyogTm93IEluZGljYXRvcg0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgLy8gSW1tZWRpYXRlbHkgcmVuZGVyIHRoZSBjdXJyZW50IHRpbWUgaW5kaWNhdG9yIGFuZCBiZWdpbnMgcmUtcmVuZGVyaW5nIGl0IGF0IGFuIGludGVydmFsLA0KICAgIC8vIHdoaWNoIGlzIGRlZmluZWQgYnkgdGhpcy5nZXROb3dJbmRpY2F0b3JVbml0KCkuDQogICAgLy8gVE9ETzogc29tZWhvdyBkbyB0aGlzIGZvciB0aGUgY3VycmVudCB3aG9sZSBkYXkncyBiYWNrZ3JvdW5kIHRvbw0KICAgIFZpZXcucHJvdG90eXBlLnN0YXJ0Tm93SW5kaWNhdG9yID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICB2YXIgdW5pdDsNCiAgICAgICAgdmFyIHVwZGF0ZTsNCiAgICAgICAgdmFyIGRlbGF5OyAvLyBtcyB3YWl0IHZhbHVlDQogICAgICAgIGlmICh0aGlzLm9wdCgnbm93SW5kaWNhdG9yJykpIHsNCiAgICAgICAgICAgIHVuaXQgPSB0aGlzLmdldE5vd0luZGljYXRvclVuaXQoKTsNCiAgICAgICAgICAgIGlmICh1bml0KSB7DQogICAgICAgICAgICAgICAgdXBkYXRlID0gdXRpbF8xLnByb3h5KHRoaXMsICd1cGRhdGVOb3dJbmRpY2F0b3InKTsgLy8gYmluZCB0byBgdGhpc2ANCiAgICAgICAgICAgICAgICB0aGlzLmluaXRpYWxOb3dEYXRlID0gdGhpcy5jYWxlbmRhci5nZXROb3coKTsNCiAgICAgICAgICAgICAgICB0aGlzLmluaXRpYWxOb3dRdWVyaWVkTXMgPSBuZXcgRGF0ZSgpLnZhbHVlT2YoKTsNCiAgICAgICAgICAgICAgICAvLyB3YWl0IHVudGlsIHRoZSBiZWdpbm5pbmcgb2YgdGhlIG5leHQgaW50ZXJ2YWwNCiAgICAgICAgICAgICAgICBkZWxheSA9IHRoaXMuaW5pdGlhbE5vd0RhdGUuY2xvbmUoKS5zdGFydE9mKHVuaXQpLmFkZCgxLCB1bml0KS52YWx1ZU9mKCkgLSB0aGlzLmluaXRpYWxOb3dEYXRlLnZhbHVlT2YoKTsNCiAgICAgICAgICAgICAgICB0aGlzLm5vd0luZGljYXRvclRpbWVvdXRJRCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICBfdGhpcy5ub3dJbmRpY2F0b3JUaW1lb3V0SUQgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICB1cGRhdGUoKTsNCiAgICAgICAgICAgICAgICAgICAgZGVsYXkgPSArbW9tZW50LmR1cmF0aW9uKDEsIHVuaXQpOw0KICAgICAgICAgICAgICAgICAgICBkZWxheSA9IE1hdGgubWF4KDEwMCwgZGVsYXkpOyAvLyBwcmV2ZW50IHRvbyBmcmVxdWVudA0KICAgICAgICAgICAgICAgICAgICBfdGhpcy5ub3dJbmRpY2F0b3JJbnRlcnZhbElEID0gc2V0SW50ZXJ2YWwodXBkYXRlLCBkZWxheSk7IC8vIHVwZGF0ZSBldmVyeSBpbnRlcnZhbA0KICAgICAgICAgICAgICAgIH0sIGRlbGF5KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIC8vIHJlbmRlcmluZyB3aWxsIGJlIGluaXRpYXRlZCBpbiB1cGRhdGVTaXplDQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIHJlcmVuZGVycyB0aGUgbm93IGluZGljYXRvciwgY29tcHV0aW5nIHRoZSBuZXcgY3VycmVudCB0aW1lIGZyb20gdGhlIGFtb3VudCBvZiB0aW1lIHRoYXQgaGFzIHBhc3NlZA0KICAgIC8vIHNpbmNlIHRoZSBpbml0aWFsIGdldE5vdyBjYWxsLg0KICAgIFZpZXcucHJvdG90eXBlLnVwZGF0ZU5vd0luZGljYXRvciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMuaXNEYXRlc1JlbmRlcmVkICYmDQogICAgICAgICAgICB0aGlzLmluaXRpYWxOb3dEYXRlIC8vIGFjdGl2YXRlZCBiZWZvcmU/DQogICAgICAgICkgew0KICAgICAgICAgICAgdGhpcy51bnJlbmRlck5vd0luZGljYXRvcigpOyAvLyB3b24ndCB1bnJlbmRlciBpZiB1bm5lY2Vzc2FyeQ0KICAgICAgICAgICAgdGhpcy5yZW5kZXJOb3dJbmRpY2F0b3IodGhpcy5pbml0aWFsTm93RGF0ZS5jbG9uZSgpLmFkZChuZXcgRGF0ZSgpLnZhbHVlT2YoKSAtIHRoaXMuaW5pdGlhbE5vd1F1ZXJpZWRNcykgLy8gYWRkIG1zDQogICAgICAgICAgICApOw0KICAgICAgICAgICAgdGhpcy5pc05vd0luZGljYXRvclJlbmRlcmVkID0gdHJ1ZTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gSW1tZWRpYXRlbHkgdW5yZW5kZXJzIHRoZSB2aWV3J3MgY3VycmVudCB0aW1lIGluZGljYXRvciBhbmQgc3RvcHMgYW55IHJlLXJlbmRlcmluZyB0aW1lcnMuDQogICAgLy8gV29uJ3QgY2F1c2Ugc2lkZSBlZmZlY3RzIGlmIGluZGljYXRvciBpc24ndCByZW5kZXJlZC4NCiAgICBWaWV3LnByb3RvdHlwZS5zdG9wTm93SW5kaWNhdG9yID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5pc05vd0luZGljYXRvclJlbmRlcmVkKSB7DQogICAgICAgICAgICBpZiAodGhpcy5ub3dJbmRpY2F0b3JUaW1lb3V0SUQpIHsNCiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5ub3dJbmRpY2F0b3JUaW1lb3V0SUQpOw0KICAgICAgICAgICAgICAgIHRoaXMubm93SW5kaWNhdG9yVGltZW91dElEID0gbnVsbDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmICh0aGlzLm5vd0luZGljYXRvckludGVydmFsSUQpIHsNCiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMubm93SW5kaWNhdG9ySW50ZXJ2YWxJRCk7DQogICAgICAgICAgICAgICAgdGhpcy5ub3dJbmRpY2F0b3JJbnRlcnZhbElEID0gbnVsbDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMudW5yZW5kZXJOb3dJbmRpY2F0b3IoKTsNCiAgICAgICAgICAgIHRoaXMuaXNOb3dJbmRpY2F0b3JSZW5kZXJlZCA9IGZhbHNlOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvKiBEaW1lbnNpb25zDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICBWaWV3LnByb3RvdHlwZS51cGRhdGVTaXplID0gZnVuY3Rpb24gKHRvdGFsSGVpZ2h0LCBpc0F1dG8sIGlzUmVzaXplKSB7DQogICAgICAgIGlmICh0aGlzWydzZXRIZWlnaHQnXSkgew0KICAgICAgICAgICAgdGhpc1snc2V0SGVpZ2h0J10odG90YWxIZWlnaHQsIGlzQXV0byk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBfc3VwZXIucHJvdG90eXBlLnVwZGF0ZVNpemUuY2FsbCh0aGlzLCB0b3RhbEhlaWdodCwgaXNBdXRvLCBpc1Jlc2l6ZSk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy51cGRhdGVOb3dJbmRpY2F0b3IoKTsNCiAgICB9Ow0KICAgIC8qIFNjcm9sbGVyDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICBWaWV3LnByb3RvdHlwZS5hZGRTY3JvbGwgPSBmdW5jdGlvbiAoc2Nyb2xsKSB7DQogICAgICAgIHZhciBxdWV1ZWRTY3JvbGwgPSB0aGlzLnF1ZXVlZFNjcm9sbCB8fCAodGhpcy5xdWV1ZWRTY3JvbGwgPSB7fSk7DQogICAgICAgICQuZXh0ZW5kKHF1ZXVlZFNjcm9sbCwgc2Nyb2xsKTsNCiAgICB9Ow0KICAgIFZpZXcucHJvdG90eXBlLnBvcFNjcm9sbCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5hcHBseVF1ZXVlZFNjcm9sbCgpOw0KICAgICAgICB0aGlzLnF1ZXVlZFNjcm9sbCA9IG51bGw7DQogICAgfTsNCiAgICBWaWV3LnByb3RvdHlwZS5hcHBseVF1ZXVlZFNjcm9sbCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMucXVldWVkU2Nyb2xsKSB7DQogICAgICAgICAgICB0aGlzLmFwcGx5U2Nyb2xsKHRoaXMucXVldWVkU2Nyb2xsKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgVmlldy5wcm90b3R5cGUucXVlcnlTY3JvbGwgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBzY3JvbGwgPSB7fTsNCiAgICAgICAgaWYgKHRoaXMuaXNEYXRlc1JlbmRlcmVkKSB7DQogICAgICAgICAgICAkLmV4dGVuZChzY3JvbGwsIHRoaXMucXVlcnlEYXRlU2Nyb2xsKCkpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBzY3JvbGw7DQogICAgfTsNCiAgICBWaWV3LnByb3RvdHlwZS5hcHBseVNjcm9sbCA9IGZ1bmN0aW9uIChzY3JvbGwpIHsNCiAgICAgICAgaWYgKHNjcm9sbC5pc0RhdGVJbml0ICYmIHRoaXMuaXNEYXRlc1JlbmRlcmVkKSB7DQogICAgICAgICAgICAkLmV4dGVuZChzY3JvbGwsIHRoaXMuY29tcHV0ZUluaXRpYWxEYXRlU2Nyb2xsKCkpOw0KICAgICAgICB9DQogICAgICAgIGlmICh0aGlzLmlzRGF0ZXNSZW5kZXJlZCkgew0KICAgICAgICAgICAgdGhpcy5hcHBseURhdGVTY3JvbGwoc2Nyb2xsKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgVmlldy5wcm90b3R5cGUuY29tcHV0ZUluaXRpYWxEYXRlU2Nyb2xsID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4ge307IC8vIHN1YmNsYXNzZXMgbXVzdCBpbXBsZW1lbnQNCiAgICB9Ow0KICAgIFZpZXcucHJvdG90eXBlLnF1ZXJ5RGF0ZVNjcm9sbCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHt9OyAvLyBzdWJjbGFzc2VzIG11c3QgaW1wbGVtZW50DQogICAgfTsNCiAgICBWaWV3LnByb3RvdHlwZS5hcHBseURhdGVTY3JvbGwgPSBmdW5jdGlvbiAoc2Nyb2xsKSB7DQogICAgICAgIC8vIHN1YmNsYXNzZXMgbXVzdCBpbXBsZW1lbnQNCiAgICB9Ow0KICAgIC8qIEV2ZW50IERyYWctbi1Ecm9wDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICBWaWV3LnByb3RvdHlwZS5yZXBvcnRFdmVudERyb3AgPSBmdW5jdGlvbiAoZXZlbnRJbnN0YW5jZSwgZXZlbnRNdXRhdGlvbiwgZWwsIGV2KSB7DQogICAgICAgIHZhciBldmVudE1hbmFnZXIgPSB0aGlzLmNhbGVuZGFyLmV2ZW50TWFuYWdlcjsNCiAgICAgICAgdmFyIHVuZG9GdW5jID0gZXZlbnRNYW5hZ2VyLm11dGF0ZUV2ZW50c1dpdGhJZChldmVudEluc3RhbmNlLmRlZi5pZCwgZXZlbnRNdXRhdGlvbik7DQogICAgICAgIHZhciBkYXRlTXV0YXRpb24gPSBldmVudE11dGF0aW9uLmRhdGVNdXRhdGlvbjsNCiAgICAgICAgLy8gdXBkYXRlIHRoZSBFdmVudEluc3RhbmNlLCBmb3IgaGFuZGxlcnMNCiAgICAgICAgaWYgKGRhdGVNdXRhdGlvbikgew0KICAgICAgICAgICAgZXZlbnRJbnN0YW5jZS5kYXRlUHJvZmlsZSA9IGRhdGVNdXRhdGlvbi5idWlsZE5ld0RhdGVQcm9maWxlKGV2ZW50SW5zdGFuY2UuZGF0ZVByb2ZpbGUsIHRoaXMuY2FsZW5kYXIpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMudHJpZ2dlckV2ZW50RHJvcChldmVudEluc3RhbmNlLCANCiAgICAgICAgLy8gYSBkcm9wIGRvZXNuJ3QgbmVjZXNzYXJpbHkgbWVhbiBhIGRhdGUgbXV0YXRpb24gKGV4OiByZXNvdXJjZSBjaGFuZ2UpDQogICAgICAgIChkYXRlTXV0YXRpb24gJiYgZGF0ZU11dGF0aW9uLmRhdGVEZWx0YSkgfHwgbW9tZW50LmR1cmF0aW9uKCksIHVuZG9GdW5jLCBlbCwgZXYpOw0KICAgIH07DQogICAgLy8gVHJpZ2dlcnMgZXZlbnQtZHJvcCBoYW5kbGVycyB0aGF0IGhhdmUgc3Vic2NyaWJlZCB2aWEgdGhlIEFQSQ0KICAgIFZpZXcucHJvdG90eXBlLnRyaWdnZXJFdmVudERyb3AgPSBmdW5jdGlvbiAoZXZlbnRJbnN0YW5jZSwgZGF0ZURlbHRhLCB1bmRvRnVuYywgZWwsIGV2KSB7DQogICAgICAgIHRoaXMucHVibGljbHlUcmlnZ2VyKCdldmVudERyb3AnLCB7DQogICAgICAgICAgICBjb250ZXh0OiBlbFswXSwNCiAgICAgICAgICAgIGFyZ3M6IFsNCiAgICAgICAgICAgICAgICBldmVudEluc3RhbmNlLnRvTGVnYWN5KCksDQogICAgICAgICAgICAgICAgZGF0ZURlbHRhLA0KICAgICAgICAgICAgICAgIHVuZG9GdW5jLA0KICAgICAgICAgICAgICAgIGV2LA0KICAgICAgICAgICAgICAgIHt9LA0KICAgICAgICAgICAgICAgIHRoaXMNCiAgICAgICAgICAgIF0NCiAgICAgICAgfSk7DQogICAgfTsNCiAgICAvKiBFeHRlcm5hbCBFbGVtZW50IERyYWctbi1Ecm9wDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICAvLyBNdXN0IGJlIGNhbGxlZCB3aGVuIGFuIGV4dGVybmFsIGVsZW1lbnQsIHZpYSBqUXVlcnkgVUksIGhhcyBiZWVuIGRyb3BwZWQgb250byB0aGUgY2FsZW5kYXIuDQogICAgLy8gYG1ldGFgIGlzIHRoZSBwYXJzZWQgZGF0YSB0aGF0IGhhcyBiZWVuIGVtYmVkZGVkIGludG8gdGhlIGRyYWdnaW5nIGV2ZW50Lg0KICAgIC8vIGBkcm9wTG9jYXRpb25gIGlzIGFuIG9iamVjdCB0aGF0IGNvbnRhaW5zIHRoZSBuZXcgem9uZWQgc3RhcnQvZW5kL2FsbERheSB2YWx1ZXMgZm9yIHRoZSBldmVudC4NCiAgICBWaWV3LnByb3RvdHlwZS5yZXBvcnRFeHRlcm5hbERyb3AgPSBmdW5jdGlvbiAoc2luZ2xlRXZlbnREZWYsIGlzRXZlbnQsIGlzU3RpY2t5LCBlbCwgZXYsIHVpKSB7DQogICAgICAgIGlmIChpc0V2ZW50KSB7DQogICAgICAgICAgICB0aGlzLmNhbGVuZGFyLmV2ZW50TWFuYWdlci5hZGRFdmVudERlZihzaW5nbGVFdmVudERlZiwgaXNTdGlja3kpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMudHJpZ2dlckV4dGVybmFsRHJvcChzaW5nbGVFdmVudERlZiwgaXNFdmVudCwgZWwsIGV2LCB1aSk7DQogICAgfTsNCiAgICAvLyBUcmlnZ2VycyBleHRlcm5hbC1kcm9wIGhhbmRsZXJzIHRoYXQgaGF2ZSBzdWJzY3JpYmVkIHZpYSB0aGUgQVBJDQogICAgVmlldy5wcm90b3R5cGUudHJpZ2dlckV4dGVybmFsRHJvcCA9IGZ1bmN0aW9uIChzaW5nbGVFdmVudERlZiwgaXNFdmVudCwgZWwsIGV2LCB1aSkgew0KICAgICAgICAvLyB0cmlnZ2VyICdkcm9wJyByZWdhcmRsZXNzIG9mIHdoZXRoZXIgZWxlbWVudCByZXByZXNlbnRzIGFuIGV2ZW50DQogICAgICAgIHRoaXMucHVibGljbHlUcmlnZ2VyKCdkcm9wJywgew0KICAgICAgICAgICAgY29udGV4dDogZWxbMF0sDQogICAgICAgICAgICBhcmdzOiBbDQogICAgICAgICAgICAgICAgc2luZ2xlRXZlbnREZWYuZGF0ZVByb2ZpbGUuc3RhcnQuY2xvbmUoKSwNCiAgICAgICAgICAgICAgICBldiwNCiAgICAgICAgICAgICAgICB1aSwNCiAgICAgICAgICAgICAgICB0aGlzDQogICAgICAgICAgICBdDQogICAgICAgIH0pOw0KICAgICAgICBpZiAoaXNFdmVudCkgew0KICAgICAgICAgICAgLy8gc2lnbmFsIGFuIGV4dGVybmFsIGV2ZW50IGxhbmRlZA0KICAgICAgICAgICAgdGhpcy5wdWJsaWNseVRyaWdnZXIoJ2V2ZW50UmVjZWl2ZScsIHsNCiAgICAgICAgICAgICAgICBjb250ZXh0OiB0aGlzLA0KICAgICAgICAgICAgICAgIGFyZ3M6IFsNCiAgICAgICAgICAgICAgICAgICAgc2luZ2xlRXZlbnREZWYuYnVpbGRJbnN0YW5jZSgpLnRvTGVnYWN5KCksDQogICAgICAgICAgICAgICAgICAgIHRoaXMNCiAgICAgICAgICAgICAgICBdDQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLyogRXZlbnQgUmVzaXppbmcNCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KICAgIC8vIE11c3QgYmUgY2FsbGVkIHdoZW4gYW4gZXZlbnQgaW4gdGhlIHZpZXcgaGFzIGJlZW4gcmVzaXplZCB0byBhIG5ldyBsZW5ndGgNCiAgICBWaWV3LnByb3RvdHlwZS5yZXBvcnRFdmVudFJlc2l6ZSA9IGZ1bmN0aW9uIChldmVudEluc3RhbmNlLCBldmVudE11dGF0aW9uLCBlbCwgZXYpIHsNCiAgICAgICAgdmFyIGV2ZW50TWFuYWdlciA9IHRoaXMuY2FsZW5kYXIuZXZlbnRNYW5hZ2VyOw0KICAgICAgICB2YXIgdW5kb0Z1bmMgPSBldmVudE1hbmFnZXIubXV0YXRlRXZlbnRzV2l0aElkKGV2ZW50SW5zdGFuY2UuZGVmLmlkLCBldmVudE11dGF0aW9uKTsNCiAgICAgICAgLy8gdXBkYXRlIHRoZSBFdmVudEluc3RhbmNlLCBmb3IgaGFuZGxlcnMNCiAgICAgICAgZXZlbnRJbnN0YW5jZS5kYXRlUHJvZmlsZSA9IGV2ZW50TXV0YXRpb24uZGF0ZU11dGF0aW9uLmJ1aWxkTmV3RGF0ZVByb2ZpbGUoZXZlbnRJbnN0YW5jZS5kYXRlUHJvZmlsZSwgdGhpcy5jYWxlbmRhcik7DQogICAgICAgIHRoaXMudHJpZ2dlckV2ZW50UmVzaXplKGV2ZW50SW5zdGFuY2UsIGV2ZW50TXV0YXRpb24uZGF0ZU11dGF0aW9uLmVuZERlbHRhLCB1bmRvRnVuYywgZWwsIGV2KTsNCiAgICB9Ow0KICAgIC8vIFRyaWdnZXJzIGV2ZW50LXJlc2l6ZSBoYW5kbGVycyB0aGF0IGhhdmUgc3Vic2NyaWJlZCB2aWEgdGhlIEFQSQ0KICAgIFZpZXcucHJvdG90eXBlLnRyaWdnZXJFdmVudFJlc2l6ZSA9IGZ1bmN0aW9uIChldmVudEluc3RhbmNlLCBkdXJhdGlvbkRlbHRhLCB1bmRvRnVuYywgZWwsIGV2KSB7DQogICAgICAgIHRoaXMucHVibGljbHlUcmlnZ2VyKCdldmVudFJlc2l6ZScsIHsNCiAgICAgICAgICAgIGNvbnRleHQ6IGVsWzBdLA0KICAgICAgICAgICAgYXJnczogWw0KICAgICAgICAgICAgICAgIGV2ZW50SW5zdGFuY2UudG9MZWdhY3koKSwNCiAgICAgICAgICAgICAgICBkdXJhdGlvbkRlbHRhLA0KICAgICAgICAgICAgICAgIHVuZG9GdW5jLA0KICAgICAgICAgICAgICAgIGV2LA0KICAgICAgICAgICAgICAgIHt9LA0KICAgICAgICAgICAgICAgIHRoaXMNCiAgICAgICAgICAgIF0NCiAgICAgICAgfSk7DQogICAgfTsNCiAgICAvKiBTZWxlY3Rpb24gKHRpbWUgcmFuZ2UpDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICAvLyBTZWxlY3RzIGEgZGF0ZSBzcGFuIG9uIHRoZSB2aWV3LiBgc3RhcnRgIGFuZCBgZW5kYCBhcmUgYm90aCBNb21lbnRzLg0KICAgIC8vIGBldmAgaXMgdGhlIG5hdGl2ZSBtb3VzZSBldmVudCB0aGF0IGJlZ2luIHRoZSBpbnRlcmFjdGlvbi4NCiAgICBWaWV3LnByb3RvdHlwZS5zZWxlY3QgPSBmdW5jdGlvbiAoZm9vdHByaW50LCBldikgew0KICAgICAgICB0aGlzLnVuc2VsZWN0KGV2KTsNCiAgICAgICAgdGhpcy5yZW5kZXJTZWxlY3Rpb25Gb290cHJpbnQoZm9vdHByaW50KTsNCiAgICAgICAgdGhpcy5yZXBvcnRTZWxlY3Rpb24oZm9vdHByaW50LCBldik7DQogICAgfTsNCiAgICBWaWV3LnByb3RvdHlwZS5yZW5kZXJTZWxlY3Rpb25Gb290cHJpbnQgPSBmdW5jdGlvbiAoZm9vdHByaW50KSB7DQogICAgICAgIGlmICh0aGlzWydyZW5kZXJTZWxlY3Rpb24nXSkgew0KICAgICAgICAgICAgdGhpc1sncmVuZGVyU2VsZWN0aW9uJ10oZm9vdHByaW50LnRvTGVnYWN5KHRoaXMuY2FsZW5kYXIpKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIF9zdXBlci5wcm90b3R5cGUucmVuZGVyU2VsZWN0aW9uRm9vdHByaW50LmNhbGwodGhpcywgZm9vdHByaW50KTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gQ2FsbGVkIHdoZW4gYSBuZXcgc2VsZWN0aW9uIGlzIG1hZGUuIFVwZGF0ZXMgaW50ZXJuYWwgc3RhdGUgYW5kIHRyaWdnZXJzIGhhbmRsZXJzLg0KICAgIFZpZXcucHJvdG90eXBlLnJlcG9ydFNlbGVjdGlvbiA9IGZ1bmN0aW9uIChmb290cHJpbnQsIGV2KSB7DQogICAgICAgIHRoaXMuaXNTZWxlY3RlZCA9IHRydWU7DQogICAgICAgIHRoaXMudHJpZ2dlclNlbGVjdChmb290cHJpbnQsIGV2KTsNCiAgICB9Ow0KICAgIC8vIFRyaWdnZXJzIGhhbmRsZXJzIHRvICdzZWxlY3QnDQogICAgVmlldy5wcm90b3R5cGUudHJpZ2dlclNlbGVjdCA9IGZ1bmN0aW9uIChmb290cHJpbnQsIGV2KSB7DQogICAgICAgIHZhciBkYXRlUHJvZmlsZSA9IHRoaXMuY2FsZW5kYXIuZm9vdHByaW50VG9EYXRlUHJvZmlsZShmb290cHJpbnQpOyAvLyBhYnVzZSBvZiAiRXZlbnQiRGF0ZVByb2ZpbGU/DQogICAgICAgIHRoaXMucHVibGljbHlUcmlnZ2VyKCdzZWxlY3QnLCB7DQogICAgICAgICAgICBjb250ZXh0OiB0aGlzLA0KICAgICAgICAgICAgYXJnczogWw0KICAgICAgICAgICAgICAgIGRhdGVQcm9maWxlLnN0YXJ0LA0KICAgICAgICAgICAgICAgIGRhdGVQcm9maWxlLmVuZCwNCiAgICAgICAgICAgICAgICBldiwNCiAgICAgICAgICAgICAgICB0aGlzDQogICAgICAgICAgICBdDQogICAgICAgIH0pOw0KICAgIH07DQogICAgLy8gVW5kb2VzIGEgc2VsZWN0aW9uLiB1cGRhdGVzIGluIHRoZSBpbnRlcm5hbCBzdGF0ZSBhbmQgdHJpZ2dlcnMgaGFuZGxlcnMuDQogICAgLy8gYGV2YCBpcyB0aGUgbmF0aXZlIG1vdXNlIGV2ZW50IHRoYXQgYmVnYW4gdGhlIGludGVyYWN0aW9uLg0KICAgIFZpZXcucHJvdG90eXBlLnVuc2VsZWN0ID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIGlmICh0aGlzLmlzU2VsZWN0ZWQpIHsNCiAgICAgICAgICAgIHRoaXMuaXNTZWxlY3RlZCA9IGZhbHNlOw0KICAgICAgICAgICAgaWYgKHRoaXNbJ2Rlc3Ryb3lTZWxlY3Rpb24nXSkgew0KICAgICAgICAgICAgICAgIHRoaXNbJ2Rlc3Ryb3lTZWxlY3Rpb24nXSgpOyAvLyBUT0RPOiBkZXByZWNhdGUNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMudW5yZW5kZXJTZWxlY3Rpb24oKTsNCiAgICAgICAgICAgIHRoaXMucHVibGljbHlUcmlnZ2VyKCd1bnNlbGVjdCcsIHsNCiAgICAgICAgICAgICAgICBjb250ZXh0OiB0aGlzLA0KICAgICAgICAgICAgICAgIGFyZ3M6IFtldiwgdGhpc10NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvKiBFdmVudCBTZWxlY3Rpb24NCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KICAgIFZpZXcucHJvdG90eXBlLnNlbGVjdEV2ZW50SW5zdGFuY2UgPSBmdW5jdGlvbiAoZXZlbnRJbnN0YW5jZSkgew0KICAgICAgICBpZiAoIXRoaXMuc2VsZWN0ZWRFdmVudEluc3RhbmNlIHx8DQogICAgICAgICAgICB0aGlzLnNlbGVjdGVkRXZlbnRJbnN0YW5jZSAhPT0gZXZlbnRJbnN0YW5jZSkgew0KICAgICAgICAgICAgdGhpcy51bnNlbGVjdEV2ZW50SW5zdGFuY2UoKTsNCiAgICAgICAgICAgIHRoaXMuZ2V0RXZlbnRTZWdzKCkuZm9yRWFjaChmdW5jdGlvbiAoc2VnKSB7DQogICAgICAgICAgICAgICAgaWYgKHNlZy5mb290cHJpbnQuZXZlbnRJbnN0YW5jZSA9PT0gZXZlbnRJbnN0YW5jZSAmJg0KICAgICAgICAgICAgICAgICAgICBzZWcuZWwgLy8gbmVjZXNzYXJ5Pw0KICAgICAgICAgICAgICAgICkgew0KICAgICAgICAgICAgICAgICAgICBzZWcuZWwuYWRkQ2xhc3MoJ2ZjLXNlbGVjdGVkJyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB0aGlzLnNlbGVjdGVkRXZlbnRJbnN0YW5jZSA9IGV2ZW50SW5zdGFuY2U7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIFZpZXcucHJvdG90eXBlLnVuc2VsZWN0RXZlbnRJbnN0YW5jZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWRFdmVudEluc3RhbmNlKSB7DQogICAgICAgICAgICB0aGlzLmdldEV2ZW50U2VncygpLmZvckVhY2goZnVuY3Rpb24gKHNlZykgew0KICAgICAgICAgICAgICAgIGlmIChzZWcuZWwpIHsNCiAgICAgICAgICAgICAgICAgICAgc2VnLmVsLnJlbW92ZUNsYXNzKCdmYy1zZWxlY3RlZCcpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEV2ZW50SW5zdGFuY2UgPSBudWxsOw0KICAgICAgICB9DQogICAgfTsNCiAgICBWaWV3LnByb3RvdHlwZS5pc0V2ZW50RGVmU2VsZWN0ZWQgPSBmdW5jdGlvbiAoZXZlbnREZWYpIHsNCiAgICAgICAgLy8gZXZlbnQgcmVmZXJlbmNlcyBtaWdodCBjaGFuZ2Ugb24gcmVmZXRjaEV2ZW50cygpLCB3aGlsZSBzZWxlY3RlZEV2ZW50SW5zdGFuY2UgZG9lc24ndCwNCiAgICAgICAgLy8gc28gY29tcGFyZSBJRHMNCiAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0ZWRFdmVudEluc3RhbmNlICYmIHRoaXMuc2VsZWN0ZWRFdmVudEluc3RhbmNlLmRlZi5pZCA9PT0gZXZlbnREZWYuaWQ7DQogICAgfTsNCiAgICAvKiBNb3VzZSAvIFRvdWNoIFVuc2VsZWN0aW5nICh0aW1lIHJhbmdlICYgZXZlbnQgdW5zZWxlY3Rpb24pDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICAvLyBUT0RPOiBtb3ZlIGNvbnNpc3RlbnRseSB0byBkb3duL3N0YXJ0IG9yIHVwL2VuZD8NCiAgICAvLyBUT0RPOiBkb24ndCBraWxsIHByZXZpb3VzIHNlbGVjdGlvbiBpZiB0b3VjaCBzY3JvbGxpbmcNCiAgICBWaWV3LnByb3RvdHlwZS5oYW5kbGVEb2N1bWVudE1vdXNlZG93biA9IGZ1bmN0aW9uIChldikgew0KICAgICAgICBpZiAodXRpbF8xLmlzUHJpbWFyeU1vdXNlQnV0dG9uKGV2KSkgew0KICAgICAgICAgICAgdGhpcy5wcm9jZXNzVW5zZWxlY3QoZXYpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBWaWV3LnByb3RvdHlwZS5wcm9jZXNzVW5zZWxlY3QgPSBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgdGhpcy5wcm9jZXNzUmFuZ2VVbnNlbGVjdChldik7DQogICAgICAgIHRoaXMucHJvY2Vzc0V2ZW50VW5zZWxlY3QoZXYpOw0KICAgIH07DQogICAgVmlldy5wcm90b3R5cGUucHJvY2Vzc1JhbmdlVW5zZWxlY3QgPSBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgdmFyIGlnbm9yZTsNCiAgICAgICAgLy8gaXMgdGhlcmUgYSB0aW1lLXJhbmdlIHNlbGVjdGlvbj8NCiAgICAgICAgaWYgKHRoaXMuaXNTZWxlY3RlZCAmJiB0aGlzLm9wdCgndW5zZWxlY3RBdXRvJykpIHsNCiAgICAgICAgICAgIC8vIG9ubHkgdW5zZWxlY3QgaWYgdGhlIGNsaWNrZWQgZWxlbWVudCBpcyBub3QgaWRlbnRpY2FsIHRvIG9yIGluc2lkZSBvZiBhbiAndW5zZWxlY3RDYW5jZWwnIGVsZW1lbnQNCiAgICAgICAgICAgIGlnbm9yZSA9IHRoaXMub3B0KCd1bnNlbGVjdENhbmNlbCcpOw0KICAgICAgICAgICAgaWYgKCFpZ25vcmUgfHwgISQoZXYudGFyZ2V0KS5jbG9zZXN0KGlnbm9yZSkubGVuZ3RoKSB7DQogICAgICAgICAgICAgICAgdGhpcy51bnNlbGVjdChldik7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9Ow0KICAgIFZpZXcucHJvdG90eXBlLnByb2Nlc3NFdmVudFVuc2VsZWN0ID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIGlmICh0aGlzLnNlbGVjdGVkRXZlbnRJbnN0YW5jZSkgew0KICAgICAgICAgICAgaWYgKCEkKGV2LnRhcmdldCkuY2xvc2VzdCgnLmZjLXNlbGVjdGVkJykubGVuZ3RoKSB7DQogICAgICAgICAgICAgICAgdGhpcy51bnNlbGVjdEV2ZW50SW5zdGFuY2UoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH07DQogICAgLyogVHJpZ2dlcnMNCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KICAgIFZpZXcucHJvdG90eXBlLnRyaWdnZXJCYXNlUmVuZGVyZWQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMucHVibGljbHlUcmlnZ2VyKCd2aWV3UmVuZGVyJywgew0KICAgICAgICAgICAgY29udGV4dDogdGhpcywNCiAgICAgICAgICAgIGFyZ3M6IFt0aGlzLCB0aGlzLmVsXQ0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIFZpZXcucHJvdG90eXBlLnRyaWdnZXJCYXNlVW5yZW5kZXJlZCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5wdWJsaWNseVRyaWdnZXIoJ3ZpZXdEZXN0cm95Jywgew0KICAgICAgICAgICAgY29udGV4dDogdGhpcywNCiAgICAgICAgICAgIGFyZ3M6IFt0aGlzLCB0aGlzLmVsXQ0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIC8vIFRyaWdnZXJzIGhhbmRsZXJzIHRvICdkYXlDbGljaycNCiAgICAvLyBTcGFuIGhhcyBzdGFydC9lbmQgb2YgdGhlIGNsaWNrZWQgYXJlYS4gT25seSB0aGUgc3RhcnQgaXMgdXNlZnVsLg0KICAgIFZpZXcucHJvdG90eXBlLnRyaWdnZXJEYXlDbGljayA9IGZ1bmN0aW9uIChmb290cHJpbnQsIGRheUVsLCBldikgew0KICAgICAgICB2YXIgZGF0ZVByb2ZpbGUgPSB0aGlzLmNhbGVuZGFyLmZvb3RwcmludFRvRGF0ZVByb2ZpbGUoZm9vdHByaW50KTsgLy8gYWJ1c2Ugb2YgIkV2ZW50IkRhdGVQcm9maWxlPw0KICAgICAgICB0aGlzLnB1YmxpY2x5VHJpZ2dlcignZGF5Q2xpY2snLCB7DQogICAgICAgICAgICBjb250ZXh0OiBkYXlFbCwNCiAgICAgICAgICAgIGFyZ3M6IFtkYXRlUHJvZmlsZS5zdGFydCwgZXYsIHRoaXNdDQogICAgICAgIH0pOw0KICAgIH07DQogICAgLyogRGF0ZSBVdGlscw0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgLy8gRm9yIERhdGVDb21wb25lbnQ6OmdldERheUNsYXNzZXMNCiAgICBWaWV3LnByb3RvdHlwZS5pc0RhdGVJbk90aGVyTW9udGggPSBmdW5jdGlvbiAoZGF0ZSwgZGF0ZVByb2ZpbGUpIHsNCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH07DQogICAgLy8gQXJndW1lbnRzIGFmdGVyIG5hbWUgd2lsbCBiZSBmb3J3YXJkZWQgdG8gYSBoeXBvdGhldGljYWwgZnVuY3Rpb24gdmFsdWUNCiAgICAvLyBXQVJOSU5HOiBwYXNzZWQtaW4gYXJndW1lbnRzIHdpbGwgYmUgZ2l2ZW4gdG8gZ2VuZXJhdG9yIGZ1bmN0aW9ucyBhcy1pcyBhbmQgY2FuIGNhdXNlIHNpZGUtZWZmZWN0cy4NCiAgICAvLyBBbHdheXMgY2xvbmUgeW91ciBvYmplY3RzIGlmIHlvdSBmZWFyIG11dGF0aW9uLg0KICAgIFZpZXcucHJvdG90eXBlLmdldFVuem9uZWRSYW5nZU9wdGlvbiA9IGZ1bmN0aW9uIChuYW1lKSB7DQogICAgICAgIHZhciB2YWwgPSB0aGlzLm9wdChuYW1lKTsNCiAgICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICdmdW5jdGlvbicpIHsNCiAgICAgICAgICAgIHZhbCA9IHZhbC5hcHBseShudWxsLCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAodmFsKSB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5jYWxlbmRhci5wYXJzZVVuem9uZWRSYW5nZSh2YWwpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvKiBIaWRkZW4gRGF5cw0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgLy8gSW5pdGlhbGl6ZXMgaW50ZXJuYWwgdmFyaWFibGVzIHJlbGF0ZWQgdG8gY2FsY3VsYXRpbmcgaGlkZGVuIGRheXMtb2Ytd2Vlaw0KICAgIFZpZXcucHJvdG90eXBlLmluaXRIaWRkZW5EYXlzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgaGlkZGVuRGF5cyA9IHRoaXMub3B0KCdoaWRkZW5EYXlzJykgfHwgW107IC8vIGFycmF5IG9mIGRheS1vZi13ZWVrIGluZGljZXMgdGhhdCBhcmUgaGlkZGVuDQogICAgICAgIHZhciBpc0hpZGRlbkRheUhhc2ggPSBbXTsgLy8gaXMgdGhlIGRheS1vZi13ZWVrIGhpZGRlbj8gKGhhc2ggd2l0aCBkYXktb2Ytd2Vlay1pbmRleCAtPiBib29sKQ0KICAgICAgICB2YXIgZGF5Q250ID0gMDsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIGlmICh0aGlzLm9wdCgnd2Vla2VuZHMnKSA9PT0gZmFsc2UpIHsNCiAgICAgICAgICAgIGhpZGRlbkRheXMucHVzaCgwLCA2KTsgLy8gMD1zdW5kYXksIDY9c2F0dXJkYXkNCiAgICAgICAgfQ0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgNzsgaSsrKSB7DQogICAgICAgICAgICBpZiAoIShpc0hpZGRlbkRheUhhc2hbaV0gPSAkLmluQXJyYXkoaSwgaGlkZGVuRGF5cykgIT09IC0xKSkgew0KICAgICAgICAgICAgICAgIGRheUNudCsrOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGlmICghZGF5Q250KSB7DQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgaGlkZGVuRGF5cycpOyAvLyBhbGwgZGF5cyB3ZXJlIGhpZGRlbj8gYmFkLg0KICAgICAgICB9DQogICAgICAgIHRoaXMuaXNIaWRkZW5EYXlIYXNoID0gaXNIaWRkZW5EYXlIYXNoOw0KICAgIH07DQogICAgLy8gUmVtb3ZlIGRheXMgZnJvbSB0aGUgYmVnaW5uaW5nIGFuZCBlbmQgb2YgdGhlIHJhbmdlIHRoYXQgYXJlIGNvbXB1dGVkIGFzIGhpZGRlbi4NCiAgICAvLyBJZiB0aGUgd2hvbGUgcmFuZ2UgaXMgdHJpbW1lZCBvZmYsIHJldHVybnMgbnVsbA0KICAgIFZpZXcucHJvdG90eXBlLnRyaW1IaWRkZW5EYXlzID0gZnVuY3Rpb24gKGlucHV0VW56b25lZFJhbmdlKSB7DQogICAgICAgIHZhciBzdGFydCA9IGlucHV0VW56b25lZFJhbmdlLmdldFN0YXJ0KCk7DQogICAgICAgIHZhciBlbmQgPSBpbnB1dFVuem9uZWRSYW5nZS5nZXRFbmQoKTsNCiAgICAgICAgaWYgKHN0YXJ0KSB7DQogICAgICAgICAgICBzdGFydCA9IHRoaXMuc2tpcEhpZGRlbkRheXMoc3RhcnQpOw0KICAgICAgICB9DQogICAgICAgIGlmIChlbmQpIHsNCiAgICAgICAgICAgIGVuZCA9IHRoaXMuc2tpcEhpZGRlbkRheXMoZW5kLCAtMSwgdHJ1ZSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHN0YXJ0ID09PSBudWxsIHx8IGVuZCA9PT0gbnVsbCB8fCBzdGFydCA8IGVuZCkgew0KICAgICAgICAgICAgcmV0dXJuIG5ldyBVbnpvbmVkUmFuZ2VfMS5kZWZhdWx0KHN0YXJ0LCBlbmQpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBudWxsOw0KICAgIH07DQogICAgLy8gSXMgdGhlIGN1cnJlbnQgZGF5IGhpZGRlbj8NCiAgICAvLyBgZGF5YCBpcyBhIGRheS1vZi13ZWVrIGluZGV4ICgwLTYpLCBvciBhIE1vbWVudA0KICAgIFZpZXcucHJvdG90eXBlLmlzSGlkZGVuRGF5ID0gZnVuY3Rpb24gKGRheSkgew0KICAgICAgICBpZiAobW9tZW50LmlzTW9tZW50KGRheSkpIHsNCiAgICAgICAgICAgIGRheSA9IGRheS5kYXkoKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpcy5pc0hpZGRlbkRheUhhc2hbZGF5XTsNCiAgICB9Ow0KICAgIC8vIEluY3JlbWVudGluZyB0aGUgY3VycmVudCBkYXkgdW50aWwgaXQgaXMgbm8gbG9uZ2VyIGEgaGlkZGVuIGRheSwgcmV0dXJuaW5nIGEgY29weS4NCiAgICAvLyBET0VTIE5PVCBDT05TSURFUiB2YWxpZFVuem9uZWRSYW5nZSENCiAgICAvLyBJZiB0aGUgaW5pdGlhbCB2YWx1ZSBvZiBgZGF0ZWAgaXMgbm90IGEgaGlkZGVuIGRheSwgZG9uJ3QgZG8gYW55dGhpbmcuDQogICAgLy8gUGFzcyBgaXNFeGNsdXNpdmVgIGFzIGB0cnVlYCBpZiB5b3UgYXJlIGRlYWxpbmcgd2l0aCBhbiBlbmQgZGF0ZS4NCiAgICAvLyBgaW5jYCBkZWZhdWx0cyB0byBgMWAgKGluY3JlbWVudCBvbmUgZGF5IGZvcndhcmQgZWFjaCB0aW1lKQ0KICAgIFZpZXcucHJvdG90eXBlLnNraXBIaWRkZW5EYXlzID0gZnVuY3Rpb24gKGRhdGUsIGluYywgaXNFeGNsdXNpdmUpIHsNCiAgICAgICAgaWYgKGluYyA9PT0gdm9pZCAwKSB7IGluYyA9IDE7IH0NCiAgICAgICAgaWYgKGlzRXhjbHVzaXZlID09PSB2b2lkIDApIHsgaXNFeGNsdXNpdmUgPSBmYWxzZTsgfQ0KICAgICAgICB2YXIgb3V0ID0gZGF0ZS5jbG9uZSgpOw0KICAgICAgICB3aGlsZSAodGhpcy5pc0hpZGRlbkRheUhhc2hbKG91dC5kYXkoKSArIChpc0V4Y2x1c2l2ZSA/IGluYyA6IDApICsgNykgJSA3XSkgew0KICAgICAgICAgICAgb3V0LmFkZChpbmMsICdkYXlzJyk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIG91dDsNCiAgICB9Ow0KICAgIHJldHVybiBWaWV3Ow0KfShJbnRlcmFjdGl2ZURhdGVDb21wb25lbnRfMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBWaWV3Ow0KVmlldy5wcm90b3R5cGUudXNlc01pbk1heFRpbWUgPSBmYWxzZTsNClZpZXcucHJvdG90eXBlLmRhdGVQcm9maWxlR2VuZXJhdG9yQ2xhc3MgPSBEYXRlUHJvZmlsZUdlbmVyYXRvcl8xLmRlZmF1bHQ7DQpWaWV3LndhdGNoKCdkaXNwbGF5aW5nRGF0ZXMnLCBbJ2lzSW5Eb20nLCAnZGF0ZVByb2ZpbGUnXSwgZnVuY3Rpb24gKGRlcHMpIHsNCiAgICB0aGlzLnJlcXVlc3REYXRlUmVuZGVyKGRlcHMuZGF0ZVByb2ZpbGUpOw0KfSwgZnVuY3Rpb24gKCkgew0KICAgIHRoaXMucmVxdWVzdERhdGVVbnJlbmRlcigpOw0KfSk7DQpWaWV3LndhdGNoKCdkaXNwbGF5aW5nQnVzaW5lc3NIb3VycycsIFsnZGlzcGxheWluZ0RhdGVzJywgJ2J1c2luZXNzSG91ckdlbmVyYXRvciddLCBmdW5jdGlvbiAoZGVwcykgew0KICAgIHRoaXMucmVxdWVzdEJ1c2luZXNzSG91cnNSZW5kZXIoZGVwcy5idXNpbmVzc0hvdXJHZW5lcmF0b3IpOw0KfSwgZnVuY3Rpb24gKCkgew0KICAgIHRoaXMucmVxdWVzdEJ1c2luZXNzSG91cnNVbnJlbmRlcigpOw0KfSk7DQpWaWV3LndhdGNoKCdpbml0aWFsRXZlbnRzJywgWydkYXRlUHJvZmlsZSddLCBmdW5jdGlvbiAoZGVwcykgew0KICAgIHJldHVybiB0aGlzLmZldGNoSW5pdGlhbEV2ZW50cyhkZXBzLmRhdGVQcm9maWxlKTsNCn0pOw0KVmlldy53YXRjaCgnYmluZGluZ0V2ZW50cycsIFsnaW5pdGlhbEV2ZW50cyddLCBmdW5jdGlvbiAoZGVwcykgew0KICAgIHRoaXMuc2V0RXZlbnRzKGRlcHMuaW5pdGlhbEV2ZW50cyk7DQogICAgdGhpcy5iaW5kRXZlbnRDaGFuZ2VzKCk7DQp9LCBmdW5jdGlvbiAoKSB7DQogICAgdGhpcy51bmJpbmRFdmVudENoYW5nZXMoKTsNCiAgICB0aGlzLnVuc2V0RXZlbnRzKCk7DQp9KTsNClZpZXcud2F0Y2goJ2Rpc3BsYXlpbmdFdmVudHMnLCBbJ2Rpc3BsYXlpbmdEYXRlcycsICdoYXNFdmVudHMnXSwgZnVuY3Rpb24gKCkgew0KICAgIHRoaXMucmVxdWVzdEV2ZW50c1JlbmRlcih0aGlzLmdldCgnY3VycmVudEV2ZW50cycpKTsNCn0sIGZ1bmN0aW9uICgpIHsNCiAgICB0aGlzLnJlcXVlc3RFdmVudHNVbnJlbmRlcigpOw0KfSk7DQpWaWV3LndhdGNoKCd0aXRsZScsIFsnZGF0ZVByb2ZpbGUnXSwgZnVuY3Rpb24gKGRlcHMpIHsNCiAgICByZXR1cm4gKHRoaXMudGl0bGUgPSB0aGlzLmNvbXB1dGVUaXRsZShkZXBzLmRhdGVQcm9maWxlKSk7IC8vIGFzc2lnbiB0byBWaWV3IGZvciBsZWdhY3kgcmVhc29ucw0KfSk7DQpWaWV3LndhdGNoKCdsZWdhY3lEYXRlUHJvcHMnLCBbJ2RhdGVQcm9maWxlJ10sIGZ1bmN0aW9uIChkZXBzKSB7DQogICAgdmFyIGNhbGVuZGFyID0gdGhpcy5jYWxlbmRhcjsNCiAgICB2YXIgZGF0ZVByb2ZpbGUgPSBkZXBzLmRhdGVQcm9maWxlOw0KICAgIC8vIERFUFJFQ0FURUQsIGJ1dCB3ZSBuZWVkIHRvIGtlZXAgaXQgdXBkYXRlZC4uLg0KICAgIHRoaXMuc3RhcnQgPSBjYWxlbmRhci5tc1RvTW9tZW50KGRhdGVQcm9maWxlLmFjdGl2ZVVuem9uZWRSYW5nZS5zdGFydE1zLCBkYXRlUHJvZmlsZS5pc1JhbmdlQWxsRGF5KTsNCiAgICB0aGlzLmVuZCA9IGNhbGVuZGFyLm1zVG9Nb21lbnQoZGF0ZVByb2ZpbGUuYWN0aXZlVW56b25lZFJhbmdlLmVuZE1zLCBkYXRlUHJvZmlsZS5pc1JhbmdlQWxsRGF5KTsNCiAgICB0aGlzLmludGVydmFsU3RhcnQgPSBjYWxlbmRhci5tc1RvTW9tZW50KGRhdGVQcm9maWxlLmN1cnJlbnRVbnpvbmVkUmFuZ2Uuc3RhcnRNcywgZGF0ZVByb2ZpbGUuaXNSYW5nZUFsbERheSk7DQogICAgdGhpcy5pbnRlcnZhbEVuZCA9IGNhbGVuZGFyLm1zVG9Nb21lbnQoZGF0ZVByb2ZpbGUuY3VycmVudFVuem9uZWRSYW5nZS5lbmRNcywgZGF0ZVByb2ZpbGUuaXNSYW5nZUFsbERheSk7DQp9KTsNCgoKLyoqKi8gfSksCi8qIDQyICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCnZhciBFdmVudFJlbmRlcmVyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgew0KICAgIGZ1bmN0aW9uIEV2ZW50UmVuZGVyZXIoY29tcG9uZW50LCBmaWxsUmVuZGVyZXIpIHsNCiAgICAgICAgdGhpcy52aWV3ID0gY29tcG9uZW50Ll9nZXRWaWV3KCk7DQogICAgICAgIHRoaXMuY29tcG9uZW50ID0gY29tcG9uZW50Ow0KICAgICAgICB0aGlzLmZpbGxSZW5kZXJlciA9IGZpbGxSZW5kZXJlcjsNCiAgICB9DQogICAgRXZlbnRSZW5kZXJlci5wcm90b3R5cGUub3B0ID0gZnVuY3Rpb24gKG5hbWUpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMudmlldy5vcHQobmFtZSk7DQogICAgfTsNCiAgICAvLyBVcGRhdGVzIHZhbHVlcyB0aGF0IHJlbHkgb24gb3B0aW9ucyBhbmQgYWxzbyByZWxhdGUgdG8gcmFuZ2UNCiAgICBFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5yYW5nZVVwZGF0ZWQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBkaXNwbGF5RXZlbnRUaW1lOw0KICAgICAgICB2YXIgZGlzcGxheUV2ZW50RW5kOw0KICAgICAgICB0aGlzLmV2ZW50VGltZUZvcm1hdCA9DQogICAgICAgICAgICB0aGlzLm9wdCgnZXZlbnRUaW1lRm9ybWF0JykgfHwNCiAgICAgICAgICAgICAgICB0aGlzLm9wdCgndGltZUZvcm1hdCcpIHx8IC8vIGRlcHJlY2F0ZWQNCiAgICAgICAgICAgICAgICB0aGlzLmNvbXB1dGVFdmVudFRpbWVGb3JtYXQoKTsNCiAgICAgICAgZGlzcGxheUV2ZW50VGltZSA9IHRoaXMub3B0KCdkaXNwbGF5RXZlbnRUaW1lJyk7DQogICAgICAgIGlmIChkaXNwbGF5RXZlbnRUaW1lID09IG51bGwpIHsNCiAgICAgICAgICAgIGRpc3BsYXlFdmVudFRpbWUgPSB0aGlzLmNvbXB1dGVEaXNwbGF5RXZlbnRUaW1lKCk7IC8vIG1pZ2h0IGJlIGJhc2VkIG9mZiBvZiByYW5nZQ0KICAgICAgICB9DQogICAgICAgIGRpc3BsYXlFdmVudEVuZCA9IHRoaXMub3B0KCdkaXNwbGF5RXZlbnRFbmQnKTsNCiAgICAgICAgaWYgKGRpc3BsYXlFdmVudEVuZCA9PSBudWxsKSB7DQogICAgICAgICAgICBkaXNwbGF5RXZlbnRFbmQgPSB0aGlzLmNvbXB1dGVEaXNwbGF5RXZlbnRFbmQoKTsgLy8gbWlnaHQgYmUgYmFzZWQgb2ZmIG9mIHJhbmdlDQogICAgICAgIH0NCiAgICAgICAgdGhpcy5kaXNwbGF5RXZlbnRUaW1lID0gZGlzcGxheUV2ZW50VGltZTsNCiAgICAgICAgdGhpcy5kaXNwbGF5RXZlbnRFbmQgPSBkaXNwbGF5RXZlbnRFbmQ7DQogICAgfTsNCiAgICBFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoZXZlbnRzUGF5bG9hZCkgew0KICAgICAgICB2YXIgZGF0ZVByb2ZpbGUgPSB0aGlzLmNvbXBvbmVudC5fZ2V0RGF0ZVByb2ZpbGUoKTsNCiAgICAgICAgdmFyIGV2ZW50RGVmSWQ7DQogICAgICAgIHZhciBpbnN0YW5jZUdyb3VwOw0KICAgICAgICB2YXIgZXZlbnRSYW5nZXM7DQogICAgICAgIHZhciBiZ1JhbmdlcyA9IFtdOw0KICAgICAgICB2YXIgZmdSYW5nZXMgPSBbXTsNCiAgICAgICAgZm9yIChldmVudERlZklkIGluIGV2ZW50c1BheWxvYWQpIHsNCiAgICAgICAgICAgIGluc3RhbmNlR3JvdXAgPSBldmVudHNQYXlsb2FkW2V2ZW50RGVmSWRdOw0KICAgICAgICAgICAgZXZlbnRSYW5nZXMgPSBpbnN0YW5jZUdyb3VwLnNsaWNlUmVuZGVyUmFuZ2VzKGRhdGVQcm9maWxlLmFjdGl2ZVVuem9uZWRSYW5nZSk7DQogICAgICAgICAgICBpZiAoaW5zdGFuY2VHcm91cC5nZXRFdmVudERlZigpLmhhc0JnUmVuZGVyaW5nKCkpIHsNCiAgICAgICAgICAgICAgICBiZ1Jhbmdlcy5wdXNoLmFwcGx5KGJnUmFuZ2VzLCBldmVudFJhbmdlcyk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICBmZ1Jhbmdlcy5wdXNoLmFwcGx5KGZnUmFuZ2VzLCBldmVudFJhbmdlcyk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5yZW5kZXJCZ1JhbmdlcyhiZ1Jhbmdlcyk7DQogICAgICAgIHRoaXMucmVuZGVyRmdSYW5nZXMoZmdSYW5nZXMpOw0KICAgIH07DQogICAgRXZlbnRSZW5kZXJlci5wcm90b3R5cGUudW5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMudW5yZW5kZXJCZ1JhbmdlcygpOw0KICAgICAgICB0aGlzLnVucmVuZGVyRmdSYW5nZXMoKTsNCiAgICB9Ow0KICAgIEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLnJlbmRlckZnUmFuZ2VzID0gZnVuY3Rpb24gKGV2ZW50UmFuZ2VzKSB7DQogICAgICAgIHZhciBldmVudEZvb3RwcmludHMgPSB0aGlzLmNvbXBvbmVudC5ldmVudFJhbmdlc1RvRXZlbnRGb290cHJpbnRzKGV2ZW50UmFuZ2VzKTsNCiAgICAgICAgdmFyIHNlZ3MgPSB0aGlzLmNvbXBvbmVudC5ldmVudEZvb3RwcmludHNUb1NlZ3MoZXZlbnRGb290cHJpbnRzKTsNCiAgICAgICAgLy8gcmVuZGVyIGFuIGAuZWxgIG9uIGVhY2ggc2VnDQogICAgICAgIC8vIHJldHVybnMgYSBzdWJzZXQgb2YgdGhlIHNlZ3MuIHNlZ3MgdGhhdCB3ZXJlIGFjdHVhbGx5IHJlbmRlcmVkDQogICAgICAgIHNlZ3MgPSB0aGlzLnJlbmRlckZnU2VnRWxzKHNlZ3MpOw0KICAgICAgICBpZiAodGhpcy5yZW5kZXJGZ1NlZ3Moc2VncykgIT09IGZhbHNlKSB7DQogICAgICAgICAgICB0aGlzLmZnU2VncyA9IHNlZ3M7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLnVucmVuZGVyRmdSYW5nZXMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMudW5yZW5kZXJGZ1NlZ3ModGhpcy5mZ1NlZ3MgfHwgW10pOw0KICAgICAgICB0aGlzLmZnU2VncyA9IG51bGw7DQogICAgfTsNCiAgICBFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJCZ1JhbmdlcyA9IGZ1bmN0aW9uIChldmVudFJhbmdlcykgew0KICAgICAgICB2YXIgZXZlbnRGb290cHJpbnRzID0gdGhpcy5jb21wb25lbnQuZXZlbnRSYW5nZXNUb0V2ZW50Rm9vdHByaW50cyhldmVudFJhbmdlcyk7DQogICAgICAgIHZhciBzZWdzID0gdGhpcy5jb21wb25lbnQuZXZlbnRGb290cHJpbnRzVG9TZWdzKGV2ZW50Rm9vdHByaW50cyk7DQogICAgICAgIGlmICh0aGlzLnJlbmRlckJnU2VncyhzZWdzKSAhPT0gZmFsc2UpIHsNCiAgICAgICAgICAgIHRoaXMuYmdTZWdzID0gc2VnczsNCiAgICAgICAgfQ0KICAgIH07DQogICAgRXZlbnRSZW5kZXJlci5wcm90b3R5cGUudW5yZW5kZXJCZ1JhbmdlcyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy51bnJlbmRlckJnU2VncygpOw0KICAgICAgICB0aGlzLmJnU2VncyA9IG51bGw7DQogICAgfTsNCiAgICBFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5nZXRTZWdzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gKHRoaXMuYmdTZWdzIHx8IFtdKS5jb25jYXQodGhpcy5mZ1NlZ3MgfHwgW10pOw0KICAgIH07DQogICAgLy8gUmVuZGVycyBmb3JlZ3JvdW5kIGV2ZW50IHNlZ21lbnRzIG9udG8gdGhlIGdyaWQNCiAgICBFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJGZ1NlZ3MgPSBmdW5jdGlvbiAoc2Vncykgew0KICAgICAgICAvLyBzdWJjbGFzc2VzIG11c3QgaW1wbGVtZW50DQogICAgICAgIC8vIHNlZ3MgYWxyZWFkeSBoYXMgcmVuZGVyZWQgZWxzLCBhbmQgaGFzIGJlZW4gZmlsdGVyZWQuDQogICAgICAgIHJldHVybiBmYWxzZTsgLy8gc2lnbmFsIGZhaWx1cmUgaWYgbm90IGltcGxlbWVudGVkDQogICAgfTsNCiAgICAvLyBVbnJlbmRlcnMgYWxsIGN1cnJlbnRseSByZW5kZXJlZCBmb3JlZ3JvdW5kIHNlZ21lbnRzDQogICAgRXZlbnRSZW5kZXJlci5wcm90b3R5cGUudW5yZW5kZXJGZ1NlZ3MgPSBmdW5jdGlvbiAoc2Vncykgew0KICAgICAgICAvLyBzdWJjbGFzc2VzIG11c3QgaW1wbGVtZW50DQogICAgfTsNCiAgICBFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJCZ1NlZ3MgPSBmdW5jdGlvbiAoc2Vncykgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICBpZiAodGhpcy5maWxsUmVuZGVyZXIpIHsNCiAgICAgICAgICAgIHRoaXMuZmlsbFJlbmRlcmVyLnJlbmRlclNlZ3MoJ2JnRXZlbnQnLCBzZWdzLCB7DQogICAgICAgICAgICAgICAgZ2V0Q2xhc3NlczogZnVuY3Rpb24gKHNlZykgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuZ2V0QmdDbGFzc2VzKHNlZy5mb290cHJpbnQuZXZlbnREZWYpOw0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgZ2V0Q3NzOiBmdW5jdGlvbiAoc2VnKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiB7DQogICAgICAgICAgICAgICAgICAgICAgICAnYmFja2dyb3VuZC1jb2xvcic6IF90aGlzLmdldEJnQ29sb3Ioc2VnLmZvb3RwcmludC5ldmVudERlZikNCiAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIGZpbHRlckVsOiBmdW5jdGlvbiAoc2VnLCBlbCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuZmlsdGVyRXZlbnRSZW5kZXJFbChzZWcuZm9vdHByaW50LCBlbCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIHNpZ25hbCBmYWlsdXJlIGlmIG5vIGZpbGxSZW5kZXJlcg0KICAgICAgICB9DQogICAgfTsNCiAgICBFdmVudFJlbmRlcmVyLnByb3RvdHlwZS51bnJlbmRlckJnU2VncyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMuZmlsbFJlbmRlcmVyKSB7DQogICAgICAgICAgICB0aGlzLmZpbGxSZW5kZXJlci51bnJlbmRlcignYmdFdmVudCcpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBSZW5kZXJzIGFuZCBhc3NpZ25zIGFuIGBlbGAgcHJvcGVydHkgZm9yIGVhY2ggZm9yZWdyb3VuZCBldmVudCBzZWdtZW50Lg0KICAgIC8vIE9ubHkgcmV0dXJucyBzZWdtZW50cyB0aGF0IHN1Y2Nlc3NmdWxseSByZW5kZXJlZC4NCiAgICBFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJGZ1NlZ0VscyA9IGZ1bmN0aW9uIChzZWdzLCBkaXNhYmxlUmVzaXppbmcpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgaWYgKGRpc2FibGVSZXNpemluZyA9PT0gdm9pZCAwKSB7IGRpc2FibGVSZXNpemluZyA9IGZhbHNlOyB9DQogICAgICAgIHZhciBoYXNFdmVudFJlbmRlckhhbmRsZXJzID0gdGhpcy52aWV3Lmhhc1B1YmxpY0hhbmRsZXJzKCdldmVudFJlbmRlcicpOw0KICAgICAgICB2YXIgaHRtbCA9ICcnOw0KICAgICAgICB2YXIgcmVuZGVyZWRTZWdzID0gW107DQogICAgICAgIHZhciBpOw0KICAgICAgICBpZiAoc2Vncy5sZW5ndGgpIHsNCiAgICAgICAgICAgIC8vIGJ1aWxkIGEgbGFyZ2UgY29uY2F0ZW5hdGlvbiBvZiBldmVudCBzZWdtZW50IEhUTUwNCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZWdzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgICAgdGhpcy5iZWZvcmVGZ1NlZ0h0bWwoc2Vnc1tpXSk7DQogICAgICAgICAgICAgICAgaHRtbCArPSB0aGlzLmZnU2VnSHRtbChzZWdzW2ldLCBkaXNhYmxlUmVzaXppbmcpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgLy8gR3JhYiBpbmRpdmlkdWFsIGVsZW1lbnRzIGZyb20gdGhlIGNvbWJpbmVkIEhUTUwgc3RyaW5nLiBVc2UgZWFjaCBhcyB0aGUgZGVmYXVsdCByZW5kZXJpbmcuDQogICAgICAgICAgICAvLyBUaGVuLCBjb21wdXRlIHRoZSAnZWwnIGZvciBlYWNoIHNlZ21lbnQuIEFuIGVsIG1pZ2h0IGJlIG51bGwgaWYgdGhlIGV2ZW50UmVuZGVyIGNhbGxiYWNrIHJldHVybmVkIGZhbHNlLg0KICAgICAgICAgICAgJChodG1sKS5lYWNoKGZ1bmN0aW9uIChpLCBub2RlKSB7DQogICAgICAgICAgICAgICAgdmFyIHNlZyA9IHNlZ3NbaV07DQogICAgICAgICAgICAgICAgdmFyIGVsID0gJChub2RlKTsNCiAgICAgICAgICAgICAgICBpZiAoaGFzRXZlbnRSZW5kZXJIYW5kbGVycykgew0KICAgICAgICAgICAgICAgICAgICBlbCA9IF90aGlzLmZpbHRlckV2ZW50UmVuZGVyRWwoc2VnLmZvb3RwcmludCwgZWwpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZiAoZWwpIHsNCiAgICAgICAgICAgICAgICAgICAgZWwuZGF0YSgnZmMtc2VnJywgc2VnKTsgLy8gdXNlZCBieSBoYW5kbGVycw0KICAgICAgICAgICAgICAgICAgICBzZWcuZWwgPSBlbDsNCiAgICAgICAgICAgICAgICAgICAgcmVuZGVyZWRTZWdzLnB1c2goc2VnKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmVuZGVyZWRTZWdzOw0KICAgIH07DQogICAgRXZlbnRSZW5kZXJlci5wcm90b3R5cGUuYmVmb3JlRmdTZWdIdG1sID0gZnVuY3Rpb24gKHNlZykgew0KICAgIH07DQogICAgLy8gR2VuZXJhdGVzIHRoZSBIVE1MIGZvciB0aGUgZGVmYXVsdCByZW5kZXJpbmcgb2YgYSBmb3JlZ3JvdW5kIGV2ZW50IHNlZ21lbnQuIFVzZWQgYnkgcmVuZGVyRmdTZWdFbHMoKQ0KICAgIEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLmZnU2VnSHRtbCA9IGZ1bmN0aW9uIChzZWcsIGRpc2FibGVSZXNpemluZykgew0KICAgICAgICAvLyBzdWJjbGFzc2VzIHNob3VsZCBpbXBsZW1lbnQNCiAgICB9Ow0KICAgIC8vIEdlbmVyaWMgdXRpbGl0eSBmb3IgZ2VuZXJhdGluZyB0aGUgSFRNTCBjbGFzc05hbWVzIGZvciBhbiBldmVudCBzZWdtZW50J3MgZWxlbWVudA0KICAgIEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLmdldFNlZ0NsYXNzZXMgPSBmdW5jdGlvbiAoc2VnLCBpc0RyYWdnYWJsZSwgaXNSZXNpemFibGUpIHsNCiAgICAgICAgdmFyIGNsYXNzZXMgPSBbDQogICAgICAgICAgICAnZmMtZXZlbnQnLA0KICAgICAgICAgICAgc2VnLmlzU3RhcnQgPyAnZmMtc3RhcnQnIDogJ2ZjLW5vdC1zdGFydCcsDQogICAgICAgICAgICBzZWcuaXNFbmQgPyAnZmMtZW5kJyA6ICdmYy1ub3QtZW5kJw0KICAgICAgICBdLmNvbmNhdCh0aGlzLmdldENsYXNzZXMoc2VnLmZvb3RwcmludC5ldmVudERlZikpOw0KICAgICAgICBpZiAoaXNEcmFnZ2FibGUpIHsNCiAgICAgICAgICAgIGNsYXNzZXMucHVzaCgnZmMtZHJhZ2dhYmxlJyk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKGlzUmVzaXphYmxlKSB7DQogICAgICAgICAgICBjbGFzc2VzLnB1c2goJ2ZjLXJlc2l6YWJsZScpOw0KICAgICAgICB9DQogICAgICAgIC8vIGV2ZW50IGlzIGN1cnJlbnRseSBzZWxlY3RlZD8gYXR0YWNoIGEgY2xhc3NOYW1lLg0KICAgICAgICBpZiAodGhpcy52aWV3LmlzRXZlbnREZWZTZWxlY3RlZChzZWcuZm9vdHByaW50LmV2ZW50RGVmKSkgew0KICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKCdmYy1zZWxlY3RlZCcpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBjbGFzc2VzOw0KICAgIH07DQogICAgLy8gR2l2ZW4gYW4gZXZlbnQgYW5kIHRoZSBkZWZhdWx0IGVsZW1lbnQgdXNlZCBmb3IgcmVuZGVyaW5nLCByZXR1cm5zIHRoZSBlbGVtZW50IHRoYXQgc2hvdWxkIGFjdHVhbGx5IGJlIHVzZWQuDQogICAgLy8gQmFzaWNhbGx5IHJ1bnMgZXZlbnRzIGFuZCBlbGVtZW50cyB0aHJvdWdoIHRoZSBldmVudFJlbmRlciBob29rLg0KICAgIEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLmZpbHRlckV2ZW50UmVuZGVyRWwgPSBmdW5jdGlvbiAoZXZlbnRGb290cHJpbnQsIGVsKSB7DQogICAgICAgIHZhciBsZWdhY3kgPSBldmVudEZvb3RwcmludC5nZXRFdmVudExlZ2FjeSgpOw0KICAgICAgICB2YXIgY3VzdG9tID0gdGhpcy52aWV3LnB1YmxpY2x5VHJpZ2dlcignZXZlbnRSZW5kZXInLCB7DQogICAgICAgICAgICBjb250ZXh0OiBsZWdhY3ksDQogICAgICAgICAgICBhcmdzOiBbbGVnYWN5LCBlbCwgdGhpcy52aWV3XQ0KICAgICAgICB9KTsNCiAgICAgICAgaWYgKGN1c3RvbSA9PT0gZmFsc2UpIHsNCiAgICAgICAgICAgIGVsID0gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmIChjdXN0b20gJiYgY3VzdG9tICE9PSB0cnVlKSB7DQogICAgICAgICAgICBlbCA9ICQoY3VzdG9tKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZWw7DQogICAgfTsNCiAgICAvLyBDb21wdXRlIHRoZSB0ZXh0IHRoYXQgc2hvdWxkIGJlIGRpc3BsYXllZCBvbiBhbiBldmVudCdzIGVsZW1lbnQuDQogICAgLy8gYHJhbmdlYCBjYW4gYmUgdGhlIEV2ZW50IG9iamVjdCBpdHNlbGYsIG9yIHNvbWV0aGluZyByYW5nZS1saWtlLCB3aXRoIGF0IGxlYXN0IGEgYHN0YXJ0YC4NCiAgICAvLyBJZiBldmVudCB0aW1lcyBhcmUgZGlzYWJsZWQsIG9yIHRoZSBldmVudCBoYXMgbm8gdGltZSwgd2lsbCByZXR1cm4gYSBibGFuayBzdHJpbmcuDQogICAgLy8gSWYgbm90IHNwZWNpZmllZCwgZm9ybWF0U3RyIHdpbGwgZGVmYXVsdCB0byB0aGUgZXZlbnRUaW1lRm9ybWF0IHNldHRpbmcsDQogICAgLy8gYW5kIGRpc3BsYXlFbmQgd2lsbCBkZWZhdWx0IHRvIHRoZSBkaXNwbGF5RXZlbnRFbmQgc2V0dGluZy4NCiAgICBFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5nZXRUaW1lVGV4dCA9IGZ1bmN0aW9uIChldmVudEZvb3RwcmludCwgZm9ybWF0U3RyLCBkaXNwbGF5RW5kKSB7DQogICAgICAgIHJldHVybiB0aGlzLl9nZXRUaW1lVGV4dChldmVudEZvb3RwcmludC5ldmVudEluc3RhbmNlLmRhdGVQcm9maWxlLnN0YXJ0LCBldmVudEZvb3RwcmludC5ldmVudEluc3RhbmNlLmRhdGVQcm9maWxlLmVuZCwgZXZlbnRGb290cHJpbnQuY29tcG9uZW50Rm9vdHByaW50LmlzQWxsRGF5LCBmb3JtYXRTdHIsIGRpc3BsYXlFbmQpOw0KICAgIH07DQogICAgRXZlbnRSZW5kZXJlci5wcm90b3R5cGUuX2dldFRpbWVUZXh0ID0gZnVuY3Rpb24gKHN0YXJ0LCBlbmQsIGlzQWxsRGF5LCBmb3JtYXRTdHIsIGRpc3BsYXlFbmQpIHsNCiAgICAgICAgaWYgKGZvcm1hdFN0ciA9PSBudWxsKSB7DQogICAgICAgICAgICBmb3JtYXRTdHIgPSB0aGlzLmV2ZW50VGltZUZvcm1hdDsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoZGlzcGxheUVuZCA9PSBudWxsKSB7DQogICAgICAgICAgICBkaXNwbGF5RW5kID0gdGhpcy5kaXNwbGF5RXZlbnRFbmQ7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHRoaXMuZGlzcGxheUV2ZW50VGltZSAmJiAhaXNBbGxEYXkpIHsNCiAgICAgICAgICAgIGlmIChkaXNwbGF5RW5kICYmIGVuZCkgew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnZpZXcuZm9ybWF0UmFuZ2UoeyBzdGFydDogc3RhcnQsIGVuZDogZW5kIH0sIGZhbHNlLCAvLyBhbGxEYXkNCiAgICAgICAgICAgICAgICBmb3JtYXRTdHIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIHN0YXJ0LmZvcm1hdChmb3JtYXRTdHIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiAnJzsNCiAgICB9Ow0KICAgIEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLmNvbXB1dGVFdmVudFRpbWVGb3JtYXQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHJldHVybiB0aGlzLm9wdCgnc21hbGxUaW1lRm9ybWF0Jyk7DQogICAgfTsNCiAgICBFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5jb21wdXRlRGlzcGxheUV2ZW50VGltZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgfTsNCiAgICBFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5jb21wdXRlRGlzcGxheUV2ZW50RW5kID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9Ow0KICAgIEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLmdldEJnQ2xhc3NlcyA9IGZ1bmN0aW9uIChldmVudERlZikgew0KICAgICAgICB2YXIgY2xhc3NOYW1lcyA9IHRoaXMuZ2V0Q2xhc3NlcyhldmVudERlZik7DQogICAgICAgIGNsYXNzTmFtZXMucHVzaCgnZmMtYmdldmVudCcpOw0KICAgICAgICByZXR1cm4gY2xhc3NOYW1lczsNCiAgICB9Ow0KICAgIEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLmdldENsYXNzZXMgPSBmdW5jdGlvbiAoZXZlbnREZWYpIHsNCiAgICAgICAgdmFyIG9ianMgPSB0aGlzLmdldFN0eWxpbmdPYmpzKGV2ZW50RGVmKTsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIHZhciBjbGFzc05hbWVzID0gW107DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBvYmpzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBjbGFzc05hbWVzLnB1c2guYXBwbHkoLy8gYXBwZW5kDQogICAgICAgICAgICBjbGFzc05hbWVzLCBvYmpzW2ldLmV2ZW50Q2xhc3NOYW1lIHx8IG9ianNbaV0uY2xhc3NOYW1lIHx8IFtdKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gY2xhc3NOYW1lczsNCiAgICB9Ow0KICAgIC8vIFV0aWxpdHkgZm9yIGdlbmVyYXRpbmcgZXZlbnQgc2tpbi1yZWxhdGVkIENTUyBwcm9wZXJ0aWVzDQogICAgRXZlbnRSZW5kZXJlci5wcm90b3R5cGUuZ2V0U2tpbkNzcyA9IGZ1bmN0aW9uIChldmVudERlZikgew0KICAgICAgICByZXR1cm4gew0KICAgICAgICAgICAgJ2JhY2tncm91bmQtY29sb3InOiB0aGlzLmdldEJnQ29sb3IoZXZlbnREZWYpLA0KICAgICAgICAgICAgJ2JvcmRlci1jb2xvcic6IHRoaXMuZ2V0Qm9yZGVyQ29sb3IoZXZlbnREZWYpLA0KICAgICAgICAgICAgY29sb3I6IHRoaXMuZ2V0VGV4dENvbG9yKGV2ZW50RGVmKQ0KICAgICAgICB9Ow0KICAgIH07DQogICAgLy8gUXVlcmllcyBmb3IgY2FsbGVyLXNwZWNpZmllZCBjb2xvciwgdGhlbiBmYWxscyBiYWNrIHRvIGRlZmF1bHQNCiAgICBFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5nZXRCZ0NvbG9yID0gZnVuY3Rpb24gKGV2ZW50RGVmKSB7DQogICAgICAgIHZhciBvYmpzID0gdGhpcy5nZXRTdHlsaW5nT2JqcyhldmVudERlZik7DQogICAgICAgIHZhciBpOw0KICAgICAgICB2YXIgdmFsOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgb2Jqcy5sZW5ndGggJiYgIXZhbDsgaSsrKSB7DQogICAgICAgICAgICB2YWwgPSBvYmpzW2ldLmV2ZW50QmFja2dyb3VuZENvbG9yIHx8IG9ianNbaV0uZXZlbnRDb2xvciB8fA0KICAgICAgICAgICAgICAgIG9ianNbaV0uYmFja2dyb3VuZENvbG9yIHx8IG9ianNbaV0uY29sb3I7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCF2YWwpIHsNCiAgICAgICAgICAgIHZhbCA9IHRoaXMub3B0KCdldmVudEJhY2tncm91bmRDb2xvcicpIHx8IHRoaXMub3B0KCdldmVudENvbG9yJyk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHZhbDsNCiAgICB9Ow0KICAgIC8vIFF1ZXJpZXMgZm9yIGNhbGxlci1zcGVjaWZpZWQgY29sb3IsIHRoZW4gZmFsbHMgYmFjayB0byBkZWZhdWx0DQogICAgRXZlbnRSZW5kZXJlci5wcm90b3R5cGUuZ2V0Qm9yZGVyQ29sb3IgPSBmdW5jdGlvbiAoZXZlbnREZWYpIHsNCiAgICAgICAgdmFyIG9ianMgPSB0aGlzLmdldFN0eWxpbmdPYmpzKGV2ZW50RGVmKTsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIHZhciB2YWw7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBvYmpzLmxlbmd0aCAmJiAhdmFsOyBpKyspIHsNCiAgICAgICAgICAgIHZhbCA9IG9ianNbaV0uZXZlbnRCb3JkZXJDb2xvciB8fCBvYmpzW2ldLmV2ZW50Q29sb3IgfHwNCiAgICAgICAgICAgICAgICBvYmpzW2ldLmJvcmRlckNvbG9yIHx8IG9ianNbaV0uY29sb3I7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCF2YWwpIHsNCiAgICAgICAgICAgIHZhbCA9IHRoaXMub3B0KCdldmVudEJvcmRlckNvbG9yJykgfHwgdGhpcy5vcHQoJ2V2ZW50Q29sb3InKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdmFsOw0KICAgIH07DQogICAgLy8gUXVlcmllcyBmb3IgY2FsbGVyLXNwZWNpZmllZCBjb2xvciwgdGhlbiBmYWxscyBiYWNrIHRvIGRlZmF1bHQNCiAgICBFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5nZXRUZXh0Q29sb3IgPSBmdW5jdGlvbiAoZXZlbnREZWYpIHsNCiAgICAgICAgdmFyIG9ianMgPSB0aGlzLmdldFN0eWxpbmdPYmpzKGV2ZW50RGVmKTsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIHZhciB2YWw7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBvYmpzLmxlbmd0aCAmJiAhdmFsOyBpKyspIHsNCiAgICAgICAgICAgIHZhbCA9IG9ianNbaV0uZXZlbnRUZXh0Q29sb3IgfHwNCiAgICAgICAgICAgICAgICBvYmpzW2ldLnRleHRDb2xvcjsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIXZhbCkgew0KICAgICAgICAgICAgdmFsID0gdGhpcy5vcHQoJ2V2ZW50VGV4dENvbG9yJyk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHZhbDsNCiAgICB9Ow0KICAgIEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLmdldFN0eWxpbmdPYmpzID0gZnVuY3Rpb24gKGV2ZW50RGVmKSB7DQogICAgICAgIHZhciBvYmpzID0gdGhpcy5nZXRGYWxsYmFja1N0eWxpbmdPYmpzKGV2ZW50RGVmKTsNCiAgICAgICAgb2Jqcy51bnNoaWZ0KGV2ZW50RGVmKTsNCiAgICAgICAgcmV0dXJuIG9ianM7DQogICAgfTsNCiAgICBFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5nZXRGYWxsYmFja1N0eWxpbmdPYmpzID0gZnVuY3Rpb24gKGV2ZW50RGVmKSB7DQogICAgICAgIHJldHVybiBbZXZlbnREZWYuc291cmNlXTsNCiAgICB9Ow0KICAgIEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLnNvcnRFdmVudFNlZ3MgPSBmdW5jdGlvbiAoc2Vncykgew0KICAgICAgICBzZWdzLnNvcnQodXRpbF8xLnByb3h5KHRoaXMsICdjb21wYXJlRXZlbnRTZWdzJykpOw0KICAgIH07DQogICAgLy8gQSBjbXAgZnVuY3Rpb24gZm9yIGRldGVybWluaW5nIHdoaWNoIHNlZ21lbnRzIHNob3VsZCB0YWtlIHZpc3VhbCBwcmlvcml0eQ0KICAgIEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLmNvbXBhcmVFdmVudFNlZ3MgPSBmdW5jdGlvbiAoc2VnMSwgc2VnMikgew0KICAgICAgICB2YXIgZjEgPSBzZWcxLmZvb3RwcmludDsNCiAgICAgICAgdmFyIGYyID0gc2VnMi5mb290cHJpbnQ7DQogICAgICAgIHZhciBjZjEgPSBmMS5jb21wb25lbnRGb290cHJpbnQ7DQogICAgICAgIHZhciBjZjIgPSBmMi5jb21wb25lbnRGb290cHJpbnQ7DQogICAgICAgIHZhciByMSA9IGNmMS51bnpvbmVkUmFuZ2U7DQogICAgICAgIHZhciByMiA9IGNmMi51bnpvbmVkUmFuZ2U7DQogICAgICAgIHJldHVybiByMS5zdGFydE1zIC0gcjIuc3RhcnRNcyB8fCAvLyBlYXJsaWVyIGV2ZW50cyBnbyBmaXJzdA0KICAgICAgICAgICAgKHIyLmVuZE1zIC0gcjIuc3RhcnRNcykgLSAocjEuZW5kTXMgLSByMS5zdGFydE1zKSB8fCAvLyB0aWU/IGxvbmdlciBldmVudHMgZ28gZmlyc3QNCiAgICAgICAgICAgIGNmMi5pc0FsbERheSAtIGNmMS5pc0FsbERheSB8fCAvLyB0aWU/IHB1dCBhbGwtZGF5IGV2ZW50cyBmaXJzdCAoYm9vbGVhbnMgY2FzdCB0byAwLzEpDQogICAgICAgICAgICB1dGlsXzEuY29tcGFyZUJ5RmllbGRTcGVjcyhmMS5ldmVudERlZiwgZjIuZXZlbnREZWYsIHRoaXMudmlldy5ldmVudE9yZGVyU3BlY3MsIGYxLmV2ZW50RGVmLm1pc2NQcm9wcywgZjIuZXZlbnREZWYubWlzY1Byb3BzKTsNCiAgICB9Ow0KICAgIHJldHVybiBFdmVudFJlbmRlcmVyOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IEV2ZW50UmVuZGVyZXI7DQoKCi8qKiovIH0pLAovKiA0MyAqLywKLyogNDQgKi8sCi8qIDQ1ICovLAovKiA0NiAqLywKLyogNDcgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciBtb21lbnRfZXh0XzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDEwKTsNCi8vIFBsdWdpbg0KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KbW9tZW50X2V4dF8xLm5ld01vbWVudFByb3RvLmZvcm1hdCA9IGZ1bmN0aW9uICgpIHsNCiAgICBpZiAodGhpcy5fZnVsbENhbGVuZGFyICYmIGFyZ3VtZW50c1swXSkgew0KICAgICAgICByZXR1cm4gZm9ybWF0RGF0ZSh0aGlzLCBhcmd1bWVudHNbMF0pOyAvLyBvdXIgZXh0ZW5kZWQgZm9ybWF0dGluZw0KICAgIH0NCiAgICBpZiAodGhpcy5fYW1iaWdUaW1lKSB7DQogICAgICAgIHJldHVybiBtb21lbnRfZXh0XzEub2xkTW9tZW50Rm9ybWF0KGVuZ2xpc2hNb21lbnQodGhpcyksICdZWVlZLU1NLUREJyk7DQogICAgfQ0KICAgIGlmICh0aGlzLl9hbWJpZ1pvbmUpIHsNCiAgICAgICAgcmV0dXJuIG1vbWVudF9leHRfMS5vbGRNb21lbnRGb3JtYXQoZW5nbGlzaE1vbWVudCh0aGlzKSwgJ1lZWVktTU0tRERbVF1ISDptbTpzcycpOw0KICAgIH0NCiAgICBpZiAodGhpcy5fZnVsbENhbGVuZGFyKSB7DQogICAgICAgIC8vIG1vbWVudC5mb3JtYXQoKSBkb2Vzbid0IGVuc3VyZSBlbmdsaXNoLCBidXQgd2Ugd2FudCB0by4NCiAgICAgICAgcmV0dXJuIG1vbWVudF9leHRfMS5vbGRNb21lbnRGb3JtYXQoZW5nbGlzaE1vbWVudCh0aGlzKSk7DQogICAgfQ0KICAgIHJldHVybiBtb21lbnRfZXh0XzEub2xkTW9tZW50UHJvdG8uZm9ybWF0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7DQp9Ow0KbW9tZW50X2V4dF8xLm5ld01vbWVudFByb3RvLnRvSVNPU3RyaW5nID0gZnVuY3Rpb24gKCkgew0KICAgIGlmICh0aGlzLl9hbWJpZ1RpbWUpIHsNCiAgICAgICAgcmV0dXJuIG1vbWVudF9leHRfMS5vbGRNb21lbnRGb3JtYXQoZW5nbGlzaE1vbWVudCh0aGlzKSwgJ1lZWVktTU0tREQnKTsNCiAgICB9DQogICAgaWYgKHRoaXMuX2FtYmlnWm9uZSkgew0KICAgICAgICByZXR1cm4gbW9tZW50X2V4dF8xLm9sZE1vbWVudEZvcm1hdChlbmdsaXNoTW9tZW50KHRoaXMpLCAnWVlZWS1NTS1ERFtUXUhIOm1tOnNzJyk7DQogICAgfQ0KICAgIGlmICh0aGlzLl9mdWxsQ2FsZW5kYXIpIHsNCiAgICAgICAgLy8gZGVwZW5kaW5nIG9uIGJyb3dzZXIsIG1vbWVudCBtaWdodCBub3Qgb3V0cHV0IGVuZ2xpc2guIGVuc3VyZSBlbmdsaXNoLg0KICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbW9tZW50L21vbWVudC9ibG9iLzIuMTguMS9zcmMvbGliL21vbWVudC9mb3JtYXQuanMjTDIyDQogICAgICAgIHJldHVybiBtb21lbnRfZXh0XzEub2xkTW9tZW50UHJvdG8udG9JU09TdHJpbmcuYXBwbHkoZW5nbGlzaE1vbWVudCh0aGlzKSwgYXJndW1lbnRzKTsNCiAgICB9DQogICAgcmV0dXJuIG1vbWVudF9leHRfMS5vbGRNb21lbnRQcm90by50b0lTT1N0cmluZy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOw0KfTsNCmZ1bmN0aW9uIGVuZ2xpc2hNb21lbnQobW9tKSB7DQogICAgaWYgKG1vbS5sb2NhbGUoKSAhPT0gJ2VuJykgew0KICAgICAgICByZXR1cm4gbW9tLmNsb25lKCkubG9jYWxlKCdlbicpOw0KICAgIH0NCiAgICByZXR1cm4gbW9tOw0KfQ0KLy8gQ29uZmlnDQovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCi8qDQpJbnNlcnRlZCBiZXR3ZWVuIGNodW5rcyBpbiB0aGUgZmFrZSAoImludGVybWVkaWF0ZSIpIGZvcm1hdHRpbmcgc3RyaW5nLg0KSW1wb3J0YW50IHRoYXQgaXQgcGFzc2VzIGFzIHdoaXRlc3BhY2UgKFxzKSBiZWNhdXNlIG1vbWVudCBvZnRlbiBpZGVudGlmaWVzIG5vbi1zdGFuZGFsb25lIG1vbnRocw0KdmlhIGEgcmVnZXhwIHdpdGggYW4gXHMuDQoqLw0KdmFyIFBBUlRfU0VQQVJBVE9SID0gJ1x1MDAwYic7IC8vIHZlcnRpY2FsIHRhYg0KLyoNCkluc2VydGVkIGFzIHRoZSBmaXJzdCBjaGFyYWN0ZXIgb2YgYSBsaXRlcmFsLXRleHQgY2h1bmsgdG8gaW5kaWNhdGUgdGhhdCB0aGUgbGl0ZXJhbCB0ZXh0IGlzIG5vdCBhY3R1YWxseSBsaXRlcmFsIHRleHQsDQpidXQgcmF0aGVyLCBhICJzcGVjaWFsIiB0b2tlbiB0aGF0IGhhcyBjdXN0b20gcmVuZGVyaW5nIChzZWUgc3BlY2lhbFRva2VucyBtYXApLg0KKi8NCnZhciBTUEVDSUFMX1RPS0VOX01BUktFUiA9ICdcdTAwMWYnOyAvLyBpbmZvcm1hdGlvbiBzZXBhcmF0b3IgMQ0KLyoNCkluc2VydGVkIGF0IHRoZSBiZWdpbm5pbmcgYW5kIGVuZCBvZiBhIHNwYW4gb2YgdGV4dCB0aGF0IG11c3QgaGF2ZSBub24temVybyBudW1lcmljIGNoYXJhY3RlcnMuDQpIYW5kbGluZyBvZiB0aGVzZSBtYXJrZXJzIGlzIGRvbmUgaW4gYSBwb3N0LXByb2Nlc3Npbmcgc3RlcCBhdCB0aGUgdmVyeSBlbmQgb2YgdGV4dCByZW5kZXJpbmcuDQoqLw0KdmFyIE1BWUJFX01BUktFUiA9ICdcdTAwMWUnOyAvLyBpbmZvcm1hdGlvbiBzZXBhcmF0b3IgMg0KdmFyIE1BWUJFX1JFR0VYUCA9IG5ldyBSZWdFeHAoTUFZQkVfTUFSS0VSICsgJyhbXicgKyBNQVlCRV9NQVJLRVIgKyAnXSopJyArIE1BWUJFX01BUktFUiwgJ2cnKTsgLy8gbXVzdCBiZSBnbG9iYWwNCi8qDQpBZGRpdGlvbiBmb3JtYXR0aW5nIHRva2VucyB3ZSB3YW50IHJlY29nbml6ZWQNCiovDQp2YXIgc3BlY2lhbFRva2VucyA9IHsNCiAgICB0OiBmdW5jdGlvbiAoZGF0ZSkgew0KICAgICAgICByZXR1cm4gbW9tZW50X2V4dF8xLm9sZE1vbWVudEZvcm1hdChkYXRlLCAnYScpLmNoYXJBdCgwKTsNCiAgICB9LA0KICAgIFQ6IGZ1bmN0aW9uIChkYXRlKSB7DQogICAgICAgIHJldHVybiBtb21lbnRfZXh0XzEub2xkTW9tZW50Rm9ybWF0KGRhdGUsICdBJykuY2hhckF0KDApOw0KICAgIH0NCn07DQovKg0KVGhlIGZpcnN0IGNoYXJhY3RlcnMgb2YgZm9ybWF0dGluZyB0b2tlbnMgZm9yIHVuaXRzIHRoYXQgYXJlIDEgZGF5IG9yIGxhcmdlci4NCmB2YWx1ZWAgaXMgZm9yIHJhbmtpbmcgcmVsYXRpdmUgc2l6ZSAobG93ZXIgbWVhbnMgYmlnZ2VyKS4NCmB1bml0YCBpcyBhIG5vcm1hbGl6ZWQgdW5pdCwgdXNlZCBmb3IgY29tcGFyaW5nIG1vbWVudHMuDQoqLw0KdmFyIGxhcmdlVG9rZW5NYXAgPSB7DQogICAgWTogeyB2YWx1ZTogMSwgdW5pdDogJ3llYXInIH0sDQogICAgTTogeyB2YWx1ZTogMiwgdW5pdDogJ21vbnRoJyB9LA0KICAgIFc6IHsgdmFsdWU6IDMsIHVuaXQ6ICd3ZWVrJyB9LA0KICAgIHc6IHsgdmFsdWU6IDMsIHVuaXQ6ICd3ZWVrJyB9LA0KICAgIEQ6IHsgdmFsdWU6IDQsIHVuaXQ6ICdkYXknIH0sDQogICAgZDogeyB2YWx1ZTogNCwgdW5pdDogJ2RheScgfSAvLyBkYXkgb2Ygd2Vlaw0KfTsNCi8vIFNpbmdsZSBEYXRlIEZvcm1hdHRpbmcNCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KLyoNCkZvcm1hdHMgYGRhdGVgIHdpdGggYSBNb21lbnQgZm9ybWF0dGluZyBzdHJpbmcsIGJ1dCBhbGxvdyBvdXIgbm9uLXplcm8gYXJlYXMgYW5kIHNwZWNpYWwgdG9rZW4NCiovDQpmdW5jdGlvbiBmb3JtYXREYXRlKGRhdGUsIGZvcm1hdFN0cikgew0KICAgIHJldHVybiByZW5kZXJGYWtlRm9ybWF0U3RyaW5nKGdldFBhcnNlZEZvcm1hdFN0cmluZyhmb3JtYXRTdHIpLmZha2VGb3JtYXRTdHJpbmcsIGRhdGUpOw0KfQ0KZXhwb3J0cy5mb3JtYXREYXRlID0gZm9ybWF0RGF0ZTsNCi8vIERhdGUgUmFuZ2UgRm9ybWF0dGluZw0KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KLy8gVE9ETzogbWFrZSBpdCB3b3JrIHdpdGggdGltZXpvbmUgb2Zmc2V0DQovKg0KVXNpbmcgYSBmb3JtYXR0aW5nIHN0cmluZyBtZWFudCBmb3IgYSBzaW5nbGUgZGF0ZSwgZ2VuZXJhdGUgYSByYW5nZSBzdHJpbmcsIGxpa2UNCiJTZXAgMiAtIDkgMjAxMyIsIHRoYXQgaW50ZWxsaWdlbnRseSBpbnNlcnRzIGEgc2VwYXJhdG9yIHdoZXJlIHRoZSBkYXRlcyBkaWZmZXIuDQpJZiB0aGUgZGF0ZXMgYXJlIHRoZSBzYW1lIGFzIGZhciBhcyB0aGUgZm9ybWF0IHN0cmluZyBpcyBjb25jZXJuZWQsIGp1c3QgcmV0dXJuIGEgc2luZ2xlDQpyZW5kZXJpbmcgb2Ygb25lIGRhdGUsIHdpdGhvdXQgYW55IHNlcGFyYXRvci4NCiovDQpmdW5jdGlvbiBmb3JtYXRSYW5nZShkYXRlMSwgZGF0ZTIsIGZvcm1hdFN0ciwgc2VwYXJhdG9yLCBpc1JUTCkgew0KICAgIHZhciBsb2NhbGVEYXRhOw0KICAgIGRhdGUxID0gbW9tZW50X2V4dF8xLmRlZmF1bHQucGFyc2Vab25lKGRhdGUxKTsNCiAgICBkYXRlMiA9IG1vbWVudF9leHRfMS5kZWZhdWx0LnBhcnNlWm9uZShkYXRlMik7DQogICAgbG9jYWxlRGF0YSA9IGRhdGUxLmxvY2FsZURhdGEoKTsNCiAgICAvLyBFeHBhbmQgbG9jYWxpemVkIGZvcm1hdCBzdHJpbmdzLCBsaWtlICJMTCIgLT4gIk1NTU0gRCBZWVlZIi4NCiAgICAvLyBCVFcsIHRoaXMgaXMgbm90IGltcG9ydGFudCBmb3IgYGZvcm1hdERhdGVgIGJlY2F1c2UgaXQgaXMgaW1wb3NzaWJsZSB0byBwdXQgY3VzdG9tIHRva2Vucw0KICAgIC8vIG9yIG5vbi16ZXJvIGFyZWFzIGluIE1vbWVudCdzIGxvY2FsaXplZCBmb3JtYXQgc3RyaW5ncy4NCiAgICBmb3JtYXRTdHIgPSBsb2NhbGVEYXRhLmxvbmdEYXRlRm9ybWF0KGZvcm1hdFN0cikgfHwgZm9ybWF0U3RyOw0KICAgIHJldHVybiByZW5kZXJQYXJzZWRGb3JtYXQoZ2V0UGFyc2VkRm9ybWF0U3RyaW5nKGZvcm1hdFN0ciksIGRhdGUxLCBkYXRlMiwgc2VwYXJhdG9yIHx8ICcgLSAnLCBpc1JUTCk7DQp9DQpleHBvcnRzLmZvcm1hdFJhbmdlID0gZm9ybWF0UmFuZ2U7DQovKg0KUmVuZGVycyBhIHJhbmdlIHdpdGggYW4gYWxyZWFkeS1wYXJzZWQgZm9ybWF0IHN0cmluZy4NCiovDQpmdW5jdGlvbiByZW5kZXJQYXJzZWRGb3JtYXQocGFyc2VkRm9ybWF0LCBkYXRlMSwgZGF0ZTIsIHNlcGFyYXRvciwgaXNSVEwpIHsNCiAgICB2YXIgc2FtZVVuaXRzID0gcGFyc2VkRm9ybWF0LnNhbWVVbml0czsNCiAgICB2YXIgdW56b25lZERhdGUxID0gZGF0ZTEuY2xvbmUoKS5zdHJpcFpvbmUoKTsgLy8gZm9yIHNhbWUtdW5pdCBjb21wYXJpc29ucw0KICAgIHZhciB1bnpvbmVkRGF0ZTIgPSBkYXRlMi5jbG9uZSgpLnN0cmlwWm9uZSgpOyAvLyAiDQogICAgdmFyIHJlbmRlcmVkUGFydHMxID0gcmVuZGVyRmFrZUZvcm1hdFN0cmluZ1BhcnRzKHBhcnNlZEZvcm1hdC5mYWtlRm9ybWF0U3RyaW5nLCBkYXRlMSk7DQogICAgdmFyIHJlbmRlcmVkUGFydHMyID0gcmVuZGVyRmFrZUZvcm1hdFN0cmluZ1BhcnRzKHBhcnNlZEZvcm1hdC5mYWtlRm9ybWF0U3RyaW5nLCBkYXRlMik7DQogICAgdmFyIGxlZnRJOw0KICAgIHZhciBsZWZ0U3RyID0gJyc7DQogICAgdmFyIHJpZ2h0STsNCiAgICB2YXIgcmlnaHRTdHIgPSAnJzsNCiAgICB2YXIgbWlkZGxlSTsNCiAgICB2YXIgbWlkZGxlU3RyMSA9ICcnOw0KICAgIHZhciBtaWRkbGVTdHIyID0gJyc7DQogICAgdmFyIG1pZGRsZVN0ciA9ICcnOw0KICAgIC8vIFN0YXJ0IGF0IHRoZSBsZWZ0bW9zdCBzaWRlIG9mIHRoZSBmb3JtYXR0aW5nIHN0cmluZyBhbmQgY29udGludWUgdW50aWwgeW91IGhpdCBhIHRva2VuDQogICAgLy8gdGhhdCBpcyBub3QgdGhlIHNhbWUgYmV0d2VlbiBkYXRlcy4NCiAgICBmb3IgKGxlZnRJID0gMDsgbGVmdEkgPCBzYW1lVW5pdHMubGVuZ3RoICYmICghc2FtZVVuaXRzW2xlZnRJXSB8fCB1bnpvbmVkRGF0ZTEuaXNTYW1lKHVuem9uZWREYXRlMiwgc2FtZVVuaXRzW2xlZnRJXSkpOyBsZWZ0SSsrKSB7DQogICAgICAgIGxlZnRTdHIgKz0gcmVuZGVyZWRQYXJ0czFbbGVmdEldOw0KICAgIH0NCiAgICAvLyBTaW1pbGFybHksIHN0YXJ0IGF0IHRoZSByaWdodG1vc3Qgc2lkZSBvZiB0aGUgZm9ybWF0dGluZyBzdHJpbmcgYW5kIG1vdmUgbGVmdA0KICAgIGZvciAocmlnaHRJID0gc2FtZVVuaXRzLmxlbmd0aCAtIDE7IHJpZ2h0SSA+IGxlZnRJICYmICghc2FtZVVuaXRzW3JpZ2h0SV0gfHwgdW56b25lZERhdGUxLmlzU2FtZSh1bnpvbmVkRGF0ZTIsIHNhbWVVbml0c1tyaWdodEldKSk7IHJpZ2h0SS0tKSB7DQogICAgICAgIC8vIElmIGN1cnJlbnQgY2h1bmsgaXMgb24gdGhlIGJvdW5kYXJ5IG9mIHVuaXF1ZSBkYXRlLWNvbnRlbnQsIGFuZCBpcyBhIHNwZWNpYWwtY2FzZQ0KICAgICAgICAvLyBkYXRlLWZvcm1hdHRpbmcgcG9zdGZpeCBjaGFyYWN0ZXIsIHRoZW4gZG9uJ3QgY29uc3VtZSBpdC4gQ29uc2lkZXIgaXQgdW5pcXVlIGRhdGUtY29udGVudC4NCiAgICAgICAgLy8gVE9ETzogbWFrZSBjb25maWd1cmFibGUNCiAgICAgICAgaWYgKHJpZ2h0SSAtIDEgPT09IGxlZnRJICYmIHJlbmRlcmVkUGFydHMxW3JpZ2h0SV0gPT09ICcuJykgew0KICAgICAgICAgICAgYnJlYWs7DQogICAgICAgIH0NCiAgICAgICAgcmlnaHRTdHIgPSByZW5kZXJlZFBhcnRzMVtyaWdodEldICsgcmlnaHRTdHI7DQogICAgfQ0KICAgIC8vIFRoZSBhcmVhIGluIHRoZSBtaWRkbGUgaXMgZGlmZmVyZW50IGZvciBib3RoIG9mIHRoZSBkYXRlcy4NCiAgICAvLyBDb2xsZWN0IHRoZW0gZGlzdGluY3RseSBzbyB3ZSBjYW4gamFtIHRoZW0gdG9nZXRoZXIgbGF0ZXIuDQogICAgZm9yIChtaWRkbGVJID0gbGVmdEk7IG1pZGRsZUkgPD0gcmlnaHRJOyBtaWRkbGVJKyspIHsNCiAgICAgICAgbWlkZGxlU3RyMSArPSByZW5kZXJlZFBhcnRzMVttaWRkbGVJXTsNCiAgICAgICAgbWlkZGxlU3RyMiArPSByZW5kZXJlZFBhcnRzMlttaWRkbGVJXTsNCiAgICB9DQogICAgaWYgKG1pZGRsZVN0cjEgfHwgbWlkZGxlU3RyMikgew0KICAgICAgICBpZiAoaXNSVEwpIHsNCiAgICAgICAgICAgIG1pZGRsZVN0ciA9IG1pZGRsZVN0cjIgKyBzZXBhcmF0b3IgKyBtaWRkbGVTdHIxOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgbWlkZGxlU3RyID0gbWlkZGxlU3RyMSArIHNlcGFyYXRvciArIG1pZGRsZVN0cjI7DQogICAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHByb2Nlc3NNYXliZU1hcmtlcnMobGVmdFN0ciArIG1pZGRsZVN0ciArIHJpZ2h0U3RyKTsNCn0NCi8vIEZvcm1hdCBTdHJpbmcgUGFyc2luZw0KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQp2YXIgcGFyc2VkRm9ybWF0U3RyQ2FjaGUgPSB7fTsNCi8qDQpSZXR1cm5zIGEgcGFyc2VkIGZvcm1hdCBzdHJpbmcsIGxldmVyYWdpbmcgYSBjYWNoZS4NCiovDQpmdW5jdGlvbiBnZXRQYXJzZWRGb3JtYXRTdHJpbmcoZm9ybWF0U3RyKSB7DQogICAgcmV0dXJuIHBhcnNlZEZvcm1hdFN0ckNhY2hlW2Zvcm1hdFN0cl0gfHwNCiAgICAgICAgKHBhcnNlZEZvcm1hdFN0ckNhY2hlW2Zvcm1hdFN0cl0gPSBwYXJzZUZvcm1hdFN0cmluZyhmb3JtYXRTdHIpKTsNCn0NCi8qDQpQYXJzZXMgYSBmb3JtYXQgc3RyaW5nIGludG8gdGhlIGZvbGxvd2luZzoNCi0gZmFrZUZvcm1hdFN0cmluZzogYSBtb21lbnRKUyBmb3JtYXR0aW5nIHN0cmluZywgbGl0dGVyZWQgd2l0aCBzcGVjaWFsIGNvbnRyb2wgY2hhcmFjdGVycyB0aGF0IGdldCBwb3N0LXByb2Nlc3NlZC4NCi0gc2FtZVVuaXRzOiBmb3IgZXZlcnkgcGFydCBpbiBmYWtlRm9ybWF0U3RyaW5nLCBpZiB0aGUgcGFydCBpcyBhIHRva2VuLCB0aGUgdmFsdWUgd2lsbCBiZSBhIHVuaXQgc3RyaW5nIChsaWtlICJkYXkiKSwNCiAgdGhhdCBpbmRpY2F0ZXMgaG93IHNpbWlsYXIgYSByYW5nZSdzIHN0YXJ0ICYgZW5kIG11c3QgYmUgaW4gb3JkZXIgdG8gc2hhcmUgdGhlIHNhbWUgZm9ybWF0dGVkIHRleHQuDQogIElmIG5vdCBhIHRva2VuLCB0aGVuIHRoZSB2YWx1ZSBpcyBudWxsLg0KICBBbHdheXMgYSBmbGF0IGFycmF5IChub3QgbmVzdGVkIGxpa2VkICJjaHVua3MiKS4NCiovDQpmdW5jdGlvbiBwYXJzZUZvcm1hdFN0cmluZyhmb3JtYXRTdHIpIHsNCiAgICB2YXIgY2h1bmtzID0gY2h1bmtGb3JtYXRTdHJpbmcoZm9ybWF0U3RyKTsNCiAgICByZXR1cm4gew0KICAgICAgICBmYWtlRm9ybWF0U3RyaW5nOiBidWlsZEZha2VGb3JtYXRTdHJpbmcoY2h1bmtzKSwNCiAgICAgICAgc2FtZVVuaXRzOiBidWlsZFNhbWVVbml0cyhjaHVua3MpDQogICAgfTsNCn0NCi8qDQpCcmVhayB0aGUgZm9ybWF0dGluZyBzdHJpbmcgaW50byBhbiBhcnJheSBvZiBjaHVua3MuDQpBICdtYXliZScgY2h1bmsgd2lsbCBoYXZlIG5lc3RlZCBjaHVua3MuDQoqLw0KZnVuY3Rpb24gY2h1bmtGb3JtYXRTdHJpbmcoZm9ybWF0U3RyKSB7DQogICAgdmFyIGNodW5rcyA9IFtdOw0KICAgIHZhciBtYXRjaDsNCiAgICAvLyBUT0RPOiBtb3JlIGRlc2NyaW1pbmF0aW9uDQogICAgLy8gXDQgaXMgYSBiYWNrcmVmZXJlbmNlIHRvIHRoZSBmaXJzdCBjaGFyYWN0ZXIgb2YgYSBtdWx0aS1jaGFyYWN0ZXIgc2V0Lg0KICAgIHZhciBjaHVua2VyID0gL1xbKFteXF1dKilcXXxcKChbXlwpXSopXCl8KExUU3xMVHwoXHcpXDQqbz8pfChbXlx3XFtcKF0rKS9nOw0KICAgIHdoaWxlICgobWF0Y2ggPSBjaHVua2VyLmV4ZWMoZm9ybWF0U3RyKSkpIHsNCiAgICAgICAgaWYgKG1hdGNoWzFdKSB7DQogICAgICAgICAgICBjaHVua3MucHVzaC5hcHBseShjaHVua3MsIC8vIGFwcGVuZA0KICAgICAgICAgICAgc3BsaXRTdHJpbmdMaXRlcmFsKG1hdGNoWzFdKSk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAobWF0Y2hbMl0pIHsNCiAgICAgICAgICAgIGNodW5rcy5wdXNoKHsgbWF5YmU6IGNodW5rRm9ybWF0U3RyaW5nKG1hdGNoWzJdKSB9KTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmIChtYXRjaFszXSkgew0KICAgICAgICAgICAgY2h1bmtzLnB1c2goeyB0b2tlbjogbWF0Y2hbM10gfSk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAobWF0Y2hbNV0pIHsNCiAgICAgICAgICAgIGNodW5rcy5wdXNoLmFwcGx5KGNodW5rcywgLy8gYXBwZW5kDQogICAgICAgICAgICBzcGxpdFN0cmluZ0xpdGVyYWwobWF0Y2hbNV0pKTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gY2h1bmtzOw0KfQ0KLyoNClBvdGVudGlhbGx5IHNwbGl0cyBhIGxpdGVyYWwtdGV4dCBzdHJpbmcgaW50byBtdWx0aXBsZSBwYXJ0cy4gRm9yIHNwZWNpYWwgY2FzZXMuDQoqLw0KZnVuY3Rpb24gc3BsaXRTdHJpbmdMaXRlcmFsKHMpIHsNCiAgICBpZiAocyA9PT0gJy4gJykgew0KICAgICAgICByZXR1cm4gWycuJywgJyAnXTsgLy8gZm9yIGxvY2FsZXMgd2l0aCBwZXJpb2RzIGJvdW5kIHRvIHRoZSBlbmQgb2YgZWFjaCB5ZWFyL21vbnRoL2RhdGUNCiAgICB9DQogICAgZWxzZSB7DQogICAgICAgIHJldHVybiBbc107DQogICAgfQ0KfQ0KLyoNCkdpdmVuIGNodW5rcyBwYXJzZWQgZnJvbSBhIHJlYWwgZm9ybWF0IHN0cmluZywgZ2VuZXJhdGUgYSBmYWtlIChha2EgImludGVybWVkaWF0ZSIpIGZvcm1hdCBzdHJpbmcgd2l0aCBzcGVjaWFsIGNvbnRyb2wNCmNoYXJhY3RlcnMgdGhhdCB3aWxsIGV2ZW50dWFsbHkgYmUgZ2l2ZW4gdG8gbW9tZW50IGZvciBmb3JtYXR0aW5nLCBhbmQgdGhlbiBwb3N0LXByb2Nlc3NlZC4NCiovDQpmdW5jdGlvbiBidWlsZEZha2VGb3JtYXRTdHJpbmcoY2h1bmtzKSB7DQogICAgdmFyIHBhcnRzID0gW107DQogICAgdmFyIGk7DQogICAgdmFyIGNodW5rOw0KICAgIGZvciAoaSA9IDA7IGkgPCBjaHVua3MubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgY2h1bmsgPSBjaHVua3NbaV07DQogICAgICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7DQogICAgICAgICAgICBwYXJ0cy5wdXNoKCdbJyArIGNodW5rICsgJ10nKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmIChjaHVuay50b2tlbikgew0KICAgICAgICAgICAgaWYgKGNodW5rLnRva2VuIGluIHNwZWNpYWxUb2tlbnMpIHsNCiAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKFNQRUNJQUxfVE9LRU5fTUFSS0VSICsgLy8gdXNlZnVsIGR1cmluZyBwb3N0LXByb2Nlc3NpbmcNCiAgICAgICAgICAgICAgICAgICAgJ1snICsgY2h1bmsudG9rZW4gKyAnXScgLy8gcHJlc2VydmUgYXMgbGl0ZXJhbCB0ZXh0DQogICAgICAgICAgICAgICAgKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIHBhcnRzLnB1c2goY2h1bmsudG9rZW4pOyAvLyB1bnByb3RlY3RlZCB0ZXh0IGltcGxpZXMgYSBmb3JtYXQgc3RyaW5nDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAoY2h1bmsubWF5YmUpIHsNCiAgICAgICAgICAgIHBhcnRzLnB1c2goTUFZQkVfTUFSS0VSICsgLy8gdXNlZnVsIGR1cmluZyBwb3N0LXByb2Nlc3NpbmcNCiAgICAgICAgICAgICAgICBidWlsZEZha2VGb3JtYXRTdHJpbmcoY2h1bmsubWF5YmUpICsNCiAgICAgICAgICAgICAgICBNQVlCRV9NQVJLRVIpOw0KICAgICAgICB9DQogICAgfQ0KICAgIHJldHVybiBwYXJ0cy5qb2luKFBBUlRfU0VQQVJBVE9SKTsNCn0NCi8qDQpHaXZlbiBwYXJzZWQgY2h1bmtzIGZyb20gYSByZWFsIGZvcm1hdHRpbmcgc3RyaW5nLCBnZW5lcmF0ZXMgYW4gYXJyYXkgb2YgdW5pdCBzdHJpbmdzIChsaWtlICJkYXkiKSB0aGF0IGluZGljYXRlDQppbiB3aGljaCByZWdhcmQgdHdvIGRhdGVzIG11c3QgYmUgc2ltaWxhciBpbiBvcmRlciB0byBzaGFyZSByYW5nZSBmb3JtYXR0aW5nIHRleHQuDQpUaGUgYGNodW5rc2AgY2FuIGJlIG5lc3RlZCAoYmVjYXVzZSBvZiAibWF5YmUiIGNodW5rcyksIGhvd2V2ZXIsIHRoZSByZXR1cm5lZCBhcnJheSB3aWxsIGJlIGZsYXQuDQoqLw0KZnVuY3Rpb24gYnVpbGRTYW1lVW5pdHMoY2h1bmtzKSB7DQogICAgdmFyIHVuaXRzID0gW107DQogICAgdmFyIGk7DQogICAgdmFyIGNodW5rOw0KICAgIHZhciB0b2tlbkluZm87DQogICAgZm9yIChpID0gMDsgaSA8IGNodW5rcy5sZW5ndGg7IGkrKykgew0KICAgICAgICBjaHVuayA9IGNodW5rc1tpXTsNCiAgICAgICAgaWYgKGNodW5rLnRva2VuKSB7DQogICAgICAgICAgICB0b2tlbkluZm8gPSBsYXJnZVRva2VuTWFwW2NodW5rLnRva2VuLmNoYXJBdCgwKV07DQogICAgICAgICAgICB1bml0cy5wdXNoKHRva2VuSW5mbyA/IHRva2VuSW5mby51bml0IDogJ3NlY29uZCcpOyAvLyBkZWZhdWx0IHRvIGEgdmVyeSBzdHJpY3Qgc2FtZS1zZWNvbmQNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmIChjaHVuay5tYXliZSkgew0KICAgICAgICAgICAgdW5pdHMucHVzaC5hcHBseSh1bml0cywgLy8gYXBwZW5kDQogICAgICAgICAgICBidWlsZFNhbWVVbml0cyhjaHVuay5tYXliZSkpOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgdW5pdHMucHVzaChudWxsKTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gdW5pdHM7DQp9DQovLyBSZW5kZXJpbmcgdG8gdGV4dA0KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQovKg0KRm9ybWF0cyBhIGRhdGUgd2l0aCBhIGZha2UgZm9ybWF0IHN0cmluZywgcG9zdC1wcm9jZXNzZXMgdGhlIGNvbnRyb2wgY2hhcmFjdGVycywgdGhlbiByZXR1cm5zLg0KKi8NCmZ1bmN0aW9uIHJlbmRlckZha2VGb3JtYXRTdHJpbmcoZmFrZUZvcm1hdFN0cmluZywgZGF0ZSkgew0KICAgIHJldHVybiBwcm9jZXNzTWF5YmVNYXJrZXJzKHJlbmRlckZha2VGb3JtYXRTdHJpbmdQYXJ0cyhmYWtlRm9ybWF0U3RyaW5nLCBkYXRlKS5qb2luKCcnKSk7DQp9DQovKg0KRm9ybWF0cyBhIGRhdGUgaW50byBwYXJ0cyB0aGF0IHdpbGwgaGF2ZSBiZWVuIHBvc3QtcHJvY2Vzc2VkLCBFWENFUFQgZm9yIHRoZSAibWF5YmUiIG1hcmtlcnMuDQoqLw0KZnVuY3Rpb24gcmVuZGVyRmFrZUZvcm1hdFN0cmluZ1BhcnRzKGZha2VGb3JtYXRTdHJpbmcsIGRhdGUpIHsNCiAgICB2YXIgcGFydHMgPSBbXTsNCiAgICB2YXIgZmFrZVJlbmRlciA9IG1vbWVudF9leHRfMS5vbGRNb21lbnRGb3JtYXQoZGF0ZSwgZmFrZUZvcm1hdFN0cmluZyk7DQogICAgdmFyIGZha2VQYXJ0cyA9IGZha2VSZW5kZXIuc3BsaXQoUEFSVF9TRVBBUkFUT1IpOw0KICAgIHZhciBpOw0KICAgIHZhciBmYWtlUGFydDsNCiAgICBmb3IgKGkgPSAwOyBpIDwgZmFrZVBhcnRzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGZha2VQYXJ0ID0gZmFrZVBhcnRzW2ldOw0KICAgICAgICBpZiAoZmFrZVBhcnQuY2hhckF0KDApID09PSBTUEVDSUFMX1RPS0VOX01BUktFUikgew0KICAgICAgICAgICAgcGFydHMucHVzaCgNCiAgICAgICAgICAgIC8vIHRoZSBsaXRlcmFsIHN0cmluZyBJUyB0aGUgdG9rZW4ncyBuYW1lLg0KICAgICAgICAgICAgLy8gY2FsbCBzcGVjaWFsIHRva2VuJ3MgcmVnaXN0ZXJlZCBmdW5jdGlvbi4NCiAgICAgICAgICAgIHNwZWNpYWxUb2tlbnNbZmFrZVBhcnQuc3Vic3RyaW5nKDEpXShkYXRlKSk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBwYXJ0cy5wdXNoKGZha2VQYXJ0KTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gcGFydHM7DQp9DQovKg0KQWNjZXB0cyBhbiBhbG1vc3QtZmluYWxseS1mb3JtYXR0ZWQgc3RyaW5nIGFuZCBwcm9jZXNzZXMgdGhlICJtYXliZSIgY29udHJvbCBjaGFyYWN0ZXJzLCByZXR1cm5pbmcgYSBuZXcgc3RyaW5nLg0KKi8NCmZ1bmN0aW9uIHByb2Nlc3NNYXliZU1hcmtlcnMocykgew0KICAgIHJldHVybiBzLnJlcGxhY2UoTUFZQkVfUkVHRVhQLCBmdW5jdGlvbiAobTAsIG0xKSB7DQogICAgICAgIGlmIChtMS5tYXRjaCgvWzEtOV0vKSkgew0KICAgICAgICAgICAgcmV0dXJuIG0xOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuICcnOw0KICAgICAgICB9DQogICAgfSk7DQp9DQovLyBNaXNjIFV0aWxzDQovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQovKg0KUmV0dXJucyBhIHVuaXQgc3RyaW5nLCBlaXRoZXIgJ3llYXInLCAnbW9udGgnLCAnZGF5Jywgb3IgbnVsbCBmb3IgdGhlIG1vc3QgZ3JhbnVsYXIgZm9ybWF0dGluZyB0b2tlbiBpbiB0aGUgc3RyaW5nLg0KKi8NCmZ1bmN0aW9uIHF1ZXJ5TW9zdEdyYW51bGFyRm9ybWF0VW5pdChmb3JtYXRTdHIpIHsNCiAgICB2YXIgY2h1bmtzID0gY2h1bmtGb3JtYXRTdHJpbmcoZm9ybWF0U3RyKTsNCiAgICB2YXIgaTsNCiAgICB2YXIgY2h1bms7DQogICAgdmFyIGNhbmRpZGF0ZTsNCiAgICB2YXIgYmVzdDsNCiAgICBmb3IgKGkgPSAwOyBpIDwgY2h1bmtzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGNodW5rID0gY2h1bmtzW2ldOw0KICAgICAgICBpZiAoY2h1bmsudG9rZW4pIHsNCiAgICAgICAgICAgIGNhbmRpZGF0ZSA9IGxhcmdlVG9rZW5NYXBbY2h1bmsudG9rZW4uY2hhckF0KDApXTsNCiAgICAgICAgICAgIGlmIChjYW5kaWRhdGUpIHsNCiAgICAgICAgICAgICAgICBpZiAoIWJlc3QgfHwgY2FuZGlkYXRlLnZhbHVlID4gYmVzdC52YWx1ZSkgew0KICAgICAgICAgICAgICAgICAgICBiZXN0ID0gY2FuZGlkYXRlOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCiAgICBpZiAoYmVzdCkgew0KICAgICAgICByZXR1cm4gYmVzdC51bml0Ow0KICAgIH0NCiAgICByZXR1cm4gbnVsbDsNCn0NCmV4cG9ydHMucXVlcnlNb3N0R3JhbnVsYXJGb3JtYXRVbml0ID0gcXVlcnlNb3N0R3JhbnVsYXJGb3JtYXRVbml0Ow0KCgovKioqLyB9KSwKLyogNDggKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciBDbGFzc18xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzMik7DQp2YXIgRW1pdHRlck1peGluXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDExKTsNCnZhciBMaXN0ZW5lck1peGluXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDcpOw0KdmFyIE1vZGVsID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKE1vZGVsLCBfc3VwZXIpOw0KICAgIGZ1bmN0aW9uIE1vZGVsKCkgew0KICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzOw0KICAgICAgICBfdGhpcy5fd2F0Y2hlcnMgPSB7fTsNCiAgICAgICAgX3RoaXMuX3Byb3BzID0ge307DQogICAgICAgIF90aGlzLmFwcGx5R2xvYmFsV2F0Y2hlcnMoKTsNCiAgICAgICAgX3RoaXMuY29uc3RydWN0ZWQoKTsNCiAgICAgICAgcmV0dXJuIF90aGlzOw0KICAgIH0NCiAgICBNb2RlbC53YXRjaCA9IGZ1bmN0aW9uIChuYW1lKSB7DQogICAgICAgIHZhciBhcmdzID0gW107DQogICAgICAgIGZvciAodmFyIF9pID0gMTsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7DQogICAgICAgICAgICBhcmdzW19pIC0gMV0gPSBhcmd1bWVudHNbX2ldOw0KICAgICAgICB9DQogICAgICAgIC8vIHN1YmNsYXNzZXMgc2hvdWxkIG1ha2UgYSBtYXNrZWQtY29weSBvZiB0aGUgc3VwZXJjbGFzcydzIG1hcA0KICAgICAgICAvLyBUT0RPOiB3cml0ZSB0ZXN0DQogICAgICAgIGlmICghdGhpcy5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkoJ19nbG9iYWxXYXRjaEFyZ3MnKSkgew0KICAgICAgICAgICAgdGhpcy5wcm90b3R5cGUuX2dsb2JhbFdhdGNoQXJncyA9IE9iamVjdC5jcmVhdGUodGhpcy5wcm90b3R5cGUuX2dsb2JhbFdhdGNoQXJncyk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5wcm90b3R5cGUuX2dsb2JhbFdhdGNoQXJnc1tuYW1lXSA9IGFyZ3M7DQogICAgfTsNCiAgICBNb2RlbC5wcm90b3R5cGUuY29uc3RydWN0ZWQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIC8vIHVzZWZ1bCBmb3IgbW9ua2V5cGF0Y2hpbmcuIFRPRE86IEJhc2VDbGFzcz8NCiAgICB9Ow0KICAgIE1vZGVsLnByb3RvdHlwZS5hcHBseUdsb2JhbFdhdGNoZXJzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgbWFwID0gdGhpcy5fZ2xvYmFsV2F0Y2hBcmdzOw0KICAgICAgICB2YXIgbmFtZTsNCiAgICAgICAgZm9yIChuYW1lIGluIG1hcCkgew0KICAgICAgICAgICAgdGhpcy53YXRjaC5hcHBseSh0aGlzLCBbbmFtZV0uY29uY2F0KG1hcFtuYW1lXSkpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBNb2RlbC5wcm90b3R5cGUuaGFzID0gZnVuY3Rpb24gKG5hbWUpIHsNCiAgICAgICAgcmV0dXJuIG5hbWUgaW4gdGhpcy5fcHJvcHM7DQogICAgfTsNCiAgICBNb2RlbC5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKG5hbWUpIHsNCiAgICAgICAgaWYgKG5hbWUgPT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Byb3BzOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzLl9wcm9wc1tuYW1lXTsNCiAgICB9Ow0KICAgIE1vZGVsLnByb3RvdHlwZS5zZXQgPSBmdW5jdGlvbiAobmFtZSwgdmFsKSB7DQogICAgICAgIHZhciBuZXdQcm9wczsNCiAgICAgICAgaWYgKHR5cGVvZiBuYW1lID09PSAnc3RyaW5nJykgew0KICAgICAgICAgICAgbmV3UHJvcHMgPSB7fTsNCiAgICAgICAgICAgIG5ld1Byb3BzW25hbWVdID0gdmFsID09PSB1bmRlZmluZWQgPyBudWxsIDogdmFsOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgbmV3UHJvcHMgPSBuYW1lOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuc2V0UHJvcHMobmV3UHJvcHMpOw0KICAgIH07DQogICAgTW9kZWwucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24gKG5ld1Byb3BzKSB7DQogICAgICAgIHZhciBvbGRQcm9wcyA9IHRoaXMuX3Byb3BzOw0KICAgICAgICB2YXIgY2hhbmdlc2V0ID0ge307IC8vIHdpbGwgaGF2ZSB1bmRlZmluZWQncyB0byBzaWduYWwgdW5zZXRzDQogICAgICAgIHZhciBuYW1lOw0KICAgICAgICBmb3IgKG5hbWUgaW4gb2xkUHJvcHMpIHsNCiAgICAgICAgICAgIGNoYW5nZXNldFtuYW1lXSA9IHVuZGVmaW5lZDsNCiAgICAgICAgfQ0KICAgICAgICBmb3IgKG5hbWUgaW4gbmV3UHJvcHMpIHsNCiAgICAgICAgICAgIGNoYW5nZXNldFtuYW1lXSA9IG5ld1Byb3BzW25hbWVdOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuc2V0UHJvcHMoY2hhbmdlc2V0KTsNCiAgICB9Ow0KICAgIE1vZGVsLnByb3RvdHlwZS51bnNldCA9IGZ1bmN0aW9uIChuYW1lKSB7DQogICAgICAgIHZhciBuZXdQcm9wcyA9IHt9Ow0KICAgICAgICB2YXIgbmFtZXM7DQogICAgICAgIHZhciBpOw0KICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnKSB7DQogICAgICAgICAgICBuYW1lcyA9IFtuYW1lXTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIG5hbWVzID0gbmFtZTsNCiAgICAgICAgfQ0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbmFtZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIG5ld1Byb3BzW25hbWVzW2ldXSA9IHVuZGVmaW5lZDsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLnNldFByb3BzKG5ld1Byb3BzKTsNCiAgICB9Ow0KICAgIE1vZGVsLnByb3RvdHlwZS5zZXRQcm9wcyA9IGZ1bmN0aW9uIChuZXdQcm9wcykgew0KICAgICAgICB2YXIgY2hhbmdlZFByb3BzID0ge307DQogICAgICAgIHZhciBjaGFuZ2VkQ250ID0gMDsNCiAgICAgICAgdmFyIG5hbWU7DQogICAgICAgIHZhciB2YWw7DQogICAgICAgIGZvciAobmFtZSBpbiBuZXdQcm9wcykgew0KICAgICAgICAgICAgdmFsID0gbmV3UHJvcHNbbmFtZV07DQogICAgICAgICAgICAvLyBhIGNoYW5nZSBpbiB2YWx1ZT8NCiAgICAgICAgICAgIC8vIGlmIGFuIG9iamVjdCwgZG9uJ3QgY2hlY2sgZXF1YWxpdHksIGJlY2F1c2UgbWlnaHQgaGF2ZSBiZWVuIG11dGF0ZWQgaW50ZXJuYWxseS4NCiAgICAgICAgICAgIC8vIFRPRE86IGV2ZW50dWFsbHkgZW5mb3JjZSBpbW11dGFiaWxpdHkuDQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ29iamVjdCcgfHwNCiAgICAgICAgICAgICAgICB2YWwgIT09IHRoaXMuX3Byb3BzW25hbWVdKSB7DQogICAgICAgICAgICAgICAgY2hhbmdlZFByb3BzW25hbWVdID0gdmFsOw0KICAgICAgICAgICAgICAgIGNoYW5nZWRDbnQrKzsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBpZiAoY2hhbmdlZENudCkgew0KICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdiZWZvcmU6YmF0Y2hDaGFuZ2UnLCBjaGFuZ2VkUHJvcHMpOw0KICAgICAgICAgICAgZm9yIChuYW1lIGluIGNoYW5nZWRQcm9wcykgew0KICAgICAgICAgICAgICAgIHZhbCA9IGNoYW5nZWRQcm9wc1tuYW1lXTsNCiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2JlZm9yZTpjaGFuZ2UnLCBuYW1lLCB2YWwpOw0KICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcignYmVmb3JlOmNoYW5nZTonICsgbmFtZSwgdmFsKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGZvciAobmFtZSBpbiBjaGFuZ2VkUHJvcHMpIHsNCiAgICAgICAgICAgICAgICB2YWwgPSBjaGFuZ2VkUHJvcHNbbmFtZV07DQogICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9wcm9wc1tuYW1lXTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Byb3BzW25hbWVdID0gdmFsOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgbmFtZSwgdmFsKTsNCiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIG5hbWUsIHZhbCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2JhdGNoQ2hhbmdlJywgY2hhbmdlZFByb3BzKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgTW9kZWwucHJvdG90eXBlLndhdGNoID0gZnVuY3Rpb24gKG5hbWUsIGRlcExpc3QsIHN0YXJ0RnVuYywgc3RvcEZ1bmMpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgdGhpcy51bndhdGNoKG5hbWUpOw0KICAgICAgICB0aGlzLl93YXRjaGVyc1tuYW1lXSA9IHRoaXMuX3dhdGNoRGVwcyhkZXBMaXN0LCBmdW5jdGlvbiAoZGVwcykgew0KICAgICAgICAgICAgdmFyIHJlcyA9IHN0YXJ0RnVuYy5jYWxsKF90aGlzLCBkZXBzKTsNCiAgICAgICAgICAgIGlmIChyZXMgJiYgcmVzLnRoZW4pIHsNCiAgICAgICAgICAgICAgICBfdGhpcy51bnNldChuYW1lKTsgLy8gcHV0IGluIGFuIHVuc2V0IHN0YXRlIHdoaWxlIHJlc29sdmluZw0KICAgICAgICAgICAgICAgIHJlcy50aGVuKGZ1bmN0aW9uICh2YWwpIHsNCiAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2V0KG5hbWUsIHZhbCk7DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICBfdGhpcy5zZXQobmFtZSwgcmVzKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSwgZnVuY3Rpb24gKGRlcHMpIHsNCiAgICAgICAgICAgIF90aGlzLnVuc2V0KG5hbWUpOw0KICAgICAgICAgICAgaWYgKHN0b3BGdW5jKSB7DQogICAgICAgICAgICAgICAgc3RvcEZ1bmMuY2FsbChfdGhpcywgZGVwcyk7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgIH07DQogICAgTW9kZWwucHJvdG90eXBlLnVud2F0Y2ggPSBmdW5jdGlvbiAobmFtZSkgew0KICAgICAgICB2YXIgd2F0Y2hlciA9IHRoaXMuX3dhdGNoZXJzW25hbWVdOw0KICAgICAgICBpZiAod2F0Y2hlcikgew0KICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3dhdGNoZXJzW25hbWVdOw0KICAgICAgICAgICAgd2F0Y2hlci50ZWFyZG93bigpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBNb2RlbC5wcm90b3R5cGUuX3dhdGNoRGVwcyA9IGZ1bmN0aW9uIChkZXBMaXN0LCBzdGFydEZ1bmMsIHN0b3BGdW5jKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIHZhciBxdWV1ZWRDaGFuZ2VDbnQgPSAwOw0KICAgICAgICB2YXIgZGVwQ250ID0gZGVwTGlzdC5sZW5ndGg7DQogICAgICAgIHZhciBzYXRpc2Z5Q250ID0gMDsNCiAgICAgICAgdmFyIHZhbHVlcyA9IHt9OyAvLyB3aGF0J3MgcGFzc2VkIGFzIHRoZSBgZGVwc2AgYXJndW1lbnRzDQogICAgICAgIHZhciBiaW5kVHVwbGVzID0gW107IC8vIGFycmF5IG9mIFsgZXZlbnROYW1lLCBoYW5kbGVyRnVuYyBdIGFycmF5cw0KICAgICAgICB2YXIgaXNDYWxsaW5nU3RvcCA9IGZhbHNlOw0KICAgICAgICB2YXIgb25CZWZvcmVEZXBDaGFuZ2UgPSBmdW5jdGlvbiAoZGVwTmFtZSwgdmFsLCBpc09wdGlvbmFsKSB7DQogICAgICAgICAgICBxdWV1ZWRDaGFuZ2VDbnQrKzsNCiAgICAgICAgICAgIGlmIChxdWV1ZWRDaGFuZ2VDbnQgPT09IDEpIHsNCiAgICAgICAgICAgICAgICBpZiAoc2F0aXNmeUNudCA9PT0gZGVwQ250KSB7DQogICAgICAgICAgICAgICAgICAgIGlzQ2FsbGluZ1N0b3AgPSB0cnVlOw0KICAgICAgICAgICAgICAgICAgICBzdG9wRnVuYyh2YWx1ZXMpOw0KICAgICAgICAgICAgICAgICAgICBpc0NhbGxpbmdTdG9wID0gZmFsc2U7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICB2YXIgb25EZXBDaGFuZ2UgPSBmdW5jdGlvbiAoZGVwTmFtZSwgdmFsLCBpc09wdGlvbmFsKSB7DQogICAgICAgICAgICBpZiAodmFsID09PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgICAgICAvLyByZXF1aXJlZCBkZXBlbmRlbmN5IHRoYXQgd2FzIHByZXZpb3VzbHkgc2V0Pw0KICAgICAgICAgICAgICAgIGlmICghaXNPcHRpb25hbCAmJiB2YWx1ZXNbZGVwTmFtZV0gIT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgICAgICAgICBzYXRpc2Z5Q250LS07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGRlbGV0ZSB2YWx1ZXNbZGVwTmFtZV07DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAvLyByZXF1aXJlZCBkZXBlbmRlbmN5IHRoYXQgd2FzIHByZXZpb3VzbHkgdW5zZXQ/DQogICAgICAgICAgICAgICAgaWYgKCFpc09wdGlvbmFsICYmIHZhbHVlc1tkZXBOYW1lXSA9PT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICAgICAgICAgIHNhdGlzZnlDbnQrKzsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgdmFsdWVzW2RlcE5hbWVdID0gdmFsOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcXVldWVkQ2hhbmdlQ250LS07DQogICAgICAgICAgICBpZiAoIXF1ZXVlZENoYW5nZUNudCkgew0KICAgICAgICAgICAgICAgIC8vIG5vdyBmaW5hbGx5IHNhdGlzZmllZCBvciBzYXRpc2ZpZWQgYWxsIGFsb25nPw0KICAgICAgICAgICAgICAgIGlmIChzYXRpc2Z5Q250ID09PSBkZXBDbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIHN0b3BGdW5jIGluaXRpYXRlZCBhbm90aGVyIHZhbHVlIGNoYW5nZSwgaWdub3JlIGl0Lg0KICAgICAgICAgICAgICAgICAgICAvLyBpdCB3aWxsIGJlIHByb2Nlc3NlZCBieSBhbm90aGVyIGNoYW5nZSBldmVudCBhbnl3YXkuDQogICAgICAgICAgICAgICAgICAgIGlmICghaXNDYWxsaW5nU3RvcCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRGdW5jKHZhbHVlcyk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIC8vIGludGVyY2VwdCBmb3IgLm9uKCkgdGhhdCByZW1lbWJlcnMgaGFuZGxlcnMNCiAgICAgICAgdmFyIGJpbmQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBoYW5kbGVyKSB7DQogICAgICAgICAgICBfdGhpcy5vbihldmVudE5hbWUsIGhhbmRsZXIpOw0KICAgICAgICAgICAgYmluZFR1cGxlcy5wdXNoKFtldmVudE5hbWUsIGhhbmRsZXJdKTsNCiAgICAgICAgfTsNCiAgICAgICAgLy8gbGlzdGVuIHRvIGRlcGVuZGVuY3kgY2hhbmdlcw0KICAgICAgICBkZXBMaXN0LmZvckVhY2goZnVuY3Rpb24gKGRlcE5hbWUpIHsNCiAgICAgICAgICAgIHZhciBpc09wdGlvbmFsID0gZmFsc2U7DQogICAgICAgICAgICBpZiAoZGVwTmFtZS5jaGFyQXQoMCkgPT09ICc/Jykgew0KICAgICAgICAgICAgICAgIGRlcE5hbWUgPSBkZXBOYW1lLnN1YnN0cmluZygxKTsNCiAgICAgICAgICAgICAgICBpc09wdGlvbmFsID0gdHJ1ZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGJpbmQoJ2JlZm9yZTpjaGFuZ2U6JyArIGRlcE5hbWUsIGZ1bmN0aW9uICh2YWwpIHsNCiAgICAgICAgICAgICAgICBvbkJlZm9yZURlcENoYW5nZShkZXBOYW1lLCB2YWwsIGlzT3B0aW9uYWwpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICBiaW5kKCdjaGFuZ2U6JyArIGRlcE5hbWUsIGZ1bmN0aW9uICh2YWwpIHsNCiAgICAgICAgICAgICAgICBvbkRlcENoYW5nZShkZXBOYW1lLCB2YWwsIGlzT3B0aW9uYWwpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0pOw0KICAgICAgICAvLyBwcm9jZXNzIGN1cnJlbnQgZGVwZW5kZW5jeSB2YWx1ZXMNCiAgICAgICAgZGVwTGlzdC5mb3JFYWNoKGZ1bmN0aW9uIChkZXBOYW1lKSB7DQogICAgICAgICAgICB2YXIgaXNPcHRpb25hbCA9IGZhbHNlOw0KICAgICAgICAgICAgaWYgKGRlcE5hbWUuY2hhckF0KDApID09PSAnPycpIHsNCiAgICAgICAgICAgICAgICBkZXBOYW1lID0gZGVwTmFtZS5zdWJzdHJpbmcoMSk7DQogICAgICAgICAgICAgICAgaXNPcHRpb25hbCA9IHRydWU7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoX3RoaXMuaGFzKGRlcE5hbWUpKSB7DQogICAgICAgICAgICAgICAgdmFsdWVzW2RlcE5hbWVdID0gX3RoaXMuZ2V0KGRlcE5hbWUpOw0KICAgICAgICAgICAgICAgIHNhdGlzZnlDbnQrKzsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2UgaWYgKGlzT3B0aW9uYWwpIHsNCiAgICAgICAgICAgICAgICBzYXRpc2Z5Q250Kys7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgICAvLyBpbml0aWFsbHkgc2F0aXNmaWVkDQogICAgICAgIGlmIChzYXRpc2Z5Q250ID09PSBkZXBDbnQpIHsNCiAgICAgICAgICAgIHN0YXJ0RnVuYyh2YWx1ZXMpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB7DQogICAgICAgICAgICB0ZWFyZG93bjogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBhbGwgaGFuZGxlcnMNCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJpbmRUdXBsZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICAgICAgX3RoaXMub2ZmKGJpbmRUdXBsZXNbaV1bMF0sIGJpbmRUdXBsZXNbaV1bMV0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBiaW5kVHVwbGVzID0gbnVsbDsNCiAgICAgICAgICAgICAgICAvLyB3YXMgc2F0aXNmaWVkLCBzbyBjYWxsIHN0b3BGdW5jDQogICAgICAgICAgICAgICAgaWYgKHNhdGlzZnlDbnQgPT09IGRlcENudCkgew0KICAgICAgICAgICAgICAgICAgICBzdG9wRnVuYygpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBmbGFzaDogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIGlmIChzYXRpc2Z5Q250ID09PSBkZXBDbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgc3RvcEZ1bmMoKTsNCiAgICAgICAgICAgICAgICAgICAgc3RhcnRGdW5jKHZhbHVlcyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgIH07DQogICAgTW9kZWwucHJvdG90eXBlLmZsYXNoID0gZnVuY3Rpb24gKG5hbWUpIHsNCiAgICAgICAgdmFyIHdhdGNoZXIgPSB0aGlzLl93YXRjaGVyc1tuYW1lXTsNCiAgICAgICAgaWYgKHdhdGNoZXIpIHsNCiAgICAgICAgICAgIHdhdGNoZXIuZmxhc2goKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgcmV0dXJuIE1vZGVsOw0KfShDbGFzc18xLmRlZmF1bHQpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IE1vZGVsOw0KTW9kZWwucHJvdG90eXBlLl9nbG9iYWxXYXRjaEFyZ3MgPSB7fTsgLy8gbXV0YXRpb24gcHJvdGVjdGlvbiBpbiBNb2RlbC53YXRjaA0KRW1pdHRlck1peGluXzEuZGVmYXVsdC5taXhJbnRvKE1vZGVsKTsNCkxpc3RlbmVyTWl4aW5fMS5kZWZhdWx0Lm1peEludG8oTW9kZWwpOw0KCgovKioqLyB9KSwKLyogNDkgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciBtb21lbnQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDApOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgU2luZ2xlRXZlbnREZWZfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTMpOw0KdmFyIFJlY3VycmluZ0V2ZW50RGVmXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIxMCk7DQpleHBvcnRzLmRlZmF1bHQgPSB7DQogICAgcGFyc2U6IGZ1bmN0aW9uIChldmVudElucHV0LCBzb3VyY2UpIHsNCiAgICAgICAgaWYgKHV0aWxfMS5pc1RpbWVTdHJpbmcoZXZlbnRJbnB1dC5zdGFydCkgfHwgbW9tZW50LmlzRHVyYXRpb24oZXZlbnRJbnB1dC5zdGFydCkgfHwNCiAgICAgICAgICAgIHV0aWxfMS5pc1RpbWVTdHJpbmcoZXZlbnRJbnB1dC5lbmQpIHx8IG1vbWVudC5pc0R1cmF0aW9uKGV2ZW50SW5wdXQuZW5kKSkgew0KICAgICAgICAgICAgcmV0dXJuIFJlY3VycmluZ0V2ZW50RGVmXzEuZGVmYXVsdC5wYXJzZShldmVudElucHV0LCBzb3VyY2UpOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuIFNpbmdsZUV2ZW50RGVmXzEuZGVmYXVsdC5wYXJzZShldmVudElucHV0LCBzb3VyY2UpOw0KICAgICAgICB9DQogICAgfQ0KfTsNCgoKLyoqKi8gfSksCi8qIDUwICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCnZhciBFdmVudERhdGVQcm9maWxlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE4KTsNCnZhciBFdmVudERlZkRhdGVNdXRhdGlvbiA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsNCiAgICBmdW5jdGlvbiBFdmVudERlZkRhdGVNdXRhdGlvbigpIHsNCiAgICAgICAgdGhpcy5jbGVhckVuZCA9IGZhbHNlOw0KICAgICAgICB0aGlzLmZvcmNlVGltZWQgPSBmYWxzZTsNCiAgICAgICAgdGhpcy5mb3JjZUFsbERheSA9IGZhbHNlOw0KICAgIH0NCiAgICBFdmVudERlZkRhdGVNdXRhdGlvbi5jcmVhdGVGcm9tRGlmZiA9IGZ1bmN0aW9uIChkYXRlUHJvZmlsZTAsIGRhdGVQcm9maWxlMSwgbGFyZ2VVbml0KSB7DQogICAgICAgIHZhciBjbGVhckVuZCA9IGRhdGVQcm9maWxlMC5lbmQgJiYgIWRhdGVQcm9maWxlMS5lbmQ7DQogICAgICAgIHZhciBmb3JjZVRpbWVkID0gZGF0ZVByb2ZpbGUwLmlzQWxsRGF5KCkgJiYgIWRhdGVQcm9maWxlMS5pc0FsbERheSgpOw0KICAgICAgICB2YXIgZm9yY2VBbGxEYXkgPSAhZGF0ZVByb2ZpbGUwLmlzQWxsRGF5KCkgJiYgZGF0ZVByb2ZpbGUxLmlzQWxsRGF5KCk7DQogICAgICAgIHZhciBkYXRlRGVsdGE7DQogICAgICAgIHZhciBlbmREaWZmOw0KICAgICAgICB2YXIgZW5kRGVsdGE7DQogICAgICAgIHZhciBtdXRhdGlvbjsNCiAgICAgICAgLy8gc3VidHJhY3RzIHRoZSBkYXRlcyBpbiB0aGUgYXBwcm9wcmlhdGUgd2F5LCByZXR1cm5pbmcgYSBkdXJhdGlvbg0KICAgICAgICBmdW5jdGlvbiBzdWJ0cmFjdERhdGVzKGRhdGUxLCBkYXRlMCkgew0KICAgICAgICAgICAgaWYgKGxhcmdlVW5pdCkgew0KICAgICAgICAgICAgICAgIHJldHVybiB1dGlsXzEuZGlmZkJ5VW5pdChkYXRlMSwgZGF0ZTAsIGxhcmdlVW5pdCk7IC8vIHBvb3JseSBuYW1lZA0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAoZGF0ZVByb2ZpbGUxLmlzQWxsRGF5KCkpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbF8xLmRpZmZEYXkoZGF0ZTEsIGRhdGUwKTsgLy8gcG9vcmx5IG5hbWVkDQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbF8xLmRpZmZEYXlUaW1lKGRhdGUxLCBkYXRlMCk7IC8vIHBvb3JseSBuYW1lZA0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGRhdGVEZWx0YSA9IHN1YnRyYWN0RGF0ZXMoZGF0ZVByb2ZpbGUxLnN0YXJ0LCBkYXRlUHJvZmlsZTAuc3RhcnQpOw0KICAgICAgICBpZiAoZGF0ZVByb2ZpbGUxLmVuZCkgew0KICAgICAgICAgICAgLy8gdXNlIHVuem9uZWRSYW5nZXMgYmVjYXVzZSBkYXRlUHJvZmlsZTAuZW5kIG1pZ2h0IGJlIG51bGwNCiAgICAgICAgICAgIGVuZERpZmYgPSBzdWJ0cmFjdERhdGVzKGRhdGVQcm9maWxlMS51bnpvbmVkUmFuZ2UuZ2V0RW5kKCksIGRhdGVQcm9maWxlMC51bnpvbmVkUmFuZ2UuZ2V0RW5kKCkpOw0KICAgICAgICAgICAgZW5kRGVsdGEgPSBlbmREaWZmLnN1YnRyYWN0KGRhdGVEZWx0YSk7DQogICAgICAgIH0NCiAgICAgICAgbXV0YXRpb24gPSBuZXcgRXZlbnREZWZEYXRlTXV0YXRpb24oKTsNCiAgICAgICAgbXV0YXRpb24uY2xlYXJFbmQgPSBjbGVhckVuZDsNCiAgICAgICAgbXV0YXRpb24uZm9yY2VUaW1lZCA9IGZvcmNlVGltZWQ7DQogICAgICAgIG11dGF0aW9uLmZvcmNlQWxsRGF5ID0gZm9yY2VBbGxEYXk7DQogICAgICAgIG11dGF0aW9uLnNldERhdGVEZWx0YShkYXRlRGVsdGEpOw0KICAgICAgICBtdXRhdGlvbi5zZXRFbmREZWx0YShlbmREZWx0YSk7DQogICAgICAgIHJldHVybiBtdXRhdGlvbjsNCiAgICB9Ow0KICAgIC8qDQogICAgcmV0dXJucyBhbiB1bmRvIGZ1bmN0aW9uLg0KICAgICovDQogICAgRXZlbnREZWZEYXRlTXV0YXRpb24ucHJvdG90eXBlLmJ1aWxkTmV3RGF0ZVByb2ZpbGUgPSBmdW5jdGlvbiAoZXZlbnREYXRlUHJvZmlsZSwgY2FsZW5kYXIpIHsNCiAgICAgICAgdmFyIHN0YXJ0ID0gZXZlbnREYXRlUHJvZmlsZS5zdGFydC5jbG9uZSgpOw0KICAgICAgICB2YXIgZW5kID0gbnVsbDsNCiAgICAgICAgdmFyIHNob3VsZFJlem9uZSA9IGZhbHNlOw0KICAgICAgICBpZiAoZXZlbnREYXRlUHJvZmlsZS5lbmQgJiYgIXRoaXMuY2xlYXJFbmQpIHsNCiAgICAgICAgICAgIGVuZCA9IGV2ZW50RGF0ZVByb2ZpbGUuZW5kLmNsb25lKCk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAodGhpcy5lbmREZWx0YSAmJiAhZW5kKSB7DQogICAgICAgICAgICBlbmQgPSBjYWxlbmRhci5nZXREZWZhdWx0RXZlbnRFbmQoZXZlbnREYXRlUHJvZmlsZS5pc0FsbERheSgpLCBzdGFydCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHRoaXMuZm9yY2VUaW1lZCkgew0KICAgICAgICAgICAgc2hvdWxkUmV6b25lID0gdHJ1ZTsNCiAgICAgICAgICAgIGlmICghc3RhcnQuaGFzVGltZSgpKSB7DQogICAgICAgICAgICAgICAgc3RhcnQudGltZSgwKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChlbmQgJiYgIWVuZC5oYXNUaW1lKCkpIHsNCiAgICAgICAgICAgICAgICBlbmQudGltZSgwKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICh0aGlzLmZvcmNlQWxsRGF5KSB7DQogICAgICAgICAgICBpZiAoc3RhcnQuaGFzVGltZSgpKSB7DQogICAgICAgICAgICAgICAgc3RhcnQuc3RyaXBUaW1lKCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoZW5kICYmIGVuZC5oYXNUaW1lKCkpIHsNCiAgICAgICAgICAgICAgICBlbmQuc3RyaXBUaW1lKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgaWYgKHRoaXMuZGF0ZURlbHRhKSB7DQogICAgICAgICAgICBzaG91bGRSZXpvbmUgPSB0cnVlOw0KICAgICAgICAgICAgc3RhcnQuYWRkKHRoaXMuZGF0ZURlbHRhKTsNCiAgICAgICAgICAgIGlmIChlbmQpIHsNCiAgICAgICAgICAgICAgICBlbmQuYWRkKHRoaXMuZGF0ZURlbHRhKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICAvLyBkbyB0aGlzIGJlZm9yZSBhZGRpbmcgc3RhcnREZWx0YSB0byBzdGFydCwgc28gd2UgY2FuIHdvcmsgb2ZmIG9mIHN0YXJ0DQogICAgICAgIGlmICh0aGlzLmVuZERlbHRhKSB7DQogICAgICAgICAgICBzaG91bGRSZXpvbmUgPSB0cnVlOw0KICAgICAgICAgICAgZW5kLmFkZCh0aGlzLmVuZERlbHRhKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAodGhpcy5zdGFydERlbHRhKSB7DQogICAgICAgICAgICBzaG91bGRSZXpvbmUgPSB0cnVlOw0KICAgICAgICAgICAgc3RhcnQuYWRkKHRoaXMuc3RhcnREZWx0YSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHNob3VsZFJlem9uZSkgew0KICAgICAgICAgICAgc3RhcnQgPSBjYWxlbmRhci5hcHBseVRpbWV6b25lKHN0YXJ0KTsNCiAgICAgICAgICAgIGlmIChlbmQpIHsNCiAgICAgICAgICAgICAgICBlbmQgPSBjYWxlbmRhci5hcHBseVRpbWV6b25lKGVuZCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgLy8gVE9ETzogb2theSB0byBhY2Nlc3MgY2FsZW5kYXIgb3B0aW9uPw0KICAgICAgICBpZiAoIWVuZCAmJiBjYWxlbmRhci5vcHQoJ2ZvcmNlRXZlbnREdXJhdGlvbicpKSB7DQogICAgICAgICAgICBlbmQgPSBjYWxlbmRhci5nZXREZWZhdWx0RXZlbnRFbmQoZXZlbnREYXRlUHJvZmlsZS5pc0FsbERheSgpLCBzdGFydCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIG5ldyBFdmVudERhdGVQcm9maWxlXzEuZGVmYXVsdChzdGFydCwgZW5kLCBjYWxlbmRhcik7DQogICAgfTsNCiAgICBFdmVudERlZkRhdGVNdXRhdGlvbi5wcm90b3R5cGUuc2V0RGF0ZURlbHRhID0gZnVuY3Rpb24gKGRhdGVEZWx0YSkgew0KICAgICAgICBpZiAoZGF0ZURlbHRhICYmIGRhdGVEZWx0YS52YWx1ZU9mKCkpIHsNCiAgICAgICAgICAgIHRoaXMuZGF0ZURlbHRhID0gZGF0ZURlbHRhOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgdGhpcy5kYXRlRGVsdGEgPSBudWxsOw0KICAgICAgICB9DQogICAgfTsNCiAgICBFdmVudERlZkRhdGVNdXRhdGlvbi5wcm90b3R5cGUuc2V0U3RhcnREZWx0YSA9IGZ1bmN0aW9uIChzdGFydERlbHRhKSB7DQogICAgICAgIGlmIChzdGFydERlbHRhICYmIHN0YXJ0RGVsdGEudmFsdWVPZigpKSB7DQogICAgICAgICAgICB0aGlzLnN0YXJ0RGVsdGEgPSBzdGFydERlbHRhOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgdGhpcy5zdGFydERlbHRhID0gbnVsbDsNCiAgICAgICAgfQ0KICAgIH07DQogICAgRXZlbnREZWZEYXRlTXV0YXRpb24ucHJvdG90eXBlLnNldEVuZERlbHRhID0gZnVuY3Rpb24gKGVuZERlbHRhKSB7DQogICAgICAgIGlmIChlbmREZWx0YSAmJiBlbmREZWx0YS52YWx1ZU9mKCkpIHsNCiAgICAgICAgICAgIHRoaXMuZW5kRGVsdGEgPSBlbmREZWx0YTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHRoaXMuZW5kRGVsdGEgPSBudWxsOw0KICAgICAgICB9DQogICAgfTsNCiAgICBFdmVudERlZkRhdGVNdXRhdGlvbi5wcm90b3R5cGUuaXNFbXB0eSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuICF0aGlzLmNsZWFyRW5kICYmICF0aGlzLmZvcmNlVGltZWQgJiYgIXRoaXMuZm9yY2VBbGxEYXkgJiYNCiAgICAgICAgICAgICF0aGlzLmRhdGVEZWx0YSAmJiAhdGhpcy5zdGFydERlbHRhICYmICF0aGlzLmVuZERlbHRhOw0KICAgIH07DQogICAgcmV0dXJuIEV2ZW50RGVmRGF0ZU11dGF0aW9uOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IEV2ZW50RGVmRGF0ZU11dGF0aW9uOw0KCgovKioqLyB9KSwKLyogNTEgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciBTdGFuZGFyZFRoZW1lXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIxMyk7DQp2YXIgSnF1ZXJ5VWlUaGVtZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMTQpOw0KdmFyIHRoZW1lQ2xhc3NIYXNoID0ge307DQpmdW5jdGlvbiBkZWZpbmVUaGVtZVN5c3RlbSh0aGVtZU5hbWUsIHRoZW1lQ2xhc3MpIHsNCiAgICB0aGVtZUNsYXNzSGFzaFt0aGVtZU5hbWVdID0gdGhlbWVDbGFzczsNCn0NCmV4cG9ydHMuZGVmaW5lVGhlbWVTeXN0ZW0gPSBkZWZpbmVUaGVtZVN5c3RlbTsNCmZ1bmN0aW9uIGdldFRoZW1lU3lzdGVtQ2xhc3ModGhlbWVTZXR0aW5nKSB7DQogICAgaWYgKCF0aGVtZVNldHRpbmcpIHsNCiAgICAgICAgcmV0dXJuIFN0YW5kYXJkVGhlbWVfMS5kZWZhdWx0Ow0KICAgIH0NCiAgICBlbHNlIGlmICh0aGVtZVNldHRpbmcgPT09IHRydWUpIHsNCiAgICAgICAgcmV0dXJuIEpxdWVyeVVpVGhlbWVfMS5kZWZhdWx0Ow0KICAgIH0NCiAgICBlbHNlIHsNCiAgICAgICAgcmV0dXJuIHRoZW1lQ2xhc3NIYXNoW3RoZW1lU2V0dGluZ107DQogICAgfQ0KfQ0KZXhwb3J0cy5nZXRUaGVtZVN5c3RlbUNsYXNzID0gZ2V0VGhlbWVTeXN0ZW1DbGFzczsNCgoKLyoqKi8gfSksCi8qIDUyICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdHNsaWJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCnZhciBQcm9taXNlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIwKTsNCnZhciBFdmVudFNvdXJjZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KTsNCnZhciBTaW5nbGVFdmVudERlZl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMyk7DQp2YXIgQXJyYXlFdmVudFNvdXJjZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHsNCiAgICB0c2xpYl8xLl9fZXh0ZW5kcyhBcnJheUV2ZW50U291cmNlLCBfc3VwZXIpOw0KICAgIGZ1bmN0aW9uIEFycmF5RXZlbnRTb3VyY2UoY2FsZW5kYXIpIHsNCiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgY2FsZW5kYXIpIHx8IHRoaXM7DQogICAgICAgIF90aGlzLmV2ZW50RGVmcyA9IFtdOyAvLyBmb3IgaWYgc2V0UmF3RXZlbnREZWZzIGlzIG5ldmVyIGNhbGxlZA0KICAgICAgICByZXR1cm4gX3RoaXM7DQogICAgfQ0KICAgIEFycmF5RXZlbnRTb3VyY2UucGFyc2UgPSBmdW5jdGlvbiAocmF3SW5wdXQsIGNhbGVuZGFyKSB7DQogICAgICAgIHZhciByYXdQcm9wczsNCiAgICAgICAgLy8gbm9ybWFsaXplIHJhdyBpbnB1dA0KICAgICAgICBpZiAoJC5pc0FycmF5KHJhd0lucHV0LmV2ZW50cykpIHsNCiAgICAgICAgICAgIHJhd1Byb3BzID0gcmF3SW5wdXQ7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAoJC5pc0FycmF5KHJhd0lucHV0KSkgew0KICAgICAgICAgICAgcmF3UHJvcHMgPSB7IGV2ZW50czogcmF3SW5wdXQgfTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAocmF3UHJvcHMpIHsNCiAgICAgICAgICAgIHJldHVybiBFdmVudFNvdXJjZV8xLmRlZmF1bHQucGFyc2UuY2FsbCh0aGlzLCByYXdQcm9wcywgY2FsZW5kYXIpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9Ow0KICAgIEFycmF5RXZlbnRTb3VyY2UucHJvdG90eXBlLnNldFJhd0V2ZW50RGVmcyA9IGZ1bmN0aW9uIChyYXdFdmVudERlZnMpIHsNCiAgICAgICAgdGhpcy5yYXdFdmVudERlZnMgPSByYXdFdmVudERlZnM7DQogICAgICAgIHRoaXMuZXZlbnREZWZzID0gdGhpcy5wYXJzZUV2ZW50RGVmcyhyYXdFdmVudERlZnMpOw0KICAgIH07DQogICAgQXJyYXlFdmVudFNvdXJjZS5wcm90b3R5cGUuZmV0Y2ggPSBmdW5jdGlvbiAoc3RhcnQsIGVuZCwgdGltZXpvbmUpIHsNCiAgICAgICAgdmFyIGV2ZW50RGVmcyA9IHRoaXMuZXZlbnREZWZzOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgaWYgKHRoaXMuY3VycmVudFRpbWV6b25lICE9IG51bGwgJiYNCiAgICAgICAgICAgIHRoaXMuY3VycmVudFRpbWV6b25lICE9PSB0aW1lem9uZSkgew0KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGV2ZW50RGVmcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgIGlmIChldmVudERlZnNbaV0gaW5zdGFuY2VvZiBTaW5nbGVFdmVudERlZl8xLmRlZmF1bHQpIHsNCiAgICAgICAgICAgICAgICAgICAgZXZlbnREZWZzW2ldLnJlem9uZSgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmN1cnJlbnRUaW1lem9uZSA9IHRpbWV6b25lOw0KICAgICAgICByZXR1cm4gUHJvbWlzZV8xLmRlZmF1bHQucmVzb2x2ZShldmVudERlZnMpOw0KICAgIH07DQogICAgQXJyYXlFdmVudFNvdXJjZS5wcm90b3R5cGUuYWRkRXZlbnREZWYgPSBmdW5jdGlvbiAoZXZlbnREZWYpIHsNCiAgICAgICAgdGhpcy5ldmVudERlZnMucHVzaChldmVudERlZik7DQogICAgfTsNCiAgICAvKg0KICAgIGV2ZW50RGVmSWQgYWxyZWFkeSBub3JtYWxpemVkIHRvIGEgc3RyaW5nDQogICAgKi8NCiAgICBBcnJheUV2ZW50U291cmNlLnByb3RvdHlwZS5yZW1vdmVFdmVudERlZnNCeUlkID0gZnVuY3Rpb24gKGV2ZW50RGVmSWQpIHsNCiAgICAgICAgcmV0dXJuIHV0aWxfMS5yZW1vdmVNYXRjaGluZyh0aGlzLmV2ZW50RGVmcywgZnVuY3Rpb24gKGV2ZW50RGVmKSB7DQogICAgICAgICAgICByZXR1cm4gZXZlbnREZWYuaWQgPT09IGV2ZW50RGVmSWQ7DQogICAgICAgIH0pOw0KICAgIH07DQogICAgQXJyYXlFdmVudFNvdXJjZS5wcm90b3R5cGUucmVtb3ZlQWxsRXZlbnREZWZzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLmV2ZW50RGVmcyA9IFtdOw0KICAgIH07DQogICAgQXJyYXlFdmVudFNvdXJjZS5wcm90b3R5cGUuZ2V0UHJpbWl0aXZlID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gdGhpcy5yYXdFdmVudERlZnM7DQogICAgfTsNCiAgICBBcnJheUV2ZW50U291cmNlLnByb3RvdHlwZS5hcHBseU1hbnVhbFN0YW5kYXJkUHJvcHMgPSBmdW5jdGlvbiAocmF3UHJvcHMpIHsNCiAgICAgICAgdmFyIHN1cGVyU3VjY2VzcyA9IF9zdXBlci5wcm90b3R5cGUuYXBwbHlNYW51YWxTdGFuZGFyZFByb3BzLmNhbGwodGhpcywgcmF3UHJvcHMpOw0KICAgICAgICB0aGlzLnNldFJhd0V2ZW50RGVmcyhyYXdQcm9wcy5ldmVudHMpOw0KICAgICAgICByZXR1cm4gc3VwZXJTdWNjZXNzOw0KICAgIH07DQogICAgcmV0dXJuIEFycmF5RXZlbnRTb3VyY2U7DQp9KEV2ZW50U291cmNlXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gQXJyYXlFdmVudFNvdXJjZTsNCkFycmF5RXZlbnRTb3VyY2UuZGVmaW5lU3RhbmRhcmRQcm9wcyh7DQogICAgZXZlbnRzOiBmYWxzZSAvLyBkb24ndCBhdXRvbWF0aWNhbGx5IHRyYW5zZmVyDQp9KTsNCgoKLyoqKi8gfSksCi8qIDUzICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCi8qDQpBIGNhY2hlIGZvciB0aGUgbGVmdC9yaWdodC90b3AvYm90dG9tL3dpZHRoL2hlaWdodCB2YWx1ZXMgZm9yIG9uZSBvciBtb3JlIGVsZW1lbnRzLg0KV29ya3Mgd2l0aCBib3RoIG9mZnNldCAoZnJvbSB0b3BsZWZ0IGRvY3VtZW50KSBhbmQgcG9zaXRpb24gKGZyb20gb2Zmc2V0UGFyZW50KS4NCgpvcHRpb25zOg0KLSBlbHMNCi0gaXNIb3Jpem9udGFsDQotIGlzVmVydGljYWwNCiovDQp2YXIgQ29vcmRDYWNoZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsNCiAgICBmdW5jdGlvbiBDb29yZENhY2hlKG9wdGlvbnMpIHsNCiAgICAgICAgdGhpcy5pc0hvcml6b250YWwgPSBmYWxzZTsgLy8gd2hldGhlciB0byBxdWVyeSBmb3IgbGVmdC9yaWdodC93aWR0aA0KICAgICAgICB0aGlzLmlzVmVydGljYWwgPSBmYWxzZTsgLy8gd2hldGhlciB0byBxdWVyeSBmb3IgdG9wL2JvdHRvbS9oZWlnaHQNCiAgICAgICAgdGhpcy5lbHMgPSAkKG9wdGlvbnMuZWxzKTsNCiAgICAgICAgdGhpcy5pc0hvcml6b250YWwgPSBvcHRpb25zLmlzSG9yaXpvbnRhbDsNCiAgICAgICAgdGhpcy5pc1ZlcnRpY2FsID0gb3B0aW9ucy5pc1ZlcnRpY2FsOw0KICAgICAgICB0aGlzLmZvcmNlZE9mZnNldFBhcmVudEVsID0gb3B0aW9ucy5vZmZzZXRQYXJlbnQgPyAkKG9wdGlvbnMub2Zmc2V0UGFyZW50KSA6IG51bGw7DQogICAgfQ0KICAgIC8vIFF1ZXJpZXMgdGhlIGVscyBmb3IgY29vcmRpbmF0ZXMgYW5kIHN0b3JlcyB0aGVtLg0KICAgIC8vIENhbGwgdGhpcyBtZXRob2QgYmVmb3JlIHVzaW5nIGFuZCBvZiB0aGUgZ2V0KiBtZXRob2RzIGJlbG93Lg0KICAgIENvb3JkQ2FjaGUucHJvdG90eXBlLmJ1aWxkID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgb2Zmc2V0UGFyZW50RWwgPSB0aGlzLmZvcmNlZE9mZnNldFBhcmVudEVsOw0KICAgICAgICBpZiAoIW9mZnNldFBhcmVudEVsICYmIHRoaXMuZWxzLmxlbmd0aCA+IDApIHsNCiAgICAgICAgICAgIG9mZnNldFBhcmVudEVsID0gdGhpcy5lbHMuZXEoMCkub2Zmc2V0UGFyZW50KCk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5vcmlnaW4gPSBvZmZzZXRQYXJlbnRFbCA/DQogICAgICAgICAgICBvZmZzZXRQYXJlbnRFbC5vZmZzZXQoKSA6DQogICAgICAgICAgICBudWxsOw0KICAgICAgICB0aGlzLmJvdW5kaW5nUmVjdCA9IHRoaXMucXVlcnlCb3VuZGluZ1JlY3QoKTsNCiAgICAgICAgaWYgKHRoaXMuaXNIb3Jpem9udGFsKSB7DQogICAgICAgICAgICB0aGlzLmJ1aWxkRWxIb3Jpem9udGFscygpOw0KICAgICAgICB9DQogICAgICAgIGlmICh0aGlzLmlzVmVydGljYWwpIHsNCiAgICAgICAgICAgIHRoaXMuYnVpbGRFbFZlcnRpY2FscygpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBEZXN0cm95cyBhbGwgaW50ZXJuYWwgZGF0YSBhYm91dCBjb29yZGluYXRlcywgZnJlZWluZyBtZW1vcnkNCiAgICBDb29yZENhY2hlLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5vcmlnaW4gPSBudWxsOw0KICAgICAgICB0aGlzLmJvdW5kaW5nUmVjdCA9IG51bGw7DQogICAgICAgIHRoaXMubGVmdHMgPSBudWxsOw0KICAgICAgICB0aGlzLnJpZ2h0cyA9IG51bGw7DQogICAgICAgIHRoaXMudG9wcyA9IG51bGw7DQogICAgICAgIHRoaXMuYm90dG9tcyA9IG51bGw7DQogICAgfTsNCiAgICAvLyBXaGVuIGNhbGxlZCwgaWYgY29vcmQgY2FjaGVzIGFyZW4ndCBidWlsdCwgYnVpbGRzIHRoZW0NCiAgICBDb29yZENhY2hlLnByb3RvdHlwZS5lbnN1cmVCdWlsdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKCF0aGlzLm9yaWdpbikgew0KICAgICAgICAgICAgdGhpcy5idWlsZCgpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBQb3B1bGF0ZXMgdGhlIGxlZnQvcmlnaHQgaW50ZXJuYWwgY29vcmRpbmF0ZSBhcnJheXMNCiAgICBDb29yZENhY2hlLnByb3RvdHlwZS5idWlsZEVsSG9yaXpvbnRhbHMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBsZWZ0cyA9IFtdOw0KICAgICAgICB2YXIgcmlnaHRzID0gW107DQogICAgICAgIHRoaXMuZWxzLmVhY2goZnVuY3Rpb24gKGksIG5vZGUpIHsNCiAgICAgICAgICAgIHZhciBlbCA9ICQobm9kZSk7DQogICAgICAgICAgICB2YXIgbGVmdCA9IGVsLm9mZnNldCgpLmxlZnQ7DQogICAgICAgICAgICB2YXIgd2lkdGggPSBlbC5vdXRlcldpZHRoKCk7DQogICAgICAgICAgICBsZWZ0cy5wdXNoKGxlZnQpOw0KICAgICAgICAgICAgcmlnaHRzLnB1c2gobGVmdCArIHdpZHRoKTsNCiAgICAgICAgfSk7DQogICAgICAgIHRoaXMubGVmdHMgPSBsZWZ0czsNCiAgICAgICAgdGhpcy5yaWdodHMgPSByaWdodHM7DQogICAgfTsNCiAgICAvLyBQb3B1bGF0ZXMgdGhlIHRvcC9ib3R0b20gaW50ZXJuYWwgY29vcmRpbmF0ZSBhcnJheXMNCiAgICBDb29yZENhY2hlLnByb3RvdHlwZS5idWlsZEVsVmVydGljYWxzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgdG9wcyA9IFtdOw0KICAgICAgICB2YXIgYm90dG9tcyA9IFtdOw0KICAgICAgICB0aGlzLmVscy5lYWNoKGZ1bmN0aW9uIChpLCBub2RlKSB7DQogICAgICAgICAgICB2YXIgZWwgPSAkKG5vZGUpOw0KICAgICAgICAgICAgdmFyIHRvcCA9IGVsLm9mZnNldCgpLnRvcDsNCiAgICAgICAgICAgIHZhciBoZWlnaHQgPSBlbC5vdXRlckhlaWdodCgpOw0KICAgICAgICAgICAgdG9wcy5wdXNoKHRvcCk7DQogICAgICAgICAgICBib3R0b21zLnB1c2godG9wICsgaGVpZ2h0KTsNCiAgICAgICAgfSk7DQogICAgICAgIHRoaXMudG9wcyA9IHRvcHM7DQogICAgICAgIHRoaXMuYm90dG9tcyA9IGJvdHRvbXM7DQogICAgfTsNCiAgICAvLyBHaXZlbiBhIGxlZnQgb2Zmc2V0IChmcm9tIGRvY3VtZW50IGxlZnQpLCByZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgZWwgdGhhdCBpdCBob3Jpem9udGFsbHkgaW50ZXJzZWN0cy4NCiAgICAvLyBJZiBubyBpbnRlcnNlY3Rpb24gaXMgbWFkZSwgcmV0dXJucyB1bmRlZmluZWQuDQogICAgQ29vcmRDYWNoZS5wcm90b3R5cGUuZ2V0SG9yaXpvbnRhbEluZGV4ID0gZnVuY3Rpb24gKGxlZnRPZmZzZXQpIHsNCiAgICAgICAgdGhpcy5lbnN1cmVCdWlsdCgpOw0KICAgICAgICB2YXIgbGVmdHMgPSB0aGlzLmxlZnRzOw0KICAgICAgICB2YXIgcmlnaHRzID0gdGhpcy5yaWdodHM7DQogICAgICAgIHZhciBsZW4gPSBsZWZ0cy5sZW5ndGg7DQogICAgICAgIHZhciBpOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsNCiAgICAgICAgICAgIGlmIChsZWZ0T2Zmc2V0ID49IGxlZnRzW2ldICYmIGxlZnRPZmZzZXQgPCByaWdodHNbaV0pIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gaTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gR2l2ZW4gYSB0b3Agb2Zmc2V0IChmcm9tIGRvY3VtZW50IHRvcCksIHJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBlbCB0aGF0IGl0IHZlcnRpY2FsbHkgaW50ZXJzZWN0cy4NCiAgICAvLyBJZiBubyBpbnRlcnNlY3Rpb24gaXMgbWFkZSwgcmV0dXJucyB1bmRlZmluZWQuDQogICAgQ29vcmRDYWNoZS5wcm90b3R5cGUuZ2V0VmVydGljYWxJbmRleCA9IGZ1bmN0aW9uICh0b3BPZmZzZXQpIHsNCiAgICAgICAgdGhpcy5lbnN1cmVCdWlsdCgpOw0KICAgICAgICB2YXIgdG9wcyA9IHRoaXMudG9wczsNCiAgICAgICAgdmFyIGJvdHRvbXMgPSB0aGlzLmJvdHRvbXM7DQogICAgICAgIHZhciBsZW4gPSB0b3BzLmxlbmd0aDsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgew0KICAgICAgICAgICAgaWYgKHRvcE9mZnNldCA+PSB0b3BzW2ldICYmIHRvcE9mZnNldCA8IGJvdHRvbXNbaV0pIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gaTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gR2V0cyB0aGUgbGVmdCBvZmZzZXQgKGZyb20gZG9jdW1lbnQgbGVmdCkgb2YgdGhlIGVsZW1lbnQgYXQgdGhlIGdpdmVuIGluZGV4DQogICAgQ29vcmRDYWNoZS5wcm90b3R5cGUuZ2V0TGVmdE9mZnNldCA9IGZ1bmN0aW9uIChsZWZ0SW5kZXgpIHsNCiAgICAgICAgdGhpcy5lbnN1cmVCdWlsdCgpOw0KICAgICAgICByZXR1cm4gdGhpcy5sZWZ0c1tsZWZ0SW5kZXhdOw0KICAgIH07DQogICAgLy8gR2V0cyB0aGUgbGVmdCBwb3NpdGlvbiAoZnJvbSBvZmZzZXRQYXJlbnQgbGVmdCkgb2YgdGhlIGVsZW1lbnQgYXQgdGhlIGdpdmVuIGluZGV4DQogICAgQ29vcmRDYWNoZS5wcm90b3R5cGUuZ2V0TGVmdFBvc2l0aW9uID0gZnVuY3Rpb24gKGxlZnRJbmRleCkgew0KICAgICAgICB0aGlzLmVuc3VyZUJ1aWx0KCk7DQogICAgICAgIHJldHVybiB0aGlzLmxlZnRzW2xlZnRJbmRleF0gLSB0aGlzLm9yaWdpbi5sZWZ0Ow0KICAgIH07DQogICAgLy8gR2V0cyB0aGUgcmlnaHQgb2Zmc2V0IChmcm9tIGRvY3VtZW50IGxlZnQpIG9mIHRoZSBlbGVtZW50IGF0IHRoZSBnaXZlbiBpbmRleC4NCiAgICAvLyBUaGlzIHZhbHVlIGlzIE5PVCByZWxhdGl2ZSB0byB0aGUgZG9jdW1lbnQncyByaWdodCBlZGdlLCBsaWtlIHRoZSBDU1MgY29uY2VwdCBvZiAicmlnaHQiIHdvdWxkIGJlLg0KICAgIENvb3JkQ2FjaGUucHJvdG90eXBlLmdldFJpZ2h0T2Zmc2V0ID0gZnVuY3Rpb24gKGxlZnRJbmRleCkgew0KICAgICAgICB0aGlzLmVuc3VyZUJ1aWx0KCk7DQogICAgICAgIHJldHVybiB0aGlzLnJpZ2h0c1tsZWZ0SW5kZXhdOw0KICAgIH07DQogICAgLy8gR2V0cyB0aGUgcmlnaHQgcG9zaXRpb24gKGZyb20gb2Zmc2V0UGFyZW50IGxlZnQpIG9mIHRoZSBlbGVtZW50IGF0IHRoZSBnaXZlbiBpbmRleC4NCiAgICAvLyBUaGlzIHZhbHVlIGlzIE5PVCByZWxhdGl2ZSB0byB0aGUgb2Zmc2V0UGFyZW50J3MgcmlnaHQgZWRnZSwgbGlrZSB0aGUgQ1NTIGNvbmNlcHQgb2YgInJpZ2h0IiB3b3VsZCBiZS4NCiAgICBDb29yZENhY2hlLnByb3RvdHlwZS5nZXRSaWdodFBvc2l0aW9uID0gZnVuY3Rpb24gKGxlZnRJbmRleCkgew0KICAgICAgICB0aGlzLmVuc3VyZUJ1aWx0KCk7DQogICAgICAgIHJldHVybiB0aGlzLnJpZ2h0c1tsZWZ0SW5kZXhdIC0gdGhpcy5vcmlnaW4ubGVmdDsNCiAgICB9Ow0KICAgIC8vIEdldHMgdGhlIHdpZHRoIG9mIHRoZSBlbGVtZW50IGF0IHRoZSBnaXZlbiBpbmRleA0KICAgIENvb3JkQ2FjaGUucHJvdG90eXBlLmdldFdpZHRoID0gZnVuY3Rpb24gKGxlZnRJbmRleCkgew0KICAgICAgICB0aGlzLmVuc3VyZUJ1aWx0KCk7DQogICAgICAgIHJldHVybiB0aGlzLnJpZ2h0c1tsZWZ0SW5kZXhdIC0gdGhpcy5sZWZ0c1tsZWZ0SW5kZXhdOw0KICAgIH07DQogICAgLy8gR2V0cyB0aGUgdG9wIG9mZnNldCAoZnJvbSBkb2N1bWVudCB0b3ApIG9mIHRoZSBlbGVtZW50IGF0IHRoZSBnaXZlbiBpbmRleA0KICAgIENvb3JkQ2FjaGUucHJvdG90eXBlLmdldFRvcE9mZnNldCA9IGZ1bmN0aW9uICh0b3BJbmRleCkgew0KICAgICAgICB0aGlzLmVuc3VyZUJ1aWx0KCk7DQogICAgICAgIHJldHVybiB0aGlzLnRvcHNbdG9wSW5kZXhdOw0KICAgIH07DQogICAgLy8gR2V0cyB0aGUgdG9wIHBvc2l0aW9uIChmcm9tIG9mZnNldFBhcmVudCB0b3ApIG9mIHRoZSBlbGVtZW50IGF0IHRoZSBnaXZlbiBwb3NpdGlvbg0KICAgIENvb3JkQ2FjaGUucHJvdG90eXBlLmdldFRvcFBvc2l0aW9uID0gZnVuY3Rpb24gKHRvcEluZGV4KSB7DQogICAgICAgIHRoaXMuZW5zdXJlQnVpbHQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXMudG9wc1t0b3BJbmRleF0gLSB0aGlzLm9yaWdpbi50b3A7DQogICAgfTsNCiAgICAvLyBHZXRzIHRoZSBib3R0b20gb2Zmc2V0IChmcm9tIHRoZSBkb2N1bWVudCB0b3ApIG9mIHRoZSBlbGVtZW50IGF0IHRoZSBnaXZlbiBpbmRleC4NCiAgICAvLyBUaGlzIHZhbHVlIGlzIE5PVCByZWxhdGl2ZSB0byB0aGUgb2Zmc2V0UGFyZW50J3MgYm90dG9tIGVkZ2UsIGxpa2UgdGhlIENTUyBjb25jZXB0IG9mICJib3R0b20iIHdvdWxkIGJlLg0KICAgIENvb3JkQ2FjaGUucHJvdG90eXBlLmdldEJvdHRvbU9mZnNldCA9IGZ1bmN0aW9uICh0b3BJbmRleCkgew0KICAgICAgICB0aGlzLmVuc3VyZUJ1aWx0KCk7DQogICAgICAgIHJldHVybiB0aGlzLmJvdHRvbXNbdG9wSW5kZXhdOw0KICAgIH07DQogICAgLy8gR2V0cyB0aGUgYm90dG9tIHBvc2l0aW9uIChmcm9tIHRoZSBvZmZzZXRQYXJlbnQgdG9wKSBvZiB0aGUgZWxlbWVudCBhdCB0aGUgZ2l2ZW4gaW5kZXguDQogICAgLy8gVGhpcyB2YWx1ZSBpcyBOT1QgcmVsYXRpdmUgdG8gdGhlIG9mZnNldFBhcmVudCdzIGJvdHRvbSBlZGdlLCBsaWtlIHRoZSBDU1MgY29uY2VwdCBvZiAiYm90dG9tIiB3b3VsZCBiZS4NCiAgICBDb29yZENhY2hlLnByb3RvdHlwZS5nZXRCb3R0b21Qb3NpdGlvbiA9IGZ1bmN0aW9uICh0b3BJbmRleCkgew0KICAgICAgICB0aGlzLmVuc3VyZUJ1aWx0KCk7DQogICAgICAgIHJldHVybiB0aGlzLmJvdHRvbXNbdG9wSW5kZXhdIC0gdGhpcy5vcmlnaW4udG9wOw0KICAgIH07DQogICAgLy8gR2V0cyB0aGUgaGVpZ2h0IG9mIHRoZSBlbGVtZW50IGF0IHRoZSBnaXZlbiBpbmRleA0KICAgIENvb3JkQ2FjaGUucHJvdG90eXBlLmdldEhlaWdodCA9IGZ1bmN0aW9uICh0b3BJbmRleCkgew0KICAgICAgICB0aGlzLmVuc3VyZUJ1aWx0KCk7DQogICAgICAgIHJldHVybiB0aGlzLmJvdHRvbXNbdG9wSW5kZXhdIC0gdGhpcy50b3BzW3RvcEluZGV4XTsNCiAgICB9Ow0KICAgIC8vIEJvdW5kaW5nIFJlY3QNCiAgICAvLyBUT0RPOiBkZWNvdXBsZSB0aGlzIGZyb20gQ29vcmRDYWNoZQ0KICAgIC8vIENvbXB1dGUgYW5kIHJldHVybiB3aGF0IHRoZSBlbGVtZW50cycgYm91bmRpbmcgcmVjdGFuZ2xlIGlzLCBmcm9tIHRoZSB1c2VyJ3MgcGVyc3BlY3RpdmUuDQogICAgLy8gUmlnaHQgbm93LCBvbmx5IHJldHVybnMgYSByZWN0YW5nbGUgaWYgY29uc3RyYWluZWQgYnkgYW4gb3ZlcmZsb3c6c2Nyb2xsIGVsZW1lbnQuDQogICAgLy8gUmV0dXJucyBudWxsIGlmIHRoZXJlIGFyZSBubyBlbGVtZW50cw0KICAgIENvb3JkQ2FjaGUucHJvdG90eXBlLnF1ZXJ5Qm91bmRpbmdSZWN0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgc2Nyb2xsUGFyZW50RWw7DQogICAgICAgIGlmICh0aGlzLmVscy5sZW5ndGggPiAwKSB7DQogICAgICAgICAgICBzY3JvbGxQYXJlbnRFbCA9IHV0aWxfMS5nZXRTY3JvbGxQYXJlbnQodGhpcy5lbHMuZXEoMCkpOw0KICAgICAgICAgICAgaWYgKCFzY3JvbGxQYXJlbnRFbC5pcyhkb2N1bWVudCkpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbF8xLmdldENsaWVudFJlY3Qoc2Nyb2xsUGFyZW50RWwpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiBudWxsOw0KICAgIH07DQogICAgQ29vcmRDYWNoZS5wcm90b3R5cGUuaXNQb2ludEluQm91bmRzID0gZnVuY3Rpb24gKGxlZnRPZmZzZXQsIHRvcE9mZnNldCkgew0KICAgICAgICByZXR1cm4gdGhpcy5pc0xlZnRJbkJvdW5kcyhsZWZ0T2Zmc2V0KSAmJiB0aGlzLmlzVG9wSW5Cb3VuZHModG9wT2Zmc2V0KTsNCiAgICB9Ow0KICAgIENvb3JkQ2FjaGUucHJvdG90eXBlLmlzTGVmdEluQm91bmRzID0gZnVuY3Rpb24gKGxlZnRPZmZzZXQpIHsNCiAgICAgICAgcmV0dXJuICF0aGlzLmJvdW5kaW5nUmVjdCB8fCAobGVmdE9mZnNldCA+PSB0aGlzLmJvdW5kaW5nUmVjdC5sZWZ0ICYmIGxlZnRPZmZzZXQgPCB0aGlzLmJvdW5kaW5nUmVjdC5yaWdodCk7DQogICAgfTsNCiAgICBDb29yZENhY2hlLnByb3RvdHlwZS5pc1RvcEluQm91bmRzID0gZnVuY3Rpb24gKHRvcE9mZnNldCkgew0KICAgICAgICByZXR1cm4gIXRoaXMuYm91bmRpbmdSZWN0IHx8ICh0b3BPZmZzZXQgPj0gdGhpcy5ib3VuZGluZ1JlY3QudG9wICYmIHRvcE9mZnNldCA8IHRoaXMuYm91bmRpbmdSZWN0LmJvdHRvbSk7DQogICAgfTsNCiAgICByZXR1cm4gQ29vcmRDYWNoZTsNCn0oKSk7DQpleHBvcnRzLmRlZmF1bHQgPSBDb29yZENhY2hlOw0KCgovKioqLyB9KSwKLyogNTQgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCnZhciB1dGlsXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQpOw0KdmFyIExpc3RlbmVyTWl4aW5fMSA9IF9fd2VicGFja19yZXF1aXJlX18oNyk7DQp2YXIgR2xvYmFsRW1pdHRlcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNSk7DQovKiBUcmFja3MgYSBkcmFnJ3MgbW91c2UgbW92ZW1lbnQsIGZpcmluZyB2YXJpb3VzIGhhbmRsZXJzDQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCi8vIFRPRE86IHVzZSBFbWl0dGVyDQp2YXIgRHJhZ0xpc3RlbmVyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgew0KICAgIGZ1bmN0aW9uIERyYWdMaXN0ZW5lcihvcHRpb25zKSB7DQogICAgICAgIHRoaXMuaXNJbnRlcmFjdGluZyA9IGZhbHNlOw0KICAgICAgICB0aGlzLmlzRGlzdGFuY2VTdXJwYXNzZWQgPSBmYWxzZTsNCiAgICAgICAgdGhpcy5pc0RlbGF5RW5kZWQgPSBmYWxzZTsNCiAgICAgICAgdGhpcy5pc0RyYWdnaW5nID0gZmFsc2U7DQogICAgICAgIHRoaXMuaXNUb3VjaCA9IGZhbHNlOw0KICAgICAgICB0aGlzLmlzR2VuZXJpYyA9IGZhbHNlOyAvLyBpbml0aWF0ZWQgYnkgJ2RyYWdzdGFydCcgKGpxdWkpDQogICAgICAgIHRoaXMuc2hvdWxkQ2FuY2VsVG91Y2hTY3JvbGwgPSB0cnVlOw0KICAgICAgICB0aGlzLnNjcm9sbEFsd2F5c0tpbGxzID0gZmFsc2U7DQogICAgICAgIHRoaXMuaXNBdXRvU2Nyb2xsID0gZmFsc2U7DQogICAgICAgIC8vIGRlZmF1bHRzDQogICAgICAgIHRoaXMuc2Nyb2xsU2Vuc2l0aXZpdHkgPSAzMDsgLy8gcGl4ZWxzIGZyb20gZWRnZSBmb3Igc2Nyb2xsaW5nIHRvIHN0YXJ0DQogICAgICAgIHRoaXMuc2Nyb2xsU3BlZWQgPSAyMDA7IC8vIHBpeGVscyBwZXIgc2Vjb25kLCBhdCBtYXhpbXVtIHNwZWVkDQogICAgICAgIHRoaXMuc2Nyb2xsSW50ZXJ2YWxNcyA9IDUwOyAvLyBtaWxsaXNlY29uZCB3YWl0IGJldHdlZW4gc2Nyb2xsIGluY3JlbWVudA0KICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9Ow0KICAgIH0NCiAgICAvLyBJbnRlcmFjdGlvbiAoaGlnaC1sZXZlbCkNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuc3RhcnRJbnRlcmFjdGlvbiA9IGZ1bmN0aW9uIChldiwgZXh0cmFPcHRpb25zKSB7DQogICAgICAgIGlmIChleHRyYU9wdGlvbnMgPT09IHZvaWQgMCkgeyBleHRyYU9wdGlvbnMgPSB7fTsgfQ0KICAgICAgICBpZiAoZXYudHlwZSA9PT0gJ21vdXNlZG93bicpIHsNCiAgICAgICAgICAgIGlmIChHbG9iYWxFbWl0dGVyXzEuZGVmYXVsdC5nZXQoKS5zaG91bGRJZ25vcmVNb3VzZSgpKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAoIXV0aWxfMS5pc1ByaW1hcnlNb3VzZUJ1dHRvbihldikpIHsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOyAvLyBwcmV2ZW50cyBuYXRpdmUgc2VsZWN0aW9uIGluIG1vc3QgYnJvd3NlcnMNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBpZiAoIXRoaXMuaXNJbnRlcmFjdGluZykgew0KICAgICAgICAgICAgLy8gcHJvY2VzcyBvcHRpb25zDQogICAgICAgICAgICB0aGlzLmRlbGF5ID0gdXRpbF8xLmZpcnN0RGVmaW5lZChleHRyYU9wdGlvbnMuZGVsYXksIHRoaXMub3B0aW9ucy5kZWxheSwgMCk7DQogICAgICAgICAgICB0aGlzLm1pbkRpc3RhbmNlID0gdXRpbF8xLmZpcnN0RGVmaW5lZChleHRyYU9wdGlvbnMuZGlzdGFuY2UsIHRoaXMub3B0aW9ucy5kaXN0YW5jZSwgMCk7DQogICAgICAgICAgICB0aGlzLnN1YmplY3RFbCA9IHRoaXMub3B0aW9ucy5zdWJqZWN0RWw7DQogICAgICAgICAgICB1dGlsXzEucHJldmVudFNlbGVjdGlvbigkKCdib2R5JykpOw0KICAgICAgICAgICAgdGhpcy5pc0ludGVyYWN0aW5nID0gdHJ1ZTsNCiAgICAgICAgICAgIHRoaXMuaXNUb3VjaCA9IHV0aWxfMS5nZXRFdklzVG91Y2goZXYpOw0KICAgICAgICAgICAgdGhpcy5pc0dlbmVyaWMgPSBldi50eXBlID09PSAnZHJhZ3N0YXJ0JzsNCiAgICAgICAgICAgIHRoaXMuaXNEZWxheUVuZGVkID0gZmFsc2U7DQogICAgICAgICAgICB0aGlzLmlzRGlzdGFuY2VTdXJwYXNzZWQgPSBmYWxzZTsNCiAgICAgICAgICAgIHRoaXMub3JpZ2luWCA9IHV0aWxfMS5nZXRFdlgoZXYpOw0KICAgICAgICAgICAgdGhpcy5vcmlnaW5ZID0gdXRpbF8xLmdldEV2WShldik7DQogICAgICAgICAgICB0aGlzLnNjcm9sbEVsID0gdXRpbF8xLmdldFNjcm9sbFBhcmVudCgkKGV2LnRhcmdldCkpOw0KICAgICAgICAgICAgdGhpcy5iaW5kSGFuZGxlcnMoKTsNCiAgICAgICAgICAgIHRoaXMuaW5pdEF1dG9TY3JvbGwoKTsNCiAgICAgICAgICAgIHRoaXMuaGFuZGxlSW50ZXJhY3Rpb25TdGFydChldik7DQogICAgICAgICAgICB0aGlzLnN0YXJ0RGVsYXkoZXYpOw0KICAgICAgICAgICAgaWYgKCF0aGlzLm1pbkRpc3RhbmNlKSB7DQogICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVEaXN0YW5jZVN1cnBhc3NlZChldik7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9Ow0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuaGFuZGxlSW50ZXJhY3Rpb25TdGFydCA9IGZ1bmN0aW9uIChldikgew0KICAgICAgICB0aGlzLnRyaWdnZXIoJ2ludGVyYWN0aW9uU3RhcnQnLCBldik7DQogICAgfTsNCiAgICBEcmFnTGlzdGVuZXIucHJvdG90eXBlLmVuZEludGVyYWN0aW9uID0gZnVuY3Rpb24gKGV2LCBpc0NhbmNlbGxlZCkgew0KICAgICAgICBpZiAodGhpcy5pc0ludGVyYWN0aW5nKSB7DQogICAgICAgICAgICB0aGlzLmVuZERyYWcoZXYpOw0KICAgICAgICAgICAgaWYgKHRoaXMuZGVsYXlUaW1lb3V0SWQpIHsNCiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5kZWxheVRpbWVvdXRJZCk7DQogICAgICAgICAgICAgICAgdGhpcy5kZWxheVRpbWVvdXRJZCA9IG51bGw7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLmRlc3Ryb3lBdXRvU2Nyb2xsKCk7DQogICAgICAgICAgICB0aGlzLnVuYmluZEhhbmRsZXJzKCk7DQogICAgICAgICAgICB0aGlzLmlzSW50ZXJhY3RpbmcgPSBmYWxzZTsNCiAgICAgICAgICAgIHRoaXMuaGFuZGxlSW50ZXJhY3Rpb25FbmQoZXYsIGlzQ2FuY2VsbGVkKTsNCiAgICAgICAgICAgIHV0aWxfMS5hbGxvd1NlbGVjdGlvbigkKCdib2R5JykpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBEcmFnTGlzdGVuZXIucHJvdG90eXBlLmhhbmRsZUludGVyYWN0aW9uRW5kID0gZnVuY3Rpb24gKGV2LCBpc0NhbmNlbGxlZCkgew0KICAgICAgICB0aGlzLnRyaWdnZXIoJ2ludGVyYWN0aW9uRW5kJywgZXYsIGlzQ2FuY2VsbGVkIHx8IGZhbHNlKTsNCiAgICB9Ow0KICAgIC8vIEJpbmRpbmcgVG8gRE9NDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICBEcmFnTGlzdGVuZXIucHJvdG90eXBlLmJpbmRIYW5kbGVycyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgLy8gc29tZSBicm93c2VycyAoU2FmYXJpIGluIGlPUyAxMCkgZG9uJ3QgYWxsb3cgcHJldmVudERlZmF1bHQgb24gdG91Y2ggZXZlbnRzIHRoYXQgYXJlIGJvdW5kIGFmdGVyIHRvdWNoc3RhcnQsDQogICAgICAgIC8vIHNvIGxpc3RlbiB0byB0aGUgR2xvYmFsRW1pdHRlciBzaW5nbGV0b24sIHdoaWNoIGlzIGFsd2F5cyBib3VuZCwgaW5zdGVhZCBvZiB0aGUgZG9jdW1lbnQgZGlyZWN0bHkuDQogICAgICAgIHZhciBnbG9iYWxFbWl0dGVyID0gR2xvYmFsRW1pdHRlcl8xLmRlZmF1bHQuZ2V0KCk7DQogICAgICAgIGlmICh0aGlzLmlzR2VuZXJpYykgew0KICAgICAgICAgICAgdGhpcy5saXN0ZW5UbygkKGRvY3VtZW50KSwgew0KICAgICAgICAgICAgICAgIGRyYWc6IHRoaXMuaGFuZGxlTW92ZSwNCiAgICAgICAgICAgICAgICBkcmFnc3RvcDogdGhpcy5lbmRJbnRlcmFjdGlvbg0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAodGhpcy5pc1RvdWNoKSB7DQogICAgICAgICAgICB0aGlzLmxpc3RlblRvKGdsb2JhbEVtaXR0ZXIsIHsNCiAgICAgICAgICAgICAgICB0b3VjaG1vdmU6IHRoaXMuaGFuZGxlVG91Y2hNb3ZlLA0KICAgICAgICAgICAgICAgIHRvdWNoZW5kOiB0aGlzLmVuZEludGVyYWN0aW9uLA0KICAgICAgICAgICAgICAgIHNjcm9sbDogdGhpcy5oYW5kbGVUb3VjaFNjcm9sbA0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICB0aGlzLmxpc3RlblRvKGdsb2JhbEVtaXR0ZXIsIHsNCiAgICAgICAgICAgICAgICBtb3VzZW1vdmU6IHRoaXMuaGFuZGxlTW91c2VNb3ZlLA0KICAgICAgICAgICAgICAgIG1vdXNldXA6IHRoaXMuZW5kSW50ZXJhY3Rpb24NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQogICAgICAgIHRoaXMubGlzdGVuVG8oZ2xvYmFsRW1pdHRlciwgew0KICAgICAgICAgICAgc2VsZWN0c3RhcnQ6IHV0aWxfMS5wcmV2ZW50RGVmYXVsdCwNCiAgICAgICAgICAgIGNvbnRleHRtZW51OiB1dGlsXzEucHJldmVudERlZmF1bHQgLy8gbG9uZyB0YXBzIHdvdWxkIG9wZW4gbWVudSBvbiBDaHJvbWUgZGV2IHRvb2xzDQogICAgICAgIH0pOw0KICAgIH07DQogICAgRHJhZ0xpc3RlbmVyLnByb3RvdHlwZS51bmJpbmRIYW5kbGVycyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nVG8oR2xvYmFsRW1pdHRlcl8xLmRlZmF1bHQuZ2V0KCkpOw0KICAgICAgICB0aGlzLnN0b3BMaXN0ZW5pbmdUbygkKGRvY3VtZW50KSk7IC8vIGZvciBpc0dlbmVyaWMNCiAgICB9Ow0KICAgIC8vIERyYWcgKGhpZ2gtbGV2ZWwpDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAvLyBleHRyYU9wdGlvbnMgaWdub3JlZCBpZiBkcmFnIGFscmVhZHkgc3RhcnRlZA0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuc3RhcnREcmFnID0gZnVuY3Rpb24gKGV2LCBleHRyYU9wdGlvbnMpIHsNCiAgICAgICAgdGhpcy5zdGFydEludGVyYWN0aW9uKGV2LCBleHRyYU9wdGlvbnMpOyAvLyBlbnN1cmUgaW50ZXJhY3Rpb24gYmVnYW4NCiAgICAgICAgaWYgKCF0aGlzLmlzRHJhZ2dpbmcpIHsNCiAgICAgICAgICAgIHRoaXMuaXNEcmFnZ2luZyA9IHRydWU7DQogICAgICAgICAgICB0aGlzLmhhbmRsZURyYWdTdGFydChldik7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuaGFuZGxlRHJhZ1N0YXJ0ID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIHRoaXMudHJpZ2dlcignZHJhZ1N0YXJ0JywgZXYpOw0KICAgIH07DQogICAgRHJhZ0xpc3RlbmVyLnByb3RvdHlwZS5oYW5kbGVNb3ZlID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIHZhciBkeCA9IHV0aWxfMS5nZXRFdlgoZXYpIC0gdGhpcy5vcmlnaW5YOw0KICAgICAgICB2YXIgZHkgPSB1dGlsXzEuZ2V0RXZZKGV2KSAtIHRoaXMub3JpZ2luWTsNCiAgICAgICAgdmFyIG1pbkRpc3RhbmNlID0gdGhpcy5taW5EaXN0YW5jZTsNCiAgICAgICAgdmFyIGRpc3RhbmNlU3E7IC8vIGN1cnJlbnQgZGlzdGFuY2UgZnJvbSB0aGUgb3JpZ2luLCBzcXVhcmVkDQogICAgICAgIGlmICghdGhpcy5pc0Rpc3RhbmNlU3VycGFzc2VkKSB7DQogICAgICAgICAgICBkaXN0YW5jZVNxID0gZHggKiBkeCArIGR5ICogZHk7DQogICAgICAgICAgICBpZiAoZGlzdGFuY2VTcSA+PSBtaW5EaXN0YW5jZSAqIG1pbkRpc3RhbmNlKSB7DQogICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVEaXN0YW5jZVN1cnBhc3NlZChldik7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgaWYgKHRoaXMuaXNEcmFnZ2luZykgew0KICAgICAgICAgICAgdGhpcy5oYW5kbGVEcmFnKGR4LCBkeSwgZXYpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBDYWxsZWQgd2hpbGUgdGhlIG1vdXNlIGlzIGJlaW5nIG1vdmVkIGFuZCB3aGVuIHdlIGtub3cgYSBsZWdpdGltYXRlIGRyYWcgaXMgdGFraW5nIHBsYWNlDQogICAgRHJhZ0xpc3RlbmVyLnByb3RvdHlwZS5oYW5kbGVEcmFnID0gZnVuY3Rpb24gKGR4LCBkeSwgZXYpIHsNCiAgICAgICAgdGhpcy50cmlnZ2VyKCdkcmFnJywgZHgsIGR5LCBldik7DQogICAgICAgIHRoaXMudXBkYXRlQXV0b1Njcm9sbChldik7IC8vIHdpbGwgcG9zc2libHkgY2F1c2Ugc2Nyb2xsaW5nDQogICAgfTsNCiAgICBEcmFnTGlzdGVuZXIucHJvdG90eXBlLmVuZERyYWcgPSBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgaWYgKHRoaXMuaXNEcmFnZ2luZykgew0KICAgICAgICAgICAgdGhpcy5pc0RyYWdnaW5nID0gZmFsc2U7DQogICAgICAgICAgICB0aGlzLmhhbmRsZURyYWdFbmQoZXYpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBEcmFnTGlzdGVuZXIucHJvdG90eXBlLmhhbmRsZURyYWdFbmQgPSBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgdGhpcy50cmlnZ2VyKCdkcmFnRW5kJywgZXYpOw0KICAgIH07DQogICAgLy8gRGVsYXkNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuc3RhcnREZWxheSA9IGZ1bmN0aW9uIChpbml0aWFsRXYpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgaWYgKHRoaXMuZGVsYXkpIHsNCiAgICAgICAgICAgIHRoaXMuZGVsYXlUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICBfdGhpcy5oYW5kbGVEZWxheUVuZChpbml0aWFsRXYpOw0KICAgICAgICAgICAgfSwgdGhpcy5kZWxheSk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICB0aGlzLmhhbmRsZURlbGF5RW5kKGluaXRpYWxFdik7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuaGFuZGxlRGVsYXlFbmQgPSBmdW5jdGlvbiAoaW5pdGlhbEV2KSB7DQogICAgICAgIHRoaXMuaXNEZWxheUVuZGVkID0gdHJ1ZTsNCiAgICAgICAgaWYgKHRoaXMuaXNEaXN0YW5jZVN1cnBhc3NlZCkgew0KICAgICAgICAgICAgdGhpcy5zdGFydERyYWcoaW5pdGlhbEV2KTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gRGlzdGFuY2UNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuaGFuZGxlRGlzdGFuY2VTdXJwYXNzZWQgPSBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgdGhpcy5pc0Rpc3RhbmNlU3VycGFzc2VkID0gdHJ1ZTsNCiAgICAgICAgaWYgKHRoaXMuaXNEZWxheUVuZGVkKSB7DQogICAgICAgICAgICB0aGlzLnN0YXJ0RHJhZyhldik7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIE1vdXNlIC8gVG91Y2gNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuaGFuZGxlVG91Y2hNb3ZlID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIC8vIHByZXZlbnQgaW5lcnRpYSBhbmQgdG91Y2htb3ZlLXNjcm9sbGluZyB3aGlsZSBkcmFnZ2luZw0KICAgICAgICBpZiAodGhpcy5pc0RyYWdnaW5nICYmIHRoaXMuc2hvdWxkQ2FuY2VsVG91Y2hTY3JvbGwpIHsNCiAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5oYW5kbGVNb3ZlKGV2KTsNCiAgICB9Ow0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuaGFuZGxlTW91c2VNb3ZlID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIHRoaXMuaGFuZGxlTW92ZShldik7DQogICAgfTsNCiAgICAvLyBTY3JvbGxpbmcgKHVucmVsYXRlZCB0byBhdXRvLXNjcm9sbCkNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuaGFuZGxlVG91Y2hTY3JvbGwgPSBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgLy8gaWYgdGhlIGRyYWcgaXMgYmVpbmcgaW5pdGlhdGVkIGJ5IHRvdWNoLCBidXQgYSBzY3JvbGwgaGFwcGVucyBiZWZvcmUNCiAgICAgICAgLy8gdGhlIGRyYWctaW5pdGlhdGluZyBkZWxheSBpcyBvdmVyLCBjYW5jZWwgdGhlIGRyYWcNCiAgICAgICAgaWYgKCF0aGlzLmlzRHJhZ2dpbmcgfHwgdGhpcy5zY3JvbGxBbHdheXNLaWxscykgew0KICAgICAgICAgICAgdGhpcy5lbmRJbnRlcmFjdGlvbihldiwgdHJ1ZSk7IC8vIGlzQ2FuY2VsbGVkPXRydWUNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gVXRpbHMNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIC8vIFRyaWdnZXJzIGEgY2FsbGJhY2suIENhbGxzIGEgZnVuY3Rpb24gaW4gdGhlIG9wdGlvbiBoYXNoIG9mIHRoZSBzYW1lIG5hbWUuDQogICAgLy8gQXJndW1lbnRzIGJleW9uZCB0aGUgZmlyc3QgYG5hbWVgIGFyZSBmb3J3YXJkZWQgb24uDQogICAgRHJhZ0xpc3RlbmVyLnByb3RvdHlwZS50cmlnZ2VyID0gZnVuY3Rpb24gKG5hbWUpIHsNCiAgICAgICAgdmFyIGFyZ3MgPSBbXTsNCiAgICAgICAgZm9yICh2YXIgX2kgPSAxOyBfaSA8IGFyZ3VtZW50cy5sZW5ndGg7IF9pKyspIHsNCiAgICAgICAgICAgIGFyZ3NbX2kgLSAxXSA9IGFyZ3VtZW50c1tfaV07DQogICAgICAgIH0NCiAgICAgICAgaWYgKHRoaXMub3B0aW9uc1tuYW1lXSkgew0KICAgICAgICAgICAgdGhpcy5vcHRpb25zW25hbWVdLmFwcGx5KHRoaXMsIGFyZ3MpOw0KICAgICAgICB9DQogICAgICAgIC8vIG1ha2VzIF9tZXRob2RzIGNhbGxhYmxlIGJ5IGV2ZW50IG5hbWUuIFRPRE86IGtpbGwgdGhpcw0KICAgICAgICBpZiAodGhpc1snXycgKyBuYW1lXSkgew0KICAgICAgICAgICAgdGhpc1snXycgKyBuYW1lXS5hcHBseSh0aGlzLCBhcmdzKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gQXV0by1zY3JvbGwNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuaW5pdEF1dG9TY3JvbGwgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBzY3JvbGxFbCA9IHRoaXMuc2Nyb2xsRWw7DQogICAgICAgIHRoaXMuaXNBdXRvU2Nyb2xsID0NCiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5zY3JvbGwgJiYNCiAgICAgICAgICAgICAgICBzY3JvbGxFbCAmJg0KICAgICAgICAgICAgICAgICFzY3JvbGxFbC5pcyh3aW5kb3cpICYmDQogICAgICAgICAgICAgICAgIXNjcm9sbEVsLmlzKGRvY3VtZW50KTsNCiAgICAgICAgaWYgKHRoaXMuaXNBdXRvU2Nyb2xsKSB7DQogICAgICAgICAgICAvLyBkZWJvdW5jZSBtYWtlcyBzdXJlIHJhcGlkIGNhbGxzIGRvbid0IGhhcHBlbg0KICAgICAgICAgICAgdGhpcy5saXN0ZW5UbyhzY3JvbGxFbCwgJ3Njcm9sbCcsIHV0aWxfMS5kZWJvdW5jZSh0aGlzLmhhbmRsZURlYm91bmNlZFNjcm9sbCwgMTAwKSk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuZGVzdHJveUF1dG9TY3JvbGwgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMuZW5kQXV0b1Njcm9sbCgpOyAvLyBraWxsIGFueSBhbmltYXRpb24gbG9vcA0KICAgICAgICAvLyByZW1vdmUgdGhlIHNjcm9sbCBoYW5kbGVyIGlmIHRoZXJlIGlzIGEgc2Nyb2xsRWwNCiAgICAgICAgaWYgKHRoaXMuaXNBdXRvU2Nyb2xsKSB7DQogICAgICAgICAgICB0aGlzLnN0b3BMaXN0ZW5pbmdUbyh0aGlzLnNjcm9sbEVsLCAnc2Nyb2xsJyk7IC8vIHdpbGwgcHJvYmFibHkgZ2V0IHJlbW92ZWQgYnkgdW5iaW5kSGFuZGxlcnMgdG9vIDooDQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIENvbXB1dGVzIGFuZCBzdG9yZXMgdGhlIGJvdW5kaW5nIHJlY3RhbmdsZSBvZiBzY3JvbGxFbA0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuY29tcHV0ZVNjcm9sbEJvdW5kcyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMuaXNBdXRvU2Nyb2xsKSB7DQogICAgICAgICAgICB0aGlzLnNjcm9sbEJvdW5kcyA9IHV0aWxfMS5nZXRPdXRlclJlY3QodGhpcy5zY3JvbGxFbCk7DQogICAgICAgICAgICAvLyBUT0RPOiB1c2UgZ2V0Q2xpZW50UmVjdCBpbiBmdXR1cmUuIGJ1dCBwcmV2ZW50cyBhdXRvIHNjcm9sbGluZyB3aGVuIG9uIHRvcCBvZiBzY3JvbGxiYXJzDQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIENhbGxlZCB3aGVuIHRoZSBkcmFnZ2luZyBpcyBpbiBwcm9ncmVzcyBhbmQgc2Nyb2xsaW5nIHNob3VsZCBiZSB1cGRhdGVkDQogICAgRHJhZ0xpc3RlbmVyLnByb3RvdHlwZS51cGRhdGVBdXRvU2Nyb2xsID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIHZhciBzZW5zaXRpdml0eSA9IHRoaXMuc2Nyb2xsU2Vuc2l0aXZpdHk7DQogICAgICAgIHZhciBib3VuZHMgPSB0aGlzLnNjcm9sbEJvdW5kczsNCiAgICAgICAgdmFyIHRvcENsb3NlbmVzczsNCiAgICAgICAgdmFyIGJvdHRvbUNsb3NlbmVzczsNCiAgICAgICAgdmFyIGxlZnRDbG9zZW5lc3M7DQogICAgICAgIHZhciByaWdodENsb3NlbmVzczsNCiAgICAgICAgdmFyIHRvcFZlbCA9IDA7DQogICAgICAgIHZhciBsZWZ0VmVsID0gMDsNCiAgICAgICAgaWYgKGJvdW5kcykgew0KICAgICAgICAgICAgLy8gY29tcHV0ZSBjbG9zZW5lc3MgdG8gZWRnZXMuIHZhbGlkIHJhbmdlIGlzIGZyb20gMC4wIC0gMS4wDQogICAgICAgICAgICB0b3BDbG9zZW5lc3MgPSAoc2Vuc2l0aXZpdHkgLSAodXRpbF8xLmdldEV2WShldikgLSBib3VuZHMudG9wKSkgLyBzZW5zaXRpdml0eTsNCiAgICAgICAgICAgIGJvdHRvbUNsb3NlbmVzcyA9IChzZW5zaXRpdml0eSAtIChib3VuZHMuYm90dG9tIC0gdXRpbF8xLmdldEV2WShldikpKSAvIHNlbnNpdGl2aXR5Ow0KICAgICAgICAgICAgbGVmdENsb3NlbmVzcyA9IChzZW5zaXRpdml0eSAtICh1dGlsXzEuZ2V0RXZYKGV2KSAtIGJvdW5kcy5sZWZ0KSkgLyBzZW5zaXRpdml0eTsNCiAgICAgICAgICAgIHJpZ2h0Q2xvc2VuZXNzID0gKHNlbnNpdGl2aXR5IC0gKGJvdW5kcy5yaWdodCAtIHV0aWxfMS5nZXRFdlgoZXYpKSkgLyBzZW5zaXRpdml0eTsNCiAgICAgICAgICAgIC8vIHRyYW5zbGF0ZSB2ZXJ0aWNhbCBjbG9zZW5lc3MgaW50byB2ZWxvY2l0eS4NCiAgICAgICAgICAgIC8vIG1vdXNlIG11c3QgYmUgY29tcGxldGVseSBpbiBib3VuZHMgZm9yIHZlbG9jaXR5IHRvIGhhcHBlbi4NCiAgICAgICAgICAgIGlmICh0b3BDbG9zZW5lc3MgPj0gMCAmJiB0b3BDbG9zZW5lc3MgPD0gMSkgew0KICAgICAgICAgICAgICAgIHRvcFZlbCA9IHRvcENsb3NlbmVzcyAqIHRoaXMuc2Nyb2xsU3BlZWQgKiAtMTsgLy8gbmVnYXRpdmUuIGZvciBzY3JvbGxpbmcgdXANCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2UgaWYgKGJvdHRvbUNsb3NlbmVzcyA+PSAwICYmIGJvdHRvbUNsb3NlbmVzcyA8PSAxKSB7DQogICAgICAgICAgICAgICAgdG9wVmVsID0gYm90dG9tQ2xvc2VuZXNzICogdGhpcy5zY3JvbGxTcGVlZDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIC8vIHRyYW5zbGF0ZSBob3Jpem9udGFsIGNsb3NlbmVzcyBpbnRvIHZlbG9jaXR5DQogICAgICAgICAgICBpZiAobGVmdENsb3NlbmVzcyA+PSAwICYmIGxlZnRDbG9zZW5lc3MgPD0gMSkgew0KICAgICAgICAgICAgICAgIGxlZnRWZWwgPSBsZWZ0Q2xvc2VuZXNzICogdGhpcy5zY3JvbGxTcGVlZCAqIC0xOyAvLyBuZWdhdGl2ZS4gZm9yIHNjcm9sbGluZyBsZWZ0DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIGlmIChyaWdodENsb3NlbmVzcyA+PSAwICYmIHJpZ2h0Q2xvc2VuZXNzIDw9IDEpIHsNCiAgICAgICAgICAgICAgICBsZWZ0VmVsID0gcmlnaHRDbG9zZW5lc3MgKiB0aGlzLnNjcm9sbFNwZWVkOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHRoaXMuc2V0U2Nyb2xsVmVsKHRvcFZlbCwgbGVmdFZlbCk7DQogICAgfTsNCiAgICAvLyBTZXRzIHRoZSBzcGVlZC1vZi1zY3JvbGxpbmcgZm9yIHRoZSBzY3JvbGxFbA0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuc2V0U2Nyb2xsVmVsID0gZnVuY3Rpb24gKHRvcFZlbCwgbGVmdFZlbCkgew0KICAgICAgICB0aGlzLnNjcm9sbFRvcFZlbCA9IHRvcFZlbDsNCiAgICAgICAgdGhpcy5zY3JvbGxMZWZ0VmVsID0gbGVmdFZlbDsNCiAgICAgICAgdGhpcy5jb25zdHJhaW5TY3JvbGxWZWwoKTsgLy8gbWFzc2FnZXMgaW50byByZWFsaXN0aWMgdmFsdWVzDQogICAgICAgIC8vIGlmIHRoZXJlIGlzIG5vbi16ZXJvIHZlbG9jaXR5LCBhbmQgYW4gYW5pbWF0aW9uIGxvb3AgaGFzbid0IGFscmVhZHkgc3RhcnRlZCwgdGhlbiBTVEFSVA0KICAgICAgICBpZiAoKHRoaXMuc2Nyb2xsVG9wVmVsIHx8IHRoaXMuc2Nyb2xsTGVmdFZlbCkgJiYgIXRoaXMuc2Nyb2xsSW50ZXJ2YWxJZCkgew0KICAgICAgICAgICAgdGhpcy5zY3JvbGxJbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwodXRpbF8xLnByb3h5KHRoaXMsICdzY3JvbGxJbnRlcnZhbEZ1bmMnKSwgLy8gc2NvcGUgdG8gYHRoaXNgDQogICAgICAgICAgICB0aGlzLnNjcm9sbEludGVydmFsTXMpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBGb3JjZXMgc2Nyb2xsVG9wVmVsIGFuZCBzY3JvbGxMZWZ0VmVsIHRvIGJlIHplcm8gaWYgc2Nyb2xsaW5nIGhhcyBhbHJlYWR5IGdvbmUgYWxsIHRoZSB3YXkNCiAgICBEcmFnTGlzdGVuZXIucHJvdG90eXBlLmNvbnN0cmFpblNjcm9sbFZlbCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIGVsID0gdGhpcy5zY3JvbGxFbDsNCiAgICAgICAgaWYgKHRoaXMuc2Nyb2xsVG9wVmVsIDwgMCkgew0KICAgICAgICAgICAgaWYgKGVsLnNjcm9sbFRvcCgpIDw9IDApIHsNCiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbFRvcFZlbCA9IDA7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAodGhpcy5zY3JvbGxUb3BWZWwgPiAwKSB7DQogICAgICAgICAgICBpZiAoZWwuc2Nyb2xsVG9wKCkgKyBlbFswXS5jbGllbnRIZWlnaHQgPj0gZWxbMF0uc2Nyb2xsSGVpZ2h0KSB7DQogICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxUb3BWZWwgPSAwOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGlmICh0aGlzLnNjcm9sbExlZnRWZWwgPCAwKSB7DQogICAgICAgICAgICBpZiAoZWwuc2Nyb2xsTGVmdCgpIDw9IDApIHsNCiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbExlZnRWZWwgPSAwOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGVsc2UgaWYgKHRoaXMuc2Nyb2xsTGVmdFZlbCA+IDApIHsNCiAgICAgICAgICAgIGlmIChlbC5zY3JvbGxMZWZ0KCkgKyBlbFswXS5jbGllbnRXaWR0aCA+PSBlbFswXS5zY3JvbGxXaWR0aCkgew0KICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsTGVmdFZlbCA9IDA7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIFRoaXMgZnVuY3Rpb24gZ2V0cyBjYWxsZWQgZHVyaW5nIGV2ZXJ5IGl0ZXJhdGlvbiBvZiB0aGUgc2Nyb2xsaW5nIGFuaW1hdGlvbiBsb29wDQogICAgRHJhZ0xpc3RlbmVyLnByb3RvdHlwZS5zY3JvbGxJbnRlcnZhbEZ1bmMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBlbCA9IHRoaXMuc2Nyb2xsRWw7DQogICAgICAgIHZhciBmcmFjID0gdGhpcy5zY3JvbGxJbnRlcnZhbE1zIC8gMTAwMDsgLy8gY29uc2lkZXJpbmcgYW5pbWF0aW9uIGZyZXF1ZW5jeSwgd2hhdCB0aGUgdmVsIHNob3VsZCBiZSBtdWx0J2QgYnkNCiAgICAgICAgLy8gY2hhbmdlIHRoZSB2YWx1ZSBvZiBzY3JvbGxFbCdzIHNjcm9sbA0KICAgICAgICBpZiAodGhpcy5zY3JvbGxUb3BWZWwpIHsNCiAgICAgICAgICAgIGVsLnNjcm9sbFRvcChlbC5zY3JvbGxUb3AoKSArIHRoaXMuc2Nyb2xsVG9wVmVsICogZnJhYyk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHRoaXMuc2Nyb2xsTGVmdFZlbCkgew0KICAgICAgICAgICAgZWwuc2Nyb2xsTGVmdChlbC5zY3JvbGxMZWZ0KCkgKyB0aGlzLnNjcm9sbExlZnRWZWwgKiBmcmFjKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmNvbnN0cmFpblNjcm9sbFZlbCgpOyAvLyBzaW5jZSB0aGUgc2Nyb2xsIHZhbHVlcyBjaGFuZ2VkLCByZWNvbXB1dGUgdGhlIHZlbG9jaXRpZXMNCiAgICAgICAgLy8gaWYgc2Nyb2xsZWQgYWxsIHRoZSB3YXksIHdoaWNoIGNhdXNlcyB0aGUgdmVscyB0byBiZSB6ZXJvLCBzdG9wIHRoZSBhbmltYXRpb24gbG9vcA0KICAgICAgICBpZiAoIXRoaXMuc2Nyb2xsVG9wVmVsICYmICF0aGlzLnNjcm9sbExlZnRWZWwpIHsNCiAgICAgICAgICAgIHRoaXMuZW5kQXV0b1Njcm9sbCgpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBLaWxscyBhbnkgZXhpc3Rpbmcgc2Nyb2xsaW5nIGFuaW1hdGlvbiBsb29wDQogICAgRHJhZ0xpc3RlbmVyLnByb3RvdHlwZS5lbmRBdXRvU2Nyb2xsID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5zY3JvbGxJbnRlcnZhbElkKSB7DQogICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMuc2Nyb2xsSW50ZXJ2YWxJZCk7DQogICAgICAgICAgICB0aGlzLnNjcm9sbEludGVydmFsSWQgPSBudWxsOw0KICAgICAgICAgICAgdGhpcy5oYW5kbGVTY3JvbGxFbmQoKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gR2V0IGNhbGxlZCB3aGVuIHRoZSBzY3JvbGxFbCBpcyBzY3JvbGxlZCAoTk9URTogdGhpcyBpcyBkZWxheWVkIHZpYSBkZWJvdW5jZSkNCiAgICBEcmFnTGlzdGVuZXIucHJvdG90eXBlLmhhbmRsZURlYm91bmNlZFNjcm9sbCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgLy8gcmVjb21wdXRlIGFsbCBjb29yZGluYXRlcywgYnV0ICpvbmx5KiBpZiB0aGlzIGlzICpub3QqIHBhcnQgb2Ygb3VyIHNjcm9sbGluZyBhbmltYXRpb24NCiAgICAgICAgaWYgKCF0aGlzLnNjcm9sbEludGVydmFsSWQpIHsNCiAgICAgICAgICAgIHRoaXMuaGFuZGxlU2Nyb2xsRW5kKCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIERyYWdMaXN0ZW5lci5wcm90b3R5cGUuaGFuZGxlU2Nyb2xsRW5kID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAvLyBDYWxsZWQgd2hlbiBzY3JvbGxpbmcgaGFzIHN0b3BwZWQsIHdoZXRoZXIgdGhyb3VnaCBhdXRvIHNjcm9sbCwgb3IgdGhlIHVzZXIgc2Nyb2xsaW5nDQogICAgfTsNCiAgICByZXR1cm4gRHJhZ0xpc3RlbmVyOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IERyYWdMaXN0ZW5lcjsNCkxpc3RlbmVyTWl4aW5fMS5kZWZhdWx0Lm1peEludG8oRHJhZ0xpc3RlbmVyKTsNCgoKLyoqKi8gfSksCi8qIDU1ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdHNsaWJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCnZhciBNaXhpbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNCk7DQovKg0KQSBzZXQgb2YgcmVuZGVyaW5nIGFuZCBkYXRlLXJlbGF0ZWQgbWV0aG9kcyBmb3IgYSB2aXN1YWwgY29tcG9uZW50IGNvbXByaXNlZCBvZiBvbmUgb3IgbW9yZSByb3dzIG9mIGRheSBjb2x1bW5zLg0KUHJlcmVxdWlzaXRlOiB0aGUgb2JqZWN0IGJlaW5nIG1peGVkIGludG8gbmVlZHMgdG8gYmUgYSAqR3JpZCoNCiovDQp2YXIgRGF5VGFibGVNaXhpbiA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHsNCiAgICB0c2xpYl8xLl9fZXh0ZW5kcyhEYXlUYWJsZU1peGluLCBfc3VwZXIpOw0KICAgIGZ1bmN0aW9uIERheVRhYmxlTWl4aW4oKSB7DQogICAgICAgIHJldHVybiBfc3VwZXIgIT09IG51bGwgJiYgX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsNCiAgICB9DQogICAgLy8gUG9wdWxhdGVzIGludGVybmFsIHZhcmlhYmxlcyB1c2VkIGZvciBkYXRlIGNhbGN1bGF0aW9uIGFuZCByZW5kZXJpbmcNCiAgICBEYXlUYWJsZU1peGluLnByb3RvdHlwZS51cGRhdGVEYXlUYWJsZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIHQgPSB0aGlzOw0KICAgICAgICB2YXIgdmlldyA9IHQudmlldzsNCiAgICAgICAgdmFyIGNhbGVuZGFyID0gdmlldy5jYWxlbmRhcjsNCiAgICAgICAgdmFyIGRhdGUgPSBjYWxlbmRhci5tc1RvVXRjTW9tZW50KHQuZGF0ZVByb2ZpbGUucmVuZGVyVW56b25lZFJhbmdlLnN0YXJ0TXMsIHRydWUpOw0KICAgICAgICB2YXIgZW5kID0gY2FsZW5kYXIubXNUb1V0Y01vbWVudCh0LmRhdGVQcm9maWxlLnJlbmRlclVuem9uZWRSYW5nZS5lbmRNcywgdHJ1ZSk7DQogICAgICAgIHZhciBkYXlJbmRleCA9IC0xOw0KICAgICAgICB2YXIgZGF5SW5kaWNlcyA9IFtdOw0KICAgICAgICB2YXIgZGF5RGF0ZXMgPSBbXTsNCiAgICAgICAgdmFyIGRheXNQZXJSb3c7DQogICAgICAgIHZhciBmaXJzdERheTsNCiAgICAgICAgdmFyIHJvd0NudDsNCiAgICAgICAgd2hpbGUgKGRhdGUuaXNCZWZvcmUoZW5kKSkgew0KICAgICAgICAgICAgaWYgKHZpZXcuaXNIaWRkZW5EYXkoZGF0ZSkpIHsNCiAgICAgICAgICAgICAgICBkYXlJbmRpY2VzLnB1c2goZGF5SW5kZXggKyAwLjUpOyAvLyBtYXJrIHRoYXQgaXQncyBiZXR3ZWVuIGluZGljZXMNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIGRheUluZGV4Kys7DQogICAgICAgICAgICAgICAgZGF5SW5kaWNlcy5wdXNoKGRheUluZGV4KTsNCiAgICAgICAgICAgICAgICBkYXlEYXRlcy5wdXNoKGRhdGUuY2xvbmUoKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBkYXRlLmFkZCgxLCAnZGF5cycpOw0KICAgICAgICB9DQogICAgICAgIGlmICh0aGlzLmJyZWFrT25XZWVrcykgew0KICAgICAgICAgICAgLy8gY291bnQgY29sdW1ucyB1bnRpbCB0aGUgZGF5LW9mLXdlZWsgcmVwZWF0cw0KICAgICAgICAgICAgZmlyc3REYXkgPSBkYXlEYXRlc1swXS5kYXkoKTsNCiAgICAgICAgICAgIGZvciAoZGF5c1BlclJvdyA9IDE7IGRheXNQZXJSb3cgPCBkYXlEYXRlcy5sZW5ndGg7IGRheXNQZXJSb3crKykgew0KICAgICAgICAgICAgICAgIGlmIChkYXlEYXRlc1tkYXlzUGVyUm93XS5kYXkoKSA9PT0gZmlyc3REYXkpIHsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcm93Q250ID0gTWF0aC5jZWlsKGRheURhdGVzLmxlbmd0aCAvIGRheXNQZXJSb3cpOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgcm93Q250ID0gMTsNCiAgICAgICAgICAgIGRheXNQZXJSb3cgPSBkYXlEYXRlcy5sZW5ndGg7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5kYXlEYXRlcyA9IGRheURhdGVzOw0KICAgICAgICB0aGlzLmRheUluZGljZXMgPSBkYXlJbmRpY2VzOw0KICAgICAgICB0aGlzLmRheXNQZXJSb3cgPSBkYXlzUGVyUm93Ow0KICAgICAgICB0aGlzLnJvd0NudCA9IHJvd0NudDsNCiAgICAgICAgdGhpcy51cGRhdGVEYXlUYWJsZUNvbHMoKTsNCiAgICB9Ow0KICAgIC8vIENvbXB1dGVzIGFuZCBhc3NpZ25lZCB0aGUgY29sQ250IHByb3BlcnR5IGFuZCB1cGRhdGVzIGFueSBvcHRpb25zIHRoYXQgbWF5IGJlIGNvbXB1dGVkIGZyb20gaXQNCiAgICBEYXlUYWJsZU1peGluLnByb3RvdHlwZS51cGRhdGVEYXlUYWJsZUNvbHMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMuY29sQ250ID0gdGhpcy5jb21wdXRlQ29sQ250KCk7DQogICAgICAgIHRoaXMuY29sSGVhZEZvcm1hdCA9DQogICAgICAgICAgICB0aGlzLm9wdCgnY29sdW1uSGVhZGVyRm9ybWF0JykgfHwNCiAgICAgICAgICAgICAgICB0aGlzLm9wdCgnY29sdW1uRm9ybWF0JykgfHwgLy8gZGVwcmVjYXRlZA0KICAgICAgICAgICAgICAgIHRoaXMuY29tcHV0ZUNvbEhlYWRGb3JtYXQoKTsNCiAgICB9Ow0KICAgIC8vIERldGVybWluZXMgaG93IG1hbnkgY29sdW1ucyB0aGVyZSBzaG91bGQgYmUgaW4gdGhlIHRhYmxlDQogICAgRGF5VGFibGVNaXhpbi5wcm90b3R5cGUuY29tcHV0ZUNvbENudCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZGF5c1BlclJvdzsNCiAgICB9Ow0KICAgIC8vIENvbXB1dGVzIHRoZSBhbWJpZ3VvdXNseS10aW1lZCBtb21lbnQgZm9yIHRoZSBnaXZlbiBjZWxsDQogICAgRGF5VGFibGVNaXhpbi5wcm90b3R5cGUuZ2V0Q2VsbERhdGUgPSBmdW5jdGlvbiAocm93LCBjb2wpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZGF5RGF0ZXNbdGhpcy5nZXRDZWxsRGF5SW5kZXgocm93LCBjb2wpXS5jbG9uZSgpOw0KICAgIH07DQogICAgLy8gQ29tcHV0ZXMgdGhlIGFtYmlndW91c2x5LXRpbWVkIGRhdGUgcmFuZ2UgZm9yIHRoZSBnaXZlbiBjZWxsDQogICAgRGF5VGFibGVNaXhpbi5wcm90b3R5cGUuZ2V0Q2VsbFJhbmdlID0gZnVuY3Rpb24gKHJvdywgY29sKSB7DQogICAgICAgIHZhciBzdGFydCA9IHRoaXMuZ2V0Q2VsbERhdGUocm93LCBjb2wpOw0KICAgICAgICB2YXIgZW5kID0gc3RhcnQuY2xvbmUoKS5hZGQoMSwgJ2RheXMnKTsNCiAgICAgICAgcmV0dXJuIHsgc3RhcnQ6IHN0YXJ0LCBlbmQ6IGVuZCB9Ow0KICAgIH07DQogICAgLy8gUmV0dXJucyB0aGUgbnVtYmVyIG9mIGRheSBjZWxscywgY2hyb25vbG9naWNhbGx5LCBmcm9tIHRoZSBmaXJzdCBvZiB0aGUgZ3JpZCAoMC1iYXNlZCkNCiAgICBEYXlUYWJsZU1peGluLnByb3RvdHlwZS5nZXRDZWxsRGF5SW5kZXggPSBmdW5jdGlvbiAocm93LCBjb2wpIHsNCiAgICAgICAgcmV0dXJuIHJvdyAqIHRoaXMuZGF5c1BlclJvdyArIHRoaXMuZ2V0Q29sRGF5SW5kZXgoY29sKTsNCiAgICB9Ow0KICAgIC8vIFJldHVybnMgdGhlIG51bW5lciBvZiBkYXkgY2VsbHMsIGNocm9ub2xvZ2ljYWxseSwgZnJvbSB0aGUgZmlyc3QgY2VsbCBpbiAqYW55IGdpdmVuIHJvdyoNCiAgICBEYXlUYWJsZU1peGluLnByb3RvdHlwZS5nZXRDb2xEYXlJbmRleCA9IGZ1bmN0aW9uIChjb2wpIHsNCiAgICAgICAgaWYgKHRoaXMuaXNSVEwpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbENudCAtIDEgLSBjb2w7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICByZXR1cm4gY29sOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBHaXZlbiBhIGRhdGUsIHJldHVybnMgaXRzIGNocm9ub2xvY2lhbCBjZWxsLWluZGV4IGZyb20gdGhlIGZpcnN0IGNlbGwgb2YgdGhlIGdyaWQuDQogICAgLy8gSWYgdGhlIGRhdGUgbGllcyBiZXR3ZWVuIGNlbGxzIChiZWNhdXNlIG9mIGhpZGRlbkRheXMpLCByZXR1cm5zIGEgZmxvYXRpbmctcG9pbnQgdmFsdWUgYmV0d2VlbiBvZmZzZXRzLg0KICAgIC8vIElmIGJlZm9yZSB0aGUgZmlyc3Qgb2Zmc2V0LCByZXR1cm5zIGEgbmVnYXRpdmUgbnVtYmVyLg0KICAgIC8vIElmIGFmdGVyIHRoZSBsYXN0IG9mZnNldCwgcmV0dXJucyBhbiBvZmZzZXQgcGFzdCB0aGUgbGFzdCBjZWxsIG9mZnNldC4NCiAgICAvLyBPbmx5IHdvcmtzIGZvciAqc3RhcnQqIGRhdGVzIG9mIGNlbGxzLiBXaWxsIG5vdCB3b3JrIGZvciBleGNsdXNpdmUgZW5kIGRhdGVzIGZvciBjZWxscy4NCiAgICBEYXlUYWJsZU1peGluLnByb3RvdHlwZS5nZXREYXRlRGF5SW5kZXggPSBmdW5jdGlvbiAoZGF0ZSkgew0KICAgICAgICB2YXIgZGF5SW5kaWNlcyA9IHRoaXMuZGF5SW5kaWNlczsNCiAgICAgICAgdmFyIGRheU9mZnNldCA9IGRhdGUuZGlmZih0aGlzLmRheURhdGVzWzBdLCAnZGF5cycpOw0KICAgICAgICBpZiAoZGF5T2Zmc2V0IDwgMCkgew0KICAgICAgICAgICAgcmV0dXJuIGRheUluZGljZXNbMF0gLSAxOw0KICAgICAgICB9DQogICAgICAgIGVsc2UgaWYgKGRheU9mZnNldCA+PSBkYXlJbmRpY2VzLmxlbmd0aCkgew0KICAgICAgICAgICAgcmV0dXJuIGRheUluZGljZXNbZGF5SW5kaWNlcy5sZW5ndGggLSAxXSArIDE7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICByZXR1cm4gZGF5SW5kaWNlc1tkYXlPZmZzZXRdOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvKiBPcHRpb25zDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICAvLyBDb21wdXRlcyBhIGRlZmF1bHQgY29sdW1uIGhlYWRlciBmb3JtYXR0aW5nIHN0cmluZyBpZiBgY29sRm9ybWF0YCBpcyBub3QgZXhwbGljaXRseSBkZWZpbmVkDQogICAgRGF5VGFibGVNaXhpbi5wcm90b3R5cGUuY29tcHV0ZUNvbEhlYWRGb3JtYXQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIC8vIGlmIG1vcmUgdGhhbiBvbmUgd2VlayByb3csIG9yIGlmIHRoZXJlIGFyZSBhIGxvdCBvZiBjb2x1bW5zIHdpdGggbm90IG11Y2ggc3BhY2UsDQogICAgICAgIC8vIHB1dCBqdXN0IHRoZSBkYXkgbnVtYmVycyB3aWxsIGJlIGluIGVhY2ggY2VsbA0KICAgICAgICBpZiAodGhpcy5yb3dDbnQgPiAxIHx8IHRoaXMuY29sQ250ID4gMTApIHsNCiAgICAgICAgICAgIHJldHVybiAnZGRkJzsgLy8gIlNhdCINCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICh0aGlzLmNvbENudCA+IDEpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLm9wdCgnZGF5T2ZNb250aEZvcm1hdCcpOyAvLyAiU2F0IDEyLzEwIg0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuICdkZGRkJzsgLy8gIlNhdHVyZGF5Ig0KICAgICAgICB9DQogICAgfTsNCiAgICAvKiBTbGljaW5nDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICAvLyBTbGljZXMgdXAgYSBkYXRlIHJhbmdlIGludG8gYSBzZWdtZW50IGZvciBldmVyeSB3ZWVrLXJvdyBpdCBpbnRlcnNlY3RzIHdpdGgNCiAgICBEYXlUYWJsZU1peGluLnByb3RvdHlwZS5zbGljZVJhbmdlQnlSb3cgPSBmdW5jdGlvbiAodW56b25lZFJhbmdlKSB7DQogICAgICAgIHZhciBkYXlzUGVyUm93ID0gdGhpcy5kYXlzUGVyUm93Ow0KICAgICAgICB2YXIgbm9ybWFsUmFuZ2UgPSB0aGlzLnZpZXcuY29tcHV0ZURheVJhbmdlKHVuem9uZWRSYW5nZSk7IC8vIG1ha2Ugd2hvbGUtZGF5IHJhbmdlLCBjb25zaWRlcmluZyBuZXh0RGF5VGhyZXNob2xkDQogICAgICAgIHZhciByYW5nZUZpcnN0ID0gdGhpcy5nZXREYXRlRGF5SW5kZXgobm9ybWFsUmFuZ2Uuc3RhcnQpOyAvLyBpbmNsdXNpdmUgZmlyc3QgaW5kZXgNCiAgICAgICAgdmFyIHJhbmdlTGFzdCA9IHRoaXMuZ2V0RGF0ZURheUluZGV4KG5vcm1hbFJhbmdlLmVuZC5jbG9uZSgpLnN1YnRyYWN0KDEsICdkYXlzJykpOyAvLyBpbmNsdXNpdmUgbGFzdCBpbmRleA0KICAgICAgICB2YXIgc2VncyA9IFtdOw0KICAgICAgICB2YXIgcm93Ow0KICAgICAgICB2YXIgcm93Rmlyc3Q7DQogICAgICAgIHZhciByb3dMYXN0OyAvLyBpbmNsdXNpdmUgZGF5LWluZGV4IHJhbmdlIGZvciBjdXJyZW50IHJvdw0KICAgICAgICB2YXIgc2VnRmlyc3Q7DQogICAgICAgIHZhciBzZWdMYXN0OyAvLyBpbmNsdXNpdmUgZGF5LWluZGV4IHJhbmdlIGZvciBzZWdtZW50DQogICAgICAgIGZvciAocm93ID0gMDsgcm93IDwgdGhpcy5yb3dDbnQ7IHJvdysrKSB7DQogICAgICAgICAgICByb3dGaXJzdCA9IHJvdyAqIGRheXNQZXJSb3c7DQogICAgICAgICAgICByb3dMYXN0ID0gcm93Rmlyc3QgKyBkYXlzUGVyUm93IC0gMTsNCiAgICAgICAgICAgIC8vIGludGVyc2VjdCBzZWdtZW50J3Mgb2Zmc2V0IHJhbmdlIHdpdGggdGhlIHJvdydzDQogICAgICAgICAgICBzZWdGaXJzdCA9IE1hdGgubWF4KHJhbmdlRmlyc3QsIHJvd0ZpcnN0KTsNCiAgICAgICAgICAgIHNlZ0xhc3QgPSBNYXRoLm1pbihyYW5nZUxhc3QsIHJvd0xhc3QpOw0KICAgICAgICAgICAgLy8gZGVhbCB3aXRoIGluLWJldHdlZW4gaW5kaWNlcw0KICAgICAgICAgICAgc2VnRmlyc3QgPSBNYXRoLmNlaWwoc2VnRmlyc3QpOyAvLyBpbi1iZXR3ZWVuIHN0YXJ0cyByb3VuZCB0byBuZXh0IGNlbGwNCiAgICAgICAgICAgIHNlZ0xhc3QgPSBNYXRoLmZsb29yKHNlZ0xhc3QpOyAvLyBpbi1iZXR3ZWVuIGVuZHMgcm91bmQgdG8gcHJldiBjZWxsDQogICAgICAgICAgICBpZiAoc2VnRmlyc3QgPD0gc2VnTGFzdCkgew0KICAgICAgICAgICAgICAgIHNlZ3MucHVzaCh7DQogICAgICAgICAgICAgICAgICAgIHJvdzogcm93LA0KICAgICAgICAgICAgICAgICAgICAvLyBub3JtYWxpemUgdG8gc3RhcnQgb2Ygcm93DQogICAgICAgICAgICAgICAgICAgIGZpcnN0Um93RGF5SW5kZXg6IHNlZ0ZpcnN0IC0gcm93Rmlyc3QsDQogICAgICAgICAgICAgICAgICAgIGxhc3RSb3dEYXlJbmRleDogc2VnTGFzdCAtIHJvd0ZpcnN0LA0KICAgICAgICAgICAgICAgICAgICAvLyBtdXN0IGJlIG1hdGNoaW5nIGludGVnZXJzIHRvIGJlIHRoZSBzZWdtZW50J3Mgc3RhcnQvZW5kDQogICAgICAgICAgICAgICAgICAgIGlzU3RhcnQ6IHNlZ0ZpcnN0ID09PSByYW5nZUZpcnN0LA0KICAgICAgICAgICAgICAgICAgICBpc0VuZDogc2VnTGFzdCA9PT0gcmFuZ2VMYXN0DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHNlZ3M7DQogICAgfTsNCiAgICAvLyBTbGljZXMgdXAgYSBkYXRlIHJhbmdlIGludG8gYSBzZWdtZW50IGZvciBldmVyeSBkYXktY2VsbCBpdCBpbnRlcnNlY3RzIHdpdGguDQogICAgLy8gVE9ETzogbWFrZSBtb3JlIERSWSB3aXRoIHNsaWNlUmFuZ2VCeVJvdyBzb21laG93Lg0KICAgIERheVRhYmxlTWl4aW4ucHJvdG90eXBlLnNsaWNlUmFuZ2VCeURheSA9IGZ1bmN0aW9uICh1bnpvbmVkUmFuZ2UpIHsNCiAgICAgICAgdmFyIGRheXNQZXJSb3cgPSB0aGlzLmRheXNQZXJSb3c7DQogICAgICAgIHZhciBub3JtYWxSYW5nZSA9IHRoaXMudmlldy5jb21wdXRlRGF5UmFuZ2UodW56b25lZFJhbmdlKTsgLy8gbWFrZSB3aG9sZS1kYXkgcmFuZ2UsIGNvbnNpZGVyaW5nIG5leHREYXlUaHJlc2hvbGQNCiAgICAgICAgdmFyIHJhbmdlRmlyc3QgPSB0aGlzLmdldERhdGVEYXlJbmRleChub3JtYWxSYW5nZS5zdGFydCk7IC8vIGluY2x1c2l2ZSBmaXJzdCBpbmRleA0KICAgICAgICB2YXIgcmFuZ2VMYXN0ID0gdGhpcy5nZXREYXRlRGF5SW5kZXgobm9ybWFsUmFuZ2UuZW5kLmNsb25lKCkuc3VidHJhY3QoMSwgJ2RheXMnKSk7IC8vIGluY2x1c2l2ZSBsYXN0IGluZGV4DQogICAgICAgIHZhciBzZWdzID0gW107DQogICAgICAgIHZhciByb3c7DQogICAgICAgIHZhciByb3dGaXJzdDsNCiAgICAgICAgdmFyIHJvd0xhc3Q7IC8vIGluY2x1c2l2ZSBkYXktaW5kZXggcmFuZ2UgZm9yIGN1cnJlbnQgcm93DQogICAgICAgIHZhciBpOw0KICAgICAgICB2YXIgc2VnRmlyc3Q7DQogICAgICAgIHZhciBzZWdMYXN0OyAvLyBpbmNsdXNpdmUgZGF5LWluZGV4IHJhbmdlIGZvciBzZWdtZW50DQogICAgICAgIGZvciAocm93ID0gMDsgcm93IDwgdGhpcy5yb3dDbnQ7IHJvdysrKSB7DQogICAgICAgICAgICByb3dGaXJzdCA9IHJvdyAqIGRheXNQZXJSb3c7DQogICAgICAgICAgICByb3dMYXN0ID0gcm93Rmlyc3QgKyBkYXlzUGVyUm93IC0gMTsNCiAgICAgICAgICAgIGZvciAoaSA9IHJvd0ZpcnN0OyBpIDw9IHJvd0xhc3Q7IGkrKykgew0KICAgICAgICAgICAgICAgIC8vIGludGVyc2VjdCBzZWdtZW50J3Mgb2Zmc2V0IHJhbmdlIHdpdGggdGhlIHJvdydzDQogICAgICAgICAgICAgICAgc2VnRmlyc3QgPSBNYXRoLm1heChyYW5nZUZpcnN0LCBpKTsNCiAgICAgICAgICAgICAgICBzZWdMYXN0ID0gTWF0aC5taW4ocmFuZ2VMYXN0LCBpKTsNCiAgICAgICAgICAgICAgICAvLyBkZWFsIHdpdGggaW4tYmV0d2VlbiBpbmRpY2VzDQogICAgICAgICAgICAgICAgc2VnRmlyc3QgPSBNYXRoLmNlaWwoc2VnRmlyc3QpOyAvLyBpbi1iZXR3ZWVuIHN0YXJ0cyByb3VuZCB0byBuZXh0IGNlbGwNCiAgICAgICAgICAgICAgICBzZWdMYXN0ID0gTWF0aC5mbG9vcihzZWdMYXN0KTsgLy8gaW4tYmV0d2VlbiBlbmRzIHJvdW5kIHRvIHByZXYgY2VsbA0KICAgICAgICAgICAgICAgIGlmIChzZWdGaXJzdCA8PSBzZWdMYXN0KSB7DQogICAgICAgICAgICAgICAgICAgIHNlZ3MucHVzaCh7DQogICAgICAgICAgICAgICAgICAgICAgICByb3c6IHJvdywNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vcm1hbGl6ZSB0byBzdGFydCBvZiByb3cNCiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0Um93RGF5SW5kZXg6IHNlZ0ZpcnN0IC0gcm93Rmlyc3QsDQogICAgICAgICAgICAgICAgICAgICAgICBsYXN0Um93RGF5SW5kZXg6IHNlZ0xhc3QgLSByb3dGaXJzdCwNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG11c3QgYmUgbWF0Y2hpbmcgaW50ZWdlcnMgdG8gYmUgdGhlIHNlZ21lbnQncyBzdGFydC9lbmQNCiAgICAgICAgICAgICAgICAgICAgICAgIGlzU3RhcnQ6IHNlZ0ZpcnN0ID09PSByYW5nZUZpcnN0LA0KICAgICAgICAgICAgICAgICAgICAgICAgaXNFbmQ6IHNlZ0xhc3QgPT09IHJhbmdlTGFzdA0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHNlZ3M7DQogICAgfTsNCiAgICAvKiBIZWFkZXIgUmVuZGVyaW5nDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICBEYXlUYWJsZU1peGluLnByb3RvdHlwZS5yZW5kZXJIZWFkSHRtbCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIHRoZW1lID0gdGhpcy52aWV3LmNhbGVuZGFyLnRoZW1lOw0KICAgICAgICByZXR1cm4gJycgKw0KICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImZjLXJvdyAnICsgdGhlbWUuZ2V0Q2xhc3MoJ2hlYWRlclJvdycpICsgJyI+JyArDQogICAgICAgICAgICAnPHRhYmxlIGNsYXNzPSInICsgdGhlbWUuZ2V0Q2xhc3MoJ3RhYmxlR3JpZCcpICsgJyI+JyArDQogICAgICAgICAgICAnPHRoZWFkPicgKw0KICAgICAgICAgICAgdGhpcy5yZW5kZXJIZWFkVHJIdG1sKCkgKw0KICAgICAgICAgICAgJzwvdGhlYWQ+JyArDQogICAgICAgICAgICAnPC90YWJsZT4nICsNCiAgICAgICAgICAgICc8L2Rpdj4nOw0KICAgIH07DQogICAgRGF5VGFibGVNaXhpbi5wcm90b3R5cGUucmVuZGVySGVhZEludHJvSHRtbCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMucmVuZGVySW50cm9IdG1sKCk7IC8vIGZhbGwgYmFjayB0byBnZW5lcmljDQogICAgfTsNCiAgICBEYXlUYWJsZU1peGluLnByb3RvdHlwZS5yZW5kZXJIZWFkVHJIdG1sID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gJycgKw0KICAgICAgICAgICAgJzx0cj4nICsNCiAgICAgICAgICAgICh0aGlzLmlzUlRMID8gJycgOiB0aGlzLnJlbmRlckhlYWRJbnRyb0h0bWwoKSkgKw0KICAgICAgICAgICAgdGhpcy5yZW5kZXJIZWFkRGF0ZUNlbGxzSHRtbCgpICsNCiAgICAgICAgICAgICh0aGlzLmlzUlRMID8gdGhpcy5yZW5kZXJIZWFkSW50cm9IdG1sKCkgOiAnJykgKw0KICAgICAgICAgICAgJzwvdHI+JzsNCiAgICB9Ow0KICAgIERheVRhYmxlTWl4aW4ucHJvdG90eXBlLnJlbmRlckhlYWREYXRlQ2VsbHNIdG1sID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgaHRtbHMgPSBbXTsNCiAgICAgICAgdmFyIGNvbDsNCiAgICAgICAgdmFyIGRhdGU7DQogICAgICAgIGZvciAoY29sID0gMDsgY29sIDwgdGhpcy5jb2xDbnQ7IGNvbCsrKSB7DQogICAgICAgICAgICBkYXRlID0gdGhpcy5nZXRDZWxsRGF0ZSgwLCBjb2wpOw0KICAgICAgICAgICAgaHRtbHMucHVzaCh0aGlzLnJlbmRlckhlYWREYXRlQ2VsbEh0bWwoZGF0ZSkpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBodG1scy5qb2luKCcnKTsNCiAgICB9Ow0KICAgIC8vIFRPRE86IHdoZW4gaW50ZXJuYWxBcGlWZXJzaW9uLCBhY2NlcHQgYW4gb2JqZWN0IGZvciBIVE1MIGF0dHJpYnV0ZXMNCiAgICAvLyAoY29sc3BhbiBzaG91bGQgYmUgbm8gZGlmZmVyZW50KQ0KICAgIERheVRhYmxlTWl4aW4ucHJvdG90eXBlLnJlbmRlckhlYWREYXRlQ2VsbEh0bWwgPSBmdW5jdGlvbiAoZGF0ZSwgY29sc3Bhbiwgb3RoZXJBdHRycykgew0KICAgICAgICB2YXIgdCA9IHRoaXM7DQogICAgICAgIHZhciB2aWV3ID0gdC52aWV3Ow0KICAgICAgICB2YXIgaXNEYXRlVmFsaWQgPSB0LmRhdGVQcm9maWxlLmFjdGl2ZVVuem9uZWRSYW5nZS5jb250YWluc0RhdGUoZGF0ZSk7IC8vIFRPRE86IGNhbGxlZCB0b28gZnJlcXVlbnRseS4gY2FjaGUgc29tZWhvdy4NCiAgICAgICAgdmFyIGNsYXNzTmFtZXMgPSBbDQogICAgICAgICAgICAnZmMtZGF5LWhlYWRlcicsDQogICAgICAgICAgICB2aWV3LmNhbGVuZGFyLnRoZW1lLmdldENsYXNzKCd3aWRnZXRIZWFkZXInKQ0KICAgICAgICBdOw0KICAgICAgICB2YXIgaW5uZXJIdG1sOw0KICAgICAgICBpZiAodHlwZW9mIHQub3B0KCdjb2x1bW5IZWFkZXJIdG1sJykgPT09ICdmdW5jdGlvbicpIHsNCiAgICAgICAgICAgIGlubmVySHRtbCA9IHQub3B0KCdjb2x1bW5IZWFkZXJIdG1sJykoZGF0ZSk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAodHlwZW9mIHQub3B0KCdjb2x1bW5IZWFkZXJUZXh0JykgPT09ICdmdW5jdGlvbicpIHsNCiAgICAgICAgICAgIGlubmVySHRtbCA9IHV0aWxfMS5odG1sRXNjYXBlKHQub3B0KCdjb2x1bW5IZWFkZXJUZXh0JykoZGF0ZSkpOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgaW5uZXJIdG1sID0gdXRpbF8xLmh0bWxFc2NhcGUoZGF0ZS5mb3JtYXQodC5jb2xIZWFkRm9ybWF0KSk7DQogICAgICAgIH0NCiAgICAgICAgLy8gaWYgb25seSBvbmUgcm93IG9mIGRheXMsIHRoZSBjbGFzc05hbWVzIG9uIHRoZSBoZWFkZXIgY2FuIHJlcHJlc2VudCB0aGUgc3BlY2lmaWMgZGF5cyBiZW5lYXRoDQogICAgICAgIGlmICh0LnJvd0NudCA9PT0gMSkgew0KICAgICAgICAgICAgY2xhc3NOYW1lcyA9IGNsYXNzTmFtZXMuY29uY2F0KA0KICAgICAgICAgICAgLy8gaW5jbHVkZXMgdGhlIGRheS1vZi13ZWVrIGNsYXNzDQogICAgICAgICAgICAvLyBub1RoZW1lSGlnaGxpZ2h0PXRydWUgKGRvbid0IGhpZ2hsaWdodCB0aGUgaGVhZGVyKQ0KICAgICAgICAgICAgdC5nZXREYXlDbGFzc2VzKGRhdGUsIHRydWUpKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIGNsYXNzTmFtZXMucHVzaCgnZmMtJyArIHV0aWxfMS5kYXlJRHNbZGF0ZS5kYXkoKV0pOyAvLyBvbmx5IGFkZCB0aGUgZGF5LW9mLXdlZWsgY2xhc3MNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gJycgKw0KICAgICAgICAgICAgJzx0aCBjbGFzcz0iJyArIGNsYXNzTmFtZXMuam9pbignICcpICsgJyInICsNCiAgICAgICAgICAgICgoaXNEYXRlVmFsaWQgJiYgdC5yb3dDbnQpID09PSAxID8NCiAgICAgICAgICAgICAgICAnIGRhdGEtZGF0ZT0iJyArIGRhdGUuZm9ybWF0KCdZWVlZLU1NLUREJykgKyAnIicgOg0KICAgICAgICAgICAgICAgICcnKSArDQogICAgICAgICAgICAoY29sc3BhbiA+IDEgPw0KICAgICAgICAgICAgICAgICcgY29sc3Bhbj0iJyArIGNvbHNwYW4gKyAnIicgOg0KICAgICAgICAgICAgICAgICcnKSArDQogICAgICAgICAgICAob3RoZXJBdHRycyA/DQogICAgICAgICAgICAgICAgJyAnICsgb3RoZXJBdHRycyA6DQogICAgICAgICAgICAgICAgJycpICsNCiAgICAgICAgICAgICc+JyArDQogICAgICAgICAgICAoaXNEYXRlVmFsaWQgPw0KICAgICAgICAgICAgICAgIC8vIGRvbid0IG1ha2UgYSBsaW5rIGlmIHRoZSBoZWFkaW5nIGNvdWxkIHJlcHJlc2VudCBtdWx0aXBsZSBkYXlzLCBvciBpZiB0aGVyZSdzIG9ubHkgb25lIGRheSAoZm9yY2VPZmYpDQogICAgICAgICAgICAgICAgdmlldy5idWlsZEdvdG9BbmNob3JIdG1sKHsgZGF0ZTogZGF0ZSwgZm9yY2VPZmY6IHQucm93Q250ID4gMSB8fCB0LmNvbENudCA9PT0gMSB9LCBpbm5lckh0bWwpIDoNCiAgICAgICAgICAgICAgICAvLyBpZiBub3QgdmFsaWQsIGRpc3BsYXkgdGV4dCwgYnV0IG5vIGxpbmsNCiAgICAgICAgICAgICAgICBpbm5lckh0bWwpICsNCiAgICAgICAgICAgICc8L3RoPic7DQogICAgfTsNCiAgICAvKiBCYWNrZ3JvdW5kIFJlbmRlcmluZw0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgRGF5VGFibGVNaXhpbi5wcm90b3R5cGUucmVuZGVyQmdUckh0bWwgPSBmdW5jdGlvbiAocm93KSB7DQogICAgICAgIHJldHVybiAnJyArDQogICAgICAgICAgICAnPHRyPicgKw0KICAgICAgICAgICAgKHRoaXMuaXNSVEwgPyAnJyA6IHRoaXMucmVuZGVyQmdJbnRyb0h0bWwocm93KSkgKw0KICAgICAgICAgICAgdGhpcy5yZW5kZXJCZ0NlbGxzSHRtbChyb3cpICsNCiAgICAgICAgICAgICh0aGlzLmlzUlRMID8gdGhpcy5yZW5kZXJCZ0ludHJvSHRtbChyb3cpIDogJycpICsNCiAgICAgICAgICAgICc8L3RyPic7DQogICAgfTsNCiAgICBEYXlUYWJsZU1peGluLnByb3RvdHlwZS5yZW5kZXJCZ0ludHJvSHRtbCA9IGZ1bmN0aW9uIChyb3cpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMucmVuZGVySW50cm9IdG1sKCk7IC8vIGZhbGwgYmFjayB0byBnZW5lcmljDQogICAgfTsNCiAgICBEYXlUYWJsZU1peGluLnByb3RvdHlwZS5yZW5kZXJCZ0NlbGxzSHRtbCA9IGZ1bmN0aW9uIChyb3cpIHsNCiAgICAgICAgdmFyIGh0bWxzID0gW107DQogICAgICAgIHZhciBjb2w7DQogICAgICAgIHZhciBkYXRlOw0KICAgICAgICBmb3IgKGNvbCA9IDA7IGNvbCA8IHRoaXMuY29sQ250OyBjb2wrKykgew0KICAgICAgICAgICAgZGF0ZSA9IHRoaXMuZ2V0Q2VsbERhdGUocm93LCBjb2wpOw0KICAgICAgICAgICAgaHRtbHMucHVzaCh0aGlzLnJlbmRlckJnQ2VsbEh0bWwoZGF0ZSkpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBodG1scy5qb2luKCcnKTsNCiAgICB9Ow0KICAgIERheVRhYmxlTWl4aW4ucHJvdG90eXBlLnJlbmRlckJnQ2VsbEh0bWwgPSBmdW5jdGlvbiAoZGF0ZSwgb3RoZXJBdHRycykgew0KICAgICAgICB2YXIgdCA9IHRoaXM7DQogICAgICAgIHZhciB2aWV3ID0gdC52aWV3Ow0KICAgICAgICB2YXIgaXNEYXRlVmFsaWQgPSB0LmRhdGVQcm9maWxlLmFjdGl2ZVVuem9uZWRSYW5nZS5jb250YWluc0RhdGUoZGF0ZSk7IC8vIFRPRE86IGNhbGxlZCB0b28gZnJlcXVlbnRseS4gY2FjaGUgc29tZWhvdy4NCiAgICAgICAgdmFyIGNsYXNzZXMgPSB0LmdldERheUNsYXNzZXMoZGF0ZSk7DQogICAgICAgIGNsYXNzZXMudW5zaGlmdCgnZmMtZGF5Jywgdmlldy5jYWxlbmRhci50aGVtZS5nZXRDbGFzcygnd2lkZ2V0Q29udGVudCcpKTsNCiAgICAgICAgcmV0dXJuICc8dGQgY2xhc3M9IicgKyBjbGFzc2VzLmpvaW4oJyAnKSArICciJyArDQogICAgICAgICAgICAoaXNEYXRlVmFsaWQgPw0KICAgICAgICAgICAgICAgICcgZGF0YS1kYXRlPSInICsgZGF0ZS5mb3JtYXQoJ1lZWVktTU0tREQnKSArICciJyA6IC8vIGlmIGRhdGUgaGFzIGEgdGltZSwgd29uJ3QgZm9ybWF0IGl0DQogICAgICAgICAgICAgICAgJycpICsNCiAgICAgICAgICAgIChvdGhlckF0dHJzID8NCiAgICAgICAgICAgICAgICAnICcgKyBvdGhlckF0dHJzIDoNCiAgICAgICAgICAgICAgICAnJykgKw0KICAgICAgICAgICAgJz48L3RkPic7DQogICAgfTsNCiAgICAvKiBHZW5lcmljDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICBEYXlUYWJsZU1peGluLnByb3RvdHlwZS5yZW5kZXJJbnRyb0h0bWwgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIC8vIEdlbmVyYXRlcyB0aGUgZGVmYXVsdCBIVE1MIGludHJvIGZvciBhbnkgcm93LiBVc2VyIGNsYXNzZXMgc2hvdWxkIG92ZXJyaWRlDQogICAgfTsNCiAgICAvLyBUT0RPOiBhIGdlbmVyaWMgbWV0aG9kIGZvciBkZWFsaW5nIHdpdGggPHRyPiwgUlRMLCBpbnRybw0KICAgIC8vIHdoZW4gaW5jcmVtZW50IGludGVybmFsQXBpVmVyc2lvbg0KICAgIC8vIHdyYXBUciAoc2NoZWR1bGVyKQ0KICAgIC8qIFV0aWxzDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICAvLyBBcHBsaWVzIHRoZSBnZW5lcmljICJpbnRybyIgYW5kICJvdXRybyIgSFRNTCB0byB0aGUgZ2l2ZW4gY2VsbHMuDQogICAgLy8gSW50cm8gbWVhbnMgdGhlIGxlZnRtb3N0IGNlbGwgd2hlbiB0aGUgY2FsZW5kYXIgaXMgTFRSIGFuZCB0aGUgcmlnaHRtb3N0IGNlbGwgd2hlbiBSVEwuIFZpY2UtdmVyc2EgZm9yIG91dHJvLg0KICAgIERheVRhYmxlTWl4aW4ucHJvdG90eXBlLmJvb2tlbmRDZWxscyA9IGZ1bmN0aW9uICh0ckVsKSB7DQogICAgICAgIHZhciBpbnRyb0h0bWwgPSB0aGlzLnJlbmRlckludHJvSHRtbCgpOw0KICAgICAgICBpZiAoaW50cm9IdG1sKSB7DQogICAgICAgICAgICBpZiAodGhpcy5pc1JUTCkgew0KICAgICAgICAgICAgICAgIHRyRWwuYXBwZW5kKGludHJvSHRtbCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICB0ckVsLnByZXBlbmQoaW50cm9IdG1sKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH07DQogICAgcmV0dXJuIERheVRhYmxlTWl4aW47DQp9KE1peGluXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gRGF5VGFibGVNaXhpbjsNCgoKLyoqKi8gfSksCi8qIDU2ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMpIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgQnVzaW5lc3NIb3VyUmVuZGVyZXIgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7DQogICAgLyoNCiAgICBjb21wb25lbnQgaW1wbGVtZW50czoNCiAgICAgIC0gZXZlbnRSYW5nZXNUb0V2ZW50Rm9vdHByaW50cw0KICAgICAgLSBldmVudEZvb3RwcmludHNUb1NlZ3MNCiAgICAqLw0KICAgIGZ1bmN0aW9uIEJ1c2luZXNzSG91clJlbmRlcmVyKGNvbXBvbmVudCwgZmlsbFJlbmRlcmVyKSB7DQogICAgICAgIHRoaXMuY29tcG9uZW50ID0gY29tcG9uZW50Ow0KICAgICAgICB0aGlzLmZpbGxSZW5kZXJlciA9IGZpbGxSZW5kZXJlcjsNCiAgICB9DQogICAgQnVzaW5lc3NIb3VyUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uIChidXNpbmVzc0hvdXJHZW5lcmF0b3IpIHsNCiAgICAgICAgdmFyIGNvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50Ow0KICAgICAgICB2YXIgdW56b25lZFJhbmdlID0gY29tcG9uZW50Ll9nZXREYXRlUHJvZmlsZSgpLmFjdGl2ZVVuem9uZWRSYW5nZTsNCiAgICAgICAgdmFyIGV2ZW50SW5zdGFuY2VHcm91cCA9IGJ1c2luZXNzSG91ckdlbmVyYXRvci5idWlsZEV2ZW50SW5zdGFuY2VHcm91cChjb21wb25lbnQuaGFzQWxsRGF5QnVzaW5lc3NIb3VycywgdW56b25lZFJhbmdlKTsNCiAgICAgICAgdmFyIGV2ZW50Rm9vdHByaW50cyA9IGV2ZW50SW5zdGFuY2VHcm91cCA/DQogICAgICAgICAgICBjb21wb25lbnQuZXZlbnRSYW5nZXNUb0V2ZW50Rm9vdHByaW50cyhldmVudEluc3RhbmNlR3JvdXAuc2xpY2VSZW5kZXJSYW5nZXModW56b25lZFJhbmdlKSkgOg0KICAgICAgICAgICAgW107DQogICAgICAgIHRoaXMucmVuZGVyRXZlbnRGb290cHJpbnRzKGV2ZW50Rm9vdHByaW50cyk7DQogICAgfTsNCiAgICBCdXNpbmVzc0hvdXJSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyRXZlbnRGb290cHJpbnRzID0gZnVuY3Rpb24gKGV2ZW50Rm9vdHByaW50cykgew0KICAgICAgICB2YXIgc2VncyA9IHRoaXMuY29tcG9uZW50LmV2ZW50Rm9vdHByaW50c1RvU2VncyhldmVudEZvb3RwcmludHMpOw0KICAgICAgICB0aGlzLnJlbmRlclNlZ3Moc2Vncyk7DQogICAgICAgIHRoaXMuc2VncyA9IHNlZ3M7DQogICAgfTsNCiAgICBCdXNpbmVzc0hvdXJSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyU2VncyA9IGZ1bmN0aW9uIChzZWdzKSB7DQogICAgICAgIGlmICh0aGlzLmZpbGxSZW5kZXJlcikgew0KICAgICAgICAgICAgdGhpcy5maWxsUmVuZGVyZXIucmVuZGVyU2VncygnYnVzaW5lc3NIb3VycycsIHNlZ3MsIHsNCiAgICAgICAgICAgICAgICBnZXRDbGFzc2VzOiBmdW5jdGlvbiAoc2VnKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBbJ2ZjLW5vbmJ1c2luZXNzJywgJ2ZjLWJnZXZlbnQnXTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgQnVzaW5lc3NIb3VyUmVuZGVyZXIucHJvdG90eXBlLnVucmVuZGVyID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5maWxsUmVuZGVyZXIpIHsNCiAgICAgICAgICAgIHRoaXMuZmlsbFJlbmRlcmVyLnVucmVuZGVyKCdidXNpbmVzc0hvdXJzJyk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5zZWdzID0gbnVsbDsNCiAgICB9Ow0KICAgIEJ1c2luZXNzSG91clJlbmRlcmVyLnByb3RvdHlwZS5nZXRTZWdzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gdGhpcy5zZWdzIHx8IFtdOw0KICAgIH07DQogICAgcmV0dXJuIEJ1c2luZXNzSG91clJlbmRlcmVyOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IEJ1c2luZXNzSG91clJlbmRlcmVyOw0KCgovKioqLyB9KSwKLyogNTcgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCnZhciB1dGlsXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQpOw0KdmFyIEZpbGxSZW5kZXJlciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsNCiAgICBmdW5jdGlvbiBGaWxsUmVuZGVyZXIoY29tcG9uZW50KSB7DQogICAgICAgIHRoaXMuZmlsbFNlZ1RhZyA9ICdkaXYnOw0KICAgICAgICB0aGlzLmNvbXBvbmVudCA9IGNvbXBvbmVudDsNCiAgICAgICAgdGhpcy5lbHNCeUZpbGwgPSB7fTsNCiAgICB9DQogICAgRmlsbFJlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJGb290cHJpbnQgPSBmdW5jdGlvbiAodHlwZSwgY29tcG9uZW50Rm9vdHByaW50LCBwcm9wcykgew0KICAgICAgICB0aGlzLnJlbmRlclNlZ3ModHlwZSwgdGhpcy5jb21wb25lbnQuY29tcG9uZW50Rm9vdHByaW50VG9TZWdzKGNvbXBvbmVudEZvb3RwcmludCksIHByb3BzKTsNCiAgICB9Ow0KICAgIEZpbGxSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyU2VncyA9IGZ1bmN0aW9uICh0eXBlLCBzZWdzLCBwcm9wcykgew0KICAgICAgICB2YXIgZWxzOw0KICAgICAgICBzZWdzID0gdGhpcy5idWlsZFNlZ0Vscyh0eXBlLCBzZWdzLCBwcm9wcyk7IC8vIGFzc2lnbmVzIGAuZWxgIHRvIGVhY2ggc2VnLiByZXR1cm5zIHN1Y2Nlc3NmdWxseSByZW5kZXJlZCBzZWdzDQogICAgICAgIGVscyA9IHRoaXMuYXR0YWNoU2VnRWxzKHR5cGUsIHNlZ3MpOw0KICAgICAgICBpZiAoZWxzKSB7DQogICAgICAgICAgICB0aGlzLnJlcG9ydEVscyh0eXBlLCBlbHMpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBzZWdzOw0KICAgIH07DQogICAgLy8gVW5yZW5kZXJzIGEgc3BlY2lmaWMgdHlwZSBvZiBmaWxsIHRoYXQgaXMgY3VycmVudGx5IHJlbmRlcmVkIG9uIHRoZSBncmlkDQogICAgRmlsbFJlbmRlcmVyLnByb3RvdHlwZS51bnJlbmRlciA9IGZ1bmN0aW9uICh0eXBlKSB7DQogICAgICAgIHZhciBlbCA9IHRoaXMuZWxzQnlGaWxsW3R5cGVdOw0KICAgICAgICBpZiAoZWwpIHsNCiAgICAgICAgICAgIGVsLnJlbW92ZSgpOw0KICAgICAgICAgICAgZGVsZXRlIHRoaXMuZWxzQnlGaWxsW3R5cGVdOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBSZW5kZXJzIGFuZCBhc3NpZ25zIGFuIGBlbGAgcHJvcGVydHkgZm9yIGVhY2ggZmlsbCBzZWdtZW50LiBHZW5lcmljIGVub3VnaCB0byB3b3JrIHdpdGggZGlmZmVyZW50IHR5cGVzLg0KICAgIC8vIE9ubHkgcmV0dXJucyBzZWdtZW50cyB0aGF0IHN1Y2Nlc3NmdWxseSByZW5kZXJlZC4NCiAgICBGaWxsUmVuZGVyZXIucHJvdG90eXBlLmJ1aWxkU2VnRWxzID0gZnVuY3Rpb24gKHR5cGUsIHNlZ3MsIHByb3BzKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIHZhciBodG1sID0gJyc7DQogICAgICAgIHZhciByZW5kZXJlZFNlZ3MgPSBbXTsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIGlmIChzZWdzLmxlbmd0aCkgew0KICAgICAgICAgICAgLy8gYnVpbGQgYSBsYXJnZSBjb25jYXRlbmF0aW9uIG9mIHNlZ21lbnQgSFRNTA0KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlZ3MubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICBodG1sICs9IHRoaXMuYnVpbGRTZWdIdG1sKHR5cGUsIHNlZ3NbaV0sIHByb3BzKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIC8vIEdyYWIgaW5kaXZpZHVhbCBlbGVtZW50cyBmcm9tIHRoZSBjb21iaW5lZCBIVE1MIHN0cmluZy4gVXNlIGVhY2ggYXMgdGhlIGRlZmF1bHQgcmVuZGVyaW5nLg0KICAgICAgICAgICAgLy8gVGhlbiwgY29tcHV0ZSB0aGUgJ2VsJyBmb3IgZWFjaCBzZWdtZW50Lg0KICAgICAgICAgICAgJChodG1sKS5lYWNoKGZ1bmN0aW9uIChpLCBub2RlKSB7DQogICAgICAgICAgICAgICAgdmFyIHNlZyA9IHNlZ3NbaV07DQogICAgICAgICAgICAgICAgdmFyIGVsID0gJChub2RlKTsNCiAgICAgICAgICAgICAgICAvLyBhbGxvdyBjdXN0b20gZmlsdGVyIG1ldGhvZHMgcGVyLXR5cGUNCiAgICAgICAgICAgICAgICBpZiAocHJvcHMuZmlsdGVyRWwpIHsNCiAgICAgICAgICAgICAgICAgICAgZWwgPSBwcm9wcy5maWx0ZXJFbChzZWcsIGVsKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYgKGVsKSB7DQogICAgICAgICAgICAgICAgICAgIGVsID0gJChlbCk7IC8vIGFsbG93IGN1c3RvbSBmaWx0ZXIgdG8gcmV0dXJuIHJhdyBET00gbm9kZQ0KICAgICAgICAgICAgICAgICAgICAvLyBjb3JyZWN0IGVsZW1lbnQgdHlwZT8gKHdvdWxkIGJlIGJhZCBpZiBhIG5vbi1URCB3ZXJlIGluc2VydGVkIGludG8gYSB0YWJsZSBmb3IgZXhhbXBsZSkNCiAgICAgICAgICAgICAgICAgICAgaWYgKGVsLmlzKF90aGlzLmZpbGxTZWdUYWcpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBzZWcuZWwgPSBlbDsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVkU2Vncy5wdXNoKHNlZyk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmVuZGVyZWRTZWdzOw0KICAgIH07DQogICAgLy8gQnVpbGRzIHRoZSBIVE1MIG5lZWRlZCBmb3Igb25lIGZpbGwgc2VnbWVudC4gR2VuZXJpYyBlbm91Z2ggdG8gd29yayB3aXRoIGRpZmZlcmVudCB0eXBlcy4NCiAgICBGaWxsUmVuZGVyZXIucHJvdG90eXBlLmJ1aWxkU2VnSHRtbCA9IGZ1bmN0aW9uICh0eXBlLCBzZWcsIHByb3BzKSB7DQogICAgICAgIC8vIGN1c3RvbSBob29rcyBwZXItdHlwZQ0KICAgICAgICB2YXIgY2xhc3NlcyA9IHByb3BzLmdldENsYXNzZXMgPyBwcm9wcy5nZXRDbGFzc2VzKHNlZykgOiBbXTsNCiAgICAgICAgdmFyIGNzcyA9IHV0aWxfMS5jc3NUb1N0cihwcm9wcy5nZXRDc3MgPyBwcm9wcy5nZXRDc3Moc2VnKSA6IHt9KTsNCiAgICAgICAgcmV0dXJuICc8JyArIHRoaXMuZmlsbFNlZ1RhZyArDQogICAgICAgICAgICAoY2xhc3Nlcy5sZW5ndGggPyAnIGNsYXNzPSInICsgY2xhc3Nlcy5qb2luKCcgJykgKyAnIicgOiAnJykgKw0KICAgICAgICAgICAgKGNzcyA/ICcgc3R5bGU9IicgKyBjc3MgKyAnIicgOiAnJykgKw0KICAgICAgICAgICAgJyAvPic7DQogICAgfTsNCiAgICAvLyBTaG91bGQgcmV0dXJuIHdyYXBwaW5nIERPTSBzdHJ1Y3R1cmUNCiAgICBGaWxsUmVuZGVyZXIucHJvdG90eXBlLmF0dGFjaFNlZ0VscyA9IGZ1bmN0aW9uICh0eXBlLCBzZWdzKSB7DQogICAgICAgIC8vIHN1YmNsYXNzZXMgbXVzdCBpbXBsZW1lbnQNCiAgICB9Ow0KICAgIEZpbGxSZW5kZXJlci5wcm90b3R5cGUucmVwb3J0RWxzID0gZnVuY3Rpb24gKHR5cGUsIG5vZGVzKSB7DQogICAgICAgIGlmICh0aGlzLmVsc0J5RmlsbFt0eXBlXSkgew0KICAgICAgICAgICAgdGhpcy5lbHNCeUZpbGxbdHlwZV0gPSB0aGlzLmVsc0J5RmlsbFt0eXBlXS5hZGQobm9kZXMpOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgdGhpcy5lbHNCeUZpbGxbdHlwZV0gPSAkKG5vZGVzKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgcmV0dXJuIEZpbGxSZW5kZXJlcjsNCn0oKSk7DQpleHBvcnRzLmRlZmF1bHQgPSBGaWxsUmVuZGVyZXI7DQoKCi8qKiovIH0pLAovKiA1OCAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIFNpbmdsZUV2ZW50RGVmXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDEzKTsNCnZhciBFdmVudEZvb3RwcmludF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzNSk7DQp2YXIgRXZlbnRTb3VyY2VfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNik7DQp2YXIgSGVscGVyUmVuZGVyZXIgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7DQogICAgZnVuY3Rpb24gSGVscGVyUmVuZGVyZXIoY29tcG9uZW50LCBldmVudFJlbmRlcmVyKSB7DQogICAgICAgIHRoaXMudmlldyA9IGNvbXBvbmVudC5fZ2V0VmlldygpOw0KICAgICAgICB0aGlzLmNvbXBvbmVudCA9IGNvbXBvbmVudDsNCiAgICAgICAgdGhpcy5ldmVudFJlbmRlcmVyID0gZXZlbnRSZW5kZXJlcjsNCiAgICB9DQogICAgSGVscGVyUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlckNvbXBvbmVudEZvb3RwcmludCA9IGZ1bmN0aW9uIChjb21wb25lbnRGb290cHJpbnQpIHsNCiAgICAgICAgdGhpcy5yZW5kZXJFdmVudEZvb3RwcmludHMoWw0KICAgICAgICAgICAgdGhpcy5mYWJyaWNhdGVFdmVudEZvb3RwcmludChjb21wb25lbnRGb290cHJpbnQpDQogICAgICAgIF0pOw0KICAgIH07DQogICAgSGVscGVyUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlckV2ZW50RHJhZ2dpbmdGb290cHJpbnRzID0gZnVuY3Rpb24gKGV2ZW50Rm9vdHByaW50cywgc291cmNlU2VnLCBpc1RvdWNoKSB7DQogICAgICAgIHRoaXMucmVuZGVyRXZlbnRGb290cHJpbnRzKGV2ZW50Rm9vdHByaW50cywgc291cmNlU2VnLCAnZmMtZHJhZ2dpbmcnLCBpc1RvdWNoID8gbnVsbCA6IHRoaXMudmlldy5vcHQoJ2RyYWdPcGFjaXR5JykpOw0KICAgIH07DQogICAgSGVscGVyUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlckV2ZW50UmVzaXppbmdGb290cHJpbnRzID0gZnVuY3Rpb24gKGV2ZW50Rm9vdHByaW50cywgc291cmNlU2VnLCBpc1RvdWNoKSB7DQogICAgICAgIHRoaXMucmVuZGVyRXZlbnRGb290cHJpbnRzKGV2ZW50Rm9vdHByaW50cywgc291cmNlU2VnLCAnZmMtcmVzaXppbmcnKTsNCiAgICB9Ow0KICAgIEhlbHBlclJlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJFdmVudEZvb3RwcmludHMgPSBmdW5jdGlvbiAoZXZlbnRGb290cHJpbnRzLCBzb3VyY2VTZWcsIGV4dHJhQ2xhc3NOYW1lcywgb3BhY2l0eSkgew0KICAgICAgICB2YXIgc2VncyA9IHRoaXMuY29tcG9uZW50LmV2ZW50Rm9vdHByaW50c1RvU2VncyhldmVudEZvb3RwcmludHMpOw0KICAgICAgICB2YXIgY2xhc3NOYW1lcyA9ICdmYy1oZWxwZXIgJyArIChleHRyYUNsYXNzTmFtZXMgfHwgJycpOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgLy8gYXNzaWducyBlYWNoIHNlZydzIGVsIGFuZCByZXR1cm5zIGEgc3Vic2V0IG9mIHNlZ3MgdGhhdCB3ZXJlIHJlbmRlcmVkDQogICAgICAgIHNlZ3MgPSB0aGlzLmV2ZW50UmVuZGVyZXIucmVuZGVyRmdTZWdFbHMoc2Vncyk7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZWdzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBzZWdzW2ldLmVsLmFkZENsYXNzKGNsYXNzTmFtZXMpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvcGFjaXR5ICE9IG51bGwpIHsNCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZWdzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgICAgc2Vnc1tpXS5lbC5jc3MoJ29wYWNpdHknLCBvcGFjaXR5KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmhlbHBlckVscyA9IHRoaXMucmVuZGVyU2VncyhzZWdzLCBzb3VyY2VTZWcpOw0KICAgIH07DQogICAgLyoNCiAgICBNdXN0IHJldHVybiBhbGwgbW9jayBldmVudCBlbGVtZW50cw0KICAgICovDQogICAgSGVscGVyUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlclNlZ3MgPSBmdW5jdGlvbiAoc2Vncywgc291cmNlU2VnKSB7DQogICAgICAgIC8vIFN1YmNsYXNzZXMgbXVzdCBpbXBsZW1lbnQNCiAgICB9Ow0KICAgIEhlbHBlclJlbmRlcmVyLnByb3RvdHlwZS51bnJlbmRlciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMuaGVscGVyRWxzKSB7DQogICAgICAgICAgICB0aGlzLmhlbHBlckVscy5yZW1vdmUoKTsNCiAgICAgICAgICAgIHRoaXMuaGVscGVyRWxzID0gbnVsbDsNCiAgICAgICAgfQ0KICAgIH07DQogICAgSGVscGVyUmVuZGVyZXIucHJvdG90eXBlLmZhYnJpY2F0ZUV2ZW50Rm9vdHByaW50ID0gZnVuY3Rpb24gKGNvbXBvbmVudEZvb3RwcmludCkgew0KICAgICAgICB2YXIgY2FsZW5kYXIgPSB0aGlzLnZpZXcuY2FsZW5kYXI7DQogICAgICAgIHZhciBldmVudERhdGVQcm9maWxlID0gY2FsZW5kYXIuZm9vdHByaW50VG9EYXRlUHJvZmlsZShjb21wb25lbnRGb290cHJpbnQpOw0KICAgICAgICB2YXIgZHVtbXlFdmVudCA9IG5ldyBTaW5nbGVFdmVudERlZl8xLmRlZmF1bHQobmV3IEV2ZW50U291cmNlXzEuZGVmYXVsdChjYWxlbmRhcikpOw0KICAgICAgICB2YXIgZHVtbXlJbnN0YW5jZTsNCiAgICAgICAgZHVtbXlFdmVudC5kYXRlUHJvZmlsZSA9IGV2ZW50RGF0ZVByb2ZpbGU7DQogICAgICAgIGR1bW15SW5zdGFuY2UgPSBkdW1teUV2ZW50LmJ1aWxkSW5zdGFuY2UoKTsNCiAgICAgICAgcmV0dXJuIG5ldyBFdmVudEZvb3RwcmludF8xLmRlZmF1bHQoY29tcG9uZW50Rm9vdHByaW50LCBkdW1teUV2ZW50LCBkdW1teUluc3RhbmNlKTsNCiAgICB9Ow0KICAgIHJldHVybiBIZWxwZXJSZW5kZXJlcjsNCn0oKSk7DQpleHBvcnRzLmRlZmF1bHQgPSBIZWxwZXJSZW5kZXJlcjsNCgoKLyoqKi8gfSksCi8qIDU5ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdHNsaWJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7DQp2YXIgR2xvYmFsRW1pdHRlcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNSk7DQp2YXIgSW50ZXJhY3Rpb25fMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTYpOw0KdmFyIEV2ZW50UG9pbnRpbmcgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoRXZlbnRQb2ludGluZywgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBFdmVudFBvaW50aW5nKCkgew0KICAgICAgICByZXR1cm4gX3N1cGVyICE9PSBudWxsICYmIF9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7DQogICAgfQ0KICAgIC8qDQogICAgY29tcG9uZW50IG11c3QgaW1wbGVtZW50Og0KICAgICAgLSBwdWJsaWNseVRyaWdnZXINCiAgICAqLw0KICAgIEV2ZW50UG9pbnRpbmcucHJvdG90eXBlLmJpbmRUb0VsID0gZnVuY3Rpb24gKGVsKSB7DQogICAgICAgIHZhciBjb21wb25lbnQgPSB0aGlzLmNvbXBvbmVudDsNCiAgICAgICAgY29tcG9uZW50LmJpbmRTZWdIYW5kbGVyVG9FbChlbCwgJ2NsaWNrJywgdGhpcy5oYW5kbGVDbGljay5iaW5kKHRoaXMpKTsNCiAgICAgICAgY29tcG9uZW50LmJpbmRTZWdIYW5kbGVyVG9FbChlbCwgJ21vdXNlZW50ZXInLCB0aGlzLmhhbmRsZU1vdXNlb3Zlci5iaW5kKHRoaXMpKTsNCiAgICAgICAgY29tcG9uZW50LmJpbmRTZWdIYW5kbGVyVG9FbChlbCwgJ21vdXNlbGVhdmUnLCB0aGlzLmhhbmRsZU1vdXNlb3V0LmJpbmQodGhpcykpOw0KICAgIH07DQogICAgRXZlbnRQb2ludGluZy5wcm90b3R5cGUuaGFuZGxlQ2xpY2sgPSBmdW5jdGlvbiAoc2VnLCBldikgew0KICAgICAgICB2YXIgcmVzID0gdGhpcy5jb21wb25lbnQucHVibGljbHlUcmlnZ2VyKCdldmVudENsaWNrJywgew0KICAgICAgICAgICAgY29udGV4dDogc2VnLmVsWzBdLA0KICAgICAgICAgICAgYXJnczogW3NlZy5mb290cHJpbnQuZ2V0RXZlbnRMZWdhY3koKSwgZXYsIHRoaXMudmlld10NCiAgICAgICAgfSk7DQogICAgICAgIGlmIChyZXMgPT09IGZhbHNlKSB7DQogICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBVcGRhdGVzIGludGVybmFsIHN0YXRlIGFuZCB0cmlnZ2VycyBoYW5kbGVycyBmb3Igd2hlbiBhbiBldmVudCBlbGVtZW50IGlzIG1vdXNlZCBvdmVyDQogICAgRXZlbnRQb2ludGluZy5wcm90b3R5cGUuaGFuZGxlTW91c2VvdmVyID0gZnVuY3Rpb24gKHNlZywgZXYpIHsNCiAgICAgICAgaWYgKCFHbG9iYWxFbWl0dGVyXzEuZGVmYXVsdC5nZXQoKS5zaG91bGRJZ25vcmVNb3VzZSgpICYmDQogICAgICAgICAgICAhdGhpcy5tb3VzZWRPdmVyU2VnKSB7DQogICAgICAgICAgICB0aGlzLm1vdXNlZE92ZXJTZWcgPSBzZWc7DQogICAgICAgICAgICAvLyBUT0RPOiBtb3ZlIHRvIEV2ZW50U2VsZWN0aW5nJ3MgcmVzcG9uc2liaWxpdHkNCiAgICAgICAgICAgIGlmICh0aGlzLnZpZXcuaXNFdmVudERlZlJlc2l6YWJsZShzZWcuZm9vdHByaW50LmV2ZW50RGVmKSkgew0KICAgICAgICAgICAgICAgIHNlZy5lbC5hZGRDbGFzcygnZmMtYWxsb3ctbW91c2UtcmVzaXplJyk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLmNvbXBvbmVudC5wdWJsaWNseVRyaWdnZXIoJ2V2ZW50TW91c2VvdmVyJywgew0KICAgICAgICAgICAgICAgIGNvbnRleHQ6IHNlZy5lbFswXSwNCiAgICAgICAgICAgICAgICBhcmdzOiBbc2VnLmZvb3RwcmludC5nZXRFdmVudExlZ2FjeSgpLCBldiwgdGhpcy52aWV3XQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIFVwZGF0ZXMgaW50ZXJuYWwgc3RhdGUgYW5kIHRyaWdnZXJzIGhhbmRsZXJzIGZvciB3aGVuIGFuIGV2ZW50IGVsZW1lbnQgaXMgbW91c2VkIG91dC4NCiAgICAvLyBDYW4gYmUgZ2l2ZW4gbm8gYXJndW1lbnRzLCBpbiB3aGljaCBjYXNlIGl0IHdpbGwgbW91c2VvdXQgdGhlIHNlZ21lbnQgdGhhdCB3YXMgcHJldmlvdXNseSBtb3VzZWQgb3Zlci4NCiAgICBFdmVudFBvaW50aW5nLnByb3RvdHlwZS5oYW5kbGVNb3VzZW91dCA9IGZ1bmN0aW9uIChzZWcsIGV2KSB7DQogICAgICAgIGlmICh0aGlzLm1vdXNlZE92ZXJTZWcpIHsNCiAgICAgICAgICAgIHRoaXMubW91c2VkT3ZlclNlZyA9IG51bGw7DQogICAgICAgICAgICAvLyBUT0RPOiBtb3ZlIHRvIEV2ZW50U2VsZWN0aW5nJ3MgcmVzcG9uc2liaWxpdHkNCiAgICAgICAgICAgIGlmICh0aGlzLnZpZXcuaXNFdmVudERlZlJlc2l6YWJsZShzZWcuZm9vdHByaW50LmV2ZW50RGVmKSkgew0KICAgICAgICAgICAgICAgIHNlZy5lbC5yZW1vdmVDbGFzcygnZmMtYWxsb3ctbW91c2UtcmVzaXplJyk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLmNvbXBvbmVudC5wdWJsaWNseVRyaWdnZXIoJ2V2ZW50TW91c2VvdXQnLCB7DQogICAgICAgICAgICAgICAgY29udGV4dDogc2VnLmVsWzBdLA0KICAgICAgICAgICAgICAgIGFyZ3M6IFsNCiAgICAgICAgICAgICAgICAgICAgc2VnLmZvb3RwcmludC5nZXRFdmVudExlZ2FjeSgpLA0KICAgICAgICAgICAgICAgICAgICBldiB8fCB7fSwNCiAgICAgICAgICAgICAgICAgICAgdGhpcy52aWV3DQogICAgICAgICAgICAgICAgXQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIEV2ZW50UG9pbnRpbmcucHJvdG90eXBlLmVuZCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMubW91c2VkT3ZlclNlZykgew0KICAgICAgICAgICAgdGhpcy5oYW5kbGVNb3VzZW91dCh0aGlzLm1vdXNlZE92ZXJTZWcpOw0KICAgICAgICB9DQogICAgfTsNCiAgICByZXR1cm4gRXZlbnRQb2ludGluZzsNCn0oSW50ZXJhY3Rpb25fMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBFdmVudFBvaW50aW5nOw0KCgovKioqLyB9KSwKLyogNjAgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciBNaXhpbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNCk7DQp2YXIgRGF0ZUNsaWNraW5nXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI0NSk7DQp2YXIgRGF0ZVNlbGVjdGluZ18xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMjUpOw0KdmFyIEV2ZW50UG9pbnRpbmdfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNTkpOw0KdmFyIEV2ZW50RHJhZ2dpbmdfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjI0KTsNCnZhciBFdmVudFJlc2l6aW5nXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIyMyk7DQp2YXIgRXh0ZXJuYWxEcm9wcGluZ18xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMjIpOw0KdmFyIFN0YW5kYXJkSW50ZXJhY3Rpb25zTWl4aW4gPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoU3RhbmRhcmRJbnRlcmFjdGlvbnNNaXhpbiwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBTdGFuZGFyZEludGVyYWN0aW9uc01peGluKCkgew0KICAgICAgICByZXR1cm4gX3N1cGVyICE9PSBudWxsICYmIF9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7DQogICAgfQ0KICAgIHJldHVybiBTdGFuZGFyZEludGVyYWN0aW9uc01peGluOw0KfShNaXhpbl8xLmRlZmF1bHQpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IFN0YW5kYXJkSW50ZXJhY3Rpb25zTWl4aW47DQpTdGFuZGFyZEludGVyYWN0aW9uc01peGluLnByb3RvdHlwZS5kYXRlQ2xpY2tpbmdDbGFzcyA9IERhdGVDbGlja2luZ18xLmRlZmF1bHQ7DQpTdGFuZGFyZEludGVyYWN0aW9uc01peGluLnByb3RvdHlwZS5kYXRlU2VsZWN0aW5nQ2xhc3MgPSBEYXRlU2VsZWN0aW5nXzEuZGVmYXVsdDsNClN0YW5kYXJkSW50ZXJhY3Rpb25zTWl4aW4ucHJvdG90eXBlLmV2ZW50UG9pbnRpbmdDbGFzcyA9IEV2ZW50UG9pbnRpbmdfMS5kZWZhdWx0Ow0KU3RhbmRhcmRJbnRlcmFjdGlvbnNNaXhpbi5wcm90b3R5cGUuZXZlbnREcmFnZ2luZ0NsYXNzID0gRXZlbnREcmFnZ2luZ18xLmRlZmF1bHQ7DQpTdGFuZGFyZEludGVyYWN0aW9uc01peGluLnByb3RvdHlwZS5ldmVudFJlc2l6aW5nQ2xhc3MgPSBFdmVudFJlc2l6aW5nXzEuZGVmYXVsdDsNClN0YW5kYXJkSW50ZXJhY3Rpb25zTWl4aW4ucHJvdG90eXBlLmV4dGVybmFsRHJvcHBpbmdDbGFzcyA9IEV4dGVybmFsRHJvcHBpbmdfMS5kZWZhdWx0Ow0KCgovKioqLyB9KSwKLyogNjEgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCnZhciB1dGlsXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQpOw0KdmFyIENvb3JkQ2FjaGVfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNTMpOw0KdmFyIFBvcG92ZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjQ5KTsNCnZhciBVbnpvbmVkUmFuZ2VfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNSk7DQp2YXIgQ29tcG9uZW50Rm9vdHByaW50XzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDEyKTsNCnZhciBFdmVudEZvb3RwcmludF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzNSk7DQp2YXIgQnVzaW5lc3NIb3VyUmVuZGVyZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNTYpOw0KdmFyIFN0YW5kYXJkSW50ZXJhY3Rpb25zTWl4aW5fMSA9IF9fd2VicGFja19yZXF1aXJlX18oNjApOw0KdmFyIEludGVyYWN0aXZlRGF0ZUNvbXBvbmVudF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0MCk7DQp2YXIgRGF5VGFibGVNaXhpbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1NSk7DQp2YXIgRGF5R3JpZEV2ZW50UmVuZGVyZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjUwKTsNCnZhciBEYXlHcmlkSGVscGVyUmVuZGVyZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjUxKTsNCnZhciBEYXlHcmlkRmlsbFJlbmRlcmVyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI1Mik7DQovKiBBIGNvbXBvbmVudCB0aGF0IHJlbmRlcnMgYSBncmlkIG9mIHdob2xlLWRheXMgdGhhdCBydW5zIGhvcml6b250YWxseS4gVGhlcmUgY2FuIGJlIG11bHRpcGxlIHJvd3MsIG9uZSBwZXIgd2Vlay4NCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KdmFyIERheUdyaWQgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoRGF5R3JpZCwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBEYXlHcmlkKHZpZXcpIHsNCiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgdmlldykgfHwgdGhpczsNCiAgICAgICAgX3RoaXMuY2VsbFdlZWtOdW1iZXJzVmlzaWJsZSA9IGZhbHNlOyAvLyBkaXNwbGF5IHdlZWsgbnVtYmVycyBpbiBkYXkgY2VsbD8NCiAgICAgICAgX3RoaXMuYm90dG9tQ29vcmRQYWRkaW5nID0gMDsgLy8gaGFjayBmb3IgZXh0ZW5kaW5nIHRoZSBoaXQgYXJlYSBmb3IgdGhlIGxhc3Qgcm93IG9mIHRoZSBjb29yZGluYXRlIGdyaWQNCiAgICAgICAgLy8gaXNSaWdpZCBkZXRlcm1pbmVzIHdoZXRoZXIgdGhlIGluZGl2aWR1YWwgcm93cyBzaG91bGQgaWdub3JlIHRoZSBjb250ZW50cyBhbmQgYmUgYSBjb25zdGFudCBoZWlnaHQuDQogICAgICAgIC8vIFJlbGllcyBvbiB0aGUgdmlldydzIGNvbENudCBhbmQgcm93Q250LiBJbiB0aGUgZnV0dXJlLCB0aGlzIGNvbXBvbmVudCBzaG91bGQgcHJvYmFibHkgYmUgc2VsZi1zdWZmaWNpZW50Lg0KICAgICAgICBfdGhpcy5pc1JpZ2lkID0gZmFsc2U7DQogICAgICAgIF90aGlzLmhhc0FsbERheUJ1c2luZXNzSG91cnMgPSB0cnVlOw0KICAgICAgICByZXR1cm4gX3RoaXM7DQogICAgfQ0KICAgIC8vIFNsaWNlcyB1cCB0aGUgZ2l2ZW4gc3BhbiAodW56b25lZCBzdGFydC9lbmQgd2l0aCBvdGhlciBtaXNjIGRhdGEpIGludG8gYW4gYXJyYXkgb2Ygc2VnbWVudHMNCiAgICBEYXlHcmlkLnByb3RvdHlwZS5jb21wb25lbnRGb290cHJpbnRUb1NlZ3MgPSBmdW5jdGlvbiAoY29tcG9uZW50Rm9vdHByaW50KSB7DQogICAgICAgIHZhciBzZWdzID0gdGhpcy5zbGljZVJhbmdlQnlSb3coY29tcG9uZW50Rm9vdHByaW50LnVuem9uZWRSYW5nZSk7DQogICAgICAgIHZhciBpOw0KICAgICAgICB2YXIgc2VnOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2Vncy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgc2VnID0gc2Vnc1tpXTsNCiAgICAgICAgICAgIGlmICh0aGlzLmlzUlRMKSB7DQogICAgICAgICAgICAgICAgc2VnLmxlZnRDb2wgPSB0aGlzLmRheXNQZXJSb3cgLSAxIC0gc2VnLmxhc3RSb3dEYXlJbmRleDsNCiAgICAgICAgICAgICAgICBzZWcucmlnaHRDb2wgPSB0aGlzLmRheXNQZXJSb3cgLSAxIC0gc2VnLmZpcnN0Um93RGF5SW5kZXg7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICBzZWcubGVmdENvbCA9IHNlZy5maXJzdFJvd0RheUluZGV4Ow0KICAgICAgICAgICAgICAgIHNlZy5yaWdodENvbCA9IHNlZy5sYXN0Um93RGF5SW5kZXg7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHNlZ3M7DQogICAgfTsNCiAgICAvKiBEYXRlIFJlbmRlcmluZw0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgRGF5R3JpZC5wcm90b3R5cGUucmVuZGVyRGF0ZXMgPSBmdW5jdGlvbiAoZGF0ZVByb2ZpbGUpIHsNCiAgICAgICAgdGhpcy5kYXRlUHJvZmlsZSA9IGRhdGVQcm9maWxlOw0KICAgICAgICB0aGlzLnVwZGF0ZURheVRhYmxlKCk7DQogICAgICAgIHRoaXMucmVuZGVyR3JpZCgpOw0KICAgIH07DQogICAgRGF5R3JpZC5wcm90b3R5cGUudW5yZW5kZXJEYXRlcyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5yZW1vdmVTZWdQb3BvdmVyKCk7DQogICAgfTsNCiAgICAvLyBSZW5kZXJzIHRoZSByb3dzIGFuZCBjb2x1bW5zIGludG8gdGhlIGNvbXBvbmVudCdzIGB0aGlzLmVsYCwgd2hpY2ggc2hvdWxkIGFscmVhZHkgYmUgYXNzaWduZWQuDQogICAgRGF5R3JpZC5wcm90b3R5cGUucmVuZGVyR3JpZCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLnZpZXc7DQogICAgICAgIHZhciByb3dDbnQgPSB0aGlzLnJvd0NudDsNCiAgICAgICAgdmFyIGNvbENudCA9IHRoaXMuY29sQ250Ow0KICAgICAgICB2YXIgaHRtbCA9ICcnOw0KICAgICAgICB2YXIgcm93Ow0KICAgICAgICB2YXIgY29sOw0KICAgICAgICBpZiAodGhpcy5oZWFkQ29udGFpbmVyRWwpIHsNCiAgICAgICAgICAgIHRoaXMuaGVhZENvbnRhaW5lckVsLmh0bWwodGhpcy5yZW5kZXJIZWFkSHRtbCgpKTsNCiAgICAgICAgfQ0KICAgICAgICBmb3IgKHJvdyA9IDA7IHJvdyA8IHJvd0NudDsgcm93KyspIHsNCiAgICAgICAgICAgIGh0bWwgKz0gdGhpcy5yZW5kZXJEYXlSb3dIdG1sKHJvdywgdGhpcy5pc1JpZ2lkKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmVsLmh0bWwoaHRtbCk7DQogICAgICAgIHRoaXMucm93RWxzID0gdGhpcy5lbC5maW5kKCcuZmMtcm93Jyk7DQogICAgICAgIHRoaXMuY2VsbEVscyA9IHRoaXMuZWwuZmluZCgnLmZjLWRheSwgLmZjLWRpc2FibGVkLWRheScpOw0KICAgICAgICB0aGlzLnJvd0Nvb3JkQ2FjaGUgPSBuZXcgQ29vcmRDYWNoZV8xLmRlZmF1bHQoew0KICAgICAgICAgICAgZWxzOiB0aGlzLnJvd0VscywNCiAgICAgICAgICAgIGlzVmVydGljYWw6IHRydWUNCiAgICAgICAgfSk7DQogICAgICAgIHRoaXMuY29sQ29vcmRDYWNoZSA9IG5ldyBDb29yZENhY2hlXzEuZGVmYXVsdCh7DQogICAgICAgICAgICBlbHM6IHRoaXMuY2VsbEVscy5zbGljZSgwLCB0aGlzLmNvbENudCksDQogICAgICAgICAgICBpc0hvcml6b250YWw6IHRydWUNCiAgICAgICAgfSk7DQogICAgICAgIC8vIHRyaWdnZXIgZGF5UmVuZGVyIHdpdGggZWFjaCBjZWxsJ3MgZWxlbWVudA0KICAgICAgICBmb3IgKHJvdyA9IDA7IHJvdyA8IHJvd0NudDsgcm93KyspIHsNCiAgICAgICAgICAgIGZvciAoY29sID0gMDsgY29sIDwgY29sQ250OyBjb2wrKykgew0KICAgICAgICAgICAgICAgIHRoaXMucHVibGljbHlUcmlnZ2VyKCdkYXlSZW5kZXInLCB7DQogICAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IHZpZXcsDQogICAgICAgICAgICAgICAgICAgIGFyZ3M6IFsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0Q2VsbERhdGUocm93LCBjb2wpLA0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRDZWxsRWwocm93LCBjb2wpLA0KICAgICAgICAgICAgICAgICAgICAgICAgdmlldw0KICAgICAgICAgICAgICAgICAgICBdDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIEdlbmVyYXRlcyB0aGUgSFRNTCBmb3IgYSBzaW5nbGUgcm93LCB3aGljaCBpcyBhIGRpdiB0aGF0IHdyYXBzIGEgdGFibGUuDQogICAgLy8gYHJvd2AgaXMgdGhlIHJvdyBudW1iZXIuDQogICAgRGF5R3JpZC5wcm90b3R5cGUucmVuZGVyRGF5Um93SHRtbCA9IGZ1bmN0aW9uIChyb3csIGlzUmlnaWQpIHsNCiAgICAgICAgdmFyIHRoZW1lID0gdGhpcy52aWV3LmNhbGVuZGFyLnRoZW1lOw0KICAgICAgICB2YXIgY2xhc3NlcyA9IFsnZmMtcm93JywgJ2ZjLXdlZWsnLCB0aGVtZS5nZXRDbGFzcygnZGF5Um93JyldOw0KICAgICAgICBpZiAoaXNSaWdpZCkgew0KICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKCdmYy1yaWdpZCcpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiAnJyArDQogICAgICAgICAgICAnPGRpdiBjbGFzcz0iJyArIGNsYXNzZXMuam9pbignICcpICsgJyI+JyArDQogICAgICAgICAgICAnPGRpdiBjbGFzcz0iZmMtYmciPicgKw0KICAgICAgICAgICAgJzx0YWJsZSBjbGFzcz0iJyArIHRoZW1lLmdldENsYXNzKCd0YWJsZUdyaWQnKSArICciPicgKw0KICAgICAgICAgICAgdGhpcy5yZW5kZXJCZ1RySHRtbChyb3cpICsNCiAgICAgICAgICAgICc8L3RhYmxlPicgKw0KICAgICAgICAgICAgJzwvZGl2PicgKw0KICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImZjLWNvbnRlbnQtc2tlbGV0b24iPicgKw0KICAgICAgICAgICAgJzx0YWJsZT4nICsNCiAgICAgICAgICAgICh0aGlzLmdldElzTnVtYmVyc1Zpc2libGUoKSA/DQogICAgICAgICAgICAgICAgJzx0aGVhZD4nICsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJOdW1iZXJUckh0bWwocm93KSArDQogICAgICAgICAgICAgICAgICAgICc8L3RoZWFkPicgOg0KICAgICAgICAgICAgICAgICcnKSArDQogICAgICAgICAgICAnPC90YWJsZT4nICsNCiAgICAgICAgICAgICc8L2Rpdj4nICsNCiAgICAgICAgICAgICc8L2Rpdj4nOw0KICAgIH07DQogICAgRGF5R3JpZC5wcm90b3R5cGUuZ2V0SXNOdW1iZXJzVmlzaWJsZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SXNEYXlOdW1iZXJzVmlzaWJsZSgpIHx8IHRoaXMuY2VsbFdlZWtOdW1iZXJzVmlzaWJsZTsNCiAgICB9Ow0KICAgIERheUdyaWQucHJvdG90eXBlLmdldElzRGF5TnVtYmVyc1Zpc2libGUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHJldHVybiB0aGlzLnJvd0NudCA+IDE7DQogICAgfTsNCiAgICAvKiBHcmlkIE51bWJlciBSZW5kZXJpbmcNCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KICAgIERheUdyaWQucHJvdG90eXBlLnJlbmRlck51bWJlclRySHRtbCA9IGZ1bmN0aW9uIChyb3cpIHsNCiAgICAgICAgcmV0dXJuICcnICsNCiAgICAgICAgICAgICc8dHI+JyArDQogICAgICAgICAgICAodGhpcy5pc1JUTCA/ICcnIDogdGhpcy5yZW5kZXJOdW1iZXJJbnRyb0h0bWwocm93KSkgKw0KICAgICAgICAgICAgdGhpcy5yZW5kZXJOdW1iZXJDZWxsc0h0bWwocm93KSArDQogICAgICAgICAgICAodGhpcy5pc1JUTCA/IHRoaXMucmVuZGVyTnVtYmVySW50cm9IdG1sKHJvdykgOiAnJykgKw0KICAgICAgICAgICAgJzwvdHI+JzsNCiAgICB9Ow0KICAgIERheUdyaWQucHJvdG90eXBlLnJlbmRlck51bWJlckludHJvSHRtbCA9IGZ1bmN0aW9uIChyb3cpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMucmVuZGVySW50cm9IdG1sKCk7DQogICAgfTsNCiAgICBEYXlHcmlkLnByb3RvdHlwZS5yZW5kZXJOdW1iZXJDZWxsc0h0bWwgPSBmdW5jdGlvbiAocm93KSB7DQogICAgICAgIHZhciBodG1scyA9IFtdOw0KICAgICAgICB2YXIgY29sOw0KICAgICAgICB2YXIgZGF0ZTsNCiAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzLmNvbENudDsgY29sKyspIHsNCiAgICAgICAgICAgIGRhdGUgPSB0aGlzLmdldENlbGxEYXRlKHJvdywgY29sKTsNCiAgICAgICAgICAgIGh0bWxzLnB1c2godGhpcy5yZW5kZXJOdW1iZXJDZWxsSHRtbChkYXRlKSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGh0bWxzLmpvaW4oJycpOw0KICAgIH07DQogICAgLy8gR2VuZXJhdGVzIHRoZSBIVE1MIGZvciB0aGUgPHRkPnMgb2YgdGhlICJudW1iZXIiIHJvdyBpbiB0aGUgRGF5R3JpZCdzIGNvbnRlbnQgc2tlbGV0b24uDQogICAgLy8gVGhlIG51bWJlciByb3cgd2lsbCBvbmx5IGV4aXN0IGlmIGVpdGhlciBkYXkgbnVtYmVycyBvciB3ZWVrIG51bWJlcnMgYXJlIHR1cm5lZCBvbi4NCiAgICBEYXlHcmlkLnByb3RvdHlwZS5yZW5kZXJOdW1iZXJDZWxsSHRtbCA9IGZ1bmN0aW9uIChkYXRlKSB7DQogICAgICAgIHZhciB2aWV3ID0gdGhpcy52aWV3Ow0KICAgICAgICB2YXIgaHRtbCA9ICcnOw0KICAgICAgICB2YXIgaXNEYXRlVmFsaWQgPSB0aGlzLmRhdGVQcm9maWxlLmFjdGl2ZVVuem9uZWRSYW5nZS5jb250YWluc0RhdGUoZGF0ZSk7IC8vIFRPRE86IGNhbGxlZCB0b28gZnJlcXVlbnRseS4gY2FjaGUgc29tZWhvdy4NCiAgICAgICAgdmFyIGlzRGF5TnVtYmVyVmlzaWJsZSA9IHRoaXMuZ2V0SXNEYXlOdW1iZXJzVmlzaWJsZSgpICYmIGlzRGF0ZVZhbGlkOw0KICAgICAgICB2YXIgY2xhc3NlczsNCiAgICAgICAgdmFyIHdlZWtDYWxjRmlyc3REb1c7DQogICAgICAgIGlmICghaXNEYXlOdW1iZXJWaXNpYmxlICYmICF0aGlzLmNlbGxXZWVrTnVtYmVyc1Zpc2libGUpIHsNCiAgICAgICAgICAgIC8vIG5vIG51bWJlcnMgaW4gZGF5IGNlbGwgKHdlZWsgbnVtYmVyIG11c3QgYmUgYWxvbmcgdGhlIHNpZGUpDQogICAgICAgICAgICByZXR1cm4gJzx0ZC8+JzsgLy8gIHdpbGwgY3JlYXRlIGFuIGVtcHR5IHNwYWNlIGFib3ZlIGV2ZW50cyA6KA0KICAgICAgICB9DQogICAgICAgIGNsYXNzZXMgPSB0aGlzLmdldERheUNsYXNzZXMoZGF0ZSk7DQogICAgICAgIGNsYXNzZXMudW5zaGlmdCgnZmMtZGF5LXRvcCcpOw0KICAgICAgICBpZiAodGhpcy5jZWxsV2Vla051bWJlcnNWaXNpYmxlKSB7DQogICAgICAgICAgICAvLyBUbyBkZXRlcm1pbmUgdGhlIGRheSBvZiB3ZWVrIG51bWJlciBjaGFuZ2UgdW5kZXIgSVNPLCB3ZSBjYW5ub3QNCiAgICAgICAgICAgIC8vIHJlbHkgb24gbW9tZW50LmpzIG1ldGhvZHMgc3VjaCBhcyBmaXJzdERheU9mV2VlaygpIG9yIHdlZWtkYXkoKSwNCiAgICAgICAgICAgIC8vIGJlY2F1c2UgdGhleSByZWx5IG9uIHRoZSBsb2NhbGUncyBkb3cgKHBvc3NpYmx5IG92ZXJyaWRkZW4gYnkNCiAgICAgICAgICAgIC8vIG91ciBmaXJzdERheSBvcHRpb24pLCB3aGljaCBtYXkgbm90IGJlIE1vbmRheS4gV2UgY2Fubm90IGNoYW5nZQ0KICAgICAgICAgICAgLy8gZG93LCBiZWNhdXNlIHRoYXQgd291bGQgYWZmZWN0IHRoZSBjYWxlbmRhciBzdGFydCBkYXkgYXMgd2VsbC4NCiAgICAgICAgICAgIGlmIChkYXRlLl9sb2NhbGUuX2Z1bGxDYWxlbmRhcl93ZWVrQ2FsYyA9PT0gJ0lTTycpIHsNCiAgICAgICAgICAgICAgICB3ZWVrQ2FsY0ZpcnN0RG9XID0gMTsgLy8gTW9uZGF5IGJ5IElTTyA4NjAxIGRlZmluaXRpb24NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIHdlZWtDYWxjRmlyc3REb1cgPSBkYXRlLl9sb2NhbGUuZmlyc3REYXlPZldlZWsoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBodG1sICs9ICc8dGQgY2xhc3M9IicgKyBjbGFzc2VzLmpvaW4oJyAnKSArICciJyArDQogICAgICAgICAgICAoaXNEYXRlVmFsaWQgPw0KICAgICAgICAgICAgICAgICcgZGF0YS1kYXRlPSInICsgZGF0ZS5mb3JtYXQoKSArICciJyA6DQogICAgICAgICAgICAgICAgJycpICsNCiAgICAgICAgICAgICc+JzsNCiAgICAgICAgaWYgKHRoaXMuY2VsbFdlZWtOdW1iZXJzVmlzaWJsZSAmJiAoZGF0ZS5kYXkoKSA9PT0gd2Vla0NhbGNGaXJzdERvVykpIHsNCiAgICAgICAgICAgIGh0bWwgKz0gdmlldy5idWlsZEdvdG9BbmNob3JIdG1sKHsgZGF0ZTogZGF0ZSwgdHlwZTogJ3dlZWsnIH0sIHsgJ2NsYXNzJzogJ2ZjLXdlZWstbnVtYmVyJyB9LCBkYXRlLmZvcm1hdCgndycpIC8vIGlubmVyIEhUTUwNCiAgICAgICAgICAgICk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKGlzRGF5TnVtYmVyVmlzaWJsZSkgew0KICAgICAgICAgICAgaHRtbCArPSB2aWV3LmJ1aWxkR290b0FuY2hvckh0bWwoZGF0ZSwgeyAnY2xhc3MnOiAnZmMtZGF5LW51bWJlcicgfSwgZGF0ZS5mb3JtYXQoJ0QnKSAvLyBpbm5lciBIVE1MDQogICAgICAgICAgICApOw0KICAgICAgICB9DQogICAgICAgIGh0bWwgKz0gJzwvdGQ+JzsNCiAgICAgICAgcmV0dXJuIGh0bWw7DQogICAgfTsNCiAgICAvKiBIaXQgU3lzdGVtDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICBEYXlHcmlkLnByb3RvdHlwZS5wcmVwYXJlSGl0cyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5jb2xDb29yZENhY2hlLmJ1aWxkKCk7DQogICAgICAgIHRoaXMucm93Q29vcmRDYWNoZS5idWlsZCgpOw0KICAgICAgICB0aGlzLnJvd0Nvb3JkQ2FjaGUuYm90dG9tc1t0aGlzLnJvd0NudCAtIDFdICs9IHRoaXMuYm90dG9tQ29vcmRQYWRkaW5nOyAvLyBoYWNrDQogICAgfTsNCiAgICBEYXlHcmlkLnByb3RvdHlwZS5yZWxlYXNlSGl0cyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5jb2xDb29yZENhY2hlLmNsZWFyKCk7DQogICAgICAgIHRoaXMucm93Q29vcmRDYWNoZS5jbGVhcigpOw0KICAgIH07DQogICAgRGF5R3JpZC5wcm90b3R5cGUucXVlcnlIaXQgPSBmdW5jdGlvbiAobGVmdE9mZnNldCwgdG9wT2Zmc2V0KSB7DQogICAgICAgIGlmICh0aGlzLmNvbENvb3JkQ2FjaGUuaXNMZWZ0SW5Cb3VuZHMobGVmdE9mZnNldCkgJiYgdGhpcy5yb3dDb29yZENhY2hlLmlzVG9wSW5Cb3VuZHModG9wT2Zmc2V0KSkgew0KICAgICAgICAgICAgdmFyIGNvbCA9IHRoaXMuY29sQ29vcmRDYWNoZS5nZXRIb3Jpem9udGFsSW5kZXgobGVmdE9mZnNldCk7DQogICAgICAgICAgICB2YXIgcm93ID0gdGhpcy5yb3dDb29yZENhY2hlLmdldFZlcnRpY2FsSW5kZXgodG9wT2Zmc2V0KTsNCiAgICAgICAgICAgIGlmIChyb3cgIT0gbnVsbCAmJiBjb2wgIT0gbnVsbCkgew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENlbGxIaXQocm93LCBjb2wpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfTsNCiAgICBEYXlHcmlkLnByb3RvdHlwZS5nZXRIaXRGb290cHJpbnQgPSBmdW5jdGlvbiAoaGl0KSB7DQogICAgICAgIHZhciByYW5nZSA9IHRoaXMuZ2V0Q2VsbFJhbmdlKGhpdC5yb3csIGhpdC5jb2wpOw0KICAgICAgICByZXR1cm4gbmV3IENvbXBvbmVudEZvb3RwcmludF8xLmRlZmF1bHQobmV3IFVuem9uZWRSYW5nZV8xLmRlZmF1bHQocmFuZ2Uuc3RhcnQsIHJhbmdlLmVuZCksIHRydWUgLy8gYWxsLWRheT8NCiAgICAgICAgKTsNCiAgICB9Ow0KICAgIERheUdyaWQucHJvdG90eXBlLmdldEhpdEVsID0gZnVuY3Rpb24gKGhpdCkgew0KICAgICAgICByZXR1cm4gdGhpcy5nZXRDZWxsRWwoaGl0LnJvdywgaGl0LmNvbCk7DQogICAgfTsNCiAgICAvKiBDZWxsIFN5c3RlbQ0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgLy8gRllJOiB0aGUgZmlyc3QgY29sdW1uIGlzIHRoZSBsZWZ0bW9zdCBjb2x1bW4sIHJlZ2FyZGxlc3Mgb2YgZGF0ZQ0KICAgIERheUdyaWQucHJvdG90eXBlLmdldENlbGxIaXQgPSBmdW5jdGlvbiAocm93LCBjb2wpIHsNCiAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgIHJvdzogcm93LA0KICAgICAgICAgICAgY29sOiBjb2wsDQogICAgICAgICAgICBjb21wb25lbnQ6IHRoaXMsDQogICAgICAgICAgICBsZWZ0OiB0aGlzLmNvbENvb3JkQ2FjaGUuZ2V0TGVmdE9mZnNldChjb2wpLA0KICAgICAgICAgICAgcmlnaHQ6IHRoaXMuY29sQ29vcmRDYWNoZS5nZXRSaWdodE9mZnNldChjb2wpLA0KICAgICAgICAgICAgdG9wOiB0aGlzLnJvd0Nvb3JkQ2FjaGUuZ2V0VG9wT2Zmc2V0KHJvdyksDQogICAgICAgICAgICBib3R0b206IHRoaXMucm93Q29vcmRDYWNoZS5nZXRCb3R0b21PZmZzZXQocm93KQ0KICAgICAgICB9Ow0KICAgIH07DQogICAgRGF5R3JpZC5wcm90b3R5cGUuZ2V0Q2VsbEVsID0gZnVuY3Rpb24gKHJvdywgY29sKSB7DQogICAgICAgIHJldHVybiB0aGlzLmNlbGxFbHMuZXEocm93ICogdGhpcy5jb2xDbnQgKyBjb2wpOw0KICAgIH07DQogICAgLyogRXZlbnQgUmVuZGVyaW5nDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICAvLyBVbnJlbmRlcnMgYWxsIGV2ZW50cyBjdXJyZW50bHkgcmVuZGVyZWQgb24gdGhlIGdyaWQNCiAgICBEYXlHcmlkLnByb3RvdHlwZS5leGVjdXRlRXZlbnRVbnJlbmRlciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5yZW1vdmVTZWdQb3BvdmVyKCk7IC8vIHJlbW92ZXMgdGhlICJtb3JlLi4iIGV2ZW50cyBwb3BvdmVyDQogICAgICAgIF9zdXBlci5wcm90b3R5cGUuZXhlY3V0ZUV2ZW50VW5yZW5kZXIuY2FsbCh0aGlzKTsNCiAgICB9Ow0KICAgIC8vIFJldHJpZXZlcyBhbGwgcmVuZGVyZWQgc2VnbWVudCBvYmplY3RzIGN1cnJlbnRseSByZW5kZXJlZCBvbiB0aGUgZ3JpZA0KICAgIERheUdyaWQucHJvdG90eXBlLmdldE93bkV2ZW50U2VncyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgLy8gYXBwZW5kIHRoZSBzZWdtZW50cyBmcm9tIHRoZSAibW9yZS4uLiIgcG9wb3Zlcg0KICAgICAgICByZXR1cm4gX3N1cGVyLnByb3RvdHlwZS5nZXRPd25FdmVudFNlZ3MuY2FsbCh0aGlzKS5jb25jYXQodGhpcy5wb3BvdmVyU2VncyB8fCBbXSk7DQogICAgfTsNCiAgICAvKiBFdmVudCBEcmFnIFZpc3VhbGl6YXRpb24NCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KICAgIC8vIFJlbmRlcnMgYSB2aXN1YWwgaW5kaWNhdGlvbiBvZiBhbiBldmVudCBvciBleHRlcm5hbCBlbGVtZW50IGJlaW5nIGRyYWdnZWQuDQogICAgLy8gYGV2ZW50TG9jYXRpb25gIGhhcyB6b25lZCBzdGFydCBhbmQgZW5kIChvcHRpb25hbCkNCiAgICBEYXlHcmlkLnByb3RvdHlwZS5yZW5kZXJEcmFnID0gZnVuY3Rpb24gKGV2ZW50Rm9vdHByaW50cywgc2VnLCBpc1RvdWNoKSB7DQogICAgICAgIHZhciBpOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZXZlbnRGb290cHJpbnRzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICB0aGlzLnJlbmRlckhpZ2hsaWdodChldmVudEZvb3RwcmludHNbaV0uY29tcG9uZW50Rm9vdHByaW50KTsNCiAgICAgICAgfQ0KICAgICAgICAvLyByZW5kZXIgZHJhZ3MgZnJvbSBPVEhFUiBjb21wb25lbnRzIGFzIGhlbHBlcnMNCiAgICAgICAgaWYgKGV2ZW50Rm9vdHByaW50cy5sZW5ndGggJiYgc2VnICYmIHNlZy5jb21wb25lbnQgIT09IHRoaXMpIHsNCiAgICAgICAgICAgIHRoaXMuaGVscGVyUmVuZGVyZXIucmVuZGVyRXZlbnREcmFnZ2luZ0Zvb3RwcmludHMoZXZlbnRGb290cHJpbnRzLCBzZWcsIGlzVG91Y2gpOw0KICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIHNpZ25hbCBoZWxwZXJzIHJlbmRlcmVkDQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIFVucmVuZGVycyBhbnkgdmlzdWFsIGluZGljYXRpb24gb2YgYSBob3ZlcmluZyBldmVudA0KICAgIERheUdyaWQucHJvdG90eXBlLnVucmVuZGVyRHJhZyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy51bnJlbmRlckhpZ2hsaWdodCgpOw0KICAgICAgICB0aGlzLmhlbHBlclJlbmRlcmVyLnVucmVuZGVyKCk7DQogICAgfTsNCiAgICAvKiBFdmVudCBSZXNpemUgVmlzdWFsaXphdGlvbg0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgLy8gUmVuZGVycyBhIHZpc3VhbCBpbmRpY2F0aW9uIG9mIGFuIGV2ZW50IGJlaW5nIHJlc2l6ZWQNCiAgICBEYXlHcmlkLnByb3RvdHlwZS5yZW5kZXJFdmVudFJlc2l6ZSA9IGZ1bmN0aW9uIChldmVudEZvb3RwcmludHMsIHNlZywgaXNUb3VjaCkgew0KICAgICAgICB2YXIgaTsNCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGV2ZW50Rm9vdHByaW50cy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgdGhpcy5yZW5kZXJIaWdobGlnaHQoZXZlbnRGb290cHJpbnRzW2ldLmNvbXBvbmVudEZvb3RwcmludCk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5oZWxwZXJSZW5kZXJlci5yZW5kZXJFdmVudFJlc2l6aW5nRm9vdHByaW50cyhldmVudEZvb3RwcmludHMsIHNlZywgaXNUb3VjaCk7DQogICAgfTsNCiAgICAvLyBVbnJlbmRlcnMgYSB2aXN1YWwgaW5kaWNhdGlvbiBvZiBhbiBldmVudCBiZWluZyByZXNpemVkDQogICAgRGF5R3JpZC5wcm90b3R5cGUudW5yZW5kZXJFdmVudFJlc2l6ZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy51bnJlbmRlckhpZ2hsaWdodCgpOw0KICAgICAgICB0aGlzLmhlbHBlclJlbmRlcmVyLnVucmVuZGVyKCk7DQogICAgfTsNCiAgICAvKiBNb3JlKyBMaW5rIFBvcG92ZXINCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KICAgIERheUdyaWQucHJvdG90eXBlLnJlbW92ZVNlZ1BvcG92ZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICh0aGlzLnNlZ1BvcG92ZXIpIHsNCiAgICAgICAgICAgIHRoaXMuc2VnUG9wb3Zlci5oaWRlKCk7IC8vIGluIGhhbmRsZXIsIHdpbGwgY2FsbCBzZWdQb3BvdmVyJ3MgcmVtb3ZlRWxlbWVudA0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBMaW1pdHMgdGhlIG51bWJlciBvZiAibGV2ZWxzIiAodmVydGljYWxseSBzdGFja2luZyBsYXllcnMgb2YgZXZlbnRzKSBmb3IgZWFjaCByb3cgb2YgdGhlIGdyaWQuDQogICAgLy8gYGxldmVsTGltaXRgIGNhbiBiZSBmYWxzZSAoZG9uJ3QgbGltaXQpLCBhIG51bWJlciwgb3IgdHJ1ZSAoc2hvdWxkIGJlIGNvbXB1dGVkKS4NCiAgICBEYXlHcmlkLnByb3RvdHlwZS5saW1pdFJvd3MgPSBmdW5jdGlvbiAobGV2ZWxMaW1pdCkgew0KICAgICAgICB2YXIgcm93U3RydWN0cyA9IHRoaXMuZXZlbnRSZW5kZXJlci5yb3dTdHJ1Y3RzIHx8IFtdOw0KICAgICAgICB2YXIgcm93OyAvLyByb3cgIw0KICAgICAgICB2YXIgcm93TGV2ZWxMaW1pdDsNCiAgICAgICAgZm9yIChyb3cgPSAwOyByb3cgPCByb3dTdHJ1Y3RzLmxlbmd0aDsgcm93KyspIHsNCiAgICAgICAgICAgIHRoaXMudW5saW1pdFJvdyhyb3cpOw0KICAgICAgICAgICAgaWYgKCFsZXZlbExpbWl0KSB7DQogICAgICAgICAgICAgICAgcm93TGV2ZWxMaW1pdCA9IGZhbHNlOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIGxldmVsTGltaXQgPT09ICdudW1iZXInKSB7DQogICAgICAgICAgICAgICAgcm93TGV2ZWxMaW1pdCA9IGxldmVsTGltaXQ7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICByb3dMZXZlbExpbWl0ID0gdGhpcy5jb21wdXRlUm93TGV2ZWxMaW1pdChyb3cpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKHJvd0xldmVsTGltaXQgIT09IGZhbHNlKSB7DQogICAgICAgICAgICAgICAgdGhpcy5saW1pdFJvdyhyb3csIHJvd0xldmVsTGltaXQpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBDb21wdXRlcyB0aGUgbnVtYmVyIG9mIGxldmVscyBhIHJvdyB3aWxsIGFjY29tb2RhdGUgd2l0aG91dCBnb2luZyBvdXRzaWRlIGl0cyBib3VuZHMuDQogICAgLy8gQXNzdW1lcyB0aGUgcm93IGlzICJyaWdpZCIgKG1haW50YWlucyBhIGNvbnN0YW50IGhlaWdodCByZWdhcmRsZXNzIG9mIHdoYXQgaXMgaW5zaWRlKS4NCiAgICAvLyBgcm93YCBpcyB0aGUgcm93IG51bWJlci4NCiAgICBEYXlHcmlkLnByb3RvdHlwZS5jb21wdXRlUm93TGV2ZWxMaW1pdCA9IGZ1bmN0aW9uIChyb3cpIHsNCiAgICAgICAgdmFyIHJvd0VsID0gdGhpcy5yb3dFbHMuZXEocm93KTsgLy8gdGhlIGNvbnRhaW5pbmcgImZha2UiIHJvdyBkaXYNCiAgICAgICAgdmFyIHJvd0hlaWdodCA9IHJvd0VsLmhlaWdodCgpOyAvLyBUT0RPOiBjYWNoZSBzb21laG93Pw0KICAgICAgICB2YXIgdHJFbHMgPSB0aGlzLmV2ZW50UmVuZGVyZXIucm93U3RydWN0c1tyb3ddLnRib2R5RWwuY2hpbGRyZW4oKTsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIHZhciB0ckVsOw0KICAgICAgICB2YXIgdHJIZWlnaHQ7DQogICAgICAgIGZ1bmN0aW9uIGl0ZXJJbm5lckhlaWdodHMoaSwgY2hpbGROb2RlKSB7DQogICAgICAgICAgICB0ckhlaWdodCA9IE1hdGgubWF4KHRySGVpZ2h0LCAkKGNoaWxkTm9kZSkub3V0ZXJIZWlnaHQoKSk7DQogICAgICAgIH0NCiAgICAgICAgLy8gUmV2ZWFsIG9uZSBsZXZlbCA8dHI+IGF0IGEgdGltZSBhbmQgc3RvcCB3aGVuIHdlIGZpbmQgb25lIG91dCBvZiBib3VuZHMNCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRyRWxzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICB0ckVsID0gdHJFbHMuZXEoaSkucmVtb3ZlQ2xhc3MoJ2ZjLWxpbWl0ZWQnKTsgLy8gcmVzZXQgdG8gb3JpZ2luYWwgc3RhdGUgKHJldmVhbCkNCiAgICAgICAgICAgIC8vIHdpdGggcm93c3BhbnM+MSBhbmQgSUU4LCB0ckVsLm91dGVySGVpZ2h0KCkgd291bGQgcmV0dXJuIHRoZSBoZWlnaHQgb2YgdGhlIGxhcmdlc3QgY2VsbCwNCiAgICAgICAgICAgIC8vIHNvIGluc3RlYWQsIGZpbmQgdGhlIHRhbGxlc3QgaW5uZXIgY29udGVudCBlbGVtZW50Lg0KICAgICAgICAgICAgdHJIZWlnaHQgPSAwOw0KICAgICAgICAgICAgdHJFbC5maW5kKCc+IHRkID4gOmZpcnN0LWNoaWxkJykuZWFjaChpdGVySW5uZXJIZWlnaHRzKTsNCiAgICAgICAgICAgIGlmICh0ckVsLnBvc2l0aW9uKCkudG9wICsgdHJIZWlnaHQgPiByb3dIZWlnaHQpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gaTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZmFsc2U7IC8vIHNob3VsZCBub3QgbGltaXQgYXQgYWxsDQogICAgfTsNCiAgICAvLyBMaW1pdHMgdGhlIGdpdmVuIGdyaWQgcm93IHRvIHRoZSBtYXhpbXVtIG51bWJlciBvZiBsZXZlbHMgYW5kIGluamVjdHMgIm1vcmUiIGxpbmtzIGlmIG5lY2Vzc2FyeS4NCiAgICAvLyBgcm93YCBpcyB0aGUgcm93IG51bWJlci4NCiAgICAvLyBgbGV2ZWxMaW1pdGAgaXMgYSBudW1iZXIgZm9yIHRoZSBtYXhpbXVtIChpbmNsdXNpdmUpIG51bWJlciBvZiBsZXZlbHMgYWxsb3dlZC4NCiAgICBEYXlHcmlkLnByb3RvdHlwZS5saW1pdFJvdyA9IGZ1bmN0aW9uIChyb3csIGxldmVsTGltaXQpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgdmFyIHJvd1N0cnVjdCA9IHRoaXMuZXZlbnRSZW5kZXJlci5yb3dTdHJ1Y3RzW3Jvd107DQogICAgICAgIHZhciBtb3JlTm9kZXMgPSBbXTsgLy8gYXJyYXkgb2YgIm1vcmUiIDxhPiBsaW5rcyBhbmQgPHRkPiBET00gbm9kZXMNCiAgICAgICAgdmFyIGNvbCA9IDA7IC8vIGNvbCAjLCBsZWZ0LXRvLXJpZ2h0IChub3QgY2hyb25vbG9naWNhbGx5KQ0KICAgICAgICB2YXIgbGV2ZWxTZWdzOyAvLyBhcnJheSBvZiBzZWdtZW50IG9iamVjdHMgaW4gdGhlIGxhc3QgYWxsb3dhYmxlIGxldmVsLCBvcmRlcmVkIGxlZnQtdG8tcmlnaHQNCiAgICAgICAgdmFyIGNlbGxNYXRyaXg7IC8vIGEgbWF0cml4IChieSBsZXZlbCwgdGhlbiBjb2x1bW4pIG9mIGFsbCA8dGQ+IGpRdWVyeSBlbGVtZW50cyBpbiB0aGUgcm93DQogICAgICAgIHZhciBsaW1pdGVkTm9kZXM7IC8vIGFycmF5IG9mIHRlbXBvcmFyaWx5IGhpZGRlbiBsZXZlbCA8dHI+IGFuZCBzZWdtZW50IDx0ZD4gRE9NIG5vZGVzDQogICAgICAgIHZhciBpOw0KICAgICAgICB2YXIgc2VnOw0KICAgICAgICB2YXIgc2Vnc0JlbG93OyAvLyBhcnJheSBvZiBzZWdtZW50IG9iamVjdHMgYmVsb3cgYHNlZ2AgaW4gdGhlIGN1cnJlbnQgYGNvbGANCiAgICAgICAgdmFyIHRvdGFsU2Vnc0JlbG93OyAvLyB0b3RhbCBudW1iZXIgb2Ygc2VnbWVudHMgYmVsb3cgYHNlZ2AgaW4gYW55IG9mIHRoZSBjb2x1bW5zIGBzZWdgIG9jY3VwaWVzDQogICAgICAgIHZhciBjb2xTZWdzQmVsb3c7IC8vIGFycmF5IG9mIHNlZ21lbnQgYXJyYXlzLCBiZWxvdyBzZWcsIG9uZSBmb3IgZWFjaCBjb2x1bW4gKG9mZnNldCBmcm9tIHNlZ3MncyBmaXJzdCBjb2x1bW4pDQogICAgICAgIHZhciB0ZDsNCiAgICAgICAgdmFyIHJvd3NwYW47DQogICAgICAgIHZhciBzZWdNb3JlTm9kZXM7IC8vIGFycmF5IG9mICJtb3JlIiA8dGQ+IGNlbGxzIHRoYXQgd2lsbCBzdGFuZC1pbiBmb3IgdGhlIGN1cnJlbnQgc2VnJ3MgY2VsbA0KICAgICAgICB2YXIgajsNCiAgICAgICAgdmFyIG1vcmVUZDsNCiAgICAgICAgdmFyIG1vcmVXcmFwOw0KICAgICAgICB2YXIgbW9yZUxpbms7DQogICAgICAgIC8vIEl0ZXJhdGVzIHRocm91Z2ggZW1wdHkgbGV2ZWwgY2VsbHMgYW5kIHBsYWNlcyAibW9yZSIgbGlua3MgaW5zaWRlIGlmIG5lZWQgYmUNCiAgICAgICAgdmFyIGVtcHR5Q2VsbHNVbnRpbCA9IGZ1bmN0aW9uIChlbmRDb2wpIHsNCiAgICAgICAgICAgIHdoaWxlIChjb2wgPCBlbmRDb2wpIHsNCiAgICAgICAgICAgICAgICBzZWdzQmVsb3cgPSBfdGhpcy5nZXRDZWxsU2Vncyhyb3csIGNvbCwgbGV2ZWxMaW1pdCk7DQogICAgICAgICAgICAgICAgaWYgKHNlZ3NCZWxvdy5sZW5ndGgpIHsNCiAgICAgICAgICAgICAgICAgICAgdGQgPSBjZWxsTWF0cml4W2xldmVsTGltaXQgLSAxXVtjb2xdOw0KICAgICAgICAgICAgICAgICAgICBtb3JlTGluayA9IF90aGlzLnJlbmRlck1vcmVMaW5rKHJvdywgY29sLCBzZWdzQmVsb3cpOw0KICAgICAgICAgICAgICAgICAgICBtb3JlV3JhcCA9ICQoJzxkaXYvPicpLmFwcGVuZChtb3JlTGluayk7DQogICAgICAgICAgICAgICAgICAgIHRkLmFwcGVuZChtb3JlV3JhcCk7DQogICAgICAgICAgICAgICAgICAgIG1vcmVOb2Rlcy5wdXNoKG1vcmVXcmFwWzBdKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgY29sKys7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIGlmIChsZXZlbExpbWl0ICYmIGxldmVsTGltaXQgPCByb3dTdHJ1Y3Quc2VnTGV2ZWxzLmxlbmd0aCkgew0KICAgICAgICAgICAgbGV2ZWxTZWdzID0gcm93U3RydWN0LnNlZ0xldmVsc1tsZXZlbExpbWl0IC0gMV07DQogICAgICAgICAgICBjZWxsTWF0cml4ID0gcm93U3RydWN0LmNlbGxNYXRyaXg7DQogICAgICAgICAgICBsaW1pdGVkTm9kZXMgPSByb3dTdHJ1Y3QudGJvZHlFbC5jaGlsZHJlbigpLnNsaWNlKGxldmVsTGltaXQpIC8vIGdldCBsZXZlbCA8dHI+IGVsZW1lbnRzIHBhc3QgdGhlIGxpbWl0DQogICAgICAgICAgICAgICAgLmFkZENsYXNzKCdmYy1saW1pdGVkJykuZ2V0KCk7IC8vIGhpZGUgZWxlbWVudHMgYW5kIGdldCBhIHNpbXBsZSBET00tbm9kZXMgYXJyYXkNCiAgICAgICAgICAgIC8vIGl0ZXJhdGUgdGhvdWdoIHNlZ21lbnRzIGluIHRoZSBsYXN0IGFsbG93YWJsZSBsZXZlbA0KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxldmVsU2Vncy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgIHNlZyA9IGxldmVsU2Vnc1tpXTsNCiAgICAgICAgICAgICAgICBlbXB0eUNlbGxzVW50aWwoc2VnLmxlZnRDb2wpOyAvLyBwcm9jZXNzIGVtcHR5IGNlbGxzIGJlZm9yZSB0aGUgc2VnbWVudA0KICAgICAgICAgICAgICAgIC8vIGRldGVybWluZSAqYWxsKiBzZWdtZW50cyBiZWxvdyBgc2VnYCB0aGF0IG9jY3VweSB0aGUgc2FtZSBjb2x1bW5zDQogICAgICAgICAgICAgICAgY29sU2Vnc0JlbG93ID0gW107DQogICAgICAgICAgICAgICAgdG90YWxTZWdzQmVsb3cgPSAwOw0KICAgICAgICAgICAgICAgIHdoaWxlIChjb2wgPD0gc2VnLnJpZ2h0Q29sKSB7DQogICAgICAgICAgICAgICAgICAgIHNlZ3NCZWxvdyA9IHRoaXMuZ2V0Q2VsbFNlZ3Mocm93LCBjb2wsIGxldmVsTGltaXQpOw0KICAgICAgICAgICAgICAgICAgICBjb2xTZWdzQmVsb3cucHVzaChzZWdzQmVsb3cpOw0KICAgICAgICAgICAgICAgICAgICB0b3RhbFNlZ3NCZWxvdyArPSBzZWdzQmVsb3cubGVuZ3RoOw0KICAgICAgICAgICAgICAgICAgICBjb2wrKzsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYgKHRvdGFsU2Vnc0JlbG93KSB7DQogICAgICAgICAgICAgICAgICAgIHRkID0gY2VsbE1hdHJpeFtsZXZlbExpbWl0IC0gMV1bc2VnLmxlZnRDb2xdOyAvLyB0aGUgc2VnbWVudCdzIHBhcmVudCBjZWxsDQogICAgICAgICAgICAgICAgICAgIHJvd3NwYW4gPSB0ZC5hdHRyKCdyb3dzcGFuJykgfHwgMTsNCiAgICAgICAgICAgICAgICAgICAgc2VnTW9yZU5vZGVzID0gW107DQogICAgICAgICAgICAgICAgICAgIC8vIG1ha2UgYSByZXBsYWNlbWVudCA8dGQ+IGZvciBlYWNoIGNvbHVtbiB0aGUgc2VnbWVudCBvY2N1cGllcy4gd2lsbCBiZSBvbmUgZm9yIGVhY2ggY29sc3Bhbg0KICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgY29sU2Vnc0JlbG93Lmxlbmd0aDsgaisrKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBtb3JlVGQgPSAkKCc8dGQgY2xhc3M9ImZjLW1vcmUtY2VsbCIvPicpLmF0dHIoJ3Jvd3NwYW4nLCByb3dzcGFuKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlZ3NCZWxvdyA9IGNvbFNlZ3NCZWxvd1tqXTsNCiAgICAgICAgICAgICAgICAgICAgICAgIG1vcmVMaW5rID0gdGhpcy5yZW5kZXJNb3JlTGluayhyb3csIHNlZy5sZWZ0Q29sICsgaiwgW3NlZ10uY29uY2F0KHNlZ3NCZWxvdykgLy8gY291bnQgc2VnIGFzIGhpZGRlbiB0b28NCiAgICAgICAgICAgICAgICAgICAgICAgICk7DQogICAgICAgICAgICAgICAgICAgICAgICBtb3JlV3JhcCA9ICQoJzxkaXYvPicpLmFwcGVuZChtb3JlTGluayk7DQogICAgICAgICAgICAgICAgICAgICAgICBtb3JlVGQuYXBwZW5kKG1vcmVXcmFwKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlZ01vcmVOb2Rlcy5wdXNoKG1vcmVUZFswXSk7DQogICAgICAgICAgICAgICAgICAgICAgICBtb3JlTm9kZXMucHVzaChtb3JlVGRbMF0pOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHRkLmFkZENsYXNzKCdmYy1saW1pdGVkJykuYWZ0ZXIoJChzZWdNb3JlTm9kZXMpKTsgLy8gaGlkZSBvcmlnaW5hbCA8dGQ+IGFuZCBpbmplY3QgcmVwbGFjZW1lbnRzDQogICAgICAgICAgICAgICAgICAgIGxpbWl0ZWROb2Rlcy5wdXNoKHRkWzBdKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbXB0eUNlbGxzVW50aWwodGhpcy5jb2xDbnQpOyAvLyBmaW5pc2ggb2ZmIHRoZSBsZXZlbA0KICAgICAgICAgICAgcm93U3RydWN0Lm1vcmVFbHMgPSAkKG1vcmVOb2Rlcyk7IC8vIGZvciBlYXN5IHVuZG9pbmcgbGF0ZXINCiAgICAgICAgICAgIHJvd1N0cnVjdC5saW1pdGVkRWxzID0gJChsaW1pdGVkTm9kZXMpOyAvLyBmb3IgZWFzeSB1bmRvaW5nIGxhdGVyDQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIFJldmVhbHMgYWxsIGxldmVscyBhbmQgcmVtb3ZlcyBhbGwgIm1vcmUiLXJlbGF0ZWQgZWxlbWVudHMgZm9yIGEgZ3JpZCdzIHJvdy4NCiAgICAvLyBgcm93YCBpcyBhIHJvdyBudW1iZXIuDQogICAgRGF5R3JpZC5wcm90b3R5cGUudW5saW1pdFJvdyA9IGZ1bmN0aW9uIChyb3cpIHsNCiAgICAgICAgdmFyIHJvd1N0cnVjdCA9IHRoaXMuZXZlbnRSZW5kZXJlci5yb3dTdHJ1Y3RzW3Jvd107DQogICAgICAgIGlmIChyb3dTdHJ1Y3QubW9yZUVscykgew0KICAgICAgICAgICAgcm93U3RydWN0Lm1vcmVFbHMucmVtb3ZlKCk7DQogICAgICAgICAgICByb3dTdHJ1Y3QubW9yZUVscyA9IG51bGw7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHJvd1N0cnVjdC5saW1pdGVkRWxzKSB7DQogICAgICAgICAgICByb3dTdHJ1Y3QubGltaXRlZEVscy5yZW1vdmVDbGFzcygnZmMtbGltaXRlZCcpOw0KICAgICAgICAgICAgcm93U3RydWN0LmxpbWl0ZWRFbHMgPSBudWxsOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBSZW5kZXJzIGFuIDxhPiBlbGVtZW50IHRoYXQgcmVwcmVzZW50cyBoaWRkZW4gZXZlbnQgZWxlbWVudCBmb3IgYSBjZWxsLg0KICAgIC8vIFJlc3BvbnNpYmxlIGZvciBhdHRhY2hpbmcgY2xpY2sgaGFuZGxlciBhcyB3ZWxsLg0KICAgIERheUdyaWQucHJvdG90eXBlLnJlbmRlck1vcmVMaW5rID0gZnVuY3Rpb24gKHJvdywgY29sLCBoaWRkZW5TZWdzKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIHZhciB2aWV3ID0gdGhpcy52aWV3Ow0KICAgICAgICByZXR1cm4gJCgnPGEgY2xhc3M9ImZjLW1vcmUiLz4nKQ0KICAgICAgICAgICAgLnRleHQodGhpcy5nZXRNb3JlTGlua1RleHQoaGlkZGVuU2Vncy5sZW5ndGgpKQ0KICAgICAgICAgICAgLm9uKCdjbGljaycsIGZ1bmN0aW9uIChldikgew0KICAgICAgICAgICAgdmFyIGNsaWNrT3B0aW9uID0gX3RoaXMub3B0KCdldmVudExpbWl0Q2xpY2snKTsNCiAgICAgICAgICAgIHZhciBkYXRlID0gX3RoaXMuZ2V0Q2VsbERhdGUocm93LCBjb2wpOw0KICAgICAgICAgICAgdmFyIG1vcmVFbCA9ICQoZXYuY3VycmVudFRhcmdldCk7DQogICAgICAgICAgICB2YXIgZGF5RWwgPSBfdGhpcy5nZXRDZWxsRWwocm93LCBjb2wpOw0KICAgICAgICAgICAgdmFyIGFsbFNlZ3MgPSBfdGhpcy5nZXRDZWxsU2Vncyhyb3csIGNvbCk7DQogICAgICAgICAgICAvLyByZXNjb3BlIHRoZSBzZWdtZW50cyB0byBiZSB3aXRoaW4gdGhlIGNlbGwncyBkYXRlDQogICAgICAgICAgICB2YXIgcmVzbGljZWRBbGxTZWdzID0gX3RoaXMucmVzbGljZURheVNlZ3MoYWxsU2VncywgZGF0ZSk7DQogICAgICAgICAgICB2YXIgcmVzbGljZWRIaWRkZW5TZWdzID0gX3RoaXMucmVzbGljZURheVNlZ3MoaGlkZGVuU2VncywgZGF0ZSk7DQogICAgICAgICAgICBpZiAodHlwZW9mIGNsaWNrT3B0aW9uID09PSAnZnVuY3Rpb24nKSB7DQogICAgICAgICAgICAgICAgLy8gdGhlIHJldHVybmVkIHZhbHVlIGNhbiBiZSBhbiBhdG9taWMgb3B0aW9uDQogICAgICAgICAgICAgICAgY2xpY2tPcHRpb24gPSBfdGhpcy5wdWJsaWNseVRyaWdnZXIoJ2V2ZW50TGltaXRDbGljaycsIHsNCiAgICAgICAgICAgICAgICAgICAgY29udGV4dDogdmlldywNCiAgICAgICAgICAgICAgICAgICAgYXJnczogWw0KICAgICAgICAgICAgICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGU6IGRhdGUuY2xvbmUoKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXlFbDogZGF5RWwsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9yZUVsOiBtb3JlRWwsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VnczogcmVzbGljZWRBbGxTZWdzLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhpZGRlblNlZ3M6IHJlc2xpY2VkSGlkZGVuU2Vncw0KICAgICAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICAgICAgICAgIGV2LA0KICAgICAgICAgICAgICAgICAgICAgICAgdmlldw0KICAgICAgICAgICAgICAgICAgICBdDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoY2xpY2tPcHRpb24gPT09ICdwb3BvdmVyJykgew0KICAgICAgICAgICAgICAgIF90aGlzLnNob3dTZWdQb3BvdmVyKHJvdywgY29sLCBtb3JlRWwsIHJlc2xpY2VkQWxsU2Vncyk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YgY2xpY2tPcHRpb24gPT09ICdzdHJpbmcnKSB7DQogICAgICAgICAgICAgICAgdmlldy5jYWxlbmRhci56b29tVG8oZGF0ZSwgY2xpY2tPcHRpb24pOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIC8vIFJldmVhbHMgdGhlIHBvcG92ZXIgdGhhdCBkaXNwbGF5cyBhbGwgZXZlbnRzIHdpdGhpbiBhIGNlbGwNCiAgICBEYXlHcmlkLnByb3RvdHlwZS5zaG93U2VnUG9wb3ZlciA9IGZ1bmN0aW9uIChyb3csIGNvbCwgbW9yZUxpbmssIHNlZ3MpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLnZpZXc7DQogICAgICAgIHZhciBtb3JlV3JhcCA9IG1vcmVMaW5rLnBhcmVudCgpOyAvLyB0aGUgPGRpdj4gd3JhcHBlciBhcm91bmQgdGhlIDxhPg0KICAgICAgICB2YXIgdG9wRWw7IC8vIHRoZSBlbGVtZW50IHdlIHdhbnQgdG8gbWF0Y2ggdGhlIHRvcCBjb29yZGluYXRlIG9mDQogICAgICAgIHZhciBvcHRpb25zOw0KICAgICAgICBpZiAodGhpcy5yb3dDbnQgPT09IDEpIHsNCiAgICAgICAgICAgIHRvcEVsID0gdmlldy5lbDsgLy8gd2lsbCBjYXVzZSB0aGUgcG9wb3ZlciB0byBjb3ZlciBhbnkgc29ydCBvZiBoZWFkZXINCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHRvcEVsID0gdGhpcy5yb3dFbHMuZXEocm93KTsgLy8gd2lsbCBhbGlnbiB3aXRoIHRvcCBvZiByb3cNCiAgICAgICAgfQ0KICAgICAgICBvcHRpb25zID0gew0KICAgICAgICAgICAgY2xhc3NOYW1lOiAnZmMtbW9yZS1wb3BvdmVyICcgKyB2aWV3LmNhbGVuZGFyLnRoZW1lLmdldENsYXNzKCdwb3BvdmVyJyksDQogICAgICAgICAgICBjb250ZW50OiB0aGlzLnJlbmRlclNlZ1BvcG92ZXJDb250ZW50KHJvdywgY29sLCBzZWdzKSwNCiAgICAgICAgICAgIHBhcmVudEVsOiB2aWV3LmVsLA0KICAgICAgICAgICAgdG9wOiB0b3BFbC5vZmZzZXQoKS50b3AsDQogICAgICAgICAgICBhdXRvSGlkZTogdHJ1ZSwNCiAgICAgICAgICAgIHZpZXdwb3J0Q29uc3RyYWluOiB0aGlzLm9wdCgncG9wb3ZlclZpZXdwb3J0Q29uc3RyYWluJyksDQogICAgICAgICAgICBoaWRlOiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgLy8ga2lsbCBldmVyeXRoaW5nIHdoZW4gdGhlIHBvcG92ZXIgaXMgaGlkZGVuDQogICAgICAgICAgICAgICAgLy8gbm90aWZ5IGV2ZW50cyB0byBiZSByZW1vdmVkDQogICAgICAgICAgICAgICAgaWYgKF90aGlzLnBvcG92ZXJTZWdzKSB7DQogICAgICAgICAgICAgICAgICAgIF90aGlzLnRyaWdnZXJCZWZvcmVFdmVudFNlZ3NEZXN0cm95ZWQoX3RoaXMucG9wb3ZlclNlZ3MpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBfdGhpcy5zZWdQb3BvdmVyLnJlbW92ZUVsZW1lbnQoKTsNCiAgICAgICAgICAgICAgICBfdGhpcy5zZWdQb3BvdmVyID0gbnVsbDsNCiAgICAgICAgICAgICAgICBfdGhpcy5wb3BvdmVyU2VncyA9IG51bGw7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIC8vIERldGVybWluZSBob3Jpem9udGFsIGNvb3JkaW5hdGUuDQogICAgICAgIC8vIFdlIHVzZSB0aGUgbW9yZVdyYXAgaW5zdGVhZCBvZiB0aGUgPHRkPiB0byBhdm9pZCBib3JkZXIgY29uZnVzaW9uLg0KICAgICAgICBpZiAodGhpcy5pc1JUTCkgew0KICAgICAgICAgICAgb3B0aW9ucy5yaWdodCA9IG1vcmVXcmFwLm9mZnNldCgpLmxlZnQgKyBtb3JlV3JhcC5vdXRlcldpZHRoKCkgKyAxOyAvLyArMSB0byBiZSBvdmVyIGNlbGwgYm9yZGVyDQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBvcHRpb25zLmxlZnQgPSBtb3JlV3JhcC5vZmZzZXQoKS5sZWZ0IC0gMTsgLy8gLTEgdG8gYmUgb3ZlciBjZWxsIGJvcmRlcg0KICAgICAgICB9DQogICAgICAgIHRoaXMuc2VnUG9wb3ZlciA9IG5ldyBQb3BvdmVyXzEuZGVmYXVsdChvcHRpb25zKTsNCiAgICAgICAgdGhpcy5zZWdQb3BvdmVyLnNob3coKTsNCiAgICAgICAgLy8gdGhlIHBvcG92ZXIgZG9lc24ndCBsaXZlIHdpdGhpbiB0aGUgZ3JpZCdzIGNvbnRhaW5lciBlbGVtZW50LCBhbmQgdGh1cyB3b24ndCBnZXQgdGhlIGV2ZW50DQogICAgICAgIC8vIGRlbGVnYXRlZC1oYW5kbGVycyBmb3IgZnJlZS4gYXR0YWNoIGV2ZW50LXJlbGF0ZWQgaGFuZGxlcnMgdG8gdGhlIHBvcG92ZXIuDQogICAgICAgIHRoaXMuYmluZEFsbFNlZ0hhbmRsZXJzVG9FbCh0aGlzLnNlZ1BvcG92ZXIuZWwpOw0KICAgICAgICB0aGlzLnRyaWdnZXJBZnRlckV2ZW50U2Vnc1JlbmRlcmVkKHNlZ3MpOw0KICAgIH07DQogICAgLy8gQnVpbGRzIHRoZSBpbm5lciBET00gY29udGVudHMgb2YgdGhlIHNlZ21lbnQgcG9wb3Zlcg0KICAgIERheUdyaWQucHJvdG90eXBlLnJlbmRlclNlZ1BvcG92ZXJDb250ZW50ID0gZnVuY3Rpb24gKHJvdywgY29sLCBzZWdzKSB7DQogICAgICAgIHZhciB2aWV3ID0gdGhpcy52aWV3Ow0KICAgICAgICB2YXIgdGhlbWUgPSB2aWV3LmNhbGVuZGFyLnRoZW1lOw0KICAgICAgICB2YXIgdGl0bGUgPSB0aGlzLmdldENlbGxEYXRlKHJvdywgY29sKS5mb3JtYXQodGhpcy5vcHQoJ2RheVBvcG92ZXJGb3JtYXQnKSk7DQogICAgICAgIHZhciBjb250ZW50ID0gJCgnPGRpdiBjbGFzcz0iZmMtaGVhZGVyICcgKyB0aGVtZS5nZXRDbGFzcygncG9wb3ZlckhlYWRlcicpICsgJyI+JyArDQogICAgICAgICAgICAnPHNwYW4gY2xhc3M9ImZjLWNsb3NlICcgKyB0aGVtZS5nZXRJY29uQ2xhc3MoJ2Nsb3NlJykgKyAnIj48L3NwYW4+JyArDQogICAgICAgICAgICAnPHNwYW4gY2xhc3M9ImZjLXRpdGxlIj4nICsNCiAgICAgICAgICAgIHV0aWxfMS5odG1sRXNjYXBlKHRpdGxlKSArDQogICAgICAgICAgICAnPC9zcGFuPicgKw0KICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImZjLWNsZWFyIi8+JyArDQogICAgICAgICAgICAnPC9kaXY+JyArDQogICAgICAgICAgICAnPGRpdiBjbGFzcz0iZmMtYm9keSAnICsgdGhlbWUuZ2V0Q2xhc3MoJ3BvcG92ZXJDb250ZW50JykgKyAnIj4nICsNCiAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJmYy1ldmVudC1jb250YWluZXIiPjwvZGl2PicgKw0KICAgICAgICAgICAgJzwvZGl2PicpOw0KICAgICAgICB2YXIgc2VnQ29udGFpbmVyID0gY29udGVudC5maW5kKCcuZmMtZXZlbnQtY29udGFpbmVyJyk7DQogICAgICAgIHZhciBpOw0KICAgICAgICAvLyByZW5kZXIgZWFjaCBzZWcncyBgZWxgIGFuZCBvbmx5IHJldHVybiB0aGUgdmlzaWJsZSBzZWdzDQogICAgICAgIHNlZ3MgPSB0aGlzLmV2ZW50UmVuZGVyZXIucmVuZGVyRmdTZWdFbHMoc2VncywgdHJ1ZSk7IC8vIGRpc2FibGVSZXNpemluZz10cnVlDQogICAgICAgIHRoaXMucG9wb3ZlclNlZ3MgPSBzZWdzOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2Vncy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgLy8gYmVjYXVzZSBzZWdtZW50cyBpbiB0aGUgcG9wb3ZlciBhcmUgbm90IHBhcnQgb2YgYSBncmlkIGNvb3JkaW5hdGUgc3lzdGVtLCBwcm92aWRlIGEgaGludCB0byBhbnkNCiAgICAgICAgICAgIC8vIGdyaWRzIHRoYXQgd2FudCB0byBkbyBkcmFnLW4tZHJvcCBhYm91dCB3aGljaCBjZWxsIGl0IGNhbWUgZnJvbQ0KICAgICAgICAgICAgdGhpcy5oaXRzTmVlZGVkKCk7DQogICAgICAgICAgICBzZWdzW2ldLmhpdCA9IHRoaXMuZ2V0Q2VsbEhpdChyb3csIGNvbCk7DQogICAgICAgICAgICB0aGlzLmhpdHNOb3ROZWVkZWQoKTsNCiAgICAgICAgICAgIHNlZ0NvbnRhaW5lci5hcHBlbmQoc2Vnc1tpXS5lbCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGNvbnRlbnQ7DQogICAgfTsNCiAgICAvLyBHaXZlbiB0aGUgZXZlbnRzIHdpdGhpbiBhbiBhcnJheSBvZiBzZWdtZW50IG9iamVjdHMsIHJlc2xpY2UgdGhlbSB0byBiZSBpbiBhIHNpbmdsZSBkYXkNCiAgICBEYXlHcmlkLnByb3RvdHlwZS5yZXNsaWNlRGF5U2VncyA9IGZ1bmN0aW9uIChzZWdzLCBkYXlEYXRlKSB7DQogICAgICAgIHZhciBkYXlTdGFydCA9IGRheURhdGUuY2xvbmUoKTsNCiAgICAgICAgdmFyIGRheUVuZCA9IGRheVN0YXJ0LmNsb25lKCkuYWRkKDEsICdkYXlzJyk7DQogICAgICAgIHZhciBkYXlSYW5nZSA9IG5ldyBVbnpvbmVkUmFuZ2VfMS5kZWZhdWx0KGRheVN0YXJ0LCBkYXlFbmQpOw0KICAgICAgICB2YXIgbmV3U2VncyA9IFtdOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgdmFyIHNlZzsNCiAgICAgICAgdmFyIHNsaWNlZFJhbmdlOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2Vncy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgc2VnID0gc2Vnc1tpXTsNCiAgICAgICAgICAgIHNsaWNlZFJhbmdlID0gc2VnLmZvb3RwcmludC5jb21wb25lbnRGb290cHJpbnQudW56b25lZFJhbmdlLmludGVyc2VjdChkYXlSYW5nZSk7DQogICAgICAgICAgICBpZiAoc2xpY2VkUmFuZ2UpIHsNCiAgICAgICAgICAgICAgICBuZXdTZWdzLnB1c2goJC5leHRlbmQoe30sIHNlZywgew0KICAgICAgICAgICAgICAgICAgICBmb290cHJpbnQ6IG5ldyBFdmVudEZvb3RwcmludF8xLmRlZmF1bHQobmV3IENvbXBvbmVudEZvb3RwcmludF8xLmRlZmF1bHQoc2xpY2VkUmFuZ2UsIHNlZy5mb290cHJpbnQuY29tcG9uZW50Rm9vdHByaW50LmlzQWxsRGF5KSwgc2VnLmZvb3RwcmludC5ldmVudERlZiwgc2VnLmZvb3RwcmludC5ldmVudEluc3RhbmNlKSwNCiAgICAgICAgICAgICAgICAgICAgaXNTdGFydDogc2VnLmlzU3RhcnQgJiYgc2xpY2VkUmFuZ2UuaXNTdGFydCwNCiAgICAgICAgICAgICAgICAgICAgaXNFbmQ6IHNlZy5pc0VuZCAmJiBzbGljZWRSYW5nZS5pc0VuZA0KICAgICAgICAgICAgICAgIH0pKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICAvLyBmb3JjZSBhbiBvcmRlciBiZWNhdXNlIGV2ZW50c1RvU2VncyBkb2Vzbid0IGd1YXJhbnRlZSBvbmUNCiAgICAgICAgLy8gVE9ETzogcmVzZWFyY2ggaWYgc3RpbGwgbmVlZGVkDQogICAgICAgIHRoaXMuZXZlbnRSZW5kZXJlci5zb3J0RXZlbnRTZWdzKG5ld1NlZ3MpOw0KICAgICAgICByZXR1cm4gbmV3U2VnczsNCiAgICB9Ow0KICAgIC8vIEdlbmVyYXRlcyB0aGUgdGV4dCB0aGF0IHNob3VsZCBiZSBpbnNpZGUgYSAibW9yZSIgbGluaywgZ2l2ZW4gdGhlIG51bWJlciBvZiBldmVudHMgaXQgcmVwcmVzZW50cw0KICAgIERheUdyaWQucHJvdG90eXBlLmdldE1vcmVMaW5rVGV4dCA9IGZ1bmN0aW9uIChudW0pIHsNCiAgICAgICAgdmFyIG9wdCA9IHRoaXMub3B0KCdldmVudExpbWl0VGV4dCcpOw0KICAgICAgICBpZiAodHlwZW9mIG9wdCA9PT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICAgICAgcmV0dXJuIG9wdChudW0pOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuICcrJyArIG51bSArICcgJyArIG9wdDsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gUmV0dXJucyBzZWdtZW50cyB3aXRoaW4gYSBnaXZlbiBjZWxsLg0KICAgIC8vIElmIGBzdGFydExldmVsYCBpcyBzcGVjaWZpZWQsIHJldHVybnMgb25seSBldmVudHMgaW5jbHVkaW5nIGFuZCBiZWxvdyB0aGF0IGxldmVsLiBPdGhlcndpc2UgcmV0dXJucyBhbGwgc2Vncy4NCiAgICBEYXlHcmlkLnByb3RvdHlwZS5nZXRDZWxsU2VncyA9IGZ1bmN0aW9uIChyb3csIGNvbCwgc3RhcnRMZXZlbCkgew0KICAgICAgICB2YXIgc2VnTWF0cml4ID0gdGhpcy5ldmVudFJlbmRlcmVyLnJvd1N0cnVjdHNbcm93XS5zZWdNYXRyaXg7DQogICAgICAgIHZhciBsZXZlbCA9IHN0YXJ0TGV2ZWwgfHwgMDsNCiAgICAgICAgdmFyIHNlZ3MgPSBbXTsNCiAgICAgICAgdmFyIHNlZzsNCiAgICAgICAgd2hpbGUgKGxldmVsIDwgc2VnTWF0cml4Lmxlbmd0aCkgew0KICAgICAgICAgICAgc2VnID0gc2VnTWF0cml4W2xldmVsXVtjb2xdOw0KICAgICAgICAgICAgaWYgKHNlZykgew0KICAgICAgICAgICAgICAgIHNlZ3MucHVzaChzZWcpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgbGV2ZWwrKzsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gc2VnczsNCiAgICB9Ow0KICAgIHJldHVybiBEYXlHcmlkOw0KfShJbnRlcmFjdGl2ZURhdGVDb21wb25lbnRfMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBEYXlHcmlkOw0KRGF5R3JpZC5wcm90b3R5cGUuZXZlbnRSZW5kZXJlckNsYXNzID0gRGF5R3JpZEV2ZW50UmVuZGVyZXJfMS5kZWZhdWx0Ow0KRGF5R3JpZC5wcm90b3R5cGUuYnVzaW5lc3NIb3VyUmVuZGVyZXJDbGFzcyA9IEJ1c2luZXNzSG91clJlbmRlcmVyXzEuZGVmYXVsdDsNCkRheUdyaWQucHJvdG90eXBlLmhlbHBlclJlbmRlcmVyQ2xhc3MgPSBEYXlHcmlkSGVscGVyUmVuZGVyZXJfMS5kZWZhdWx0Ow0KRGF5R3JpZC5wcm90b3R5cGUuZmlsbFJlbmRlcmVyQ2xhc3MgPSBEYXlHcmlkRmlsbFJlbmRlcmVyXzEuZGVmYXVsdDsNClN0YW5kYXJkSW50ZXJhY3Rpb25zTWl4aW5fMS5kZWZhdWx0Lm1peEludG8oRGF5R3JpZCk7DQpEYXlUYWJsZU1peGluXzEuZGVmYXVsdC5taXhJbnRvKERheUdyaWQpOw0KCgovKioqLyB9KSwKLyogNjIgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCnZhciB1dGlsXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQpOw0KdmFyIFNjcm9sbGVyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM5KTsNCnZhciBWaWV3XzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQxKTsNCnZhciBCYXNpY1ZpZXdEYXRlUHJvZmlsZUdlbmVyYXRvcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMjgpOw0KdmFyIERheUdyaWRfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNjEpOw0KLyogQW4gYWJzdHJhY3QgY2xhc3MgZm9yIHRoZSAiYmFzaWMiIHZpZXdzLCBhcyB3ZWxsIGFzIG1vbnRoIHZpZXcuIFJlbmRlcnMgb25lIG9yIG1vcmUgcm93cyBvZiBkYXkgY2VsbHMuDQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCi8vIEl0IGlzIGEgbWFuYWdlciBmb3IgYSBEYXlHcmlkIHN1YmNvbXBvbmVudCwgd2hpY2ggZG9lcyBtb3N0IG9mIHRoZSBoZWF2eSBsaWZ0aW5nLg0KLy8gSXQgaXMgcmVzcG9uc2libGUgZm9yIG1hbmFnaW5nIHdpZHRoL2hlaWdodC4NCnZhciBCYXNpY1ZpZXcgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoQmFzaWNWaWV3LCBfc3VwZXIpOw0KICAgIGZ1bmN0aW9uIEJhc2ljVmlldyhjYWxlbmRhciwgdmlld1NwZWMpIHsNCiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgY2FsZW5kYXIsIHZpZXdTcGVjKSB8fCB0aGlzOw0KICAgICAgICBfdGhpcy5kYXlHcmlkID0gX3RoaXMuaW5zdGFudGlhdGVEYXlHcmlkKCk7DQogICAgICAgIF90aGlzLmRheUdyaWQuaXNSaWdpZCA9IF90aGlzLmhhc1JpZ2lkUm93cygpOw0KICAgICAgICBpZiAoX3RoaXMub3B0KCd3ZWVrTnVtYmVycycpKSB7DQogICAgICAgICAgICBpZiAoX3RoaXMub3B0KCd3ZWVrTnVtYmVyc1dpdGhpbkRheXMnKSkgew0KICAgICAgICAgICAgICAgIF90aGlzLmRheUdyaWQuY2VsbFdlZWtOdW1iZXJzVmlzaWJsZSA9IHRydWU7DQogICAgICAgICAgICAgICAgX3RoaXMuZGF5R3JpZC5jb2xXZWVrTnVtYmVyc1Zpc2libGUgPSBmYWxzZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIF90aGlzLmRheUdyaWQuY2VsbFdlZWtOdW1iZXJzVmlzaWJsZSA9IGZhbHNlOw0KICAgICAgICAgICAgICAgIF90aGlzLmRheUdyaWQuY29sV2Vla051bWJlcnNWaXNpYmxlID0gdHJ1ZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBfdGhpcy5hZGRDaGlsZChfdGhpcy5kYXlHcmlkKTsNCiAgICAgICAgX3RoaXMuc2Nyb2xsZXIgPSBuZXcgU2Nyb2xsZXJfMS5kZWZhdWx0KHsNCiAgICAgICAgICAgIG92ZXJmbG93WDogJ2hpZGRlbicsDQogICAgICAgICAgICBvdmVyZmxvd1k6ICdhdXRvJw0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuIF90aGlzOw0KICAgIH0NCiAgICAvLyBHZW5lcmF0ZXMgdGhlIERheUdyaWQgb2JqZWN0IHRoaXMgdmlldyBuZWVkcy4gRHJhd3MgZnJvbSB0aGlzLmRheUdyaWRDbGFzcw0KICAgIEJhc2ljVmlldy5wcm90b3R5cGUuaW5zdGFudGlhdGVEYXlHcmlkID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAvLyBnZW5lcmF0ZSBhIHN1YmNsYXNzIG9uIHRoZSBmbHkgd2l0aCBCYXNpY1ZpZXctc3BlY2lmaWMgYmVoYXZpb3INCiAgICAgICAgLy8gVE9ETzogY2FjaGUgdGhpcyBzdWJjbGFzcw0KICAgICAgICB2YXIgc3ViY2xhc3MgPSBtYWtlRGF5R3JpZFN1YmNsYXNzKHRoaXMuZGF5R3JpZENsYXNzKTsNCiAgICAgICAgcmV0dXJuIG5ldyBzdWJjbGFzcyh0aGlzKTsNCiAgICB9Ow0KICAgIEJhc2ljVmlldy5wcm90b3R5cGUuZXhlY3V0ZURhdGVSZW5kZXIgPSBmdW5jdGlvbiAoZGF0ZVByb2ZpbGUpIHsNCiAgICAgICAgdGhpcy5kYXlHcmlkLmJyZWFrT25XZWVrcyA9IC95ZWFyfG1vbnRofHdlZWsvLnRlc3QoZGF0ZVByb2ZpbGUuY3VycmVudFJhbmdlVW5pdCk7DQogICAgICAgIF9zdXBlci5wcm90b3R5cGUuZXhlY3V0ZURhdGVSZW5kZXIuY2FsbCh0aGlzLCBkYXRlUHJvZmlsZSk7DQogICAgfTsNCiAgICBCYXNpY1ZpZXcucHJvdG90eXBlLnJlbmRlclNrZWxldG9uID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgZGF5R3JpZENvbnRhaW5lckVsOw0KICAgICAgICB2YXIgZGF5R3JpZEVsOw0KICAgICAgICB0aGlzLmVsLmFkZENsYXNzKCdmYy1iYXNpYy12aWV3JykuaHRtbCh0aGlzLnJlbmRlclNrZWxldG9uSHRtbCgpKTsNCiAgICAgICAgdGhpcy5zY3JvbGxlci5yZW5kZXIoKTsNCiAgICAgICAgZGF5R3JpZENvbnRhaW5lckVsID0gdGhpcy5zY3JvbGxlci5lbC5hZGRDbGFzcygnZmMtZGF5LWdyaWQtY29udGFpbmVyJyk7DQogICAgICAgIGRheUdyaWRFbCA9ICQoJzxkaXYgY2xhc3M9ImZjLWRheS1ncmlkIiAvPicpLmFwcGVuZFRvKGRheUdyaWRDb250YWluZXJFbCk7DQogICAgICAgIHRoaXMuZWwuZmluZCgnLmZjLWJvZHkgPiB0ciA+IHRkJykuYXBwZW5kKGRheUdyaWRDb250YWluZXJFbCk7DQogICAgICAgIHRoaXMuZGF5R3JpZC5oZWFkQ29udGFpbmVyRWwgPSB0aGlzLmVsLmZpbmQoJy5mYy1oZWFkLWNvbnRhaW5lcicpOw0KICAgICAgICB0aGlzLmRheUdyaWQuc2V0RWxlbWVudChkYXlHcmlkRWwpOw0KICAgIH07DQogICAgQmFzaWNWaWV3LnByb3RvdHlwZS51bnJlbmRlclNrZWxldG9uID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLmRheUdyaWQucmVtb3ZlRWxlbWVudCgpOw0KICAgICAgICB0aGlzLnNjcm9sbGVyLmRlc3Ryb3koKTsNCiAgICB9Ow0KICAgIC8vIEJ1aWxkcyB0aGUgSFRNTCBza2VsZXRvbiBmb3IgdGhlIHZpZXcuDQogICAgLy8gVGhlIGRheS1ncmlkIGNvbXBvbmVudCB3aWxsIHJlbmRlciBpbnNpZGUgb2YgYSBjb250YWluZXIgZGVmaW5lZCBieSB0aGlzIEhUTUwuDQogICAgQmFzaWNWaWV3LnByb3RvdHlwZS5yZW5kZXJTa2VsZXRvbkh0bWwgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciB0aGVtZSA9IHRoaXMuY2FsZW5kYXIudGhlbWU7DQogICAgICAgIHJldHVybiAnJyArDQogICAgICAgICAgICAnPHRhYmxlIGNsYXNzPSInICsgdGhlbWUuZ2V0Q2xhc3MoJ3RhYmxlR3JpZCcpICsgJyI+JyArDQogICAgICAgICAgICAodGhpcy5vcHQoJ2NvbHVtbkhlYWRlcicpID8NCiAgICAgICAgICAgICAgICAnPHRoZWFkIGNsYXNzPSJmYy1oZWFkIj4nICsNCiAgICAgICAgICAgICAgICAgICAgJzx0cj4nICsNCiAgICAgICAgICAgICAgICAgICAgJzx0ZCBjbGFzcz0iZmMtaGVhZC1jb250YWluZXIgJyArIHRoZW1lLmdldENsYXNzKCd3aWRnZXRIZWFkZXInKSArICciPiZuYnNwOzwvdGQ+JyArDQogICAgICAgICAgICAgICAgICAgICc8L3RyPicgKw0KICAgICAgICAgICAgICAgICAgICAnPC90aGVhZD4nIDoNCiAgICAgICAgICAgICAgICAnJykgKw0KICAgICAgICAgICAgJzx0Ym9keSBjbGFzcz0iZmMtYm9keSI+JyArDQogICAgICAgICAgICAnPHRyPicgKw0KICAgICAgICAgICAgJzx0ZCBjbGFzcz0iJyArIHRoZW1lLmdldENsYXNzKCd3aWRnZXRDb250ZW50JykgKyAnIj48L3RkPicgKw0KICAgICAgICAgICAgJzwvdHI+JyArDQogICAgICAgICAgICAnPC90Ym9keT4nICsNCiAgICAgICAgICAgICc8L3RhYmxlPic7DQogICAgfTsNCiAgICAvLyBHZW5lcmF0ZXMgYW4gSFRNTCBhdHRyaWJ1dGUgc3RyaW5nIGZvciBzZXR0aW5nIHRoZSB3aWR0aCBvZiB0aGUgd2VlayBudW1iZXIgY29sdW1uLCBpZiBpdCBpcyBrbm93bg0KICAgIEJhc2ljVmlldy5wcm90b3R5cGUud2Vla051bWJlclN0eWxlQXR0ciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMud2Vla051bWJlcldpZHRoICE9IG51bGwpIHsNCiAgICAgICAgICAgIHJldHVybiAnc3R5bGU9IndpZHRoOicgKyB0aGlzLndlZWtOdW1iZXJXaWR0aCArICdweCInOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiAnJzsNCiAgICB9Ow0KICAgIC8vIERldGVybWluZXMgd2hldGhlciBlYWNoIHJvdyBzaG91bGQgaGF2ZSBhIGNvbnN0YW50IGhlaWdodA0KICAgIEJhc2ljVmlldy5wcm90b3R5cGUuaGFzUmlnaWRSb3dzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgZXZlbnRMaW1pdCA9IHRoaXMub3B0KCdldmVudExpbWl0Jyk7DQogICAgICAgIHJldHVybiBldmVudExpbWl0ICYmIHR5cGVvZiBldmVudExpbWl0ICE9PSAnbnVtYmVyJzsNCiAgICB9Ow0KICAgIC8qIERpbWVuc2lvbnMNCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KICAgIC8vIFJlZnJlc2hlcyB0aGUgaG9yaXpvbnRhbCBkaW1lbnNpb25zIG9mIHRoZSB2aWV3DQogICAgQmFzaWNWaWV3LnByb3RvdHlwZS51cGRhdGVTaXplID0gZnVuY3Rpb24gKHRvdGFsSGVpZ2h0LCBpc0F1dG8sIGlzUmVzaXplKSB7DQogICAgICAgIHZhciBldmVudExpbWl0ID0gdGhpcy5vcHQoJ2V2ZW50TGltaXQnKTsNCiAgICAgICAgdmFyIGhlYWRSb3dFbCA9IHRoaXMuZGF5R3JpZC5oZWFkQ29udGFpbmVyRWwuZmluZCgnLmZjLXJvdycpOw0KICAgICAgICB2YXIgc2Nyb2xsZXJIZWlnaHQ7DQogICAgICAgIHZhciBzY3JvbGxiYXJXaWR0aHM7DQogICAgICAgIC8vIGhhY2sgdG8gZ2l2ZSB0aGUgdmlldyBzb21lIGhlaWdodCBwcmlvciB0byBkYXlHcmlkJ3MgY29sdW1ucyBiZWluZyByZW5kZXJlZA0KICAgICAgICAvLyBUT0RPOiBzZXBhcmF0ZSBzZXR0aW5nIGhlaWdodCBmcm9tIHNjcm9sbGVyIFZTIGRheUdyaWQuDQogICAgICAgIGlmICghdGhpcy5kYXlHcmlkLnJvd0Vscykgew0KICAgICAgICAgICAgaWYgKCFpc0F1dG8pIHsNCiAgICAgICAgICAgICAgICBzY3JvbGxlckhlaWdodCA9IHRoaXMuY29tcHV0ZVNjcm9sbGVySGVpZ2h0KHRvdGFsSGVpZ2h0KTsNCiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbGVyLnNldEhlaWdodChzY3JvbGxlckhlaWdodCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgX3N1cGVyLnByb3RvdHlwZS51cGRhdGVTaXplLmNhbGwodGhpcywgdG90YWxIZWlnaHQsIGlzQXV0bywgaXNSZXNpemUpOw0KICAgICAgICBpZiAodGhpcy5kYXlHcmlkLmNvbFdlZWtOdW1iZXJzVmlzaWJsZSkgew0KICAgICAgICAgICAgLy8gTWFrZSBzdXJlIGFsbCB3ZWVrIG51bWJlciBjZWxscyBydW5uaW5nIGRvd24gdGhlIHNpZGUgaGF2ZSB0aGUgc2FtZSB3aWR0aC4NCiAgICAgICAgICAgIC8vIFJlY29yZCB0aGUgd2lkdGggZm9yIGNlbGxzIGNyZWF0ZWQgbGF0ZXIuDQogICAgICAgICAgICB0aGlzLndlZWtOdW1iZXJXaWR0aCA9IHV0aWxfMS5tYXRjaENlbGxXaWR0aHModGhpcy5lbC5maW5kKCcuZmMtd2Vlay1udW1iZXInKSk7DQogICAgICAgIH0NCiAgICAgICAgLy8gcmVzZXQgYWxsIGhlaWdodHMgdG8gYmUgbmF0dXJhbA0KICAgICAgICB0aGlzLnNjcm9sbGVyLmNsZWFyKCk7DQogICAgICAgIHV0aWxfMS51bmNvbXBlbnNhdGVTY3JvbGwoaGVhZFJvd0VsKTsNCiAgICAgICAgdGhpcy5kYXlHcmlkLnJlbW92ZVNlZ1BvcG92ZXIoKTsgLy8ga2lsbCB0aGUgIm1vcmUiIHBvcG92ZXIgaWYgZGlzcGxheWVkDQogICAgICAgIC8vIGlzIHRoZSBldmVudCBsaW1pdCBhIGNvbnN0YW50IGxldmVsIG51bWJlcj8NCiAgICAgICAgaWYgKGV2ZW50TGltaXQgJiYgdHlwZW9mIGV2ZW50TGltaXQgPT09ICdudW1iZXInKSB7DQogICAgICAgICAgICB0aGlzLmRheUdyaWQubGltaXRSb3dzKGV2ZW50TGltaXQpOyAvLyBsaW1pdCB0aGUgbGV2ZWxzIGZpcnN0IHNvIHRoZSBoZWlnaHQgY2FuIHJlZGlzdHJpYnV0ZSBhZnRlcg0KICAgICAgICB9DQogICAgICAgIC8vIGRpc3RyaWJ1dGUgdGhlIGhlaWdodCB0byB0aGUgcm93cw0KICAgICAgICAvLyAodG90YWxIZWlnaHQgaXMgYSAicmVjb21tZW5kZWQiIHZhbHVlIGlmIGlzQXV0bykNCiAgICAgICAgc2Nyb2xsZXJIZWlnaHQgPSB0aGlzLmNvbXB1dGVTY3JvbGxlckhlaWdodCh0b3RhbEhlaWdodCk7DQogICAgICAgIHRoaXMuc2V0R3JpZEhlaWdodChzY3JvbGxlckhlaWdodCwgaXNBdXRvKTsNCiAgICAgICAgLy8gaXMgdGhlIGV2ZW50IGxpbWl0IGR5bmFtaWNhbGx5IGNhbGN1bGF0ZWQ/DQogICAgICAgIGlmIChldmVudExpbWl0ICYmIHR5cGVvZiBldmVudExpbWl0ICE9PSAnbnVtYmVyJykgew0KICAgICAgICAgICAgdGhpcy5kYXlHcmlkLmxpbWl0Um93cyhldmVudExpbWl0KTsgLy8gbGltaXQgdGhlIGxldmVscyBhZnRlciB0aGUgZ3JpZCdzIHJvdyBoZWlnaHRzIGhhdmUgYmVlbiBzZXQNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIWlzQXV0bykgew0KICAgICAgICAgICAgdGhpcy5zY3JvbGxlci5zZXRIZWlnaHQoc2Nyb2xsZXJIZWlnaHQpOw0KICAgICAgICAgICAgc2Nyb2xsYmFyV2lkdGhzID0gdGhpcy5zY3JvbGxlci5nZXRTY3JvbGxiYXJXaWR0aHMoKTsNCiAgICAgICAgICAgIGlmIChzY3JvbGxiYXJXaWR0aHMubGVmdCB8fCBzY3JvbGxiYXJXaWR0aHMucmlnaHQpIHsNCiAgICAgICAgICAgICAgICB1dGlsXzEuY29tcGVuc2F0ZVNjcm9sbChoZWFkUm93RWwsIHNjcm9sbGJhcldpZHRocyk7DQogICAgICAgICAgICAgICAgLy8gZG9pbmcgdGhlIHNjcm9sbGJhciBjb21wZW5zYXRpb24gbWlnaHQgaGF2ZSBjcmVhdGVkIHRleHQgb3ZlcmZsb3cgd2hpY2ggY3JlYXRlZCBtb3JlIGhlaWdodC4gcmVkbw0KICAgICAgICAgICAgICAgIHNjcm9sbGVySGVpZ2h0ID0gdGhpcy5jb21wdXRlU2Nyb2xsZXJIZWlnaHQodG90YWxIZWlnaHQpOw0KICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsZXIuc2V0SGVpZ2h0KHNjcm9sbGVySGVpZ2h0KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIC8vIGd1YXJhbnRlZXMgdGhlIHNhbWUgc2Nyb2xsYmFyIHdpZHRocw0KICAgICAgICAgICAgdGhpcy5zY3JvbGxlci5sb2NrT3ZlcmZsb3coc2Nyb2xsYmFyV2lkdGhzKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gZ2l2ZW4gYSBkZXNpcmVkIHRvdGFsIGhlaWdodCBvZiB0aGUgdmlldywgcmV0dXJucyB3aGF0IHRoZSBoZWlnaHQgb2YgdGhlIHNjcm9sbGVyIHNob3VsZCBiZQ0KICAgIEJhc2ljVmlldy5wcm90b3R5cGUuY29tcHV0ZVNjcm9sbGVySGVpZ2h0ID0gZnVuY3Rpb24gKHRvdGFsSGVpZ2h0KSB7DQogICAgICAgIHJldHVybiB0b3RhbEhlaWdodCAtDQogICAgICAgICAgICB1dGlsXzEuc3VidHJhY3RJbm5lckVsSGVpZ2h0KHRoaXMuZWwsIHRoaXMuc2Nyb2xsZXIuZWwpOyAvLyBldmVyeXRoaW5nIHRoYXQncyBOT1QgdGhlIHNjcm9sbGVyDQogICAgfTsNCiAgICAvLyBTZXRzIHRoZSBoZWlnaHQgb2YganVzdCB0aGUgRGF5R3JpZCBjb21wb25lbnQgaW4gdGhpcyB2aWV3DQogICAgQmFzaWNWaWV3LnByb3RvdHlwZS5zZXRHcmlkSGVpZ2h0ID0gZnVuY3Rpb24gKGhlaWdodCwgaXNBdXRvKSB7DQogICAgICAgIGlmIChpc0F1dG8pIHsNCiAgICAgICAgICAgIHV0aWxfMS51bmRpc3RyaWJ1dGVIZWlnaHQodGhpcy5kYXlHcmlkLnJvd0Vscyk7IC8vIGxldCB0aGUgcm93cyBiZSB0aGVpciBuYXR1cmFsIGhlaWdodCB3aXRoIG5vIGV4cGFuZGluZw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgdXRpbF8xLmRpc3RyaWJ1dGVIZWlnaHQodGhpcy5kYXlHcmlkLnJvd0VscywgaGVpZ2h0LCB0cnVlKTsgLy8gdHJ1ZSA9IGNvbXBlbnNhdGUgZm9yIGhlaWdodC1ob2dnaW5nIHJvd3MNCiAgICAgICAgfQ0KICAgIH07DQogICAgLyogU2Nyb2xsDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICBCYXNpY1ZpZXcucHJvdG90eXBlLmNvbXB1dGVJbml0aWFsRGF0ZVNjcm9sbCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHsgdG9wOiAwIH07DQogICAgfTsNCiAgICBCYXNpY1ZpZXcucHJvdG90eXBlLnF1ZXJ5RGF0ZVNjcm9sbCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHsgdG9wOiB0aGlzLnNjcm9sbGVyLmdldFNjcm9sbFRvcCgpIH07DQogICAgfTsNCiAgICBCYXNpY1ZpZXcucHJvdG90eXBlLmFwcGx5RGF0ZVNjcm9sbCA9IGZ1bmN0aW9uIChzY3JvbGwpIHsNCiAgICAgICAgaWYgKHNjcm9sbC50b3AgIT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgdGhpcy5zY3JvbGxlci5zZXRTY3JvbGxUb3Aoc2Nyb2xsLnRvcCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIHJldHVybiBCYXNpY1ZpZXc7DQp9KFZpZXdfMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBCYXNpY1ZpZXc7DQpCYXNpY1ZpZXcucHJvdG90eXBlLmRhdGVQcm9maWxlR2VuZXJhdG9yQ2xhc3MgPSBCYXNpY1ZpZXdEYXRlUHJvZmlsZUdlbmVyYXRvcl8xLmRlZmF1bHQ7DQpCYXNpY1ZpZXcucHJvdG90eXBlLmRheUdyaWRDbGFzcyA9IERheUdyaWRfMS5kZWZhdWx0Ow0KLy8gY3VzdG9taXplIHRoZSByZW5kZXJpbmcgYmVoYXZpb3Igb2YgQmFzaWNWaWV3J3MgZGF5R3JpZA0KZnVuY3Rpb24gbWFrZURheUdyaWRTdWJjbGFzcyhTdXBlckNsYXNzKSB7DQogICAgcmV0dXJuIC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHsNCiAgICAgICAgdHNsaWJfMS5fX2V4dGVuZHMoU3ViQ2xhc3MsIF9zdXBlcik7DQogICAgICAgIGZ1bmN0aW9uIFN1YkNsYXNzKCkgew0KICAgICAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyICE9PSBudWxsICYmIF9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7DQogICAgICAgICAgICBfdGhpcy5jb2xXZWVrTnVtYmVyc1Zpc2libGUgPSBmYWxzZTsgLy8gZGlzcGxheSB3ZWVrIG51bWJlcnMgYWxvbmcgdGhlIHNpZGU/DQogICAgICAgICAgICByZXR1cm4gX3RoaXM7DQogICAgICAgIH0NCiAgICAgICAgLy8gR2VuZXJhdGVzIHRoZSBIVE1MIHRoYXQgd2lsbCBnbyBiZWZvcmUgdGhlIGRheS1vZiB3ZWVrIGhlYWRlciBjZWxscw0KICAgICAgICBTdWJDbGFzcy5wcm90b3R5cGUucmVuZGVySGVhZEludHJvSHRtbCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHZhciB2aWV3ID0gdGhpcy52aWV3Ow0KICAgICAgICAgICAgaWYgKHRoaXMuY29sV2Vla051bWJlcnNWaXNpYmxlKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuICcnICsNCiAgICAgICAgICAgICAgICAgICAgJzx0aCBjbGFzcz0iZmMtd2Vlay1udW1iZXIgJyArIHZpZXcuY2FsZW5kYXIudGhlbWUuZ2V0Q2xhc3MoJ3dpZGdldEhlYWRlcicpICsgJyIgJyArIHZpZXcud2Vla051bWJlclN0eWxlQXR0cigpICsgJz4nICsNCiAgICAgICAgICAgICAgICAgICAgJzxzcGFuPicgKyAvLyBuZWVkZWQgZm9yIG1hdGNoQ2VsbFdpZHRocw0KICAgICAgICAgICAgICAgICAgICB1dGlsXzEuaHRtbEVzY2FwZSh0aGlzLm9wdCgnd2Vla051bWJlclRpdGxlJykpICsNCiAgICAgICAgICAgICAgICAgICAgJzwvc3Bhbj4nICsNCiAgICAgICAgICAgICAgICAgICAgJzwvdGg+JzsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHJldHVybiAnJzsNCiAgICAgICAgfTsNCiAgICAgICAgLy8gR2VuZXJhdGVzIHRoZSBIVE1MIHRoYXQgd2lsbCBnbyBiZWZvcmUgY29udGVudC1za2VsZXRvbiBjZWxscyB0aGF0IGRpc3BsYXkgdGhlIGRheS93ZWVrIG51bWJlcnMNCiAgICAgICAgU3ViQ2xhc3MucHJvdG90eXBlLnJlbmRlck51bWJlckludHJvSHRtbCA9IGZ1bmN0aW9uIChyb3cpIHsNCiAgICAgICAgICAgIHZhciB2aWV3ID0gdGhpcy52aWV3Ow0KICAgICAgICAgICAgdmFyIHdlZWtTdGFydCA9IHRoaXMuZ2V0Q2VsbERhdGUocm93LCAwKTsNCiAgICAgICAgICAgIGlmICh0aGlzLmNvbFdlZWtOdW1iZXJzVmlzaWJsZSkgew0KICAgICAgICAgICAgICAgIHJldHVybiAnJyArDQogICAgICAgICAgICAgICAgICAgICc8dGQgY2xhc3M9ImZjLXdlZWstbnVtYmVyIiAnICsgdmlldy53ZWVrTnVtYmVyU3R5bGVBdHRyKCkgKyAnPicgKw0KICAgICAgICAgICAgICAgICAgICB2aWV3LmJ1aWxkR290b0FuY2hvckh0bWwoLy8gYXNpZGUgZnJvbSBsaW5rLCBpbXBvcnRhbnQgZm9yIG1hdGNoQ2VsbFdpZHRocw0KICAgICAgICAgICAgICAgICAgICB7IGRhdGU6IHdlZWtTdGFydCwgdHlwZTogJ3dlZWsnLCBmb3JjZU9mZjogdGhpcy5jb2xDbnQgPT09IDEgfSwgd2Vla1N0YXJ0LmZvcm1hdCgndycpIC8vIGlubmVyIEhUTUwNCiAgICAgICAgICAgICAgICAgICAgKSArDQogICAgICAgICAgICAgICAgICAgICc8L3RkPic7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gJyc7DQogICAgICAgIH07DQogICAgICAgIC8vIEdlbmVyYXRlcyB0aGUgSFRNTCB0aGF0IGdvZXMgYmVmb3JlIHRoZSBkYXkgYmcgY2VsbHMgZm9yIGVhY2ggZGF5LXJvdw0KICAgICAgICBTdWJDbGFzcy5wcm90b3R5cGUucmVuZGVyQmdJbnRyb0h0bWwgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICB2YXIgdmlldyA9IHRoaXMudmlldzsNCiAgICAgICAgICAgIGlmICh0aGlzLmNvbFdlZWtOdW1iZXJzVmlzaWJsZSkgew0KICAgICAgICAgICAgICAgIHJldHVybiAnPHRkIGNsYXNzPSJmYy13ZWVrLW51bWJlciAnICsgdmlldy5jYWxlbmRhci50aGVtZS5nZXRDbGFzcygnd2lkZ2V0Q29udGVudCcpICsgJyIgJyArDQogICAgICAgICAgICAgICAgICAgIHZpZXcud2Vla051bWJlclN0eWxlQXR0cigpICsgJz48L3RkPic7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gJyc7DQogICAgICAgIH07DQogICAgICAgIC8vIEdlbmVyYXRlcyB0aGUgSFRNTCB0aGF0IGdvZXMgYmVmb3JlIGV2ZXJ5IG90aGVyIHR5cGUgb2Ygcm93IGdlbmVyYXRlZCBieSBEYXlHcmlkLg0KICAgICAgICAvLyBBZmZlY3RzIGhlbHBlci1za2VsZXRvbiBhbmQgaGlnaGxpZ2h0LXNrZWxldG9uIHJvd3MuDQogICAgICAgIFN1YkNsYXNzLnByb3RvdHlwZS5yZW5kZXJJbnRyb0h0bWwgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICB2YXIgdmlldyA9IHRoaXMudmlldzsNCiAgICAgICAgICAgIGlmICh0aGlzLmNvbFdlZWtOdW1iZXJzVmlzaWJsZSkgew0KICAgICAgICAgICAgICAgIHJldHVybiAnPHRkIGNsYXNzPSJmYy13ZWVrLW51bWJlciIgJyArIHZpZXcud2Vla051bWJlclN0eWxlQXR0cigpICsgJz48L3RkPic7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gJyc7DQogICAgICAgIH07DQogICAgICAgIFN1YkNsYXNzLnByb3RvdHlwZS5nZXRJc051bWJlcnNWaXNpYmxlID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgcmV0dXJuIERheUdyaWRfMS5kZWZhdWx0LnByb3RvdHlwZS5nZXRJc051bWJlcnNWaXNpYmxlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpcy5jb2xXZWVrTnVtYmVyc1Zpc2libGU7DQogICAgICAgIH07DQogICAgICAgIHJldHVybiBTdWJDbGFzczsNCiAgICB9KFN1cGVyQ2xhc3MpKTsNCn0NCgoKLyoqKi8gfSksCi8qIDYzICovLAovKiA2NCAqLywKLyogNjUgKi8sCi8qIDY2ICovLAovKiA2NyAqLywKLyogNjggKi8sCi8qIDY5ICovLAovKiA3MCAqLywKLyogNzEgKi8sCi8qIDcyICovLAovKiA3MyAqLywKLyogNzQgKi8sCi8qIDc1ICovLAovKiA3NiAqLywKLyogNzcgKi8sCi8qIDc4ICovLAovKiA3OSAqLywKLyogODAgKi8sCi8qIDgxICovLAovKiA4MiAqLywKLyogODMgKi8sCi8qIDg0ICovLAovKiA4NSAqLywKLyogODYgKi8sCi8qIDg3ICovLAovKiA4OCAqLywKLyogODkgKi8sCi8qIDkwICovLAovKiA5MSAqLywKLyogOTIgKi8sCi8qIDkzICovLAovKiA5NCAqLywKLyogOTUgKi8sCi8qIDk2ICovLAovKiA5NyAqLywKLyogOTggKi8sCi8qIDk5ICovLAovKiAxMDAgKi8sCi8qIDEwMSAqLywKLyogMTAyICovLAovKiAxMDMgKi8sCi8qIDEwNCAqLywKLyogMTA1ICovLAovKiAxMDYgKi8sCi8qIDEwNyAqLywKLyogMTA4ICovLAovKiAxMDkgKi8sCi8qIDExMCAqLywKLyogMTExICovLAovKiAxMTIgKi8sCi8qIDExMyAqLywKLyogMTE0ICovLAovKiAxMTUgKi8sCi8qIDExNiAqLywKLyogMTE3ICovLAovKiAxMTggKi8sCi8qIDExOSAqLywKLyogMTIwICovLAovKiAxMjEgKi8sCi8qIDEyMiAqLywKLyogMTIzICovLAovKiAxMjQgKi8sCi8qIDEyNSAqLywKLyogMTI2ICovLAovKiAxMjcgKi8sCi8qIDEyOCAqLywKLyogMTI5ICovLAovKiAxMzAgKi8sCi8qIDEzMSAqLywKLyogMTMyICovLAovKiAxMzMgKi8sCi8qIDEzNCAqLywKLyogMTM1ICovLAovKiAxMzYgKi8sCi8qIDEzNyAqLywKLyogMTM4ICovLAovKiAxMzkgKi8sCi8qIDE0MCAqLywKLyogMTQxICovLAovKiAxNDIgKi8sCi8qIDE0MyAqLywKLyogMTQ0ICovLAovKiAxNDUgKi8sCi8qIDE0NiAqLywKLyogMTQ3ICovLAovKiAxNDggKi8sCi8qIDE0OSAqLywKLyogMTUwICovLAovKiAxNTEgKi8sCi8qIDE1MiAqLywKLyogMTUzICovLAovKiAxNTQgKi8sCi8qIDE1NSAqLywKLyogMTU2ICovLAovKiAxNTcgKi8sCi8qIDE1OCAqLywKLyogMTU5ICovLAovKiAxNjAgKi8sCi8qIDE2MSAqLywKLyogMTYyICovLAovKiAxNjMgKi8sCi8qIDE2NCAqLywKLyogMTY1ICovLAovKiAxNjYgKi8sCi8qIDE2NyAqLywKLyogMTY4ICovLAovKiAxNjkgKi8sCi8qIDE3MCAqLywKLyogMTcxICovLAovKiAxNzIgKi8sCi8qIDE3MyAqLywKLyogMTc0ICovLAovKiAxNzUgKi8sCi8qIDE3NiAqLywKLyogMTc3ICovLAovKiAxNzggKi8sCi8qIDE3OSAqLywKLyogMTgwICovLAovKiAxODEgKi8sCi8qIDE4MiAqLywKLyogMTgzICovLAovKiAxODQgKi8sCi8qIDE4NSAqLywKLyogMTg2ICovLAovKiAxODcgKi8sCi8qIDE4OCAqLywKLyogMTg5ICovLAovKiAxOTAgKi8sCi8qIDE5MSAqLywKLyogMTkyICovLAovKiAxOTMgKi8sCi8qIDE5NCAqLywKLyogMTk1ICovLAovKiAxOTYgKi8sCi8qIDE5NyAqLywKLyogMTk4ICovLAovKiAxOTkgKi8sCi8qIDIwMCAqLywKLyogMjAxICovLAovKiAyMDIgKi8sCi8qIDIwMyAqLywKLyogMjA0ICovLAovKiAyMDUgKi8sCi8qIDIwNiAqLywKLyogMjA3ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgVW56b25lZFJhbmdlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUpOw0KdmFyIENvbXBvbmVudEZvb3RwcmludF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMik7DQp2YXIgRXZlbnREZWZQYXJzZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNDkpOw0KdmFyIEV2ZW50U291cmNlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMzQpOw0KdmFyIENvbnN0cmFpbnRzID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgew0KICAgIGZ1bmN0aW9uIENvbnN0cmFpbnRzKGV2ZW50TWFuYWdlciwgX2NhbGVuZGFyKSB7DQogICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyID0gZXZlbnRNYW5hZ2VyOw0KICAgICAgICB0aGlzLl9jYWxlbmRhciA9IF9jYWxlbmRhcjsNCiAgICB9DQogICAgQ29uc3RyYWludHMucHJvdG90eXBlLm9wdCA9IGZ1bmN0aW9uIChuYW1lKSB7DQogICAgICAgIHJldHVybiB0aGlzLl9jYWxlbmRhci5vcHQobmFtZSk7DQogICAgfTsNCiAgICAvKg0KICAgIGRldGVybWluZXMgaWYgZXZlbnRJbnN0YW5jZUdyb3VwIGlzIGFsbG93ZWQsDQogICAgaW4gcmVsYXRpb24gdG8gb3RoZXIgRVZFTlRTIGFuZCBidXNpbmVzcyBob3Vycy4NCiAgICAqLw0KICAgIENvbnN0cmFpbnRzLnByb3RvdHlwZS5pc0V2ZW50SW5zdGFuY2VHcm91cEFsbG93ZWQgPSBmdW5jdGlvbiAoZXZlbnRJbnN0YW5jZUdyb3VwKSB7DQogICAgICAgIHZhciBldmVudERlZiA9IGV2ZW50SW5zdGFuY2VHcm91cC5nZXRFdmVudERlZigpOw0KICAgICAgICB2YXIgZXZlbnRGb290cHJpbnRzID0gdGhpcy5ldmVudFJhbmdlc1RvRXZlbnRGb290cHJpbnRzKGV2ZW50SW5zdGFuY2VHcm91cC5nZXRBbGxFdmVudFJhbmdlcygpKTsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIHZhciBwZWVyRXZlbnRJbnN0YW5jZXMgPSB0aGlzLmdldFBlZXJFdmVudEluc3RhbmNlcyhldmVudERlZik7DQogICAgICAgIHZhciBwZWVyRXZlbnRSYW5nZXMgPSBwZWVyRXZlbnRJbnN0YW5jZXMubWFwKHV0aWxfMS5ldmVudEluc3RhbmNlVG9FdmVudFJhbmdlKTsNCiAgICAgICAgdmFyIHBlZXJFdmVudEZvb3RwcmludHMgPSB0aGlzLmV2ZW50UmFuZ2VzVG9FdmVudEZvb3RwcmludHMocGVlckV2ZW50UmFuZ2VzKTsNCiAgICAgICAgdmFyIGNvbnN0cmFpbnRWYWwgPSBldmVudERlZi5nZXRDb25zdHJhaW50KCk7DQogICAgICAgIHZhciBvdmVybGFwVmFsID0gZXZlbnREZWYuZ2V0T3ZlcmxhcCgpOw0KICAgICAgICB2YXIgZXZlbnRBbGxvd0Z1bmMgPSB0aGlzLm9wdCgnZXZlbnRBbGxvdycpOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZXZlbnRGb290cHJpbnRzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBpZiAoIXRoaXMuaXNGb290cHJpbnRBbGxvd2VkKGV2ZW50Rm9vdHByaW50c1tpXS5jb21wb25lbnRGb290cHJpbnQsIHBlZXJFdmVudEZvb3RwcmludHMsIGNvbnN0cmFpbnRWYWwsIG92ZXJsYXBWYWwsIGV2ZW50Rm9vdHByaW50c1tpXS5ldmVudEluc3RhbmNlKSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBpZiAoZXZlbnRBbGxvd0Z1bmMpIHsNCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBldmVudEZvb3RwcmludHMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICBpZiAoZXZlbnRBbGxvd0Z1bmMoZXZlbnRGb290cHJpbnRzW2ldLmNvbXBvbmVudEZvb3RwcmludC50b0xlZ2FjeSh0aGlzLl9jYWxlbmRhciksIGV2ZW50Rm9vdHByaW50c1tpXS5nZXRFdmVudExlZ2FjeSgpKSA9PT0gZmFsc2UpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9Ow0KICAgIENvbnN0cmFpbnRzLnByb3RvdHlwZS5nZXRQZWVyRXZlbnRJbnN0YW5jZXMgPSBmdW5jdGlvbiAoZXZlbnREZWYpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRNYW5hZ2VyLmdldEV2ZW50SW5zdGFuY2VzV2l0aG91dElkKGV2ZW50RGVmLmlkKTsNCiAgICB9Ow0KICAgIENvbnN0cmFpbnRzLnByb3RvdHlwZS5pc1NlbGVjdGlvbkZvb3RwcmludEFsbG93ZWQgPSBmdW5jdGlvbiAoY29tcG9uZW50Rm9vdHByaW50KSB7DQogICAgICAgIHZhciBwZWVyRXZlbnRJbnN0YW5jZXMgPSB0aGlzLmV2ZW50TWFuYWdlci5nZXRFdmVudEluc3RhbmNlcygpOw0KICAgICAgICB2YXIgcGVlckV2ZW50UmFuZ2VzID0gcGVlckV2ZW50SW5zdGFuY2VzLm1hcCh1dGlsXzEuZXZlbnRJbnN0YW5jZVRvRXZlbnRSYW5nZSk7DQogICAgICAgIHZhciBwZWVyRXZlbnRGb290cHJpbnRzID0gdGhpcy5ldmVudFJhbmdlc1RvRXZlbnRGb290cHJpbnRzKHBlZXJFdmVudFJhbmdlcyk7DQogICAgICAgIHZhciBzZWxlY3RBbGxvd0Z1bmM7DQogICAgICAgIGlmICh0aGlzLmlzRm9vdHByaW50QWxsb3dlZChjb21wb25lbnRGb290cHJpbnQsIHBlZXJFdmVudEZvb3RwcmludHMsIHRoaXMub3B0KCdzZWxlY3RDb25zdHJhaW50JyksIHRoaXMub3B0KCdzZWxlY3RPdmVybGFwJykpKSB7DQogICAgICAgICAgICBzZWxlY3RBbGxvd0Z1bmMgPSB0aGlzLm9wdCgnc2VsZWN0QWxsb3cnKTsNCiAgICAgICAgICAgIGlmIChzZWxlY3RBbGxvd0Z1bmMpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZWN0QWxsb3dGdW5jKGNvbXBvbmVudEZvb3RwcmludC50b0xlZ2FjeSh0aGlzLl9jYWxlbmRhcikpICE9PSBmYWxzZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9Ow0KICAgIENvbnN0cmFpbnRzLnByb3RvdHlwZS5pc0Zvb3RwcmludEFsbG93ZWQgPSBmdW5jdGlvbiAoY29tcG9uZW50Rm9vdHByaW50LCBwZWVyRXZlbnRGb290cHJpbnRzLCBjb25zdHJhaW50VmFsLCBvdmVybGFwVmFsLCBzdWJqZWN0RXZlbnRJbnN0YW5jZSAvLyBvcHRpb25hbA0KICAgICkgew0KICAgICAgICB2YXIgY29uc3RyYWludEZvb3RwcmludHM7IC8vIENvbXBvbmVudEZvb3RwcmludFtdDQogICAgICAgIHZhciBvdmVybGFwRXZlbnRGb290cHJpbnRzOyAvLyBFdmVudEZvb3RwcmludFtdDQogICAgICAgIGlmIChjb25zdHJhaW50VmFsICE9IG51bGwpIHsNCiAgICAgICAgICAgIGNvbnN0cmFpbnRGb290cHJpbnRzID0gdGhpcy5jb25zdHJhaW50VmFsVG9Gb290cHJpbnRzKGNvbnN0cmFpbnRWYWwsIGNvbXBvbmVudEZvb3RwcmludC5pc0FsbERheSk7DQogICAgICAgICAgICBpZiAoIXRoaXMuaXNGb290cHJpbnRXaXRoaW5Db25zdHJhaW50cyhjb21wb25lbnRGb290cHJpbnQsIGNvbnN0cmFpbnRGb290cHJpbnRzKSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBvdmVybGFwRXZlbnRGb290cHJpbnRzID0gdGhpcy5jb2xsZWN0T3ZlcmxhcEV2ZW50Rm9vdHByaW50cyhwZWVyRXZlbnRGb290cHJpbnRzLCBjb21wb25lbnRGb290cHJpbnQpOw0KICAgICAgICBpZiAob3ZlcmxhcFZhbCA9PT0gZmFsc2UpIHsNCiAgICAgICAgICAgIGlmIChvdmVybGFwRXZlbnRGb290cHJpbnRzLmxlbmd0aCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICh0eXBlb2Ygb3ZlcmxhcFZhbCA9PT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICAgICAgaWYgKCFpc092ZXJsYXBzQWxsb3dlZEJ5RnVuYyhvdmVybGFwRXZlbnRGb290cHJpbnRzLCBvdmVybGFwVmFsLCBzdWJqZWN0RXZlbnRJbnN0YW5jZSkpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgaWYgKHN1YmplY3RFdmVudEluc3RhbmNlKSB7DQogICAgICAgICAgICBpZiAoIWlzT3ZlcmxhcEV2ZW50SW5zdGFuY2VzQWxsb3dlZChvdmVybGFwRXZlbnRGb290cHJpbnRzLCBzdWJqZWN0RXZlbnRJbnN0YW5jZSkpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgfTsNCiAgICAvLyBDb25zdHJhaW50DQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgQ29uc3RyYWludHMucHJvdG90eXBlLmlzRm9vdHByaW50V2l0aGluQ29uc3RyYWludHMgPSBmdW5jdGlvbiAoY29tcG9uZW50Rm9vdHByaW50LCBjb25zdHJhaW50Rm9vdHByaW50cykgew0KICAgICAgICB2YXIgaTsNCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvbnN0cmFpbnRGb290cHJpbnRzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBpZiAodGhpcy5mb290cHJpbnRDb250YWluc0Zvb3RwcmludChjb25zdHJhaW50Rm9vdHByaW50c1tpXSwgY29tcG9uZW50Rm9vdHByaW50KSkgew0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9Ow0KICAgIENvbnN0cmFpbnRzLnByb3RvdHlwZS5jb25zdHJhaW50VmFsVG9Gb290cHJpbnRzID0gZnVuY3Rpb24gKGNvbnN0cmFpbnRWYWwsIGlzQWxsRGF5KSB7DQogICAgICAgIHZhciBldmVudEluc3RhbmNlczsNCiAgICAgICAgaWYgKGNvbnN0cmFpbnRWYWwgPT09ICdidXNpbmVzc0hvdXJzJykgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRDdXJyZW50QnVzaW5lc3NGb290cHJpbnRzKGlzQWxsRGF5KTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICh0eXBlb2YgY29uc3RyYWludFZhbCA9PT0gJ29iamVjdCcpIHsNCiAgICAgICAgICAgIGV2ZW50SW5zdGFuY2VzID0gdGhpcy5wYXJzZUV2ZW50RGVmVG9JbnN0YW5jZXMoY29uc3RyYWludFZhbCk7IC8vIGhhbmRsZXMgcmVjdXJyaW5nIGV2ZW50cw0KICAgICAgICAgICAgaWYgKCFldmVudEluc3RhbmNlcykgew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnNlRm9vdHByaW50cyhjb25zdHJhaW50VmFsKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmV2ZW50SW5zdGFuY2VzVG9Gb290cHJpbnRzKGV2ZW50SW5zdGFuY2VzKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmIChjb25zdHJhaW50VmFsICE9IG51bGwpIHsNCiAgICAgICAgICAgIGV2ZW50SW5zdGFuY2VzID0gdGhpcy5ldmVudE1hbmFnZXIuZ2V0RXZlbnRJbnN0YW5jZXNXaXRoSWQoY29uc3RyYWludFZhbCk7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5ldmVudEluc3RhbmNlc1RvRm9vdHByaW50cyhldmVudEluc3RhbmNlcyk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIHJldHVybnMgQ29tcG9uZW50Rm9vdHByaW50W10NCiAgICAvLyB1c2VzIGN1cnJlbnQgdmlldydzIHJhbmdlDQogICAgQ29uc3RyYWludHMucHJvdG90eXBlLmJ1aWxkQ3VycmVudEJ1c2luZXNzRm9vdHByaW50cyA9IGZ1bmN0aW9uIChpc0FsbERheSkgew0KICAgICAgICB2YXIgdmlldyA9IHRoaXMuX2NhbGVuZGFyLnZpZXc7DQogICAgICAgIHZhciBidXNpbmVzc0hvdXJHZW5lcmF0b3IgPSB2aWV3LmdldCgnYnVzaW5lc3NIb3VyR2VuZXJhdG9yJyk7DQogICAgICAgIHZhciB1bnpvbmVkUmFuZ2UgPSB2aWV3LmRhdGVQcm9maWxlLmFjdGl2ZVVuem9uZWRSYW5nZTsNCiAgICAgICAgdmFyIGV2ZW50SW5zdGFuY2VHcm91cCA9IGJ1c2luZXNzSG91ckdlbmVyYXRvci5idWlsZEV2ZW50SW5zdGFuY2VHcm91cChpc0FsbERheSwgdW56b25lZFJhbmdlKTsNCiAgICAgICAgaWYgKGV2ZW50SW5zdGFuY2VHcm91cCkgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRJbnN0YW5jZXNUb0Zvb3RwcmludHMoZXZlbnRJbnN0YW5jZUdyb3VwLmV2ZW50SW5zdGFuY2VzKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHJldHVybiBbXTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gY29udmVyc2lvbiB1dGlsDQogICAgQ29uc3RyYWludHMucHJvdG90eXBlLmV2ZW50SW5zdGFuY2VzVG9Gb290cHJpbnRzID0gZnVuY3Rpb24gKGV2ZW50SW5zdGFuY2VzKSB7DQogICAgICAgIHZhciBldmVudFJhbmdlcyA9IGV2ZW50SW5zdGFuY2VzLm1hcCh1dGlsXzEuZXZlbnRJbnN0YW5jZVRvRXZlbnRSYW5nZSk7DQogICAgICAgIHZhciBldmVudEZvb3RwcmludHMgPSB0aGlzLmV2ZW50UmFuZ2VzVG9FdmVudEZvb3RwcmludHMoZXZlbnRSYW5nZXMpOw0KICAgICAgICByZXR1cm4gZXZlbnRGb290cHJpbnRzLm1hcCh1dGlsXzEuZXZlbnRGb290cHJpbnRUb0NvbXBvbmVudEZvb3RwcmludCk7DQogICAgfTsNCiAgICAvLyBPdmVybGFwDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgQ29uc3RyYWludHMucHJvdG90eXBlLmNvbGxlY3RPdmVybGFwRXZlbnRGb290cHJpbnRzID0gZnVuY3Rpb24gKHBlZXJFdmVudEZvb3RwcmludHMsIHRhcmdldEZvb3RwcmludCkgew0KICAgICAgICB2YXIgb3ZlcmxhcEV2ZW50Rm9vdHByaW50cyA9IFtdOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHBlZXJFdmVudEZvb3RwcmludHMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIGlmICh0aGlzLmZvb3RwcmludHNJbnRlcnNlY3QodGFyZ2V0Rm9vdHByaW50LCBwZWVyRXZlbnRGb290cHJpbnRzW2ldLmNvbXBvbmVudEZvb3RwcmludCkpIHsNCiAgICAgICAgICAgICAgICBvdmVybGFwRXZlbnRGb290cHJpbnRzLnB1c2gocGVlckV2ZW50Rm9vdHByaW50c1tpXSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIG92ZXJsYXBFdmVudEZvb3RwcmludHM7DQogICAgfTsNCiAgICAvLyBDb252ZXJzaW9uOiBldmVudERlZnMgLT4gZXZlbnRJbnN0YW5jZXMgLT4gZXZlbnRSYW5nZXMgLT4gZXZlbnRGb290cHJpbnRzIC0+IGNvbXBvbmVudEZvb3RwcmludHMNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAvLyBOT1RFOiB0aGlzIG1pZ2h0IHNlZW0gbGlrZSByZXBldGl0aXZlIGNvZGUgd2l0aCB0aGUgR3JpZCBjbGFzcywgaG93ZXZlciwgdGhpcyBjb2RlIGlzIHJlbGF0ZWQgdG8NCiAgICAvLyBjb25zdHJhaW50cyB3aGVyZWFzIHRoZSBHcmlkIGNvZGUgaXMgcmVsYXRlZCB0byByZW5kZXJpbmcuIEVhY2ggYXBwcm9hY2ggbWlnaHQgd2FudCB0byBjb252ZXJ0DQogICAgLy8gZXZlbnRSYW5nZXMgLT4gZXZlbnRGb290cHJpbnRzIGluIGEgZGlmZmVyZW50IHdheS4gUmVnYXJkbGVzcywgdGhlcmUgYXJlIG9wcG9ydHVuaXRpZXMgdG8gbWFrZQ0KICAgIC8vIHRoaXMgbW9yZSBEUlkuDQogICAgLyoNCiAgICBSZXR1cm5zIGZhbHNlIG9uIGludmFsaWQgaW5wdXQuDQogICAgKi8NCiAgICBDb25zdHJhaW50cy5wcm90b3R5cGUucGFyc2VFdmVudERlZlRvSW5zdGFuY2VzID0gZnVuY3Rpb24gKGV2ZW50SW5wdXQpIHsNCiAgICAgICAgdmFyIGV2ZW50TWFuYWdlciA9IHRoaXMuZXZlbnRNYW5hZ2VyOw0KICAgICAgICB2YXIgZXZlbnREZWYgPSBFdmVudERlZlBhcnNlcl8xLmRlZmF1bHQucGFyc2UoZXZlbnRJbnB1dCwgbmV3IEV2ZW50U291cmNlXzEuZGVmYXVsdCh0aGlzLl9jYWxlbmRhcikpOw0KICAgICAgICBpZiAoIWV2ZW50RGVmKSB7DQogICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGV2ZW50RGVmLmJ1aWxkSW5zdGFuY2VzKGV2ZW50TWFuYWdlci5jdXJyZW50UGVyaW9kLnVuem9uZWRSYW5nZSk7DQogICAgfTsNCiAgICBDb25zdHJhaW50cy5wcm90b3R5cGUuZXZlbnRSYW5nZXNUb0V2ZW50Rm9vdHByaW50cyA9IGZ1bmN0aW9uIChldmVudFJhbmdlcykgew0KICAgICAgICB2YXIgaTsNCiAgICAgICAgdmFyIGV2ZW50Rm9vdHByaW50cyA9IFtdOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZXZlbnRSYW5nZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIGV2ZW50Rm9vdHByaW50cy5wdXNoLmFwcGx5KC8vIGZvb3RwcmludHMNCiAgICAgICAgICAgIGV2ZW50Rm9vdHByaW50cywgdGhpcy5ldmVudFJhbmdlVG9FdmVudEZvb3RwcmludHMoZXZlbnRSYW5nZXNbaV0pKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZXZlbnRGb290cHJpbnRzOw0KICAgIH07DQogICAgQ29uc3RyYWludHMucHJvdG90eXBlLmV2ZW50UmFuZ2VUb0V2ZW50Rm9vdHByaW50cyA9IGZ1bmN0aW9uIChldmVudFJhbmdlKSB7DQogICAgICAgIHJldHVybiBbdXRpbF8xLmV2ZW50UmFuZ2VUb0V2ZW50Rm9vdHByaW50KGV2ZW50UmFuZ2UpXTsNCiAgICB9Ow0KICAgIC8qDQogICAgUGFyc2VzIGZvb3RwcmludHMgZGlyZWN0bHkuDQogICAgVmVyeSBzaW1pbGFyIHRvIEV2ZW50RGF0ZVByb2ZpbGU6OnBhcnNlIDooDQogICAgKi8NCiAgICBDb25zdHJhaW50cy5wcm90b3R5cGUucGFyc2VGb290cHJpbnRzID0gZnVuY3Rpb24gKHJhd0lucHV0KSB7DQogICAgICAgIHZhciBzdGFydDsNCiAgICAgICAgdmFyIGVuZDsNCiAgICAgICAgaWYgKHJhd0lucHV0LnN0YXJ0KSB7DQogICAgICAgICAgICBzdGFydCA9IHRoaXMuX2NhbGVuZGFyLm1vbWVudChyYXdJbnB1dC5zdGFydCk7DQogICAgICAgICAgICBpZiAoIXN0YXJ0LmlzVmFsaWQoKSkgew0KICAgICAgICAgICAgICAgIHN0YXJ0ID0gbnVsbDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBpZiAocmF3SW5wdXQuZW5kKSB7DQogICAgICAgICAgICBlbmQgPSB0aGlzLl9jYWxlbmRhci5tb21lbnQocmF3SW5wdXQuZW5kKTsNCiAgICAgICAgICAgIGlmICghZW5kLmlzVmFsaWQoKSkgew0KICAgICAgICAgICAgICAgIGVuZCA9IG51bGw7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIFsNCiAgICAgICAgICAgIG5ldyBDb21wb25lbnRGb290cHJpbnRfMS5kZWZhdWx0KG5ldyBVbnpvbmVkUmFuZ2VfMS5kZWZhdWx0KHN0YXJ0LCBlbmQpLCAoc3RhcnQgJiYgIXN0YXJ0Lmhhc1RpbWUoKSkgfHwgKGVuZCAmJiAhZW5kLmhhc1RpbWUoKSkgLy8gaXNBbGxEYXkNCiAgICAgICAgICAgICkNCiAgICAgICAgXTsNCiAgICB9Ow0KICAgIC8vIEZvb3RwcmludCBVdGlscw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICBDb25zdHJhaW50cy5wcm90b3R5cGUuZm9vdHByaW50Q29udGFpbnNGb290cHJpbnQgPSBmdW5jdGlvbiAob3V0ZXJGb290cHJpbnQsIGlubmVyRm9vdHByaW50KSB7DQogICAgICAgIHJldHVybiBvdXRlckZvb3RwcmludC51bnpvbmVkUmFuZ2UuY29udGFpbnNSYW5nZShpbm5lckZvb3RwcmludC51bnpvbmVkUmFuZ2UpOw0KICAgIH07DQogICAgQ29uc3RyYWludHMucHJvdG90eXBlLmZvb3RwcmludHNJbnRlcnNlY3QgPSBmdW5jdGlvbiAoZm9vdHByaW50MCwgZm9vdHByaW50MSkgew0KICAgICAgICByZXR1cm4gZm9vdHByaW50MC51bnpvbmVkUmFuZ2UuaW50ZXJzZWN0c1dpdGgoZm9vdHByaW50MS51bnpvbmVkUmFuZ2UpOw0KICAgIH07DQogICAgcmV0dXJuIENvbnN0cmFpbnRzOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IENvbnN0cmFpbnRzOw0KLy8gb3B0aW9uYWwgc3ViamVjdEV2ZW50SW5zdGFuY2UNCmZ1bmN0aW9uIGlzT3ZlcmxhcHNBbGxvd2VkQnlGdW5jKG92ZXJsYXBFdmVudEZvb3RwcmludHMsIG92ZXJsYXBGdW5jLCBzdWJqZWN0RXZlbnRJbnN0YW5jZSkgew0KICAgIHZhciBpOw0KICAgIGZvciAoaSA9IDA7IGkgPCBvdmVybGFwRXZlbnRGb290cHJpbnRzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGlmICghb3ZlcmxhcEZ1bmMob3ZlcmxhcEV2ZW50Rm9vdHByaW50c1tpXS5ldmVudEluc3RhbmNlLnRvTGVnYWN5KCksIHN1YmplY3RFdmVudEluc3RhbmNlID8gc3ViamVjdEV2ZW50SW5zdGFuY2UudG9MZWdhY3koKSA6IG51bGwpKSB7DQogICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHRydWU7DQp9DQpmdW5jdGlvbiBpc092ZXJsYXBFdmVudEluc3RhbmNlc0FsbG93ZWQob3ZlcmxhcEV2ZW50Rm9vdHByaW50cywgc3ViamVjdEV2ZW50SW5zdGFuY2UpIHsNCiAgICB2YXIgc3ViamVjdExlZ2FjeUluc3RhbmNlID0gc3ViamVjdEV2ZW50SW5zdGFuY2UudG9MZWdhY3koKTsNCiAgICB2YXIgaTsNCiAgICB2YXIgb3ZlcmxhcEV2ZW50SW5zdGFuY2U7DQogICAgdmFyIG92ZXJsYXBFdmVudERlZjsNCiAgICB2YXIgb3ZlcmxhcFZhbDsNCiAgICBmb3IgKGkgPSAwOyBpIDwgb3ZlcmxhcEV2ZW50Rm9vdHByaW50cy5sZW5ndGg7IGkrKykgew0KICAgICAgICBvdmVybGFwRXZlbnRJbnN0YW5jZSA9IG92ZXJsYXBFdmVudEZvb3RwcmludHNbaV0uZXZlbnRJbnN0YW5jZTsNCiAgICAgICAgb3ZlcmxhcEV2ZW50RGVmID0gb3ZlcmxhcEV2ZW50SW5zdGFuY2UuZGVmOw0KICAgICAgICAvLyBkb24ndCBuZWVkIHRvIHBhc3MgaW4gY2FsZW5kYXIsIGJlY2F1c2UgZG9uJ3Qgd2FudCB0byBjb25zaWRlciBnbG9iYWwgZXZlbnRPdmVybGFwIHByb3BlcnR5LA0KICAgICAgICAvLyBiZWNhdXNlIHdlIGFscmVhZHkgY29uc2lkZXJlZCB0aGF0IGVhcmxpZXIgaW4gdGhlIHByb2Nlc3MuDQogICAgICAgIG92ZXJsYXBWYWwgPSBvdmVybGFwRXZlbnREZWYuZ2V0T3ZlcmxhcCgpOw0KICAgICAgICBpZiAob3ZlcmxhcFZhbCA9PT0gZmFsc2UpIHsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICh0eXBlb2Ygb3ZlcmxhcFZhbCA9PT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICAgICAgaWYgKCFvdmVybGFwVmFsKG92ZXJsYXBFdmVudEluc3RhbmNlLnRvTGVnYWN5KCksIHN1YmplY3RMZWdhY3lJbnN0YW5jZSkpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIHRydWU7DQp9DQoKCi8qKiovIH0pLAovKiAyMDggKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKLyoNClVTQUdFOg0KICBpbXBvcnQgeyBkZWZhdWx0IGFzIFBhcnNhYmxlTW9kZWxNaXhpbiwgUGFyc2FibGVNb2RlbEludGVyZmFjZSB9IGZyb20gJy4vUGFyc2FibGVNb2RlbE1peGluJw0KaW4gY2xhc3M6DQogIGFwcGx5UHJvcHM6IFBhcnNhYmxlTW9kZWxJbnRlcmZhY2VbJ2FwcGx5UHJvcHMnXQ0KICBhcHBseU1hbnVhbFN0YW5kYXJkUHJvcHM6IFBhcnNhYmxlTW9kZWxJbnRlcmZhY2VbJ2FwcGx5TWFudWFsU3RhbmRhcmRQcm9wcyddDQogIGFwcGx5TWlzY1Byb3BzOiBQYXJzYWJsZU1vZGVsSW50ZXJmYWNlWydhcHBseU1pc2NQcm9wcyddDQogIGlzU3RhbmRhcmRQcm9wOiBQYXJzYWJsZU1vZGVsSW50ZXJmYWNlWydpc1N0YW5kYXJkUHJvcCddDQogIHN0YXRpYyBkZWZpbmVTdGFuZGFyZFByb3BzID0gUGFyc2FibGVNb2RlbE1peGluLmRlZmluZVN0YW5kYXJkUHJvcHMNCiAgc3RhdGljIGNvcHlWZXJiYXRpbVN0YW5kYXJkUHJvcHMgPSBQYXJzYWJsZU1vZGVsTWl4aW4uY29weVZlcmJhdGltU3RhbmRhcmRQcm9wcw0KYWZ0ZXIgY2xhc3M6DQogIFBhcnNhYmxlTW9kZWxNaXhpbi5taXhJbnRvKFRoZUNsYXNzKQ0KKi8NCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdHNsaWJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCnZhciBNaXhpbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNCk7DQp2YXIgUGFyc2FibGVNb2RlbE1peGluID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKFBhcnNhYmxlTW9kZWxNaXhpbiwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBQYXJzYWJsZU1vZGVsTWl4aW4oKSB7DQogICAgICAgIHJldHVybiBfc3VwZXIgIT09IG51bGwgJiYgX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsNCiAgICB9DQogICAgUGFyc2FibGVNb2RlbE1peGluLmRlZmluZVN0YW5kYXJkUHJvcHMgPSBmdW5jdGlvbiAocHJvcERlZnMpIHsNCiAgICAgICAgdmFyIHByb3RvID0gdGhpcy5wcm90b3R5cGU7DQogICAgICAgIGlmICghcHJvdG8uaGFzT3duUHJvcGVydHkoJ3N0YW5kYXJkUHJvcE1hcCcpKSB7DQogICAgICAgICAgICBwcm90by5zdGFuZGFyZFByb3BNYXAgPSBPYmplY3QuY3JlYXRlKHByb3RvLnN0YW5kYXJkUHJvcE1hcCk7DQogICAgICAgIH0NCiAgICAgICAgdXRpbF8xLmNvcHlPd25Qcm9wcyhwcm9wRGVmcywgcHJvdG8uc3RhbmRhcmRQcm9wTWFwKTsNCiAgICB9Ow0KICAgIFBhcnNhYmxlTW9kZWxNaXhpbi5jb3B5VmVyYmF0aW1TdGFuZGFyZFByb3BzID0gZnVuY3Rpb24gKHNyYywgZGVzdCkgew0KICAgICAgICB2YXIgbWFwID0gdGhpcy5wcm90b3R5cGUuc3RhbmRhcmRQcm9wTWFwOw0KICAgICAgICB2YXIgcHJvcE5hbWU7DQogICAgICAgIGZvciAocHJvcE5hbWUgaW4gbWFwKSB7DQogICAgICAgICAgICBpZiAoc3JjW3Byb3BOYW1lXSAhPSBudWxsICYmIC8vIGluIHRoZSBzcmMgb2JqZWN0Pw0KICAgICAgICAgICAgICAgIG1hcFtwcm9wTmFtZV0gPT09IHRydWUgLy8gZmFsc2UgbWVhbnMgImNvcHkgdmVyYmF0aW0iDQogICAgICAgICAgICApIHsNCiAgICAgICAgICAgICAgICBkZXN0W3Byb3BOYW1lXSA9IHNyY1twcm9wTmFtZV07DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8qDQogICAgUmV0dXJucyB0cnVlL2ZhbHNlIGZvciBzdWNjZXNzLg0KICAgIE1lYW50IHRvIGJlIG9ubHkgY2FsbGVkIE9OQ0UsIGF0IG9iamVjdCBjcmVhdGlvbi4NCiAgICAqLw0KICAgIFBhcnNhYmxlTW9kZWxNaXhpbi5wcm90b3R5cGUuYXBwbHlQcm9wcyA9IGZ1bmN0aW9uIChyYXdQcm9wcykgew0KICAgICAgICB2YXIgc3RhbmRhcmRQcm9wTWFwID0gdGhpcy5zdGFuZGFyZFByb3BNYXA7DQogICAgICAgIHZhciBtYW51YWxQcm9wcyA9IHt9Ow0KICAgICAgICB2YXIgbWlzY1Byb3BzID0ge307DQogICAgICAgIHZhciBwcm9wTmFtZTsNCiAgICAgICAgZm9yIChwcm9wTmFtZSBpbiByYXdQcm9wcykgew0KICAgICAgICAgICAgaWYgKHN0YW5kYXJkUHJvcE1hcFtwcm9wTmFtZV0gPT09IHRydWUpIHsNCiAgICAgICAgICAgICAgICB0aGlzW3Byb3BOYW1lXSA9IHJhd1Byb3BzW3Byb3BOYW1lXTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2UgaWYgKHN0YW5kYXJkUHJvcE1hcFtwcm9wTmFtZV0gPT09IGZhbHNlKSB7DQogICAgICAgICAgICAgICAgbWFudWFsUHJvcHNbcHJvcE5hbWVdID0gcmF3UHJvcHNbcHJvcE5hbWVdOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgbWlzY1Byb3BzW3Byb3BOYW1lXSA9IHJhd1Byb3BzW3Byb3BOYW1lXTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmFwcGx5TWlzY1Byb3BzKG1pc2NQcm9wcyk7DQogICAgICAgIHJldHVybiB0aGlzLmFwcGx5TWFudWFsU3RhbmRhcmRQcm9wcyhtYW51YWxQcm9wcyk7DQogICAgfTsNCiAgICAvKg0KICAgIElmIHN1YmNsYXNzZXMgb3ZlcnJpZGUsIHRoZXkgbXVzdCBjYWxsIHRoaXMgc3VwZXJtZXRob2QgYW5kIHJldHVybiB0aGUgYm9vbGVhbiByZXNwb25zZS4NCiAgICBNZWFudCB0byBiZSBvbmx5IGNhbGxlZCBPTkNFLCBhdCBvYmplY3QgY3JlYXRpb24uDQogICAgKi8NCiAgICBQYXJzYWJsZU1vZGVsTWl4aW4ucHJvdG90eXBlLmFwcGx5TWFudWFsU3RhbmRhcmRQcm9wcyA9IGZ1bmN0aW9uIChyYXdQcm9wcykgew0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9Ow0KICAgIC8qDQogICAgQ2FuIGJlIGNhbGxlZCBldmVuIGFmdGVyIGluaXRpYWwgb2JqZWN0IGNyZWF0aW9uLg0KICAgICovDQogICAgUGFyc2FibGVNb2RlbE1peGluLnByb3RvdHlwZS5hcHBseU1pc2NQcm9wcyA9IGZ1bmN0aW9uIChyYXdQcm9wcykgew0KICAgICAgICAvLyBzdWJjbGFzc2VzIGNhbiBpbXBsZW1lbnQNCiAgICB9Ow0KICAgIC8qDQogICAgVE9ETzogd2h5IGlzIHRoaXMgYSBtZXRob2Qgd2hlbiBkZWZpbmVTdGFuZGFyZFByb3BzIGlzIHN0YXRpYw0KICAgICovDQogICAgUGFyc2FibGVNb2RlbE1peGluLnByb3RvdHlwZS5pc1N0YW5kYXJkUHJvcCA9IGZ1bmN0aW9uIChwcm9wTmFtZSkgew0KICAgICAgICByZXR1cm4gcHJvcE5hbWUgaW4gdGhpcy5zdGFuZGFyZFByb3BNYXA7DQogICAgfTsNCiAgICByZXR1cm4gUGFyc2FibGVNb2RlbE1peGluOw0KfShNaXhpbl8xLmRlZmF1bHQpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IFBhcnNhYmxlTW9kZWxNaXhpbjsNClBhcnNhYmxlTW9kZWxNaXhpbi5wcm90b3R5cGUuc3RhbmRhcmRQcm9wTWFwID0ge307IC8vIHdpbGwgYmUgY2xvbmVkIGJ5IGRlZmluZVN0YW5kYXJkUHJvcHMNCgoKLyoqKi8gfSksCi8qIDIwOSAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIEV2ZW50SW5zdGFuY2UgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7DQogICAgZnVuY3Rpb24gRXZlbnRJbnN0YW5jZShkZWYsIGRhdGVQcm9maWxlKSB7DQogICAgICAgIHRoaXMuZGVmID0gZGVmOw0KICAgICAgICB0aGlzLmRhdGVQcm9maWxlID0gZGF0ZVByb2ZpbGU7DQogICAgfQ0KICAgIEV2ZW50SW5zdGFuY2UucHJvdG90eXBlLnRvTGVnYWN5ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgZGF0ZVByb2ZpbGUgPSB0aGlzLmRhdGVQcm9maWxlOw0KICAgICAgICB2YXIgb2JqID0gdGhpcy5kZWYudG9MZWdhY3koKTsNCiAgICAgICAgb2JqLnN0YXJ0ID0gZGF0ZVByb2ZpbGUuc3RhcnQuY2xvbmUoKTsNCiAgICAgICAgb2JqLmVuZCA9IGRhdGVQcm9maWxlLmVuZCA/IGRhdGVQcm9maWxlLmVuZC5jbG9uZSgpIDogbnVsbDsNCiAgICAgICAgcmV0dXJuIG9iajsNCiAgICB9Ow0KICAgIHJldHVybiBFdmVudEluc3RhbmNlOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IEV2ZW50SW5zdGFuY2U7DQoKCi8qKiovIH0pLAovKiAyMTAgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCnZhciBtb21lbnQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDApOw0KdmFyIEV2ZW50RGVmXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMzKTsNCnZhciBFdmVudEluc3RhbmNlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIwOSk7DQp2YXIgRXZlbnREYXRlUHJvZmlsZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxOCk7DQp2YXIgUmVjdXJyaW5nRXZlbnREZWYgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoUmVjdXJyaW5nRXZlbnREZWYsIF9zdXBlcik7DQogICAgZnVuY3Rpb24gUmVjdXJyaW5nRXZlbnREZWYoKSB7DQogICAgICAgIHJldHVybiBfc3VwZXIgIT09IG51bGwgJiYgX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsNCiAgICB9DQogICAgUmVjdXJyaW5nRXZlbnREZWYucHJvdG90eXBlLmlzQWxsRGF5ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gIXRoaXMuc3RhcnRUaW1lICYmICF0aGlzLmVuZFRpbWU7DQogICAgfTsNCiAgICBSZWN1cnJpbmdFdmVudERlZi5wcm90b3R5cGUuYnVpbGRJbnN0YW5jZXMgPSBmdW5jdGlvbiAodW56b25lZFJhbmdlKSB7DQogICAgICAgIHZhciBjYWxlbmRhciA9IHRoaXMuc291cmNlLmNhbGVuZGFyOw0KICAgICAgICB2YXIgdW56b25lZERhdGUgPSB1bnpvbmVkUmFuZ2UuZ2V0U3RhcnQoKTsNCiAgICAgICAgdmFyIHVuem9uZWRFbmQgPSB1bnpvbmVkUmFuZ2UuZ2V0RW5kKCk7DQogICAgICAgIHZhciB6b25lZERheVN0YXJ0Ow0KICAgICAgICB2YXIgaW5zdGFuY2VTdGFydDsNCiAgICAgICAgdmFyIGluc3RhbmNlRW5kOw0KICAgICAgICB2YXIgaW5zdGFuY2VzID0gW107DQogICAgICAgIHdoaWxlICh1bnpvbmVkRGF0ZS5pc0JlZm9yZSh1bnpvbmVkRW5kKSkgew0KICAgICAgICAgICAgLy8gaWYgZXZlcnlkYXksIG9yIHRoaXMgcGFydGljdWxhciBkYXktb2Ytd2Vlaw0KICAgICAgICAgICAgaWYgKCF0aGlzLmRvd0hhc2ggfHwgdGhpcy5kb3dIYXNoW3Vuem9uZWREYXRlLmRheSgpXSkgew0KICAgICAgICAgICAgICAgIHpvbmVkRGF5U3RhcnQgPSBjYWxlbmRhci5hcHBseVRpbWV6b25lKHVuem9uZWREYXRlKTsNCiAgICAgICAgICAgICAgICBpbnN0YW5jZVN0YXJ0ID0gem9uZWREYXlTdGFydC5jbG9uZSgpOw0KICAgICAgICAgICAgICAgIGluc3RhbmNlRW5kID0gbnVsbDsNCiAgICAgICAgICAgICAgICBpZiAodGhpcy5zdGFydFRpbWUpIHsNCiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VTdGFydC50aW1lKHRoaXMuc3RhcnRUaW1lKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIGluc3RhbmNlU3RhcnQuc3RyaXBUaW1lKCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmICh0aGlzLmVuZFRpbWUpIHsNCiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VFbmQgPSB6b25lZERheVN0YXJ0LmNsb25lKCkudGltZSh0aGlzLmVuZFRpbWUpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpbnN0YW5jZXMucHVzaChuZXcgRXZlbnRJbnN0YW5jZV8xLmRlZmF1bHQodGhpcywgLy8gZGVmaW5pdGlvbg0KICAgICAgICAgICAgICAgIG5ldyBFdmVudERhdGVQcm9maWxlXzEuZGVmYXVsdChpbnN0YW5jZVN0YXJ0LCBpbnN0YW5jZUVuZCwgY2FsZW5kYXIpKSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB1bnpvbmVkRGF0ZS5hZGQoMSwgJ2RheXMnKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gaW5zdGFuY2VzOw0KICAgIH07DQogICAgUmVjdXJyaW5nRXZlbnREZWYucHJvdG90eXBlLnNldERvdyA9IGZ1bmN0aW9uIChkb3dOdW1iZXJzKSB7DQogICAgICAgIGlmICghdGhpcy5kb3dIYXNoKSB7DQogICAgICAgICAgICB0aGlzLmRvd0hhc2ggPSB7fTsNCiAgICAgICAgfQ0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRvd051bWJlcnMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIHRoaXMuZG93SGFzaFtkb3dOdW1iZXJzW2ldXSA9IHRydWU7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIFJlY3VycmluZ0V2ZW50RGVmLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIGRlZiA9IF9zdXBlci5wcm90b3R5cGUuY2xvbmUuY2FsbCh0aGlzKTsNCiAgICAgICAgaWYgKGRlZi5zdGFydFRpbWUpIHsNCiAgICAgICAgICAgIGRlZi5zdGFydFRpbWUgPSBtb21lbnQuZHVyYXRpb24odGhpcy5zdGFydFRpbWUpOw0KICAgICAgICB9DQogICAgICAgIGlmIChkZWYuZW5kVGltZSkgew0KICAgICAgICAgICAgZGVmLmVuZFRpbWUgPSBtb21lbnQuZHVyYXRpb24odGhpcy5lbmRUaW1lKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAodGhpcy5kb3dIYXNoKSB7DQogICAgICAgICAgICBkZWYuZG93SGFzaCA9ICQuZXh0ZW5kKHt9LCB0aGlzLmRvd0hhc2gpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBkZWY7DQogICAgfTsNCiAgICByZXR1cm4gUmVjdXJyaW5nRXZlbnREZWY7DQp9KEV2ZW50RGVmXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gUmVjdXJyaW5nRXZlbnREZWY7DQovKg0KSEFDSyB0byB3b3JrIHdpdGggVHlwZVNjcmlwdCBtaXhpbnMNCk5PVEU6IGlmIHN1cGVyLW1ldGhvZCBmYWlscywgc2hvdWxkIHN0aWxsIGF0dGVtcHQgdG8gYXBwbHkNCiovDQpSZWN1cnJpbmdFdmVudERlZi5wcm90b3R5cGUuYXBwbHlQcm9wcyA9IGZ1bmN0aW9uIChyYXdQcm9wcykgew0KICAgIHZhciBzdXBlclN1Y2Nlc3MgPSBFdmVudERlZl8xLmRlZmF1bHQucHJvdG90eXBlLmFwcGx5UHJvcHMuY2FsbCh0aGlzLCByYXdQcm9wcyk7DQogICAgaWYgKHJhd1Byb3BzLnN0YXJ0KSB7DQogICAgICAgIHRoaXMuc3RhcnRUaW1lID0gbW9tZW50LmR1cmF0aW9uKHJhd1Byb3BzLnN0YXJ0KTsNCiAgICB9DQogICAgaWYgKHJhd1Byb3BzLmVuZCkgew0KICAgICAgICB0aGlzLmVuZFRpbWUgPSBtb21lbnQuZHVyYXRpb24ocmF3UHJvcHMuZW5kKTsNCiAgICB9DQogICAgaWYgKHJhd1Byb3BzLmRvdykgew0KICAgICAgICB0aGlzLnNldERvdyhyYXdQcm9wcy5kb3cpOw0KICAgIH0NCiAgICByZXR1cm4gc3VwZXJTdWNjZXNzOw0KfTsNCi8vIFBhcnNpbmcNCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KUmVjdXJyaW5nRXZlbnREZWYuZGVmaW5lU3RhbmRhcmRQcm9wcyh7DQogICAgc3RhcnQ6IGZhbHNlLA0KICAgIGVuZDogZmFsc2UsDQogICAgZG93OiBmYWxzZQ0KfSk7DQoKCi8qKiovIH0pLAovKiAyMTEgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciBFdmVudFJhbmdlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgew0KICAgIGZ1bmN0aW9uIEV2ZW50UmFuZ2UodW56b25lZFJhbmdlLCBldmVudERlZiwgZXZlbnRJbnN0YW5jZSkgew0KICAgICAgICB0aGlzLnVuem9uZWRSYW5nZSA9IHVuem9uZWRSYW5nZTsNCiAgICAgICAgdGhpcy5ldmVudERlZiA9IGV2ZW50RGVmOw0KICAgICAgICBpZiAoZXZlbnRJbnN0YW5jZSkgew0KICAgICAgICAgICAgdGhpcy5ldmVudEluc3RhbmNlID0gZXZlbnRJbnN0YW5jZTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4gRXZlbnRSYW5nZTsNCn0oKSk7DQpleHBvcnRzLmRlZmF1bHQgPSBFdmVudFJhbmdlOw0KCgovKioqLyB9KSwKLyogMjEyICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzNCk7DQp2YXIgRXZlbnRJbnN0YW5jZUdyb3VwXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE5KTsNCnZhciBSZWN1cnJpbmdFdmVudERlZl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMTApOw0KdmFyIEV2ZW50U291cmNlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpOw0KdmFyIEJVU0lORVNTX0hPVVJfRVZFTlRfREVGQVVMVFMgPSB7DQogICAgc3RhcnQ6ICcwOTowMCcsDQogICAgZW5kOiAnMTc6MDAnLA0KICAgIGRvdzogWzEsIDIsIDMsIDQsIDVdLA0KICAgIHJlbmRlcmluZzogJ2ludmVyc2UtYmFja2dyb3VuZCcNCiAgICAvLyBjbGFzc05hbWVzIGFyZSBkZWZpbmVkIGluIGJ1c2luZXNzSG91cnNTZWdDbGFzc2VzDQp9Ow0KdmFyIEJ1c2luZXNzSG91ckdlbmVyYXRvciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsNCiAgICBmdW5jdGlvbiBCdXNpbmVzc0hvdXJHZW5lcmF0b3IocmF3Q29tcGxleERlZiwgY2FsZW5kYXIpIHsNCiAgICAgICAgdGhpcy5yYXdDb21wbGV4RGVmID0gcmF3Q29tcGxleERlZjsNCiAgICAgICAgdGhpcy5jYWxlbmRhciA9IGNhbGVuZGFyOw0KICAgIH0NCiAgICBCdXNpbmVzc0hvdXJHZW5lcmF0b3IucHJvdG90eXBlLmJ1aWxkRXZlbnRJbnN0YW5jZUdyb3VwID0gZnVuY3Rpb24gKGlzQWxsRGF5LCB1bnpvbmVkUmFuZ2UpIHsNCiAgICAgICAgdmFyIGV2ZW50RGVmcyA9IHRoaXMuYnVpbGRFdmVudERlZnMoaXNBbGxEYXkpOw0KICAgICAgICB2YXIgZXZlbnRJbnN0YW5jZUdyb3VwOw0KICAgICAgICBpZiAoZXZlbnREZWZzLmxlbmd0aCkgew0KICAgICAgICAgICAgZXZlbnRJbnN0YW5jZUdyb3VwID0gbmV3IEV2ZW50SW5zdGFuY2VHcm91cF8xLmRlZmF1bHQodXRpbF8xLmV2ZW50RGVmc1RvRXZlbnRJbnN0YW5jZXMoZXZlbnREZWZzLCB1bnpvbmVkUmFuZ2UpKTsNCiAgICAgICAgICAgIC8vIHNvIHRoYXQgaW52ZXJzZS1iYWNrZ3JvdW5kIHJlbmRlcmluZyBjYW4gaGFwcGVuIGV2ZW4gd2hlbiBubyBldmVudFJhbmdlcyBpbiB2aWV3DQogICAgICAgICAgICBldmVudEluc3RhbmNlR3JvdXAuZXhwbGljaXRFdmVudERlZiA9IGV2ZW50RGVmc1swXTsNCiAgICAgICAgICAgIHJldHVybiBldmVudEluc3RhbmNlR3JvdXA7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIEJ1c2luZXNzSG91ckdlbmVyYXRvci5wcm90b3R5cGUuYnVpbGRFdmVudERlZnMgPSBmdW5jdGlvbiAoaXNBbGxEYXkpIHsNCiAgICAgICAgdmFyIHJhd0NvbXBsZXhEZWYgPSB0aGlzLnJhd0NvbXBsZXhEZWY7DQogICAgICAgIHZhciByYXdEZWZzID0gW107DQogICAgICAgIHZhciByZXF1aXJlRG93ID0gZmFsc2U7DQogICAgICAgIHZhciBpOw0KICAgICAgICB2YXIgZGVmcyA9IFtdOw0KICAgICAgICBpZiAocmF3Q29tcGxleERlZiA9PT0gdHJ1ZSkgew0KICAgICAgICAgICAgcmF3RGVmcyA9IFt7fV07IC8vIHdpbGwgZ2V0IEJVU0lORVNTX0hPVVJfRVZFTlRfREVGQVVMVFMgdmVyYmF0aW0NCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICgkLmlzUGxhaW5PYmplY3QocmF3Q29tcGxleERlZikpIHsNCiAgICAgICAgICAgIHJhd0RlZnMgPSBbcmF3Q29tcGxleERlZl07DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAoJC5pc0FycmF5KHJhd0NvbXBsZXhEZWYpKSB7DQogICAgICAgICAgICByYXdEZWZzID0gcmF3Q29tcGxleERlZjsNCiAgICAgICAgICAgIHJlcXVpcmVEb3cgPSB0cnVlOyAvLyBldmVyeSBzdWItZGVmaW5pdGlvbiBORUVEUyBhIGRheS1vZi13ZWVrDQogICAgICAgIH0NCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHJhd0RlZnMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIGlmICghcmVxdWlyZURvdyB8fCByYXdEZWZzW2ldLmRvdykgew0KICAgICAgICAgICAgICAgIGRlZnMucHVzaCh0aGlzLmJ1aWxkRXZlbnREZWYoaXNBbGxEYXksIHJhd0RlZnNbaV0pKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZGVmczsNCiAgICB9Ow0KICAgIEJ1c2luZXNzSG91ckdlbmVyYXRvci5wcm90b3R5cGUuYnVpbGRFdmVudERlZiA9IGZ1bmN0aW9uIChpc0FsbERheSwgcmF3RGVmKSB7DQogICAgICAgIHZhciBmdWxsUmF3RGVmID0gJC5leHRlbmQoe30sIEJVU0lORVNTX0hPVVJfRVZFTlRfREVGQVVMVFMsIHJhd0RlZik7DQogICAgICAgIGlmIChpc0FsbERheSkgew0KICAgICAgICAgICAgZnVsbFJhd0RlZi5zdGFydCA9IG51bGw7DQogICAgICAgICAgICBmdWxsUmF3RGVmLmVuZCA9IG51bGw7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIFJlY3VycmluZ0V2ZW50RGVmXzEuZGVmYXVsdC5wYXJzZShmdWxsUmF3RGVmLCBuZXcgRXZlbnRTb3VyY2VfMS5kZWZhdWx0KHRoaXMuY2FsZW5kYXIpIC8vIGR1bW15IHNvdXJjZQ0KICAgICAgICApOw0KICAgIH07DQogICAgcmV0dXJuIEJ1c2luZXNzSG91ckdlbmVyYXRvcjsNCn0oKSk7DQpleHBvcnRzLmRlZmF1bHQgPSBCdXNpbmVzc0hvdXJHZW5lcmF0b3I7DQoKCi8qKiovIH0pLAovKiAyMTMgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciBUaGVtZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzOCk7DQp2YXIgU3RhbmRhcmRUaGVtZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHsNCiAgICB0c2xpYl8xLl9fZXh0ZW5kcyhTdGFuZGFyZFRoZW1lLCBfc3VwZXIpOw0KICAgIGZ1bmN0aW9uIFN0YW5kYXJkVGhlbWUoKSB7DQogICAgICAgIHJldHVybiBfc3VwZXIgIT09IG51bGwgJiYgX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsNCiAgICB9DQogICAgcmV0dXJuIFN0YW5kYXJkVGhlbWU7DQp9KFRoZW1lXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gU3RhbmRhcmRUaGVtZTsNClN0YW5kYXJkVGhlbWUucHJvdG90eXBlLmNsYXNzZXMgPSB7DQogICAgd2lkZ2V0OiAnZmMtdW50aGVtZWQnLA0KICAgIHdpZGdldEhlYWRlcjogJ2ZjLXdpZGdldC1oZWFkZXInLA0KICAgIHdpZGdldENvbnRlbnQ6ICdmYy13aWRnZXQtY29udGVudCcsDQogICAgYnV0dG9uR3JvdXA6ICdmYy1idXR0b24tZ3JvdXAnLA0KICAgIGJ1dHRvbjogJ2ZjLWJ1dHRvbicsDQogICAgY29ybmVyTGVmdDogJ2ZjLWNvcm5lci1sZWZ0JywNCiAgICBjb3JuZXJSaWdodDogJ2ZjLWNvcm5lci1yaWdodCcsDQogICAgc3RhdGVEZWZhdWx0OiAnZmMtc3RhdGUtZGVmYXVsdCcsDQogICAgc3RhdGVBY3RpdmU6ICdmYy1zdGF0ZS1hY3RpdmUnLA0KICAgIHN0YXRlRGlzYWJsZWQ6ICdmYy1zdGF0ZS1kaXNhYmxlZCcsDQogICAgc3RhdGVIb3ZlcjogJ2ZjLXN0YXRlLWhvdmVyJywNCiAgICBzdGF0ZURvd246ICdmYy1zdGF0ZS1kb3duJywNCiAgICBwb3BvdmVySGVhZGVyOiAnZmMtd2lkZ2V0LWhlYWRlcicsDQogICAgcG9wb3ZlckNvbnRlbnQ6ICdmYy13aWRnZXQtY29udGVudCcsDQogICAgLy8gZGF5IGdyaWQNCiAgICBoZWFkZXJSb3c6ICdmYy13aWRnZXQtaGVhZGVyJywNCiAgICBkYXlSb3c6ICdmYy13aWRnZXQtY29udGVudCcsDQogICAgLy8gbGlzdCB2aWV3DQogICAgbGlzdFZpZXc6ICdmYy13aWRnZXQtY29udGVudCcNCn07DQpTdGFuZGFyZFRoZW1lLnByb3RvdHlwZS5iYXNlSWNvbkNsYXNzID0gJ2ZjLWljb24nOw0KU3RhbmRhcmRUaGVtZS5wcm90b3R5cGUuaWNvbkNsYXNzZXMgPSB7DQogICAgY2xvc2U6ICdmYy1pY29uLXgnLA0KICAgIHByZXY6ICdmYy1pY29uLWxlZnQtc2luZ2xlLWFycm93JywNCiAgICBuZXh0OiAnZmMtaWNvbi1yaWdodC1zaW5nbGUtYXJyb3cnLA0KICAgIHByZXZZZWFyOiAnZmMtaWNvbi1sZWZ0LWRvdWJsZS1hcnJvdycsDQogICAgbmV4dFllYXI6ICdmYy1pY29uLXJpZ2h0LWRvdWJsZS1hcnJvdycNCn07DQpTdGFuZGFyZFRoZW1lLnByb3RvdHlwZS5pY29uT3ZlcnJpZGVPcHRpb24gPSAnYnV0dG9uSWNvbnMnOw0KU3RhbmRhcmRUaGVtZS5wcm90b3R5cGUuaWNvbk92ZXJyaWRlQ3VzdG9tQnV0dG9uT3B0aW9uID0gJ2ljb24nOw0KU3RhbmRhcmRUaGVtZS5wcm90b3R5cGUuaWNvbk92ZXJyaWRlUHJlZml4ID0gJ2ZjLWljb24tJzsNCgoKLyoqKi8gfSksCi8qIDIxNCAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIHRzbGliXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIpOw0KdmFyIFRoZW1lXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM4KTsNCnZhciBKcXVlcnlVaVRoZW1lID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKEpxdWVyeVVpVGhlbWUsIF9zdXBlcik7DQogICAgZnVuY3Rpb24gSnF1ZXJ5VWlUaGVtZSgpIHsNCiAgICAgICAgcmV0dXJuIF9zdXBlciAhPT0gbnVsbCAmJiBfc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOw0KICAgIH0NCiAgICByZXR1cm4gSnF1ZXJ5VWlUaGVtZTsNCn0oVGhlbWVfMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBKcXVlcnlVaVRoZW1lOw0KSnF1ZXJ5VWlUaGVtZS5wcm90b3R5cGUuY2xhc3NlcyA9IHsNCiAgICB3aWRnZXQ6ICd1aS13aWRnZXQnLA0KICAgIHdpZGdldEhlYWRlcjogJ3VpLXdpZGdldC1oZWFkZXInLA0KICAgIHdpZGdldENvbnRlbnQ6ICd1aS13aWRnZXQtY29udGVudCcsDQogICAgYnV0dG9uR3JvdXA6ICdmYy1idXR0b24tZ3JvdXAnLA0KICAgIGJ1dHRvbjogJ3VpLWJ1dHRvbicsDQogICAgY29ybmVyTGVmdDogJ3VpLWNvcm5lci1sZWZ0JywNCiAgICBjb3JuZXJSaWdodDogJ3VpLWNvcm5lci1yaWdodCcsDQogICAgc3RhdGVEZWZhdWx0OiAndWktc3RhdGUtZGVmYXVsdCcsDQogICAgc3RhdGVBY3RpdmU6ICd1aS1zdGF0ZS1hY3RpdmUnLA0KICAgIHN0YXRlRGlzYWJsZWQ6ICd1aS1zdGF0ZS1kaXNhYmxlZCcsDQogICAgc3RhdGVIb3ZlcjogJ3VpLXN0YXRlLWhvdmVyJywNCiAgICBzdGF0ZURvd246ICd1aS1zdGF0ZS1kb3duJywNCiAgICB0b2RheTogJ3VpLXN0YXRlLWhpZ2hsaWdodCcsDQogICAgcG9wb3ZlckhlYWRlcjogJ3VpLXdpZGdldC1oZWFkZXInLA0KICAgIHBvcG92ZXJDb250ZW50OiAndWktd2lkZ2V0LWNvbnRlbnQnLA0KICAgIC8vIGRheSBncmlkDQogICAgaGVhZGVyUm93OiAndWktd2lkZ2V0LWhlYWRlcicsDQogICAgZGF5Um93OiAndWktd2lkZ2V0LWNvbnRlbnQnLA0KICAgIC8vIGxpc3Qgdmlldw0KICAgIGxpc3RWaWV3OiAndWktd2lkZ2V0LWNvbnRlbnQnDQp9Ow0KSnF1ZXJ5VWlUaGVtZS5wcm90b3R5cGUuYmFzZUljb25DbGFzcyA9ICd1aS1pY29uJzsNCkpxdWVyeVVpVGhlbWUucHJvdG90eXBlLmljb25DbGFzc2VzID0gew0KICAgIGNsb3NlOiAndWktaWNvbi1jbG9zZXRoaWNrJywNCiAgICBwcmV2OiAndWktaWNvbi1jaXJjbGUtdHJpYW5nbGUtdycsDQogICAgbmV4dDogJ3VpLWljb24tY2lyY2xlLXRyaWFuZ2xlLWUnLA0KICAgIHByZXZZZWFyOiAndWktaWNvbi1zZWVrLXByZXYnLA0KICAgIG5leHRZZWFyOiAndWktaWNvbi1zZWVrLW5leHQnDQp9Ow0KSnF1ZXJ5VWlUaGVtZS5wcm90b3R5cGUuaWNvbk92ZXJyaWRlT3B0aW9uID0gJ3RoZW1lQnV0dG9uSWNvbnMnOw0KSnF1ZXJ5VWlUaGVtZS5wcm90b3R5cGUuaWNvbk92ZXJyaWRlQ3VzdG9tQnV0dG9uT3B0aW9uID0gJ3RoZW1lSWNvbic7DQpKcXVlcnlVaVRoZW1lLnByb3RvdHlwZS5pY29uT3ZlcnJpZGVQcmVmaXggPSAndWktaWNvbi0nOw0KCgovKioqLyB9KSwKLyogMjE1ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdHNsaWJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgUHJvbWlzZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMCk7DQp2YXIgRXZlbnRTb3VyY2VfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNik7DQp2YXIgRnVuY0V2ZW50U291cmNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKEZ1bmNFdmVudFNvdXJjZSwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBGdW5jRXZlbnRTb3VyY2UoKSB7DQogICAgICAgIHJldHVybiBfc3VwZXIgIT09IG51bGwgJiYgX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsNCiAgICB9DQogICAgRnVuY0V2ZW50U291cmNlLnBhcnNlID0gZnVuY3Rpb24gKHJhd0lucHV0LCBjYWxlbmRhcikgew0KICAgICAgICB2YXIgcmF3UHJvcHM7DQogICAgICAgIC8vIG5vcm1hbGl6ZSByYXcgaW5wdXQNCiAgICAgICAgaWYgKCQuaXNGdW5jdGlvbihyYXdJbnB1dC5ldmVudHMpKSB7DQogICAgICAgICAgICByYXdQcm9wcyA9IHJhd0lucHV0Ow0KICAgICAgICB9DQogICAgICAgIGVsc2UgaWYgKCQuaXNGdW5jdGlvbihyYXdJbnB1dCkpIHsNCiAgICAgICAgICAgIHJhd1Byb3BzID0geyBldmVudHM6IHJhd0lucHV0IH07DQogICAgICAgIH0NCiAgICAgICAgaWYgKHJhd1Byb3BzKSB7DQogICAgICAgICAgICByZXR1cm4gRXZlbnRTb3VyY2VfMS5kZWZhdWx0LnBhcnNlLmNhbGwodGhpcywgcmF3UHJvcHMsIGNhbGVuZGFyKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgfTsNCiAgICBGdW5jRXZlbnRTb3VyY2UucHJvdG90eXBlLmZldGNoID0gZnVuY3Rpb24gKHN0YXJ0LCBlbmQsIHRpbWV6b25lKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIHRoaXMuY2FsZW5kYXIucHVzaExvYWRpbmcoKTsNCiAgICAgICAgcmV0dXJuIFByb21pc2VfMS5kZWZhdWx0LmNvbnN0cnVjdChmdW5jdGlvbiAob25SZXNvbHZlKSB7DQogICAgICAgICAgICBfdGhpcy5mdW5jLmNhbGwoX3RoaXMuY2FsZW5kYXIsIHN0YXJ0LmNsb25lKCksIGVuZC5jbG9uZSgpLCB0aW1lem9uZSwgZnVuY3Rpb24gKHJhd0V2ZW50RGVmcykgew0KICAgICAgICAgICAgICAgIF90aGlzLmNhbGVuZGFyLnBvcExvYWRpbmcoKTsNCiAgICAgICAgICAgICAgICBvblJlc29sdmUoX3RoaXMucGFyc2VFdmVudERlZnMocmF3RXZlbnREZWZzKSk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfSk7DQogICAgfTsNCiAgICBGdW5jRXZlbnRTb3VyY2UucHJvdG90eXBlLmdldFByaW1pdGl2ZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZnVuYzsNCiAgICB9Ow0KICAgIEZ1bmNFdmVudFNvdXJjZS5wcm90b3R5cGUuYXBwbHlNYW51YWxTdGFuZGFyZFByb3BzID0gZnVuY3Rpb24gKHJhd1Byb3BzKSB7DQogICAgICAgIHZhciBzdXBlclN1Y2Nlc3MgPSBfc3VwZXIucHJvdG90eXBlLmFwcGx5TWFudWFsU3RhbmRhcmRQcm9wcy5jYWxsKHRoaXMsIHJhd1Byb3BzKTsNCiAgICAgICAgdGhpcy5mdW5jID0gcmF3UHJvcHMuZXZlbnRzOw0KICAgICAgICByZXR1cm4gc3VwZXJTdWNjZXNzOw0KICAgIH07DQogICAgcmV0dXJuIEZ1bmNFdmVudFNvdXJjZTsNCn0oRXZlbnRTb3VyY2VfMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBGdW5jRXZlbnRTb3VyY2U7DQpGdW5jRXZlbnRTb3VyY2UuZGVmaW5lU3RhbmRhcmRQcm9wcyh7DQogICAgZXZlbnRzOiBmYWxzZSAvLyBkb24ndCBhdXRvbWF0aWNhbGx5IHRyYW5zZmVyDQp9KTsNCgoKLyoqKi8gfSksCi8qIDIxNiAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIHRzbGliXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIpOw0KdmFyICQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgUHJvbWlzZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMCk7DQp2YXIgRXZlbnRTb3VyY2VfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNik7DQp2YXIgSnNvbkZlZWRFdmVudFNvdXJjZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHsNCiAgICB0c2xpYl8xLl9fZXh0ZW5kcyhKc29uRmVlZEV2ZW50U291cmNlLCBfc3VwZXIpOw0KICAgIGZ1bmN0aW9uIEpzb25GZWVkRXZlbnRTb3VyY2UoKSB7DQogICAgICAgIHJldHVybiBfc3VwZXIgIT09IG51bGwgJiYgX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsNCiAgICB9DQogICAgSnNvbkZlZWRFdmVudFNvdXJjZS5wYXJzZSA9IGZ1bmN0aW9uIChyYXdJbnB1dCwgY2FsZW5kYXIpIHsNCiAgICAgICAgdmFyIHJhd1Byb3BzOw0KICAgICAgICAvLyBub3JtYWxpemUgcmF3IGlucHV0DQogICAgICAgIGlmICh0eXBlb2YgcmF3SW5wdXQudXJsID09PSAnc3RyaW5nJykgew0KICAgICAgICAgICAgcmF3UHJvcHMgPSByYXdJbnB1dDsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICh0eXBlb2YgcmF3SW5wdXQgPT09ICdzdHJpbmcnKSB7DQogICAgICAgICAgICByYXdQcm9wcyA9IHsgdXJsOiByYXdJbnB1dCB9Ow0KICAgICAgICB9DQogICAgICAgIGlmIChyYXdQcm9wcykgew0KICAgICAgICAgICAgcmV0dXJuIEV2ZW50U291cmNlXzEuZGVmYXVsdC5wYXJzZS5jYWxsKHRoaXMsIHJhd1Byb3BzLCBjYWxlbmRhcik7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH07DQogICAgSnNvbkZlZWRFdmVudFNvdXJjZS5wcm90b3R5cGUuZmV0Y2ggPSBmdW5jdGlvbiAoc3RhcnQsIGVuZCwgdGltZXpvbmUpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgdmFyIGFqYXhTZXR0aW5ncyA9IHRoaXMuYWpheFNldHRpbmdzOw0KICAgICAgICB2YXIgb25TdWNjZXNzID0gYWpheFNldHRpbmdzLnN1Y2Nlc3M7DQogICAgICAgIHZhciBvbkVycm9yID0gYWpheFNldHRpbmdzLmVycm9yOw0KICAgICAgICB2YXIgcmVxdWVzdFBhcmFtcyA9IHRoaXMuYnVpbGRSZXF1ZXN0UGFyYW1zKHN0YXJ0LCBlbmQsIHRpbWV6b25lKTsNCiAgICAgICAgLy8gdG9kbzogZXZlbnR1YWxseSBoYW5kbGUgdGhlIHByb21pc2UncyB0aGVuLA0KICAgICAgICAvLyBkb24ndCBpbnRlcmNlcHQgc3VjY2Vzcy9lcnJvcg0KICAgICAgICAvLyB0aG8gd2lsbCBiZSBhIGJyZWFraW5nIEFQSSBjaGFuZ2UNCiAgICAgICAgdGhpcy5jYWxlbmRhci5wdXNoTG9hZGluZygpOw0KICAgICAgICByZXR1cm4gUHJvbWlzZV8xLmRlZmF1bHQuY29uc3RydWN0KGZ1bmN0aW9uIChvblJlc29sdmUsIG9uUmVqZWN0KSB7DQogICAgICAgICAgICAkLmFqYXgoJC5leHRlbmQoe30sIC8vIGRlc3RpbmF0aW9uDQogICAgICAgICAgICBKc29uRmVlZEV2ZW50U291cmNlLkFKQVhfREVGQVVMVFMsIGFqYXhTZXR0aW5ncywgew0KICAgICAgICAgICAgICAgIHVybDogX3RoaXMudXJsLA0KICAgICAgICAgICAgICAgIGRhdGE6IHJlcXVlc3RQYXJhbXMsDQogICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKHJhd0V2ZW50RGVmcywgc3RhdHVzLCB4aHIpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrUmVzOw0KICAgICAgICAgICAgICAgICAgICBfdGhpcy5jYWxlbmRhci5wb3BMb2FkaW5nKCk7DQogICAgICAgICAgICAgICAgICAgIGlmIChyYXdFdmVudERlZnMpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrUmVzID0gdXRpbF8xLmFwcGx5QWxsKG9uU3VjY2VzcywgX3RoaXMsIFtyYXdFdmVudERlZnMsIHN0YXR1cywgeGhyXSk7IC8vIHJlZGlyZWN0IGB0aGlzYA0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQuaXNBcnJheShjYWxsYmFja1JlcykpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXdFdmVudERlZnMgPSBjYWxsYmFja1JlczsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIG9uUmVzb2x2ZShfdGhpcy5wYXJzZUV2ZW50RGVmcyhyYXdFdmVudERlZnMpKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIG9uUmVqZWN0KCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbiAoeGhyLCBzdGF0dXNUZXh0LCBlcnJvclRocm93bikgew0KICAgICAgICAgICAgICAgICAgICBfdGhpcy5jYWxlbmRhci5wb3BMb2FkaW5nKCk7DQogICAgICAgICAgICAgICAgICAgIHV0aWxfMS5hcHBseUFsbChvbkVycm9yLCBfdGhpcywgW3hociwgc3RhdHVzVGV4dCwgZXJyb3JUaHJvd25dKTsgLy8gcmVkaXJlY3QgYHRoaXNgDQogICAgICAgICAgICAgICAgICAgIG9uUmVqZWN0KCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSkpOw0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIEpzb25GZWVkRXZlbnRTb3VyY2UucHJvdG90eXBlLmJ1aWxkUmVxdWVzdFBhcmFtcyA9IGZ1bmN0aW9uIChzdGFydCwgZW5kLCB0aW1lem9uZSkgew0KICAgICAgICB2YXIgY2FsZW5kYXIgPSB0aGlzLmNhbGVuZGFyOw0KICAgICAgICB2YXIgYWpheFNldHRpbmdzID0gdGhpcy5hamF4U2V0dGluZ3M7DQogICAgICAgIHZhciBzdGFydFBhcmFtOw0KICAgICAgICB2YXIgZW5kUGFyYW07DQogICAgICAgIHZhciB0aW1lem9uZVBhcmFtOw0KICAgICAgICB2YXIgY3VzdG9tUmVxdWVzdFBhcmFtczsNCiAgICAgICAgdmFyIHBhcmFtcyA9IHt9Ow0KICAgICAgICBzdGFydFBhcmFtID0gdGhpcy5zdGFydFBhcmFtOw0KICAgICAgICBpZiAoc3RhcnRQYXJhbSA9PSBudWxsKSB7DQogICAgICAgICAgICBzdGFydFBhcmFtID0gY2FsZW5kYXIub3B0KCdzdGFydFBhcmFtJyk7DQogICAgICAgIH0NCiAgICAgICAgZW5kUGFyYW0gPSB0aGlzLmVuZFBhcmFtOw0KICAgICAgICBpZiAoZW5kUGFyYW0gPT0gbnVsbCkgew0KICAgICAgICAgICAgZW5kUGFyYW0gPSBjYWxlbmRhci5vcHQoJ2VuZFBhcmFtJyk7DQogICAgICAgIH0NCiAgICAgICAgdGltZXpvbmVQYXJhbSA9IHRoaXMudGltZXpvbmVQYXJhbTsNCiAgICAgICAgaWYgKHRpbWV6b25lUGFyYW0gPT0gbnVsbCkgew0KICAgICAgICAgICAgdGltZXpvbmVQYXJhbSA9IGNhbGVuZGFyLm9wdCgndGltZXpvbmVQYXJhbScpOw0KICAgICAgICB9DQogICAgICAgIC8vIHJldHJpZXZlIGFueSBvdXRib3VuZCBHRVQvUE9TVCAkLmFqYXggZGF0YSBmcm9tIHRoZSBvcHRpb25zDQogICAgICAgIGlmICgkLmlzRnVuY3Rpb24oYWpheFNldHRpbmdzLmRhdGEpKSB7DQogICAgICAgICAgICAvLyBzdXBwbGllZCBhcyBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhIGtleS92YWx1ZSBvYmplY3QNCiAgICAgICAgICAgIGN1c3RvbVJlcXVlc3RQYXJhbXMgPSBhamF4U2V0dGluZ3MuZGF0YSgpOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgLy8gcHJvYmFibHkgc3VwcGxpZWQgYXMgYSBzdHJhaWdodCBrZXkvdmFsdWUgb2JqZWN0DQogICAgICAgICAgICBjdXN0b21SZXF1ZXN0UGFyYW1zID0gYWpheFNldHRpbmdzLmRhdGEgfHwge307DQogICAgICAgIH0NCiAgICAgICAgJC5leHRlbmQocGFyYW1zLCBjdXN0b21SZXF1ZXN0UGFyYW1zKTsNCiAgICAgICAgcGFyYW1zW3N0YXJ0UGFyYW1dID0gc3RhcnQuZm9ybWF0KCk7DQogICAgICAgIHBhcmFtc1tlbmRQYXJhbV0gPSBlbmQuZm9ybWF0KCk7DQogICAgICAgIGlmICh0aW1lem9uZSAmJiB0aW1lem9uZSAhPT0gJ2xvY2FsJykgew0KICAgICAgICAgICAgcGFyYW1zW3RpbWV6b25lUGFyYW1dID0gdGltZXpvbmU7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHBhcmFtczsNCiAgICB9Ow0KICAgIEpzb25GZWVkRXZlbnRTb3VyY2UucHJvdG90eXBlLmdldFByaW1pdGl2ZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMudXJsOw0KICAgIH07DQogICAgSnNvbkZlZWRFdmVudFNvdXJjZS5wcm90b3R5cGUuYXBwbHlNaXNjUHJvcHMgPSBmdW5jdGlvbiAocmF3UHJvcHMpIHsNCiAgICAgICAgdGhpcy5hamF4U2V0dGluZ3MgPSByYXdQcm9wczsNCiAgICB9Ow0KICAgIEpzb25GZWVkRXZlbnRTb3VyY2UuQUpBWF9ERUZBVUxUUyA9IHsNCiAgICAgICAgZGF0YVR5cGU6ICdqc29uJywNCiAgICAgICAgY2FjaGU6IGZhbHNlDQogICAgfTsNCiAgICByZXR1cm4gSnNvbkZlZWRFdmVudFNvdXJjZTsNCn0oRXZlbnRTb3VyY2VfMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBKc29uRmVlZEV2ZW50U291cmNlOw0KSnNvbkZlZWRFdmVudFNvdXJjZS5kZWZpbmVTdGFuZGFyZFByb3BzKHsNCiAgICAvLyBhdXRvbWF0aWNhbGx5IHRyYW5zZmVyICh0cnVlKS4uLg0KICAgIHVybDogdHJ1ZSwNCiAgICBzdGFydFBhcmFtOiB0cnVlLA0KICAgIGVuZFBhcmFtOiB0cnVlLA0KICAgIHRpbWV6b25lUGFyYW06IHRydWUNCn0pOw0KCgovKioqLyB9KSwKLyogMjE3ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgRW1pdHRlck1peGluXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDExKTsNCnZhciBUYXNrUXVldWUgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7DQogICAgZnVuY3Rpb24gVGFza1F1ZXVlKCkgew0KICAgICAgICB0aGlzLnEgPSBbXTsNCiAgICAgICAgdGhpcy5pc1BhdXNlZCA9IGZhbHNlOw0KICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOw0KICAgIH0NCiAgICBUYXNrUXVldWUucHJvdG90eXBlLnF1ZXVlID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgYXJncyA9IFtdOw0KICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykgew0KICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2ldOw0KICAgICAgICB9DQogICAgICAgIHRoaXMucS5wdXNoLmFwcGx5KHRoaXMucSwgYXJncyk7IC8vIGFwcGVuZA0KICAgICAgICB0aGlzLnRyeVN0YXJ0KCk7DQogICAgfTsNCiAgICBUYXNrUXVldWUucHJvdG90eXBlLnBhdXNlID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLmlzUGF1c2VkID0gdHJ1ZTsNCiAgICB9Ow0KICAgIFRhc2tRdWV1ZS5wcm90b3R5cGUucmVzdW1lID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLmlzUGF1c2VkID0gZmFsc2U7DQogICAgICAgIHRoaXMudHJ5U3RhcnQoKTsNCiAgICB9Ow0KICAgIFRhc2tRdWV1ZS5wcm90b3R5cGUuZ2V0SXNJZGxlID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gIXRoaXMuaXNSdW5uaW5nICYmICF0aGlzLmlzUGF1c2VkOw0KICAgIH07DQogICAgVGFza1F1ZXVlLnByb3RvdHlwZS50cnlTdGFydCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKCF0aGlzLmlzUnVubmluZyAmJiB0aGlzLmNhblJ1bk5leHQoKSkgew0KICAgICAgICAgICAgdGhpcy5pc1J1bm5pbmcgPSB0cnVlOw0KICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdzdGFydCcpOw0KICAgICAgICAgICAgdGhpcy5ydW5SZW1haW5pbmcoKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgVGFza1F1ZXVlLnByb3RvdHlwZS5jYW5SdW5OZXh0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gIXRoaXMuaXNQYXVzZWQgJiYgdGhpcy5xLmxlbmd0aDsNCiAgICB9Ow0KICAgIFRhc2tRdWV1ZS5wcm90b3R5cGUucnVuUmVtYWluaW5nID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICB2YXIgdGFzazsNCiAgICAgICAgdmFyIHJlczsNCiAgICAgICAgZG8gew0KICAgICAgICAgICAgdGFzayA9IHRoaXMucS5zaGlmdCgpOyAvLyBhbHdheXMgZnJlc2hseSByZWZlcmVuY2UgcS4gbWlnaHQgaGF2ZSBiZWVuIHJlYXNzaWduZWQuDQogICAgICAgICAgICByZXMgPSB0aGlzLnJ1blRhc2sodGFzayk7DQogICAgICAgICAgICBpZiAocmVzICYmIHJlcy50aGVuKSB7DQogICAgICAgICAgICAgICAgcmVzLnRoZW4oZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMuY2FuUnVuTmV4dCgpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5ydW5SZW1haW5pbmcoKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIHJldHVybjsgLy8gcHJldmVudCBtYXJraW5nIGFzIHN0b3BwZWQNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSB3aGlsZSAodGhpcy5jYW5SdW5OZXh0KCkpOw0KICAgICAgICB0aGlzLnRyaWdnZXIoJ3N0b3AnKTsgLy8gbm90IHJlYWxseSBhICdzdG9wJyAuLi4gbW9yZSBvZiBhICdkcmFpbmVkJw0KICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOw0KICAgICAgICAvLyBpZiAnc3RvcCcgaGFuZGxlciBhZGRlZCBtb3JlIHRhc2tzLi4uLiBUT0RPOiB3cml0ZSB0ZXN0IGZvciB0aGlzDQogICAgICAgIHRoaXMudHJ5U3RhcnQoKTsNCiAgICB9Ow0KICAgIFRhc2tRdWV1ZS5wcm90b3R5cGUucnVuVGFzayA9IGZ1bmN0aW9uICh0YXNrKSB7DQogICAgICAgIHJldHVybiB0YXNrKCk7IC8vIHRhc2sgKmlzKiB0aGUgZnVuY3Rpb24sIGJ1dCBzdWJjbGFzc2VzIGNhbiBjaGFuZ2UgdGhlIGZvcm1hdCBvZiBhIHRhc2sNCiAgICB9Ow0KICAgIHJldHVybiBUYXNrUXVldWU7DQp9KCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gVGFza1F1ZXVlOw0KRW1pdHRlck1peGluXzEuZGVmYXVsdC5taXhJbnRvKFRhc2tRdWV1ZSk7DQoKCi8qKiovIH0pLAovKiAyMTggKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciBUYXNrUXVldWVfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjE3KTsNCnZhciBSZW5kZXJRdWV1ZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHsNCiAgICB0c2xpYl8xLl9fZXh0ZW5kcyhSZW5kZXJRdWV1ZSwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBSZW5kZXJRdWV1ZSh3YWl0c0J5TmFtZXNwYWNlKSB7DQogICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpIHx8IHRoaXM7DQogICAgICAgIF90aGlzLndhaXRzQnlOYW1lc3BhY2UgPSB3YWl0c0J5TmFtZXNwYWNlIHx8IHt9Ow0KICAgICAgICByZXR1cm4gX3RoaXM7DQogICAgfQ0KICAgIFJlbmRlclF1ZXVlLnByb3RvdHlwZS5xdWV1ZSA9IGZ1bmN0aW9uICh0YXNrRnVuYywgbmFtZXNwYWNlLCB0eXBlKSB7DQogICAgICAgIHZhciB0YXNrID0gew0KICAgICAgICAgICAgZnVuYzogdGFza0Z1bmMsDQogICAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZSwNCiAgICAgICAgICAgIHR5cGU6IHR5cGUNCiAgICAgICAgfTsNCiAgICAgICAgdmFyIHdhaXRNczsNCiAgICAgICAgaWYgKG5hbWVzcGFjZSkgew0KICAgICAgICAgICAgd2FpdE1zID0gdGhpcy53YWl0c0J5TmFtZXNwYWNlW25hbWVzcGFjZV07DQogICAgICAgIH0NCiAgICAgICAgaWYgKHRoaXMud2FpdE5hbWVzcGFjZSkgew0KICAgICAgICAgICAgaWYgKG5hbWVzcGFjZSA9PT0gdGhpcy53YWl0TmFtZXNwYWNlICYmIHdhaXRNcyAhPSBudWxsKSB7DQogICAgICAgICAgICAgICAgdGhpcy5kZWxheVdhaXQod2FpdE1zKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJXYWl0KCk7DQogICAgICAgICAgICAgICAgdGhpcy50cnlTdGFydCgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGlmICh0aGlzLmNvbXBvdW5kVGFzayh0YXNrKSkgew0KICAgICAgICAgICAgaWYgKCF0aGlzLndhaXROYW1lc3BhY2UgJiYgd2FpdE1zICE9IG51bGwpIHsNCiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0V2FpdChuYW1lc3BhY2UsIHdhaXRNcyk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICB0aGlzLnRyeVN0YXJ0KCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9Ow0KICAgIFJlbmRlclF1ZXVlLnByb3RvdHlwZS5zdGFydFdhaXQgPSBmdW5jdGlvbiAobmFtZXNwYWNlLCB3YWl0TXMpIHsNCiAgICAgICAgdGhpcy53YWl0TmFtZXNwYWNlID0gbmFtZXNwYWNlOw0KICAgICAgICB0aGlzLnNwYXduV2FpdCh3YWl0TXMpOw0KICAgIH07DQogICAgUmVuZGVyUXVldWUucHJvdG90eXBlLmRlbGF5V2FpdCA9IGZ1bmN0aW9uICh3YWl0TXMpIHsNCiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMud2FpdElkKTsNCiAgICAgICAgdGhpcy5zcGF3bldhaXQod2FpdE1zKTsNCiAgICB9Ow0KICAgIFJlbmRlclF1ZXVlLnByb3RvdHlwZS5zcGF3bldhaXQgPSBmdW5jdGlvbiAod2FpdE1zKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIHRoaXMud2FpdElkID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICBfdGhpcy53YWl0TmFtZXNwYWNlID0gbnVsbDsNCiAgICAgICAgICAgIF90aGlzLnRyeVN0YXJ0KCk7DQogICAgICAgIH0sIHdhaXRNcyk7DQogICAgfTsNCiAgICBSZW5kZXJRdWV1ZS5wcm90b3R5cGUuY2xlYXJXYWl0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy53YWl0TmFtZXNwYWNlKSB7DQogICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy53YWl0SWQpOw0KICAgICAgICAgICAgdGhpcy53YWl0SWQgPSBudWxsOw0KICAgICAgICAgICAgdGhpcy53YWl0TmFtZXNwYWNlID0gbnVsbDsNCiAgICAgICAgfQ0KICAgIH07DQogICAgUmVuZGVyUXVldWUucHJvdG90eXBlLmNhblJ1bk5leHQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICghX3N1cGVyLnByb3RvdHlwZS5jYW5SdW5OZXh0LmNhbGwodGhpcykpIHsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfQ0KICAgICAgICAvLyB3YWl0aW5nIGZvciBhIGNlcnRhaW4gbmFtZXNwYWNlIHRvIHN0b3AgcmVjZWl2aW5nIHRhc2tzPw0KICAgICAgICBpZiAodGhpcy53YWl0TmFtZXNwYWNlKSB7DQogICAgICAgICAgICB2YXIgcSA9IHRoaXMucTsNCiAgICAgICAgICAgIC8vIGlmIHRoZXJlIHdhcyBhIGRpZmZlcmVudCBuYW1lc3BhY2UgdGFzayBpbiB0aGUgbWVhbnRpbWUsDQogICAgICAgICAgICAvLyB0aGF0IGZvcmNlcyBhbGwgcHJldmlvdXNseS13YWl0aW5nIHRhc2tzIHRvIHN1ZGRlbmx5IGV4ZWN1dGUuDQogICAgICAgICAgICAvLyBUT0RPOiBmaW5kIGEgd2F5IHRvIGRvIHRoaXMgaW4gY29uc3RhbnQgdGltZS4NCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcS5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgIGlmIChxW2ldLm5hbWVzcGFjZSAhPT0gdGhpcy53YWl0TmFtZXNwYWNlKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBhbGxvdyBleGVjdXRpb24NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgfTsNCiAgICBSZW5kZXJRdWV1ZS5wcm90b3R5cGUucnVuVGFzayA9IGZ1bmN0aW9uICh0YXNrKSB7DQogICAgICAgIHRhc2suZnVuYygpOw0KICAgIH07DQogICAgUmVuZGVyUXVldWUucHJvdG90eXBlLmNvbXBvdW5kVGFzayA9IGZ1bmN0aW9uIChuZXdUYXNrKSB7DQogICAgICAgIHZhciBxID0gdGhpcy5xOw0KICAgICAgICB2YXIgc2hvdWxkQXBwZW5kID0gdHJ1ZTsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIHZhciB0YXNrOw0KICAgICAgICBpZiAobmV3VGFzay5uYW1lc3BhY2UgJiYgbmV3VGFzay50eXBlID09PSAnZGVzdHJveScpIHsNCiAgICAgICAgICAgIC8vIHJlbW92ZSBhbGwgaW5pdC9hZGQvcmVtb3ZlIG9wcyB3aXRoIHNhbWUgbmFtZXNwYWNlLCByZWdhcmRsZXNzIG9mIG9yZGVyDQogICAgICAgICAgICBmb3IgKGkgPSBxLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7DQogICAgICAgICAgICAgICAgdGFzayA9IHFbaV07DQogICAgICAgICAgICAgICAgc3dpdGNoICh0YXNrLnR5cGUpIHsNCiAgICAgICAgICAgICAgICAgICAgY2FzZSAnaW5pdCc6DQogICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRBcHBlbmQgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgLy8gdGhlIGxhdGVzdCBkZXN0cm95IGlzIGNhbmNlbGxlZCBvdXQgYnkgbm90IGRvaW5nIHRoZSBpbml0DQogICAgICAgICAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8NCiAgICAgICAgICAgICAgICAgICAgY2FzZSAnYWRkJzoNCiAgICAgICAgICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLw0KICAgICAgICAgICAgICAgICAgICBjYXNlICdyZW1vdmUnOg0KICAgICAgICAgICAgICAgICAgICAgICAgcS5zcGxpY2UoaSwgMSk7IC8vIHJlbW92ZSB0YXNrDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGlmIChzaG91bGRBcHBlbmQpIHsNCiAgICAgICAgICAgIHEucHVzaChuZXdUYXNrKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gc2hvdWxkQXBwZW5kOw0KICAgIH07DQogICAgcmV0dXJuIFJlbmRlclF1ZXVlOw0KfShUYXNrUXVldWVfMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBSZW5kZXJRdWV1ZTsNCgoKLyoqKi8gfSksCi8qIDIxOSAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIHRzbGliXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIpOw0KdmFyICQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOw0KdmFyIG1vbWVudCA9IF9fd2VicGFja19yZXF1aXJlX18oMCk7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCnZhciBtb21lbnRfZXh0XzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDEwKTsNCnZhciBkYXRlX2Zvcm1hdHRpbmdfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNDcpOw0KdmFyIENvbXBvbmVudF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMzcpOw0KdmFyIHV0aWxfMiA9IF9fd2VicGFja19yZXF1aXJlX18oMzQpOw0KdmFyIERhdGVDb21wb25lbnQgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoRGF0ZUNvbXBvbmVudCwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBEYXRlQ29tcG9uZW50KF92aWV3LCBfb3B0aW9ucykgew0KICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKSB8fCB0aGlzOw0KICAgICAgICBfdGhpcy5pc1JUTCA9IGZhbHNlOyAvLyBmcmVxdWVudGx5IGFjY2Vzc2VkIG9wdGlvbnMNCiAgICAgICAgX3RoaXMuaGl0c05lZWRlZERlcHRoID0gMDsgLy8gbmVjZXNzYXJ5IGJlY2F1c2UgbXVsdGlwbGUgY2FsbGVycyBtaWdodCBuZWVkIHRoZSBzYW1lIGhpdHMNCiAgICAgICAgX3RoaXMuaGFzQWxsRGF5QnVzaW5lc3NIb3VycyA9IGZhbHNlOyAvLyBUT0RPOiB1bmlmeSB3aXRoIGxhcmdlVW5pdCBhbmQgaXNUaW1lU2NhbGU/DQogICAgICAgIF90aGlzLmlzRGF0ZXNSZW5kZXJlZCA9IGZhbHNlOw0KICAgICAgICAvLyBoYWNrIHRvIHNldCBvcHRpb25zIHByaW9yIHRvIHRoZSB0aGlzLm9wdCBjYWxscw0KICAgICAgICBpZiAoX3ZpZXcpIHsNCiAgICAgICAgICAgIF90aGlzWyd2aWV3J10gPSBfdmlldzsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoX29wdGlvbnMpIHsNCiAgICAgICAgICAgIF90aGlzWydvcHRpb25zJ10gPSBfb3B0aW9uczsNCiAgICAgICAgfQ0KICAgICAgICBfdGhpcy51aWQgPSBTdHJpbmcoRGF0ZUNvbXBvbmVudC5ndWlkKyspOw0KICAgICAgICBfdGhpcy5jaGlsZHJlbkJ5VWlkID0ge307DQogICAgICAgIF90aGlzLm5leHREYXlUaHJlc2hvbGQgPSBtb21lbnQuZHVyYXRpb24oX3RoaXMub3B0KCduZXh0RGF5VGhyZXNob2xkJykpOw0KICAgICAgICBfdGhpcy5pc1JUTCA9IF90aGlzLm9wdCgnaXNSVEwnKTsNCiAgICAgICAgaWYgKF90aGlzLmZpbGxSZW5kZXJlckNsYXNzKSB7DQogICAgICAgICAgICBfdGhpcy5maWxsUmVuZGVyZXIgPSBuZXcgX3RoaXMuZmlsbFJlbmRlcmVyQ2xhc3MoX3RoaXMpOw0KICAgICAgICB9DQogICAgICAgIGlmIChfdGhpcy5ldmVudFJlbmRlcmVyQ2xhc3MpIHsNCiAgICAgICAgICAgIF90aGlzLmV2ZW50UmVuZGVyZXIgPSBuZXcgX3RoaXMuZXZlbnRSZW5kZXJlckNsYXNzKF90aGlzLCBfdGhpcy5maWxsUmVuZGVyZXIpOw0KICAgICAgICB9DQogICAgICAgIGlmIChfdGhpcy5oZWxwZXJSZW5kZXJlckNsYXNzICYmIF90aGlzLmV2ZW50UmVuZGVyZXIpIHsNCiAgICAgICAgICAgIF90aGlzLmhlbHBlclJlbmRlcmVyID0gbmV3IF90aGlzLmhlbHBlclJlbmRlcmVyQ2xhc3MoX3RoaXMsIF90aGlzLmV2ZW50UmVuZGVyZXIpOw0KICAgICAgICB9DQogICAgICAgIGlmIChfdGhpcy5idXNpbmVzc0hvdXJSZW5kZXJlckNsYXNzICYmIF90aGlzLmZpbGxSZW5kZXJlcikgew0KICAgICAgICAgICAgX3RoaXMuYnVzaW5lc3NIb3VyUmVuZGVyZXIgPSBuZXcgX3RoaXMuYnVzaW5lc3NIb3VyUmVuZGVyZXJDbGFzcyhfdGhpcywgX3RoaXMuZmlsbFJlbmRlcmVyKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gX3RoaXM7DQogICAgfQ0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLmFkZENoaWxkID0gZnVuY3Rpb24gKGNoaWxkKSB7DQogICAgICAgIGlmICghdGhpcy5jaGlsZHJlbkJ5VWlkW2NoaWxkLnVpZF0pIHsNCiAgICAgICAgICAgIHRoaXMuY2hpbGRyZW5CeVVpZFtjaGlsZC51aWRdID0gY2hpbGQ7DQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgfTsNCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5yZW1vdmVDaGlsZCA9IGZ1bmN0aW9uIChjaGlsZCkgew0KICAgICAgICBpZiAodGhpcy5jaGlsZHJlbkJ5VWlkW2NoaWxkLnVpZF0pIHsNCiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoaWxkcmVuQnlVaWRbY2hpbGQudWlkXTsNCiAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9Ow0KICAgIC8vIFRPRE86IG9ubHkgZG8gaWYgaXNJbkRvbT8NCiAgICAvLyBUT0RPOiBtYWtlIHBhcnQgb2YgQ29tcG9uZW50LCBhbG9uZyB3aXRoIGNoaWxkcmVuL2JhdGNoLXJlbmRlciBzeXN0ZW0/DQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUudXBkYXRlU2l6ZSA9IGZ1bmN0aW9uICh0b3RhbEhlaWdodCwgaXNBdXRvLCBpc1Jlc2l6ZSkgew0KICAgICAgICB0aGlzLmNhbGxDaGlsZHJlbigndXBkYXRlU2l6ZScsIGFyZ3VtZW50cyk7DQogICAgfTsNCiAgICAvLyBPcHRpb25zDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5vcHQgPSBmdW5jdGlvbiAobmFtZSkgew0KICAgICAgICByZXR1cm4gdGhpcy5fZ2V0VmlldygpLm9wdChuYW1lKTsgLy8gZGVmYXVsdCBpbXBsZW1lbnRhdGlvbg0KICAgIH07DQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUucHVibGljbHlUcmlnZ2VyID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgYXJncyA9IFtdOw0KICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykgew0KICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2ldOw0KICAgICAgICB9DQogICAgICAgIHZhciBjYWxlbmRhciA9IHRoaXMuX2dldENhbGVuZGFyKCk7DQogICAgICAgIHJldHVybiBjYWxlbmRhci5wdWJsaWNseVRyaWdnZXIuYXBwbHkoY2FsZW5kYXIsIGFyZ3MpOw0KICAgIH07DQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuaGFzUHVibGljSGFuZGxlcnMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBhcmdzID0gW107DQogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7DQogICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07DQogICAgICAgIH0NCiAgICAgICAgdmFyIGNhbGVuZGFyID0gdGhpcy5fZ2V0Q2FsZW5kYXIoKTsNCiAgICAgICAgcmV0dXJuIGNhbGVuZGFyLmhhc1B1YmxpY0hhbmRsZXJzLmFwcGx5KGNhbGVuZGFyLCBhcmdzKTsNCiAgICB9Ow0KICAgIC8vIERhdGUNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLmV4ZWN1dGVEYXRlUmVuZGVyID0gZnVuY3Rpb24gKGRhdGVQcm9maWxlKSB7DQogICAgICAgIHRoaXMuZGF0ZVByb2ZpbGUgPSBkYXRlUHJvZmlsZTsgLy8gZm9yIHJlbmRlcmluZw0KICAgICAgICB0aGlzLnJlbmRlckRhdGVzKGRhdGVQcm9maWxlKTsNCiAgICAgICAgdGhpcy5pc0RhdGVzUmVuZGVyZWQgPSB0cnVlOw0KICAgICAgICB0aGlzLmNhbGxDaGlsZHJlbignZXhlY3V0ZURhdGVSZW5kZXInLCBhcmd1bWVudHMpOw0KICAgIH07DQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuZXhlY3V0ZURhdGVVbnJlbmRlciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5jYWxsQ2hpbGRyZW4oJ2V4ZWN1dGVEYXRlVW5yZW5kZXInLCBhcmd1bWVudHMpOw0KICAgICAgICB0aGlzLmRhdGVQcm9maWxlID0gbnVsbDsNCiAgICAgICAgdGhpcy51bnJlbmRlckRhdGVzKCk7DQogICAgICAgIHRoaXMuaXNEYXRlc1JlbmRlcmVkID0gZmFsc2U7DQogICAgfTsNCiAgICAvLyBkYXRlLWNlbGwgY29udGVudCBvbmx5DQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUucmVuZGVyRGF0ZXMgPSBmdW5jdGlvbiAoZGF0ZVByb2ZpbGUpIHsNCiAgICAgICAgLy8gc3ViY2xhc3NlcyBzaG91bGQgaW1wbGVtZW50DQogICAgfTsNCiAgICAvLyBkYXRlLWNlbGwgY29udGVudCBvbmx5DQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUudW5yZW5kZXJEYXRlcyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgLy8gc3ViY2xhc3NlcyBzaG91bGQgb3ZlcnJpZGUNCiAgICB9Ow0KICAgIC8vIE5vdy1JbmRpY2F0b3INCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIC8vIFJldHVybnMgYSBzdHJpbmcgdW5pdCwgbGlrZSAnc2Vjb25kJyBvciAnbWludXRlJyB0aGF0IGRlZmluZWQgaG93IG9mdGVuIHRoZSBjdXJyZW50IHRpbWUgaW5kaWNhdG9yDQogICAgLy8gc2hvdWxkIGJlIHJlZnJlc2hlZC4gSWYgc29tZXRoaW5nIGZhbHN5IGlzIHJldHVybmVkLCBubyB0aW1lIGluZGljYXRvciBpcyByZW5kZXJlZCBhdCBhbGwuDQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuZ2V0Tm93SW5kaWNhdG9yVW5pdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgLy8gc3ViY2xhc3NlcyBzaG91bGQgaW1wbGVtZW50DQogICAgfTsNCiAgICAvLyBSZW5kZXJzIGEgY3VycmVudCB0aW1lIGluZGljYXRvciBhdCB0aGUgZ2l2ZW4gZGF0ZXRpbWUNCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5yZW5kZXJOb3dJbmRpY2F0b3IgPSBmdW5jdGlvbiAoZGF0ZSkgew0KICAgICAgICB0aGlzLmNhbGxDaGlsZHJlbigncmVuZGVyTm93SW5kaWNhdG9yJywgYXJndW1lbnRzKTsNCiAgICB9Ow0KICAgIC8vIFVuZG9lcyB0aGUgcmVuZGVyaW5nIGFjdGlvbnMgZnJvbSByZW5kZXJOb3dJbmRpY2F0b3INCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS51bnJlbmRlck5vd0luZGljYXRvciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5jYWxsQ2hpbGRyZW4oJ3VucmVuZGVyTm93SW5kaWNhdG9yJywgYXJndW1lbnRzKTsNCiAgICB9Ow0KICAgIC8vIEJ1c2luZXNzIEhvdXJzDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUucmVuZGVyQnVzaW5lc3NIb3VycyA9IGZ1bmN0aW9uIChidXNpbmVzc0hvdXJHZW5lcmF0b3IpIHsNCiAgICAgICAgaWYgKHRoaXMuYnVzaW5lc3NIb3VyUmVuZGVyZXIpIHsNCiAgICAgICAgICAgIHRoaXMuYnVzaW5lc3NIb3VyUmVuZGVyZXIucmVuZGVyKGJ1c2luZXNzSG91ckdlbmVyYXRvcik7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5jYWxsQ2hpbGRyZW4oJ3JlbmRlckJ1c2luZXNzSG91cnMnLCBhcmd1bWVudHMpOw0KICAgIH07DQogICAgLy8gVW5yZW5kZXJzIHByZXZpb3VzbHktcmVuZGVyZWQgYnVzaW5lc3MtaG91cnMNCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS51bnJlbmRlckJ1c2luZXNzSG91cnMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMuY2FsbENoaWxkcmVuKCd1bnJlbmRlckJ1c2luZXNzSG91cnMnLCBhcmd1bWVudHMpOw0KICAgICAgICBpZiAodGhpcy5idXNpbmVzc0hvdXJSZW5kZXJlcikgew0KICAgICAgICAgICAgdGhpcy5idXNpbmVzc0hvdXJSZW5kZXJlci51bnJlbmRlcigpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBFdmVudCBEaXNwbGF5aW5nDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5leGVjdXRlRXZlbnRSZW5kZXIgPSBmdW5jdGlvbiAoZXZlbnRzUGF5bG9hZCkgew0KICAgICAgICBpZiAodGhpcy5ldmVudFJlbmRlcmVyKSB7DQogICAgICAgICAgICB0aGlzLmV2ZW50UmVuZGVyZXIucmFuZ2VVcGRhdGVkKCk7IC8vIHBvb3JseSBuYW1lZCBub3cNCiAgICAgICAgICAgIHRoaXMuZXZlbnRSZW5kZXJlci5yZW5kZXIoZXZlbnRzUGF5bG9hZCk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAodGhpc1sncmVuZGVyRXZlbnRzJ10pIHsNCiAgICAgICAgICAgIHRoaXNbJ3JlbmRlckV2ZW50cyddKGNvbnZlcnRFdmVudHNQYXlsb2FkVG9MZWdhY3lBcnJheShldmVudHNQYXlsb2FkKSk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5jYWxsQ2hpbGRyZW4oJ2V4ZWN1dGVFdmVudFJlbmRlcicsIGFyZ3VtZW50cyk7DQogICAgfTsNCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5leGVjdXRlRXZlbnRVbnJlbmRlciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5jYWxsQ2hpbGRyZW4oJ2V4ZWN1dGVFdmVudFVucmVuZGVyJywgYXJndW1lbnRzKTsNCiAgICAgICAgaWYgKHRoaXMuZXZlbnRSZW5kZXJlcikgew0KICAgICAgICAgICAgdGhpcy5ldmVudFJlbmRlcmVyLnVucmVuZGVyKCk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAodGhpc1snZGVzdHJveUV2ZW50cyddKSB7DQogICAgICAgICAgICB0aGlzWydkZXN0cm95RXZlbnRzJ10oKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuZ2V0QnVzaW5lc3NIb3VyU2VncyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIHNlZ3MgPSB0aGlzLmdldE93bkJ1c2luZXNzSG91clNlZ3MoKTsNCiAgICAgICAgdGhpcy5pdGVyQ2hpbGRyZW4oZnVuY3Rpb24gKGNoaWxkKSB7DQogICAgICAgICAgICBzZWdzLnB1c2guYXBwbHkoc2VncywgY2hpbGQuZ2V0QnVzaW5lc3NIb3VyU2VncygpKTsNCiAgICAgICAgfSk7DQogICAgICAgIHJldHVybiBzZWdzOw0KICAgIH07DQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuZ2V0T3duQnVzaW5lc3NIb3VyU2VncyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMuYnVzaW5lc3NIb3VyUmVuZGVyZXIpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLmJ1c2luZXNzSG91clJlbmRlcmVyLmdldFNlZ3MoKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gW107DQogICAgfTsNCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5nZXRFdmVudFNlZ3MgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBzZWdzID0gdGhpcy5nZXRPd25FdmVudFNlZ3MoKTsNCiAgICAgICAgdGhpcy5pdGVyQ2hpbGRyZW4oZnVuY3Rpb24gKGNoaWxkKSB7DQogICAgICAgICAgICBzZWdzLnB1c2guYXBwbHkoc2VncywgY2hpbGQuZ2V0RXZlbnRTZWdzKCkpOw0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuIHNlZ3M7DQogICAgfTsNCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5nZXRPd25FdmVudFNlZ3MgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICh0aGlzLmV2ZW50UmVuZGVyZXIpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLmV2ZW50UmVuZGVyZXIuZ2V0U2VncygpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBbXTsNCiAgICB9Ow0KICAgIC8vIEV2ZW50IFJlbmRlcmluZyBUcmlnZ2VyaW5nDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS50cmlnZ2VyQWZ0ZXJFdmVudHNSZW5kZXJlZCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy50cmlnZ2VyQWZ0ZXJFdmVudFNlZ3NSZW5kZXJlZCh0aGlzLmdldEV2ZW50U2VncygpKTsNCiAgICAgICAgdGhpcy5wdWJsaWNseVRyaWdnZXIoJ2V2ZW50QWZ0ZXJBbGxSZW5kZXInLCB7DQogICAgICAgICAgICBjb250ZXh0OiB0aGlzLA0KICAgICAgICAgICAgYXJnczogW3RoaXNdDQogICAgICAgIH0pOw0KICAgIH07DQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUudHJpZ2dlckFmdGVyRXZlbnRTZWdzUmVuZGVyZWQgPSBmdW5jdGlvbiAoc2Vncykgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICAvLyBhbiBvcHRpbWl6YXRpb24sIGJlY2F1c2UgZ2V0RXZlbnRMZWdhY3kgaXMgZXhwZW5zaXZlDQogICAgICAgIGlmICh0aGlzLmhhc1B1YmxpY0hhbmRsZXJzKCdldmVudEFmdGVyUmVuZGVyJykpIHsNCiAgICAgICAgICAgIHNlZ3MuZm9yRWFjaChmdW5jdGlvbiAoc2VnKSB7DQogICAgICAgICAgICAgICAgdmFyIGxlZ2FjeTsNCiAgICAgICAgICAgICAgICBpZiAoc2VnLmVsKSB7DQogICAgICAgICAgICAgICAgICAgIGxlZ2FjeSA9IHNlZy5mb290cHJpbnQuZ2V0RXZlbnRMZWdhY3koKTsNCiAgICAgICAgICAgICAgICAgICAgX3RoaXMucHVibGljbHlUcmlnZ2VyKCdldmVudEFmdGVyUmVuZGVyJywgew0KICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dDogbGVnYWN5LA0KICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogW2xlZ2FjeSwgc2VnLmVsLCBfdGhpc10NCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLnRyaWdnZXJCZWZvcmVFdmVudHNEZXN0cm95ZWQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMudHJpZ2dlckJlZm9yZUV2ZW50U2Vnc0Rlc3Ryb3llZCh0aGlzLmdldEV2ZW50U2VncygpKTsNCiAgICB9Ow0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLnRyaWdnZXJCZWZvcmVFdmVudFNlZ3NEZXN0cm95ZWQgPSBmdW5jdGlvbiAoc2Vncykgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICBpZiAodGhpcy5oYXNQdWJsaWNIYW5kbGVycygnZXZlbnREZXN0cm95JykpIHsNCiAgICAgICAgICAgIHNlZ3MuZm9yRWFjaChmdW5jdGlvbiAoc2VnKSB7DQogICAgICAgICAgICAgICAgdmFyIGxlZ2FjeTsNCiAgICAgICAgICAgICAgICBpZiAoc2VnLmVsKSB7DQogICAgICAgICAgICAgICAgICAgIGxlZ2FjeSA9IHNlZy5mb290cHJpbnQuZ2V0RXZlbnRMZWdhY3koKTsNCiAgICAgICAgICAgICAgICAgICAgX3RoaXMucHVibGljbHlUcmlnZ2VyKCdldmVudERlc3Ryb3knLCB7DQogICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0OiBsZWdhY3ksDQogICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiBbbGVnYWN5LCBzZWcuZWwsIF90aGlzXQ0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gRXZlbnQgUmVuZGVyaW5nIFV0aWxzDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAvLyBIaWRlcyBhbGwgcmVuZGVyZWQgZXZlbnQgc2VnbWVudHMgbGlua2VkIHRvIHRoZSBnaXZlbiBldmVudA0KICAgIC8vIFJFQ1VSU0lWRSB3aXRoIHN1YmNvbXBvbmVudHMNCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5zaG93RXZlbnRzV2l0aElkID0gZnVuY3Rpb24gKGV2ZW50RGVmSWQpIHsNCiAgICAgICAgdGhpcy5nZXRFdmVudFNlZ3MoKS5mb3JFYWNoKGZ1bmN0aW9uIChzZWcpIHsNCiAgICAgICAgICAgIGlmIChzZWcuZm9vdHByaW50LmV2ZW50RGVmLmlkID09PSBldmVudERlZklkICYmDQogICAgICAgICAgICAgICAgc2VnLmVsIC8vIG5lY2Vzc2FyeT8NCiAgICAgICAgICAgICkgew0KICAgICAgICAgICAgICAgIHNlZy5lbC5jc3MoJ3Zpc2liaWxpdHknLCAnJyk7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgICB0aGlzLmNhbGxDaGlsZHJlbignc2hvd0V2ZW50c1dpdGhJZCcsIGFyZ3VtZW50cyk7DQogICAgfTsNCiAgICAvLyBTaG93cyBhbGwgcmVuZGVyZWQgZXZlbnQgc2VnbWVudHMgbGlua2VkIHRvIHRoZSBnaXZlbiBldmVudA0KICAgIC8vIFJFQ1VSU0lWRSB3aXRoIHN1YmNvbXBvbmVudHMNCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5oaWRlRXZlbnRzV2l0aElkID0gZnVuY3Rpb24gKGV2ZW50RGVmSWQpIHsNCiAgICAgICAgdGhpcy5nZXRFdmVudFNlZ3MoKS5mb3JFYWNoKGZ1bmN0aW9uIChzZWcpIHsNCiAgICAgICAgICAgIGlmIChzZWcuZm9vdHByaW50LmV2ZW50RGVmLmlkID09PSBldmVudERlZklkICYmDQogICAgICAgICAgICAgICAgc2VnLmVsIC8vIG5lY2Vzc2FyeT8NCiAgICAgICAgICAgICkgew0KICAgICAgICAgICAgICAgIHNlZy5lbC5jc3MoJ3Zpc2liaWxpdHknLCAnaGlkZGVuJyk7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgICB0aGlzLmNhbGxDaGlsZHJlbignaGlkZUV2ZW50c1dpdGhJZCcsIGFyZ3VtZW50cyk7DQogICAgfTsNCiAgICAvLyBEcmFnLW4tRHJvcCBSZW5kZXJpbmcgKGZvciBib3RoIGV2ZW50cyBhbmQgZXh0ZXJuYWwgZWxlbWVudHMpDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgLy8gUmVuZGVycyBhIHZpc3VhbCBpbmRpY2F0aW9uIG9mIGEgZXZlbnQgb3IgZXh0ZXJuYWwtZWxlbWVudCBkcmFnIG92ZXIgdGhlIGdpdmVuIGRyb3Agem9uZS4NCiAgICAvLyBJZiBhbiBleHRlcm5hbC1lbGVtZW50LCBzZWcgd2lsbCBiZSBgbnVsbGAuDQogICAgLy8gTXVzdCByZXR1cm4gZWxlbWVudHMgdXNlZCBmb3IgYW55IG1vY2sgZXZlbnRzLg0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLnJlbmRlckRyYWcgPSBmdW5jdGlvbiAoZXZlbnRGb290cHJpbnRzLCBzZWcsIGlzVG91Y2gpIHsNCiAgICAgICAgdmFyIHJlbmRlcmVkSGVscGVyID0gZmFsc2U7DQogICAgICAgIHRoaXMuaXRlckNoaWxkcmVuKGZ1bmN0aW9uIChjaGlsZCkgew0KICAgICAgICAgICAgaWYgKGNoaWxkLnJlbmRlckRyYWcoZXZlbnRGb290cHJpbnRzLCBzZWcsIGlzVG91Y2gpKSB7DQogICAgICAgICAgICAgICAgcmVuZGVyZWRIZWxwZXIgPSB0cnVlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuIHJlbmRlcmVkSGVscGVyOw0KICAgIH07DQogICAgLy8gVW5yZW5kZXJzIGEgdmlzdWFsIGluZGljYXRpb24gb2YgYW4gZXZlbnQgb3IgZXh0ZXJuYWwtZWxlbWVudCBiZWluZyBkcmFnZ2VkLg0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLnVucmVuZGVyRHJhZyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5jYWxsQ2hpbGRyZW4oJ3VucmVuZGVyRHJhZycsIGFyZ3VtZW50cyk7DQogICAgfTsNCiAgICAvLyBFdmVudCBSZXNpemluZw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIC8vIFJlbmRlcnMgYSB2aXN1YWwgaW5kaWNhdGlvbiBvZiBhbiBldmVudCBiZWluZyByZXNpemVkLg0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLnJlbmRlckV2ZW50UmVzaXplID0gZnVuY3Rpb24gKGV2ZW50Rm9vdHByaW50cywgc2VnLCBpc1RvdWNoKSB7DQogICAgICAgIHRoaXMuY2FsbENoaWxkcmVuKCdyZW5kZXJFdmVudFJlc2l6ZScsIGFyZ3VtZW50cyk7DQogICAgfTsNCiAgICAvLyBVbnJlbmRlcnMgYSB2aXN1YWwgaW5kaWNhdGlvbiBvZiBhbiBldmVudCBiZWluZyByZXNpemVkLg0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLnVucmVuZGVyRXZlbnRSZXNpemUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMuY2FsbENoaWxkcmVuKCd1bnJlbmRlckV2ZW50UmVzaXplJywgYXJndW1lbnRzKTsNCiAgICB9Ow0KICAgIC8vIFNlbGVjdGlvbg0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIC8vIFJlbmRlcnMgYSB2aXN1YWwgaW5kaWNhdGlvbiBvZiB0aGUgc2VsZWN0aW9uDQogICAgLy8gVE9ETzogcmVuYW1lIHRvIGByZW5kZXJTZWxlY3Rpb25gIGFmdGVyIGxlZ2FjeSBpcyBnb25lDQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUucmVuZGVyU2VsZWN0aW9uRm9vdHByaW50ID0gZnVuY3Rpb24gKGNvbXBvbmVudEZvb3RwcmludCkgew0KICAgICAgICB0aGlzLnJlbmRlckhpZ2hsaWdodChjb21wb25lbnRGb290cHJpbnQpOw0KICAgICAgICB0aGlzLmNhbGxDaGlsZHJlbigncmVuZGVyU2VsZWN0aW9uRm9vdHByaW50JywgYXJndW1lbnRzKTsNCiAgICB9Ow0KICAgIC8vIFVucmVuZGVycyBhIHZpc3VhbCBpbmRpY2F0aW9uIG9mIHNlbGVjdGlvbg0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLnVucmVuZGVyU2VsZWN0aW9uID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLnVucmVuZGVySGlnaGxpZ2h0KCk7DQogICAgICAgIHRoaXMuY2FsbENoaWxkcmVuKCd1bnJlbmRlclNlbGVjdGlvbicsIGFyZ3VtZW50cyk7DQogICAgfTsNCiAgICAvLyBIaWdobGlnaHQNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAvLyBSZW5kZXJzIGFuIGVtcGhhc2lzIG9uIHRoZSBnaXZlbiBkYXRlIHJhbmdlLiBHaXZlbiBhIHNwYW4gKHVuem9uZWQgc3RhcnQvZW5kIGFuZCBvdGhlciBtaXNjIGRhdGEpDQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUucmVuZGVySGlnaGxpZ2h0ID0gZnVuY3Rpb24gKGNvbXBvbmVudEZvb3RwcmludCkgew0KICAgICAgICBpZiAodGhpcy5maWxsUmVuZGVyZXIpIHsNCiAgICAgICAgICAgIHRoaXMuZmlsbFJlbmRlcmVyLnJlbmRlckZvb3RwcmludCgnaGlnaGxpZ2h0JywgY29tcG9uZW50Rm9vdHByaW50LCB7DQogICAgICAgICAgICAgICAgZ2V0Q2xhc3NlczogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gWydmYy1oaWdobGlnaHQnXTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmNhbGxDaGlsZHJlbigncmVuZGVySGlnaGxpZ2h0JywgYXJndW1lbnRzKTsNCiAgICB9Ow0KICAgIC8vIFVucmVuZGVycyB0aGUgZW1waGFzaXMgb24gYSBkYXRlIHJhbmdlDQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUudW5yZW5kZXJIaWdobGlnaHQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICh0aGlzLmZpbGxSZW5kZXJlcikgew0KICAgICAgICAgICAgdGhpcy5maWxsUmVuZGVyZXIudW5yZW5kZXIoJ2hpZ2hsaWdodCcpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuY2FsbENoaWxkcmVuKCd1bnJlbmRlckhpZ2hsaWdodCcsIGFyZ3VtZW50cyk7DQogICAgfTsNCiAgICAvLyBIaXQgQXJlYXMNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAvLyBqdXN0IGJlY2F1c2UgYWxsIERhdGVDb21wb25lbnRzIHN1cHBvcnQgdGhpcyBpbnRlcmZhY2UNCiAgICAvLyBkb2Vzbid0IG1lYW4gdGhleSBuZWVkIHRvIGhhdmUgdGhlaXIgb3duIGludGVybmFsIGNvb3JkIHN5c3RlbS4gdGhleSBjYW4gZGVmZXIgdG8gc3ViLWNvbXBvbmVudHMuDQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuaGl0c05lZWRlZCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKCEodGhpcy5oaXRzTmVlZGVkRGVwdGgrKykpIHsNCiAgICAgICAgICAgIHRoaXMucHJlcGFyZUhpdHMoKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmNhbGxDaGlsZHJlbignaGl0c05lZWRlZCcsIGFyZ3VtZW50cyk7DQogICAgfTsNCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5oaXRzTm90TmVlZGVkID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5oaXRzTmVlZGVkRGVwdGggJiYgISgtLXRoaXMuaGl0c05lZWRlZERlcHRoKSkgew0KICAgICAgICAgICAgdGhpcy5yZWxlYXNlSGl0cygpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuY2FsbENoaWxkcmVuKCdoaXRzTm90TmVlZGVkJywgYXJndW1lbnRzKTsNCiAgICB9Ow0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLnByZXBhcmVIaXRzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAvLyBzdWJjbGFzc2VzIGNhbiBpbXBsZW1lbnQNCiAgICB9Ow0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLnJlbGVhc2VIaXRzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAvLyBzdWJjbGFzc2VzIGNhbiBpbXBsZW1lbnQNCiAgICB9Ow0KICAgIC8vIEdpdmVuIGNvb3JkaW5hdGVzIGZyb20gdGhlIHRvcGxlZnQgb2YgdGhlIGRvY3VtZW50LCByZXR1cm4gZGF0YSBhYm91dCB0aGUgZGF0ZS1yZWxhdGVkIGFyZWEgdW5kZXJuZWF0aC4NCiAgICAvLyBDYW4gcmV0dXJuIGFuIG9iamVjdCB3aXRoIGFyYml0cmFyeSBwcm9wZXJ0aWVzIChhbHRob3VnaCB0b3AvcmlnaHQvbGVmdC9ib3R0b20gYXJlIGVuY291cmFnZWQpLg0KICAgIC8vIE11c3QgaGF2ZSBhIGBncmlkYCBwcm9wZXJ0eSwgYSByZWZlcmVuY2UgdG8gdGhpcyBjdXJyZW50IGdyaWQuIFRPRE86IGF2b2lkIHRoaXMNCiAgICAvLyBUaGUgcmV0dXJuZWQgb2JqZWN0IHdpbGwgYmUgcHJvY2Vzc2VkIGJ5IGdldEhpdEZvb3RwcmludCBhbmQgZ2V0SGl0RWwuDQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUucXVlcnlIaXQgPSBmdW5jdGlvbiAobGVmdE9mZnNldCwgdG9wT2Zmc2V0KSB7DQogICAgICAgIHZhciBjaGlsZHJlbkJ5VWlkID0gdGhpcy5jaGlsZHJlbkJ5VWlkOw0KICAgICAgICB2YXIgdWlkOw0KICAgICAgICB2YXIgaGl0Ow0KICAgICAgICBmb3IgKHVpZCBpbiBjaGlsZHJlbkJ5VWlkKSB7DQogICAgICAgICAgICBoaXQgPSBjaGlsZHJlbkJ5VWlkW3VpZF0ucXVlcnlIaXQobGVmdE9mZnNldCwgdG9wT2Zmc2V0KTsNCiAgICAgICAgICAgIGlmIChoaXQpIHsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gaGl0Ow0KICAgIH07DQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuZ2V0U2FmZUhpdEZvb3RwcmludCA9IGZ1bmN0aW9uIChoaXQpIHsNCiAgICAgICAgdmFyIGZvb3RwcmludCA9IHRoaXMuZ2V0SGl0Rm9vdHByaW50KGhpdCk7DQogICAgICAgIGlmICghdGhpcy5kYXRlUHJvZmlsZS5hY3RpdmVVbnpvbmVkUmFuZ2UuY29udGFpbnNSYW5nZShmb290cHJpbnQudW56b25lZFJhbmdlKSkgew0KICAgICAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGZvb3RwcmludDsNCiAgICB9Ow0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLmdldEhpdEZvb3RwcmludCA9IGZ1bmN0aW9uIChoaXQpIHsNCiAgICAgICAgLy8gd2hhdCBhYm91dCBiZWluZyBhYnN0cmFjdCE/DQogICAgfTsNCiAgICAvLyBHaXZlbiBwb3NpdGlvbi1sZXZlbCBpbmZvcm1hdGlvbiBhYm91dCBhIGRhdGUtcmVsYXRlZCBhcmVhIHdpdGhpbiB0aGUgZ3JpZCwNCiAgICAvLyBzaG91bGQgcmV0dXJuIGEgalF1ZXJ5IGVsZW1lbnQgdGhhdCBiZXN0IHJlcHJlc2VudHMgaXQuIHBhc3NlZCB0byBkYXlDbGljayBjYWxsYmFjay4NCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5nZXRIaXRFbCA9IGZ1bmN0aW9uIChoaXQpIHsNCiAgICAgICAgLy8gd2hhdCBhYm91dCBiZWluZyBhYnN0cmFjdCE/DQogICAgfTsNCiAgICAvKiBDb252ZXJ0aW5nIGV2ZW50UmFuZ2UgLT4gZXZlbnRGb290cHJpbnQNCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLmV2ZW50UmFuZ2VzVG9FdmVudEZvb3RwcmludHMgPSBmdW5jdGlvbiAoZXZlbnRSYW5nZXMpIHsNCiAgICAgICAgdmFyIGV2ZW50Rm9vdHByaW50cyA9IFtdOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGV2ZW50UmFuZ2VzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBldmVudEZvb3RwcmludHMucHVzaC5hcHBseSgvLyBhcHBlbmQNCiAgICAgICAgICAgIGV2ZW50Rm9vdHByaW50cywgdGhpcy5ldmVudFJhbmdlVG9FdmVudEZvb3RwcmludHMoZXZlbnRSYW5nZXNbaV0pKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZXZlbnRGb290cHJpbnRzOw0KICAgIH07DQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuZXZlbnRSYW5nZVRvRXZlbnRGb290cHJpbnRzID0gZnVuY3Rpb24gKGV2ZW50UmFuZ2UpIHsNCiAgICAgICAgcmV0dXJuIFt1dGlsXzIuZXZlbnRSYW5nZVRvRXZlbnRGb290cHJpbnQoZXZlbnRSYW5nZSldOw0KICAgIH07DQogICAgLyogQ29udmVydGluZyBjb21wb25lbnRGb290cHJpbnQvZXZlbnRGb290cHJpbnQgLT4gc2Vncw0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuZXZlbnRGb290cHJpbnRzVG9TZWdzID0gZnVuY3Rpb24gKGV2ZW50Rm9vdHByaW50cykgew0KICAgICAgICB2YXIgc2VncyA9IFtdOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGV2ZW50Rm9vdHByaW50cy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgc2Vncy5wdXNoLmFwcGx5KHNlZ3MsIHRoaXMuZXZlbnRGb290cHJpbnRUb1NlZ3MoZXZlbnRGb290cHJpbnRzW2ldKSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHNlZ3M7DQogICAgfTsNCiAgICAvLyBHaXZlbiBhbiBldmVudCdzIHNwYW4gKHVuem9uZWQgc3RhcnQvZW5kIGFuZCBvdGhlciBtaXNjIGRhdGEpLCBhbmQgdGhlIGV2ZW50IGl0c2VsZiwNCiAgICAvLyBzbGljZXMgaW50byBzZWdtZW50cyBhbmQgYXR0YWNoZXMgZXZlbnQtZGVyaXZlZCBwcm9wZXJ0aWVzIHRvIHRoZW0uDQogICAgLy8gZXZlbnRTcGFuIC0geyBzdGFydCwgZW5kLCBpc1N0YXJ0LCBpc0VuZCwgb3RoZXJ0aGluZ3MuLi4gfQ0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLmV2ZW50Rm9vdHByaW50VG9TZWdzID0gZnVuY3Rpb24gKGV2ZW50Rm9vdHByaW50KSB7DQogICAgICAgIHZhciB1bnpvbmVkUmFuZ2UgPSBldmVudEZvb3RwcmludC5jb21wb25lbnRGb290cHJpbnQudW56b25lZFJhbmdlOw0KICAgICAgICB2YXIgc2VnczsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIHZhciBzZWc7DQogICAgICAgIHNlZ3MgPSB0aGlzLmNvbXBvbmVudEZvb3RwcmludFRvU2VncyhldmVudEZvb3RwcmludC5jb21wb25lbnRGb290cHJpbnQpOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2Vncy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgc2VnID0gc2Vnc1tpXTsNCiAgICAgICAgICAgIGlmICghdW56b25lZFJhbmdlLmlzU3RhcnQpIHsNCiAgICAgICAgICAgICAgICBzZWcuaXNTdGFydCA9IGZhbHNlOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKCF1bnpvbmVkUmFuZ2UuaXNFbmQpIHsNCiAgICAgICAgICAgICAgICBzZWcuaXNFbmQgPSBmYWxzZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHNlZy5mb290cHJpbnQgPSBldmVudEZvb3RwcmludDsNCiAgICAgICAgICAgIC8vIFRPRE86IHJlbmFtZSB0byBzZWcuZXZlbnRGb290cHJpbnQNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gc2VnczsNCiAgICB9Ow0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLmNvbXBvbmVudEZvb3RwcmludFRvU2VncyA9IGZ1bmN0aW9uIChjb21wb25lbnRGb290cHJpbnQpIHsNCiAgICAgICAgcmV0dXJuIFtdOw0KICAgIH07DQogICAgLy8gVXRpbHMNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5jYWxsQ2hpbGRyZW4gPSBmdW5jdGlvbiAobWV0aG9kTmFtZSwgYXJncykgew0KICAgICAgICB0aGlzLml0ZXJDaGlsZHJlbihmdW5jdGlvbiAoY2hpbGQpIHsNCiAgICAgICAgICAgIGNoaWxkW21ldGhvZE5hbWVdLmFwcGx5KGNoaWxkLCBhcmdzKTsNCiAgICAgICAgfSk7DQogICAgfTsNCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5pdGVyQ2hpbGRyZW4gPSBmdW5jdGlvbiAoZnVuYykgew0KICAgICAgICB2YXIgY2hpbGRyZW5CeVVpZCA9IHRoaXMuY2hpbGRyZW5CeVVpZDsNCiAgICAgICAgdmFyIHVpZDsNCiAgICAgICAgZm9yICh1aWQgaW4gY2hpbGRyZW5CeVVpZCkgew0KICAgICAgICAgICAgZnVuYyhjaGlsZHJlbkJ5VWlkW3VpZF0pOw0KICAgICAgICB9DQogICAgfTsNCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5fZ2V0Q2FsZW5kYXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciB0ID0gdGhpczsNCiAgICAgICAgcmV0dXJuIHQuY2FsZW5kYXIgfHwgdC52aWV3LmNhbGVuZGFyOw0KICAgIH07DQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuX2dldFZpZXcgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHJldHVybiB0aGlzLnZpZXc7DQogICAgfTsNCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5fZ2V0RGF0ZVByb2ZpbGUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHJldHVybiB0aGlzLl9nZXRWaWV3KCkuZ2V0KCdkYXRlUHJvZmlsZScpOw0KICAgIH07DQogICAgLy8gR2VuZXJhdGVzIEhUTUwgZm9yIGFuIGFuY2hvciB0byBhbm90aGVyIHZpZXcgaW50byB0aGUgY2FsZW5kYXIuDQogICAgLy8gV2lsbCBlaXRoZXIgZ2VuZXJhdGUgYW4gPGE+IHRhZyBvciBhIG5vbi1jbGlja2FibGUgPHNwYW4+IHRhZywgZGVwZW5kaW5nIG9uIGVuYWJsZWQgc2V0dGluZ3MuDQogICAgLy8gYGdvdG9PcHRpb25zYCBjYW4gZWl0aGVyIGJlIGEgbW9tZW50IGlucHV0LCBvciBhbiBvYmplY3Qgd2l0aCB0aGUgZm9ybToNCiAgICAvLyB7IGRhdGUsIHR5cGUsIGZvcmNlT2ZmIH0NCiAgICAvLyBgdHlwZWAgaXMgYSB2aWV3LXR5cGUgbGlrZSAiZGF5IiBvciAid2VlayIuIGRlZmF1bHQgdmFsdWUgaXMgImRheSIuDQogICAgLy8gYGF0dHJzYCBhbmQgYGlubmVySHRtbGAgYXJlIHVzZSB0byBnZW5lcmF0ZSB0aGUgcmVzdCBvZiB0aGUgSFRNTCB0YWcuDQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuYnVpbGRHb3RvQW5jaG9ySHRtbCA9IGZ1bmN0aW9uIChnb3RvT3B0aW9ucywgYXR0cnMsIGlubmVySHRtbCkgew0KICAgICAgICB2YXIgZGF0ZTsNCiAgICAgICAgdmFyIHR5cGU7DQogICAgICAgIHZhciBmb3JjZU9mZjsNCiAgICAgICAgdmFyIGZpbmFsT3B0aW9uczsNCiAgICAgICAgaWYgKCQuaXNQbGFpbk9iamVjdChnb3RvT3B0aW9ucykpIHsNCiAgICAgICAgICAgIGRhdGUgPSBnb3RvT3B0aW9ucy5kYXRlOw0KICAgICAgICAgICAgdHlwZSA9IGdvdG9PcHRpb25zLnR5cGU7DQogICAgICAgICAgICBmb3JjZU9mZiA9IGdvdG9PcHRpb25zLmZvcmNlT2ZmOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgZGF0ZSA9IGdvdG9PcHRpb25zOyAvLyBhIHNpbmdsZSBtb21lbnQgaW5wdXQNCiAgICAgICAgfQ0KICAgICAgICBkYXRlID0gbW9tZW50X2V4dF8xLmRlZmF1bHQoZGF0ZSk7IC8vIGlmIGEgc3RyaW5nLCBwYXJzZSBpdA0KICAgICAgICBmaW5hbE9wdGlvbnMgPSB7DQogICAgICAgICAgICBkYXRlOiBkYXRlLmZvcm1hdCgnWVlZWS1NTS1ERCcpLA0KICAgICAgICAgICAgdHlwZTogdHlwZSB8fCAnZGF5Jw0KICAgICAgICB9Ow0KICAgICAgICBpZiAodHlwZW9mIGF0dHJzID09PSAnc3RyaW5nJykgew0KICAgICAgICAgICAgaW5uZXJIdG1sID0gYXR0cnM7DQogICAgICAgICAgICBhdHRycyA9IG51bGw7DQogICAgICAgIH0NCiAgICAgICAgYXR0cnMgPSBhdHRycyA/ICcgJyArIHV0aWxfMS5hdHRyc1RvU3RyKGF0dHJzKSA6ICcnOyAvLyB3aWxsIGhhdmUgYSBsZWFkaW5nIHNwYWNlDQogICAgICAgIGlubmVySHRtbCA9IGlubmVySHRtbCB8fCAnJzsNCiAgICAgICAgaWYgKCFmb3JjZU9mZiAmJiB0aGlzLm9wdCgnbmF2TGlua3MnKSkgew0KICAgICAgICAgICAgcmV0dXJuICc8YScgKyBhdHRycyArDQogICAgICAgICAgICAgICAgJyBkYXRhLWdvdG89IicgKyB1dGlsXzEuaHRtbEVzY2FwZShKU09OLnN0cmluZ2lmeShmaW5hbE9wdGlvbnMpKSArICciPicgKw0KICAgICAgICAgICAgICAgIGlubmVySHRtbCArDQogICAgICAgICAgICAgICAgJzwvYT4nOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuICc8c3BhbicgKyBhdHRycyArICc+JyArDQogICAgICAgICAgICAgICAgaW5uZXJIdG1sICsNCiAgICAgICAgICAgICAgICAnPC9zcGFuPic7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLmdldEFsbERheUh0bWwgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHJldHVybiB0aGlzLm9wdCgnYWxsRGF5SHRtbCcpIHx8IHV0aWxfMS5odG1sRXNjYXBlKHRoaXMub3B0KCdhbGxEYXlUZXh0JykpOw0KICAgIH07DQogICAgLy8gQ29tcHV0ZXMgSFRNTCBjbGFzc05hbWVzIGZvciBhIHNpbmdsZS1kYXkgZWxlbWVudA0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLmdldERheUNsYXNzZXMgPSBmdW5jdGlvbiAoZGF0ZSwgbm9UaGVtZUhpZ2hsaWdodCkgew0KICAgICAgICB2YXIgdmlldyA9IHRoaXMuX2dldFZpZXcoKTsNCiAgICAgICAgdmFyIGNsYXNzZXMgPSBbXTsNCiAgICAgICAgdmFyIHRvZGF5Ow0KICAgICAgICBpZiAoIXRoaXMuZGF0ZVByb2ZpbGUuYWN0aXZlVW56b25lZFJhbmdlLmNvbnRhaW5zRGF0ZShkYXRlKSkgew0KICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKCdmYy1kaXNhYmxlZC1kYXknKTsgLy8gVE9ETzogalF1ZXJ5IFVJIHRoZW1lPw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKCdmYy0nICsgdXRpbF8xLmRheUlEc1tkYXRlLmRheSgpXSk7DQogICAgICAgICAgICBpZiAodmlldy5pc0RhdGVJbk90aGVyTW9udGgoZGF0ZSwgdGhpcy5kYXRlUHJvZmlsZSkpIHsNCiAgICAgICAgICAgICAgICBjbGFzc2VzLnB1c2goJ2ZjLW90aGVyLW1vbnRoJyk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0b2RheSA9IHZpZXcuY2FsZW5kYXIuZ2V0Tm93KCk7DQogICAgICAgICAgICBpZiAoZGF0ZS5pc1NhbWUodG9kYXksICdkYXknKSkgew0KICAgICAgICAgICAgICAgIGNsYXNzZXMucHVzaCgnZmMtdG9kYXknKTsNCiAgICAgICAgICAgICAgICBpZiAobm9UaGVtZUhpZ2hsaWdodCAhPT0gdHJ1ZSkgew0KICAgICAgICAgICAgICAgICAgICBjbGFzc2VzLnB1c2godmlldy5jYWxlbmRhci50aGVtZS5nZXRDbGFzcygndG9kYXknKSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAoZGF0ZSA8IHRvZGF5KSB7DQogICAgICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKCdmYy1wYXN0Jyk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICBjbGFzc2VzLnB1c2goJ2ZjLWZ1dHVyZScpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiBjbGFzc2VzOw0KICAgIH07DQogICAgLy8gVXRpbGl0eSBmb3IgZm9ybWF0dGluZyBhIHJhbmdlLiBBY2NlcHRzIGEgcmFuZ2Ugb2JqZWN0LCBmb3JtYXR0aW5nIHN0cmluZywgYW5kIG9wdGlvbmFsIHNlcGFyYXRvci4NCiAgICAvLyBEaXNwbGF5cyBhbGwtZGF5IHJhbmdlcyBuYXR1cmFsbHksIHdpdGggYW4gaW5jbHVzaXZlIGVuZC4gVGFrZXMgdGhlIGN1cnJlbnQgaXNSVEwgaW50byBhY2NvdW50Lg0KICAgIC8vIFRoZSB0aW1lem9uZXMgb2YgdGhlIGRhdGVzIHdpdGhpbiBgcmFuZ2VgIHdpbGwgYmUgcmVzcGVjdGVkLg0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLmZvcm1hdFJhbmdlID0gZnVuY3Rpb24gKHJhbmdlLCBpc0FsbERheSwgZm9ybWF0U3RyLCBzZXBhcmF0b3IpIHsNCiAgICAgICAgdmFyIGVuZCA9IHJhbmdlLmVuZDsNCiAgICAgICAgaWYgKGlzQWxsRGF5KSB7DQogICAgICAgICAgICBlbmQgPSBlbmQuY2xvbmUoKS5zdWJ0cmFjdCgxKTsgLy8gY29udmVydCB0byBpbmNsdXNpdmUuIGxhc3QgbXMgb2YgcHJldmlvdXMgZGF5DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGRhdGVfZm9ybWF0dGluZ18xLmZvcm1hdFJhbmdlKHJhbmdlLnN0YXJ0LCBlbmQsIGZvcm1hdFN0ciwgc2VwYXJhdG9yLCB0aGlzLmlzUlRMKTsNCiAgICB9Ow0KICAgIC8vIENvbXB1dGUgdGhlIG51bWJlciBvZiB0aGUgZ2l2ZSB1bml0cyBpbiB0aGUgImN1cnJlbnQiIHJhbmdlLg0KICAgIC8vIFdpbGwgcmV0dXJuIGEgZmxvYXRpbmctcG9pbnQgbnVtYmVyLiBXb24ndCByb3VuZC4NCiAgICBEYXRlQ29tcG9uZW50LnByb3RvdHlwZS5jdXJyZW50UmFuZ2VBcyA9IGZ1bmN0aW9uICh1bml0KSB7DQogICAgICAgIHJldHVybiB0aGlzLl9nZXREYXRlUHJvZmlsZSgpLmN1cnJlbnRVbnpvbmVkUmFuZ2UuYXModW5pdCk7DQogICAgfTsNCiAgICAvLyBSZXR1cm5zIHRoZSBkYXRlIHJhbmdlIG9mIHRoZSBmdWxsIGRheXMgdGhlIGdpdmVuIHJhbmdlIHZpc3VhbGx5IGFwcGVhcnMgdG8gb2NjdXB5Lg0KICAgIC8vIFJldHVybnMgYSBwbGFpbiBvYmplY3Qgd2l0aCBzdGFydC9lbmQsIE5PVCBhbiBVbnpvbmVkUmFuZ2UhDQogICAgRGF0ZUNvbXBvbmVudC5wcm90b3R5cGUuY29tcHV0ZURheVJhbmdlID0gZnVuY3Rpb24gKHVuem9uZWRSYW5nZSkgew0KICAgICAgICB2YXIgY2FsZW5kYXIgPSB0aGlzLl9nZXRDYWxlbmRhcigpOw0KICAgICAgICB2YXIgc3RhcnREYXkgPSBjYWxlbmRhci5tc1RvVXRjTW9tZW50KHVuem9uZWRSYW5nZS5zdGFydE1zLCB0cnVlKTsgLy8gdGhlIGJlZ2lubmluZyBvZiB0aGUgZGF5IHRoZSByYW5nZSBzdGFydHMNCiAgICAgICAgdmFyIGVuZCA9IGNhbGVuZGFyLm1zVG9VdGNNb21lbnQodW56b25lZFJhbmdlLmVuZE1zKTsNCiAgICAgICAgdmFyIGVuZFRpbWVNUyA9ICtlbmQudGltZSgpOyAvLyAjIG9mIG1pbGxpc2Vjb25kcyBpbnRvIGBlbmREYXlgDQogICAgICAgIHZhciBlbmREYXkgPSBlbmQuY2xvbmUoKS5zdHJpcFRpbWUoKTsgLy8gdGhlIGJlZ2lubmluZyBvZiB0aGUgZGF5IHRoZSByYW5nZSBleGNsdXNpdmVseSBlbmRzDQogICAgICAgIC8vIElmIHRoZSBlbmQgdGltZSBpcyBhY3R1YWxseSBpbmNsdXNpdmVseSBwYXJ0IG9mIHRoZSBuZXh0IGRheSBhbmQgaXMgZXF1YWwgdG8gb3INCiAgICAgICAgLy8gYmV5b25kIHRoZSBuZXh0IGRheSB0aHJlc2hvbGQsIGFkanVzdCB0aGUgZW5kIHRvIGJlIHRoZSBleGNsdXNpdmUgZW5kIG9mIGBlbmREYXlgLg0KICAgICAgICAvLyBPdGhlcndpc2UsIGxlYXZpbmcgaXQgYXMgaW5jbHVzaXZlIHdpbGwgY2F1c2UgaXQgdG8gZXhjbHVkZSBgZW5kRGF5YC4NCiAgICAgICAgaWYgKGVuZFRpbWVNUyAmJiBlbmRUaW1lTVMgPj0gdGhpcy5uZXh0RGF5VGhyZXNob2xkKSB7DQogICAgICAgICAgICBlbmREYXkuYWRkKDEsICdkYXlzJyk7DQogICAgICAgIH0NCiAgICAgICAgLy8gSWYgZW5kIGlzIHdpdGhpbiBgc3RhcnREYXlgIGJ1dCBub3QgcGFzdCBuZXh0RGF5VGhyZXNob2xkLCBhc3NpZ24gdGhlIGRlZmF1bHQgZHVyYXRpb24gb2Ygb25lIGRheS4NCiAgICAgICAgaWYgKGVuZERheSA8PSBzdGFydERheSkgew0KICAgICAgICAgICAgZW5kRGF5ID0gc3RhcnREYXkuY2xvbmUoKS5hZGQoMSwgJ2RheXMnKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4geyBzdGFydDogc3RhcnREYXksIGVuZDogZW5kRGF5IH07DQogICAgfTsNCiAgICAvLyBEb2VzIHRoZSBnaXZlbiByYW5nZSB2aXN1YWxseSBhcHBlYXIgdG8gb2NjdXB5IG1vcmUgdGhhbiBvbmUgZGF5Pw0KICAgIERhdGVDb21wb25lbnQucHJvdG90eXBlLmlzTXVsdGlEYXlSYW5nZSA9IGZ1bmN0aW9uICh1bnpvbmVkUmFuZ2UpIHsNCiAgICAgICAgdmFyIGRheVJhbmdlID0gdGhpcy5jb21wdXRlRGF5UmFuZ2UodW56b25lZFJhbmdlKTsNCiAgICAgICAgcmV0dXJuIGRheVJhbmdlLmVuZC5kaWZmKGRheVJhbmdlLnN0YXJ0LCAnZGF5cycpID4gMTsNCiAgICB9Ow0KICAgIERhdGVDb21wb25lbnQuZ3VpZCA9IDA7IC8vIFRPRE86IGJldHRlciBzeXN0ZW0gZm9yIHRoaXM/DQogICAgcmV0dXJuIERhdGVDb21wb25lbnQ7DQp9KENvbXBvbmVudF8xLmRlZmF1bHQpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IERhdGVDb21wb25lbnQ7DQovLyBsZWdhY3kNCmZ1bmN0aW9uIGNvbnZlcnRFdmVudHNQYXlsb2FkVG9MZWdhY3lBcnJheShldmVudHNQYXlsb2FkKSB7DQogICAgdmFyIGV2ZW50RGVmSWQ7DQogICAgdmFyIGV2ZW50SW5zdGFuY2VzOw0KICAgIHZhciBsZWdhY3lFdmVudHMgPSBbXTsNCiAgICB2YXIgaTsNCiAgICBmb3IgKGV2ZW50RGVmSWQgaW4gZXZlbnRzUGF5bG9hZCkgew0KICAgICAgICBldmVudEluc3RhbmNlcyA9IGV2ZW50c1BheWxvYWRbZXZlbnREZWZJZF0uZXZlbnRJbnN0YW5jZXM7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBldmVudEluc3RhbmNlcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgbGVnYWN5RXZlbnRzLnB1c2goZXZlbnRJbnN0YW5jZXNbaV0udG9MZWdhY3koKSk7DQogICAgICAgIH0NCiAgICB9DQogICAgcmV0dXJuIGxlZ2FjeUV2ZW50czsNCn0NCgoKLyoqKi8gfSksCi8qIDIyMCAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyICQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOw0KdmFyIG1vbWVudCA9IF9fd2VicGFja19yZXF1aXJlX18oMCk7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCnZhciBvcHRpb25zXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMxKTsNCnZhciBJdGVyYXRvcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMzgpOw0KdmFyIEdsb2JhbEVtaXR0ZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTUpOw0KdmFyIEVtaXR0ZXJNaXhpbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMSk7DQp2YXIgTGlzdGVuZXJNaXhpbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg3KTsNCnZhciBUb29sYmFyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIzOSk7DQp2YXIgT3B0aW9uc01hbmFnZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjQwKTsNCnZhciBWaWV3U3BlY01hbmFnZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjQxKTsNCnZhciBDb25zdHJhaW50c18xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMDcpOw0KdmFyIGxvY2FsZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzMCk7DQp2YXIgbW9tZW50X2V4dF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMCk7DQp2YXIgVW56b25lZFJhbmdlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUpOw0KdmFyIENvbXBvbmVudEZvb3RwcmludF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMik7DQp2YXIgRXZlbnREYXRlUHJvZmlsZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxOCk7DQp2YXIgRXZlbnRNYW5hZ2VyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI0Mik7DQp2YXIgQnVzaW5lc3NIb3VyR2VuZXJhdG9yXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIxMik7DQp2YXIgRXZlbnRTb3VyY2VQYXJzZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMzcpOw0KdmFyIEV2ZW50RGVmUGFyc2VyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQ5KTsNCnZhciBTaW5nbGVFdmVudERlZl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMyk7DQp2YXIgRXZlbnREZWZNdXRhdGlvbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzNik7DQp2YXIgRXZlbnRTb3VyY2VfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNik7DQp2YXIgVGhlbWVSZWdpc3RyeV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1MSk7DQp2YXIgQ2FsZW5kYXIgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7DQogICAgZnVuY3Rpb24gQ2FsZW5kYXIoZWwsIG92ZXJyaWRlcykgew0KICAgICAgICB0aGlzLmxvYWRpbmdMZXZlbCA9IDA7IC8vIG51bWJlciBvZiBzaW11bHRhbmVvdXMgbG9hZGluZyB0YXNrcw0KICAgICAgICB0aGlzLmlnbm9yZVVwZGF0ZVZpZXdTaXplID0gMDsNCiAgICAgICAgdGhpcy5mcmVlemVDb250ZW50SGVpZ2h0RGVwdGggPSAwOw0KICAgICAgICAvLyBkZWNsYXJlIHRoZSBjdXJyZW50IGNhbGVuZGFyIGluc3RhbmNlIHJlbGllcyBvbiBHbG9iYWxFbWl0dGVyLiBuZWVkZWQgZm9yIGdhcmJhZ2UgY29sbGVjdGlvbi4NCiAgICAgICAgLy8gdW5uZWVkZWQoKSBpcyBjYWxsZWQgaW4gZGVzdHJveS4NCiAgICAgICAgR2xvYmFsRW1pdHRlcl8xLmRlZmF1bHQubmVlZGVkKCk7DQogICAgICAgIHRoaXMuZWwgPSBlbDsNCiAgICAgICAgdGhpcy52aWV3c0J5VHlwZSA9IHt9Ow0KICAgICAgICB0aGlzLm9wdGlvbnNNYW5hZ2VyID0gbmV3IE9wdGlvbnNNYW5hZ2VyXzEuZGVmYXVsdCh0aGlzLCBvdmVycmlkZXMpOw0KICAgICAgICB0aGlzLnZpZXdTcGVjTWFuYWdlciA9IG5ldyBWaWV3U3BlY01hbmFnZXJfMS5kZWZhdWx0KHRoaXMub3B0aW9uc01hbmFnZXIsIHRoaXMpOw0KICAgICAgICB0aGlzLmluaXRNb21lbnRJbnRlcm5hbHMoKTsgLy8gbmVlZHMgdG8gaGFwcGVuIGFmdGVyIG9wdGlvbnMgaGFzaCBpbml0aWFsaXplZA0KICAgICAgICB0aGlzLmluaXRDdXJyZW50RGF0ZSgpOw0KICAgICAgICB0aGlzLmluaXRFdmVudE1hbmFnZXIoKTsNCiAgICAgICAgdGhpcy5jb25zdHJhaW50cyA9IG5ldyBDb25zdHJhaW50c18xLmRlZmF1bHQodGhpcy5ldmVudE1hbmFnZXIsIHRoaXMpOw0KICAgICAgICB0aGlzLmNvbnN0cnVjdGVkKCk7DQogICAgfQ0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5jb25zdHJ1Y3RlZCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgLy8gdXNlZnVsIGZvciBtb25rZXlwYXRjaGluZy4gdXNlZD8NCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5nZXRWaWV3ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gdGhpcy52aWV3Ow0KICAgIH07DQogICAgQ2FsZW5kYXIucHJvdG90eXBlLnB1YmxpY2x5VHJpZ2dlciA9IGZ1bmN0aW9uIChuYW1lLCB0cmlnZ2VySW5mbykgew0KICAgICAgICB2YXIgb3B0SGFuZGxlciA9IHRoaXMub3B0KG5hbWUpOw0KICAgICAgICB2YXIgY29udGV4dDsNCiAgICAgICAgdmFyIGFyZ3M7DQogICAgICAgIGlmICgkLmlzUGxhaW5PYmplY3QodHJpZ2dlckluZm8pKSB7DQogICAgICAgICAgICBjb250ZXh0ID0gdHJpZ2dlckluZm8uY29udGV4dDsNCiAgICAgICAgICAgIGFyZ3MgPSB0cmlnZ2VySW5mby5hcmdzOw0KICAgICAgICB9DQogICAgICAgIGVsc2UgaWYgKCQuaXNBcnJheSh0cmlnZ2VySW5mbykpIHsNCiAgICAgICAgICAgIGFyZ3MgPSB0cmlnZ2VySW5mbzsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoY29udGV4dCA9PSBudWxsKSB7DQogICAgICAgICAgICBjb250ZXh0ID0gdGhpcy5lbFswXTsgLy8gZmFsbGJhY2sgY29udGV4dA0KICAgICAgICB9DQogICAgICAgIGlmICghYXJncykgew0KICAgICAgICAgICAgYXJncyA9IFtdOw0KICAgICAgICB9DQogICAgICAgIHRoaXMudHJpZ2dlcldpdGgobmFtZSwgY29udGV4dCwgYXJncyk7IC8vIEVtaXR0ZXIncyBtZXRob2QNCiAgICAgICAgaWYgKG9wdEhhbmRsZXIpIHsNCiAgICAgICAgICAgIHJldHVybiBvcHRIYW5kbGVyLmFwcGx5KGNvbnRleHQsIGFyZ3MpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBDYWxlbmRhci5wcm90b3R5cGUuaGFzUHVibGljSGFuZGxlcnMgPSBmdW5jdGlvbiAobmFtZSkgew0KICAgICAgICByZXR1cm4gdGhpcy5oYXNIYW5kbGVycyhuYW1lKSB8fA0KICAgICAgICAgICAgdGhpcy5vcHQobmFtZSk7IC8vIGhhbmRsZXIgc3BlY2lmaWVkIGluIG9wdGlvbnMNCiAgICB9Ow0KICAgIC8vIE9wdGlvbnMgUHVibGljIEFQSQ0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgLy8gcHVibGljIGdldHRlci9zZXR0ZXINCiAgICBDYWxlbmRhci5wcm90b3R5cGUub3B0aW9uID0gZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7DQogICAgICAgIHZhciBuZXdPcHRpb25IYXNoOw0KICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnKSB7DQogICAgICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnNNYW5hZ2VyLmdldChuYW1lKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIG5ld09wdGlvbkhhc2ggPSB7fTsNCiAgICAgICAgICAgICAgICBuZXdPcHRpb25IYXNoW25hbWVdID0gdmFsdWU7DQogICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zTWFuYWdlci5hZGQobmV3T3B0aW9uSGFzaCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSB7DQogICAgICAgICAgICB0aGlzLm9wdGlvbnNNYW5hZ2VyLmFkZChuYW1lKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gcHJpdmF0ZSBnZXR0ZXINCiAgICBDYWxlbmRhci5wcm90b3R5cGUub3B0ID0gZnVuY3Rpb24gKG5hbWUpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9uc01hbmFnZXIuZ2V0KG5hbWUpOw0KICAgIH07DQogICAgLy8gVmlldw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgLy8gR2l2ZW4gYSB2aWV3IG5hbWUgZm9yIGEgY3VzdG9tIHZpZXcgb3IgYSBzdGFuZGFyZCB2aWV3LCBjcmVhdGVzIGEgcmVhZHktdG8tZ28gVmlldyBvYmplY3QNCiAgICBDYWxlbmRhci5wcm90b3R5cGUuaW5zdGFudGlhdGVWaWV3ID0gZnVuY3Rpb24gKHZpZXdUeXBlKSB7DQogICAgICAgIHZhciBzcGVjID0gdGhpcy52aWV3U3BlY01hbmFnZXIuZ2V0Vmlld1NwZWModmlld1R5cGUpOw0KICAgICAgICBpZiAoIXNwZWMpIHsNCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVmlldyB0eXBlIFwiIiArIHZpZXdUeXBlICsgIlwiIGlzIG5vdCB2YWxpZCIpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBuZXcgc3BlY1snY2xhc3MnXSh0aGlzLCBzcGVjKTsNCiAgICB9Ow0KICAgIC8vIFJldHVybnMgYSBib29sZWFuIGFib3V0IHdoZXRoZXIgdGhlIHZpZXcgaXMgb2theSB0byBpbnN0YW50aWF0ZSBhdCBzb21lIHBvaW50DQogICAgQ2FsZW5kYXIucHJvdG90eXBlLmlzVmFsaWRWaWV3VHlwZSA9IGZ1bmN0aW9uICh2aWV3VHlwZSkgew0KICAgICAgICByZXR1cm4gQm9vbGVhbih0aGlzLnZpZXdTcGVjTWFuYWdlci5nZXRWaWV3U3BlYyh2aWV3VHlwZSkpOw0KICAgIH07DQogICAgQ2FsZW5kYXIucHJvdG90eXBlLmNoYW5nZVZpZXcgPSBmdW5jdGlvbiAodmlld05hbWUsIGRhdGVPclJhbmdlKSB7DQogICAgICAgIGlmIChkYXRlT3JSYW5nZSkgew0KICAgICAgICAgICAgaWYgKGRhdGVPclJhbmdlLnN0YXJ0ICYmIGRhdGVPclJhbmdlLmVuZCkgew0KICAgICAgICAgICAgICAgIHRoaXMub3B0aW9uc01hbmFnZXIucmVjb3JkT3ZlcnJpZGVzKHsNCiAgICAgICAgICAgICAgICAgICAgdmlzaWJsZVJhbmdlOiBkYXRlT3JSYW5nZQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RGF0ZSA9IHRoaXMubW9tZW50KGRhdGVPclJhbmdlKS5zdHJpcFpvbmUoKTsgLy8ganVzdCBsaWtlIGdvdG9EYXRlDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5yZW5kZXJWaWV3KHZpZXdOYW1lKTsNCiAgICB9Ow0KICAgIC8vIEZvcmNlcyBuYXZpZ2F0aW9uIHRvIGEgdmlldyBmb3IgdGhlIGdpdmVuIGRhdGUuDQogICAgLy8gYHZpZXdUeXBlYCBjYW4gYmUgYSBzcGVjaWZpYyB2aWV3IG5hbWUgb3IgYSBnZW5lcmljIG9uZSBsaWtlICJ3ZWVrIiBvciAiZGF5Ii4NCiAgICBDYWxlbmRhci5wcm90b3R5cGUuem9vbVRvID0gZnVuY3Rpb24gKG5ld0RhdGUsIHZpZXdUeXBlKSB7DQogICAgICAgIHZhciBzcGVjOw0KICAgICAgICB2aWV3VHlwZSA9IHZpZXdUeXBlIHx8ICdkYXknOyAvLyBkYXkgaXMgZGVmYXVsdCB6b29tDQogICAgICAgIHNwZWMgPSB0aGlzLnZpZXdTcGVjTWFuYWdlci5nZXRWaWV3U3BlYyh2aWV3VHlwZSkgfHwNCiAgICAgICAgICAgIHRoaXMudmlld1NwZWNNYW5hZ2VyLmdldFVuaXRWaWV3U3BlYyh2aWV3VHlwZSk7DQogICAgICAgIHRoaXMuY3VycmVudERhdGUgPSBuZXdEYXRlLmNsb25lKCk7DQogICAgICAgIHRoaXMucmVuZGVyVmlldyhzcGVjID8gc3BlYy50eXBlIDogbnVsbCk7DQogICAgfTsNCiAgICAvLyBDdXJyZW50IERhdGUNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5pbml0Q3VycmVudERhdGUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBkZWZhdWx0RGF0ZUlucHV0ID0gdGhpcy5vcHQoJ2RlZmF1bHREYXRlJyk7DQogICAgICAgIC8vIGNvbXB1dGUgdGhlIGluaXRpYWwgYW1iaWctdGltZXpvbmUgZGF0ZQ0KICAgICAgICBpZiAoZGVmYXVsdERhdGVJbnB1dCAhPSBudWxsKSB7DQogICAgICAgICAgICB0aGlzLmN1cnJlbnREYXRlID0gdGhpcy5tb21lbnQoZGVmYXVsdERhdGVJbnB1dCkuc3RyaXBab25lKCk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICB0aGlzLmN1cnJlbnREYXRlID0gdGhpcy5nZXROb3coKTsgLy8gZ2V0Tm93IGFscmVhZHkgcmV0dXJucyB1bnpvbmVkDQogICAgICAgIH0NCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5wcmV2ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgdmlldyA9IHRoaXMudmlldzsNCiAgICAgICAgdmFyIHByZXZJbmZvID0gdmlldy5kYXRlUHJvZmlsZUdlbmVyYXRvci5idWlsZFByZXYodmlldy5nZXQoJ2RhdGVQcm9maWxlJykpOw0KICAgICAgICBpZiAocHJldkluZm8uaXNWYWxpZCkgew0KICAgICAgICAgICAgdGhpcy5jdXJyZW50RGF0ZSA9IHByZXZJbmZvLmRhdGU7DQogICAgICAgICAgICB0aGlzLnJlbmRlclZpZXcoKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgQ2FsZW5kYXIucHJvdG90eXBlLm5leHQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciB2aWV3ID0gdGhpcy52aWV3Ow0KICAgICAgICB2YXIgbmV4dEluZm8gPSB2aWV3LmRhdGVQcm9maWxlR2VuZXJhdG9yLmJ1aWxkTmV4dCh2aWV3LmdldCgnZGF0ZVByb2ZpbGUnKSk7DQogICAgICAgIGlmIChuZXh0SW5mby5pc1ZhbGlkKSB7DQogICAgICAgICAgICB0aGlzLmN1cnJlbnREYXRlID0gbmV4dEluZm8uZGF0ZTsNCiAgICAgICAgICAgIHRoaXMucmVuZGVyVmlldygpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBDYWxlbmRhci5wcm90b3R5cGUucHJldlllYXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMuY3VycmVudERhdGUuYWRkKC0xLCAneWVhcnMnKTsNCiAgICAgICAgdGhpcy5yZW5kZXJWaWV3KCk7DQogICAgfTsNCiAgICBDYWxlbmRhci5wcm90b3R5cGUubmV4dFllYXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMuY3VycmVudERhdGUuYWRkKDEsICd5ZWFycycpOw0KICAgICAgICB0aGlzLnJlbmRlclZpZXcoKTsNCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS50b2RheSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5jdXJyZW50RGF0ZSA9IHRoaXMuZ2V0Tm93KCk7IC8vIHNob3VsZCBkZW55IGxpa2UgcHJldi9uZXh0Pw0KICAgICAgICB0aGlzLnJlbmRlclZpZXcoKTsNCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5nb3RvRGF0ZSA9IGZ1bmN0aW9uICh6b25lZERhdGVJbnB1dCkgew0KICAgICAgICB0aGlzLmN1cnJlbnREYXRlID0gdGhpcy5tb21lbnQoem9uZWREYXRlSW5wdXQpLnN0cmlwWm9uZSgpOw0KICAgICAgICB0aGlzLnJlbmRlclZpZXcoKTsNCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5pbmNyZW1lbnREYXRlID0gZnVuY3Rpb24gKGRlbHRhKSB7DQogICAgICAgIHRoaXMuY3VycmVudERhdGUuYWRkKG1vbWVudC5kdXJhdGlvbihkZWx0YSkpOw0KICAgICAgICB0aGlzLnJlbmRlclZpZXcoKTsNCiAgICB9Ow0KICAgIC8vIGZvciBleHRlcm5hbCBBUEkNCiAgICBDYWxlbmRhci5wcm90b3R5cGUuZ2V0RGF0ZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuYXBwbHlUaW1lem9uZSh0aGlzLmN1cnJlbnREYXRlKTsgLy8gaW5mdXNlIHRoZSBjYWxlbmRhcidzIHRpbWV6b25lDQogICAgfTsNCiAgICAvLyBMb2FkaW5nIFRyaWdnZXJpbmcNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIC8vIFNob3VsZCBiZSBjYWxsZWQgd2hlbiBhbnkgdHlwZSBvZiBhc3luYyBkYXRhIGZldGNoaW5nIGJlZ2lucw0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5wdXNoTG9hZGluZyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKCEodGhpcy5sb2FkaW5nTGV2ZWwrKykpIHsNCiAgICAgICAgICAgIHRoaXMucHVibGljbHlUcmlnZ2VyKCdsb2FkaW5nJywgW3RydWUsIHRoaXMudmlld10pOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBTaG91bGQgYmUgY2FsbGVkIHdoZW4gYW55IHR5cGUgb2YgYXN5bmMgZGF0YSBmZXRjaGluZyBjb21wbGV0ZXMNCiAgICBDYWxlbmRhci5wcm90b3R5cGUucG9wTG9hZGluZyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKCEoLS10aGlzLmxvYWRpbmdMZXZlbCkpIHsNCiAgICAgICAgICAgIHRoaXMucHVibGljbHlUcmlnZ2VyKCdsb2FkaW5nJywgW2ZhbHNlLCB0aGlzLnZpZXddKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gSGlnaC1sZXZlbCBSZW5kZXJpbmcNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICghdGhpcy5jb250ZW50RWwpIHsNCiAgICAgICAgICAgIHRoaXMuaW5pdGlhbFJlbmRlcigpOw0KICAgICAgICB9DQogICAgICAgIGVsc2UgaWYgKHRoaXMuZWxlbWVudFZpc2libGUoKSkgew0KICAgICAgICAgICAgLy8gbWFpbmx5IGZvciB0aGUgcHVibGljIEFQSQ0KICAgICAgICAgICAgdGhpcy5jYWxjU2l6ZSgpOw0KICAgICAgICAgICAgdGhpcy51cGRhdGVWaWV3U2l6ZSgpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBDYWxlbmRhci5wcm90b3R5cGUuaW5pdGlhbFJlbmRlciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgdmFyIGVsID0gdGhpcy5lbDsNCiAgICAgICAgZWwuYWRkQ2xhc3MoJ2ZjJyk7DQogICAgICAgIC8vIGV2ZW50IGRlbGVnYXRpb24gZm9yIG5hdiBsaW5rcw0KICAgICAgICBlbC5vbignY2xpY2suZmMnLCAnYVtkYXRhLWdvdG9dJywgZnVuY3Rpb24gKGV2KSB7DQogICAgICAgICAgICB2YXIgYW5jaG9yRWwgPSAkKGV2LmN1cnJlbnRUYXJnZXQpOw0KICAgICAgICAgICAgdmFyIGdvdG9PcHRpb25zID0gYW5jaG9yRWwuZGF0YSgnZ290bycpOyAvLyB3aWxsIGF1dG9tYXRpY2FsbHkgcGFyc2UgSlNPTg0KICAgICAgICAgICAgdmFyIGRhdGUgPSBfdGhpcy5tb21lbnQoZ290b09wdGlvbnMuZGF0ZSk7DQogICAgICAgICAgICB2YXIgdmlld1R5cGUgPSBnb3RvT3B0aW9ucy50eXBlOw0KICAgICAgICAgICAgLy8gcHJvcGVydHkgbGlrZSAibmF2TGlua0RheUNsaWNrIi4gbWlnaHQgYmUgYSBzdHJpbmcgb3IgYSBmdW5jdGlvbg0KICAgICAgICAgICAgdmFyIGN1c3RvbUFjdGlvbiA9IF90aGlzLnZpZXcub3B0KCduYXZMaW5rJyArIHV0aWxfMS5jYXBpdGFsaXNlRmlyc3RMZXR0ZXIodmlld1R5cGUpICsgJ0NsaWNrJyk7DQogICAgICAgICAgICBpZiAodHlwZW9mIGN1c3RvbUFjdGlvbiA9PT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICAgICAgICAgIGN1c3RvbUFjdGlvbihkYXRlLCBldik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGN1c3RvbUFjdGlvbiA9PT0gJ3N0cmluZycpIHsNCiAgICAgICAgICAgICAgICAgICAgdmlld1R5cGUgPSBjdXN0b21BY3Rpb247DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIF90aGlzLnpvb21UbyhkYXRlLCB2aWV3VHlwZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgICAvLyBjYWxsZWQgaW1tZWRpYXRlbHksIGFuZCB1cG9uIG9wdGlvbiBjaGFuZ2UNCiAgICAgICAgdGhpcy5vcHRpb25zTWFuYWdlci53YXRjaCgnc2V0dGluZ1RoZW1lJywgWyc/dGhlbWUnLCAnP3RoZW1lU3lzdGVtJ10sIGZ1bmN0aW9uIChvcHRzKSB7DQogICAgICAgICAgICB2YXIgdGhlbWVDbGFzcyA9IFRoZW1lUmVnaXN0cnlfMS5nZXRUaGVtZVN5c3RlbUNsYXNzKG9wdHMudGhlbWVTeXN0ZW0gfHwgb3B0cy50aGVtZSk7DQogICAgICAgICAgICB2YXIgdGhlbWUgPSBuZXcgdGhlbWVDbGFzcyhfdGhpcy5vcHRpb25zTWFuYWdlcik7DQogICAgICAgICAgICB2YXIgd2lkZ2V0Q2xhc3MgPSB0aGVtZS5nZXRDbGFzcygnd2lkZ2V0Jyk7DQogICAgICAgICAgICBfdGhpcy50aGVtZSA9IHRoZW1lOw0KICAgICAgICAgICAgaWYgKHdpZGdldENsYXNzKSB7DQogICAgICAgICAgICAgICAgZWwuYWRkQ2xhc3Mod2lkZ2V0Q2xhc3MpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9LCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICB2YXIgd2lkZ2V0Q2xhc3MgPSBfdGhpcy50aGVtZS5nZXRDbGFzcygnd2lkZ2V0Jyk7DQogICAgICAgICAgICBfdGhpcy50aGVtZSA9IG51bGw7DQogICAgICAgICAgICBpZiAod2lkZ2V0Q2xhc3MpIHsNCiAgICAgICAgICAgICAgICBlbC5yZW1vdmVDbGFzcyh3aWRnZXRDbGFzcyk7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgICB0aGlzLm9wdGlvbnNNYW5hZ2VyLndhdGNoKCdzZXR0aW5nQnVzaW5lc3NIb3VyR2VuZXJhdG9yJywgWyc/YnVzaW5lc3NIb3VycyddLCBmdW5jdGlvbiAoZGVwcykgew0KICAgICAgICAgICAgX3RoaXMuYnVzaW5lc3NIb3VyR2VuZXJhdG9yID0gbmV3IEJ1c2luZXNzSG91ckdlbmVyYXRvcl8xLmRlZmF1bHQoZGVwcy5idXNpbmVzc0hvdXJzLCBfdGhpcyk7DQogICAgICAgICAgICBpZiAoX3RoaXMudmlldykgew0KICAgICAgICAgICAgICAgIF90aGlzLnZpZXcuc2V0KCdidXNpbmVzc0hvdXJHZW5lcmF0b3InLCBfdGhpcy5idXNpbmVzc0hvdXJHZW5lcmF0b3IpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9LCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICBfdGhpcy5idXNpbmVzc0hvdXJHZW5lcmF0b3IgPSBudWxsOw0KICAgICAgICB9KTsNCiAgICAgICAgLy8gY2FsbGVkIGltbWVkaWF0ZWx5LCBhbmQgdXBvbiBvcHRpb24gY2hhbmdlLg0KICAgICAgICAvLyBIQUNLOiBsb2NhbGUgb2Z0ZW4gYWZmZWN0cyBpc1JUTCwgc28gd2UgZXhwbGljaXRseSBsaXN0ZW4gdG8gdGhhdCB0b28uDQogICAgICAgIHRoaXMub3B0aW9uc01hbmFnZXIud2F0Y2goJ2FwcGx5aW5nRGlyQ2xhc3NlcycsIFsnP2lzUlRMJywgJz9sb2NhbGUnXSwgZnVuY3Rpb24gKG9wdHMpIHsNCiAgICAgICAgICAgIGVsLnRvZ2dsZUNsYXNzKCdmYy1sdHInLCAhb3B0cy5pc1JUTCk7DQogICAgICAgICAgICBlbC50b2dnbGVDbGFzcygnZmMtcnRsJywgb3B0cy5pc1JUTCk7DQogICAgICAgIH0pOw0KICAgICAgICB0aGlzLmNvbnRlbnRFbCA9ICQoIjxkaXYgY2xhc3M9J2ZjLXZpZXctY29udGFpbmVyJy8+IikucHJlcGVuZFRvKGVsKTsNCiAgICAgICAgdGhpcy5pbml0VG9vbGJhcnMoKTsNCiAgICAgICAgdGhpcy5yZW5kZXJIZWFkZXIoKTsNCiAgICAgICAgdGhpcy5yZW5kZXJGb290ZXIoKTsNCiAgICAgICAgdGhpcy5yZW5kZXJWaWV3KHRoaXMub3B0KCdkZWZhdWx0VmlldycpKTsNCiAgICAgICAgaWYgKHRoaXMub3B0KCdoYW5kbGVXaW5kb3dSZXNpemUnKSkgew0KICAgICAgICAgICAgJCh3aW5kb3cpLnJlc2l6ZSh0aGlzLndpbmRvd1Jlc2l6ZVByb3h5ID0gdXRpbF8xLmRlYm91bmNlKC8vIHByZXZlbnRzIHJhcGlkIGNhbGxzDQogICAgICAgICAgICB0aGlzLndpbmRvd1Jlc2l6ZS5iaW5kKHRoaXMpLCB0aGlzLm9wdCgnd2luZG93UmVzaXplRGVsYXknKSkpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBDYWxlbmRhci5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMudmlldykgew0KICAgICAgICAgICAgdGhpcy5jbGVhclZpZXcoKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLnRvb2xiYXJzTWFuYWdlci5wcm94eUNhbGwoJ3JlbW92ZUVsZW1lbnQnKTsNCiAgICAgICAgdGhpcy5jb250ZW50RWwucmVtb3ZlKCk7DQogICAgICAgIHRoaXMuZWwucmVtb3ZlQ2xhc3MoJ2ZjIGZjLWx0ciBmYy1ydGwnKTsNCiAgICAgICAgLy8gcmVtb3ZlcyB0aGVtZS1yZWxhdGVkIHJvb3QgY2xhc3NOYW1lDQogICAgICAgIHRoaXMub3B0aW9uc01hbmFnZXIudW53YXRjaCgnc2V0dGluZ1RoZW1lJyk7DQogICAgICAgIHRoaXMub3B0aW9uc01hbmFnZXIudW53YXRjaCgnc2V0dGluZ0J1c2luZXNzSG91ckdlbmVyYXRvcicpOw0KICAgICAgICB0aGlzLmVsLm9mZignLmZjJyk7IC8vIHVuYmluZCBuYXYgbGluayBoYW5kbGVycw0KICAgICAgICBpZiAodGhpcy53aW5kb3dSZXNpemVQcm94eSkgew0KICAgICAgICAgICAgJCh3aW5kb3cpLnVuYmluZCgncmVzaXplJywgdGhpcy53aW5kb3dSZXNpemVQcm94eSk7DQogICAgICAgICAgICB0aGlzLndpbmRvd1Jlc2l6ZVByb3h5ID0gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICBHbG9iYWxFbWl0dGVyXzEuZGVmYXVsdC51bm5lZWRlZCgpOw0KICAgIH07DQogICAgQ2FsZW5kYXIucHJvdG90eXBlLmVsZW1lbnRWaXNpYmxlID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gdGhpcy5lbC5pcygnOnZpc2libGUnKTsNCiAgICB9Ow0KICAgIC8vIFJlbmRlciBRdWV1ZQ0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgQ2FsZW5kYXIucHJvdG90eXBlLmJpbmRWaWV3SGFuZGxlcnMgPSBmdW5jdGlvbiAodmlldykgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICB2aWV3LndhdGNoKCd0aXRsZUZvckNhbGVuZGFyJywgWyd0aXRsZSddLCBmdW5jdGlvbiAoZGVwcykgew0KICAgICAgICAgICAgaWYgKHZpZXcgPT09IF90aGlzLnZpZXcpIHsNCiAgICAgICAgICAgICAgICBfdGhpcy5zZXRUb29sYmFyc1RpdGxlKGRlcHMudGl0bGUpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgdmlldy53YXRjaCgnZGF0ZVByb2ZpbGVGb3JDYWxlbmRhcicsIFsnZGF0ZVByb2ZpbGUnXSwgZnVuY3Rpb24gKGRlcHMpIHsNCiAgICAgICAgICAgIGlmICh2aWV3ID09PSBfdGhpcy52aWV3KSB7DQogICAgICAgICAgICAgICAgX3RoaXMuY3VycmVudERhdGUgPSBkZXBzLmRhdGVQcm9maWxlLmRhdGU7IC8vIG1pZ2h0IGhhdmUgYmVlbiBjb25zdHJhaW5lZCBieSB2aWV3IGRhdGVzDQogICAgICAgICAgICAgICAgX3RoaXMudXBkYXRlVG9vbGJhckJ1dHRvbnMoZGVwcy5kYXRlUHJvZmlsZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgIH07DQogICAgQ2FsZW5kYXIucHJvdG90eXBlLnVuYmluZFZpZXdIYW5kbGVycyA9IGZ1bmN0aW9uICh2aWV3KSB7DQogICAgICAgIHZpZXcudW53YXRjaCgndGl0bGVGb3JDYWxlbmRhcicpOw0KICAgICAgICB2aWV3LnVud2F0Y2goJ2RhdGVQcm9maWxlRm9yQ2FsZW5kYXInKTsNCiAgICB9Ow0KICAgIC8vIFZpZXcgUmVuZGVyaW5nDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAvLyBSZW5kZXJzIGEgdmlldyBiZWNhdXNlIG9mIGEgZGF0ZSBjaGFuZ2UsIHZpZXctdHlwZSBjaGFuZ2UsIG9yIGZvciB0aGUgZmlyc3QgdGltZS4NCiAgICAvLyBJZiBub3QgZ2l2ZW4gYSB2aWV3VHlwZSwga2VlcCB0aGUgY3VycmVudCB2aWV3IGJ1dCByZW5kZXIgZGlmZmVyZW50IGRhdGVzLg0KICAgIC8vIEFjY2VwdHMgYW4gb3B0aW9uYWwgc2Nyb2xsIHN0YXRlIHRvIHJlc3RvcmUgdG8uDQogICAgQ2FsZW5kYXIucHJvdG90eXBlLnJlbmRlclZpZXcgPSBmdW5jdGlvbiAodmlld1R5cGUpIHsNCiAgICAgICAgdmFyIG9sZFZpZXcgPSB0aGlzLnZpZXc7DQogICAgICAgIHZhciBuZXdWaWV3Ow0KICAgICAgICB0aGlzLmZyZWV6ZUNvbnRlbnRIZWlnaHQoKTsNCiAgICAgICAgaWYgKG9sZFZpZXcgJiYgdmlld1R5cGUgJiYgb2xkVmlldy50eXBlICE9PSB2aWV3VHlwZSkgew0KICAgICAgICAgICAgdGhpcy5jbGVhclZpZXcoKTsNCiAgICAgICAgfQ0KICAgICAgICAvLyBpZiB2aWV3VHlwZSBjaGFuZ2VkLCBvciB0aGUgdmlldyB3YXMgbmV2ZXIgY3JlYXRlZCwgY3JlYXRlIGEgZnJlc2ggdmlldw0KICAgICAgICBpZiAoIXRoaXMudmlldyAmJiB2aWV3VHlwZSkgew0KICAgICAgICAgICAgbmV3VmlldyA9IHRoaXMudmlldyA9DQogICAgICAgICAgICAgICAgdGhpcy52aWV3c0J5VHlwZVt2aWV3VHlwZV0gfHwNCiAgICAgICAgICAgICAgICAgICAgKHRoaXMudmlld3NCeVR5cGVbdmlld1R5cGVdID0gdGhpcy5pbnN0YW50aWF0ZVZpZXcodmlld1R5cGUpKTsNCiAgICAgICAgICAgIHRoaXMuYmluZFZpZXdIYW5kbGVycyhuZXdWaWV3KTsNCiAgICAgICAgICAgIG5ld1ZpZXcuc3RhcnRCYXRjaFJlbmRlcigpOyAvLyBzbyB0aGF0IHNldEVsZW1lbnQrc2V0RGF0ZSByZW5kZXJpbmcgYXJlIGpvaW5lZA0KICAgICAgICAgICAgbmV3Vmlldy5zZXRFbGVtZW50KCQoIjxkaXYgY2xhc3M9J2ZjLXZpZXcgZmMtIiArIHZpZXdUeXBlICsgIi12aWV3JyAvPiIpLmFwcGVuZFRvKHRoaXMuY29udGVudEVsKSk7DQogICAgICAgICAgICB0aGlzLnRvb2xiYXJzTWFuYWdlci5wcm94eUNhbGwoJ2FjdGl2YXRlQnV0dG9uJywgdmlld1R5cGUpOw0KICAgICAgICB9DQogICAgICAgIGlmICh0aGlzLnZpZXcpIHsNCiAgICAgICAgICAgIC8vIHByZXZlbnQgdW5uZWNlc3NhcnkgY2hhbmdlIGZpcmluZw0KICAgICAgICAgICAgaWYgKHRoaXMudmlldy5nZXQoJ2J1c2luZXNzSG91ckdlbmVyYXRvcicpICE9PSB0aGlzLmJ1c2luZXNzSG91ckdlbmVyYXRvcikgew0KICAgICAgICAgICAgICAgIHRoaXMudmlldy5zZXQoJ2J1c2luZXNzSG91ckdlbmVyYXRvcicsIHRoaXMuYnVzaW5lc3NIb3VyR2VuZXJhdG9yKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMudmlldy5zZXREYXRlKHRoaXMuY3VycmVudERhdGUpOw0KICAgICAgICAgICAgaWYgKG5ld1ZpZXcpIHsNCiAgICAgICAgICAgICAgICBuZXdWaWV3LnN0b3BCYXRjaFJlbmRlcigpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHRoaXMudGhhd0NvbnRlbnRIZWlnaHQoKTsNCiAgICB9Ow0KICAgIC8vIFVucmVuZGVycyB0aGUgY3VycmVudCB2aWV3IGFuZCByZWZsZWN0cyB0aGlzIGNoYW5nZSBpbiB0aGUgSGVhZGVyLg0KICAgIC8vIFVucmVnc2l0ZXJzIHRoZSBgdmlld2AsIGJ1dCBkb2VzIG5vdCByZW1vdmUgZnJvbSB2aWV3QnlUeXBlIGhhc2guDQogICAgQ2FsZW5kYXIucHJvdG90eXBlLmNsZWFyVmlldyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIGN1cnJlbnRWaWV3ID0gdGhpcy52aWV3Ow0KICAgICAgICB0aGlzLnRvb2xiYXJzTWFuYWdlci5wcm94eUNhbGwoJ2RlYWN0aXZhdGVCdXR0b24nLCBjdXJyZW50Vmlldy50eXBlKTsNCiAgICAgICAgdGhpcy51bmJpbmRWaWV3SGFuZGxlcnMoY3VycmVudFZpZXcpOw0KICAgICAgICBjdXJyZW50Vmlldy5yZW1vdmVFbGVtZW50KCk7DQogICAgICAgIGN1cnJlbnRWaWV3LnVuc2V0RGF0ZSgpOyAvLyBzbyBiaW5kVmlld0hhbmRsZXJzIGRvZXNuJ3QgZmlyZSB3aXRoIG9sZCB2YWx1ZXMgbmV4dCB0aW1lDQogICAgICAgIHRoaXMudmlldyA9IG51bGw7DQogICAgfTsNCiAgICAvLyBEZXN0cm95cyB0aGUgdmlldywgaW5jbHVkaW5nIHRoZSB2aWV3IG9iamVjdC4gVGhlbiwgcmUtaW5zdGFudGlhdGVzIGl0IGFuZCByZW5kZXJzIGl0Lg0KICAgIC8vIE1haW50YWlucyB0aGUgc2FtZSBzY3JvbGwgc3RhdGUuDQogICAgLy8gVE9ETzogbWFpbnRhaW4gYW55IG90aGVyIHVzZXItbWFuaXB1bGF0ZWQgc3RhdGUuDQogICAgQ2FsZW5kYXIucHJvdG90eXBlLnJlaW5pdFZpZXcgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBvbGRWaWV3ID0gdGhpcy52aWV3Ow0KICAgICAgICB2YXIgc2Nyb2xsID0gb2xkVmlldy5xdWVyeVNjcm9sbCgpOyAvLyB3b3VsZG4ndCBiZSBzbyBjb21wbGljYXRlZCBpZiBDYWxlbmRhciBvd25lZCB0aGUgc2Nyb2xsDQogICAgICAgIHRoaXMuZnJlZXplQ29udGVudEhlaWdodCgpOw0KICAgICAgICB0aGlzLmNsZWFyVmlldygpOw0KICAgICAgICB0aGlzLmNhbGNTaXplKCk7DQogICAgICAgIHRoaXMucmVuZGVyVmlldyhvbGRWaWV3LnR5cGUpOyAvLyBuZWVkcyB0aGUgdHlwZSB0byBmcmVzaGx5IHJlbmRlcg0KICAgICAgICB0aGlzLnZpZXcuYXBwbHlTY3JvbGwoc2Nyb2xsKTsNCiAgICAgICAgdGhpcy50aGF3Q29udGVudEhlaWdodCgpOw0KICAgIH07DQogICAgLy8gUmVzaXppbmcNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5nZXRTdWdnZXN0ZWRWaWV3SGVpZ2h0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5zdWdnZXN0ZWRWaWV3SGVpZ2h0ID09IG51bGwpIHsNCiAgICAgICAgICAgIHRoaXMuY2FsY1NpemUoKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpcy5zdWdnZXN0ZWRWaWV3SGVpZ2h0Ow0KICAgIH07DQogICAgQ2FsZW5kYXIucHJvdG90eXBlLmlzSGVpZ2h0QXV0byA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMub3B0KCdjb250ZW50SGVpZ2h0JykgPT09ICdhdXRvJyB8fCB0aGlzLm9wdCgnaGVpZ2h0JykgPT09ICdhdXRvJzsNCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS51cGRhdGVWaWV3U2l6ZSA9IGZ1bmN0aW9uIChpc1Jlc2l6ZSkgew0KICAgICAgICBpZiAoaXNSZXNpemUgPT09IHZvaWQgMCkgeyBpc1Jlc2l6ZSA9IGZhbHNlOyB9DQogICAgICAgIHZhciB2aWV3ID0gdGhpcy52aWV3Ow0KICAgICAgICB2YXIgc2Nyb2xsOw0KICAgICAgICBpZiAoIXRoaXMuaWdub3JlVXBkYXRlVmlld1NpemUgJiYgdmlldykgew0KICAgICAgICAgICAgaWYgKGlzUmVzaXplKSB7DQogICAgICAgICAgICAgICAgdGhpcy5jYWxjU2l6ZSgpOw0KICAgICAgICAgICAgICAgIHNjcm9sbCA9IHZpZXcucXVlcnlTY3JvbGwoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMuaWdub3JlVXBkYXRlVmlld1NpemUrKzsNCiAgICAgICAgICAgIHZpZXcudXBkYXRlU2l6ZSh0aGlzLmdldFN1Z2dlc3RlZFZpZXdIZWlnaHQoKSwgdGhpcy5pc0hlaWdodEF1dG8oKSwgaXNSZXNpemUpOw0KICAgICAgICAgICAgdGhpcy5pZ25vcmVVcGRhdGVWaWV3U2l6ZS0tOw0KICAgICAgICAgICAgaWYgKGlzUmVzaXplKSB7DQogICAgICAgICAgICAgICAgdmlldy5hcHBseVNjcm9sbChzY3JvbGwpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIHNpZ25hbCBzdWNjZXNzDQogICAgICAgIH0NCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5jYWxjU2l6ZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMuZWxlbWVudFZpc2libGUoKSkgew0KICAgICAgICAgICAgdGhpcy5fY2FsY1NpemUoKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgQ2FsZW5kYXIucHJvdG90eXBlLl9jYWxjU2l6ZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIGNvbnRlbnRIZWlnaHRJbnB1dCA9IHRoaXMub3B0KCdjb250ZW50SGVpZ2h0Jyk7DQogICAgICAgIHZhciBoZWlnaHRJbnB1dCA9IHRoaXMub3B0KCdoZWlnaHQnKTsNCiAgICAgICAgaWYgKHR5cGVvZiBjb250ZW50SGVpZ2h0SW5wdXQgPT09ICdudW1iZXInKSB7DQogICAgICAgICAgICB0aGlzLnN1Z2dlc3RlZFZpZXdIZWlnaHQgPSBjb250ZW50SGVpZ2h0SW5wdXQ7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAodHlwZW9mIGNvbnRlbnRIZWlnaHRJbnB1dCA9PT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICAgICAgdGhpcy5zdWdnZXN0ZWRWaWV3SGVpZ2h0ID0gY29udGVudEhlaWdodElucHV0KCk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAodHlwZW9mIGhlaWdodElucHV0ID09PSAnbnVtYmVyJykgew0KICAgICAgICAgICAgdGhpcy5zdWdnZXN0ZWRWaWV3SGVpZ2h0ID0gaGVpZ2h0SW5wdXQgLSB0aGlzLnF1ZXJ5VG9vbGJhcnNIZWlnaHQoKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICh0eXBlb2YgaGVpZ2h0SW5wdXQgPT09ICdmdW5jdGlvbicpIHsNCiAgICAgICAgICAgIHRoaXMuc3VnZ2VzdGVkVmlld0hlaWdodCA9IGhlaWdodElucHV0KCkgLSB0aGlzLnF1ZXJ5VG9vbGJhcnNIZWlnaHQoKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmIChoZWlnaHRJbnB1dCA9PT0gJ3BhcmVudCcpIHsNCiAgICAgICAgICAgIHRoaXMuc3VnZ2VzdGVkVmlld0hlaWdodCA9IHRoaXMuZWwucGFyZW50KCkuaGVpZ2h0KCkgLSB0aGlzLnF1ZXJ5VG9vbGJhcnNIZWlnaHQoKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHRoaXMuc3VnZ2VzdGVkVmlld0hlaWdodCA9IE1hdGgucm91bmQodGhpcy5jb250ZW50RWwud2lkdGgoKSAvDQogICAgICAgICAgICAgICAgTWF0aC5tYXgodGhpcy5vcHQoJ2FzcGVjdFJhdGlvJyksIC41KSk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS53aW5kb3dSZXNpemUgPSBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgaWYgKA0KICAgICAgICAvLyB0aGUgcHVycG9zZTogc28gd2UgZG9uJ3QgcHJvY2VzcyBqcXVpICJyZXNpemUiIGV2ZW50cyB0aGF0IGhhdmUgYnViYmxlZCB1cA0KICAgICAgICAvLyBjYXN0IHRvIGFueSBiZWNhdXNlIC50YXJnZXQsIHdoaWNoIGlzIEVsZW1lbnQsIGNhbid0IGJlIGNvbXBhcmVkIHRvIHdpbmRvdyBmb3Igc29tZSByZWFzb24uDQogICAgICAgIGV2LnRhcmdldCA9PT0gd2luZG93ICYmDQogICAgICAgICAgICB0aGlzLnZpZXcgJiYNCiAgICAgICAgICAgIHRoaXMudmlldy5pc0RhdGVzUmVuZGVyZWQpIHsNCiAgICAgICAgICAgIGlmICh0aGlzLnVwZGF0ZVZpZXdTaXplKHRydWUpKSB7DQogICAgICAgICAgICAgICAgdGhpcy5wdWJsaWNseVRyaWdnZXIoJ3dpbmRvd1Jlc2l6ZScsIFt0aGlzLnZpZXddKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH07DQogICAgLyogSGVpZ2h0ICJGcmVlemluZyINCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgQ2FsZW5kYXIucHJvdG90eXBlLmZyZWV6ZUNvbnRlbnRIZWlnaHQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICghKHRoaXMuZnJlZXplQ29udGVudEhlaWdodERlcHRoKyspKSB7DQogICAgICAgICAgICB0aGlzLmZvcmNlRnJlZXplQ29udGVudEhlaWdodCgpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBDYWxlbmRhci5wcm90b3R5cGUuZm9yY2VGcmVlemVDb250ZW50SGVpZ2h0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLmNvbnRlbnRFbC5jc3Moew0KICAgICAgICAgICAgd2lkdGg6ICcxMDAlJywNCiAgICAgICAgICAgIGhlaWdodDogdGhpcy5jb250ZW50RWwuaGVpZ2h0KCksDQogICAgICAgICAgICBvdmVyZmxvdzogJ2hpZGRlbicNCiAgICAgICAgfSk7DQogICAgfTsNCiAgICBDYWxlbmRhci5wcm90b3R5cGUudGhhd0NvbnRlbnRIZWlnaHQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMuZnJlZXplQ29udGVudEhlaWdodERlcHRoLS07DQogICAgICAgIC8vIGFsd2F5cyBicmluZyBiYWNrIHRvIG5hdHVyYWwgaGVpZ2h0DQogICAgICAgIHRoaXMuY29udGVudEVsLmNzcyh7DQogICAgICAgICAgICB3aWR0aDogJycsDQogICAgICAgICAgICBoZWlnaHQ6ICcnLA0KICAgICAgICAgICAgb3ZlcmZsb3c6ICcnDQogICAgICAgIH0pOw0KICAgICAgICAvLyBidXQgaWYgdGhlcmUgYXJlIGZ1dHVyZSB0aGF3cywgcmUtZnJlZXplDQogICAgICAgIGlmICh0aGlzLmZyZWV6ZUNvbnRlbnRIZWlnaHREZXB0aCkgew0KICAgICAgICAgICAgdGhpcy5mb3JjZUZyZWV6ZUNvbnRlbnRIZWlnaHQoKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gVG9vbGJhcg0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgQ2FsZW5kYXIucHJvdG90eXBlLmluaXRUb29sYmFycyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5oZWFkZXIgPSBuZXcgVG9vbGJhcl8xLmRlZmF1bHQodGhpcywgdGhpcy5jb21wdXRlSGVhZGVyT3B0aW9ucygpKTsNCiAgICAgICAgdGhpcy5mb290ZXIgPSBuZXcgVG9vbGJhcl8xLmRlZmF1bHQodGhpcywgdGhpcy5jb21wdXRlRm9vdGVyT3B0aW9ucygpKTsNCiAgICAgICAgdGhpcy50b29sYmFyc01hbmFnZXIgPSBuZXcgSXRlcmF0b3JfMS5kZWZhdWx0KFt0aGlzLmhlYWRlciwgdGhpcy5mb290ZXJdKTsNCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5jb21wdXRlSGVhZGVyT3B0aW9ucyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgIGV4dHJhQ2xhc3NlczogJ2ZjLWhlYWRlci10b29sYmFyJywNCiAgICAgICAgICAgIGxheW91dDogdGhpcy5vcHQoJ2hlYWRlcicpDQogICAgICAgIH07DQogICAgfTsNCiAgICBDYWxlbmRhci5wcm90b3R5cGUuY29tcHV0ZUZvb3Rlck9wdGlvbnMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHJldHVybiB7DQogICAgICAgICAgICBleHRyYUNsYXNzZXM6ICdmYy1mb290ZXItdG9vbGJhcicsDQogICAgICAgICAgICBsYXlvdXQ6IHRoaXMub3B0KCdmb290ZXInKQ0KICAgICAgICB9Ow0KICAgIH07DQogICAgLy8gY2FuIGJlIGNhbGxlZCByZXBlYXRlZGx5IGFuZCBIZWFkZXIgd2lsbCByZXJlbmRlcg0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5yZW5kZXJIZWFkZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBoZWFkZXIgPSB0aGlzLmhlYWRlcjsNCiAgICAgICAgaGVhZGVyLnNldFRvb2xiYXJPcHRpb25zKHRoaXMuY29tcHV0ZUhlYWRlck9wdGlvbnMoKSk7DQogICAgICAgIGhlYWRlci5yZW5kZXIoKTsNCiAgICAgICAgaWYgKGhlYWRlci5lbCkgew0KICAgICAgICAgICAgdGhpcy5lbC5wcmVwZW5kKGhlYWRlci5lbCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIGNhbiBiZSBjYWxsZWQgcmVwZWF0ZWRseSBhbmQgRm9vdGVyIHdpbGwgcmVyZW5kZXINCiAgICBDYWxlbmRhci5wcm90b3R5cGUucmVuZGVyRm9vdGVyID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgZm9vdGVyID0gdGhpcy5mb290ZXI7DQogICAgICAgIGZvb3Rlci5zZXRUb29sYmFyT3B0aW9ucyh0aGlzLmNvbXB1dGVGb290ZXJPcHRpb25zKCkpOw0KICAgICAgICBmb290ZXIucmVuZGVyKCk7DQogICAgICAgIGlmIChmb290ZXIuZWwpIHsNCiAgICAgICAgICAgIHRoaXMuZWwuYXBwZW5kKGZvb3Rlci5lbCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5zZXRUb29sYmFyc1RpdGxlID0gZnVuY3Rpb24gKHRpdGxlKSB7DQogICAgICAgIHRoaXMudG9vbGJhcnNNYW5hZ2VyLnByb3h5Q2FsbCgndXBkYXRlVGl0bGUnLCB0aXRsZSk7DQogICAgfTsNCiAgICBDYWxlbmRhci5wcm90b3R5cGUudXBkYXRlVG9vbGJhckJ1dHRvbnMgPSBmdW5jdGlvbiAoZGF0ZVByb2ZpbGUpIHsNCiAgICAgICAgdmFyIG5vdyA9IHRoaXMuZ2V0Tm93KCk7DQogICAgICAgIHZhciB2aWV3ID0gdGhpcy52aWV3Ow0KICAgICAgICB2YXIgdG9kYXlJbmZvID0gdmlldy5kYXRlUHJvZmlsZUdlbmVyYXRvci5idWlsZChub3cpOw0KICAgICAgICB2YXIgcHJldkluZm8gPSB2aWV3LmRhdGVQcm9maWxlR2VuZXJhdG9yLmJ1aWxkUHJldih2aWV3LmdldCgnZGF0ZVByb2ZpbGUnKSk7DQogICAgICAgIHZhciBuZXh0SW5mbyA9IHZpZXcuZGF0ZVByb2ZpbGVHZW5lcmF0b3IuYnVpbGROZXh0KHZpZXcuZ2V0KCdkYXRlUHJvZmlsZScpKTsNCiAgICAgICAgdGhpcy50b29sYmFyc01hbmFnZXIucHJveHlDYWxsKCh0b2RheUluZm8uaXNWYWxpZCAmJiAhZGF0ZVByb2ZpbGUuY3VycmVudFVuem9uZWRSYW5nZS5jb250YWluc0RhdGUobm93KSkgPw0KICAgICAgICAgICAgJ2VuYWJsZUJ1dHRvbicgOg0KICAgICAgICAgICAgJ2Rpc2FibGVCdXR0b24nLCAndG9kYXknKTsNCiAgICAgICAgdGhpcy50b29sYmFyc01hbmFnZXIucHJveHlDYWxsKHByZXZJbmZvLmlzVmFsaWQgPw0KICAgICAgICAgICAgJ2VuYWJsZUJ1dHRvbicgOg0KICAgICAgICAgICAgJ2Rpc2FibGVCdXR0b24nLCAncHJldicpOw0KICAgICAgICB0aGlzLnRvb2xiYXJzTWFuYWdlci5wcm94eUNhbGwobmV4dEluZm8uaXNWYWxpZCA/DQogICAgICAgICAgICAnZW5hYmxlQnV0dG9uJyA6DQogICAgICAgICAgICAnZGlzYWJsZUJ1dHRvbicsICduZXh0Jyk7DQogICAgfTsNCiAgICBDYWxlbmRhci5wcm90b3R5cGUucXVlcnlUb29sYmFyc0hlaWdodCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMudG9vbGJhcnNNYW5hZ2VyLml0ZW1zLnJlZHVjZShmdW5jdGlvbiAoYWNjdW11bGF0b3IsIHRvb2xiYXIpIHsNCiAgICAgICAgICAgIHZhciB0b29sYmFySGVpZ2h0ID0gdG9vbGJhci5lbCA/IHRvb2xiYXIuZWwub3V0ZXJIZWlnaHQodHJ1ZSkgOiAwOyAvLyBpbmNsdWRlcyBtYXJnaW4NCiAgICAgICAgICAgIHJldHVybiBhY2N1bXVsYXRvciArIHRvb2xiYXJIZWlnaHQ7DQogICAgICAgIH0sIDApOw0KICAgIH07DQogICAgLy8gU2VsZWN0aW9uDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAvLyB0aGlzIHB1YmxpYyBtZXRob2QgcmVjZWl2ZXMgc3RhcnQvZW5kIGRhdGVzIGluIGFueSBmb3JtYXQsIHdpdGggYW55IHRpbWV6b25lDQogICAgQ2FsZW5kYXIucHJvdG90eXBlLnNlbGVjdCA9IGZ1bmN0aW9uICh6b25lZFN0YXJ0SW5wdXQsIHpvbmVkRW5kSW5wdXQpIHsNCiAgICAgICAgdGhpcy52aWV3LnNlbGVjdCh0aGlzLmJ1aWxkU2VsZWN0Rm9vdHByaW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOw0KICAgIH07DQogICAgQ2FsZW5kYXIucHJvdG90eXBlLnVuc2VsZWN0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy52aWV3KSB7DQogICAgICAgICAgICB0aGlzLnZpZXcudW5zZWxlY3QoKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gR2l2ZW4gYXJndW1lbnRzIHRvIHRoZSBzZWxlY3QgbWV0aG9kIGluIHRoZSBBUEksIHJldHVybnMgYSBzcGFuICh1bnpvbmVkIHN0YXJ0L2VuZCBhbmQgb3RoZXIgaW5mbykNCiAgICBDYWxlbmRhci5wcm90b3R5cGUuYnVpbGRTZWxlY3RGb290cHJpbnQgPSBmdW5jdGlvbiAoem9uZWRTdGFydElucHV0LCB6b25lZEVuZElucHV0KSB7DQogICAgICAgIHZhciBzdGFydCA9IHRoaXMubW9tZW50KHpvbmVkU3RhcnRJbnB1dCkuc3RyaXBab25lKCk7DQogICAgICAgIHZhciBlbmQ7DQogICAgICAgIGlmICh6b25lZEVuZElucHV0KSB7DQogICAgICAgICAgICBlbmQgPSB0aGlzLm1vbWVudCh6b25lZEVuZElucHV0KS5zdHJpcFpvbmUoKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmIChzdGFydC5oYXNUaW1lKCkpIHsNCiAgICAgICAgICAgIGVuZCA9IHN0YXJ0LmNsb25lKCkuYWRkKHRoaXMuZGVmYXVsdFRpbWVkRXZlbnREdXJhdGlvbik7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBlbmQgPSBzdGFydC5jbG9uZSgpLmFkZCh0aGlzLmRlZmF1bHRBbGxEYXlFdmVudER1cmF0aW9uKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gbmV3IENvbXBvbmVudEZvb3RwcmludF8xLmRlZmF1bHQobmV3IFVuem9uZWRSYW5nZV8xLmRlZmF1bHQoc3RhcnQsIGVuZCksICFzdGFydC5oYXNUaW1lKCkpOw0KICAgIH07DQogICAgLy8gRGF0ZSBVdGlscw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgQ2FsZW5kYXIucHJvdG90eXBlLmluaXRNb21lbnRJbnRlcm5hbHMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIHRoaXMuZGVmYXVsdEFsbERheUV2ZW50RHVyYXRpb24gPSBtb21lbnQuZHVyYXRpb24odGhpcy5vcHQoJ2RlZmF1bHRBbGxEYXlFdmVudER1cmF0aW9uJykpOw0KICAgICAgICB0aGlzLmRlZmF1bHRUaW1lZEV2ZW50RHVyYXRpb24gPSBtb21lbnQuZHVyYXRpb24odGhpcy5vcHQoJ2RlZmF1bHRUaW1lZEV2ZW50RHVyYXRpb24nKSk7DQogICAgICAgIC8vIENhbGxlZCBpbW1lZGlhdGVseSwgYW5kIHdoZW4gYW55IG9mIHRoZSBvcHRpb25zIGNoYW5nZS4NCiAgICAgICAgLy8gSGFwcGVucyBiZWZvcmUgYW55IGludGVybmFsIG9iamVjdHMgcmVidWlsZCBvciByZXJlbmRlciwgYmVjYXVzZSB0aGlzIGlzIHZlcnkgY29yZS4NCiAgICAgICAgdGhpcy5vcHRpb25zTWFuYWdlci53YXRjaCgnYnVpbGRpbmdNb21lbnRMb2NhbGUnLCBbDQogICAgICAgICAgICAnP2xvY2FsZScsICc/bW9udGhOYW1lcycsICc/bW9udGhOYW1lc1Nob3J0JywgJz9kYXlOYW1lcycsICc/ZGF5TmFtZXNTaG9ydCcsDQogICAgICAgICAgICAnP2ZpcnN0RGF5JywgJz93ZWVrTnVtYmVyQ2FsY3VsYXRpb24nDQogICAgICAgIF0sIGZ1bmN0aW9uIChvcHRzKSB7DQogICAgICAgICAgICB2YXIgd2Vla051bWJlckNhbGN1bGF0aW9uID0gb3B0cy53ZWVrTnVtYmVyQ2FsY3VsYXRpb247DQogICAgICAgICAgICB2YXIgZmlyc3REYXkgPSBvcHRzLmZpcnN0RGF5Ow0KICAgICAgICAgICAgdmFyIF93ZWVrOw0KICAgICAgICAgICAgLy8gbm9ybWFsaXplDQogICAgICAgICAgICBpZiAod2Vla051bWJlckNhbGN1bGF0aW9uID09PSAnaXNvJykgew0KICAgICAgICAgICAgICAgIHdlZWtOdW1iZXJDYWxjdWxhdGlvbiA9ICdJU08nOyAvLyBub3JtYWxpemUNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHZhciBsb2NhbGVEYXRhID0gT2JqZWN0LmNyZWF0ZSgvLyBtYWtlIGEgY2hlYXAgY29weQ0KICAgICAgICAgICAgbG9jYWxlXzEuZ2V0TW9tZW50TG9jYWxlRGF0YShvcHRzLmxvY2FsZSkgLy8gd2lsbCBmYWxsIGJhY2sgdG8gZW4NCiAgICAgICAgICAgICk7DQogICAgICAgICAgICBpZiAob3B0cy5tb250aE5hbWVzKSB7DQogICAgICAgICAgICAgICAgbG9jYWxlRGF0YS5fbW9udGhzID0gb3B0cy5tb250aE5hbWVzOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKG9wdHMubW9udGhOYW1lc1Nob3J0KSB7DQogICAgICAgICAgICAgICAgbG9jYWxlRGF0YS5fbW9udGhzU2hvcnQgPSBvcHRzLm1vbnRoTmFtZXNTaG9ydDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChvcHRzLmRheU5hbWVzKSB7DQogICAgICAgICAgICAgICAgbG9jYWxlRGF0YS5fd2Vla2RheXMgPSBvcHRzLmRheU5hbWVzOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKG9wdHMuZGF5TmFtZXNTaG9ydCkgew0KICAgICAgICAgICAgICAgIGxvY2FsZURhdGEuX3dlZWtkYXlzU2hvcnQgPSBvcHRzLmRheU5hbWVzU2hvcnQ7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoZmlyc3REYXkgPT0gbnVsbCAmJiB3ZWVrTnVtYmVyQ2FsY3VsYXRpb24gPT09ICdJU08nKSB7DQogICAgICAgICAgICAgICAgZmlyc3REYXkgPSAxOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKGZpcnN0RGF5ICE9IG51bGwpIHsNCiAgICAgICAgICAgICAgICBfd2VlayA9IE9iamVjdC5jcmVhdGUobG9jYWxlRGF0YS5fd2Vlayk7IC8vIF93ZWVrOiB7IGRvdzogIyB9DQogICAgICAgICAgICAgICAgX3dlZWsuZG93ID0gZmlyc3REYXk7DQogICAgICAgICAgICAgICAgbG9jYWxlRGF0YS5fd2VlayA9IF93ZWVrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKHdlZWtOdW1iZXJDYWxjdWxhdGlvbiA9PT0gJ0lTTycgfHwNCiAgICAgICAgICAgICAgICB3ZWVrTnVtYmVyQ2FsY3VsYXRpb24gPT09ICdsb2NhbCcgfHwNCiAgICAgICAgICAgICAgICB0eXBlb2Ygd2Vla051bWJlckNhbGN1bGF0aW9uID09PSAnZnVuY3Rpb24nKSB7DQogICAgICAgICAgICAgICAgbG9jYWxlRGF0YS5fZnVsbENhbGVuZGFyX3dlZWtDYWxjID0gd2Vla051bWJlckNhbGN1bGF0aW9uOyAvLyBtb21lbnQtZXh0IHdpbGwga25vdyB3aGF0IHRvIGRvIHdpdGggaXQNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIF90aGlzLmxvY2FsZURhdGEgPSBsb2NhbGVEYXRhOw0KICAgICAgICAgICAgLy8gSWYgdGhlIGludGVybmFsIGN1cnJlbnQgZGF0ZSBvYmplY3QgYWxyZWFkeSBleGlzdHMsIG1vdmUgdG8gbmV3IGxvY2FsZS4NCiAgICAgICAgICAgIC8vIFdlIGRvIE5PVCBuZWVkIHRvIGRvIHRoaXMgdGVjaG5pcXVlIGZvciBldmVudCBkYXRlcywgYmVjYXVzZSB0aGlzIGhhcHBlbnMgd2hlbiBjb252ZXJ0aW5nIHRvICJzZWdtZW50cyIuDQogICAgICAgICAgICBpZiAoX3RoaXMuY3VycmVudERhdGUpIHsNCiAgICAgICAgICAgICAgICBfdGhpcy5sb2NhbGl6ZU1vbWVudChfdGhpcy5jdXJyZW50RGF0ZSk7IC8vIHNldHMgdG8gbG9jYWxlRGF0YQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIC8vIEJ1aWxkcyBhIG1vbWVudCB1c2luZyB0aGUgc2V0dGluZ3Mgb2YgdGhlIGN1cnJlbnQgY2FsZW5kYXI6IHRpbWV6b25lIGFuZCBsb2NhbGUuDQogICAgLy8gQWNjZXB0cyBhbnl0aGluZyB0aGUgdmFuaWxsYSBtb21lbnQoKSBjb25zdHJ1Y3RvciBhY2NlcHRzLg0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5tb21lbnQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBhcmdzID0gW107DQogICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhcmd1bWVudHMubGVuZ3RoOyBfaSsrKSB7DQogICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaV07DQogICAgICAgIH0NCiAgICAgICAgdmFyIG1vbTsNCiAgICAgICAgaWYgKHRoaXMub3B0KCd0aW1lem9uZScpID09PSAnbG9jYWwnKSB7DQogICAgICAgICAgICBtb20gPSBtb21lbnRfZXh0XzEuZGVmYXVsdC5hcHBseShudWxsLCBhcmdzKTsNCiAgICAgICAgICAgIC8vIEZvcmNlIHRoZSBtb21lbnQgdG8gYmUgbG9jYWwsIGJlY2F1c2UgbW9tZW50RXh0IGRvZXNuJ3QgZ3VhcmFudGVlIGl0Lg0KICAgICAgICAgICAgaWYgKG1vbS5oYXNUaW1lKCkpIHsNCiAgICAgICAgICAgICAgICBtb20ubG9jYWwoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICh0aGlzLm9wdCgndGltZXpvbmUnKSA9PT0gJ1VUQycpIHsNCiAgICAgICAgICAgIG1vbSA9IG1vbWVudF9leHRfMS5kZWZhdWx0LnV0Yy5hcHBseShudWxsLCBhcmdzKTsgLy8gcHJvY2VzcyBhcyBVVEMNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIG1vbSA9IG1vbWVudF9leHRfMS5kZWZhdWx0LnBhcnNlWm9uZS5hcHBseShudWxsLCBhcmdzKTsgLy8gbGV0IHRoZSBpbnB1dCBkZWNpZGUgdGhlIHpvbmUNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmxvY2FsaXplTW9tZW50KG1vbSk7IC8vIFRPRE8NCiAgICAgICAgcmV0dXJuIG1vbTsNCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5tc1RvTW9tZW50ID0gZnVuY3Rpb24gKG1zLCBmb3JjZUFsbERheSkgew0KICAgICAgICB2YXIgbW9tID0gbW9tZW50X2V4dF8xLmRlZmF1bHQudXRjKG1zKTsgLy8gVE9ETzogb3B0aW1pemUgYnkgdXNpbmcgRGF0ZS5VVEMNCiAgICAgICAgaWYgKGZvcmNlQWxsRGF5KSB7DQogICAgICAgICAgICBtb20uc3RyaXBUaW1lKCk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBtb20gPSB0aGlzLmFwcGx5VGltZXpvbmUobW9tKTsgLy8gbWF5IG9yIG1heSBub3QgYXBwbHkgbG9jYWxlDQogICAgICAgIH0NCiAgICAgICAgdGhpcy5sb2NhbGl6ZU1vbWVudChtb20pOw0KICAgICAgICByZXR1cm4gbW9tOw0KICAgIH07DQogICAgQ2FsZW5kYXIucHJvdG90eXBlLm1zVG9VdGNNb21lbnQgPSBmdW5jdGlvbiAobXMsIGZvcmNlQWxsRGF5KSB7DQogICAgICAgIHZhciBtb20gPSBtb21lbnRfZXh0XzEuZGVmYXVsdC51dGMobXMpOyAvLyBUT0RPOiBvcHRpbWl6ZSBieSB1c2luZyBEYXRlLlVUQw0KICAgICAgICBpZiAoZm9yY2VBbGxEYXkpIHsNCiAgICAgICAgICAgIG1vbS5zdHJpcFRpbWUoKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmxvY2FsaXplTW9tZW50KG1vbSk7DQogICAgICAgIHJldHVybiBtb207DQogICAgfTsNCiAgICAvLyBVcGRhdGVzIHRoZSBnaXZlbiBtb21lbnQncyBsb2NhbGUgc2V0dGluZ3MgdG8gdGhlIGN1cnJlbnQgY2FsZW5kYXIgbG9jYWxlIHNldHRpbmdzLg0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5sb2NhbGl6ZU1vbWVudCA9IGZ1bmN0aW9uIChtb20pIHsNCiAgICAgICAgbW9tLl9sb2NhbGUgPSB0aGlzLmxvY2FsZURhdGE7DQogICAgfTsNCiAgICAvLyBSZXR1cm5zIGEgYm9vbGVhbiBhYm91dCB3aGV0aGVyIG9yIG5vdCB0aGUgY2FsZW5kYXIga25vd3MgaG93IHRvIGNhbGN1bGF0ZQ0KICAgIC8vIHRoZSB0aW1lem9uZSBvZmZzZXQgb2YgYXJiaXRyYXJ5IGRhdGVzIGluIHRoZSBjdXJyZW50IHRpbWV6b25lLg0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5nZXRJc0FtYmlnVGltZXpvbmUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHJldHVybiB0aGlzLm9wdCgndGltZXpvbmUnKSAhPT0gJ2xvY2FsJyAmJiB0aGlzLm9wdCgndGltZXpvbmUnKSAhPT0gJ1VUQyc7DQogICAgfTsNCiAgICAvLyBSZXR1cm5zIGEgY29weSBvZiB0aGUgZ2l2ZW4gZGF0ZSBpbiB0aGUgY3VycmVudCB0aW1lem9uZS4gSGFzIG5vIGVmZmVjdCBvbiBkYXRlcyB3aXRob3V0IHRpbWVzLg0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5hcHBseVRpbWV6b25lID0gZnVuY3Rpb24gKGRhdGUpIHsNCiAgICAgICAgaWYgKCFkYXRlLmhhc1RpbWUoKSkgew0KICAgICAgICAgICAgcmV0dXJuIGRhdGUuY2xvbmUoKTsNCiAgICAgICAgfQ0KICAgICAgICB2YXIgem9uZWREYXRlID0gdGhpcy5tb21lbnQoZGF0ZS50b0FycmF5KCkpOw0KICAgICAgICB2YXIgdGltZUFkanVzdCA9IGRhdGUudGltZSgpLmFzTWlsbGlzZWNvbmRzKCkgLSB6b25lZERhdGUudGltZSgpLmFzTWlsbGlzZWNvbmRzKCk7DQogICAgICAgIHZhciBhZGp1c3RlZFpvbmVkRGF0ZTsNCiAgICAgICAgLy8gU2FmYXJpIHNvbWV0aW1lcyBoYXMgcHJvYmxlbXMgd2l0aCB0aGlzIGNvZXJzaW9uIHdoZW4gbmVhciBEU1QuIEFkanVzdCBpZiBuZWNlc3NhcnkuIChidWcgIzIzOTYpDQogICAgICAgIGlmICh0aW1lQWRqdXN0KSB7DQogICAgICAgICAgICBhZGp1c3RlZFpvbmVkRGF0ZSA9IHpvbmVkRGF0ZS5jbG9uZSgpLmFkZCh0aW1lQWRqdXN0KTsgLy8gYWRkIG1pbGxpc2Vjb25kcw0KICAgICAgICAgICAgaWYgKGRhdGUudGltZSgpLmFzTWlsbGlzZWNvbmRzKCkgLSBhZGp1c3RlZFpvbmVkRGF0ZS50aW1lKCkuYXNNaWxsaXNlY29uZHMoKSA9PT0gMCkgew0KICAgICAgICAgICAgICAgIHpvbmVkRGF0ZSA9IGFkanVzdGVkWm9uZWREYXRlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiB6b25lZERhdGU7DQogICAgfTsNCiAgICAvKg0KICAgIEFzc3VtZXMgdGhlIGZvb3RwcmludCBpcyBub24tb3Blbi1lbmRlZC4NCiAgICAqLw0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5mb290cHJpbnRUb0RhdGVQcm9maWxlID0gZnVuY3Rpb24gKGNvbXBvbmVudEZvb3RwcmludCwgaWdub3JlRW5kKSB7DQogICAgICAgIGlmIChpZ25vcmVFbmQgPT09IHZvaWQgMCkgeyBpZ25vcmVFbmQgPSBmYWxzZTsgfQ0KICAgICAgICB2YXIgc3RhcnQgPSBtb21lbnRfZXh0XzEuZGVmYXVsdC51dGMoY29tcG9uZW50Rm9vdHByaW50LnVuem9uZWRSYW5nZS5zdGFydE1zKTsNCiAgICAgICAgdmFyIGVuZDsNCiAgICAgICAgaWYgKCFpZ25vcmVFbmQpIHsNCiAgICAgICAgICAgIGVuZCA9IG1vbWVudF9leHRfMS5kZWZhdWx0LnV0Yyhjb21wb25lbnRGb290cHJpbnQudW56b25lZFJhbmdlLmVuZE1zKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoY29tcG9uZW50Rm9vdHByaW50LmlzQWxsRGF5KSB7DQogICAgICAgICAgICBzdGFydC5zdHJpcFRpbWUoKTsNCiAgICAgICAgICAgIGlmIChlbmQpIHsNCiAgICAgICAgICAgICAgICBlbmQuc3RyaXBUaW1lKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBzdGFydCA9IHRoaXMuYXBwbHlUaW1lem9uZShzdGFydCk7DQogICAgICAgICAgICBpZiAoZW5kKSB7DQogICAgICAgICAgICAgICAgZW5kID0gdGhpcy5hcHBseVRpbWV6b25lKGVuZCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIG5ldyBFdmVudERhdGVQcm9maWxlXzEuZGVmYXVsdChzdGFydCwgZW5kLCB0aGlzKTsNCiAgICB9Ow0KICAgIC8vIFJldHVybnMgYSBtb21lbnQgZm9yIHRoZSBjdXJyZW50IGRhdGUsIGFzIGRlZmluZWQgYnkgdGhlIGNsaWVudCdzIGNvbXB1dGVyIG9yIGZyb20gdGhlIGBub3dgIG9wdGlvbi4NCiAgICAvLyBXaWxsIHJldHVybiBhbiBtb21lbnQgd2l0aCBhbiBhbWJpZ3VvdXMgdGltZXpvbmUuDQogICAgQ2FsZW5kYXIucHJvdG90eXBlLmdldE5vdyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIG5vdyA9IHRoaXMub3B0KCdub3cnKTsNCiAgICAgICAgaWYgKHR5cGVvZiBub3cgPT09ICdmdW5jdGlvbicpIHsNCiAgICAgICAgICAgIG5vdyA9IG5vdygpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzLm1vbWVudChub3cpLnN0cmlwWm9uZSgpOw0KICAgIH07DQogICAgLy8gUHJvZHVjZXMgYSBodW1hbi1yZWFkYWJsZSBzdHJpbmcgZm9yIHRoZSBnaXZlbiBkdXJhdGlvbi4NCiAgICAvLyBTaWRlLWVmZmVjdDogY2hhbmdlcyB0aGUgbG9jYWxlIG9mIHRoZSBnaXZlbiBkdXJhdGlvbi4NCiAgICBDYWxlbmRhci5wcm90b3R5cGUuaHVtYW5pemVEdXJhdGlvbiA9IGZ1bmN0aW9uIChkdXJhdGlvbikgew0KICAgICAgICByZXR1cm4gZHVyYXRpb24ubG9jYWxlKHRoaXMub3B0KCdsb2NhbGUnKSkuaHVtYW5pemUoKTsNCiAgICB9Ow0KICAgIC8vIHdpbGwgcmV0dXJuIGBudWxsYCBpZiBpbnZhbGlkIHJhbmdlDQogICAgQ2FsZW5kYXIucHJvdG90eXBlLnBhcnNlVW56b25lZFJhbmdlID0gZnVuY3Rpb24gKHJhbmdlSW5wdXQpIHsNCiAgICAgICAgdmFyIHN0YXJ0ID0gbnVsbDsNCiAgICAgICAgdmFyIGVuZCA9IG51bGw7DQogICAgICAgIGlmIChyYW5nZUlucHV0LnN0YXJ0KSB7DQogICAgICAgICAgICBzdGFydCA9IHRoaXMubW9tZW50KHJhbmdlSW5wdXQuc3RhcnQpLnN0cmlwWm9uZSgpOw0KICAgICAgICB9DQogICAgICAgIGlmIChyYW5nZUlucHV0LmVuZCkgew0KICAgICAgICAgICAgZW5kID0gdGhpcy5tb21lbnQocmFuZ2VJbnB1dC5lbmQpLnN0cmlwWm9uZSgpOw0KICAgICAgICB9DQogICAgICAgIGlmICghc3RhcnQgJiYgIWVuZCkgew0KICAgICAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHN0YXJ0ICYmIGVuZCAmJiBlbmQuaXNCZWZvcmUoc3RhcnQpKSB7DQogICAgICAgICAgICByZXR1cm4gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gbmV3IFVuem9uZWRSYW5nZV8xLmRlZmF1bHQoc3RhcnQsIGVuZCk7DQogICAgfTsNCiAgICAvLyBFdmVudC1EYXRlIFV0aWxpdGllcw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgQ2FsZW5kYXIucHJvdG90eXBlLmluaXRFdmVudE1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIHZhciBldmVudE1hbmFnZXIgPSBuZXcgRXZlbnRNYW5hZ2VyXzEuZGVmYXVsdCh0aGlzKTsNCiAgICAgICAgdmFyIHJhd1NvdXJjZXMgPSB0aGlzLm9wdCgnZXZlbnRTb3VyY2VzJykgfHwgW107DQogICAgICAgIHZhciBzaW5nbGVSYXdTb3VyY2UgPSB0aGlzLm9wdCgnZXZlbnRzJyk7DQogICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyID0gZXZlbnRNYW5hZ2VyOw0KICAgICAgICBpZiAoc2luZ2xlUmF3U291cmNlKSB7DQogICAgICAgICAgICByYXdTb3VyY2VzLnVuc2hpZnQoc2luZ2xlUmF3U291cmNlKTsNCiAgICAgICAgfQ0KICAgICAgICBldmVudE1hbmFnZXIub24oJ3JlbGVhc2UnLCBmdW5jdGlvbiAoZXZlbnRzUGF5bG9hZCkgew0KICAgICAgICAgICAgX3RoaXMudHJpZ2dlcignZXZlbnRzUmVzZXQnLCBldmVudHNQYXlsb2FkKTsNCiAgICAgICAgfSk7DQogICAgICAgIGV2ZW50TWFuYWdlci5mcmVlemUoKTsNCiAgICAgICAgcmF3U291cmNlcy5mb3JFYWNoKGZ1bmN0aW9uIChyYXdTb3VyY2UpIHsNCiAgICAgICAgICAgIHZhciBzb3VyY2UgPSBFdmVudFNvdXJjZVBhcnNlcl8xLmRlZmF1bHQucGFyc2UocmF3U291cmNlLCBfdGhpcyk7DQogICAgICAgICAgICBpZiAoc291cmNlKSB7DQogICAgICAgICAgICAgICAgZXZlbnRNYW5hZ2VyLmFkZFNvdXJjZShzb3VyY2UpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgZXZlbnRNYW5hZ2VyLnRoYXcoKTsNCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5yZXF1ZXN0RXZlbnRzID0gZnVuY3Rpb24gKHN0YXJ0LCBlbmQpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRNYW5hZ2VyLnJlcXVlc3RFdmVudHMoc3RhcnQsIGVuZCwgdGhpcy5vcHQoJ3RpbWV6b25lJyksICF0aGlzLm9wdCgnbGF6eUZldGNoaW5nJykpOw0KICAgIH07DQogICAgLy8gR2V0IGFuIGV2ZW50J3Mgbm9ybWFsaXplZCBlbmQgZGF0ZS4gSWYgbm90IHByZXNlbnQsIGNhbGN1bGF0ZSBpdCBmcm9tIHRoZSBkZWZhdWx0cy4NCiAgICBDYWxlbmRhci5wcm90b3R5cGUuZ2V0RXZlbnRFbmQgPSBmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgaWYgKGV2ZW50LmVuZCkgew0KICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmVuZC5jbG9uZSgpOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGVmYXVsdEV2ZW50RW5kKGV2ZW50LmFsbERheSwgZXZlbnQuc3RhcnQpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBHaXZlbiBhbiBldmVudCdzIGFsbERheSBzdGF0dXMgYW5kIHN0YXJ0IGRhdGUsIHJldHVybiB3aGF0IGl0cyBmYWxsYmFjayBlbmQgZGF0ZSBzaG91bGQgYmUuDQogICAgLy8gVE9ETzogcmVuYW1lIHRvIGNvbXB1dGVEZWZhdWx0RXZlbnRFbmQNCiAgICBDYWxlbmRhci5wcm90b3R5cGUuZ2V0RGVmYXVsdEV2ZW50RW5kID0gZnVuY3Rpb24gKGFsbERheSwgem9uZWRTdGFydCkgew0KICAgICAgICB2YXIgZW5kID0gem9uZWRTdGFydC5jbG9uZSgpOw0KICAgICAgICBpZiAoYWxsRGF5KSB7DQogICAgICAgICAgICBlbmQuc3RyaXBUaW1lKCkuYWRkKHRoaXMuZGVmYXVsdEFsbERheUV2ZW50RHVyYXRpb24pOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgZW5kLmFkZCh0aGlzLmRlZmF1bHRUaW1lZEV2ZW50RHVyYXRpb24pOw0KICAgICAgICB9DQogICAgICAgIGlmICh0aGlzLmdldElzQW1iaWdUaW1lem9uZSgpKSB7DQogICAgICAgICAgICBlbmQuc3RyaXBab25lKCk7IC8vIHdlIGRvbid0IGtub3cgd2hhdCB0aGUgdHpvIHNob3VsZCBiZQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiBlbmQ7DQogICAgfTsNCiAgICAvLyBQdWJsaWMgRXZlbnRzIEFQSQ0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgQ2FsZW5kYXIucHJvdG90eXBlLnJlcmVuZGVyRXZlbnRzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLnZpZXcuZmxhc2goJ2Rpc3BsYXlpbmdFdmVudHMnKTsNCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5yZWZldGNoRXZlbnRzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLmV2ZW50TWFuYWdlci5yZWZldGNoQWxsU291cmNlcygpOw0KICAgIH07DQogICAgQ2FsZW5kYXIucHJvdG90eXBlLnJlbmRlckV2ZW50cyA9IGZ1bmN0aW9uIChldmVudElucHV0cywgaXNTdGlja3kpIHsNCiAgICAgICAgdGhpcy5ldmVudE1hbmFnZXIuZnJlZXplKCk7DQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRJbnB1dHMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIHRoaXMucmVuZGVyRXZlbnQoZXZlbnRJbnB1dHNbaV0sIGlzU3RpY2t5KTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmV2ZW50TWFuYWdlci50aGF3KCk7DQogICAgfTsNCiAgICBDYWxlbmRhci5wcm90b3R5cGUucmVuZGVyRXZlbnQgPSBmdW5jdGlvbiAoZXZlbnRJbnB1dCwgaXNTdGlja3kpIHsNCiAgICAgICAgaWYgKGlzU3RpY2t5ID09PSB2b2lkIDApIHsgaXNTdGlja3kgPSBmYWxzZTsgfQ0KICAgICAgICB2YXIgZXZlbnRNYW5hZ2VyID0gdGhpcy5ldmVudE1hbmFnZXI7DQogICAgICAgIHZhciBldmVudERlZiA9IEV2ZW50RGVmUGFyc2VyXzEuZGVmYXVsdC5wYXJzZShldmVudElucHV0LCBldmVudElucHV0LnNvdXJjZSB8fCBldmVudE1hbmFnZXIuc3RpY2t5U291cmNlKTsNCiAgICAgICAgaWYgKGV2ZW50RGVmKSB7DQogICAgICAgICAgICBldmVudE1hbmFnZXIuYWRkRXZlbnREZWYoZXZlbnREZWYsIGlzU3RpY2t5KTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gbGVnYWN5UXVlcnkgb3BlcmF0ZXMgb24gbGVnYWN5IGV2ZW50IGluc3RhbmNlIG9iamVjdHMNCiAgICBDYWxlbmRhci5wcm90b3R5cGUucmVtb3ZlRXZlbnRzID0gZnVuY3Rpb24gKGxlZ2FjeVF1ZXJ5KSB7DQogICAgICAgIHZhciBldmVudE1hbmFnZXIgPSB0aGlzLmV2ZW50TWFuYWdlcjsNCiAgICAgICAgdmFyIGxlZ2FjeUluc3RhbmNlcyA9IFtdOw0KICAgICAgICB2YXIgaWRNYXAgPSB7fTsNCiAgICAgICAgdmFyIGV2ZW50RGVmOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgaWYgKGxlZ2FjeVF1ZXJ5ID09IG51bGwpIHsNCiAgICAgICAgICAgIGV2ZW50TWFuYWdlci5yZW1vdmVBbGxFdmVudERlZnMoKTsgLy8gcGVyc2lzdD10cnVlDQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBldmVudE1hbmFnZXIuZ2V0RXZlbnRJbnN0YW5jZXMoKS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudEluc3RhbmNlKSB7DQogICAgICAgICAgICAgICAgbGVnYWN5SW5zdGFuY2VzLnB1c2goZXZlbnRJbnN0YW5jZS50b0xlZ2FjeSgpKTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgbGVnYWN5SW5zdGFuY2VzID0gZmlsdGVyTGVnYWN5RXZlbnRJbnN0YW5jZXMobGVnYWN5SW5zdGFuY2VzLCBsZWdhY3lRdWVyeSk7DQogICAgICAgICAgICAvLyBjb21wdXRlIHVuaXF1ZSBJRHMNCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZWdhY3lJbnN0YW5jZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICBldmVudERlZiA9IHRoaXMuZXZlbnRNYW5hZ2VyLmdldEV2ZW50RGVmQnlVaWQobGVnYWN5SW5zdGFuY2VzW2ldLl9pZCk7DQogICAgICAgICAgICAgICAgaWRNYXBbZXZlbnREZWYuaWRdID0gdHJ1ZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGV2ZW50TWFuYWdlci5mcmVlemUoKTsNCiAgICAgICAgICAgIGZvciAoaSBpbiBpZE1hcCkgew0KICAgICAgICAgICAgICAgIGV2ZW50TWFuYWdlci5yZW1vdmVFdmVudERlZnNCeUlkKGkpOyAvLyBwZXJzaXN0PXRydWUNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGV2ZW50TWFuYWdlci50aGF3KCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIGxlZ2FjeVF1ZXJ5IG9wZXJhdGVzIG9uIGxlZ2FjeSBldmVudCBpbnN0YW5jZSBvYmplY3RzDQogICAgQ2FsZW5kYXIucHJvdG90eXBlLmNsaWVudEV2ZW50cyA9IGZ1bmN0aW9uIChsZWdhY3lRdWVyeSkgew0KICAgICAgICB2YXIgbGVnYWN5RXZlbnRJbnN0YW5jZXMgPSBbXTsNCiAgICAgICAgdGhpcy5ldmVudE1hbmFnZXIuZ2V0RXZlbnRJbnN0YW5jZXMoKS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudEluc3RhbmNlKSB7DQogICAgICAgICAgICBsZWdhY3lFdmVudEluc3RhbmNlcy5wdXNoKGV2ZW50SW5zdGFuY2UudG9MZWdhY3koKSk7DQogICAgICAgIH0pOw0KICAgICAgICByZXR1cm4gZmlsdGVyTGVnYWN5RXZlbnRJbnN0YW5jZXMobGVnYWN5RXZlbnRJbnN0YW5jZXMsIGxlZ2FjeVF1ZXJ5KTsNCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS51cGRhdGVFdmVudHMgPSBmdW5jdGlvbiAoZXZlbnRQcm9wc0FycmF5KSB7DQogICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyLmZyZWV6ZSgpOw0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50UHJvcHNBcnJheS5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgdGhpcy51cGRhdGVFdmVudChldmVudFByb3BzQXJyYXlbaV0pOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyLnRoYXcoKTsNCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS51cGRhdGVFdmVudCA9IGZ1bmN0aW9uIChldmVudFByb3BzKSB7DQogICAgICAgIHZhciBldmVudERlZiA9IHRoaXMuZXZlbnRNYW5hZ2VyLmdldEV2ZW50RGVmQnlVaWQoZXZlbnRQcm9wcy5faWQpOw0KICAgICAgICB2YXIgZXZlbnRJbnN0YW5jZTsNCiAgICAgICAgdmFyIGV2ZW50RGVmTXV0YXRpb247DQogICAgICAgIGlmIChldmVudERlZiBpbnN0YW5jZW9mIFNpbmdsZUV2ZW50RGVmXzEuZGVmYXVsdCkgew0KICAgICAgICAgICAgZXZlbnRJbnN0YW5jZSA9IGV2ZW50RGVmLmJ1aWxkSW5zdGFuY2UoKTsNCiAgICAgICAgICAgIGV2ZW50RGVmTXV0YXRpb24gPSBFdmVudERlZk11dGF0aW9uXzEuZGVmYXVsdC5jcmVhdGVGcm9tUmF3UHJvcHMoZXZlbnRJbnN0YW5jZSwgZXZlbnRQcm9wcywgLy8gcmF3IHByb3BzDQogICAgICAgICAgICBudWxsIC8vIGxhcmdlVW5pdCAtLSB3aG8gdXNlcyBpdD8NCiAgICAgICAgICAgICk7DQogICAgICAgICAgICB0aGlzLmV2ZW50TWFuYWdlci5tdXRhdGVFdmVudHNXaXRoSWQoZXZlbnREZWYuaWQsIGV2ZW50RGVmTXV0YXRpb24pOyAvLyB3aWxsIHJlbGVhc2UNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gUHVibGljIEV2ZW50IFNvdXJjZXMgQVBJDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgQ2FsZW5kYXIucHJvdG90eXBlLmdldEV2ZW50U291cmNlcyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRNYW5hZ2VyLm90aGVyU291cmNlcy5zbGljZSgpOyAvLyBjbG9uZQ0KICAgIH07DQogICAgQ2FsZW5kYXIucHJvdG90eXBlLmdldEV2ZW50U291cmNlQnlJZCA9IGZ1bmN0aW9uIChpZCkgew0KICAgICAgICByZXR1cm4gdGhpcy5ldmVudE1hbmFnZXIuZ2V0U291cmNlQnlJZChFdmVudFNvdXJjZV8xLmRlZmF1bHQubm9ybWFsaXplSWQoaWQpKTsNCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5hZGRFdmVudFNvdXJjZSA9IGZ1bmN0aW9uIChzb3VyY2VJbnB1dCkgew0KICAgICAgICB2YXIgc291cmNlID0gRXZlbnRTb3VyY2VQYXJzZXJfMS5kZWZhdWx0LnBhcnNlKHNvdXJjZUlucHV0LCB0aGlzKTsNCiAgICAgICAgaWYgKHNvdXJjZSkgew0KICAgICAgICAgICAgdGhpcy5ldmVudE1hbmFnZXIuYWRkU291cmNlKHNvdXJjZSk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5yZW1vdmVFdmVudFNvdXJjZXMgPSBmdW5jdGlvbiAoc291cmNlTXVsdGlRdWVyeSkgew0KICAgICAgICB2YXIgZXZlbnRNYW5hZ2VyID0gdGhpcy5ldmVudE1hbmFnZXI7DQogICAgICAgIHZhciBzb3VyY2VzOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgaWYgKHNvdXJjZU11bHRpUXVlcnkgPT0gbnVsbCkgew0KICAgICAgICAgICAgdGhpcy5ldmVudE1hbmFnZXIucmVtb3ZlQWxsU291cmNlcygpOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgc291cmNlcyA9IGV2ZW50TWFuYWdlci5tdWx0aVF1ZXJ5U291cmNlcyhzb3VyY2VNdWx0aVF1ZXJ5KTsNCiAgICAgICAgICAgIGV2ZW50TWFuYWdlci5mcmVlemUoKTsNCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzb3VyY2VzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgICAgZXZlbnRNYW5hZ2VyLnJlbW92ZVNvdXJjZShzb3VyY2VzW2ldKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGV2ZW50TWFuYWdlci50aGF3KCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIENhbGVuZGFyLnByb3RvdHlwZS5yZW1vdmVFdmVudFNvdXJjZSA9IGZ1bmN0aW9uIChzb3VyY2VRdWVyeSkgew0KICAgICAgICB2YXIgZXZlbnRNYW5hZ2VyID0gdGhpcy5ldmVudE1hbmFnZXI7DQogICAgICAgIHZhciBzb3VyY2VzID0gZXZlbnRNYW5hZ2VyLnF1ZXJ5U291cmNlcyhzb3VyY2VRdWVyeSk7DQogICAgICAgIHZhciBpOw0KICAgICAgICBldmVudE1hbmFnZXIuZnJlZXplKCk7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzb3VyY2VzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBldmVudE1hbmFnZXIucmVtb3ZlU291cmNlKHNvdXJjZXNbaV0pOw0KICAgICAgICB9DQogICAgICAgIGV2ZW50TWFuYWdlci50aGF3KCk7DQogICAgfTsNCiAgICBDYWxlbmRhci5wcm90b3R5cGUucmVmZXRjaEV2ZW50U291cmNlcyA9IGZ1bmN0aW9uIChzb3VyY2VNdWx0aVF1ZXJ5KSB7DQogICAgICAgIHZhciBldmVudE1hbmFnZXIgPSB0aGlzLmV2ZW50TWFuYWdlcjsNCiAgICAgICAgdmFyIHNvdXJjZXMgPSBldmVudE1hbmFnZXIubXVsdGlRdWVyeVNvdXJjZXMoc291cmNlTXVsdGlRdWVyeSk7DQogICAgICAgIHZhciBpOw0KICAgICAgICBldmVudE1hbmFnZXIuZnJlZXplKCk7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzb3VyY2VzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBldmVudE1hbmFnZXIucmVmZXRjaFNvdXJjZShzb3VyY2VzW2ldKTsNCiAgICAgICAgfQ0KICAgICAgICBldmVudE1hbmFnZXIudGhhdygpOw0KICAgIH07DQogICAgLy8gbm90IGZvciBpbnRlcm5hbCB1c2UuIHVzZSBvcHRpb25zIG1vZHVsZSBkaXJlY3RseSBpbnN0ZWFkLg0KICAgIENhbGVuZGFyLmRlZmF1bHRzID0gb3B0aW9uc18xLmdsb2JhbERlZmF1bHRzOw0KICAgIENhbGVuZGFyLmVuZ2xpc2hEZWZhdWx0cyA9IG9wdGlvbnNfMS5lbmdsaXNoRGVmYXVsdHM7DQogICAgQ2FsZW5kYXIucnRsRGVmYXVsdHMgPSBvcHRpb25zXzEucnRsRGVmYXVsdHM7DQogICAgcmV0dXJuIENhbGVuZGFyOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IENhbGVuZGFyOw0KRW1pdHRlck1peGluXzEuZGVmYXVsdC5taXhJbnRvKENhbGVuZGFyKTsNCkxpc3RlbmVyTWl4aW5fMS5kZWZhdWx0Lm1peEludG8oQ2FsZW5kYXIpOw0KZnVuY3Rpb24gZmlsdGVyTGVnYWN5RXZlbnRJbnN0YW5jZXMobGVnYWN5RXZlbnRJbnN0YW5jZXMsIGxlZ2FjeVF1ZXJ5KSB7DQogICAgaWYgKGxlZ2FjeVF1ZXJ5ID09IG51bGwpIHsNCiAgICAgICAgcmV0dXJuIGxlZ2FjeUV2ZW50SW5zdGFuY2VzOw0KICAgIH0NCiAgICBlbHNlIGlmICgkLmlzRnVuY3Rpb24obGVnYWN5UXVlcnkpKSB7DQogICAgICAgIHJldHVybiBsZWdhY3lFdmVudEluc3RhbmNlcy5maWx0ZXIobGVnYWN5UXVlcnkpOw0KICAgIH0NCiAgICBlbHNlIHsNCiAgICAgICAgbGVnYWN5UXVlcnkgKz0gJyc7IC8vIG5vcm1hbGl6ZSB0byBzdHJpbmcNCiAgICAgICAgcmV0dXJuIGxlZ2FjeUV2ZW50SW5zdGFuY2VzLmZpbHRlcihmdW5jdGlvbiAobGVnYWN5RXZlbnRJbnN0YW5jZSkgew0KICAgICAgICAgICAgLy8gc29mdCBjb21wYXJpc29uIGJlY2F1c2UgaWQgbm90IGJlIG5vcm1hbGl6ZWQgdG8gc3RyaW5nDQogICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmUNCiAgICAgICAgICAgIHJldHVybiBsZWdhY3lFdmVudEluc3RhbmNlLmlkID09IGxlZ2FjeVF1ZXJ5IHx8DQogICAgICAgICAgICAgICAgbGVnYWN5RXZlbnRJbnN0YW5jZS5faWQgPT09IGxlZ2FjeVF1ZXJ5OyAvLyBjYW4gc3BlY2lmeSBpbnRlcm5hbCBpZCwgYnV0IG11c3QgZXhhY3RseSBtYXRjaA0KICAgICAgICB9KTsNCiAgICB9DQp9DQoKCi8qKiovIH0pLAovKiAyMjEgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciBtb21lbnQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDApOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgVW56b25lZFJhbmdlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUpOw0KdmFyIERhdGVQcm9maWxlR2VuZXJhdG9yID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgew0KICAgIGZ1bmN0aW9uIERhdGVQcm9maWxlR2VuZXJhdG9yKF92aWV3KSB7DQogICAgICAgIHRoaXMuX3ZpZXcgPSBfdmlldzsNCiAgICB9DQogICAgRGF0ZVByb2ZpbGVHZW5lcmF0b3IucHJvdG90eXBlLm9wdCA9IGZ1bmN0aW9uIChuYW1lKSB7DQogICAgICAgIHJldHVybiB0aGlzLl92aWV3Lm9wdChuYW1lKTsNCiAgICB9Ow0KICAgIERhdGVQcm9maWxlR2VuZXJhdG9yLnByb3RvdHlwZS50cmltSGlkZGVuRGF5cyA9IGZ1bmN0aW9uICh1bnpvbmVkUmFuZ2UpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuX3ZpZXcudHJpbUhpZGRlbkRheXModW56b25lZFJhbmdlKTsNCiAgICB9Ow0KICAgIERhdGVQcm9maWxlR2VuZXJhdG9yLnByb3RvdHlwZS5tc1RvVXRjTW9tZW50ID0gZnVuY3Rpb24gKG1zLCBmb3JjZUFsbERheSkgew0KICAgICAgICByZXR1cm4gdGhpcy5fdmlldy5jYWxlbmRhci5tc1RvVXRjTW9tZW50KG1zLCBmb3JjZUFsbERheSk7DQogICAgfTsNCiAgICAvKiBEYXRlIFJhbmdlIENvbXB1dGF0aW9uDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICAvLyBCdWlsZHMgYSBzdHJ1Y3R1cmUgd2l0aCBpbmZvIGFib3V0IHdoYXQgdGhlIGRhdGVzL3JhbmdlcyB3aWxsIGJlIGZvciB0aGUgInByZXYiIHZpZXcuDQogICAgRGF0ZVByb2ZpbGVHZW5lcmF0b3IucHJvdG90eXBlLmJ1aWxkUHJldiA9IGZ1bmN0aW9uIChjdXJyZW50RGF0ZVByb2ZpbGUpIHsNCiAgICAgICAgdmFyIHByZXZEYXRlID0gY3VycmVudERhdGVQcm9maWxlLmRhdGUuY2xvbmUoKQ0KICAgICAgICAgICAgLnN0YXJ0T2YoY3VycmVudERhdGVQcm9maWxlLmN1cnJlbnRSYW5nZVVuaXQpDQogICAgICAgICAgICAuc3VidHJhY3QoY3VycmVudERhdGVQcm9maWxlLmRhdGVJbmNyZW1lbnQpOw0KICAgICAgICByZXR1cm4gdGhpcy5idWlsZChwcmV2RGF0ZSwgLTEpOw0KICAgIH07DQogICAgLy8gQnVpbGRzIGEgc3RydWN0dXJlIHdpdGggaW5mbyBhYm91dCB3aGF0IHRoZSBkYXRlcy9yYW5nZXMgd2lsbCBiZSBmb3IgdGhlICJuZXh0IiB2aWV3Lg0KICAgIERhdGVQcm9maWxlR2VuZXJhdG9yLnByb3RvdHlwZS5idWlsZE5leHQgPSBmdW5jdGlvbiAoY3VycmVudERhdGVQcm9maWxlKSB7DQogICAgICAgIHZhciBuZXh0RGF0ZSA9IGN1cnJlbnREYXRlUHJvZmlsZS5kYXRlLmNsb25lKCkNCiAgICAgICAgICAgIC5zdGFydE9mKGN1cnJlbnREYXRlUHJvZmlsZS5jdXJyZW50UmFuZ2VVbml0KQ0KICAgICAgICAgICAgLmFkZChjdXJyZW50RGF0ZVByb2ZpbGUuZGF0ZUluY3JlbWVudCk7DQogICAgICAgIHJldHVybiB0aGlzLmJ1aWxkKG5leHREYXRlLCAxKTsNCiAgICB9Ow0KICAgIC8vIEJ1aWxkcyBhIHN0cnVjdHVyZSBob2xkaW5nIGRhdGVzL3JhbmdlcyBmb3IgcmVuZGVyaW5nIGFyb3VuZCB0aGUgZ2l2ZW4gZGF0ZS4NCiAgICAvLyBPcHRpb25hbCBkaXJlY3Rpb24gcGFyYW0gaW5kaWNhdGVzIHdoZXRoZXIgdGhlIGRhdGUgaXMgYmVpbmcgaW5jcmVtZW50ZWQvZGVjcmVtZW50ZWQNCiAgICAvLyBmcm9tIGl0cyBwcmV2aW91cyB2YWx1ZS4gZGVjcmVtZW50ZWQgPSAtMSwgaW5jcmVtZW50ZWQgPSAxIChkZWZhdWx0KS4NCiAgICBEYXRlUHJvZmlsZUdlbmVyYXRvci5wcm90b3R5cGUuYnVpbGQgPSBmdW5jdGlvbiAoZGF0ZSwgZGlyZWN0aW9uLCBmb3JjZVRvVmFsaWQpIHsNCiAgICAgICAgaWYgKGZvcmNlVG9WYWxpZCA9PT0gdm9pZCAwKSB7IGZvcmNlVG9WYWxpZCA9IGZhbHNlOyB9DQogICAgICAgIHZhciBpc0RhdGVBbGxEYXkgPSAhZGF0ZS5oYXNUaW1lKCk7DQogICAgICAgIHZhciB2YWxpZFVuem9uZWRSYW5nZTsNCiAgICAgICAgdmFyIG1pblRpbWUgPSBudWxsOw0KICAgICAgICB2YXIgbWF4VGltZSA9IG51bGw7DQogICAgICAgIHZhciBjdXJyZW50SW5mbzsNCiAgICAgICAgdmFyIGlzUmFuZ2VBbGxEYXk7DQogICAgICAgIHZhciByZW5kZXJVbnpvbmVkUmFuZ2U7DQogICAgICAgIHZhciBhY3RpdmVVbnpvbmVkUmFuZ2U7DQogICAgICAgIHZhciBpc1ZhbGlkOw0KICAgICAgICB2YWxpZFVuem9uZWRSYW5nZSA9IHRoaXMuYnVpbGRWYWxpZFJhbmdlKCk7DQogICAgICAgIHZhbGlkVW56b25lZFJhbmdlID0gdGhpcy50cmltSGlkZGVuRGF5cyh2YWxpZFVuem9uZWRSYW5nZSk7DQogICAgICAgIGlmIChmb3JjZVRvVmFsaWQpIHsNCiAgICAgICAgICAgIGRhdGUgPSB0aGlzLm1zVG9VdGNNb21lbnQodmFsaWRVbnpvbmVkUmFuZ2UuY29uc3RyYWluRGF0ZShkYXRlKSwgLy8gcmV0dXJucyBNUw0KICAgICAgICAgICAgaXNEYXRlQWxsRGF5KTsNCiAgICAgICAgfQ0KICAgICAgICBjdXJyZW50SW5mbyA9IHRoaXMuYnVpbGRDdXJyZW50UmFuZ2VJbmZvKGRhdGUsIGRpcmVjdGlvbik7DQogICAgICAgIGlzUmFuZ2VBbGxEYXkgPSAvXih5ZWFyfG1vbnRofHdlZWt8ZGF5KSQvLnRlc3QoY3VycmVudEluZm8udW5pdCk7DQogICAgICAgIHJlbmRlclVuem9uZWRSYW5nZSA9IHRoaXMuYnVpbGRSZW5kZXJSYW5nZSh0aGlzLnRyaW1IaWRkZW5EYXlzKGN1cnJlbnRJbmZvLnVuem9uZWRSYW5nZSksIGN1cnJlbnRJbmZvLnVuaXQsIGlzUmFuZ2VBbGxEYXkpOw0KICAgICAgICByZW5kZXJVbnpvbmVkUmFuZ2UgPSB0aGlzLnRyaW1IaWRkZW5EYXlzKHJlbmRlclVuem9uZWRSYW5nZSk7DQogICAgICAgIGFjdGl2ZVVuem9uZWRSYW5nZSA9IHJlbmRlclVuem9uZWRSYW5nZS5jbG9uZSgpOw0KICAgICAgICBpZiAoIXRoaXMub3B0KCdzaG93Tm9uQ3VycmVudERhdGVzJykpIHsNCiAgICAgICAgICAgIGFjdGl2ZVVuem9uZWRSYW5nZSA9IGFjdGl2ZVVuem9uZWRSYW5nZS5pbnRlcnNlY3QoY3VycmVudEluZm8udW56b25lZFJhbmdlKTsNCiAgICAgICAgfQ0KICAgICAgICBtaW5UaW1lID0gbW9tZW50LmR1cmF0aW9uKHRoaXMub3B0KCdtaW5UaW1lJykpOw0KICAgICAgICBtYXhUaW1lID0gbW9tZW50LmR1cmF0aW9uKHRoaXMub3B0KCdtYXhUaW1lJykpOw0KICAgICAgICBhY3RpdmVVbnpvbmVkUmFuZ2UgPSB0aGlzLmFkanVzdEFjdGl2ZVJhbmdlKGFjdGl2ZVVuem9uZWRSYW5nZSwgbWluVGltZSwgbWF4VGltZSk7DQogICAgICAgIGFjdGl2ZVVuem9uZWRSYW5nZSA9IGFjdGl2ZVVuem9uZWRSYW5nZS5pbnRlcnNlY3QodmFsaWRVbnpvbmVkUmFuZ2UpOyAvLyBtaWdodCByZXR1cm4gbnVsbA0KICAgICAgICBpZiAoYWN0aXZlVW56b25lZFJhbmdlKSB7DQogICAgICAgICAgICBkYXRlID0gdGhpcy5tc1RvVXRjTW9tZW50KGFjdGl2ZVVuem9uZWRSYW5nZS5jb25zdHJhaW5EYXRlKGRhdGUpLCAvLyByZXR1cm5zIE1TDQogICAgICAgICAgICBpc0RhdGVBbGxEYXkpOw0KICAgICAgICB9DQogICAgICAgIC8vIGl0J3MgaW52YWxpZCBpZiB0aGUgb3JpZ2luYWxseSByZXF1ZXN0ZWQgZGF0ZSBpcyBub3QgY29udGFpbmVkLA0KICAgICAgICAvLyBvciBpZiB0aGUgcmFuZ2UgaXMgY29tcGxldGVseSBvdXRzaWRlIG9mIHRoZSB2YWxpZCByYW5nZS4NCiAgICAgICAgaXNWYWxpZCA9IGN1cnJlbnRJbmZvLnVuem9uZWRSYW5nZS5pbnRlcnNlY3RzV2l0aCh2YWxpZFVuem9uZWRSYW5nZSk7DQogICAgICAgIHJldHVybiB7DQogICAgICAgICAgICAvLyBjb25zdHJhaW50IGZvciB3aGVyZSBwcmV2L25leHQgb3BlcmF0aW9ucyBjYW4gZ28gYW5kIHdoZXJlIGV2ZW50cyBjYW4gYmUgZHJhZ2dlZC9yZXNpemVkIHRvLg0KICAgICAgICAgICAgLy8gYW4gb2JqZWN0IHdpdGggb3B0aW9uYWwgc3RhcnQgYW5kIGVuZCBwcm9wZXJ0aWVzLg0KICAgICAgICAgICAgdmFsaWRVbnpvbmVkUmFuZ2U6IHZhbGlkVW56b25lZFJhbmdlLA0KICAgICAgICAgICAgLy8gcmFuZ2UgdGhlIHZpZXcgaXMgZm9ybWFsbHkgcmVzcG9uc2libGUgZm9yLg0KICAgICAgICAgICAgLy8gZm9yIGV4YW1wbGUsIGEgbW9udGggdmlldyBtaWdodCBoYXZlIDFzdC0zMXN0LCBleGNsdWRpbmcgcGFkZGVkIGRhdGVzDQogICAgICAgICAgICBjdXJyZW50VW56b25lZFJhbmdlOiBjdXJyZW50SW5mby51bnpvbmVkUmFuZ2UsDQogICAgICAgICAgICAvLyBuYW1lIG9mIGxhcmdlc3QgdW5pdCBiZWluZyBkaXNwbGF5ZWQsIGxpa2UgIm1vbnRoIiBvciAid2VlayINCiAgICAgICAgICAgIGN1cnJlbnRSYW5nZVVuaXQ6IGN1cnJlbnRJbmZvLnVuaXQsDQogICAgICAgICAgICBpc1JhbmdlQWxsRGF5OiBpc1JhbmdlQWxsRGF5LA0KICAgICAgICAgICAgLy8gZGF0ZXMgdGhhdCBkaXNwbGF5IGV2ZW50cyBhbmQgYWNjZXB0IGRyYWctbi1kcm9wDQogICAgICAgICAgICAvLyB3aWxsIGJlIGBudWxsYCBpZiBubyBkYXRlcyBhY2NlcHQgZXZlbnRzDQogICAgICAgICAgICBhY3RpdmVVbnpvbmVkUmFuZ2U6IGFjdGl2ZVVuem9uZWRSYW5nZSwNCiAgICAgICAgICAgIC8vIGRhdGUgcmFuZ2Ugd2l0aCBhIHJlbmRlcmVkIHNrZWxldG9uDQogICAgICAgICAgICAvLyBpbmNsdWRlcyBub3QtYWN0aXZlIGRheXMgdGhhdCBuZWVkIHNvbWUgc29ydCBvZiBET00NCiAgICAgICAgICAgIHJlbmRlclVuem9uZWRSYW5nZTogcmVuZGVyVW56b25lZFJhbmdlLA0KICAgICAgICAgICAgLy8gRHVyYXRpb24gb2JqZWN0IHRoYXQgZGVub3RlcyB0aGUgZmlyc3QgdmlzaWJsZSB0aW1lIG9mIGFueSBnaXZlbiBkYXkNCiAgICAgICAgICAgIG1pblRpbWU6IG1pblRpbWUsDQogICAgICAgICAgICAvLyBEdXJhdGlvbiBvYmplY3QgdGhhdCBkZW5vdGVzIHRoZSBleGNsdXNpdmUgdmlzaWJsZSBlbmQgdGltZSBvZiBhbnkgZ2l2ZW4gZGF5DQogICAgICAgICAgICBtYXhUaW1lOiBtYXhUaW1lLA0KICAgICAgICAgICAgaXNWYWxpZDogaXNWYWxpZCwNCiAgICAgICAgICAgIGRhdGU6IGRhdGUsDQogICAgICAgICAgICAvLyBob3cgZmFyIHRoZSBjdXJyZW50IGRhdGUgd2lsbCBtb3ZlIGZvciBhIHByZXYvbmV4dCBvcGVyYXRpb24NCiAgICAgICAgICAgIGRhdGVJbmNyZW1lbnQ6IHRoaXMuYnVpbGREYXRlSW5jcmVtZW50KGN1cnJlbnRJbmZvLmR1cmF0aW9uKQ0KICAgICAgICAgICAgLy8gcGFzcyBhIGZhbGxiYWNrIChtaWdodCBiZSBudWxsKSBeDQogICAgICAgIH07DQogICAgfTsNCiAgICAvLyBCdWlsZHMgYW4gb2JqZWN0IHdpdGggb3B0aW9uYWwgc3RhcnQvZW5kIHByb3BlcnRpZXMuDQogICAgLy8gSW5kaWNhdGVzIHRoZSBtaW5pbXVtL21heGltdW0gZGF0ZXMgdG8gZGlzcGxheS4NCiAgICAvLyBub3QgcmVzcG9uc2libGUgZm9yIHRyaW1taW5nIGhpZGRlbiBkYXlzLg0KICAgIERhdGVQcm9maWxlR2VuZXJhdG9yLnByb3RvdHlwZS5idWlsZFZhbGlkUmFuZ2UgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHJldHVybiB0aGlzLl92aWV3LmdldFVuem9uZWRSYW5nZU9wdGlvbigndmFsaWRSYW5nZScsIHRoaXMuX3ZpZXcuY2FsZW5kYXIuZ2V0Tm93KCkpIHx8DQogICAgICAgICAgICBuZXcgVW56b25lZFJhbmdlXzEuZGVmYXVsdCgpOyAvLyBjb21wbGV0ZWx5IG9wZW4tZW5kZWQNCiAgICB9Ow0KICAgIC8vIEJ1aWxkcyBhIHN0cnVjdHVyZSB3aXRoIGluZm8gYWJvdXQgdGhlICJjdXJyZW50IiByYW5nZSwgdGhlIHJhbmdlIHRoYXQgaXMNCiAgICAvLyBoaWdobGlnaHRlZCBhcyBiZWluZyB0aGUgY3VycmVudCBtb250aCBmb3IgZXhhbXBsZS4NCiAgICAvLyBTZWUgYnVpbGQoKSBmb3IgYSBkZXNjcmlwdGlvbiBvZiBgZGlyZWN0aW9uYC4NCiAgICAvLyBHdWFyYW50ZWVkIHRvIGhhdmUgYHJhbmdlYCBhbmQgYHVuaXRgIHByb3BlcnRpZXMuIGBkdXJhdGlvbmAgaXMgb3B0aW9uYWwuDQogICAgLy8gVE9ETzogYWNjZXB0IGEgTVMtdGltZSBpbnN0ZWFkIG9mIGEgbW9tZW50IGBkYXRlYD8NCiAgICBEYXRlUHJvZmlsZUdlbmVyYXRvci5wcm90b3R5cGUuYnVpbGRDdXJyZW50UmFuZ2VJbmZvID0gZnVuY3Rpb24gKGRhdGUsIGRpcmVjdGlvbikgew0KICAgICAgICB2YXIgdmlld1NwZWMgPSB0aGlzLl92aWV3LnZpZXdTcGVjOw0KICAgICAgICB2YXIgZHVyYXRpb24gPSBudWxsOw0KICAgICAgICB2YXIgdW5pdCA9IG51bGw7DQogICAgICAgIHZhciB1bnpvbmVkUmFuZ2UgPSBudWxsOw0KICAgICAgICB2YXIgZGF5Q291bnQ7DQogICAgICAgIGlmICh2aWV3U3BlYy5kdXJhdGlvbikgew0KICAgICAgICAgICAgZHVyYXRpb24gPSB2aWV3U3BlYy5kdXJhdGlvbjsNCiAgICAgICAgICAgIHVuaXQgPSB2aWV3U3BlYy5kdXJhdGlvblVuaXQ7DQogICAgICAgICAgICB1bnpvbmVkUmFuZ2UgPSB0aGlzLmJ1aWxkUmFuZ2VGcm9tRHVyYXRpb24oZGF0ZSwgZGlyZWN0aW9uLCBkdXJhdGlvbiwgdW5pdCk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAoKGRheUNvdW50ID0gdGhpcy5vcHQoJ2RheUNvdW50JykpKSB7DQogICAgICAgICAgICB1bml0ID0gJ2RheSc7DQogICAgICAgICAgICB1bnpvbmVkUmFuZ2UgPSB0aGlzLmJ1aWxkUmFuZ2VGcm9tRGF5Q291bnQoZGF0ZSwgZGlyZWN0aW9uLCBkYXlDb3VudCk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAoKHVuem9uZWRSYW5nZSA9IHRoaXMuYnVpbGRDdXN0b21WaXNpYmxlUmFuZ2UoZGF0ZSkpKSB7DQogICAgICAgICAgICB1bml0ID0gdXRpbF8xLmNvbXB1dGVHcmVhdGVzdFVuaXQodW56b25lZFJhbmdlLmdldFN0YXJ0KCksIHVuem9uZWRSYW5nZS5nZXRFbmQoKSk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBkdXJhdGlvbiA9IHRoaXMuZ2V0RmFsbGJhY2tEdXJhdGlvbigpOw0KICAgICAgICAgICAgdW5pdCA9IHV0aWxfMS5jb21wdXRlR3JlYXRlc3RVbml0KGR1cmF0aW9uKTsNCiAgICAgICAgICAgIHVuem9uZWRSYW5nZSA9IHRoaXMuYnVpbGRSYW5nZUZyb21EdXJhdGlvbihkYXRlLCBkaXJlY3Rpb24sIGR1cmF0aW9uLCB1bml0KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4geyBkdXJhdGlvbjogZHVyYXRpb24sIHVuaXQ6IHVuaXQsIHVuem9uZWRSYW5nZTogdW56b25lZFJhbmdlIH07DQogICAgfTsNCiAgICBEYXRlUHJvZmlsZUdlbmVyYXRvci5wcm90b3R5cGUuZ2V0RmFsbGJhY2tEdXJhdGlvbiA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIG1vbWVudC5kdXJhdGlvbih7IGRheXM6IDEgfSk7DQogICAgfTsNCiAgICAvLyBSZXR1cm5zIGEgbmV3IGFjdGl2ZVVuem9uZWRSYW5nZSB0byBoYXZlIHRpbWUgdmFsdWVzICh1bi1hbWJpZ3VhdGUpDQogICAgLy8gbWluVGltZSBvciBtYXhUaW1lIGNhdXNlcyB0aGUgcmFuZ2UgdG8gZXhwYW5kLg0KICAgIERhdGVQcm9maWxlR2VuZXJhdG9yLnByb3RvdHlwZS5hZGp1c3RBY3RpdmVSYW5nZSA9IGZ1bmN0aW9uICh1bnpvbmVkUmFuZ2UsIG1pblRpbWUsIG1heFRpbWUpIHsNCiAgICAgICAgdmFyIHN0YXJ0ID0gdW56b25lZFJhbmdlLmdldFN0YXJ0KCk7DQogICAgICAgIHZhciBlbmQgPSB1bnpvbmVkUmFuZ2UuZ2V0RW5kKCk7DQogICAgICAgIGlmICh0aGlzLl92aWV3LnVzZXNNaW5NYXhUaW1lKSB7DQogICAgICAgICAgICBpZiAobWluVGltZSA8IDApIHsNCiAgICAgICAgICAgICAgICBzdGFydC50aW1lKDApLmFkZChtaW5UaW1lKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChtYXhUaW1lID4gMjQgKiA2MCAqIDYwICogMTAwMCkgew0KICAgICAgICAgICAgICAgIGVuZC50aW1lKG1heFRpbWUgLSAoMjQgKiA2MCAqIDYwICogMTAwMCkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiBuZXcgVW56b25lZFJhbmdlXzEuZGVmYXVsdChzdGFydCwgZW5kKTsNCiAgICB9Ow0KICAgIC8vIEJ1aWxkcyB0aGUgImN1cnJlbnQiIHJhbmdlIHdoZW4gaXQgaXMgc3BlY2lmaWVkIGFzIGFuIGV4cGxpY2l0IGR1cmF0aW9uLg0KICAgIC8vIGB1bml0YCBpcyB0aGUgYWxyZWFkeS1jb21wdXRlZCBjb21wdXRlR3JlYXRlc3RVbml0IHZhbHVlIG9mIGR1cmF0aW9uLg0KICAgIC8vIFRPRE86IGFjY2VwdCBhIE1TLXRpbWUgaW5zdGVhZCBvZiBhIG1vbWVudCBgZGF0ZWA/DQogICAgRGF0ZVByb2ZpbGVHZW5lcmF0b3IucHJvdG90eXBlLmJ1aWxkUmFuZ2VGcm9tRHVyYXRpb24gPSBmdW5jdGlvbiAoZGF0ZSwgZGlyZWN0aW9uLCBkdXJhdGlvbiwgdW5pdCkgew0KICAgICAgICB2YXIgYWxpZ25tZW50ID0gdGhpcy5vcHQoJ2RhdGVBbGlnbm1lbnQnKTsNCiAgICAgICAgdmFyIGRhdGVJbmNyZW1lbnRJbnB1dDsNCiAgICAgICAgdmFyIGRhdGVJbmNyZW1lbnREdXJhdGlvbjsNCiAgICAgICAgdmFyIHN0YXJ0Ow0KICAgICAgICB2YXIgZW5kOw0KICAgICAgICB2YXIgcmVzOw0KICAgICAgICAvLyBjb21wdXRlIHdoYXQgdGhlIGFsaWdubWVudCBzaG91bGQgYmUNCiAgICAgICAgaWYgKCFhbGlnbm1lbnQpIHsNCiAgICAgICAgICAgIGRhdGVJbmNyZW1lbnRJbnB1dCA9IHRoaXMub3B0KCdkYXRlSW5jcmVtZW50Jyk7DQogICAgICAgICAgICBpZiAoZGF0ZUluY3JlbWVudElucHV0KSB7DQogICAgICAgICAgICAgICAgZGF0ZUluY3JlbWVudER1cmF0aW9uID0gbW9tZW50LmR1cmF0aW9uKGRhdGVJbmNyZW1lbnRJbnB1dCk7DQogICAgICAgICAgICAgICAgLy8gdXNlIHRoZSBzbWFsbGVyIG9mIHRoZSB0d28gdW5pdHMNCiAgICAgICAgICAgICAgICBpZiAoZGF0ZUluY3JlbWVudER1cmF0aW9uIDwgZHVyYXRpb24pIHsNCiAgICAgICAgICAgICAgICAgICAgYWxpZ25tZW50ID0gdXRpbF8xLmNvbXB1dGVEdXJhdGlvbkdyZWF0ZXN0VW5pdChkYXRlSW5jcmVtZW50RHVyYXRpb24sIGRhdGVJbmNyZW1lbnRJbnB1dCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBhbGlnbm1lbnQgPSB1bml0Ow0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIGFsaWdubWVudCA9IHVuaXQ7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgLy8gaWYgdGhlIHZpZXcgZGlzcGxheXMgYSBzaW5nbGUgZGF5IG9yIHNtYWxsZXINCiAgICAgICAgaWYgKGR1cmF0aW9uLmFzKCdkYXlzJykgPD0gMSkgew0KICAgICAgICAgICAgaWYgKHRoaXMuX3ZpZXcuaXNIaWRkZW5EYXkoc3RhcnQpKSB7DQogICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl92aWV3LnNraXBIaWRkZW5EYXlzKHN0YXJ0LCBkaXJlY3Rpb24pOw0KICAgICAgICAgICAgICAgIHN0YXJ0LnN0YXJ0T2YoJ2RheScpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGZ1bmN0aW9uIGNvbXB1dGVSZXMoKSB7DQogICAgICAgICAgICBzdGFydCA9IGRhdGUuY2xvbmUoKS5zdGFydE9mKGFsaWdubWVudCk7DQogICAgICAgICAgICBlbmQgPSBzdGFydC5jbG9uZSgpLmFkZChkdXJhdGlvbik7DQogICAgICAgICAgICByZXMgPSBuZXcgVW56b25lZFJhbmdlXzEuZGVmYXVsdChzdGFydCwgZW5kKTsNCiAgICAgICAgfQ0KICAgICAgICBjb21wdXRlUmVzKCk7DQogICAgICAgIC8vIGlmIHJhbmdlIGlzIGNvbXBsZXRlbHkgZW52ZWxvcGVkIGJ5IGhpZGRlbiBkYXlzLCBnbyBwYXN0IHRoZSBoaWRkZW4gZGF5cw0KICAgICAgICBpZiAoIXRoaXMudHJpbUhpZGRlbkRheXMocmVzKSkgew0KICAgICAgICAgICAgZGF0ZSA9IHRoaXMuX3ZpZXcuc2tpcEhpZGRlbkRheXMoZGF0ZSwgZGlyZWN0aW9uKTsNCiAgICAgICAgICAgIGNvbXB1dGVSZXMoKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmVzOw0KICAgIH07DQogICAgLy8gQnVpbGRzIHRoZSAiY3VycmVudCIgcmFuZ2Ugd2hlbiBhIGRheUNvdW50IGlzIHNwZWNpZmllZC4NCiAgICAvLyBUT0RPOiBhY2NlcHQgYSBNUy10aW1lIGluc3RlYWQgb2YgYSBtb21lbnQgYGRhdGVgPw0KICAgIERhdGVQcm9maWxlR2VuZXJhdG9yLnByb3RvdHlwZS5idWlsZFJhbmdlRnJvbURheUNvdW50ID0gZnVuY3Rpb24gKGRhdGUsIGRpcmVjdGlvbiwgZGF5Q291bnQpIHsNCiAgICAgICAgdmFyIGN1c3RvbUFsaWdubWVudCA9IHRoaXMub3B0KCdkYXRlQWxpZ25tZW50Jyk7DQogICAgICAgIHZhciBydW5uaW5nQ291bnQgPSAwOw0KICAgICAgICB2YXIgc3RhcnQgPSBkYXRlLmNsb25lKCk7DQogICAgICAgIHZhciBlbmQ7DQogICAgICAgIGlmIChjdXN0b21BbGlnbm1lbnQpIHsNCiAgICAgICAgICAgIHN0YXJ0LnN0YXJ0T2YoY3VzdG9tQWxpZ25tZW50KTsNCiAgICAgICAgfQ0KICAgICAgICBzdGFydC5zdGFydE9mKCdkYXknKTsNCiAgICAgICAgc3RhcnQgPSB0aGlzLl92aWV3LnNraXBIaWRkZW5EYXlzKHN0YXJ0LCBkaXJlY3Rpb24pOw0KICAgICAgICBlbmQgPSBzdGFydC5jbG9uZSgpOw0KICAgICAgICBkbyB7DQogICAgICAgICAgICBlbmQuYWRkKDEsICdkYXknKTsNCiAgICAgICAgICAgIGlmICghdGhpcy5fdmlldy5pc0hpZGRlbkRheShlbmQpKSB7DQogICAgICAgICAgICAgICAgcnVubmluZ0NvdW50Kys7DQogICAgICAgICAgICB9DQogICAgICAgIH0gd2hpbGUgKHJ1bm5pbmdDb3VudCA8IGRheUNvdW50KTsNCiAgICAgICAgcmV0dXJuIG5ldyBVbnpvbmVkUmFuZ2VfMS5kZWZhdWx0KHN0YXJ0LCBlbmQpOw0KICAgIH07DQogICAgLy8gQnVpbGRzIGEgbm9ybWFsaXplZCByYW5nZSBvYmplY3QgZm9yIHRoZSAidmlzaWJsZSIgcmFuZ2UsDQogICAgLy8gd2hpY2ggaXMgYSB3YXkgdG8gZGVmaW5lIHRoZSBjdXJyZW50VW56b25lZFJhbmdlIGFuZCBhY3RpdmVVbnpvbmVkUmFuZ2UgYXQgdGhlIHNhbWUgdGltZS4NCiAgICAvLyBUT0RPOiBhY2NlcHQgYSBNUy10aW1lIGluc3RlYWQgb2YgYSBtb21lbnQgYGRhdGVgPw0KICAgIERhdGVQcm9maWxlR2VuZXJhdG9yLnByb3RvdHlwZS5idWlsZEN1c3RvbVZpc2libGVSYW5nZSA9IGZ1bmN0aW9uIChkYXRlKSB7DQogICAgICAgIHZhciB2aXNpYmxlVW56b25lZFJhbmdlID0gdGhpcy5fdmlldy5nZXRVbnpvbmVkUmFuZ2VPcHRpb24oJ3Zpc2libGVSYW5nZScsIHRoaXMuX3ZpZXcuY2FsZW5kYXIuYXBwbHlUaW1lem9uZShkYXRlKSAvLyBjb3JyZWN0IHpvbmUuIGFsc28gZ2VuZXJhdGVzIG5ldyBvYmogdGhhdCBhdm9pZHMgbXV0YXRpb25zDQogICAgICAgICk7DQogICAgICAgIGlmICh2aXNpYmxlVW56b25lZFJhbmdlICYmICh2aXNpYmxlVW56b25lZFJhbmdlLnN0YXJ0TXMgPT0gbnVsbCB8fCB2aXNpYmxlVW56b25lZFJhbmdlLmVuZE1zID09IG51bGwpKSB7DQogICAgICAgICAgICByZXR1cm4gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdmlzaWJsZVVuem9uZWRSYW5nZTsNCiAgICB9Ow0KICAgIC8vIENvbXB1dGVzIHRoZSByYW5nZSB0aGF0IHdpbGwgcmVwcmVzZW50IHRoZSBlbGVtZW50L2NlbGxzIGZvciAqcmVuZGVyaW5nKiwNCiAgICAvLyBidXQgd2hpY2ggbWF5IGhhdmUgdm9pZGVkIGRheXMvdGltZXMuDQogICAgLy8gbm90IHJlc3BvbnNpYmxlIGZvciB0cmltbWluZyBoaWRkZW4gZGF5cy4NCiAgICBEYXRlUHJvZmlsZUdlbmVyYXRvci5wcm90b3R5cGUuYnVpbGRSZW5kZXJSYW5nZSA9IGZ1bmN0aW9uIChjdXJyZW50VW56b25lZFJhbmdlLCBjdXJyZW50UmFuZ2VVbml0LCBpc1JhbmdlQWxsRGF5KSB7DQogICAgICAgIHJldHVybiBjdXJyZW50VW56b25lZFJhbmdlLmNsb25lKCk7DQogICAgfTsNCiAgICAvLyBDb21wdXRlIHRoZSBkdXJhdGlvbiB2YWx1ZSB0aGF0IHNob3VsZCBiZSBhZGRlZC9zdWJzdHJhY3RlZCB0byB0aGUgY3VycmVudCBkYXRlDQogICAgLy8gd2hlbiBhIHByZXYvbmV4dCBvcGVyYXRpb24gaGFwcGVucy4NCiAgICBEYXRlUHJvZmlsZUdlbmVyYXRvci5wcm90b3R5cGUuYnVpbGREYXRlSW5jcmVtZW50ID0gZnVuY3Rpb24gKGZhbGxiYWNrKSB7DQogICAgICAgIHZhciBkYXRlSW5jcmVtZW50SW5wdXQgPSB0aGlzLm9wdCgnZGF0ZUluY3JlbWVudCcpOw0KICAgICAgICB2YXIgY3VzdG9tQWxpZ25tZW50Ow0KICAgICAgICBpZiAoZGF0ZUluY3JlbWVudElucHV0KSB7DQogICAgICAgICAgICByZXR1cm4gbW9tZW50LmR1cmF0aW9uKGRhdGVJbmNyZW1lbnRJbnB1dCk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAoKGN1c3RvbUFsaWdubWVudCA9IHRoaXMub3B0KCdkYXRlQWxpZ25tZW50JykpKSB7DQogICAgICAgICAgICByZXR1cm4gbW9tZW50LmR1cmF0aW9uKDEsIGN1c3RvbUFsaWdubWVudCk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAoZmFsbGJhY2spIHsNCiAgICAgICAgICAgIHJldHVybiBmYWxsYmFjazsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHJldHVybiBtb21lbnQuZHVyYXRpb24oeyBkYXlzOiAxIH0pOw0KICAgICAgICB9DQogICAgfTsNCiAgICByZXR1cm4gRGF0ZVByb2ZpbGVHZW5lcmF0b3I7DQp9KCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gRGF0ZVByb2ZpbGVHZW5lcmF0b3I7DQoKCi8qKiovIH0pLAovKiAyMjIgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCnZhciBtb21lbnQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDApOw0KdmFyIGV4cG9ydEhvb2tzID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNyk7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCnZhciBtb21lbnRfZXh0XzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDEwKTsNCnZhciBMaXN0ZW5lck1peGluXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDcpOw0KdmFyIEhpdERyYWdMaXN0ZW5lcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMik7DQp2YXIgU2luZ2xlRXZlbnREZWZfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTMpOw0KdmFyIEV2ZW50SW5zdGFuY2VHcm91cF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxOSk7DQp2YXIgRXZlbnRTb3VyY2VfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNik7DQp2YXIgSW50ZXJhY3Rpb25fMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTYpOw0KdmFyIEV4dGVybmFsRHJvcHBpbmcgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoRXh0ZXJuYWxEcm9wcGluZywgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBFeHRlcm5hbERyb3BwaW5nKCkgew0KICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIgIT09IG51bGwgJiYgX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsNCiAgICAgICAgX3RoaXMuaXNEcmFnZ2luZyA9IGZhbHNlOyAvLyBqcXVpLWRyYWdnaW5nIGFuIGV4dGVybmFsIGVsZW1lbnQ/IGJvb2xlYW4NCiAgICAgICAgcmV0dXJuIF90aGlzOw0KICAgIH0NCiAgICAvKg0KICAgIGNvbXBvbmVudCBpbXBlbWVudHM6DQogICAgICAtIGV2ZW50UmFuZ2VzVG9FdmVudEZvb3RwcmludHMNCiAgICAgIC0gaXNFdmVudEluc3RhbmNlR3JvdXBBbGxvd2VkDQogICAgICAtIGlzRXh0ZXJuYWxJbnN0YW5jZUdyb3VwQWxsb3dlZA0KICAgICAgLSByZW5kZXJEcmFnDQogICAgICAtIHVucmVuZGVyRHJhZw0KICAgICovDQogICAgRXh0ZXJuYWxEcm9wcGluZy5wcm90b3R5cGUuZW5kID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5kcmFnTGlzdGVuZXIpIHsNCiAgICAgICAgICAgIHRoaXMuZHJhZ0xpc3RlbmVyLmVuZEludGVyYWN0aW9uKCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIEV4dGVybmFsRHJvcHBpbmcucHJvdG90eXBlLmJpbmRUb0RvY3VtZW50ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLmxpc3RlblRvKCQoZG9jdW1lbnQpLCB7DQogICAgICAgICAgICBkcmFnc3RhcnQ6IHRoaXMuaGFuZGxlRHJhZ1N0YXJ0LA0KICAgICAgICAgICAgc29ydHN0YXJ0OiB0aGlzLmhhbmRsZURyYWdTdGFydCAvLyBqcXVpDQogICAgICAgIH0pOw0KICAgIH07DQogICAgRXh0ZXJuYWxEcm9wcGluZy5wcm90b3R5cGUudW5iaW5kRnJvbURvY3VtZW50ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLnN0b3BMaXN0ZW5pbmdUbygkKGRvY3VtZW50KSk7DQogICAgfTsNCiAgICAvLyBDYWxsZWQgd2hlbiBhIGpRdWVyeSBVSSBkcmFnIGlzIGluaXRpYXRlZCBhbnl3aGVyZSBpbiB0aGUgRE9NDQogICAgRXh0ZXJuYWxEcm9wcGluZy5wcm90b3R5cGUuaGFuZGxlRHJhZ1N0YXJ0ID0gZnVuY3Rpb24gKGV2LCB1aSkgew0KICAgICAgICB2YXIgZWw7DQogICAgICAgIHZhciBhY2NlcHQ7DQogICAgICAgIGlmICh0aGlzLm9wdCgnZHJvcHBhYmxlJykpIHsNCiAgICAgICAgICAgIGVsID0gJCgodWkgPyB1aS5pdGVtIDogbnVsbCkgfHwgZXYudGFyZ2V0KTsNCiAgICAgICAgICAgIC8vIFRlc3QgdGhhdCB0aGUgZHJhZ2dlZCBlbGVtZW50IHBhc3NlcyB0aGUgZHJvcEFjY2VwdCBzZWxlY3RvciBvciBmaWx0ZXIgZnVuY3Rpb24uDQogICAgICAgICAgICAvLyBGWUksIHRoZSBkZWZhdWx0IGlzICIqIiAobWF0Y2hlcyBhbGwpDQogICAgICAgICAgICBhY2NlcHQgPSB0aGlzLm9wdCgnZHJvcEFjY2VwdCcpOw0KICAgICAgICAgICAgaWYgKCQuaXNGdW5jdGlvbihhY2NlcHQpID8gYWNjZXB0LmNhbGwoZWxbMF0sIGVsKSA6IGVsLmlzKGFjY2VwdCkpIHsNCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNEcmFnZ2luZykgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLmxpc3RlblRvRXh0ZXJuYWxEcmFnKGVsLCBldiwgdWkpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gQ2FsbGVkIHdoZW4gYSBqUXVlcnkgVUkgZHJhZyBzdGFydHMgYW5kIGl0IG5lZWRzIHRvIGJlIG1vbml0b3JlZCBmb3IgZHJvcHBpbmcNCiAgICBFeHRlcm5hbERyb3BwaW5nLnByb3RvdHlwZS5saXN0ZW5Ub0V4dGVybmFsRHJhZyA9IGZ1bmN0aW9uIChlbCwgZXYsIHVpKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIHZhciBjb21wb25lbnQgPSB0aGlzLmNvbXBvbmVudDsNCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLnZpZXc7DQogICAgICAgIHZhciBtZXRhID0gZ2V0RHJhZ2dlZEVsTWV0YShlbCk7IC8vIGV4dHJhIGRhdGEgYWJvdXQgZXZlbnQgZHJvcCwgaW5jbHVkaW5nIHBvc3NpYmxlIGV2ZW50IHRvIGNyZWF0ZQ0KICAgICAgICB2YXIgc2luZ2xlRXZlbnREZWY7IC8vIGEgbnVsbCB2YWx1ZSBzaWduYWxzIGFuIHVuc3VjY2Vzc2Z1bCBkcmFnDQogICAgICAgIC8vIGxpc3RlbmVyIHRoYXQgdHJhY2tzIG1vdXNlIG1vdmVtZW50IG92ZXIgZGF0ZS1hc3NvY2lhdGVkIHBpeGVsIHJlZ2lvbnMNCiAgICAgICAgdmFyIGRyYWdMaXN0ZW5lciA9IHRoaXMuZHJhZ0xpc3RlbmVyID0gbmV3IEhpdERyYWdMaXN0ZW5lcl8xLmRlZmF1bHQoY29tcG9uZW50LCB7DQogICAgICAgICAgICBpbnRlcmFjdGlvblN0YXJ0OiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgX3RoaXMuaXNEcmFnZ2luZyA9IHRydWU7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgaGl0T3ZlcjogZnVuY3Rpb24gKGhpdCkgew0KICAgICAgICAgICAgICAgIHZhciBpc0FsbG93ZWQgPSB0cnVlOw0KICAgICAgICAgICAgICAgIHZhciBoaXRGb290cHJpbnQgPSBoaXQuY29tcG9uZW50LmdldFNhZmVIaXRGb290cHJpbnQoaGl0KTsgLy8gaGl0IG1pZ2h0IG5vdCBiZWxvbmcgdG8gdGhpcyBncmlkDQogICAgICAgICAgICAgICAgdmFyIG11dGF0ZWRFdmVudEluc3RhbmNlR3JvdXA7DQogICAgICAgICAgICAgICAgaWYgKGhpdEZvb3RwcmludCkgew0KICAgICAgICAgICAgICAgICAgICBzaW5nbGVFdmVudERlZiA9IF90aGlzLmNvbXB1dGVFeHRlcm5hbERyb3AoaGl0Rm9vdHByaW50LCBtZXRhKTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKHNpbmdsZUV2ZW50RGVmKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBtdXRhdGVkRXZlbnRJbnN0YW5jZUdyb3VwID0gbmV3IEV2ZW50SW5zdGFuY2VHcm91cF8xLmRlZmF1bHQoc2luZ2xlRXZlbnREZWYuYnVpbGRJbnN0YW5jZXMoKSk7DQogICAgICAgICAgICAgICAgICAgICAgICBpc0FsbG93ZWQgPSBtZXRhLmV2ZW50UHJvcHMgPyAvLyBpc0V2ZW50Pw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC5pc0V2ZW50SW5zdGFuY2VHcm91cEFsbG93ZWQobXV0YXRlZEV2ZW50SW5zdGFuY2VHcm91cCkgOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC5pc0V4dGVybmFsSW5zdGFuY2VHcm91cEFsbG93ZWQobXV0YXRlZEV2ZW50SW5zdGFuY2VHcm91cCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpc0FsbG93ZWQgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgaXNBbGxvd2VkID0gZmFsc2U7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmICghaXNBbGxvd2VkKSB7DQogICAgICAgICAgICAgICAgICAgIHNpbmdsZUV2ZW50RGVmID0gbnVsbDsNCiAgICAgICAgICAgICAgICAgICAgdXRpbF8xLmRpc2FibGVDdXJzb3IoKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYgKHNpbmdsZUV2ZW50RGVmKSB7DQogICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC5yZW5kZXJEcmFnKC8vIGNhbGxlZCB3aXRob3V0IGEgc2VnIHBhcmFtZXRlcg0KICAgICAgICAgICAgICAgICAgICBjb21wb25lbnQuZXZlbnRSYW5nZXNUb0V2ZW50Rm9vdHByaW50cyhtdXRhdGVkRXZlbnRJbnN0YW5jZUdyb3VwLnNsaWNlUmVuZGVyUmFuZ2VzKGNvbXBvbmVudC5kYXRlUHJvZmlsZS5yZW5kZXJVbnpvbmVkUmFuZ2UsIHZpZXcuY2FsZW5kYXIpKSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGhpdE91dDogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIHNpbmdsZUV2ZW50RGVmID0gbnVsbDsgLy8gc2lnbmFsIHVuc3VjY2Vzc2Z1bA0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGhpdERvbmU6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICB1dGlsXzEuZW5hYmxlQ3Vyc29yKCk7DQogICAgICAgICAgICAgICAgY29tcG9uZW50LnVucmVuZGVyRHJhZygpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGludGVyYWN0aW9uRW5kOiBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgICAgICAgICBpZiAoc2luZ2xlRXZlbnREZWYpIHsNCiAgICAgICAgICAgICAgICAgICAgdmlldy5yZXBvcnRFeHRlcm5hbERyb3Aoc2luZ2xlRXZlbnREZWYsIEJvb2xlYW4obWV0YS5ldmVudFByb3BzKSwgLy8gaXNFdmVudA0KICAgICAgICAgICAgICAgICAgICBCb29sZWFuKG1ldGEuc3RpY2spLCAvLyBpc1N0aWNreQ0KICAgICAgICAgICAgICAgICAgICBlbCwgZXYsIHVpKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgX3RoaXMuaXNEcmFnZ2luZyA9IGZhbHNlOw0KICAgICAgICAgICAgICAgIF90aGlzLmRyYWdMaXN0ZW5lciA9IG51bGw7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgICBkcmFnTGlzdGVuZXIuc3RhcnREcmFnKGV2KTsgLy8gc3RhcnQgbGlzdGVuaW5nIGltbWVkaWF0ZWx5DQogICAgfTsNCiAgICAvLyBHaXZlbiBhIGhpdCB0byBiZSBkcm9wcGVkIHVwb24sIGFuZCBtaXNjIGRhdGEgYXNzb2NpYXRlZCB3aXRoIHRoZSBqcXVpIGRyYWcgKGd1YXJhbnRlZWQgdG8gYmUgYSBwbGFpbiBvYmplY3QpLA0KICAgIC8vIHJldHVybnMgdGhlIHpvbmVkIHN0YXJ0L2VuZCBkYXRlcyBmb3IgdGhlIGV2ZW50IHRoYXQgd291bGQgcmVzdWx0IGZyb20gdGhlIGh5cG90aGV0aWNhbCBkcm9wLiBlbmQgbWlnaHQgYmUgbnVsbC4NCiAgICAvLyBSZXR1cm5pbmcgYSBudWxsIHZhbHVlIHNpZ25hbHMgYW4gaW52YWxpZCBkcm9wIGhpdC4NCiAgICAvLyBET0VTIE5PVCBjb25zaWRlciBvdmVybGFwL2NvbnN0cmFpbnQuDQogICAgLy8gQXNzdW1lcyBib3RoIGZvb3RwcmludHMgYXJlIG5vbi1vcGVuLWVuZGVkLg0KICAgIEV4dGVybmFsRHJvcHBpbmcucHJvdG90eXBlLmNvbXB1dGVFeHRlcm5hbERyb3AgPSBmdW5jdGlvbiAoY29tcG9uZW50Rm9vdHByaW50LCBtZXRhKSB7DQogICAgICAgIHZhciBjYWxlbmRhciA9IHRoaXMudmlldy5jYWxlbmRhcjsNCiAgICAgICAgdmFyIHN0YXJ0ID0gbW9tZW50X2V4dF8xLmRlZmF1bHQudXRjKGNvbXBvbmVudEZvb3RwcmludC51bnpvbmVkUmFuZ2Uuc3RhcnRNcykuc3RyaXBab25lKCk7DQogICAgICAgIHZhciBlbmQ7DQogICAgICAgIHZhciBldmVudERlZjsNCiAgICAgICAgaWYgKGNvbXBvbmVudEZvb3RwcmludC5pc0FsbERheSkgew0KICAgICAgICAgICAgLy8gaWYgZHJvcHBlZCBvbiBhbiBhbGwtZGF5IHNwYW4sIGFuZCBlbGVtZW50J3MgbWV0YWRhdGEgc3BlY2lmaWVkIGEgdGltZSwgc2V0IGl0DQogICAgICAgICAgICBpZiAobWV0YS5zdGFydFRpbWUpIHsNCiAgICAgICAgICAgICAgICBzdGFydC50aW1lKG1ldGEuc3RhcnRUaW1lKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIHN0YXJ0LnN0cmlwVGltZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGlmIChtZXRhLmR1cmF0aW9uKSB7DQogICAgICAgICAgICBlbmQgPSBzdGFydC5jbG9uZSgpLmFkZChtZXRhLmR1cmF0aW9uKTsNCiAgICAgICAgfQ0KICAgICAgICBzdGFydCA9IGNhbGVuZGFyLmFwcGx5VGltZXpvbmUoc3RhcnQpOw0KICAgICAgICBpZiAoZW5kKSB7DQogICAgICAgICAgICBlbmQgPSBjYWxlbmRhci5hcHBseVRpbWV6b25lKGVuZCk7DQogICAgICAgIH0NCiAgICAgICAgZXZlbnREZWYgPSBTaW5nbGVFdmVudERlZl8xLmRlZmF1bHQucGFyc2UoJC5leHRlbmQoe30sIG1ldGEuZXZlbnRQcm9wcywgew0KICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0LA0KICAgICAgICAgICAgZW5kOiBlbmQNCiAgICAgICAgfSksIG5ldyBFdmVudFNvdXJjZV8xLmRlZmF1bHQoY2FsZW5kYXIpKTsNCiAgICAgICAgcmV0dXJuIGV2ZW50RGVmOw0KICAgIH07DQogICAgcmV0dXJuIEV4dGVybmFsRHJvcHBpbmc7DQp9KEludGVyYWN0aW9uXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gRXh0ZXJuYWxEcm9wcGluZzsNCkxpc3RlbmVyTWl4aW5fMS5kZWZhdWx0Lm1peEludG8oRXh0ZXJuYWxEcm9wcGluZyk7DQovKiBFeHRlcm5hbC1EcmFnZ2luZy1FbGVtZW50IERhdGENCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KLy8gUmVxdWlyZSBhbGwgSFRNTDUgZGF0YS0qIGF0dHJpYnV0ZXMgdXNlZCBieSBGdWxsQ2FsZW5kYXIgdG8gaGF2ZSB0aGlzIHByZWZpeC4NCi8vIEEgdmFsdWUgb2YgJycgd2lsbCBxdWVyeSBhdHRyaWJ1dGVzIGxpa2UgZGF0YS1ldmVudC4gQSB2YWx1ZSBvZiAnZmMnIHdpbGwgcXVlcnkgYXR0cmlidXRlcyBsaWtlIGRhdGEtZmMtZXZlbnQuDQpleHBvcnRIb29rcy5kYXRhQXR0clByZWZpeCA9ICcnOw0KLy8gR2l2ZW4gYSBqUXVlcnkgZWxlbWVudCB0aGF0IG1pZ2h0IHJlcHJlc2VudCBhIGRyYWdnZWQgRnVsbENhbGVuZGFyIGV2ZW50LCByZXR1cm5zIGFuIGludGVybWVkaWF0ZSBkYXRhIHN0cnVjdHVyZQ0KLy8gdG8gYmUgdXNlZCBmb3IgRXZlbnQgT2JqZWN0IGNyZWF0aW9uLg0KLy8gQSBkZWZpbmVkIGAuZXZlbnRQcm9wc2AsIGV2ZW4gd2hlbiBlbXB0eSwgaW5kaWNhdGVzIHRoYXQgYW4gZXZlbnQgc2hvdWxkIGJlIGNyZWF0ZWQuDQpmdW5jdGlvbiBnZXREcmFnZ2VkRWxNZXRhKGVsKSB7DQogICAgdmFyIHByZWZpeCA9IGV4cG9ydEhvb2tzLmRhdGFBdHRyUHJlZml4Ow0KICAgIHZhciBldmVudFByb3BzOyAvLyBwcm9wZXJ0aWVzIGZvciBjcmVhdGluZyB0aGUgZXZlbnQsIG5vdCByZWxhdGVkIHRvIGRhdGUvdGltZQ0KICAgIHZhciBzdGFydFRpbWU7IC8vIGEgRHVyYXRpb24NCiAgICB2YXIgZHVyYXRpb247DQogICAgdmFyIHN0aWNrOw0KICAgIGlmIChwcmVmaXgpIHsNCiAgICAgICAgcHJlZml4ICs9ICctJzsNCiAgICB9DQogICAgZXZlbnRQcm9wcyA9IGVsLmRhdGEocHJlZml4ICsgJ2V2ZW50JykgfHwgbnVsbDsNCiAgICBpZiAoZXZlbnRQcm9wcykgew0KICAgICAgICBpZiAodHlwZW9mIGV2ZW50UHJvcHMgPT09ICdvYmplY3QnKSB7DQogICAgICAgICAgICBldmVudFByb3BzID0gJC5leHRlbmQoe30sIGV2ZW50UHJvcHMpOyAvLyBtYWtlIGEgY29weQ0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgZXZlbnRQcm9wcyA9IHt9Ow0KICAgICAgICB9DQogICAgICAgIC8vIHBsdWNrIHNwZWNpYWwtY2FzZWQgZGF0ZS90aW1lIHByb3BlcnRpZXMNCiAgICAgICAgc3RhcnRUaW1lID0gZXZlbnRQcm9wcy5zdGFydDsNCiAgICAgICAgaWYgKHN0YXJ0VGltZSA9PSBudWxsKSB7DQogICAgICAgICAgICBzdGFydFRpbWUgPSBldmVudFByb3BzLnRpbWU7DQogICAgICAgIH0gLy8gYWNjZXB0ICd0aW1lJyBhcyB3ZWxsDQogICAgICAgIGR1cmF0aW9uID0gZXZlbnRQcm9wcy5kdXJhdGlvbjsNCiAgICAgICAgc3RpY2sgPSBldmVudFByb3BzLnN0aWNrOw0KICAgICAgICBkZWxldGUgZXZlbnRQcm9wcy5zdGFydDsNCiAgICAgICAgZGVsZXRlIGV2ZW50UHJvcHMudGltZTsNCiAgICAgICAgZGVsZXRlIGV2ZW50UHJvcHMuZHVyYXRpb247DQogICAgICAgIGRlbGV0ZSBldmVudFByb3BzLnN0aWNrOw0KICAgIH0NCiAgICAvLyBmYWxsYmFjayB0byBzdGFuZGFsb25lIGF0dHJpYnV0ZSB2YWx1ZXMgZm9yIGVhY2ggb2YgdGhlIGRhdGUvdGltZSBwcm9wZXJ0aWVzDQogICAgaWYgKHN0YXJ0VGltZSA9PSBudWxsKSB7DQogICAgICAgIHN0YXJ0VGltZSA9IGVsLmRhdGEocHJlZml4ICsgJ3N0YXJ0Jyk7DQogICAgfQ0KICAgIGlmIChzdGFydFRpbWUgPT0gbnVsbCkgew0KICAgICAgICBzdGFydFRpbWUgPSBlbC5kYXRhKHByZWZpeCArICd0aW1lJyk7DQogICAgfSAvLyBhY2NlcHQgJ3RpbWUnIGFzIHdlbGwNCiAgICBpZiAoZHVyYXRpb24gPT0gbnVsbCkgew0KICAgICAgICBkdXJhdGlvbiA9IGVsLmRhdGEocHJlZml4ICsgJ2R1cmF0aW9uJyk7DQogICAgfQ0KICAgIGlmIChzdGljayA9PSBudWxsKSB7DQogICAgICAgIHN0aWNrID0gZWwuZGF0YShwcmVmaXggKyAnc3RpY2snKTsNCiAgICB9DQogICAgLy8gbWFzc2FnZSBpbnRvIGNvcnJlY3QgZGF0YSB0eXBlcw0KICAgIHN0YXJ0VGltZSA9IHN0YXJ0VGltZSAhPSBudWxsID8gbW9tZW50LmR1cmF0aW9uKHN0YXJ0VGltZSkgOiBudWxsOw0KICAgIGR1cmF0aW9uID0gZHVyYXRpb24gIT0gbnVsbCA/IG1vbWVudC5kdXJhdGlvbihkdXJhdGlvbikgOiBudWxsOw0KICAgIHN0aWNrID0gQm9vbGVhbihzdGljayk7DQogICAgcmV0dXJuIHsgZXZlbnRQcm9wczogZXZlbnRQcm9wcywgc3RhcnRUaW1lOiBzdGFydFRpbWUsIGR1cmF0aW9uOiBkdXJhdGlvbiwgc3RpY2s6IHN0aWNrIH07DQp9DQoKCi8qKiovIH0pLAovKiAyMjMgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCnZhciB1dGlsXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQpOw0KdmFyIEV2ZW50RGVmTXV0YXRpb25fMSA9IF9fd2VicGFja19yZXF1aXJlX18oMzYpOw0KdmFyIEV2ZW50RGVmRGF0ZU11dGF0aW9uXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUwKTsNCnZhciBIaXREcmFnTGlzdGVuZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjIpOw0KdmFyIEludGVyYWN0aW9uXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDE2KTsNCnZhciBFdmVudFJlc2l6aW5nID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKEV2ZW50UmVzaXppbmcsIF9zdXBlcik7DQogICAgLyoNCiAgICBjb21wb25lbnQgaW1wZW1lbnRzOg0KICAgICAgLSBiaW5kU2VnSGFuZGxlclRvRWwNCiAgICAgIC0gcHVibGljbHlUcmlnZ2VyDQogICAgICAtIGRpZmZEYXRlcw0KICAgICAgLSBldmVudFJhbmdlc1RvRXZlbnRGb290cHJpbnRzDQogICAgICAtIGlzRXZlbnRJbnN0YW5jZUdyb3VwQWxsb3dlZA0KICAgICAgLSBnZXRTYWZlSGl0Rm9vdHByaW50DQogICAgKi8NCiAgICBmdW5jdGlvbiBFdmVudFJlc2l6aW5nKGNvbXBvbmVudCwgZXZlbnRQb2ludGluZykgew0KICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzLCBjb21wb25lbnQpIHx8IHRoaXM7DQogICAgICAgIF90aGlzLmlzUmVzaXppbmcgPSBmYWxzZTsNCiAgICAgICAgX3RoaXMuZXZlbnRQb2ludGluZyA9IGV2ZW50UG9pbnRpbmc7DQogICAgICAgIHJldHVybiBfdGhpczsNCiAgICB9DQogICAgRXZlbnRSZXNpemluZy5wcm90b3R5cGUuZW5kID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5kcmFnTGlzdGVuZXIpIHsNCiAgICAgICAgICAgIHRoaXMuZHJhZ0xpc3RlbmVyLmVuZEludGVyYWN0aW9uKCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIEV2ZW50UmVzaXppbmcucHJvdG90eXBlLmJpbmRUb0VsID0gZnVuY3Rpb24gKGVsKSB7DQogICAgICAgIHZhciBjb21wb25lbnQgPSB0aGlzLmNvbXBvbmVudDsNCiAgICAgICAgY29tcG9uZW50LmJpbmRTZWdIYW5kbGVyVG9FbChlbCwgJ21vdXNlZG93bicsIHRoaXMuaGFuZGxlTW91c2VEb3duLmJpbmQodGhpcykpOw0KICAgICAgICBjb21wb25lbnQuYmluZFNlZ0hhbmRsZXJUb0VsKGVsLCAndG91Y2hzdGFydCcsIHRoaXMuaGFuZGxlVG91Y2hTdGFydC5iaW5kKHRoaXMpKTsNCiAgICB9Ow0KICAgIEV2ZW50UmVzaXppbmcucHJvdG90eXBlLmhhbmRsZU1vdXNlRG93biA9IGZ1bmN0aW9uIChzZWcsIGV2KSB7DQogICAgICAgIGlmICh0aGlzLmNvbXBvbmVudC5jYW5TdGFydFJlc2l6ZShzZWcsIGV2KSkgew0KICAgICAgICAgICAgdGhpcy5idWlsZERyYWdMaXN0ZW5lcihzZWcsICQoZXYudGFyZ2V0KS5pcygnLmZjLXN0YXJ0LXJlc2l6ZXInKSkNCiAgICAgICAgICAgICAgICAuc3RhcnRJbnRlcmFjdGlvbihldiwgeyBkaXN0YW5jZTogNSB9KTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgRXZlbnRSZXNpemluZy5wcm90b3R5cGUuaGFuZGxlVG91Y2hTdGFydCA9IGZ1bmN0aW9uIChzZWcsIGV2KSB7DQogICAgICAgIGlmICh0aGlzLmNvbXBvbmVudC5jYW5TdGFydFJlc2l6ZShzZWcsIGV2KSkgew0KICAgICAgICAgICAgdGhpcy5idWlsZERyYWdMaXN0ZW5lcihzZWcsICQoZXYudGFyZ2V0KS5pcygnLmZjLXN0YXJ0LXJlc2l6ZXInKSkNCiAgICAgICAgICAgICAgICAuc3RhcnRJbnRlcmFjdGlvbihldik7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIENyZWF0ZXMgYSBsaXN0ZW5lciB0aGF0IHRyYWNrcyB0aGUgdXNlciBhcyB0aGV5IHJlc2l6ZSBhbiBldmVudCBzZWdtZW50Lg0KICAgIC8vIEdlbmVyaWMgZW5vdWdoIHRvIHdvcmsgd2l0aCBhbnkgdHlwZSBvZiBHcmlkLg0KICAgIEV2ZW50UmVzaXppbmcucHJvdG90eXBlLmJ1aWxkRHJhZ0xpc3RlbmVyID0gZnVuY3Rpb24gKHNlZywgaXNTdGFydCkgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICB2YXIgY29tcG9uZW50ID0gdGhpcy5jb21wb25lbnQ7DQogICAgICAgIHZhciB2aWV3ID0gdGhpcy52aWV3Ow0KICAgICAgICB2YXIgY2FsZW5kYXIgPSB2aWV3LmNhbGVuZGFyOw0KICAgICAgICB2YXIgZXZlbnRNYW5hZ2VyID0gY2FsZW5kYXIuZXZlbnRNYW5hZ2VyOw0KICAgICAgICB2YXIgZWwgPSBzZWcuZWw7DQogICAgICAgIHZhciBldmVudERlZiA9IHNlZy5mb290cHJpbnQuZXZlbnREZWY7DQogICAgICAgIHZhciBldmVudEluc3RhbmNlID0gc2VnLmZvb3RwcmludC5ldmVudEluc3RhbmNlOw0KICAgICAgICB2YXIgaXNEcmFnZ2luZzsNCiAgICAgICAgdmFyIHJlc2l6ZU11dGF0aW9uOyAvLyB6b25lZCBldmVudCBkYXRlIHByb3BlcnRpZXMuIGZhbHN5IGlmIGludmFsaWQgcmVzaXplDQogICAgICAgIC8vIFRyYWNrcyBtb3VzZSBtb3ZlbWVudCBvdmVyIHRoZSAqZ3JpZCdzKiBjb29yZGluYXRlIG1hcA0KICAgICAgICB2YXIgZHJhZ0xpc3RlbmVyID0gdGhpcy5kcmFnTGlzdGVuZXIgPSBuZXcgSGl0RHJhZ0xpc3RlbmVyXzEuZGVmYXVsdChjb21wb25lbnQsIHsNCiAgICAgICAgICAgIHNjcm9sbDogdGhpcy5vcHQoJ2RyYWdTY3JvbGwnKSwNCiAgICAgICAgICAgIHN1YmplY3RFbDogZWwsDQogICAgICAgICAgICBpbnRlcmFjdGlvblN0YXJ0OiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgaXNEcmFnZ2luZyA9IGZhbHNlOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGRyYWdTdGFydDogZnVuY3Rpb24gKGV2KSB7DQogICAgICAgICAgICAgICAgaXNEcmFnZ2luZyA9IHRydWU7DQogICAgICAgICAgICAgICAgLy8gZW5zdXJlIGEgbW91c2VvdXQgb24gdGhlIG1hbmlwdWxhdGVkIGV2ZW50IGhhcyBiZWVuIHJlcG9ydGVkDQogICAgICAgICAgICAgICAgX3RoaXMuZXZlbnRQb2ludGluZy5oYW5kbGVNb3VzZW91dChzZWcsIGV2KTsNCiAgICAgICAgICAgICAgICBfdGhpcy5zZWdSZXNpemVTdGFydChzZWcsIGV2KTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBoaXRPdmVyOiBmdW5jdGlvbiAoaGl0LCBpc09yaWcsIG9yaWdIaXQpIHsNCiAgICAgICAgICAgICAgICB2YXIgaXNBbGxvd2VkID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICB2YXIgb3JpZ0hpdEZvb3RwcmludCA9IGNvbXBvbmVudC5nZXRTYWZlSGl0Rm9vdHByaW50KG9yaWdIaXQpOw0KICAgICAgICAgICAgICAgIHZhciBoaXRGb290cHJpbnQgPSBjb21wb25lbnQuZ2V0U2FmZUhpdEZvb3RwcmludChoaXQpOw0KICAgICAgICAgICAgICAgIHZhciBtdXRhdGVkRXZlbnRJbnN0YW5jZUdyb3VwOw0KICAgICAgICAgICAgICAgIGlmIChvcmlnSGl0Rm9vdHByaW50ICYmIGhpdEZvb3RwcmludCkgew0KICAgICAgICAgICAgICAgICAgICByZXNpemVNdXRhdGlvbiA9IGlzU3RhcnQgPw0KICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29tcHV0ZUV2ZW50U3RhcnRSZXNpemVNdXRhdGlvbihvcmlnSGl0Rm9vdHByaW50LCBoaXRGb290cHJpbnQsIHNlZy5mb290cHJpbnQpIDoNCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmNvbXB1dGVFdmVudEVuZFJlc2l6ZU11dGF0aW9uKG9yaWdIaXRGb290cHJpbnQsIGhpdEZvb3RwcmludCwgc2VnLmZvb3RwcmludCk7DQogICAgICAgICAgICAgICAgICAgIGlmIChyZXNpemVNdXRhdGlvbikgew0KICAgICAgICAgICAgICAgICAgICAgICAgbXV0YXRlZEV2ZW50SW5zdGFuY2VHcm91cCA9IGV2ZW50TWFuYWdlci5idWlsZE11dGF0ZWRFdmVudEluc3RhbmNlR3JvdXAoZXZlbnREZWYuaWQsIHJlc2l6ZU11dGF0aW9uKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlzQWxsb3dlZCA9IGNvbXBvbmVudC5pc0V2ZW50SW5zdGFuY2VHcm91cEFsbG93ZWQobXV0YXRlZEV2ZW50SW5zdGFuY2VHcm91cCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpc0FsbG93ZWQgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgaXNBbGxvd2VkID0gZmFsc2U7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmICghaXNBbGxvd2VkKSB7DQogICAgICAgICAgICAgICAgICAgIHJlc2l6ZU11dGF0aW9uID0gbnVsbDsNCiAgICAgICAgICAgICAgICAgICAgdXRpbF8xLmRpc2FibGVDdXJzb3IoKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSBpZiAocmVzaXplTXV0YXRpb24uaXNFbXB0eSgpKSB7DQogICAgICAgICAgICAgICAgICAgIC8vIG5vIGNoYW5nZS4gKEZZSSwgZXZlbnQgZGF0ZXMgbWlnaHQgaGF2ZSB6b25lcykNCiAgICAgICAgICAgICAgICAgICAgcmVzaXplTXV0YXRpb24gPSBudWxsOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZiAocmVzaXplTXV0YXRpb24pIHsNCiAgICAgICAgICAgICAgICAgICAgdmlldy5oaWRlRXZlbnRzV2l0aElkKHNlZy5mb290cHJpbnQuZXZlbnREZWYuaWQpOw0KICAgICAgICAgICAgICAgICAgICB2aWV3LnJlbmRlckV2ZW50UmVzaXplKGNvbXBvbmVudC5ldmVudFJhbmdlc1RvRXZlbnRGb290cHJpbnRzKG11dGF0ZWRFdmVudEluc3RhbmNlR3JvdXAuc2xpY2VSZW5kZXJSYW5nZXMoY29tcG9uZW50LmRhdGVQcm9maWxlLnJlbmRlclVuem9uZWRSYW5nZSwgY2FsZW5kYXIpKSwgc2VnKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgaGl0T3V0OiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgcmVzaXplTXV0YXRpb24gPSBudWxsOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGhpdERvbmU6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICB2aWV3LnVucmVuZGVyRXZlbnRSZXNpemUoc2VnKTsNCiAgICAgICAgICAgICAgICB2aWV3LnNob3dFdmVudHNXaXRoSWQoc2VnLmZvb3RwcmludC5ldmVudERlZi5pZCk7DQogICAgICAgICAgICAgICAgdXRpbF8xLmVuYWJsZUN1cnNvcigpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGludGVyYWN0aW9uRW5kOiBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgICAgICAgICBpZiAoaXNEcmFnZ2luZykgew0KICAgICAgICAgICAgICAgICAgICBfdGhpcy5zZWdSZXNpemVTdG9wKHNlZywgZXYpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZiAocmVzaXplTXV0YXRpb24pIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gbm8gbmVlZCB0byByZS1zaG93IG9yaWdpbmFsLCB3aWxsIHJlcmVuZGVyIGFsbCBhbnl3YXlzLiBlc3AgaW1wb3J0YW50IGlmIGV2ZW50UmVuZGVyV2FpdA0KICAgICAgICAgICAgICAgICAgICB2aWV3LnJlcG9ydEV2ZW50UmVzaXplKGV2ZW50SW5zdGFuY2UsIHJlc2l6ZU11dGF0aW9uLCBlbCwgZXYpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBfdGhpcy5kcmFnTGlzdGVuZXIgPSBudWxsOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuIGRyYWdMaXN0ZW5lcjsNCiAgICB9Ow0KICAgIC8vIENhbGxlZCBiZWZvcmUgZXZlbnQgc2VnbWVudCByZXNpemluZyBzdGFydHMNCiAgICBFdmVudFJlc2l6aW5nLnByb3RvdHlwZS5zZWdSZXNpemVTdGFydCA9IGZ1bmN0aW9uIChzZWcsIGV2KSB7DQogICAgICAgIHRoaXMuaXNSZXNpemluZyA9IHRydWU7DQogICAgICAgIHRoaXMuY29tcG9uZW50LnB1YmxpY2x5VHJpZ2dlcignZXZlbnRSZXNpemVTdGFydCcsIHsNCiAgICAgICAgICAgIGNvbnRleHQ6IHNlZy5lbFswXSwNCiAgICAgICAgICAgIGFyZ3M6IFsNCiAgICAgICAgICAgICAgICBzZWcuZm9vdHByaW50LmdldEV2ZW50TGVnYWN5KCksDQogICAgICAgICAgICAgICAgZXYsDQogICAgICAgICAgICAgICAge30sDQogICAgICAgICAgICAgICAgdGhpcy52aWV3DQogICAgICAgICAgICBdDQogICAgICAgIH0pOw0KICAgIH07DQogICAgLy8gQ2FsbGVkIGFmdGVyIGV2ZW50IHNlZ21lbnQgcmVzaXppbmcgc3RvcHMNCiAgICBFdmVudFJlc2l6aW5nLnByb3RvdHlwZS5zZWdSZXNpemVTdG9wID0gZnVuY3Rpb24gKHNlZywgZXYpIHsNCiAgICAgICAgdGhpcy5pc1Jlc2l6aW5nID0gZmFsc2U7DQogICAgICAgIHRoaXMuY29tcG9uZW50LnB1YmxpY2x5VHJpZ2dlcignZXZlbnRSZXNpemVTdG9wJywgew0KICAgICAgICAgICAgY29udGV4dDogc2VnLmVsWzBdLA0KICAgICAgICAgICAgYXJnczogWw0KICAgICAgICAgICAgICAgIHNlZy5mb290cHJpbnQuZ2V0RXZlbnRMZWdhY3koKSwNCiAgICAgICAgICAgICAgICBldiwNCiAgICAgICAgICAgICAgICB7fSwNCiAgICAgICAgICAgICAgICB0aGlzLnZpZXcNCiAgICAgICAgICAgIF0NCiAgICAgICAgfSk7DQogICAgfTsNCiAgICAvLyBSZXR1cm5zIG5ldyBkYXRlLWluZm9ybWF0aW9uIGZvciBhbiBldmVudCBzZWdtZW50IGJlaW5nIHJlc2l6ZWQgZnJvbSBpdHMgc3RhcnQNCiAgICBFdmVudFJlc2l6aW5nLnByb3RvdHlwZS5jb21wdXRlRXZlbnRTdGFydFJlc2l6ZU11dGF0aW9uID0gZnVuY3Rpb24gKHN0YXJ0Rm9vdHByaW50LCBlbmRGb290cHJpbnQsIG9yaWdFdmVudEZvb3RwcmludCkgew0KICAgICAgICB2YXIgb3JpZ1JhbmdlID0gb3JpZ0V2ZW50Rm9vdHByaW50LmNvbXBvbmVudEZvb3RwcmludC51bnpvbmVkUmFuZ2U7DQogICAgICAgIHZhciBzdGFydERlbHRhID0gdGhpcy5jb21wb25lbnQuZGlmZkRhdGVzKGVuZEZvb3RwcmludC51bnpvbmVkUmFuZ2UuZ2V0U3RhcnQoKSwgc3RhcnRGb290cHJpbnQudW56b25lZFJhbmdlLmdldFN0YXJ0KCkpOw0KICAgICAgICB2YXIgZGF0ZU11dGF0aW9uOw0KICAgICAgICB2YXIgZXZlbnREZWZNdXRhdGlvbjsNCiAgICAgICAgaWYgKG9yaWdSYW5nZS5nZXRTdGFydCgpLmFkZChzdGFydERlbHRhKSA8IG9yaWdSYW5nZS5nZXRFbmQoKSkgew0KICAgICAgICAgICAgZGF0ZU11dGF0aW9uID0gbmV3IEV2ZW50RGVmRGF0ZU11dGF0aW9uXzEuZGVmYXVsdCgpOw0KICAgICAgICAgICAgZGF0ZU11dGF0aW9uLnNldFN0YXJ0RGVsdGEoc3RhcnREZWx0YSk7DQogICAgICAgICAgICBldmVudERlZk11dGF0aW9uID0gbmV3IEV2ZW50RGVmTXV0YXRpb25fMS5kZWZhdWx0KCk7DQogICAgICAgICAgICBldmVudERlZk11dGF0aW9uLnNldERhdGVNdXRhdGlvbihkYXRlTXV0YXRpb24pOw0KICAgICAgICAgICAgcmV0dXJuIGV2ZW50RGVmTXV0YXRpb247DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH07DQogICAgLy8gUmV0dXJucyBuZXcgZGF0ZS1pbmZvcm1hdGlvbiBmb3IgYW4gZXZlbnQgc2VnbWVudCBiZWluZyByZXNpemVkIGZyb20gaXRzIGVuZA0KICAgIEV2ZW50UmVzaXppbmcucHJvdG90eXBlLmNvbXB1dGVFdmVudEVuZFJlc2l6ZU11dGF0aW9uID0gZnVuY3Rpb24gKHN0YXJ0Rm9vdHByaW50LCBlbmRGb290cHJpbnQsIG9yaWdFdmVudEZvb3RwcmludCkgew0KICAgICAgICB2YXIgb3JpZ1JhbmdlID0gb3JpZ0V2ZW50Rm9vdHByaW50LmNvbXBvbmVudEZvb3RwcmludC51bnpvbmVkUmFuZ2U7DQogICAgICAgIHZhciBlbmREZWx0YSA9IHRoaXMuY29tcG9uZW50LmRpZmZEYXRlcyhlbmRGb290cHJpbnQudW56b25lZFJhbmdlLmdldEVuZCgpLCBzdGFydEZvb3RwcmludC51bnpvbmVkUmFuZ2UuZ2V0RW5kKCkpOw0KICAgICAgICB2YXIgZGF0ZU11dGF0aW9uOw0KICAgICAgICB2YXIgZXZlbnREZWZNdXRhdGlvbjsNCiAgICAgICAgaWYgKG9yaWdSYW5nZS5nZXRFbmQoKS5hZGQoZW5kRGVsdGEpID4gb3JpZ1JhbmdlLmdldFN0YXJ0KCkpIHsNCiAgICAgICAgICAgIGRhdGVNdXRhdGlvbiA9IG5ldyBFdmVudERlZkRhdGVNdXRhdGlvbl8xLmRlZmF1bHQoKTsNCiAgICAgICAgICAgIGRhdGVNdXRhdGlvbi5zZXRFbmREZWx0YShlbmREZWx0YSk7DQogICAgICAgICAgICBldmVudERlZk11dGF0aW9uID0gbmV3IEV2ZW50RGVmTXV0YXRpb25fMS5kZWZhdWx0KCk7DQogICAgICAgICAgICBldmVudERlZk11dGF0aW9uLnNldERhdGVNdXRhdGlvbihkYXRlTXV0YXRpb24pOw0KICAgICAgICAgICAgcmV0dXJuIGV2ZW50RGVmTXV0YXRpb247DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH07DQogICAgcmV0dXJuIEV2ZW50UmVzaXppbmc7DQp9KEludGVyYWN0aW9uXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gRXZlbnRSZXNpemluZzsNCgoKLyoqKi8gfSksCi8qIDIyNCAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIHRzbGliXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIpOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgRXZlbnREZWZNdXRhdGlvbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzNik7DQp2YXIgRXZlbnREZWZEYXRlTXV0YXRpb25fMSA9IF9fd2VicGFja19yZXF1aXJlX18oNTApOw0KdmFyIERyYWdMaXN0ZW5lcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1NCk7DQp2YXIgSGl0RHJhZ0xpc3RlbmVyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIyKTsNCnZhciBNb3VzZUZvbGxvd2VyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI0NCk7DQp2YXIgR2xvYmFsRW1pdHRlcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNSk7DQp2YXIgSW50ZXJhY3Rpb25fMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTYpOw0KdmFyIEV2ZW50RHJhZ2dpbmcgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoRXZlbnREcmFnZ2luZywgX3N1cGVyKTsNCiAgICAvKg0KICAgIGNvbXBvbmVudCBpbXBsZW1lbnRzOg0KICAgICAgLSBiaW5kU2VnSGFuZGxlclRvRWwNCiAgICAgIC0gcHVibGljbHlUcmlnZ2VyDQogICAgICAtIGRpZmZEYXRlcw0KICAgICAgLSBldmVudFJhbmdlc1RvRXZlbnRGb290cHJpbnRzDQogICAgICAtIGlzRXZlbnRJbnN0YW5jZUdyb3VwQWxsb3dlZA0KICAgICovDQogICAgZnVuY3Rpb24gRXZlbnREcmFnZ2luZyhjb21wb25lbnQsIGV2ZW50UG9pbnRpbmcpIHsNCiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgY29tcG9uZW50KSB8fCB0aGlzOw0KICAgICAgICBfdGhpcy5pc0RyYWdnaW5nID0gZmFsc2U7DQogICAgICAgIF90aGlzLmV2ZW50UG9pbnRpbmcgPSBldmVudFBvaW50aW5nOw0KICAgICAgICByZXR1cm4gX3RoaXM7DQogICAgfQ0KICAgIEV2ZW50RHJhZ2dpbmcucHJvdG90eXBlLmVuZCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMuZHJhZ0xpc3RlbmVyKSB7DQogICAgICAgICAgICB0aGlzLmRyYWdMaXN0ZW5lci5lbmRJbnRlcmFjdGlvbigpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBFdmVudERyYWdnaW5nLnByb3RvdHlwZS5nZXRTZWxlY3Rpb25EZWxheSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIGRlbGF5ID0gdGhpcy5vcHQoJ2V2ZW50TG9uZ1ByZXNzRGVsYXknKTsNCiAgICAgICAgaWYgKGRlbGF5ID09IG51bGwpIHsNCiAgICAgICAgICAgIGRlbGF5ID0gdGhpcy5vcHQoJ2xvbmdQcmVzc0RlbGF5Jyk7IC8vIGZhbGxiYWNrDQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGRlbGF5Ow0KICAgIH07DQogICAgRXZlbnREcmFnZ2luZy5wcm90b3R5cGUuYmluZFRvRWwgPSBmdW5jdGlvbiAoZWwpIHsNCiAgICAgICAgdmFyIGNvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50Ow0KICAgICAgICBjb21wb25lbnQuYmluZFNlZ0hhbmRsZXJUb0VsKGVsLCAnbW91c2Vkb3duJywgdGhpcy5oYW5kbGVNb3VzZWRvd24uYmluZCh0aGlzKSk7DQogICAgICAgIGNvbXBvbmVudC5iaW5kU2VnSGFuZGxlclRvRWwoZWwsICd0b3VjaHN0YXJ0JywgdGhpcy5oYW5kbGVUb3VjaFN0YXJ0LmJpbmQodGhpcykpOw0KICAgIH07DQogICAgRXZlbnREcmFnZ2luZy5wcm90b3R5cGUuaGFuZGxlTW91c2Vkb3duID0gZnVuY3Rpb24gKHNlZywgZXYpIHsNCiAgICAgICAgaWYgKCFHbG9iYWxFbWl0dGVyXzEuZGVmYXVsdC5nZXQoKS5zaG91bGRJZ25vcmVNb3VzZSgpICYmIC8vIFRPRE86IG1vdmUgdG8gYSBkZWVwZXIgbGV2ZWwNCiAgICAgICAgICAgIHRoaXMuY29tcG9uZW50LmNhblN0YXJ0RHJhZyhzZWcsIGV2KSkgew0KICAgICAgICAgICAgdGhpcy5idWlsZERyYWdMaXN0ZW5lcihzZWcpLnN0YXJ0SW50ZXJhY3Rpb24oZXYsIHsgZGlzdGFuY2U6IDUgfSk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIEV2ZW50RHJhZ2dpbmcucHJvdG90eXBlLmhhbmRsZVRvdWNoU3RhcnQgPSBmdW5jdGlvbiAoc2VnLCBldikgew0KICAgICAgICB2YXIgY29tcG9uZW50ID0gdGhpcy5jb21wb25lbnQ7DQogICAgICAgIHZhciBzZXR0aW5ncyA9IHsNCiAgICAgICAgICAgIGRlbGF5OiB0aGlzLnZpZXcuaXNFdmVudERlZlNlbGVjdGVkKHNlZy5mb290cHJpbnQuZXZlbnREZWYpID8gLy8gYWxyZWFkeSBzZWxlY3RlZD8NCiAgICAgICAgICAgICAgICAwIDogdGhpcy5nZXRTZWxlY3Rpb25EZWxheSgpDQogICAgICAgIH07DQogICAgICAgIGlmICghR2xvYmFsRW1pdHRlcl8xLmRlZmF1bHQuZ2V0KCkuc2hvdWxkSWdub3JlTW91c2UoKSkgew0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudC5jYW5TdGFydERyYWcoc2VnLCBldikpIHsNCiAgICAgICAgICAgICAgICB0aGlzLmJ1aWxkRHJhZ0xpc3RlbmVyKHNlZykuc3RhcnRJbnRlcmFjdGlvbihldiwgc2V0dGluZ3MpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAoY29tcG9uZW50LmNhblN0YXJ0U2VsZWN0aW9uKHNlZywgZXYpKSB7DQogICAgICAgICAgICAgICAgdGhpcy5idWlsZFNlbGVjdExpc3RlbmVyKHNlZykuc3RhcnRJbnRlcmFjdGlvbihldiwgc2V0dGluZ3MpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBzZWcgaXNuJ3QgZHJhZ2dhYmxlLCBidXQgbGV0J3MgdXNlIGEgZ2VuZXJpYyBEcmFnTGlzdGVuZXINCiAgICAvLyBzaW1wbHkgZm9yIHRoZSBkZWxheSwgc28gaXQgY2FuIGJlIHNlbGVjdGVkLg0KICAgIC8vIEhhcyBzaWRlIGVmZmVjdCBvZiBzZXR0aW5nL3Vuc2V0dGluZyBgZHJhZ0xpc3RlbmVyYA0KICAgIEV2ZW50RHJhZ2dpbmcucHJvdG90eXBlLmJ1aWxkU2VsZWN0TGlzdGVuZXIgPSBmdW5jdGlvbiAoc2VnKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgIHZhciB2aWV3ID0gdGhpcy52aWV3Ow0KICAgICAgICB2YXIgZXZlbnREZWYgPSBzZWcuZm9vdHByaW50LmV2ZW50RGVmOw0KICAgICAgICB2YXIgZXZlbnRJbnN0YW5jZSA9IHNlZy5mb290cHJpbnQuZXZlbnRJbnN0YW5jZTsgLy8gbnVsbCBmb3IgaW52ZXJzZS1iYWNrZ3JvdW5kIGV2ZW50cw0KICAgICAgICBpZiAodGhpcy5kcmFnTGlzdGVuZXIpIHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLmRyYWdMaXN0ZW5lcjsNCiAgICAgICAgfQ0KICAgICAgICB2YXIgZHJhZ0xpc3RlbmVyID0gdGhpcy5kcmFnTGlzdGVuZXIgPSBuZXcgRHJhZ0xpc3RlbmVyXzEuZGVmYXVsdCh7DQogICAgICAgICAgICBkcmFnU3RhcnQ6IGZ1bmN0aW9uIChldikgew0KICAgICAgICAgICAgICAgIGlmIChkcmFnTGlzdGVuZXIuaXNUb3VjaCAmJg0KICAgICAgICAgICAgICAgICAgICAhdmlldy5pc0V2ZW50RGVmU2VsZWN0ZWQoZXZlbnREZWYpICYmDQogICAgICAgICAgICAgICAgICAgIGV2ZW50SW5zdGFuY2UpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgbm90IHByZXZpb3VzbHkgc2VsZWN0ZWQsIHdpbGwgZmlyZSBhZnRlciBhIGRlbGF5LiB0aGVuLCBzZWxlY3QgdGhlIGV2ZW50DQogICAgICAgICAgICAgICAgICAgIHZpZXcuc2VsZWN0RXZlbnRJbnN0YW5jZShldmVudEluc3RhbmNlKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgaW50ZXJhY3Rpb25FbmQ6IGZ1bmN0aW9uIChldikgew0KICAgICAgICAgICAgICAgIF90aGlzLmRyYWdMaXN0ZW5lciA9IG51bGw7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgICByZXR1cm4gZHJhZ0xpc3RlbmVyOw0KICAgIH07DQogICAgLy8gQnVpbGRzIGEgbGlzdGVuZXIgdGhhdCB3aWxsIHRyYWNrIHVzZXItZHJhZ2dpbmcgb24gYW4gZXZlbnQgc2VnbWVudC4NCiAgICAvLyBHZW5lcmljIGVub3VnaCB0byB3b3JrIHdpdGggYW55IHR5cGUgb2YgR3JpZC4NCiAgICAvLyBIYXMgc2lkZSBlZmZlY3Qgb2Ygc2V0dGluZy91bnNldHRpbmcgYGRyYWdMaXN0ZW5lcmANCiAgICBFdmVudERyYWdnaW5nLnByb3RvdHlwZS5idWlsZERyYWdMaXN0ZW5lciA9IGZ1bmN0aW9uIChzZWcpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgdmFyIGNvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50Ow0KICAgICAgICB2YXIgdmlldyA9IHRoaXMudmlldzsNCiAgICAgICAgdmFyIGNhbGVuZGFyID0gdmlldy5jYWxlbmRhcjsNCiAgICAgICAgdmFyIGV2ZW50TWFuYWdlciA9IGNhbGVuZGFyLmV2ZW50TWFuYWdlcjsNCiAgICAgICAgdmFyIGVsID0gc2VnLmVsOw0KICAgICAgICB2YXIgZXZlbnREZWYgPSBzZWcuZm9vdHByaW50LmV2ZW50RGVmOw0KICAgICAgICB2YXIgZXZlbnRJbnN0YW5jZSA9IHNlZy5mb290cHJpbnQuZXZlbnRJbnN0YW5jZTsgLy8gbnVsbCBmb3IgaW52ZXJzZS1iYWNrZ3JvdW5kIGV2ZW50cw0KICAgICAgICB2YXIgaXNEcmFnZ2luZzsNCiAgICAgICAgdmFyIG1vdXNlRm9sbG93ZXI7IC8vIEEgY2xvbmUgb2YgdGhlIG9yaWdpbmFsIGVsZW1lbnQgdGhhdCB3aWxsIG1vdmUgd2l0aCB0aGUgbW91c2UNCiAgICAgICAgdmFyIGV2ZW50RGVmTXV0YXRpb247DQogICAgICAgIGlmICh0aGlzLmRyYWdMaXN0ZW5lcikgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuZHJhZ0xpc3RlbmVyOw0KICAgICAgICB9DQogICAgICAgIC8vIFRyYWNrcyBtb3VzZSBtb3ZlbWVudCBvdmVyIHRoZSAqdmlldydzKiBjb29yZGluYXRlIG1hcC4gQWxsb3dzIGRyYWdnaW5nIGFuZCBkcm9wcGluZyBiZXR3ZWVuIHN1YmNvbXBvbmVudHMNCiAgICAgICAgLy8gb2YgdGhlIHZpZXcuDQogICAgICAgIHZhciBkcmFnTGlzdGVuZXIgPSB0aGlzLmRyYWdMaXN0ZW5lciA9IG5ldyBIaXREcmFnTGlzdGVuZXJfMS5kZWZhdWx0KHZpZXcsIHsNCiAgICAgICAgICAgIHNjcm9sbDogdGhpcy5vcHQoJ2RyYWdTY3JvbGwnKSwNCiAgICAgICAgICAgIHN1YmplY3RFbDogZWwsDQogICAgICAgICAgICBzdWJqZWN0Q2VudGVyOiB0cnVlLA0KICAgICAgICAgICAgaW50ZXJhY3Rpb25TdGFydDogZnVuY3Rpb24gKGV2KSB7DQogICAgICAgICAgICAgICAgc2VnLmNvbXBvbmVudCA9IGNvbXBvbmVudDsgLy8gZm9yIHJlbmRlckRyYWcNCiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gZmFsc2U7DQogICAgICAgICAgICAgICAgbW91c2VGb2xsb3dlciA9IG5ldyBNb3VzZUZvbGxvd2VyXzEuZGVmYXVsdChzZWcuZWwsIHsNCiAgICAgICAgICAgICAgICAgICAgYWRkaXRpb25hbENsYXNzOiAnZmMtZHJhZ2dpbmcnLA0KICAgICAgICAgICAgICAgICAgICBwYXJlbnRFbDogdmlldy5lbCwNCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogZHJhZ0xpc3RlbmVyLmlzVG91Y2ggPyBudWxsIDogX3RoaXMub3B0KCdkcmFnT3BhY2l0eScpLA0KICAgICAgICAgICAgICAgICAgICByZXZlcnREdXJhdGlvbjogX3RoaXMub3B0KCdkcmFnUmV2ZXJ0RHVyYXRpb24nKSwNCiAgICAgICAgICAgICAgICAgICAgekluZGV4OiAyIC8vIG9uZSBhYm92ZSB0aGUgLmZjLXZpZXcNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICBtb3VzZUZvbGxvd2VyLmhpZGUoKTsgLy8gZG9uJ3Qgc2hvdyB1bnRpbCB3ZSBrbm93IHRoaXMgaXMgYSByZWFsIGRyYWcNCiAgICAgICAgICAgICAgICBtb3VzZUZvbGxvd2VyLnN0YXJ0KGV2KTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBkcmFnU3RhcnQ6IGZ1bmN0aW9uIChldikgew0KICAgICAgICAgICAgICAgIGlmIChkcmFnTGlzdGVuZXIuaXNUb3VjaCAmJg0KICAgICAgICAgICAgICAgICAgICAhdmlldy5pc0V2ZW50RGVmU2VsZWN0ZWQoZXZlbnREZWYpICYmDQogICAgICAgICAgICAgICAgICAgIGV2ZW50SW5zdGFuY2UpIHsNCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgbm90IHByZXZpb3VzbHkgc2VsZWN0ZWQsIHdpbGwgZmlyZSBhZnRlciBhIGRlbGF5LiB0aGVuLCBzZWxlY3QgdGhlIGV2ZW50DQogICAgICAgICAgICAgICAgICAgIHZpZXcuc2VsZWN0RXZlbnRJbnN0YW5jZShldmVudEluc3RhbmNlKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaXNEcmFnZ2luZyA9IHRydWU7DQogICAgICAgICAgICAgICAgLy8gZW5zdXJlIGEgbW91c2VvdXQgb24gdGhlIG1hbmlwdWxhdGVkIGV2ZW50IGhhcyBiZWVuIHJlcG9ydGVkDQogICAgICAgICAgICAgICAgX3RoaXMuZXZlbnRQb2ludGluZy5oYW5kbGVNb3VzZW91dChzZWcsIGV2KTsNCiAgICAgICAgICAgICAgICBfdGhpcy5zZWdEcmFnU3RhcnQoc2VnLCBldik7DQogICAgICAgICAgICAgICAgdmlldy5oaWRlRXZlbnRzV2l0aElkKHNlZy5mb290cHJpbnQuZXZlbnREZWYuaWQpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGhpdE92ZXI6IGZ1bmN0aW9uIChoaXQsIGlzT3JpZywgb3JpZ0hpdCkgew0KICAgICAgICAgICAgICAgIHZhciBpc0FsbG93ZWQgPSB0cnVlOw0KICAgICAgICAgICAgICAgIHZhciBvcmlnRm9vdHByaW50Ow0KICAgICAgICAgICAgICAgIHZhciBmb290cHJpbnQ7DQogICAgICAgICAgICAgICAgdmFyIG11dGF0ZWRFdmVudEluc3RhbmNlR3JvdXA7DQogICAgICAgICAgICAgICAgLy8gc3RhcnRpbmcgaGl0IGNvdWxkIGJlIGZvcmNlZCAoRGF5R3JpZC5saW1pdCkNCiAgICAgICAgICAgICAgICBpZiAoc2VnLmhpdCkgew0KICAgICAgICAgICAgICAgICAgICBvcmlnSGl0ID0gc2VnLmhpdDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgLy8gaGl0IG1pZ2h0IG5vdCBiZWxvbmcgdG8gdGhpcyBncmlkLCBzbyBxdWVyeSBvcmlnaW4gZ3JpZA0KICAgICAgICAgICAgICAgIG9yaWdGb290cHJpbnQgPSBvcmlnSGl0LmNvbXBvbmVudC5nZXRTYWZlSGl0Rm9vdHByaW50KG9yaWdIaXQpOw0KICAgICAgICAgICAgICAgIGZvb3RwcmludCA9IGhpdC5jb21wb25lbnQuZ2V0U2FmZUhpdEZvb3RwcmludChoaXQpOw0KICAgICAgICAgICAgICAgIGlmIChvcmlnRm9vdHByaW50ICYmIGZvb3RwcmludCkgew0KICAgICAgICAgICAgICAgICAgICBldmVudERlZk11dGF0aW9uID0gX3RoaXMuY29tcHV0ZUV2ZW50RHJvcE11dGF0aW9uKG9yaWdGb290cHJpbnQsIGZvb3RwcmludCwgZXZlbnREZWYpOw0KICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnREZWZNdXRhdGlvbikgew0KICAgICAgICAgICAgICAgICAgICAgICAgbXV0YXRlZEV2ZW50SW5zdGFuY2VHcm91cCA9IGV2ZW50TWFuYWdlci5idWlsZE11dGF0ZWRFdmVudEluc3RhbmNlR3JvdXAoZXZlbnREZWYuaWQsIGV2ZW50RGVmTXV0YXRpb24pOw0KICAgICAgICAgICAgICAgICAgICAgICAgaXNBbGxvd2VkID0gY29tcG9uZW50LmlzRXZlbnRJbnN0YW5jZUdyb3VwQWxsb3dlZChtdXRhdGVkRXZlbnRJbnN0YW5jZUdyb3VwKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlzQWxsb3dlZCA9IGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBpc0FsbG93ZWQgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgaWYgKCFpc0FsbG93ZWQpIHsNCiAgICAgICAgICAgICAgICAgICAgZXZlbnREZWZNdXRhdGlvbiA9IG51bGw7DQogICAgICAgICAgICAgICAgICAgIHV0aWxfMS5kaXNhYmxlQ3Vyc29yKCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIC8vIGlmIGEgdmFsaWQgZHJvcCBsb2NhdGlvbiwgaGF2ZSB0aGUgc3ViY2xhc3MgcmVuZGVyIGEgdmlzdWFsIGluZGljYXRpb24NCiAgICAgICAgICAgICAgICBpZiAoZXZlbnREZWZNdXRhdGlvbiAmJg0KICAgICAgICAgICAgICAgICAgICB2aWV3LnJlbmRlckRyYWcoLy8gdHJ1dGh5IGlmIHJlbmRlcmVkIHNvbWV0aGluZw0KICAgICAgICAgICAgICAgICAgICBjb21wb25lbnQuZXZlbnRSYW5nZXNUb0V2ZW50Rm9vdHByaW50cyhtdXRhdGVkRXZlbnRJbnN0YW5jZUdyb3VwLnNsaWNlUmVuZGVyUmFuZ2VzKGNvbXBvbmVudC5kYXRlUHJvZmlsZS5yZW5kZXJVbnpvbmVkUmFuZ2UsIGNhbGVuZGFyKSksIHNlZywgZHJhZ0xpc3RlbmVyLmlzVG91Y2gpKSB7DQogICAgICAgICAgICAgICAgICAgIG1vdXNlRm9sbG93ZXIuaGlkZSgpOyAvLyBpZiB0aGUgc3ViY2xhc3MgaXMgYWxyZWFkeSB1c2luZyBhIG1vY2sgZXZlbnQgImhlbHBlciIsIGhpZGUgb3VyIG93bg0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgbW91c2VGb2xsb3dlci5zaG93KCk7IC8vIG90aGVyd2lzZSwgaGF2ZSB0aGUgaGVscGVyIGZvbGxvdyB0aGUgbW91c2UgKG5vIHNuYXBwaW5nKQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZiAoaXNPcmlnKSB7DQogICAgICAgICAgICAgICAgICAgIC8vIG5lZWRzIHRvIGhhdmUgbW92ZWQgaGl0cyB0byBiZSBhIHZhbGlkIGRyb3ANCiAgICAgICAgICAgICAgICAgICAgZXZlbnREZWZNdXRhdGlvbiA9IG51bGw7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGhpdE91dDogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIHZpZXcudW5yZW5kZXJEcmFnKHNlZyk7IC8vIHVucmVuZGVyIHdoYXRldmVyIHdhcyBkb25lIGluIHJlbmRlckRyYWcNCiAgICAgICAgICAgICAgICBtb3VzZUZvbGxvd2VyLnNob3coKTsgLy8gc2hvdyBpbiBjYXNlIHdlIGFyZSBtb3Zpbmcgb3V0IG9mIGFsbCBoaXRzDQogICAgICAgICAgICAgICAgZXZlbnREZWZNdXRhdGlvbiA9IG51bGw7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgaGl0RG9uZTogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIHV0aWxfMS5lbmFibGVDdXJzb3IoKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBpbnRlcmFjdGlvbkVuZDogZnVuY3Rpb24gKGV2KSB7DQogICAgICAgICAgICAgICAgZGVsZXRlIHNlZy5jb21wb25lbnQ7IC8vIHByZXZlbnQgc2lkZSBlZmZlY3RzDQogICAgICAgICAgICAgICAgLy8gZG8gcmV2ZXJ0IGFuaW1hdGlvbiBpZiBoYXNuJ3QgY2hhbmdlZC4gY2FsbHMgYSBjYWxsYmFjayB3aGVuIGZpbmlzaGVkICh3aGV0aGVyIGFuaW1hdGlvbiBvciBub3QpDQogICAgICAgICAgICAgICAgbW91c2VGb2xsb3dlci5zdG9wKCFldmVudERlZk11dGF0aW9uLCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgIGlmIChpc0RyYWdnaW5nKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB2aWV3LnVucmVuZGVyRHJhZyhzZWcpOw0KICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2VnRHJhZ1N0b3Aoc2VnLCBldik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgdmlldy5zaG93RXZlbnRzV2l0aElkKHNlZy5mb290cHJpbnQuZXZlbnREZWYuaWQpOw0KICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnREZWZNdXRhdGlvbikgew0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm8gbmVlZCB0byByZS1zaG93IG9yaWdpbmFsLCB3aWxsIHJlcmVuZGVyIGFsbCBhbnl3YXlzLiBlc3AgaW1wb3J0YW50IGlmIGV2ZW50UmVuZGVyV2FpdA0KICAgICAgICAgICAgICAgICAgICAgICAgdmlldy5yZXBvcnRFdmVudERyb3AoZXZlbnRJbnN0YW5jZSwgZXZlbnREZWZNdXRhdGlvbiwgZWwsIGV2KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIF90aGlzLmRyYWdMaXN0ZW5lciA9IG51bGw7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgICByZXR1cm4gZHJhZ0xpc3RlbmVyOw0KICAgIH07DQogICAgLy8gQ2FsbGVkIGJlZm9yZSBldmVudCBzZWdtZW50IGRyYWdnaW5nIHN0YXJ0cw0KICAgIEV2ZW50RHJhZ2dpbmcucHJvdG90eXBlLnNlZ0RyYWdTdGFydCA9IGZ1bmN0aW9uIChzZWcsIGV2KSB7DQogICAgICAgIHRoaXMuaXNEcmFnZ2luZyA9IHRydWU7DQogICAgICAgIHRoaXMuY29tcG9uZW50LnB1YmxpY2x5VHJpZ2dlcignZXZlbnREcmFnU3RhcnQnLCB7DQogICAgICAgICAgICBjb250ZXh0OiBzZWcuZWxbMF0sDQogICAgICAgICAgICBhcmdzOiBbDQogICAgICAgICAgICAgICAgc2VnLmZvb3RwcmludC5nZXRFdmVudExlZ2FjeSgpLA0KICAgICAgICAgICAgICAgIGV2LA0KICAgICAgICAgICAgICAgIHt9LA0KICAgICAgICAgICAgICAgIHRoaXMudmlldw0KICAgICAgICAgICAgXQ0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIC8vIENhbGxlZCBhZnRlciBldmVudCBzZWdtZW50IGRyYWdnaW5nIHN0b3BzDQogICAgRXZlbnREcmFnZ2luZy5wcm90b3R5cGUuc2VnRHJhZ1N0b3AgPSBmdW5jdGlvbiAoc2VnLCBldikgew0KICAgICAgICB0aGlzLmlzRHJhZ2dpbmcgPSBmYWxzZTsNCiAgICAgICAgdGhpcy5jb21wb25lbnQucHVibGljbHlUcmlnZ2VyKCdldmVudERyYWdTdG9wJywgew0KICAgICAgICAgICAgY29udGV4dDogc2VnLmVsWzBdLA0KICAgICAgICAgICAgYXJnczogWw0KICAgICAgICAgICAgICAgIHNlZy5mb290cHJpbnQuZ2V0RXZlbnRMZWdhY3koKSwNCiAgICAgICAgICAgICAgICBldiwNCiAgICAgICAgICAgICAgICB7fSwNCiAgICAgICAgICAgICAgICB0aGlzLnZpZXcNCiAgICAgICAgICAgIF0NCiAgICAgICAgfSk7DQogICAgfTsNCiAgICAvLyBET0VTIE5PVCBjb25zaWRlciBvdmVybGFwL2NvbnN0cmFpbnQNCiAgICBFdmVudERyYWdnaW5nLnByb3RvdHlwZS5jb21wdXRlRXZlbnREcm9wTXV0YXRpb24gPSBmdW5jdGlvbiAoc3RhcnRGb290cHJpbnQsIGVuZEZvb3RwcmludCwgZXZlbnREZWYpIHsNCiAgICAgICAgdmFyIGV2ZW50RGVmTXV0YXRpb24gPSBuZXcgRXZlbnREZWZNdXRhdGlvbl8xLmRlZmF1bHQoKTsNCiAgICAgICAgZXZlbnREZWZNdXRhdGlvbi5zZXREYXRlTXV0YXRpb24odGhpcy5jb21wdXRlRXZlbnREYXRlTXV0YXRpb24oc3RhcnRGb290cHJpbnQsIGVuZEZvb3RwcmludCkpOw0KICAgICAgICByZXR1cm4gZXZlbnREZWZNdXRhdGlvbjsNCiAgICB9Ow0KICAgIEV2ZW50RHJhZ2dpbmcucHJvdG90eXBlLmNvbXB1dGVFdmVudERhdGVNdXRhdGlvbiA9IGZ1bmN0aW9uIChzdGFydEZvb3RwcmludCwgZW5kRm9vdHByaW50KSB7DQogICAgICAgIHZhciBkYXRlMCA9IHN0YXJ0Rm9vdHByaW50LnVuem9uZWRSYW5nZS5nZXRTdGFydCgpOw0KICAgICAgICB2YXIgZGF0ZTEgPSBlbmRGb290cHJpbnQudW56b25lZFJhbmdlLmdldFN0YXJ0KCk7DQogICAgICAgIHZhciBjbGVhckVuZCA9IGZhbHNlOw0KICAgICAgICB2YXIgZm9yY2VUaW1lZCA9IGZhbHNlOw0KICAgICAgICB2YXIgZm9yY2VBbGxEYXkgPSBmYWxzZTsNCiAgICAgICAgdmFyIGRhdGVEZWx0YTsNCiAgICAgICAgdmFyIGRhdGVNdXRhdGlvbjsNCiAgICAgICAgaWYgKHN0YXJ0Rm9vdHByaW50LmlzQWxsRGF5ICE9PSBlbmRGb290cHJpbnQuaXNBbGxEYXkpIHsNCiAgICAgICAgICAgIGNsZWFyRW5kID0gdHJ1ZTsNCiAgICAgICAgICAgIGlmIChlbmRGb290cHJpbnQuaXNBbGxEYXkpIHsNCiAgICAgICAgICAgICAgICBmb3JjZUFsbERheSA9IHRydWU7DQogICAgICAgICAgICAgICAgZGF0ZTAuc3RyaXBUaW1lKCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICBmb3JjZVRpbWVkID0gdHJ1ZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBkYXRlRGVsdGEgPSB0aGlzLmNvbXBvbmVudC5kaWZmRGF0ZXMoZGF0ZTEsIGRhdGUwKTsNCiAgICAgICAgZGF0ZU11dGF0aW9uID0gbmV3IEV2ZW50RGVmRGF0ZU11dGF0aW9uXzEuZGVmYXVsdCgpOw0KICAgICAgICBkYXRlTXV0YXRpb24uY2xlYXJFbmQgPSBjbGVhckVuZDsNCiAgICAgICAgZGF0ZU11dGF0aW9uLmZvcmNlVGltZWQgPSBmb3JjZVRpbWVkOw0KICAgICAgICBkYXRlTXV0YXRpb24uZm9yY2VBbGxEYXkgPSBmb3JjZUFsbERheTsNCiAgICAgICAgZGF0ZU11dGF0aW9uLnNldERhdGVEZWx0YShkYXRlRGVsdGEpOw0KICAgICAgICByZXR1cm4gZGF0ZU11dGF0aW9uOw0KICAgIH07DQogICAgcmV0dXJuIEV2ZW50RHJhZ2dpbmc7DQp9KEludGVyYWN0aW9uXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gRXZlbnREcmFnZ2luZzsNCgoKLyoqKi8gfSksCi8qIDIyNSAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIHRzbGliXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIpOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgSGl0RHJhZ0xpc3RlbmVyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIyKTsNCnZhciBDb21wb25lbnRGb290cHJpbnRfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTIpOw0KdmFyIFVuem9uZWRSYW5nZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1KTsNCnZhciBJbnRlcmFjdGlvbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNik7DQp2YXIgRGF0ZVNlbGVjdGluZyA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHsNCiAgICB0c2xpYl8xLl9fZXh0ZW5kcyhEYXRlU2VsZWN0aW5nLCBfc3VwZXIpOw0KICAgIC8qDQogICAgY29tcG9uZW50IG11c3QgaW1wbGVtZW50Og0KICAgICAgLSBiaW5kRGF0ZUhhbmRsZXJUb0VsDQogICAgICAtIGdldFNhZmVIaXRGb290cHJpbnQNCiAgICAgIC0gcmVuZGVySGlnaGxpZ2h0DQogICAgICAtIHVucmVuZGVySGlnaGxpZ2h0DQogICAgKi8NCiAgICBmdW5jdGlvbiBEYXRlU2VsZWN0aW5nKGNvbXBvbmVudCkgew0KICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzLCBjb21wb25lbnQpIHx8IHRoaXM7DQogICAgICAgIF90aGlzLmRyYWdMaXN0ZW5lciA9IF90aGlzLmJ1aWxkRHJhZ0xpc3RlbmVyKCk7DQogICAgICAgIHJldHVybiBfdGhpczsNCiAgICB9DQogICAgRGF0ZVNlbGVjdGluZy5wcm90b3R5cGUuZW5kID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLmRyYWdMaXN0ZW5lci5lbmRJbnRlcmFjdGlvbigpOw0KICAgIH07DQogICAgRGF0ZVNlbGVjdGluZy5wcm90b3R5cGUuZ2V0RGVsYXkgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBkZWxheSA9IHRoaXMub3B0KCdzZWxlY3RMb25nUHJlc3NEZWxheScpOw0KICAgICAgICBpZiAoZGVsYXkgPT0gbnVsbCkgew0KICAgICAgICAgICAgZGVsYXkgPSB0aGlzLm9wdCgnbG9uZ1ByZXNzRGVsYXknKTsgLy8gZmFsbGJhY2sNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZGVsYXk7DQogICAgfTsNCiAgICBEYXRlU2VsZWN0aW5nLnByb3RvdHlwZS5iaW5kVG9FbCA9IGZ1bmN0aW9uIChlbCkgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICB2YXIgY29tcG9uZW50ID0gdGhpcy5jb21wb25lbnQ7DQogICAgICAgIHZhciBkcmFnTGlzdGVuZXIgPSB0aGlzLmRyYWdMaXN0ZW5lcjsNCiAgICAgICAgY29tcG9uZW50LmJpbmREYXRlSGFuZGxlclRvRWwoZWwsICdtb3VzZWRvd24nLCBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgICAgIGlmIChfdGhpcy5vcHQoJ3NlbGVjdGFibGUnKSAmJiAhY29tcG9uZW50LnNob3VsZElnbm9yZU1vdXNlKCkpIHsNCiAgICAgICAgICAgICAgICBkcmFnTGlzdGVuZXIuc3RhcnRJbnRlcmFjdGlvbihldiwgew0KICAgICAgICAgICAgICAgICAgICBkaXN0YW5jZTogX3RoaXMub3B0KCdzZWxlY3RNaW5EaXN0YW5jZScpDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgICBjb21wb25lbnQuYmluZERhdGVIYW5kbGVyVG9FbChlbCwgJ3RvdWNoc3RhcnQnLCBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgICAgIGlmIChfdGhpcy5vcHQoJ3NlbGVjdGFibGUnKSAmJiAhY29tcG9uZW50LnNob3VsZElnbm9yZVRvdWNoKCkpIHsNCiAgICAgICAgICAgICAgICBkcmFnTGlzdGVuZXIuc3RhcnRJbnRlcmFjdGlvbihldiwgew0KICAgICAgICAgICAgICAgICAgICBkZWxheTogX3RoaXMuZ2V0RGVsYXkoKQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgdXRpbF8xLnByZXZlbnRTZWxlY3Rpb24oZWwpOw0KICAgIH07DQogICAgLy8gQ3JlYXRlcyBhIGxpc3RlbmVyIHRoYXQgdHJhY2tzIHRoZSB1c2VyJ3MgZHJhZyBhY3Jvc3MgZGF5IGVsZW1lbnRzLCBmb3IgZGF5IHNlbGVjdGluZy4NCiAgICBEYXRlU2VsZWN0aW5nLnByb3RvdHlwZS5idWlsZERyYWdMaXN0ZW5lciA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgdmFyIGNvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50Ow0KICAgICAgICB2YXIgc2VsZWN0aW9uRm9vdHByaW50OyAvLyBudWxsIGlmIGludmFsaWQgc2VsZWN0aW9uDQogICAgICAgIHZhciBkcmFnTGlzdGVuZXIgPSBuZXcgSGl0RHJhZ0xpc3RlbmVyXzEuZGVmYXVsdChjb21wb25lbnQsIHsNCiAgICAgICAgICAgIHNjcm9sbDogdGhpcy5vcHQoJ2RyYWdTY3JvbGwnKSwNCiAgICAgICAgICAgIGludGVyYWN0aW9uU3RhcnQ6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICBzZWxlY3Rpb25Gb290cHJpbnQgPSBudWxsOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGRyYWdTdGFydDogZnVuY3Rpb24gKGV2KSB7DQogICAgICAgICAgICAgICAgX3RoaXMudmlldy51bnNlbGVjdChldik7IC8vIHNpbmNlIHdlIGNvdWxkIGJlIHJlbmRlcmluZyBhIG5ldyBzZWxlY3Rpb24sIHdlIHdhbnQgdG8gY2xlYXIgYW55IG9sZCBvbmUNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBoaXRPdmVyOiBmdW5jdGlvbiAoaGl0LCBpc09yaWcsIG9yaWdIaXQpIHsNCiAgICAgICAgICAgICAgICB2YXIgb3JpZ0hpdEZvb3RwcmludDsNCiAgICAgICAgICAgICAgICB2YXIgaGl0Rm9vdHByaW50Ow0KICAgICAgICAgICAgICAgIGlmIChvcmlnSGl0KSB7DQogICAgICAgICAgICAgICAgICAgIG9yaWdIaXRGb290cHJpbnQgPSBjb21wb25lbnQuZ2V0U2FmZUhpdEZvb3RwcmludChvcmlnSGl0KTsNCiAgICAgICAgICAgICAgICAgICAgaGl0Rm9vdHByaW50ID0gY29tcG9uZW50LmdldFNhZmVIaXRGb290cHJpbnQoaGl0KTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKG9yaWdIaXRGb290cHJpbnQgJiYgaGl0Rm9vdHByaW50KSB7DQogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb25Gb290cHJpbnQgPSBfdGhpcy5jb21wdXRlU2VsZWN0aW9uKG9yaWdIaXRGb290cHJpbnQsIGhpdEZvb3RwcmludCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb25Gb290cHJpbnQgPSBudWxsOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rpb25Gb290cHJpbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC5yZW5kZXJTZWxlY3Rpb25Gb290cHJpbnQoc2VsZWN0aW9uRm9vdHByaW50KTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChzZWxlY3Rpb25Gb290cHJpbnQgPT09IGZhbHNlKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB1dGlsXzEuZGlzYWJsZUN1cnNvcigpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGhpdE91dDogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIHNlbGVjdGlvbkZvb3RwcmludCA9IG51bGw7DQogICAgICAgICAgICAgICAgY29tcG9uZW50LnVucmVuZGVyU2VsZWN0aW9uKCk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgaGl0RG9uZTogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIHV0aWxfMS5lbmFibGVDdXJzb3IoKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBpbnRlcmFjdGlvbkVuZDogZnVuY3Rpb24gKGV2LCBpc0NhbmNlbGxlZCkgew0KICAgICAgICAgICAgICAgIGlmICghaXNDYW5jZWxsZWQgJiYgc2VsZWN0aW9uRm9vdHByaW50KSB7DQogICAgICAgICAgICAgICAgICAgIC8vIHRoZSBzZWxlY3Rpb24gd2lsbCBhbHJlYWR5IGhhdmUgYmVlbiByZW5kZXJlZC4ganVzdCByZXBvcnQgaXQNCiAgICAgICAgICAgICAgICAgICAgX3RoaXMudmlldy5yZXBvcnRTZWxlY3Rpb24oc2VsZWN0aW9uRm9vdHByaW50LCBldik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuIGRyYWdMaXN0ZW5lcjsNCiAgICB9Ow0KICAgIC8vIEdpdmVuIHRoZSBmaXJzdCBhbmQgbGFzdCBkYXRlLXNwYW5zIG9mIGEgc2VsZWN0aW9uLCByZXR1cm5zIGFub3RoZXIgZGF0ZS1zcGFuIG9iamVjdC4NCiAgICAvLyBTdWJjbGFzc2VzIGNhbiBvdmVycmlkZSBhbmQgcHJvdmlkZSBhZGRpdGlvbmFsIGRhdGEgaW4gdGhlIHNwYW4gb2JqZWN0LiBXaWxsIGJlIHBhc3NlZCB0byByZW5kZXJTZWxlY3Rpb25Gb290cHJpbnQoKS4NCiAgICAvLyBXaWxsIHJldHVybiBmYWxzZSBpZiB0aGUgc2VsZWN0aW9uIGlzIGludmFsaWQgYW5kIHRoaXMgc2hvdWxkIGJlIGluZGljYXRlZCB0byB0aGUgdXNlci4NCiAgICAvLyBXaWxsIHJldHVybiBudWxsL3VuZGVmaW5lZCBpZiBhIHNlbGVjdGlvbiBpbnZhbGlkIGJ1dCBubyBlcnJvciBzaG91bGQgYmUgcmVwb3J0ZWQuDQogICAgRGF0ZVNlbGVjdGluZy5wcm90b3R5cGUuY29tcHV0ZVNlbGVjdGlvbiA9IGZ1bmN0aW9uIChmb290cHJpbnQwLCBmb290cHJpbnQxKSB7DQogICAgICAgIHZhciB3aG9sZUZvb3RwcmludCA9IHRoaXMuY29tcHV0ZVNlbGVjdGlvbkZvb3RwcmludChmb290cHJpbnQwLCBmb290cHJpbnQxKTsNCiAgICAgICAgaWYgKHdob2xlRm9vdHByaW50ICYmICF0aGlzLmlzU2VsZWN0aW9uRm9vdHByaW50QWxsb3dlZCh3aG9sZUZvb3RwcmludCkpIHsNCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gd2hvbGVGb290cHJpbnQ7DQogICAgfTsNCiAgICAvLyBHaXZlbiB0d28gc3BhbnMsIG11c3QgcmV0dXJuIHRoZSBjb21iaW5hdGlvbiBvZiB0aGUgdHdvLg0KICAgIC8vIFRPRE86IGRvIHRoaXMgc2VwYXJhdGlvbiBvZiBjb25jZXJucyAoY29tYmluaW5nIFZTIHZhbGlkYXRpb24pIGZvciBldmVudCBkbmQvcmVzaXplIHRvby4NCiAgICAvLyBBc3N1bWVzIGJvdGggZm9vdHByaW50cyBhcmUgbm9uLW9wZW4tZW5kZWQuDQogICAgRGF0ZVNlbGVjdGluZy5wcm90b3R5cGUuY29tcHV0ZVNlbGVjdGlvbkZvb3RwcmludCA9IGZ1bmN0aW9uIChmb290cHJpbnQwLCBmb290cHJpbnQxKSB7DQogICAgICAgIHZhciBtcyA9IFsNCiAgICAgICAgICAgIGZvb3RwcmludDAudW56b25lZFJhbmdlLnN0YXJ0TXMsDQogICAgICAgICAgICBmb290cHJpbnQwLnVuem9uZWRSYW5nZS5lbmRNcywNCiAgICAgICAgICAgIGZvb3RwcmludDEudW56b25lZFJhbmdlLnN0YXJ0TXMsDQogICAgICAgICAgICBmb290cHJpbnQxLnVuem9uZWRSYW5nZS5lbmRNcw0KICAgICAgICBdOw0KICAgICAgICBtcy5zb3J0KHV0aWxfMS5jb21wYXJlTnVtYmVycyk7DQogICAgICAgIHJldHVybiBuZXcgQ29tcG9uZW50Rm9vdHByaW50XzEuZGVmYXVsdChuZXcgVW56b25lZFJhbmdlXzEuZGVmYXVsdChtc1swXSwgbXNbM10pLCBmb290cHJpbnQwLmlzQWxsRGF5KTsNCiAgICB9Ow0KICAgIERhdGVTZWxlY3RpbmcucHJvdG90eXBlLmlzU2VsZWN0aW9uRm9vdHByaW50QWxsb3dlZCA9IGZ1bmN0aW9uIChjb21wb25lbnRGb290cHJpbnQpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuY29tcG9uZW50LmRhdGVQcm9maWxlLnZhbGlkVW56b25lZFJhbmdlLmNvbnRhaW5zUmFuZ2UoY29tcG9uZW50Rm9vdHByaW50LnVuem9uZWRSYW5nZSkgJiYNCiAgICAgICAgICAgIHRoaXMudmlldy5jYWxlbmRhci5jb25zdHJhaW50cy5pc1NlbGVjdGlvbkZvb3RwcmludEFsbG93ZWQoY29tcG9uZW50Rm9vdHByaW50KTsNCiAgICB9Ow0KICAgIHJldHVybiBEYXRlU2VsZWN0aW5nOw0KfShJbnRlcmFjdGlvbl8xLmRlZmF1bHQpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IERhdGVTZWxlY3Rpbmc7DQoKCi8qKiovIH0pLAovKiAyMjYgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciBtb21lbnQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDApOw0KdmFyICQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgU2Nyb2xsZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMzkpOw0KdmFyIFZpZXdfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNDEpOw0KdmFyIFRpbWVHcmlkXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIyNyk7DQp2YXIgRGF5R3JpZF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2MSk7DQp2YXIgQUdFTkRBX0FMTF9EQVlfRVZFTlRfTElNSVQgPSA1Ow0KdmFyIGFnZW5kYVRpbWVHcmlkTWV0aG9kczsNCnZhciBhZ2VuZGFEYXlHcmlkTWV0aG9kczsNCi8qIEFuIGFic3RyYWN0IGNsYXNzIGZvciBhbGwgYWdlbmRhLXJlbGF0ZWQgdmlld3MuIERpc3BsYXlzIG9uZSBtb3JlIGNvbHVtbnMgd2l0aCB0aW1lIHNsb3RzIHJ1bm5pbmcgdmVydGljYWxseS4NCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KLy8gSXMgYSBtYW5hZ2VyIGZvciB0aGUgVGltZUdyaWQgc3ViY29tcG9uZW50IGFuZCBwb3NzaWJseSB0aGUgRGF5R3JpZCBzdWJjb21wb25lbnQgKGlmIGFsbERheVNsb3QgaXMgb24pLg0KLy8gUmVzcG9uc2libGUgZm9yIG1hbmFnaW5nIHdpZHRoL2hlaWdodC4NCnZhciBBZ2VuZGFWaWV3ID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKEFnZW5kYVZpZXcsIF9zdXBlcik7DQogICAgZnVuY3Rpb24gQWdlbmRhVmlldyhjYWxlbmRhciwgdmlld1NwZWMpIHsNCiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgY2FsZW5kYXIsIHZpZXdTcGVjKSB8fCB0aGlzOw0KICAgICAgICBfdGhpcy51c2VzTWluTWF4VGltZSA9IHRydWU7IC8vIGluZGljYXRlcyB0aGF0IG1pblRpbWUvbWF4VGltZSBhZmZlY3RzIHJlbmRlcmluZw0KICAgICAgICBfdGhpcy50aW1lR3JpZCA9IF90aGlzLmluc3RhbnRpYXRlVGltZUdyaWQoKTsNCiAgICAgICAgX3RoaXMuYWRkQ2hpbGQoX3RoaXMudGltZUdyaWQpOw0KICAgICAgICBpZiAoX3RoaXMub3B0KCdhbGxEYXlTbG90JykpIHsNCiAgICAgICAgICAgIF90aGlzLmRheUdyaWQgPSBfdGhpcy5pbnN0YW50aWF0ZURheUdyaWQoKTsgLy8gdGhlIGFsbC1kYXkgc3ViY29tcG9uZW50IG9mIHRoaXMgdmlldw0KICAgICAgICAgICAgX3RoaXMuYWRkQ2hpbGQoX3RoaXMuZGF5R3JpZCk7DQogICAgICAgIH0NCiAgICAgICAgX3RoaXMuc2Nyb2xsZXIgPSBuZXcgU2Nyb2xsZXJfMS5kZWZhdWx0KHsNCiAgICAgICAgICAgIG92ZXJmbG93WDogJ2hpZGRlbicsDQogICAgICAgICAgICBvdmVyZmxvd1k6ICdhdXRvJw0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuIF90aGlzOw0KICAgIH0NCiAgICAvLyBJbnN0YW50aWF0ZXMgdGhlIFRpbWVHcmlkIG9iamVjdCB0aGlzIHZpZXcgbmVlZHMuIERyYXdzIGZyb20gdGhpcy50aW1lR3JpZENsYXNzDQogICAgQWdlbmRhVmlldy5wcm90b3R5cGUuaW5zdGFudGlhdGVUaW1lR3JpZCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIHRpbWVHcmlkID0gbmV3IHRoaXMudGltZUdyaWRDbGFzcyh0aGlzKTsNCiAgICAgICAgdXRpbF8xLmNvcHlPd25Qcm9wcyhhZ2VuZGFUaW1lR3JpZE1ldGhvZHMsIHRpbWVHcmlkKTsNCiAgICAgICAgcmV0dXJuIHRpbWVHcmlkOw0KICAgIH07DQogICAgLy8gSW5zdGFudGlhdGVzIHRoZSBEYXlHcmlkIG9iamVjdCB0aGlzIHZpZXcgbWlnaHQgbmVlZC4gRHJhd3MgZnJvbSB0aGlzLmRheUdyaWRDbGFzcw0KICAgIEFnZW5kYVZpZXcucHJvdG90eXBlLmluc3RhbnRpYXRlRGF5R3JpZCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIGRheUdyaWQgPSBuZXcgdGhpcy5kYXlHcmlkQ2xhc3ModGhpcyk7DQogICAgICAgIHV0aWxfMS5jb3B5T3duUHJvcHMoYWdlbmRhRGF5R3JpZE1ldGhvZHMsIGRheUdyaWQpOw0KICAgICAgICByZXR1cm4gZGF5R3JpZDsNCiAgICB9Ow0KICAgIC8qIFJlbmRlcmluZw0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgQWdlbmRhVmlldy5wcm90b3R5cGUucmVuZGVyU2tlbGV0b24gPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciB0aW1lR3JpZFdyYXBFbDsNCiAgICAgICAgdmFyIHRpbWVHcmlkRWw7DQogICAgICAgIHRoaXMuZWwuYWRkQ2xhc3MoJ2ZjLWFnZW5kYS12aWV3JykuaHRtbCh0aGlzLnJlbmRlclNrZWxldG9uSHRtbCgpKTsNCiAgICAgICAgdGhpcy5zY3JvbGxlci5yZW5kZXIoKTsNCiAgICAgICAgdGltZUdyaWRXcmFwRWwgPSB0aGlzLnNjcm9sbGVyLmVsLmFkZENsYXNzKCdmYy10aW1lLWdyaWQtY29udGFpbmVyJyk7DQogICAgICAgIHRpbWVHcmlkRWwgPSAkKCc8ZGl2IGNsYXNzPSJmYy10aW1lLWdyaWQiIC8+JykuYXBwZW5kVG8odGltZUdyaWRXcmFwRWwpOw0KICAgICAgICB0aGlzLmVsLmZpbmQoJy5mYy1ib2R5ID4gdHIgPiB0ZCcpLmFwcGVuZCh0aW1lR3JpZFdyYXBFbCk7DQogICAgICAgIHRoaXMudGltZUdyaWQuaGVhZENvbnRhaW5lckVsID0gdGhpcy5lbC5maW5kKCcuZmMtaGVhZC1jb250YWluZXInKTsNCiAgICAgICAgdGhpcy50aW1lR3JpZC5zZXRFbGVtZW50KHRpbWVHcmlkRWwpOw0KICAgICAgICBpZiAodGhpcy5kYXlHcmlkKSB7DQogICAgICAgICAgICB0aGlzLmRheUdyaWQuc2V0RWxlbWVudCh0aGlzLmVsLmZpbmQoJy5mYy1kYXktZ3JpZCcpKTsNCiAgICAgICAgICAgIC8vIGhhdmUgdGhlIGRheS1ncmlkIGV4dGVuZCBpdCdzIGNvb3JkaW5hdGUgYXJlYSBvdmVyIHRoZSA8aHI+IGRpdmlkaW5nIHRoZSB0d28gZ3JpZHMNCiAgICAgICAgICAgIHRoaXMuZGF5R3JpZC5ib3R0b21Db29yZFBhZGRpbmcgPSB0aGlzLmRheUdyaWQuZWwubmV4dCgnaHInKS5vdXRlckhlaWdodCgpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBBZ2VuZGFWaWV3LnByb3RvdHlwZS51bnJlbmRlclNrZWxldG9uID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLnRpbWVHcmlkLnJlbW92ZUVsZW1lbnQoKTsNCiAgICAgICAgaWYgKHRoaXMuZGF5R3JpZCkgew0KICAgICAgICAgICAgdGhpcy5kYXlHcmlkLnJlbW92ZUVsZW1lbnQoKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLnNjcm9sbGVyLmRlc3Ryb3koKTsNCiAgICB9Ow0KICAgIC8vIEJ1aWxkcyB0aGUgSFRNTCBza2VsZXRvbiBmb3IgdGhlIHZpZXcuDQogICAgLy8gVGhlIGRheS1ncmlkIGFuZCB0aW1lLWdyaWQgY29tcG9uZW50cyB3aWxsIHJlbmRlciBpbnNpZGUgY29udGFpbmVycyBkZWZpbmVkIGJ5IHRoaXMgSFRNTC4NCiAgICBBZ2VuZGFWaWV3LnByb3RvdHlwZS5yZW5kZXJTa2VsZXRvbkh0bWwgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciB0aGVtZSA9IHRoaXMuY2FsZW5kYXIudGhlbWU7DQogICAgICAgIHJldHVybiAnJyArDQogICAgICAgICAgICAnPHRhYmxlIGNsYXNzPSInICsgdGhlbWUuZ2V0Q2xhc3MoJ3RhYmxlR3JpZCcpICsgJyI+JyArDQogICAgICAgICAgICAodGhpcy5vcHQoJ2NvbHVtbkhlYWRlcicpID8NCiAgICAgICAgICAgICAgICAnPHRoZWFkIGNsYXNzPSJmYy1oZWFkIj4nICsNCiAgICAgICAgICAgICAgICAgICAgJzx0cj4nICsNCiAgICAgICAgICAgICAgICAgICAgJzx0ZCBjbGFzcz0iZmMtaGVhZC1jb250YWluZXIgJyArIHRoZW1lLmdldENsYXNzKCd3aWRnZXRIZWFkZXInKSArICciPiZuYnNwOzwvdGQ+JyArDQogICAgICAgICAgICAgICAgICAgICc8L3RyPicgKw0KICAgICAgICAgICAgICAgICAgICAnPC90aGVhZD4nIDoNCiAgICAgICAgICAgICAgICAnJykgKw0KICAgICAgICAgICAgJzx0Ym9keSBjbGFzcz0iZmMtYm9keSI+JyArDQogICAgICAgICAgICAnPHRyPicgKw0KICAgICAgICAgICAgJzx0ZCBjbGFzcz0iJyArIHRoZW1lLmdldENsYXNzKCd3aWRnZXRDb250ZW50JykgKyAnIj4nICsNCiAgICAgICAgICAgICh0aGlzLmRheUdyaWQgPw0KICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJmYy1kYXktZ3JpZCIvPicgKw0KICAgICAgICAgICAgICAgICAgICAnPGhyIGNsYXNzPSJmYy1kaXZpZGVyICcgKyB0aGVtZS5nZXRDbGFzcygnd2lkZ2V0SGVhZGVyJykgKyAnIi8+JyA6DQogICAgICAgICAgICAgICAgJycpICsNCiAgICAgICAgICAgICc8L3RkPicgKw0KICAgICAgICAgICAgJzwvdHI+JyArDQogICAgICAgICAgICAnPC90Ym9keT4nICsNCiAgICAgICAgICAgICc8L3RhYmxlPic7DQogICAgfTsNCiAgICAvLyBHZW5lcmF0ZXMgYW4gSFRNTCBhdHRyaWJ1dGUgc3RyaW5nIGZvciBzZXR0aW5nIHRoZSB3aWR0aCBvZiB0aGUgYXhpcywgaWYgaXQgaXMga25vd24NCiAgICBBZ2VuZGFWaWV3LnByb3RvdHlwZS5heGlzU3R5bGVBdHRyID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5heGlzV2lkdGggIT0gbnVsbCkgew0KICAgICAgICAgICAgcmV0dXJuICdzdHlsZT0id2lkdGg6JyArIHRoaXMuYXhpc1dpZHRoICsgJ3B4Iic7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuICcnOw0KICAgIH07DQogICAgLyogTm93IEluZGljYXRvcg0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgQWdlbmRhVmlldy5wcm90b3R5cGUuZ2V0Tm93SW5kaWNhdG9yVW5pdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMudGltZUdyaWQuZ2V0Tm93SW5kaWNhdG9yVW5pdCgpOw0KICAgIH07DQogICAgLyogRGltZW5zaW9ucw0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgLy8gQWRqdXN0cyB0aGUgdmVydGljYWwgZGltZW5zaW9ucyBvZiB0aGUgdmlldyB0byB0aGUgc3BlY2lmaWVkIHZhbHVlcw0KICAgIEFnZW5kYVZpZXcucHJvdG90eXBlLnVwZGF0ZVNpemUgPSBmdW5jdGlvbiAodG90YWxIZWlnaHQsIGlzQXV0bywgaXNSZXNpemUpIHsNCiAgICAgICAgdmFyIGV2ZW50TGltaXQ7DQogICAgICAgIHZhciBzY3JvbGxlckhlaWdodDsNCiAgICAgICAgdmFyIHNjcm9sbGJhcldpZHRoczsNCiAgICAgICAgX3N1cGVyLnByb3RvdHlwZS51cGRhdGVTaXplLmNhbGwodGhpcywgdG90YWxIZWlnaHQsIGlzQXV0bywgaXNSZXNpemUpOw0KICAgICAgICAvLyBtYWtlIGFsbCBheGlzIGNlbGxzIGxpbmUgdXAsIGFuZCByZWNvcmQgdGhlIHdpZHRoIHNvIG5ld2x5IGNyZWF0ZWQgYXhpcyBjZWxscyB3aWxsIGhhdmUgaXQNCiAgICAgICAgdGhpcy5heGlzV2lkdGggPSB1dGlsXzEubWF0Y2hDZWxsV2lkdGhzKHRoaXMuZWwuZmluZCgnLmZjLWF4aXMnKSk7DQogICAgICAgIC8vIGhhY2sgdG8gZ2l2ZSB0aGUgdmlldyBzb21lIGhlaWdodCBwcmlvciB0byB0aW1lR3JpZCdzIGNvbHVtbnMgYmVpbmcgcmVuZGVyZWQNCiAgICAgICAgLy8gVE9ETzogc2VwYXJhdGUgc2V0dGluZyBoZWlnaHQgZnJvbSBzY3JvbGxlciBWUyB0aW1lR3JpZC4NCiAgICAgICAgaWYgKCF0aGlzLnRpbWVHcmlkLmNvbEVscykgew0KICAgICAgICAgICAgaWYgKCFpc0F1dG8pIHsNCiAgICAgICAgICAgICAgICBzY3JvbGxlckhlaWdodCA9IHRoaXMuY29tcHV0ZVNjcm9sbGVySGVpZ2h0KHRvdGFsSGVpZ2h0KTsNCiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbGVyLnNldEhlaWdodChzY3JvbGxlckhlaWdodCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgLy8gc2V0IG9mIGZha2Ugcm93IGVsZW1lbnRzIHRoYXQgbXVzdCBjb21wZW5zYXRlIHdoZW4gc2Nyb2xsZXIgaGFzIHNjcm9sbGJhcnMNCiAgICAgICAgdmFyIG5vU2Nyb2xsUm93RWxzID0gdGhpcy5lbC5maW5kKCcuZmMtcm93Om5vdCguZmMtc2Nyb2xsZXIgKiknKTsNCiAgICAgICAgLy8gcmVzZXQgYWxsIGRpbWVuc2lvbnMgYmFjayB0byB0aGUgb3JpZ2luYWwgc3RhdGUNCiAgICAgICAgdGhpcy50aW1lR3JpZC5ib3R0b21SdWxlRWwuaGlkZSgpOyAvLyAuc2hvdygpIHdpbGwgYmUgY2FsbGVkIGxhdGVyIGlmIHRoaXMgPGhyPiBpcyBuZWNlc3NhcnkNCiAgICAgICAgdGhpcy5zY3JvbGxlci5jbGVhcigpOyAvLyBzZXRzIGhlaWdodCB0byAnYXV0bycgYW5kIGNsZWFycyBvdmVyZmxvdw0KICAgICAgICB1dGlsXzEudW5jb21wZW5zYXRlU2Nyb2xsKG5vU2Nyb2xsUm93RWxzKTsNCiAgICAgICAgLy8gbGltaXQgbnVtYmVyIG9mIGV2ZW50cyBpbiB0aGUgYWxsLWRheSBhcmVhDQogICAgICAgIGlmICh0aGlzLmRheUdyaWQpIHsNCiAgICAgICAgICAgIHRoaXMuZGF5R3JpZC5yZW1vdmVTZWdQb3BvdmVyKCk7IC8vIGtpbGwgdGhlICJtb3JlIiBwb3BvdmVyIGlmIGRpc3BsYXllZA0KICAgICAgICAgICAgZXZlbnRMaW1pdCA9IHRoaXMub3B0KCdldmVudExpbWl0Jyk7DQogICAgICAgICAgICBpZiAoZXZlbnRMaW1pdCAmJiB0eXBlb2YgZXZlbnRMaW1pdCAhPT0gJ251bWJlcicpIHsNCiAgICAgICAgICAgICAgICBldmVudExpbWl0ID0gQUdFTkRBX0FMTF9EQVlfRVZFTlRfTElNSVQ7IC8vIG1ha2Ugc3VyZSAiYXV0byIgZ29lcyB0byBhIHJlYWwgbnVtYmVyDQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoZXZlbnRMaW1pdCkgew0KICAgICAgICAgICAgICAgIHRoaXMuZGF5R3JpZC5saW1pdFJvd3MoZXZlbnRMaW1pdCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFpc0F1dG8pIHsNCiAgICAgICAgICAgIHNjcm9sbGVySGVpZ2h0ID0gdGhpcy5jb21wdXRlU2Nyb2xsZXJIZWlnaHQodG90YWxIZWlnaHQpOw0KICAgICAgICAgICAgdGhpcy5zY3JvbGxlci5zZXRIZWlnaHQoc2Nyb2xsZXJIZWlnaHQpOw0KICAgICAgICAgICAgc2Nyb2xsYmFyV2lkdGhzID0gdGhpcy5zY3JvbGxlci5nZXRTY3JvbGxiYXJXaWR0aHMoKTsNCiAgICAgICAgICAgIGlmIChzY3JvbGxiYXJXaWR0aHMubGVmdCB8fCBzY3JvbGxiYXJXaWR0aHMucmlnaHQpIHsNCiAgICAgICAgICAgICAgICAvLyBtYWtlIHRoZSBhbGwtZGF5IGFuZCBoZWFkZXIgcm93cyBsaW5lcyB1cA0KICAgICAgICAgICAgICAgIHV0aWxfMS5jb21wZW5zYXRlU2Nyb2xsKG5vU2Nyb2xsUm93RWxzLCBzY3JvbGxiYXJXaWR0aHMpOw0KICAgICAgICAgICAgICAgIC8vIHRoZSBzY3JvbGxiYXIgY29tcGVuc2F0aW9uIG1pZ2h0IGhhdmUgY2hhbmdlZCB0ZXh0IGZsb3csIHdoaWNoIG1pZ2h0IGFmZmVjdCBoZWlnaHQsIHNvIHJlY2FsY3VsYXRlDQogICAgICAgICAgICAgICAgLy8gYW5kIHJlYXBwbHkgdGhlIGRlc2lyZWQgaGVpZ2h0IHRvIHRoZSBzY3JvbGxlci4NCiAgICAgICAgICAgICAgICBzY3JvbGxlckhlaWdodCA9IHRoaXMuY29tcHV0ZVNjcm9sbGVySGVpZ2h0KHRvdGFsSGVpZ2h0KTsNCiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbGVyLnNldEhlaWdodChzY3JvbGxlckhlaWdodCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICAvLyBndWFyYW50ZWVzIHRoZSBzYW1lIHNjcm9sbGJhciB3aWR0aHMNCiAgICAgICAgICAgIHRoaXMuc2Nyb2xsZXIubG9ja092ZXJmbG93KHNjcm9sbGJhcldpZHRocyk7DQogICAgICAgICAgICAvLyBpZiB0aGVyZSdzIGFueSBzcGFjZSBiZWxvdyB0aGUgc2xhdHMsIHNob3cgdGhlIGhvcml6b250YWwgcnVsZS4NCiAgICAgICAgICAgIC8vIHRoaXMgd29uJ3QgY2F1c2UgYW55IG5ldyBvdmVyZmxvdywgYmVjYXVzZSBsb2NrT3ZlcmZsb3cgYWxyZWFkeSBjYWxsZWQuDQogICAgICAgICAgICBpZiAodGhpcy50aW1lR3JpZC5nZXRUb3RhbFNsYXRIZWlnaHQoKSA8IHNjcm9sbGVySGVpZ2h0KSB7DQogICAgICAgICAgICAgICAgdGhpcy50aW1lR3JpZC5ib3R0b21SdWxlRWwuc2hvdygpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBnaXZlbiBhIGRlc2lyZWQgdG90YWwgaGVpZ2h0IG9mIHRoZSB2aWV3LCByZXR1cm5zIHdoYXQgdGhlIGhlaWdodCBvZiB0aGUgc2Nyb2xsZXIgc2hvdWxkIGJlDQogICAgQWdlbmRhVmlldy5wcm90b3R5cGUuY29tcHV0ZVNjcm9sbGVySGVpZ2h0ID0gZnVuY3Rpb24gKHRvdGFsSGVpZ2h0KSB7DQogICAgICAgIHJldHVybiB0b3RhbEhlaWdodCAtDQogICAgICAgICAgICB1dGlsXzEuc3VidHJhY3RJbm5lckVsSGVpZ2h0KHRoaXMuZWwsIHRoaXMuc2Nyb2xsZXIuZWwpOyAvLyBldmVyeXRoaW5nIHRoYXQncyBOT1QgdGhlIHNjcm9sbGVyDQogICAgfTsNCiAgICAvKiBTY3JvbGwNCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KICAgIC8vIENvbXB1dGVzIHRoZSBpbml0aWFsIHByZS1jb25maWd1cmVkIHNjcm9sbCBzdGF0ZSBwcmlvciB0byBhbGxvd2luZyB0aGUgdXNlciB0byBjaGFuZ2UgaXQNCiAgICBBZ2VuZGFWaWV3LnByb3RvdHlwZS5jb21wdXRlSW5pdGlhbERhdGVTY3JvbGwgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBzY3JvbGxUaW1lID0gbW9tZW50LmR1cmF0aW9uKHRoaXMub3B0KCdzY3JvbGxUaW1lJykpOw0KICAgICAgICB2YXIgdG9wID0gdGhpcy50aW1lR3JpZC5jb21wdXRlVGltZVRvcChzY3JvbGxUaW1lKTsNCiAgICAgICAgLy8gem9vbSBjYW4gZ2l2ZSB3ZWlyZCBmbG9hdGluZy1wb2ludCB2YWx1ZXMuIHJhdGhlciBzY3JvbGwgYSBsaXR0bGUgYml0IGZ1cnRoZXINCiAgICAgICAgdG9wID0gTWF0aC5jZWlsKHRvcCk7DQogICAgICAgIGlmICh0b3ApIHsNCiAgICAgICAgICAgIHRvcCsrOyAvLyB0byBvdmVyY29tZSB0b3AgYm9yZGVyIHRoYXQgc2xvdHMgYmV5b25kIHRoZSBmaXJzdCBoYXZlLiBsb29rcyBiZXR0ZXINCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4geyB0b3A6IHRvcCB9Ow0KICAgIH07DQogICAgQWdlbmRhVmlldy5wcm90b3R5cGUucXVlcnlEYXRlU2Nyb2xsID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4geyB0b3A6IHRoaXMuc2Nyb2xsZXIuZ2V0U2Nyb2xsVG9wKCkgfTsNCiAgICB9Ow0KICAgIEFnZW5kYVZpZXcucHJvdG90eXBlLmFwcGx5RGF0ZVNjcm9sbCA9IGZ1bmN0aW9uIChzY3JvbGwpIHsNCiAgICAgICAgaWYgKHNjcm9sbC50b3AgIT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgdGhpcy5zY3JvbGxlci5zZXRTY3JvbGxUb3Aoc2Nyb2xsLnRvcCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8qIEhpdCBBcmVhcw0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgLy8gZm9yd2FyZCBhbGwgaGl0LXJlbGF0ZWQgbWV0aG9kIGNhbGxzIHRvIHRoZSBncmlkcyAoZGF5R3JpZCBtaWdodCBub3QgYmUgZGVmaW5lZCkNCiAgICBBZ2VuZGFWaWV3LnByb3RvdHlwZS5nZXRIaXRGb290cHJpbnQgPSBmdW5jdGlvbiAoaGl0KSB7DQogICAgICAgIC8vIFRPRE86IGhpdC5jb21wb25lbnQgaXMgc2V0IGFzIGEgaGFjayB0byBpZGVudGlmeSB3aGVyZSB0aGUgaGl0IGNhbWUgZnJvbQ0KICAgICAgICByZXR1cm4gaGl0LmNvbXBvbmVudC5nZXRIaXRGb290cHJpbnQoaGl0KTsNCiAgICB9Ow0KICAgIEFnZW5kYVZpZXcucHJvdG90eXBlLmdldEhpdEVsID0gZnVuY3Rpb24gKGhpdCkgew0KICAgICAgICAvLyBUT0RPOiBoaXQuY29tcG9uZW50IGlzIHNldCBhcyBhIGhhY2sgdG8gaWRlbnRpZnkgd2hlcmUgdGhlIGhpdCBjYW1lIGZyb20NCiAgICAgICAgcmV0dXJuIGhpdC5jb21wb25lbnQuZ2V0SGl0RWwoaGl0KTsNCiAgICB9Ow0KICAgIC8qIEV2ZW50IFJlbmRlcmluZw0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgQWdlbmRhVmlldy5wcm90b3R5cGUuZXhlY3V0ZUV2ZW50UmVuZGVyID0gZnVuY3Rpb24gKGV2ZW50c1BheWxvYWQpIHsNCiAgICAgICAgdmFyIGRheUV2ZW50c1BheWxvYWQgPSB7fTsNCiAgICAgICAgdmFyIHRpbWVkRXZlbnRzUGF5bG9hZCA9IHt9Ow0KICAgICAgICB2YXIgaWQ7DQogICAgICAgIHZhciBldmVudEluc3RhbmNlR3JvdXA7DQogICAgICAgIC8vIHNlcGFyYXRlIHRoZSBldmVudHMgaW50byBhbGwtZGF5IGFuZCB0aW1lZA0KICAgICAgICBmb3IgKGlkIGluIGV2ZW50c1BheWxvYWQpIHsNCiAgICAgICAgICAgIGV2ZW50SW5zdGFuY2VHcm91cCA9IGV2ZW50c1BheWxvYWRbaWRdOw0KICAgICAgICAgICAgaWYgKGV2ZW50SW5zdGFuY2VHcm91cC5nZXRFdmVudERlZigpLmlzQWxsRGF5KCkpIHsNCiAgICAgICAgICAgICAgICBkYXlFdmVudHNQYXlsb2FkW2lkXSA9IGV2ZW50SW5zdGFuY2VHcm91cDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIHRpbWVkRXZlbnRzUGF5bG9hZFtpZF0gPSBldmVudEluc3RhbmNlR3JvdXA7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgdGhpcy50aW1lR3JpZC5leGVjdXRlRXZlbnRSZW5kZXIodGltZWRFdmVudHNQYXlsb2FkKTsNCiAgICAgICAgaWYgKHRoaXMuZGF5R3JpZCkgew0KICAgICAgICAgICAgdGhpcy5kYXlHcmlkLmV4ZWN1dGVFdmVudFJlbmRlcihkYXlFdmVudHNQYXlsb2FkKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLyogRHJhZ2dpbmcvUmVzaXppbmcgUm91dGluZw0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgLy8gQSByZXR1cm5lZCB2YWx1ZSBvZiBgdHJ1ZWAgc2lnbmFscyB0aGF0IGEgbW9jayAiaGVscGVyIiBldmVudCBoYXMgYmVlbiByZW5kZXJlZC4NCiAgICBBZ2VuZGFWaWV3LnByb3RvdHlwZS5yZW5kZXJEcmFnID0gZnVuY3Rpb24gKGV2ZW50Rm9vdHByaW50cywgc2VnLCBpc1RvdWNoKSB7DQogICAgICAgIHZhciBncm91cHMgPSBncm91cEV2ZW50Rm9vdHByaW50c0J5QWxsRGF5KGV2ZW50Rm9vdHByaW50cyk7DQogICAgICAgIHZhciByZW5kZXJlZEhlbHBlciA9IGZhbHNlOw0KICAgICAgICByZW5kZXJlZEhlbHBlciA9IHRoaXMudGltZUdyaWQucmVuZGVyRHJhZyhncm91cHMudGltZWQsIHNlZywgaXNUb3VjaCk7DQogICAgICAgIGlmICh0aGlzLmRheUdyaWQpIHsNCiAgICAgICAgICAgIHJlbmRlcmVkSGVscGVyID0gdGhpcy5kYXlHcmlkLnJlbmRlckRyYWcoZ3JvdXBzLmFsbERheSwgc2VnLCBpc1RvdWNoKSB8fCByZW5kZXJlZEhlbHBlcjsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmVuZGVyZWRIZWxwZXI7DQogICAgfTsNCiAgICBBZ2VuZGFWaWV3LnByb3RvdHlwZS5yZW5kZXJFdmVudFJlc2l6ZSA9IGZ1bmN0aW9uIChldmVudEZvb3RwcmludHMsIHNlZywgaXNUb3VjaCkgew0KICAgICAgICB2YXIgZ3JvdXBzID0gZ3JvdXBFdmVudEZvb3RwcmludHNCeUFsbERheShldmVudEZvb3RwcmludHMpOw0KICAgICAgICB0aGlzLnRpbWVHcmlkLnJlbmRlckV2ZW50UmVzaXplKGdyb3Vwcy50aW1lZCwgc2VnLCBpc1RvdWNoKTsNCiAgICAgICAgaWYgKHRoaXMuZGF5R3JpZCkgew0KICAgICAgICAgICAgdGhpcy5kYXlHcmlkLnJlbmRlckV2ZW50UmVzaXplKGdyb3Vwcy5hbGxEYXksIHNlZywgaXNUb3VjaCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8qIFNlbGVjdGlvbg0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgLy8gUmVuZGVycyBhIHZpc3VhbCBpbmRpY2F0aW9uIG9mIGEgc2VsZWN0aW9uDQogICAgQWdlbmRhVmlldy5wcm90b3R5cGUucmVuZGVyU2VsZWN0aW9uRm9vdHByaW50ID0gZnVuY3Rpb24gKGNvbXBvbmVudEZvb3RwcmludCkgew0KICAgICAgICBpZiAoIWNvbXBvbmVudEZvb3RwcmludC5pc0FsbERheSkgew0KICAgICAgICAgICAgdGhpcy50aW1lR3JpZC5yZW5kZXJTZWxlY3Rpb25Gb290cHJpbnQoY29tcG9uZW50Rm9vdHByaW50KTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICh0aGlzLmRheUdyaWQpIHsNCiAgICAgICAgICAgIHRoaXMuZGF5R3JpZC5yZW5kZXJTZWxlY3Rpb25Gb290cHJpbnQoY29tcG9uZW50Rm9vdHByaW50KTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgcmV0dXJuIEFnZW5kYVZpZXc7DQp9KFZpZXdfMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBBZ2VuZGFWaWV3Ow0KQWdlbmRhVmlldy5wcm90b3R5cGUudGltZUdyaWRDbGFzcyA9IFRpbWVHcmlkXzEuZGVmYXVsdDsNCkFnZW5kYVZpZXcucHJvdG90eXBlLmRheUdyaWRDbGFzcyA9IERheUdyaWRfMS5kZWZhdWx0Ow0KLy8gV2lsbCBjdXN0b21pemUgdGhlIHJlbmRlcmluZyBiZWhhdmlvciBvZiB0aGUgQWdlbmRhVmlldydzIHRpbWVHcmlkDQphZ2VuZGFUaW1lR3JpZE1ldGhvZHMgPSB7DQogICAgLy8gR2VuZXJhdGVzIHRoZSBIVE1MIHRoYXQgd2lsbCBnbyBiZWZvcmUgdGhlIGRheS1vZiB3ZWVrIGhlYWRlciBjZWxscw0KICAgIHJlbmRlckhlYWRJbnRyb0h0bWw6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLnZpZXc7DQogICAgICAgIHZhciBjYWxlbmRhciA9IHZpZXcuY2FsZW5kYXI7DQogICAgICAgIHZhciB3ZWVrU3RhcnQgPSBjYWxlbmRhci5tc1RvVXRjTW9tZW50KHRoaXMuZGF0ZVByb2ZpbGUucmVuZGVyVW56b25lZFJhbmdlLnN0YXJ0TXMsIHRydWUpOw0KICAgICAgICB2YXIgd2Vla1RleHQ7DQogICAgICAgIGlmICh0aGlzLm9wdCgnd2Vla051bWJlcnMnKSkgew0KICAgICAgICAgICAgd2Vla1RleHQgPSB3ZWVrU3RhcnQuZm9ybWF0KHRoaXMub3B0KCdzbWFsbFdlZWtGb3JtYXQnKSk7DQogICAgICAgICAgICByZXR1cm4gJycgKw0KICAgICAgICAgICAgICAgICc8dGggY2xhc3M9ImZjLWF4aXMgZmMtd2Vlay1udW1iZXIgJyArIGNhbGVuZGFyLnRoZW1lLmdldENsYXNzKCd3aWRnZXRIZWFkZXInKSArICciICcgKyB2aWV3LmF4aXNTdHlsZUF0dHIoKSArICc+JyArDQogICAgICAgICAgICAgICAgdmlldy5idWlsZEdvdG9BbmNob3JIdG1sKC8vIGFzaWRlIGZyb20gbGluaywgaW1wb3J0YW50IGZvciBtYXRjaENlbGxXaWR0aHMNCiAgICAgICAgICAgICAgICB7IGRhdGU6IHdlZWtTdGFydCwgdHlwZTogJ3dlZWsnLCBmb3JjZU9mZjogdGhpcy5jb2xDbnQgPiAxIH0sIHV0aWxfMS5odG1sRXNjYXBlKHdlZWtUZXh0KSAvLyBpbm5lciBIVE1MDQogICAgICAgICAgICAgICAgKSArDQogICAgICAgICAgICAgICAgJzwvdGg+JzsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHJldHVybiAnPHRoIGNsYXNzPSJmYy1heGlzICcgKyBjYWxlbmRhci50aGVtZS5nZXRDbGFzcygnd2lkZ2V0SGVhZGVyJykgKyAnIiAnICsgdmlldy5heGlzU3R5bGVBdHRyKCkgKyAnPjwvdGg+JzsNCiAgICAgICAgfQ0KICAgIH0sDQogICAgLy8gR2VuZXJhdGVzIHRoZSBIVE1MIHRoYXQgZ29lcyBiZWZvcmUgdGhlIGJnIG9mIHRoZSBUaW1lR3JpZCBzbG90IGFyZWEuIExvbmcgdmVydGljYWwgY29sdW1uLg0KICAgIHJlbmRlckJnSW50cm9IdG1sOiBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciB2aWV3ID0gdGhpcy52aWV3Ow0KICAgICAgICByZXR1cm4gJzx0ZCBjbGFzcz0iZmMtYXhpcyAnICsgdmlldy5jYWxlbmRhci50aGVtZS5nZXRDbGFzcygnd2lkZ2V0Q29udGVudCcpICsgJyIgJyArIHZpZXcuYXhpc1N0eWxlQXR0cigpICsgJz48L3RkPic7DQogICAgfSwNCiAgICAvLyBHZW5lcmF0ZXMgdGhlIEhUTUwgdGhhdCBnb2VzIGJlZm9yZSBhbGwgb3RoZXIgdHlwZXMgb2YgY2VsbHMuDQogICAgLy8gQWZmZWN0cyBjb250ZW50LXNrZWxldG9uLCBoZWxwZXItc2tlbGV0b24sIGhpZ2hsaWdodC1za2VsZXRvbiBmb3IgYm90aCB0aGUgdGltZS1ncmlkIGFuZCBkYXktZ3JpZC4NCiAgICByZW5kZXJJbnRyb0h0bWw6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLnZpZXc7DQogICAgICAgIHJldHVybiAnPHRkIGNsYXNzPSJmYy1heGlzIiAnICsgdmlldy5heGlzU3R5bGVBdHRyKCkgKyAnPjwvdGQ+JzsNCiAgICB9DQp9Ow0KLy8gV2lsbCBjdXN0b21pemUgdGhlIHJlbmRlcmluZyBiZWhhdmlvciBvZiB0aGUgQWdlbmRhVmlldydzIGRheUdyaWQNCmFnZW5kYURheUdyaWRNZXRob2RzID0gew0KICAgIC8vIEdlbmVyYXRlcyB0aGUgSFRNTCB0aGF0IGdvZXMgYmVmb3JlIHRoZSBhbGwtZGF5IGNlbGxzDQogICAgcmVuZGVyQmdJbnRyb0h0bWw6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLnZpZXc7DQogICAgICAgIHJldHVybiAnJyArDQogICAgICAgICAgICAnPHRkIGNsYXNzPSJmYy1heGlzICcgKyB2aWV3LmNhbGVuZGFyLnRoZW1lLmdldENsYXNzKCd3aWRnZXRDb250ZW50JykgKyAnIiAnICsgdmlldy5heGlzU3R5bGVBdHRyKCkgKyAnPicgKw0KICAgICAgICAgICAgJzxzcGFuPicgKyAvLyBuZWVkZWQgZm9yIG1hdGNoQ2VsbFdpZHRocw0KICAgICAgICAgICAgdmlldy5nZXRBbGxEYXlIdG1sKCkgKw0KICAgICAgICAgICAgJzwvc3Bhbj4nICsNCiAgICAgICAgICAgICc8L3RkPic7DQogICAgfSwNCiAgICAvLyBHZW5lcmF0ZXMgdGhlIEhUTUwgdGhhdCBnb2VzIGJlZm9yZSBhbGwgb3RoZXIgdHlwZXMgb2YgY2VsbHMuDQogICAgLy8gQWZmZWN0cyBjb250ZW50LXNrZWxldG9uLCBoZWxwZXItc2tlbGV0b24sIGhpZ2hsaWdodC1za2VsZXRvbiBmb3IgYm90aCB0aGUgdGltZS1ncmlkIGFuZCBkYXktZ3JpZC4NCiAgICByZW5kZXJJbnRyb0h0bWw6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLnZpZXc7DQogICAgICAgIHJldHVybiAnPHRkIGNsYXNzPSJmYy1heGlzIiAnICsgdmlldy5heGlzU3R5bGVBdHRyKCkgKyAnPjwvdGQ+JzsNCiAgICB9DQp9Ow0KZnVuY3Rpb24gZ3JvdXBFdmVudEZvb3RwcmludHNCeUFsbERheShldmVudEZvb3RwcmludHMpIHsNCiAgICB2YXIgYWxsRGF5ID0gW107DQogICAgdmFyIHRpbWVkID0gW107DQogICAgdmFyIGk7DQogICAgZm9yIChpID0gMDsgaSA8IGV2ZW50Rm9vdHByaW50cy5sZW5ndGg7IGkrKykgew0KICAgICAgICBpZiAoZXZlbnRGb290cHJpbnRzW2ldLmNvbXBvbmVudEZvb3RwcmludC5pc0FsbERheSkgew0KICAgICAgICAgICAgYWxsRGF5LnB1c2goZXZlbnRGb290cHJpbnRzW2ldKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHRpbWVkLnB1c2goZXZlbnRGb290cHJpbnRzW2ldKTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICByZXR1cm4geyBhbGxEYXk6IGFsbERheSwgdGltZWQ6IHRpbWVkIH07DQp9DQoKCi8qKiovIH0pLAovKiAyMjcgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCnZhciBtb21lbnQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDApOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgSW50ZXJhY3RpdmVEYXRlQ29tcG9uZW50XzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQwKTsNCnZhciBCdXNpbmVzc0hvdXJSZW5kZXJlcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1Nik7DQp2YXIgU3RhbmRhcmRJbnRlcmFjdGlvbnNNaXhpbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2MCk7DQp2YXIgRGF5VGFibGVNaXhpbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1NSk7DQp2YXIgQ29vcmRDYWNoZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1Myk7DQp2YXIgVW56b25lZFJhbmdlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUpOw0KdmFyIENvbXBvbmVudEZvb3RwcmludF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxMik7DQp2YXIgVGltZUdyaWRFdmVudFJlbmRlcmVyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI0Nik7DQp2YXIgVGltZUdyaWRIZWxwZXJSZW5kZXJlcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyNDcpOw0KdmFyIFRpbWVHcmlkRmlsbFJlbmRlcmVyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDI0OCk7DQovKiBBIGNvbXBvbmVudCB0aGF0IHJlbmRlcnMgb25lIG9yIG1vcmUgY29sdW1ucyBvZiB2ZXJ0aWNhbCB0aW1lIHNsb3RzDQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCi8vIFdlIG1peGluIERheVRhYmxlLCBldmVuIHRob3VnaCB0aGVyZSBpcyBvbmx5IGEgc2luZ2xlIHJvdyBvZiBkYXlzDQovLyBwb3RlbnRpYWwgbmljZSB2YWx1ZXMgZm9yIHRoZSBzbG90LWR1cmF0aW9uIGFuZCBpbnRlcnZhbC1kdXJhdGlvbg0KLy8gZnJvbSBsYXJnZXN0IHRvIHNtYWxsZXN0DQp2YXIgQUdFTkRBX1NUT0NLX1NVQl9EVVJBVElPTlMgPSBbDQogICAgeyBob3VyczogMSB9LA0KICAgIHsgbWludXRlczogMzAgfSwNCiAgICB7IG1pbnV0ZXM6IDE1IH0sDQogICAgeyBzZWNvbmRzOiAzMCB9LA0KICAgIHsgc2Vjb25kczogMTUgfQ0KXTsNCnZhciBUaW1lR3JpZCA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHsNCiAgICB0c2xpYl8xLl9fZXh0ZW5kcyhUaW1lR3JpZCwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBUaW1lR3JpZCh2aWV3KSB7DQogICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMsIHZpZXcpIHx8IHRoaXM7DQogICAgICAgIF90aGlzLnByb2Nlc3NPcHRpb25zKCk7DQogICAgICAgIHJldHVybiBfdGhpczsNCiAgICB9DQogICAgLy8gU2xpY2VzIHVwIHRoZSBnaXZlbiBzcGFuICh1bnpvbmVkIHN0YXJ0L2VuZCB3aXRoIG90aGVyIG1pc2MgZGF0YSkgaW50byBhbiBhcnJheSBvZiBzZWdtZW50cw0KICAgIFRpbWVHcmlkLnByb3RvdHlwZS5jb21wb25lbnRGb290cHJpbnRUb1NlZ3MgPSBmdW5jdGlvbiAoY29tcG9uZW50Rm9vdHByaW50KSB7DQogICAgICAgIHZhciBzZWdzID0gdGhpcy5zbGljZVJhbmdlQnlUaW1lcyhjb21wb25lbnRGb290cHJpbnQudW56b25lZFJhbmdlKTsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZWdzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBpZiAodGhpcy5pc1JUTCkgew0KICAgICAgICAgICAgICAgIHNlZ3NbaV0uY29sID0gdGhpcy5kYXlzUGVyUm93IC0gMSAtIHNlZ3NbaV0uZGF5SW5kZXg7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICBzZWdzW2ldLmNvbCA9IHNlZ3NbaV0uZGF5SW5kZXg7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHNlZ3M7DQogICAgfTsNCiAgICAvKiBEYXRlIEhhbmRsaW5nDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICBUaW1lR3JpZC5wcm90b3R5cGUuc2xpY2VSYW5nZUJ5VGltZXMgPSBmdW5jdGlvbiAodW56b25lZFJhbmdlKSB7DQogICAgICAgIHZhciBzZWdzID0gW107DQogICAgICAgIHZhciBzZWdSYW5nZTsNCiAgICAgICAgdmFyIGRheUluZGV4Ow0KICAgICAgICBmb3IgKGRheUluZGV4ID0gMDsgZGF5SW5kZXggPCB0aGlzLmRheXNQZXJSb3c7IGRheUluZGV4KyspIHsNCiAgICAgICAgICAgIHNlZ1JhbmdlID0gdW56b25lZFJhbmdlLmludGVyc2VjdCh0aGlzLmRheVJhbmdlc1tkYXlJbmRleF0pOw0KICAgICAgICAgICAgaWYgKHNlZ1JhbmdlKSB7DQogICAgICAgICAgICAgICAgc2Vncy5wdXNoKHsNCiAgICAgICAgICAgICAgICAgICAgc3RhcnRNczogc2VnUmFuZ2Uuc3RhcnRNcywNCiAgICAgICAgICAgICAgICAgICAgZW5kTXM6IHNlZ1JhbmdlLmVuZE1zLA0KICAgICAgICAgICAgICAgICAgICBpc1N0YXJ0OiBzZWdSYW5nZS5pc1N0YXJ0LA0KICAgICAgICAgICAgICAgICAgICBpc0VuZDogc2VnUmFuZ2UuaXNFbmQsDQogICAgICAgICAgICAgICAgICAgIGRheUluZGV4OiBkYXlJbmRleA0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiBzZWdzOw0KICAgIH07DQogICAgLyogT3B0aW9ucw0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgLy8gUGFyc2VzIHZhcmlvdXMgb3B0aW9ucyBpbnRvIHByb3BlcnRpZXMgb2YgdGhpcyBvYmplY3QNCiAgICBUaW1lR3JpZC5wcm90b3R5cGUucHJvY2Vzc09wdGlvbnMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBzbG90RHVyYXRpb24gPSB0aGlzLm9wdCgnc2xvdER1cmF0aW9uJyk7DQogICAgICAgIHZhciBzbmFwRHVyYXRpb24gPSB0aGlzLm9wdCgnc25hcER1cmF0aW9uJyk7DQogICAgICAgIHZhciBpbnB1dDsNCiAgICAgICAgc2xvdER1cmF0aW9uID0gbW9tZW50LmR1cmF0aW9uKHNsb3REdXJhdGlvbik7DQogICAgICAgIHNuYXBEdXJhdGlvbiA9IHNuYXBEdXJhdGlvbiA/IG1vbWVudC5kdXJhdGlvbihzbmFwRHVyYXRpb24pIDogc2xvdER1cmF0aW9uOw0KICAgICAgICB0aGlzLnNsb3REdXJhdGlvbiA9IHNsb3REdXJhdGlvbjsNCiAgICAgICAgdGhpcy5zbmFwRHVyYXRpb24gPSBzbmFwRHVyYXRpb247DQogICAgICAgIHRoaXMuc25hcHNQZXJTbG90ID0gc2xvdER1cmF0aW9uIC8gc25hcER1cmF0aW9uOyAvLyBUT0RPOiBlbnN1cmUgYW4gaW50ZWdlciBtdWx0aXBsZT8NCiAgICAgICAgLy8gbWlnaHQgYmUgYW4gYXJyYXkgdmFsdWUgKGZvciBUaW1lbGluZVZpZXcpLg0KICAgICAgICAvLyBpZiBzbywgZ2V0dGluZyB0aGUgbW9zdCBncmFudWxhciBlbnRyeSAodGhlIGxhc3Qgb25lIHByb2JhYmx5KS4NCiAgICAgICAgaW5wdXQgPSB0aGlzLm9wdCgnc2xvdExhYmVsRm9ybWF0Jyk7DQogICAgICAgIGlmICgkLmlzQXJyYXkoaW5wdXQpKSB7DQogICAgICAgICAgICBpbnB1dCA9IGlucHV0W2lucHV0Lmxlbmd0aCAtIDFdOw0KICAgICAgICB9DQogICAgICAgIHRoaXMubGFiZWxGb3JtYXQgPSBpbnB1dCB8fA0KICAgICAgICAgICAgdGhpcy5vcHQoJ3NtYWxsVGltZUZvcm1hdCcpOyAvLyB0aGUgY29tcHV0ZWQgZGVmYXVsdA0KICAgICAgICBpbnB1dCA9IHRoaXMub3B0KCdzbG90TGFiZWxJbnRlcnZhbCcpOw0KICAgICAgICB0aGlzLmxhYmVsSW50ZXJ2YWwgPSBpbnB1dCA/DQogICAgICAgICAgICBtb21lbnQuZHVyYXRpb24oaW5wdXQpIDoNCiAgICAgICAgICAgIHRoaXMuY29tcHV0ZUxhYmVsSW50ZXJ2YWwoc2xvdER1cmF0aW9uKTsNCiAgICB9Ow0KICAgIC8vIENvbXB1dGVzIGFuIGF1dG9tYXRpYyB2YWx1ZSBmb3Igc2xvdExhYmVsSW50ZXJ2YWwNCiAgICBUaW1lR3JpZC5wcm90b3R5cGUuY29tcHV0ZUxhYmVsSW50ZXJ2YWwgPSBmdW5jdGlvbiAoc2xvdER1cmF0aW9uKSB7DQogICAgICAgIHZhciBpOw0KICAgICAgICB2YXIgbGFiZWxJbnRlcnZhbDsNCiAgICAgICAgdmFyIHNsb3RzUGVyTGFiZWw7DQogICAgICAgIC8vIGZpbmQgdGhlIHNtYWxsZXN0IHN0b2NrIGxhYmVsIGludGVydmFsIHRoYXQgcmVzdWx0cyBpbiBtb3JlIHRoYW4gb25lIHNsb3RzLXBlci1sYWJlbA0KICAgICAgICBmb3IgKGkgPSBBR0VOREFfU1RPQ0tfU1VCX0RVUkFUSU9OUy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgew0KICAgICAgICAgICAgbGFiZWxJbnRlcnZhbCA9IG1vbWVudC5kdXJhdGlvbihBR0VOREFfU1RPQ0tfU1VCX0RVUkFUSU9OU1tpXSk7DQogICAgICAgICAgICBzbG90c1BlckxhYmVsID0gdXRpbF8xLmRpdmlkZUR1cmF0aW9uQnlEdXJhdGlvbihsYWJlbEludGVydmFsLCBzbG90RHVyYXRpb24pOw0KICAgICAgICAgICAgaWYgKHV0aWxfMS5pc0ludChzbG90c1BlckxhYmVsKSAmJiBzbG90c1BlckxhYmVsID4gMSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBsYWJlbEludGVydmFsOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiBtb21lbnQuZHVyYXRpb24oc2xvdER1cmF0aW9uKTsgLy8gZmFsbCBiYWNrLiBjbG9uZQ0KICAgIH07DQogICAgLyogRGF0ZSBSZW5kZXJpbmcNCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KICAgIFRpbWVHcmlkLnByb3RvdHlwZS5yZW5kZXJEYXRlcyA9IGZ1bmN0aW9uIChkYXRlUHJvZmlsZSkgew0KICAgICAgICB0aGlzLmRhdGVQcm9maWxlID0gZGF0ZVByb2ZpbGU7DQogICAgICAgIHRoaXMudXBkYXRlRGF5VGFibGUoKTsNCiAgICAgICAgdGhpcy5yZW5kZXJTbGF0cygpOw0KICAgICAgICB0aGlzLnJlbmRlckNvbHVtbnMoKTsNCiAgICB9Ow0KICAgIFRpbWVHcmlkLnByb3RvdHlwZS51bnJlbmRlckRhdGVzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAvLyB0aGlzLnVucmVuZGVyU2xhdHMoKTsgLy8gZG9uJ3QgbmVlZCB0aGlzIGJlY2F1c2UgcmVwZWF0ZWQgLmh0bWwoKSBjYWxscyBjbGVhcg0KICAgICAgICB0aGlzLnVucmVuZGVyQ29sdW1ucygpOw0KICAgIH07DQogICAgVGltZUdyaWQucHJvdG90eXBlLnJlbmRlclNrZWxldG9uID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgdGhlbWUgPSB0aGlzLnZpZXcuY2FsZW5kYXIudGhlbWU7DQogICAgICAgIHRoaXMuZWwuaHRtbCgnPGRpdiBjbGFzcz0iZmMtYmciPjwvZGl2PicgKw0KICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImZjLXNsYXRzIj48L2Rpdj4nICsNCiAgICAgICAgICAgICc8aHIgY2xhc3M9ImZjLWRpdmlkZXIgJyArIHRoZW1lLmdldENsYXNzKCd3aWRnZXRIZWFkZXInKSArICciIHN0eWxlPSJkaXNwbGF5Om5vbmUiIC8+Jyk7DQogICAgICAgIHRoaXMuYm90dG9tUnVsZUVsID0gdGhpcy5lbC5maW5kKCdocicpOw0KICAgIH07DQogICAgVGltZUdyaWQucHJvdG90eXBlLnJlbmRlclNsYXRzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgdGhlbWUgPSB0aGlzLnZpZXcuY2FsZW5kYXIudGhlbWU7DQogICAgICAgIHRoaXMuc2xhdENvbnRhaW5lckVsID0gdGhpcy5lbC5maW5kKCc+IC5mYy1zbGF0cycpDQogICAgICAgICAgICAuaHRtbCgvLyBhdm9pZHMgbmVlZGluZyA6OnVucmVuZGVyU2xhdHMoKQ0KICAgICAgICAnPHRhYmxlIGNsYXNzPSInICsgdGhlbWUuZ2V0Q2xhc3MoJ3RhYmxlR3JpZCcpICsgJyI+JyArDQogICAgICAgICAgICB0aGlzLnJlbmRlclNsYXRSb3dIdG1sKCkgKw0KICAgICAgICAgICAgJzwvdGFibGU+Jyk7DQogICAgICAgIHRoaXMuc2xhdEVscyA9IHRoaXMuc2xhdENvbnRhaW5lckVsLmZpbmQoJ3RyJyk7DQogICAgICAgIHRoaXMuc2xhdENvb3JkQ2FjaGUgPSBuZXcgQ29vcmRDYWNoZV8xLmRlZmF1bHQoew0KICAgICAgICAgICAgZWxzOiB0aGlzLnNsYXRFbHMsDQogICAgICAgICAgICBpc1ZlcnRpY2FsOiB0cnVlDQogICAgICAgIH0pOw0KICAgIH07DQogICAgLy8gR2VuZXJhdGVzIHRoZSBIVE1MIGZvciB0aGUgaG9yaXpvbnRhbCAic2xhdHMiIHRoYXQgcnVuIHdpZHRoLXdpc2UuIEhhcyBhIHRpbWUgYXhpcyBvbiBhIHNpZGUuIERlcGVuZHMgb24gUlRMLg0KICAgIFRpbWVHcmlkLnByb3RvdHlwZS5yZW5kZXJTbGF0Um93SHRtbCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLnZpZXc7DQogICAgICAgIHZhciBjYWxlbmRhciA9IHZpZXcuY2FsZW5kYXI7DQogICAgICAgIHZhciB0aGVtZSA9IGNhbGVuZGFyLnRoZW1lOw0KICAgICAgICB2YXIgaXNSVEwgPSB0aGlzLmlzUlRMOw0KICAgICAgICB2YXIgZGF0ZVByb2ZpbGUgPSB0aGlzLmRhdGVQcm9maWxlOw0KICAgICAgICB2YXIgaHRtbCA9ICcnOw0KICAgICAgICB2YXIgc2xvdFRpbWUgPSBtb21lbnQuZHVyYXRpb24oK2RhdGVQcm9maWxlLm1pblRpbWUpOyAvLyB3aXNoIHRoZXJlIHdhcyAuY2xvbmUoKSBmb3IgZHVyYXRpb25zDQogICAgICAgIHZhciBzbG90SXRlcmF0b3IgPSBtb21lbnQuZHVyYXRpb24oMCk7DQogICAgICAgIHZhciBzbG90RGF0ZTsgLy8gd2lsbCBiZSBvbiB0aGUgdmlldydzIGZpcnN0IGRheSwgYnV0IHdlIG9ubHkgY2FyZSBhYm91dCBpdHMgdGltZQ0KICAgICAgICB2YXIgaXNMYWJlbGVkOw0KICAgICAgICB2YXIgYXhpc0h0bWw7DQogICAgICAgIC8vIENhbGN1bGF0ZSB0aGUgdGltZSBmb3IgZWFjaCBzbG90DQogICAgICAgIHdoaWxlIChzbG90VGltZSA8IGRhdGVQcm9maWxlLm1heFRpbWUpIHsNCiAgICAgICAgICAgIHNsb3REYXRlID0gY2FsZW5kYXIubXNUb1V0Y01vbWVudChkYXRlUHJvZmlsZS5yZW5kZXJVbnpvbmVkUmFuZ2Uuc3RhcnRNcykudGltZShzbG90VGltZSk7DQogICAgICAgICAgICBpc0xhYmVsZWQgPSB1dGlsXzEuaXNJbnQodXRpbF8xLmRpdmlkZUR1cmF0aW9uQnlEdXJhdGlvbihzbG90SXRlcmF0b3IsIHRoaXMubGFiZWxJbnRlcnZhbCkpOw0KICAgICAgICAgICAgYXhpc0h0bWwgPQ0KICAgICAgICAgICAgICAgICc8dGQgY2xhc3M9ImZjLWF4aXMgZmMtdGltZSAnICsgdGhlbWUuZ2V0Q2xhc3MoJ3dpZGdldENvbnRlbnQnKSArICciICcgKyB2aWV3LmF4aXNTdHlsZUF0dHIoKSArICc+JyArDQogICAgICAgICAgICAgICAgICAgIChpc0xhYmVsZWQgPw0KICAgICAgICAgICAgICAgICAgICAgICAgJzxzcGFuPicgKyAvLyBmb3IgbWF0Y2hDZWxsV2lkdGhzDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXRpbF8xLmh0bWxFc2NhcGUoc2xvdERhdGUuZm9ybWF0KHRoaXMubGFiZWxGb3JtYXQpKSArDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvc3Bhbj4nIDoNCiAgICAgICAgICAgICAgICAgICAgICAgICcnKSArDQogICAgICAgICAgICAgICAgICAgICc8L3RkPic7DQogICAgICAgICAgICBodG1sICs9DQogICAgICAgICAgICAgICAgJzx0ciBkYXRhLXRpbWU9IicgKyBzbG90RGF0ZS5mb3JtYXQoJ0hIOm1tOnNzJykgKyAnIicgKw0KICAgICAgICAgICAgICAgICAgICAoaXNMYWJlbGVkID8gJycgOiAnIGNsYXNzPSJmYy1taW5vciInKSArDQogICAgICAgICAgICAgICAgICAgICc+JyArDQogICAgICAgICAgICAgICAgICAgICghaXNSVEwgPyBheGlzSHRtbCA6ICcnKSArDQogICAgICAgICAgICAgICAgICAgICc8dGQgY2xhc3M9IicgKyB0aGVtZS5nZXRDbGFzcygnd2lkZ2V0Q29udGVudCcpICsgJyIvPicgKw0KICAgICAgICAgICAgICAgICAgICAoaXNSVEwgPyBheGlzSHRtbCA6ICcnKSArDQogICAgICAgICAgICAgICAgICAgICc8L3RyPic7DQogICAgICAgICAgICBzbG90VGltZS5hZGQodGhpcy5zbG90RHVyYXRpb24pOw0KICAgICAgICAgICAgc2xvdEl0ZXJhdG9yLmFkZCh0aGlzLnNsb3REdXJhdGlvbik7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGh0bWw7DQogICAgfTsNCiAgICBUaW1lR3JpZC5wcm90b3R5cGUucmVuZGVyQ29sdW1ucyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIGRhdGVQcm9maWxlID0gdGhpcy5kYXRlUHJvZmlsZTsNCiAgICAgICAgdmFyIHRoZW1lID0gdGhpcy52aWV3LmNhbGVuZGFyLnRoZW1lOw0KICAgICAgICB0aGlzLmRheVJhbmdlcyA9IHRoaXMuZGF5RGF0ZXMubWFwKGZ1bmN0aW9uIChkYXlEYXRlKSB7DQogICAgICAgICAgICByZXR1cm4gbmV3IFVuem9uZWRSYW5nZV8xLmRlZmF1bHQoZGF5RGF0ZS5jbG9uZSgpLmFkZChkYXRlUHJvZmlsZS5taW5UaW1lKSwgZGF5RGF0ZS5jbG9uZSgpLmFkZChkYXRlUHJvZmlsZS5tYXhUaW1lKSk7DQogICAgICAgIH0pOw0KICAgICAgICBpZiAodGhpcy5oZWFkQ29udGFpbmVyRWwpIHsNCiAgICAgICAgICAgIHRoaXMuaGVhZENvbnRhaW5lckVsLmh0bWwodGhpcy5yZW5kZXJIZWFkSHRtbCgpKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmVsLmZpbmQoJz4gLmZjLWJnJykuaHRtbCgnPHRhYmxlIGNsYXNzPSInICsgdGhlbWUuZ2V0Q2xhc3MoJ3RhYmxlR3JpZCcpICsgJyI+JyArDQogICAgICAgICAgICB0aGlzLnJlbmRlckJnVHJIdG1sKDApICsgLy8gcm93PTANCiAgICAgICAgICAgICc8L3RhYmxlPicpOw0KICAgICAgICB0aGlzLmNvbEVscyA9IHRoaXMuZWwuZmluZCgnLmZjLWRheSwgLmZjLWRpc2FibGVkLWRheScpOw0KICAgICAgICB0aGlzLmNvbENvb3JkQ2FjaGUgPSBuZXcgQ29vcmRDYWNoZV8xLmRlZmF1bHQoew0KICAgICAgICAgICAgZWxzOiB0aGlzLmNvbEVscywNCiAgICAgICAgICAgIGlzSG9yaXpvbnRhbDogdHJ1ZQ0KICAgICAgICB9KTsNCiAgICAgICAgdGhpcy5yZW5kZXJDb250ZW50U2tlbGV0b24oKTsNCiAgICB9Ow0KICAgIFRpbWVHcmlkLnByb3RvdHlwZS51bnJlbmRlckNvbHVtbnMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMudW5yZW5kZXJDb250ZW50U2tlbGV0b24oKTsNCiAgICB9Ow0KICAgIC8qIENvbnRlbnQgU2tlbGV0b24NCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KICAgIC8vIFJlbmRlcnMgdGhlIERPTSB0aGF0IHRoZSB2aWV3J3MgY29udGVudCB3aWxsIGxpdmUgaW4NCiAgICBUaW1lR3JpZC5wcm90b3R5cGUucmVuZGVyQ29udGVudFNrZWxldG9uID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgY2VsbEh0bWwgPSAnJzsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIHZhciBza2VsZXRvbkVsOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5jb2xDbnQ7IGkrKykgew0KICAgICAgICAgICAgY2VsbEh0bWwgKz0NCiAgICAgICAgICAgICAgICAnPHRkPicgKw0KICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iZmMtY29udGVudC1jb2wiPicgKw0KICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iZmMtZXZlbnQtY29udGFpbmVyIGZjLWhlbHBlci1jb250YWluZXIiPjwvZGl2PicgKw0KICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iZmMtZXZlbnQtY29udGFpbmVyIj48L2Rpdj4nICsNCiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImZjLWhpZ2hsaWdodC1jb250YWluZXIiPjwvZGl2PicgKw0KICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iZmMtYmdldmVudC1jb250YWluZXIiPjwvZGl2PicgKw0KICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iZmMtYnVzaW5lc3MtY29udGFpbmVyIj48L2Rpdj4nICsNCiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgKw0KICAgICAgICAgICAgICAgICAgICAnPC90ZD4nOw0KICAgICAgICB9DQogICAgICAgIHNrZWxldG9uRWwgPSB0aGlzLmNvbnRlbnRTa2VsZXRvbkVsID0gJCgnPGRpdiBjbGFzcz0iZmMtY29udGVudC1za2VsZXRvbiI+JyArDQogICAgICAgICAgICAnPHRhYmxlPicgKw0KICAgICAgICAgICAgJzx0cj4nICsgY2VsbEh0bWwgKyAnPC90cj4nICsNCiAgICAgICAgICAgICc8L3RhYmxlPicgKw0KICAgICAgICAgICAgJzwvZGl2PicpOw0KICAgICAgICB0aGlzLmNvbENvbnRhaW5lckVscyA9IHNrZWxldG9uRWwuZmluZCgnLmZjLWNvbnRlbnQtY29sJyk7DQogICAgICAgIHRoaXMuaGVscGVyQ29udGFpbmVyRWxzID0gc2tlbGV0b25FbC5maW5kKCcuZmMtaGVscGVyLWNvbnRhaW5lcicpOw0KICAgICAgICB0aGlzLmZnQ29udGFpbmVyRWxzID0gc2tlbGV0b25FbC5maW5kKCcuZmMtZXZlbnQtY29udGFpbmVyOm5vdCguZmMtaGVscGVyLWNvbnRhaW5lciknKTsNCiAgICAgICAgdGhpcy5iZ0NvbnRhaW5lckVscyA9IHNrZWxldG9uRWwuZmluZCgnLmZjLWJnZXZlbnQtY29udGFpbmVyJyk7DQogICAgICAgIHRoaXMuaGlnaGxpZ2h0Q29udGFpbmVyRWxzID0gc2tlbGV0b25FbC5maW5kKCcuZmMtaGlnaGxpZ2h0LWNvbnRhaW5lcicpOw0KICAgICAgICB0aGlzLmJ1c2luZXNzQ29udGFpbmVyRWxzID0gc2tlbGV0b25FbC5maW5kKCcuZmMtYnVzaW5lc3MtY29udGFpbmVyJyk7DQogICAgICAgIHRoaXMuYm9va2VuZENlbGxzKHNrZWxldG9uRWwuZmluZCgndHInKSk7IC8vIFRPRE86IGRvIHRoaXMgb24gc3RyaW5nIGxldmVsDQogICAgICAgIHRoaXMuZWwuYXBwZW5kKHNrZWxldG9uRWwpOw0KICAgIH07DQogICAgVGltZUdyaWQucHJvdG90eXBlLnVucmVuZGVyQ29udGVudFNrZWxldG9uID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5jb250ZW50U2tlbGV0b25FbCkgew0KICAgICAgICAgICAgdGhpcy5jb250ZW50U2tlbGV0b25FbC5yZW1vdmUoKTsNCiAgICAgICAgICAgIHRoaXMuY29udGVudFNrZWxldG9uRWwgPSBudWxsOw0KICAgICAgICAgICAgdGhpcy5jb2xDb250YWluZXJFbHMgPSBudWxsOw0KICAgICAgICAgICAgdGhpcy5oZWxwZXJDb250YWluZXJFbHMgPSBudWxsOw0KICAgICAgICAgICAgdGhpcy5mZ0NvbnRhaW5lckVscyA9IG51bGw7DQogICAgICAgICAgICB0aGlzLmJnQ29udGFpbmVyRWxzID0gbnVsbDsNCiAgICAgICAgICAgIHRoaXMuaGlnaGxpZ2h0Q29udGFpbmVyRWxzID0gbnVsbDsNCiAgICAgICAgICAgIHRoaXMuYnVzaW5lc3NDb250YWluZXJFbHMgPSBudWxsOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBHaXZlbiBhIGZsYXQgYXJyYXkgb2Ygc2VnbWVudHMsIHJldHVybiBhbiBhcnJheSBvZiBzdWItYXJyYXlzLCBncm91cGVkIGJ5IGVhY2ggc2VnbWVudCdzIGNvbA0KICAgIFRpbWVHcmlkLnByb3RvdHlwZS5ncm91cFNlZ3NCeUNvbCA9IGZ1bmN0aW9uIChzZWdzKSB7DQogICAgICAgIHZhciBzZWdzQnlDb2wgPSBbXTsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLmNvbENudDsgaSsrKSB7DQogICAgICAgICAgICBzZWdzQnlDb2wucHVzaChbXSk7DQogICAgICAgIH0NCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlZ3MubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIHNlZ3NCeUNvbFtzZWdzW2ldLmNvbF0ucHVzaChzZWdzW2ldKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gc2Vnc0J5Q29sOw0KICAgIH07DQogICAgLy8gR2l2ZW4gc2VnbWVudHMgZ3JvdXBlZCBieSBjb2x1bW4sIGluc2VydCB0aGUgc2VnbWVudHMnIGVsZW1lbnRzIGludG8gYSBwYXJhbGxlbCBhcnJheSBvZiBjb250YWluZXINCiAgICAvLyBlbGVtZW50cywgZWFjaCBsaXZpbmcgd2l0aGluIGEgY29sdW1uLg0KICAgIFRpbWVHcmlkLnByb3RvdHlwZS5hdHRhY2hTZWdzQnlDb2wgPSBmdW5jdGlvbiAoc2Vnc0J5Q29sLCBjb250YWluZXJFbHMpIHsNCiAgICAgICAgdmFyIGNvbDsNCiAgICAgICAgdmFyIHNlZ3M7DQogICAgICAgIHZhciBpOw0KICAgICAgICBmb3IgKGNvbCA9IDA7IGNvbCA8IHRoaXMuY29sQ250OyBjb2wrKykgew0KICAgICAgICAgICAgc2VncyA9IHNlZ3NCeUNvbFtjb2xdOw0KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlZ3MubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICBjb250YWluZXJFbHMuZXEoY29sKS5hcHBlbmQoc2Vnc1tpXS5lbCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8qIE5vdyBJbmRpY2F0b3INCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KICAgIFRpbWVHcmlkLnByb3RvdHlwZS5nZXROb3dJbmRpY2F0b3JVbml0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gJ21pbnV0ZSc7IC8vIHdpbGwgcmVmcmVzaCBvbiB0aGUgbWludXRlDQogICAgfTsNCiAgICBUaW1lR3JpZC5wcm90b3R5cGUucmVuZGVyTm93SW5kaWNhdG9yID0gZnVuY3Rpb24gKGRhdGUpIHsNCiAgICAgICAgLy8gSEFDSzogaWYgZGF0ZSBjb2x1bW5zIG5vdCByZWFkeSBmb3Igc29tZSByZWFzb24gKHNjaGVkdWxlcikNCiAgICAgICAgaWYgKCF0aGlzLmNvbENvbnRhaW5lckVscykgew0KICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIC8vIHNlZyBzeXN0ZW0gbWlnaHQgYmUgb3ZlcmtpbGwsIGJ1dCBpdCBoYW5kbGVzIHNjZW5hcmlvIHdoZXJlIGxpbmUgbmVlZHMgdG8gYmUgcmVuZGVyZWQNCiAgICAgICAgLy8gIG1vcmUgdGhhbiBvbmNlIGJlY2F1c2Ugb2YgY29sdW1ucyB3aXRoIHRoZSBzYW1lIGRhdGUgKHJlc291cmNlcyBjb2x1bW5zIGZvciBleGFtcGxlKQ0KICAgICAgICB2YXIgc2VncyA9IHRoaXMuY29tcG9uZW50Rm9vdHByaW50VG9TZWdzKG5ldyBDb21wb25lbnRGb290cHJpbnRfMS5kZWZhdWx0KG5ldyBVbnpvbmVkUmFuZ2VfMS5kZWZhdWx0KGRhdGUsIGRhdGUudmFsdWVPZigpICsgMSksIC8vIHByb3RlY3QgYWdhaW5zdCBudWxsIHJhbmdlDQogICAgICAgIGZhbHNlIC8vIGFsbC1kYXkNCiAgICAgICAgKSk7DQogICAgICAgIHZhciB0b3AgPSB0aGlzLmNvbXB1dGVEYXRlVG9wKGRhdGUsIGRhdGUpOw0KICAgICAgICB2YXIgbm9kZXMgPSBbXTsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIC8vIHJlbmRlciBsaW5lcyB3aXRoaW4gdGhlIGNvbHVtbnMNCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlZ3MubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIG5vZGVzLnB1c2goJCgnPGRpdiBjbGFzcz0iZmMtbm93LWluZGljYXRvciBmYy1ub3ctaW5kaWNhdG9yLWxpbmUiPjwvZGl2PicpDQogICAgICAgICAgICAgICAgLmNzcygndG9wJywgdG9wKQ0KICAgICAgICAgICAgICAgIC5hcHBlbmRUbyh0aGlzLmNvbENvbnRhaW5lckVscy5lcShzZWdzW2ldLmNvbCkpWzBdKTsNCiAgICAgICAgfQ0KICAgICAgICAvLyByZW5kZXIgYW4gYXJyb3cgb3ZlciB0aGUgYXhpcw0KICAgICAgICBpZiAoc2Vncy5sZW5ndGggPiAwKSB7DQogICAgICAgICAgICBub2Rlcy5wdXNoKCQoJzxkaXYgY2xhc3M9ImZjLW5vdy1pbmRpY2F0b3IgZmMtbm93LWluZGljYXRvci1hcnJvdyI+PC9kaXY+JykNCiAgICAgICAgICAgICAgICAuY3NzKCd0b3AnLCB0b3ApDQogICAgICAgICAgICAgICAgLmFwcGVuZFRvKHRoaXMuZWwuZmluZCgnLmZjLWNvbnRlbnQtc2tlbGV0b24nKSlbMF0pOw0KICAgICAgICB9DQogICAgICAgIHRoaXMubm93SW5kaWNhdG9yRWxzID0gJChub2Rlcyk7DQogICAgfTsNCiAgICBUaW1lR3JpZC5wcm90b3R5cGUudW5yZW5kZXJOb3dJbmRpY2F0b3IgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICh0aGlzLm5vd0luZGljYXRvckVscykgew0KICAgICAgICAgICAgdGhpcy5ub3dJbmRpY2F0b3JFbHMucmVtb3ZlKCk7DQogICAgICAgICAgICB0aGlzLm5vd0luZGljYXRvckVscyA9IG51bGw7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8qIENvb3JkaW5hdGVzDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICBUaW1lR3JpZC5wcm90b3R5cGUudXBkYXRlU2l6ZSA9IGZ1bmN0aW9uICh0b3RhbEhlaWdodCwgaXNBdXRvLCBpc1Jlc2l6ZSkgew0KICAgICAgICBfc3VwZXIucHJvdG90eXBlLnVwZGF0ZVNpemUuY2FsbCh0aGlzLCB0b3RhbEhlaWdodCwgaXNBdXRvLCBpc1Jlc2l6ZSk7DQogICAgICAgIHRoaXMuc2xhdENvb3JkQ2FjaGUuYnVpbGQoKTsNCiAgICAgICAgaWYgKGlzUmVzaXplKSB7DQogICAgICAgICAgICB0aGlzLnVwZGF0ZVNlZ1ZlcnRpY2FscyhbXS5jb25jYXQodGhpcy5ldmVudFJlbmRlcmVyLmdldFNlZ3MoKSwgdGhpcy5idXNpbmVzc1NlZ3MgfHwgW10pKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgVGltZUdyaWQucHJvdG90eXBlLmdldFRvdGFsU2xhdEhlaWdodCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuc2xhdENvbnRhaW5lckVsLm91dGVySGVpZ2h0KCk7DQogICAgfTsNCiAgICAvLyBDb21wdXRlcyB0aGUgdG9wIGNvb3JkaW5hdGUsIHJlbGF0aXZlIHRvIHRoZSBib3VuZHMgb2YgdGhlIGdyaWQsIG9mIHRoZSBnaXZlbiBkYXRlLg0KICAgIC8vIGBtc2AgY2FuIGJlIGEgbWlsbGlzZWNvbmQgVVRDIHRpbWUgT1IgYSBVVEMgbW9tZW50Lg0KICAgIC8vIEEgYHN0YXJ0T2ZEYXlEYXRlYCBtdXN0IGJlIGdpdmVuIGZvciBhdm9pZGluZyBhbWJpZ3VpdHkgb3ZlciBob3cgdG8gdHJlYXQgbWlkbmlnaHQuDQogICAgVGltZUdyaWQucHJvdG90eXBlLmNvbXB1dGVEYXRlVG9wID0gZnVuY3Rpb24gKG1zLCBzdGFydE9mRGF5RGF0ZSkgew0KICAgICAgICByZXR1cm4gdGhpcy5jb21wdXRlVGltZVRvcChtb21lbnQuZHVyYXRpb24obXMgLSBzdGFydE9mRGF5RGF0ZS5jbG9uZSgpLnN0cmlwVGltZSgpKSk7DQogICAgfTsNCiAgICAvLyBDb21wdXRlcyB0aGUgdG9wIGNvb3JkaW5hdGUsIHJlbGF0aXZlIHRvIHRoZSBib3VuZHMgb2YgdGhlIGdyaWQsIG9mIHRoZSBnaXZlbiB0aW1lIChhIER1cmF0aW9uKS4NCiAgICBUaW1lR3JpZC5wcm90b3R5cGUuY29tcHV0ZVRpbWVUb3AgPSBmdW5jdGlvbiAodGltZSkgew0KICAgICAgICB2YXIgbGVuID0gdGhpcy5zbGF0RWxzLmxlbmd0aDsNCiAgICAgICAgdmFyIGRhdGVQcm9maWxlID0gdGhpcy5kYXRlUHJvZmlsZTsNCiAgICAgICAgdmFyIHNsYXRDb3ZlcmFnZSA9ICh0aW1lIC0gZGF0ZVByb2ZpbGUubWluVGltZSkgLyB0aGlzLnNsb3REdXJhdGlvbjsgLy8gZmxvYXRpbmctcG9pbnQgdmFsdWUgb2YgIyBvZiBzbG90cyBjb3ZlcmVkDQogICAgICAgIHZhciBzbGF0SW5kZXg7DQogICAgICAgIHZhciBzbGF0UmVtYWluZGVyOw0KICAgICAgICAvLyBjb21wdXRlIGEgZmxvYXRpbmctcG9pbnQgbnVtYmVyIGZvciBob3cgbWFueSBzbGF0cyBzaG91bGQgYmUgcHJvZ3Jlc3NlZCB0aHJvdWdoLg0KICAgICAgICAvLyBmcm9tIDAgdG8gbnVtYmVyIG9mIHNsYXRzIChpbmNsdXNpdmUpDQogICAgICAgIC8vIGNvbnN0cmFpbmVkIGJlY2F1c2UgbWluVGltZS9tYXhUaW1lIG1pZ2h0IGJlIGN1c3RvbWl6ZWQuDQogICAgICAgIHNsYXRDb3ZlcmFnZSA9IE1hdGgubWF4KDAsIHNsYXRDb3ZlcmFnZSk7DQogICAgICAgIHNsYXRDb3ZlcmFnZSA9IE1hdGgubWluKGxlbiwgc2xhdENvdmVyYWdlKTsNCiAgICAgICAgLy8gYW4gaW50ZWdlciBpbmRleCBvZiB0aGUgZnVydGhlc3Qgd2hvbGUgc2xhdA0KICAgICAgICAvLyBmcm9tIDAgdG8gbnVtYmVyIHNsYXRzICgqZXhjbHVzaXZlKiwgc28gbGVuLTEpDQogICAgICAgIHNsYXRJbmRleCA9IE1hdGguZmxvb3Ioc2xhdENvdmVyYWdlKTsNCiAgICAgICAgc2xhdEluZGV4ID0gTWF0aC5taW4oc2xhdEluZGV4LCBsZW4gLSAxKTsNCiAgICAgICAgLy8gaG93IG11Y2ggZnVydGhlciB0aHJvdWdoIHRoZSBzbGF0SW5kZXggc2xhdCAoZnJvbSAwLjAtMS4wKSBtdXN0IGJlIGNvdmVyZWQgaW4gYWRkaXRpb24uDQogICAgICAgIC8vIGNvdWxkIGJlIDEuMCBpZiBzbGF0Q292ZXJhZ2UgaXMgY292ZXJpbmcgKmFsbCogdGhlIHNsb3RzDQogICAgICAgIHNsYXRSZW1haW5kZXIgPSBzbGF0Q292ZXJhZ2UgLSBzbGF0SW5kZXg7DQogICAgICAgIHJldHVybiB0aGlzLnNsYXRDb29yZENhY2hlLmdldFRvcFBvc2l0aW9uKHNsYXRJbmRleCkgKw0KICAgICAgICAgICAgdGhpcy5zbGF0Q29vcmRDYWNoZS5nZXRIZWlnaHQoc2xhdEluZGV4KSAqIHNsYXRSZW1haW5kZXI7DQogICAgfTsNCiAgICAvLyBSZWZyZXNoZXMgdGhlIENTUyB0b3AvYm90dG9tIGNvb3JkaW5hdGVzIGZvciBlYWNoIHNlZ21lbnQgZWxlbWVudC4NCiAgICAvLyBXb3JrcyB3aGVuIGNhbGxlZCBhZnRlciBpbml0aWFsIHJlbmRlciwgYWZ0ZXIgYSB3aW5kb3cgcmVzaXplL3pvb20gZm9yIGV4YW1wbGUuDQogICAgVGltZUdyaWQucHJvdG90eXBlLnVwZGF0ZVNlZ1ZlcnRpY2FscyA9IGZ1bmN0aW9uIChzZWdzKSB7DQogICAgICAgIHRoaXMuY29tcHV0ZVNlZ1ZlcnRpY2FscyhzZWdzKTsNCiAgICAgICAgdGhpcy5hc3NpZ25TZWdWZXJ0aWNhbHMoc2Vncyk7DQogICAgfTsNCiAgICAvLyBGb3IgZWFjaCBzZWdtZW50IGluIGFuIGFycmF5LCBjb21wdXRlcyBhbmQgYXNzaWducyBpdHMgdG9wIGFuZCBib3R0b20gcHJvcGVydGllcw0KICAgIFRpbWVHcmlkLnByb3RvdHlwZS5jb21wdXRlU2VnVmVydGljYWxzID0gZnVuY3Rpb24gKHNlZ3MpIHsNCiAgICAgICAgdmFyIGV2ZW50TWluSGVpZ2h0ID0gdGhpcy5vcHQoJ2FnZW5kYUV2ZW50TWluSGVpZ2h0Jyk7DQogICAgICAgIHZhciBpOw0KICAgICAgICB2YXIgc2VnOw0KICAgICAgICB2YXIgZGF5RGF0ZTsNCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlZ3MubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIHNlZyA9IHNlZ3NbaV07DQogICAgICAgICAgICBkYXlEYXRlID0gdGhpcy5kYXlEYXRlc1tzZWcuZGF5SW5kZXhdOw0KICAgICAgICAgICAgc2VnLnRvcCA9IHRoaXMuY29tcHV0ZURhdGVUb3Aoc2VnLnN0YXJ0TXMsIGRheURhdGUpOw0KICAgICAgICAgICAgc2VnLmJvdHRvbSA9IE1hdGgubWF4KHNlZy50b3AgKyBldmVudE1pbkhlaWdodCwgdGhpcy5jb21wdXRlRGF0ZVRvcChzZWcuZW5kTXMsIGRheURhdGUpKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gR2l2ZW4gc2VnbWVudHMgdGhhdCBhbHJlYWR5IGhhdmUgdGhlaXIgdG9wL2JvdHRvbSBwcm9wZXJ0aWVzIGNvbXB1dGVkLCBhcHBsaWVzIHRob3NlIHZhbHVlcyB0bw0KICAgIC8vIHRoZSBzZWdtZW50cycgZWxlbWVudHMuDQogICAgVGltZUdyaWQucHJvdG90eXBlLmFzc2lnblNlZ1ZlcnRpY2FscyA9IGZ1bmN0aW9uIChzZWdzKSB7DQogICAgICAgIHZhciBpOw0KICAgICAgICB2YXIgc2VnOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2Vncy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgc2VnID0gc2Vnc1tpXTsNCiAgICAgICAgICAgIHNlZy5lbC5jc3ModGhpcy5nZW5lcmF0ZVNlZ1ZlcnRpY2FsQ3NzKHNlZykpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBHZW5lcmF0ZXMgYW4gb2JqZWN0IHdpdGggQ1NTIHByb3BlcnRpZXMgZm9yIHRoZSB0b3AvYm90dG9tIGNvb3JkaW5hdGVzIG9mIGEgc2VnbWVudCBlbGVtZW50DQogICAgVGltZUdyaWQucHJvdG90eXBlLmdlbmVyYXRlU2VnVmVydGljYWxDc3MgPSBmdW5jdGlvbiAoc2VnKSB7DQogICAgICAgIHJldHVybiB7DQogICAgICAgICAgICB0b3A6IHNlZy50b3AsDQogICAgICAgICAgICBib3R0b206IC1zZWcuYm90dG9tIC8vIGZsaXBwZWQgYmVjYXVzZSBuZWVkcyB0byBiZSBzcGFjZSBiZXlvbmQgYm90dG9tIGVkZ2Ugb2YgZXZlbnQgY29udGFpbmVyDQogICAgICAgIH07DQogICAgfTsNCiAgICAvKiBIaXQgU3lzdGVtDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICBUaW1lR3JpZC5wcm90b3R5cGUucHJlcGFyZUhpdHMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMuY29sQ29vcmRDYWNoZS5idWlsZCgpOw0KICAgICAgICB0aGlzLnNsYXRDb29yZENhY2hlLmJ1aWxkKCk7DQogICAgfTsNCiAgICBUaW1lR3JpZC5wcm90b3R5cGUucmVsZWFzZUhpdHMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMuY29sQ29vcmRDYWNoZS5jbGVhcigpOw0KICAgICAgICAvLyBOT1RFOiBkb24ndCBjbGVhciBzbGF0Q29vcmRDYWNoZSBiZWNhdXNlIHdlIHJlbHkgb24gaXQgZm9yIGNvbXB1dGVUaW1lVG9wDQogICAgfTsNCiAgICBUaW1lR3JpZC5wcm90b3R5cGUucXVlcnlIaXQgPSBmdW5jdGlvbiAobGVmdE9mZnNldCwgdG9wT2Zmc2V0KSB7DQogICAgICAgIHZhciBzbmFwc1BlclNsb3QgPSB0aGlzLnNuYXBzUGVyU2xvdDsNCiAgICAgICAgdmFyIGNvbENvb3JkQ2FjaGUgPSB0aGlzLmNvbENvb3JkQ2FjaGU7DQogICAgICAgIHZhciBzbGF0Q29vcmRDYWNoZSA9IHRoaXMuc2xhdENvb3JkQ2FjaGU7DQogICAgICAgIGlmIChjb2xDb29yZENhY2hlLmlzTGVmdEluQm91bmRzKGxlZnRPZmZzZXQpICYmIHNsYXRDb29yZENhY2hlLmlzVG9wSW5Cb3VuZHModG9wT2Zmc2V0KSkgew0KICAgICAgICAgICAgdmFyIGNvbEluZGV4ID0gY29sQ29vcmRDYWNoZS5nZXRIb3Jpem9udGFsSW5kZXgobGVmdE9mZnNldCk7DQogICAgICAgICAgICB2YXIgc2xhdEluZGV4ID0gc2xhdENvb3JkQ2FjaGUuZ2V0VmVydGljYWxJbmRleCh0b3BPZmZzZXQpOw0KICAgICAgICAgICAgaWYgKGNvbEluZGV4ICE9IG51bGwgJiYgc2xhdEluZGV4ICE9IG51bGwpIHsNCiAgICAgICAgICAgICAgICB2YXIgc2xhdFRvcCA9IHNsYXRDb29yZENhY2hlLmdldFRvcE9mZnNldChzbGF0SW5kZXgpOw0KICAgICAgICAgICAgICAgIHZhciBzbGF0SGVpZ2h0ID0gc2xhdENvb3JkQ2FjaGUuZ2V0SGVpZ2h0KHNsYXRJbmRleCk7DQogICAgICAgICAgICAgICAgdmFyIHBhcnRpYWwgPSAodG9wT2Zmc2V0IC0gc2xhdFRvcCkgLyBzbGF0SGVpZ2h0OyAvLyBmbG9hdGluZyBwb2ludCBudW1iZXIgYmV0d2VlbiAwIGFuZCAxDQogICAgICAgICAgICAgICAgdmFyIGxvY2FsU25hcEluZGV4ID0gTWF0aC5mbG9vcihwYXJ0aWFsICogc25hcHNQZXJTbG90KTsgLy8gdGhlIHNuYXAgIyByZWxhdGl2ZSB0byBzdGFydCBvZiBzbGF0DQogICAgICAgICAgICAgICAgdmFyIHNuYXBJbmRleCA9IHNsYXRJbmRleCAqIHNuYXBzUGVyU2xvdCArIGxvY2FsU25hcEluZGV4Ow0KICAgICAgICAgICAgICAgIHZhciBzbmFwVG9wID0gc2xhdFRvcCArIChsb2NhbFNuYXBJbmRleCAvIHNuYXBzUGVyU2xvdCkgKiBzbGF0SGVpZ2h0Ow0KICAgICAgICAgICAgICAgIHZhciBzbmFwQm90dG9tID0gc2xhdFRvcCArICgobG9jYWxTbmFwSW5kZXggKyAxKSAvIHNuYXBzUGVyU2xvdCkgKiBzbGF0SGVpZ2h0Ow0KICAgICAgICAgICAgICAgIHJldHVybiB7DQogICAgICAgICAgICAgICAgICAgIGNvbDogY29sSW5kZXgsDQogICAgICAgICAgICAgICAgICAgIHNuYXA6IHNuYXBJbmRleCwNCiAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50OiB0aGlzLA0KICAgICAgICAgICAgICAgICAgICBsZWZ0OiBjb2xDb29yZENhY2hlLmdldExlZnRPZmZzZXQoY29sSW5kZXgpLA0KICAgICAgICAgICAgICAgICAgICByaWdodDogY29sQ29vcmRDYWNoZS5nZXRSaWdodE9mZnNldChjb2xJbmRleCksDQogICAgICAgICAgICAgICAgICAgIHRvcDogc25hcFRvcCwNCiAgICAgICAgICAgICAgICAgICAgYm90dG9tOiBzbmFwQm90dG9tDQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH07DQogICAgVGltZUdyaWQucHJvdG90eXBlLmdldEhpdEZvb3RwcmludCA9IGZ1bmN0aW9uIChoaXQpIHsNCiAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5nZXRDZWxsRGF0ZSgwLCBoaXQuY29sKTsgLy8gcm93PTANCiAgICAgICAgdmFyIHRpbWUgPSB0aGlzLmNvbXB1dGVTbmFwVGltZShoaXQuc25hcCk7IC8vIHBhc3MgaW4gdGhlIHNuYXAtaW5kZXgNCiAgICAgICAgdmFyIGVuZDsNCiAgICAgICAgc3RhcnQudGltZSh0aW1lKTsNCiAgICAgICAgZW5kID0gc3RhcnQuY2xvbmUoKS5hZGQodGhpcy5zbmFwRHVyYXRpb24pOw0KICAgICAgICByZXR1cm4gbmV3IENvbXBvbmVudEZvb3RwcmludF8xLmRlZmF1bHQobmV3IFVuem9uZWRSYW5nZV8xLmRlZmF1bHQoc3RhcnQsIGVuZCksIGZhbHNlIC8vIGFsbC1kYXk/DQogICAgICAgICk7DQogICAgfTsNCiAgICAvLyBHaXZlbiBhIHJvdyBudW1iZXIgb2YgdGhlIGdyaWQsIHJlcHJlc2VudGluZyBhICJzbmFwIiwgcmV0dXJucyBhIHRpbWUgKER1cmF0aW9uKSBmcm9tIGl0cyBzdGFydC1vZi1kYXkNCiAgICBUaW1lR3JpZC5wcm90b3R5cGUuY29tcHV0ZVNuYXBUaW1lID0gZnVuY3Rpb24gKHNuYXBJbmRleCkgew0KICAgICAgICByZXR1cm4gbW9tZW50LmR1cmF0aW9uKHRoaXMuZGF0ZVByb2ZpbGUubWluVGltZSArIHRoaXMuc25hcER1cmF0aW9uICogc25hcEluZGV4KTsNCiAgICB9Ow0KICAgIFRpbWVHcmlkLnByb3RvdHlwZS5nZXRIaXRFbCA9IGZ1bmN0aW9uIChoaXQpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuY29sRWxzLmVxKGhpdC5jb2wpOw0KICAgIH07DQogICAgLyogRXZlbnQgRHJhZyBWaXN1YWxpemF0aW9uDQogICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCiAgICAvLyBSZW5kZXJzIGEgdmlzdWFsIGluZGljYXRpb24gb2YgYW4gZXZlbnQgYmVpbmcgZHJhZ2dlZCBvdmVyIHRoZSBzcGVjaWZpZWQgZGF0ZShzKS4NCiAgICAvLyBBIHJldHVybmVkIHZhbHVlIG9mIGB0cnVlYCBzaWduYWxzIHRoYXQgYSBtb2NrICJoZWxwZXIiIGV2ZW50IGhhcyBiZWVuIHJlbmRlcmVkLg0KICAgIFRpbWVHcmlkLnByb3RvdHlwZS5yZW5kZXJEcmFnID0gZnVuY3Rpb24gKGV2ZW50Rm9vdHByaW50cywgc2VnLCBpc1RvdWNoKSB7DQogICAgICAgIHZhciBpOw0KICAgICAgICBpZiAoc2VnKSB7DQogICAgICAgICAgICBpZiAoZXZlbnRGb290cHJpbnRzLmxlbmd0aCkgew0KICAgICAgICAgICAgICAgIHRoaXMuaGVscGVyUmVuZGVyZXIucmVuZGVyRXZlbnREcmFnZ2luZ0Zvb3RwcmludHMoZXZlbnRGb290cHJpbnRzLCBzZWcsIGlzVG91Y2gpOw0KICAgICAgICAgICAgICAgIC8vIHNpZ25hbCB0aGF0IGEgaGVscGVyIGhhcyBiZWVuIHJlbmRlcmVkDQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZXZlbnRGb290cHJpbnRzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJIaWdobGlnaHQoZXZlbnRGb290cHJpbnRzW2ldLmNvbXBvbmVudEZvb3RwcmludCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIFVucmVuZGVycyBhbnkgdmlzdWFsIGluZGljYXRpb24gb2YgYW4gZXZlbnQgYmVpbmcgZHJhZ2dlZA0KICAgIFRpbWVHcmlkLnByb3RvdHlwZS51bnJlbmRlckRyYWcgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMudW5yZW5kZXJIaWdobGlnaHQoKTsNCiAgICAgICAgdGhpcy5oZWxwZXJSZW5kZXJlci51bnJlbmRlcigpOw0KICAgIH07DQogICAgLyogRXZlbnQgUmVzaXplIFZpc3VhbGl6YXRpb24NCiAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLw0KICAgIC8vIFJlbmRlcnMgYSB2aXN1YWwgaW5kaWNhdGlvbiBvZiBhbiBldmVudCBiZWluZyByZXNpemVkDQogICAgVGltZUdyaWQucHJvdG90eXBlLnJlbmRlckV2ZW50UmVzaXplID0gZnVuY3Rpb24gKGV2ZW50Rm9vdHByaW50cywgc2VnLCBpc1RvdWNoKSB7DQogICAgICAgIHRoaXMuaGVscGVyUmVuZGVyZXIucmVuZGVyRXZlbnRSZXNpemluZ0Zvb3RwcmludHMoZXZlbnRGb290cHJpbnRzLCBzZWcsIGlzVG91Y2gpOw0KICAgIH07DQogICAgLy8gVW5yZW5kZXJzIGFueSB2aXN1YWwgaW5kaWNhdGlvbiBvZiBhbiBldmVudCBiZWluZyByZXNpemVkDQogICAgVGltZUdyaWQucHJvdG90eXBlLnVucmVuZGVyRXZlbnRSZXNpemUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMuaGVscGVyUmVuZGVyZXIudW5yZW5kZXIoKTsNCiAgICB9Ow0KICAgIC8qIFNlbGVjdGlvbg0KICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQogICAgLy8gUmVuZGVycyBhIHZpc3VhbCBpbmRpY2F0aW9uIG9mIGEgc2VsZWN0aW9uLiBPdmVycmlkZXMgdGhlIGRlZmF1bHQsIHdoaWNoIHdhcyB0byBzaW1wbHkgcmVuZGVyIGEgaGlnaGxpZ2h0Lg0KICAgIFRpbWVHcmlkLnByb3RvdHlwZS5yZW5kZXJTZWxlY3Rpb25Gb290cHJpbnQgPSBmdW5jdGlvbiAoY29tcG9uZW50Rm9vdHByaW50KSB7DQogICAgICAgIGlmICh0aGlzLm9wdCgnc2VsZWN0SGVscGVyJykpIHsNCiAgICAgICAgICAgIHRoaXMuaGVscGVyUmVuZGVyZXIucmVuZGVyQ29tcG9uZW50Rm9vdHByaW50KGNvbXBvbmVudEZvb3RwcmludCk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICB0aGlzLnJlbmRlckhpZ2hsaWdodChjb21wb25lbnRGb290cHJpbnQpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBVbnJlbmRlcnMgYW55IHZpc3VhbCBpbmRpY2F0aW9uIG9mIGEgc2VsZWN0aW9uDQogICAgVGltZUdyaWQucHJvdG90eXBlLnVucmVuZGVyU2VsZWN0aW9uID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLmhlbHBlclJlbmRlcmVyLnVucmVuZGVyKCk7DQogICAgICAgIHRoaXMudW5yZW5kZXJIaWdobGlnaHQoKTsNCiAgICB9Ow0KICAgIHJldHVybiBUaW1lR3JpZDsNCn0oSW50ZXJhY3RpdmVEYXRlQ29tcG9uZW50XzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gVGltZUdyaWQ7DQpUaW1lR3JpZC5wcm90b3R5cGUuZXZlbnRSZW5kZXJlckNsYXNzID0gVGltZUdyaWRFdmVudFJlbmRlcmVyXzEuZGVmYXVsdDsNClRpbWVHcmlkLnByb3RvdHlwZS5idXNpbmVzc0hvdXJSZW5kZXJlckNsYXNzID0gQnVzaW5lc3NIb3VyUmVuZGVyZXJfMS5kZWZhdWx0Ow0KVGltZUdyaWQucHJvdG90eXBlLmhlbHBlclJlbmRlcmVyQ2xhc3MgPSBUaW1lR3JpZEhlbHBlclJlbmRlcmVyXzEuZGVmYXVsdDsNClRpbWVHcmlkLnByb3RvdHlwZS5maWxsUmVuZGVyZXJDbGFzcyA9IFRpbWVHcmlkRmlsbFJlbmRlcmVyXzEuZGVmYXVsdDsNClN0YW5kYXJkSW50ZXJhY3Rpb25zTWl4aW5fMS5kZWZhdWx0Lm1peEludG8oVGltZUdyaWQpOw0KRGF5VGFibGVNaXhpbl8xLmRlZmF1bHQubWl4SW50byhUaW1lR3JpZCk7DQoKCi8qKiovIH0pLAovKiAyMjggKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciBVbnpvbmVkUmFuZ2VfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNSk7DQp2YXIgRGF0ZVByb2ZpbGVHZW5lcmF0b3JfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjIxKTsNCnZhciBCYXNpY1ZpZXdEYXRlUHJvZmlsZUdlbmVyYXRvciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHsNCiAgICB0c2xpYl8xLl9fZXh0ZW5kcyhCYXNpY1ZpZXdEYXRlUHJvZmlsZUdlbmVyYXRvciwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBCYXNpY1ZpZXdEYXRlUHJvZmlsZUdlbmVyYXRvcigpIHsNCiAgICAgICAgcmV0dXJuIF9zdXBlciAhPT0gbnVsbCAmJiBfc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOw0KICAgIH0NCiAgICAvLyBDb21wdXRlcyB0aGUgZGF0ZSByYW5nZSB0aGF0IHdpbGwgYmUgcmVuZGVyZWQuDQogICAgQmFzaWNWaWV3RGF0ZVByb2ZpbGVHZW5lcmF0b3IucHJvdG90eXBlLmJ1aWxkUmVuZGVyUmFuZ2UgPSBmdW5jdGlvbiAoY3VycmVudFVuem9uZWRSYW5nZSwgY3VycmVudFJhbmdlVW5pdCwgaXNSYW5nZUFsbERheSkgew0KICAgICAgICB2YXIgcmVuZGVyVW56b25lZFJhbmdlID0gX3N1cGVyLnByb3RvdHlwZS5idWlsZFJlbmRlclJhbmdlLmNhbGwodGhpcywgY3VycmVudFVuem9uZWRSYW5nZSwgY3VycmVudFJhbmdlVW5pdCwgaXNSYW5nZUFsbERheSk7IC8vIGFuIFVuem9uZWRSYW5nZQ0KICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLm1zVG9VdGNNb21lbnQocmVuZGVyVW56b25lZFJhbmdlLnN0YXJ0TXMsIGlzUmFuZ2VBbGxEYXkpOw0KICAgICAgICB2YXIgZW5kID0gdGhpcy5tc1RvVXRjTW9tZW50KHJlbmRlclVuem9uZWRSYW5nZS5lbmRNcywgaXNSYW5nZUFsbERheSk7DQogICAgICAgIC8vIHllYXIgYW5kIG1vbnRoIHZpZXdzIHNob3VsZCBiZSBhbGlnbmVkIHdpdGggd2Vla3MuIHRoaXMgaXMgYWxyZWFkeSBkb25lIGZvciB3ZWVrDQogICAgICAgIGlmICgvXih5ZWFyfG1vbnRoKSQvLnRlc3QoY3VycmVudFJhbmdlVW5pdCkpIHsNCiAgICAgICAgICAgIHN0YXJ0LnN0YXJ0T2YoJ3dlZWsnKTsNCiAgICAgICAgICAgIC8vIG1ha2UgZW5kLW9mLXdlZWsgaWYgbm90IGFscmVhZHkNCiAgICAgICAgICAgIGlmIChlbmQud2Vla2RheSgpKSB7DQogICAgICAgICAgICAgICAgZW5kLmFkZCgxLCAnd2VlaycpLnN0YXJ0T2YoJ3dlZWsnKTsgLy8gZXhjbHVzaXZlbHkgbW92ZSBiYWNrd2FyZHMNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gbmV3IFVuem9uZWRSYW5nZV8xLmRlZmF1bHQoc3RhcnQsIGVuZCk7DQogICAgfTsNCiAgICByZXR1cm4gQmFzaWNWaWV3RGF0ZVByb2ZpbGVHZW5lcmF0b3I7DQp9KERhdGVQcm9maWxlR2VuZXJhdG9yXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gQmFzaWNWaWV3RGF0ZVByb2ZpbGVHZW5lcmF0b3I7DQoKCi8qKiovIH0pLAovKiAyMjkgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciBtb21lbnQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDApOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgQmFzaWNWaWV3XzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYyKTsNCnZhciBNb250aFZpZXdEYXRlUHJvZmlsZUdlbmVyYXRvcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyNTMpOw0KLyogQSBtb250aCB2aWV3IHdpdGggZGF5IGNlbGxzIHJ1bm5pbmcgaW4gcm93cyAob25lLXBlci13ZWVrKSBhbmQgY29sdW1ucw0KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQp2YXIgTW9udGhWaWV3ID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKE1vbnRoVmlldywgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBNb250aFZpZXcoKSB7DQogICAgICAgIHJldHVybiBfc3VwZXIgIT09IG51bGwgJiYgX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsNCiAgICB9DQogICAgLy8gT3ZlcnJpZGVzIHRoZSBkZWZhdWx0IEJhc2ljVmlldyBiZWhhdmlvciB0byBoYXZlIHNwZWNpYWwgbXVsdGktd2VlayBhdXRvLWhlaWdodCBsb2dpYw0KICAgIE1vbnRoVmlldy5wcm90b3R5cGUuc2V0R3JpZEhlaWdodCA9IGZ1bmN0aW9uIChoZWlnaHQsIGlzQXV0bykgew0KICAgICAgICAvLyBpZiBhdXRvLCBtYWtlIHRoZSBoZWlnaHQgb2YgZWFjaCByb3cgdGhlIGhlaWdodCB0aGF0IGl0IHdvdWxkIGJlIGlmIHRoZXJlIHdlcmUgNiB3ZWVrcw0KICAgICAgICBpZiAoaXNBdXRvKSB7DQogICAgICAgICAgICBoZWlnaHQgKj0gdGhpcy5kYXlHcmlkLnJvd0NudCAvIDY7DQogICAgICAgIH0NCiAgICAgICAgdXRpbF8xLmRpc3RyaWJ1dGVIZWlnaHQodGhpcy5kYXlHcmlkLnJvd0VscywgaGVpZ2h0LCAhaXNBdXRvKTsgLy8gaWYgYXV0bywgZG9uJ3QgY29tcGVuc2F0ZSBmb3IgaGVpZ2h0LWhvZ2dpbmcgcm93cw0KICAgIH07DQogICAgTW9udGhWaWV3LnByb3RvdHlwZS5pc0RhdGVJbk90aGVyTW9udGggPSBmdW5jdGlvbiAoZGF0ZSwgZGF0ZVByb2ZpbGUpIHsNCiAgICAgICAgcmV0dXJuIGRhdGUubW9udGgoKSAhPT0gbW9tZW50LnV0YyhkYXRlUHJvZmlsZS5jdXJyZW50VW56b25lZFJhbmdlLnN0YXJ0TXMpLm1vbnRoKCk7IC8vIFRPRE86IG9wdGltaXplDQogICAgfTsNCiAgICByZXR1cm4gTW9udGhWaWV3Ow0KfShCYXNpY1ZpZXdfMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBNb250aFZpZXc7DQpNb250aFZpZXcucHJvdG90eXBlLmRhdGVQcm9maWxlR2VuZXJhdG9yQ2xhc3MgPSBNb250aFZpZXdEYXRlUHJvZmlsZUdlbmVyYXRvcl8xLmRlZmF1bHQ7DQoKCi8qKiovIH0pLAovKiAyMzAgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCnZhciB1dGlsXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQpOw0KdmFyIFVuem9uZWRSYW5nZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1KTsNCnZhciBWaWV3XzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQxKTsNCnZhciBTY3JvbGxlcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzOSk7DQp2YXIgTGlzdEV2ZW50UmVuZGVyZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjU0KTsNCnZhciBMaXN0RXZlbnRQb2ludGluZ18xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyNTUpOw0KLyoNClJlc3BvbnNpYmxlIGZvciB0aGUgc2Nyb2xsZXIsIGFuZCBmb3J3YXJkaW5nIGV2ZW50LXJlbGF0ZWQgYWN0aW9ucyBpbnRvIHRoZSAiZ3JpZCIuDQoqLw0KdmFyIExpc3RWaWV3ID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKExpc3RWaWV3LCBfc3VwZXIpOw0KICAgIGZ1bmN0aW9uIExpc3RWaWV3KGNhbGVuZGFyLCB2aWV3U3BlYykgew0KICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzLCBjYWxlbmRhciwgdmlld1NwZWMpIHx8IHRoaXM7DQogICAgICAgIF90aGlzLnNlZ1NlbGVjdG9yID0gJy5mYy1saXN0LWl0ZW0nOyAvLyB3aGljaCBlbGVtZW50cyBhY2NlcHQgZXZlbnQgYWN0aW9ucw0KICAgICAgICBfdGhpcy5zY3JvbGxlciA9IG5ldyBTY3JvbGxlcl8xLmRlZmF1bHQoew0KICAgICAgICAgICAgb3ZlcmZsb3dYOiAnaGlkZGVuJywNCiAgICAgICAgICAgIG92ZXJmbG93WTogJ2F1dG8nDQogICAgICAgIH0pOw0KICAgICAgICByZXR1cm4gX3RoaXM7DQogICAgfQ0KICAgIExpc3RWaWV3LnByb3RvdHlwZS5yZW5kZXJTa2VsZXRvbiA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5lbC5hZGRDbGFzcygnZmMtbGlzdC12aWV3ICcgKw0KICAgICAgICAgICAgdGhpcy5jYWxlbmRhci50aGVtZS5nZXRDbGFzcygnbGlzdFZpZXcnKSk7DQogICAgICAgIHRoaXMuc2Nyb2xsZXIucmVuZGVyKCk7DQogICAgICAgIHRoaXMuc2Nyb2xsZXIuZWwuYXBwZW5kVG8odGhpcy5lbCk7DQogICAgICAgIHRoaXMuY29udGVudEVsID0gdGhpcy5zY3JvbGxlci5zY3JvbGxFbDsgLy8gc2hvcnRjdXQNCiAgICB9Ow0KICAgIExpc3RWaWV3LnByb3RvdHlwZS51bnJlbmRlclNrZWxldG9uID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLnNjcm9sbGVyLmRlc3Ryb3koKTsgLy8gd2lsbCByZW1vdmUgdGhlIEdyaWQgdG9vDQogICAgfTsNCiAgICBMaXN0Vmlldy5wcm90b3R5cGUudXBkYXRlU2l6ZSA9IGZ1bmN0aW9uICh0b3RhbEhlaWdodCwgaXNBdXRvLCBpc1Jlc2l6ZSkgew0KICAgICAgICB0aGlzLnNjcm9sbGVyLnNldEhlaWdodCh0aGlzLmNvbXB1dGVTY3JvbGxlckhlaWdodCh0b3RhbEhlaWdodCkpOw0KICAgIH07DQogICAgTGlzdFZpZXcucHJvdG90eXBlLmNvbXB1dGVTY3JvbGxlckhlaWdodCA9IGZ1bmN0aW9uICh0b3RhbEhlaWdodCkgew0KICAgICAgICByZXR1cm4gdG90YWxIZWlnaHQgLQ0KICAgICAgICAgICAgdXRpbF8xLnN1YnRyYWN0SW5uZXJFbEhlaWdodCh0aGlzLmVsLCB0aGlzLnNjcm9sbGVyLmVsKTsgLy8gZXZlcnl0aGluZyB0aGF0J3MgTk9UIHRoZSBzY3JvbGxlcg0KICAgIH07DQogICAgTGlzdFZpZXcucHJvdG90eXBlLnJlbmRlckRhdGVzID0gZnVuY3Rpb24gKGRhdGVQcm9maWxlKSB7DQogICAgICAgIHZhciBjYWxlbmRhciA9IHRoaXMuY2FsZW5kYXI7DQogICAgICAgIHZhciBkYXlTdGFydCA9IGNhbGVuZGFyLm1zVG9VdGNNb21lbnQoZGF0ZVByb2ZpbGUucmVuZGVyVW56b25lZFJhbmdlLnN0YXJ0TXMsIHRydWUpOw0KICAgICAgICB2YXIgdmlld0VuZCA9IGNhbGVuZGFyLm1zVG9VdGNNb21lbnQoZGF0ZVByb2ZpbGUucmVuZGVyVW56b25lZFJhbmdlLmVuZE1zLCB0cnVlKTsNCiAgICAgICAgdmFyIGRheURhdGVzID0gW107DQogICAgICAgIHZhciBkYXlSYW5nZXMgPSBbXTsNCiAgICAgICAgd2hpbGUgKGRheVN0YXJ0IDwgdmlld0VuZCkgew0KICAgICAgICAgICAgZGF5RGF0ZXMucHVzaChkYXlTdGFydC5jbG9uZSgpKTsNCiAgICAgICAgICAgIGRheVJhbmdlcy5wdXNoKG5ldyBVbnpvbmVkUmFuZ2VfMS5kZWZhdWx0KGRheVN0YXJ0LCBkYXlTdGFydC5jbG9uZSgpLmFkZCgxLCAnZGF5JykpKTsNCiAgICAgICAgICAgIGRheVN0YXJ0LmFkZCgxLCAnZGF5Jyk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5kYXlEYXRlcyA9IGRheURhdGVzOw0KICAgICAgICB0aGlzLmRheVJhbmdlcyA9IGRheVJhbmdlczsNCiAgICAgICAgLy8gYWxsIHJlYWwgcmVuZGVyaW5nIGhhcHBlbnMgaW4gRXZlbnRSZW5kZXJlcg0KICAgIH07DQogICAgLy8gc2xpY2VzIGJ5IGRheQ0KICAgIExpc3RWaWV3LnByb3RvdHlwZS5jb21wb25lbnRGb290cHJpbnRUb1NlZ3MgPSBmdW5jdGlvbiAoZm9vdHByaW50KSB7DQogICAgICAgIHZhciBkYXlSYW5nZXMgPSB0aGlzLmRheVJhbmdlczsNCiAgICAgICAgdmFyIGRheUluZGV4Ow0KICAgICAgICB2YXIgc2VnUmFuZ2U7DQogICAgICAgIHZhciBzZWc7DQogICAgICAgIHZhciBzZWdzID0gW107DQogICAgICAgIGZvciAoZGF5SW5kZXggPSAwOyBkYXlJbmRleCA8IGRheVJhbmdlcy5sZW5ndGg7IGRheUluZGV4KyspIHsNCiAgICAgICAgICAgIHNlZ1JhbmdlID0gZm9vdHByaW50LnVuem9uZWRSYW5nZS5pbnRlcnNlY3QoZGF5UmFuZ2VzW2RheUluZGV4XSk7DQogICAgICAgICAgICBpZiAoc2VnUmFuZ2UpIHsNCiAgICAgICAgICAgICAgICBzZWcgPSB7DQogICAgICAgICAgICAgICAgICAgIHN0YXJ0TXM6IHNlZ1JhbmdlLnN0YXJ0TXMsDQogICAgICAgICAgICAgICAgICAgIGVuZE1zOiBzZWdSYW5nZS5lbmRNcywNCiAgICAgICAgICAgICAgICAgICAgaXNTdGFydDogc2VnUmFuZ2UuaXNTdGFydCwNCiAgICAgICAgICAgICAgICAgICAgaXNFbmQ6IHNlZ1JhbmdlLmlzRW5kLA0KICAgICAgICAgICAgICAgICAgICBkYXlJbmRleDogZGF5SW5kZXgNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIHNlZ3MucHVzaChzZWcpOw0KICAgICAgICAgICAgICAgIC8vIGRldGVjdCB3aGVuIGZvb3RwcmludCB3b24ndCBnbyBmdWxseSBpbnRvIHRoZSBuZXh0IGRheSwNCiAgICAgICAgICAgICAgICAvLyBhbmQgbXV0YXRlIHRoZSBsYXRlc3Qgc2VnIHRvIHRoZSBiZSB0aGUgZW5kLg0KICAgICAgICAgICAgICAgIGlmICghc2VnLmlzRW5kICYmICFmb290cHJpbnQuaXNBbGxEYXkgJiYNCiAgICAgICAgICAgICAgICAgICAgZGF5SW5kZXggKyAxIDwgZGF5UmFuZ2VzLmxlbmd0aCAmJg0KICAgICAgICAgICAgICAgICAgICBmb290cHJpbnQudW56b25lZFJhbmdlLmVuZE1zIDwgZGF5UmFuZ2VzW2RheUluZGV4ICsgMV0uc3RhcnRNcyArIHRoaXMubmV4dERheVRocmVzaG9sZCkgew0KICAgICAgICAgICAgICAgICAgICBzZWcuZW5kTXMgPSBmb290cHJpbnQudW56b25lZFJhbmdlLmVuZE1zOw0KICAgICAgICAgICAgICAgICAgICBzZWcuaXNFbmQgPSB0cnVlOw0KICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHNlZ3M7DQogICAgfTsNCiAgICBMaXN0Vmlldy5wcm90b3R5cGUucmVuZGVyRW1wdHlNZXNzYWdlID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLmNvbnRlbnRFbC5odG1sKCc8ZGl2IGNsYXNzPSJmYy1saXN0LWVtcHR5LXdyYXAyIj4nICsgLy8gVE9ETzogdHJ5IGxlc3Mgd3JhcHMNCiAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJmYy1saXN0LWVtcHR5LXdyYXAxIj4nICsNCiAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJmYy1saXN0LWVtcHR5Ij4nICsNCiAgICAgICAgICAgIHV0aWxfMS5odG1sRXNjYXBlKHRoaXMub3B0KCdub0V2ZW50c01lc3NhZ2UnKSkgKw0KICAgICAgICAgICAgJzwvZGl2PicgKw0KICAgICAgICAgICAgJzwvZGl2PicgKw0KICAgICAgICAgICAgJzwvZGl2PicpOw0KICAgIH07DQogICAgLy8gcmVuZGVyIHRoZSBldmVudCBzZWdtZW50cyBpbiB0aGUgdmlldw0KICAgIExpc3RWaWV3LnByb3RvdHlwZS5yZW5kZXJTZWdMaXN0ID0gZnVuY3Rpb24gKGFsbFNlZ3MpIHsNCiAgICAgICAgdmFyIHNlZ3NCeURheSA9IHRoaXMuZ3JvdXBTZWdzQnlEYXkoYWxsU2Vncyk7IC8vIHNwYXJzZSBhcnJheQ0KICAgICAgICB2YXIgZGF5SW5kZXg7DQogICAgICAgIHZhciBkYXlTZWdzOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgdmFyIHRhYmxlRWwgPSAkKCc8dGFibGUgY2xhc3M9ImZjLWxpc3QtdGFibGUgJyArIHRoaXMuY2FsZW5kYXIudGhlbWUuZ2V0Q2xhc3MoJ3RhYmxlTGlzdCcpICsgJyI+PHRib2R5Lz48L3RhYmxlPicpOw0KICAgICAgICB2YXIgdGJvZHlFbCA9IHRhYmxlRWwuZmluZCgndGJvZHknKTsNCiAgICAgICAgZm9yIChkYXlJbmRleCA9IDA7IGRheUluZGV4IDwgc2Vnc0J5RGF5Lmxlbmd0aDsgZGF5SW5kZXgrKykgew0KICAgICAgICAgICAgZGF5U2VncyA9IHNlZ3NCeURheVtkYXlJbmRleF07DQogICAgICAgICAgICBpZiAoZGF5U2Vncykgew0KICAgICAgICAgICAgICAgIC8vIGFwcGVuZCBhIGRheSBoZWFkZXINCiAgICAgICAgICAgICAgICB0Ym9keUVsLmFwcGVuZCh0aGlzLmRheUhlYWRlckh0bWwodGhpcy5kYXlEYXRlc1tkYXlJbmRleF0pKTsNCiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50UmVuZGVyZXIuc29ydEV2ZW50U2VncyhkYXlTZWdzKTsNCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZGF5U2Vncy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgICAgICB0Ym9keUVsLmFwcGVuZChkYXlTZWdzW2ldLmVsKTsgLy8gYXBwZW5kIGV2ZW50IHJvdw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmNvbnRlbnRFbC5lbXB0eSgpLmFwcGVuZCh0YWJsZUVsKTsNCiAgICB9Ow0KICAgIC8vIFJldHVybnMgYSBzcGFyc2UgYXJyYXkgb2YgYXJyYXlzLCBzZWdzIGdyb3VwZWQgYnkgdGhlaXIgZGF5SW5kZXgNCiAgICBMaXN0Vmlldy5wcm90b3R5cGUuZ3JvdXBTZWdzQnlEYXkgPSBmdW5jdGlvbiAoc2Vncykgew0KICAgICAgICB2YXIgc2Vnc0J5RGF5ID0gW107IC8vIHNwYXJzZSBhcnJheQ0KICAgICAgICB2YXIgaTsNCiAgICAgICAgdmFyIHNlZzsNCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlZ3MubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIHNlZyA9IHNlZ3NbaV07DQogICAgICAgICAgICAoc2Vnc0J5RGF5W3NlZy5kYXlJbmRleF0gfHwgKHNlZ3NCeURheVtzZWcuZGF5SW5kZXhdID0gW10pKQ0KICAgICAgICAgICAgICAgIC5wdXNoKHNlZyk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHNlZ3NCeURheTsNCiAgICB9Ow0KICAgIC8vIGdlbmVyYXRlcyB0aGUgSFRNTCBmb3IgdGhlIGRheSBoZWFkZXJzIHRoYXQgbGl2ZSBhbW9uZ3N0IHRoZSBldmVudCByb3dzDQogICAgTGlzdFZpZXcucHJvdG90eXBlLmRheUhlYWRlckh0bWwgPSBmdW5jdGlvbiAoZGF5RGF0ZSkgew0KICAgICAgICB2YXIgbWFpbkZvcm1hdCA9IHRoaXMub3B0KCdsaXN0RGF5Rm9ybWF0Jyk7DQogICAgICAgIHZhciBhbHRGb3JtYXQgPSB0aGlzLm9wdCgnbGlzdERheUFsdEZvcm1hdCcpOw0KICAgICAgICByZXR1cm4gJzx0ciBjbGFzcz0iZmMtbGlzdC1oZWFkaW5nIiBkYXRhLWRhdGU9IicgKyBkYXlEYXRlLmZvcm1hdCgnWVlZWS1NTS1ERCcpICsgJyI+JyArDQogICAgICAgICAgICAnPHRkIGNsYXNzPSInICsgdGhpcy5jYWxlbmRhci50aGVtZS5nZXRDbGFzcygnd2lkZ2V0SGVhZGVyJykgKyAnIiBjb2xzcGFuPSIzIj4nICsNCiAgICAgICAgICAgIChtYWluRm9ybWF0ID8NCiAgICAgICAgICAgICAgICB0aGlzLmJ1aWxkR290b0FuY2hvckh0bWwoZGF5RGF0ZSwgeyAnY2xhc3MnOiAnZmMtbGlzdC1oZWFkaW5nLW1haW4nIH0sIHV0aWxfMS5odG1sRXNjYXBlKGRheURhdGUuZm9ybWF0KG1haW5Gb3JtYXQpKSAvLyBpbm5lciBIVE1MDQogICAgICAgICAgICAgICAgKSA6DQogICAgICAgICAgICAgICAgJycpICsNCiAgICAgICAgICAgIChhbHRGb3JtYXQgPw0KICAgICAgICAgICAgICAgIHRoaXMuYnVpbGRHb3RvQW5jaG9ySHRtbChkYXlEYXRlLCB7ICdjbGFzcyc6ICdmYy1saXN0LWhlYWRpbmctYWx0JyB9LCB1dGlsXzEuaHRtbEVzY2FwZShkYXlEYXRlLmZvcm1hdChhbHRGb3JtYXQpKSAvLyBpbm5lciBIVE1MDQogICAgICAgICAgICAgICAgKSA6DQogICAgICAgICAgICAgICAgJycpICsNCiAgICAgICAgICAgICc8L3RkPicgKw0KICAgICAgICAgICAgJzwvdHI+JzsNCiAgICB9Ow0KICAgIHJldHVybiBMaXN0VmlldzsNCn0oVmlld18xLmRlZmF1bHQpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IExpc3RWaWV3Ow0KTGlzdFZpZXcucHJvdG90eXBlLmV2ZW50UmVuZGVyZXJDbGFzcyA9IExpc3RFdmVudFJlbmRlcmVyXzEuZGVmYXVsdDsNCkxpc3RWaWV3LnByb3RvdHlwZS5ldmVudFBvaW50aW5nQ2xhc3MgPSBMaXN0RXZlbnRQb2ludGluZ18xLmRlZmF1bHQ7DQoKCi8qKiovIH0pLAovKiAyMzEgKi8sCi8qIDIzMiAqLywKLyogMjMzICovLAovKiAyMzQgKi8sCi8qIDIzNSAqLywKLyogMjM2ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCnZhciBleHBvcnRIb29rcyA9IF9fd2VicGFja19yZXF1aXJlX18oMTcpOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgQ2FsZW5kYXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjIwKTsNCi8vIGZvciBpbnRlbnRpb25hbCBzaWRlLWVmZmVjdHMNCl9fd2VicGFja19yZXF1aXJlX18oMTApOw0KX193ZWJwYWNrX3JlcXVpcmVfXyg0Nyk7DQpfX3dlYnBhY2tfcmVxdWlyZV9fKDI1Nik7DQpfX3dlYnBhY2tfcmVxdWlyZV9fKDI1Nyk7DQpfX3dlYnBhY2tfcmVxdWlyZV9fKDI1OSk7DQpfX3dlYnBhY2tfcmVxdWlyZV9fKDI2MCk7DQpfX3dlYnBhY2tfcmVxdWlyZV9fKDI2MSk7DQpfX3dlYnBhY2tfcmVxdWlyZV9fKDI2Mik7DQokLmZ1bGxDYWxlbmRhciA9IGV4cG9ydEhvb2tzOw0KJC5mbi5mdWxsQ2FsZW5kYXIgPSBmdW5jdGlvbiAob3B0aW9ucykgew0KICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsgLy8gZm9yIGEgcG9zc2libGUgbWV0aG9kIGNhbGwNCiAgICB2YXIgcmVzID0gdGhpczsgLy8gd2hhdCB0aGlzIGZ1bmN0aW9uIHdpbGwgcmV0dXJuICh0aGlzIGpRdWVyeSBvYmplY3QgYnkgZGVmYXVsdCkNCiAgICB0aGlzLmVhY2goZnVuY3Rpb24gKGksIF9lbGVtZW50KSB7DQogICAgICAgIHZhciBlbGVtZW50ID0gJChfZWxlbWVudCk7DQogICAgICAgIHZhciBjYWxlbmRhciA9IGVsZW1lbnQuZGF0YSgnZnVsbENhbGVuZGFyJyk7IC8vIGdldCB0aGUgZXhpc3RpbmcgY2FsZW5kYXIgb2JqZWN0IChpZiBhbnkpDQogICAgICAgIHZhciBzaW5nbGVSZXM7IC8vIHRoZSByZXR1cm5lZCB2YWx1ZSBvZiB0aGlzIHNpbmdsZSBtZXRob2QgY2FsbA0KICAgICAgICAvLyBhIG1ldGhvZCBjYWxsDQogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHsNCiAgICAgICAgICAgIGlmIChvcHRpb25zID09PSAnZ2V0Q2FsZW5kYXInKSB7DQogICAgICAgICAgICAgICAgaWYgKCFpKSB7DQogICAgICAgICAgICAgICAgICAgIHJlcyA9IGNhbGVuZGFyOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2UgaWYgKG9wdGlvbnMgPT09ICdkZXN0cm95Jykgew0KICAgICAgICAgICAgICAgIGlmIChjYWxlbmRhcikgew0KICAgICAgICAgICAgICAgICAgICBjYWxlbmRhci5kZXN0cm95KCk7DQogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRGF0YSgnZnVsbENhbGVuZGFyJyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAoIWNhbGVuZGFyKSB7DQogICAgICAgICAgICAgICAgdXRpbF8xLndhcm4oJ0F0dGVtcHRpbmcgdG8gY2FsbCBhIEZ1bGxDYWxlbmRhciBtZXRob2Qgb24gYW4gZWxlbWVudCB3aXRoIG5vIGNhbGVuZGFyLicpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAoJC5pc0Z1bmN0aW9uKGNhbGVuZGFyW29wdGlvbnNdKSkgew0KICAgICAgICAgICAgICAgIHNpbmdsZVJlcyA9IGNhbGVuZGFyW29wdGlvbnNdLmFwcGx5KGNhbGVuZGFyLCBhcmdzKTsNCiAgICAgICAgICAgICAgICBpZiAoIWkpIHsNCiAgICAgICAgICAgICAgICAgICAgcmVzID0gc2luZ2xlUmVzOyAvLyByZWNvcmQgdGhlIGZpcnN0IG1ldGhvZCBjYWxsIHJlc3VsdA0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucyA9PT0gJ2Rlc3Ryb3knKSB7DQogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRGF0YSgnZnVsbENhbGVuZGFyJyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgdXRpbF8xLndhcm4oIiciICsgb3B0aW9ucyArICInIGlzIGFuIHVua25vd24gRnVsbENhbGVuZGFyIG1ldGhvZC4iKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBlbHNlIGlmICghY2FsZW5kYXIpIHsNCiAgICAgICAgICAgIGNhbGVuZGFyID0gbmV3IENhbGVuZGFyXzEuZGVmYXVsdChlbGVtZW50LCBvcHRpb25zKTsNCiAgICAgICAgICAgIGVsZW1lbnQuZGF0YSgnZnVsbENhbGVuZGFyJywgY2FsZW5kYXIpOw0KICAgICAgICAgICAgY2FsZW5kYXIucmVuZGVyKCk7DQogICAgICAgIH0NCiAgICB9KTsNCiAgICByZXR1cm4gcmVzOw0KfTsNCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0SG9va3M7DQoKCi8qKiovIH0pLAovKiAyMzcgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciBNb2RlbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0OCk7DQp2YXIgQ29tcG9uZW50ID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKENvbXBvbmVudCwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBDb21wb25lbnQoKSB7DQogICAgICAgIHJldHVybiBfc3VwZXIgIT09IG51bGwgJiYgX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsNCiAgICB9DQogICAgQ29tcG9uZW50LnByb3RvdHlwZS5zZXRFbGVtZW50ID0gZnVuY3Rpb24gKGVsKSB7DQogICAgICAgIHRoaXMuZWwgPSBlbDsNCiAgICAgICAgdGhpcy5iaW5kR2xvYmFsSGFuZGxlcnMoKTsNCiAgICAgICAgdGhpcy5yZW5kZXJTa2VsZXRvbigpOw0KICAgICAgICB0aGlzLnNldCgnaXNJbkRvbScsIHRydWUpOw0KICAgIH07DQogICAgQ29tcG9uZW50LnByb3RvdHlwZS5yZW1vdmVFbGVtZW50ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB0aGlzLnVuc2V0KCdpc0luRG9tJyk7DQogICAgICAgIHRoaXMudW5yZW5kZXJTa2VsZXRvbigpOw0KICAgICAgICB0aGlzLnVuYmluZEdsb2JhbEhhbmRsZXJzKCk7DQogICAgICAgIHRoaXMuZWwucmVtb3ZlKCk7DQogICAgICAgIC8vIE5PVEU6IGRvbid0IG51bGwtb3V0IHRoaXMuZWwgaW4gY2FzZSB0aGUgVmlldyB3YXMgZGVzdHJveWVkIHdpdGhpbiBhbiBBUEkgY2FsbGJhY2suDQogICAgICAgIC8vIFdlIGRvbid0IG51bGwtb3V0IHRoZSBWaWV3J3Mgb3RoZXIgalF1ZXJ5IGVsZW1lbnQgcmVmZXJlbmNlcyB1cG9uIGRlc3Ryb3ksDQogICAgICAgIC8vICBzbyB3ZSBzaG91bGRuJ3Qga2lsbCB0aGlzLmVsIGVpdGhlci4NCiAgICB9Ow0KICAgIENvbXBvbmVudC5wcm90b3R5cGUuYmluZEdsb2JhbEhhbmRsZXJzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAvLyBzdWJjbGFzc2VzIGNhbiBvdmVycmlkZQ0KICAgIH07DQogICAgQ29tcG9uZW50LnByb3RvdHlwZS51bmJpbmRHbG9iYWxIYW5kbGVycyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgLy8gc3ViY2xhc3NlcyBjYW4gb3ZlcnJpZGUNCiAgICB9Ow0KICAgIC8qDQogICAgTk9URTogQ2FuJ3QgaGF2ZSBhIGByZW5kZXJgIG1ldGhvZC4gUmVhZCB0aGUgZGVwcmVjYXRpb24gbm90aWNlIGluIFZpZXc6OmV4ZWN1dGVEYXRlUmVuZGVyDQogICAgKi8NCiAgICAvLyBSZW5kZXJzIHRoZSBiYXNpYyBzdHJ1Y3R1cmUgb2YgdGhlIHZpZXcgYmVmb3JlIGFueSBjb250ZW50IGlzIHJlbmRlcmVkDQogICAgQ29tcG9uZW50LnByb3RvdHlwZS5yZW5kZXJTa2VsZXRvbiA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgLy8gc3ViY2xhc3NlcyBzaG91bGQgaW1wbGVtZW50DQogICAgfTsNCiAgICAvLyBVbnJlbmRlcnMgdGhlIGJhc2ljIHN0cnVjdHVyZSBvZiB0aGUgdmlldw0KICAgIENvbXBvbmVudC5wcm90b3R5cGUudW5yZW5kZXJTa2VsZXRvbiA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgLy8gc3ViY2xhc3NlcyBzaG91bGQgaW1wbGVtZW50DQogICAgfTsNCiAgICByZXR1cm4gQ29tcG9uZW50Ow0KfShNb2RlbF8xLmRlZmF1bHQpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IENvbXBvbmVudDsNCgoKLyoqKi8gfSksCi8qIDIzOCAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIEl0ZXJhdG9yID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgew0KICAgIGZ1bmN0aW9uIEl0ZXJhdG9yKGl0ZW1zKSB7DQogICAgICAgIHRoaXMuaXRlbXMgPSBpdGVtcyB8fCBbXTsNCiAgICB9DQogICAgLyogQ2FsbHMgYSBtZXRob2Qgb24gZXZlcnkgaXRlbSBwYXNzaW5nIHRoZSBhcmd1bWVudHMgdGhyb3VnaCAqLw0KICAgIEl0ZXJhdG9yLnByb3RvdHlwZS5wcm94eUNhbGwgPSBmdW5jdGlvbiAobWV0aG9kTmFtZSkgew0KICAgICAgICB2YXIgYXJncyA9IFtdOw0KICAgICAgICBmb3IgKHZhciBfaSA9IDE7IF9pIDwgYXJndW1lbnRzLmxlbmd0aDsgX2krKykgew0KICAgICAgICAgICAgYXJnc1tfaSAtIDFdID0gYXJndW1lbnRzW19pXTsNCiAgICAgICAgfQ0KICAgICAgICB2YXIgcmVzdWx0cyA9IFtdOw0KICAgICAgICB0aGlzLml0ZW1zLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsNCiAgICAgICAgICAgIHJlc3VsdHMucHVzaChpdGVtW21ldGhvZE5hbWVdLmFwcGx5KGl0ZW0sIGFyZ3MpKTsNCiAgICAgICAgfSk7DQogICAgICAgIHJldHVybiByZXN1bHRzOw0KICAgIH07DQogICAgcmV0dXJuIEl0ZXJhdG9yOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IEl0ZXJhdG9yOw0KCgovKioqLyB9KSwKLyogMjM5ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCi8qIFRvb2xiYXIgd2l0aCBidXR0b25zIGFuZCB0aXRsZQ0KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQp2YXIgVG9vbGJhciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsNCiAgICBmdW5jdGlvbiBUb29sYmFyKGNhbGVuZGFyLCB0b29sYmFyT3B0aW9ucykgew0KICAgICAgICB0aGlzLmVsID0gbnVsbDsgLy8gbWlycm9ycyBsb2NhbCBgZWxgDQogICAgICAgIHRoaXMudmlld3NXaXRoQnV0dG9ucyA9IFtdOw0KICAgICAgICB0aGlzLmNhbGVuZGFyID0gY2FsZW5kYXI7DQogICAgICAgIHRoaXMudG9vbGJhck9wdGlvbnMgPSB0b29sYmFyT3B0aW9uczsNCiAgICB9DQogICAgLy8gbWV0aG9kIHRvIHVwZGF0ZSB0b29sYmFyLXNwZWNpZmljIG9wdGlvbnMsIG5vdCBjYWxlbmRhci13aWRlIG9wdGlvbnMNCiAgICBUb29sYmFyLnByb3RvdHlwZS5zZXRUb29sYmFyT3B0aW9ucyA9IGZ1bmN0aW9uIChuZXdUb29sYmFyT3B0aW9ucykgew0KICAgICAgICB0aGlzLnRvb2xiYXJPcHRpb25zID0gbmV3VG9vbGJhck9wdGlvbnM7DQogICAgfTsNCiAgICAvLyBjYW4gYmUgY2FsbGVkIHJlcGVhdGVkbHkgYW5kIHdpbGwgcmVyZW5kZXINCiAgICBUb29sYmFyLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBzZWN0aW9ucyA9IHRoaXMudG9vbGJhck9wdGlvbnMubGF5b3V0Ow0KICAgICAgICB2YXIgZWwgPSB0aGlzLmVsOw0KICAgICAgICBpZiAoc2VjdGlvbnMpIHsNCiAgICAgICAgICAgIGlmICghZWwpIHsNCiAgICAgICAgICAgICAgICBlbCA9IHRoaXMuZWwgPSAkKCI8ZGl2IGNsYXNzPSdmYy10b29sYmFyICIgKyB0aGlzLnRvb2xiYXJPcHRpb25zLmV4dHJhQ2xhc3NlcyArICInLz4iKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIGVsLmVtcHR5KCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbC5hcHBlbmQodGhpcy5yZW5kZXJTZWN0aW9uKCdsZWZ0JykpDQogICAgICAgICAgICAgICAgLmFwcGVuZCh0aGlzLnJlbmRlclNlY3Rpb24oJ3JpZ2h0JykpDQogICAgICAgICAgICAgICAgLmFwcGVuZCh0aGlzLnJlbmRlclNlY3Rpb24oJ2NlbnRlcicpKQ0KICAgICAgICAgICAgICAgIC5hcHBlbmQoJzxkaXYgY2xhc3M9ImZjLWNsZWFyIi8+Jyk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICB0aGlzLnJlbW92ZUVsZW1lbnQoKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgVG9vbGJhci5wcm90b3R5cGUucmVtb3ZlRWxlbWVudCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMuZWwpIHsNCiAgICAgICAgICAgIHRoaXMuZWwucmVtb3ZlKCk7DQogICAgICAgICAgICB0aGlzLmVsID0gbnVsbDsNCiAgICAgICAgfQ0KICAgIH07DQogICAgVG9vbGJhci5wcm90b3R5cGUucmVuZGVyU2VjdGlvbiA9IGZ1bmN0aW9uIChwb3NpdGlvbikgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICB2YXIgY2FsZW5kYXIgPSB0aGlzLmNhbGVuZGFyOw0KICAgICAgICB2YXIgdGhlbWUgPSBjYWxlbmRhci50aGVtZTsNCiAgICAgICAgdmFyIG9wdGlvbnNNYW5hZ2VyID0gY2FsZW5kYXIub3B0aW9uc01hbmFnZXI7DQogICAgICAgIHZhciB2aWV3U3BlY01hbmFnZXIgPSBjYWxlbmRhci52aWV3U3BlY01hbmFnZXI7DQogICAgICAgIHZhciBzZWN0aW9uRWwgPSAkKCc8ZGl2IGNsYXNzPSJmYy0nICsgcG9zaXRpb24gKyAnIi8+Jyk7DQogICAgICAgIHZhciBidXR0b25TdHIgPSB0aGlzLnRvb2xiYXJPcHRpb25zLmxheW91dFtwb3NpdGlvbl07DQogICAgICAgIHZhciBjYWxlbmRhckN1c3RvbUJ1dHRvbnMgPSBvcHRpb25zTWFuYWdlci5nZXQoJ2N1c3RvbUJ1dHRvbnMnKSB8fCB7fTsNCiAgICAgICAgdmFyIGNhbGVuZGFyQnV0dG9uVGV4dE92ZXJyaWRlcyA9IG9wdGlvbnNNYW5hZ2VyLm92ZXJyaWRlcy5idXR0b25UZXh0IHx8IHt9Ow0KICAgICAgICB2YXIgY2FsZW5kYXJCdXR0b25UZXh0ID0gb3B0aW9uc01hbmFnZXIuZ2V0KCdidXR0b25UZXh0JykgfHwge307DQogICAgICAgIGlmIChidXR0b25TdHIpIHsNCiAgICAgICAgICAgICQuZWFjaChidXR0b25TdHIuc3BsaXQoJyAnKSwgZnVuY3Rpb24gKGksIGJ1dHRvbkdyb3VwU3RyKSB7DQogICAgICAgICAgICAgICAgdmFyIGdyb3VwQ2hpbGRyZW4gPSAkKCk7DQogICAgICAgICAgICAgICAgdmFyIGlzT25seUJ1dHRvbnMgPSB0cnVlOw0KICAgICAgICAgICAgICAgIHZhciBncm91cEVsOw0KICAgICAgICAgICAgICAgICQuZWFjaChidXR0b25Hcm91cFN0ci5zcGxpdCgnLCcpLCBmdW5jdGlvbiAoaiwgYnV0dG9uTmFtZSkgew0KICAgICAgICAgICAgICAgICAgICB2YXIgY3VzdG9tQnV0dG9uUHJvcHM7DQogICAgICAgICAgICAgICAgICAgIHZhciB2aWV3U3BlYzsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGJ1dHRvbkNsaWNrOw0KICAgICAgICAgICAgICAgICAgICB2YXIgYnV0dG9uSWNvbjsgLy8gb25seSBvbmUgb2YgdGhlc2Ugd2lsbCBiZSBzZXQNCiAgICAgICAgICAgICAgICAgICAgdmFyIGJ1dHRvblRleHQ7IC8vICINCiAgICAgICAgICAgICAgICAgICAgdmFyIGJ1dHRvbklubmVySHRtbDsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGJ1dHRvbkNsYXNzZXM7DQogICAgICAgICAgICAgICAgICAgIHZhciBidXR0b25FbDsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGJ1dHRvbkFyaWFBdHRyOw0KICAgICAgICAgICAgICAgICAgICBpZiAoYnV0dG9uTmFtZSA9PT0gJ3RpdGxlJykgew0KICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBDaGlsZHJlbiA9IGdyb3VwQ2hpbGRyZW4uYWRkKCQoJzxoMj4mbmJzcDs8L2gyPicpKTsgLy8gd2UgYWx3YXlzIHdhbnQgaXQgdG8gdGFrZSB1cCBoZWlnaHQNCiAgICAgICAgICAgICAgICAgICAgICAgIGlzT25seUJ1dHRvbnMgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoY3VzdG9tQnV0dG9uUHJvcHMgPSBjYWxlbmRhckN1c3RvbUJ1dHRvbnNbYnV0dG9uTmFtZV0pKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uQ2xpY2sgPSBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1c3RvbUJ1dHRvblByb3BzLmNsaWNrKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXN0b21CdXR0b25Qcm9wcy5jbGljay5jYWxsKGJ1dHRvbkVsWzBdLCBldik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIChidXR0b25JY29uID0gdGhlbWUuZ2V0Q3VzdG9tQnV0dG9uSWNvbkNsYXNzKGN1c3RvbUJ1dHRvblByb3BzKSkgfHwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGJ1dHRvbkljb24gPSB0aGVtZS5nZXRJY29uQ2xhc3MoYnV0dG9uTmFtZSkpIHx8DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChidXR0b25UZXh0ID0gY3VzdG9tQnV0dG9uUHJvcHMudGV4dCk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICgodmlld1NwZWMgPSB2aWV3U3BlY01hbmFnZXIuZ2V0Vmlld1NwZWMoYnV0dG9uTmFtZSkpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMudmlld3NXaXRoQnV0dG9ucy5wdXNoKGJ1dHRvbk5hbWUpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbkNsaWNrID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxlbmRhci5jaGFuZ2VWaWV3KGJ1dHRvbk5hbWUpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGJ1dHRvblRleHQgPSB2aWV3U3BlYy5idXR0b25UZXh0T3ZlcnJpZGUpIHx8DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChidXR0b25JY29uID0gdGhlbWUuZ2V0SWNvbkNsYXNzKGJ1dHRvbk5hbWUpKSB8fA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYnV0dG9uVGV4dCA9IHZpZXdTcGVjLmJ1dHRvblRleHREZWZhdWx0KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGNhbGVuZGFyW2J1dHRvbk5hbWVdKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uQ2xpY2sgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGVuZGFyW2J1dHRvbk5hbWVdKCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYnV0dG9uVGV4dCA9IGNhbGVuZGFyQnV0dG9uVGV4dE92ZXJyaWRlc1tidXR0b25OYW1lXSkgfHwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGJ1dHRvbkljb24gPSB0aGVtZS5nZXRJY29uQ2xhc3MoYnV0dG9uTmFtZSkpIHx8DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChidXR0b25UZXh0ID0gY2FsZW5kYXJCdXR0b25UZXh0W2J1dHRvbk5hbWVdKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgIF4gZXZlcnl0aGluZyBlbHNlIGlzIGNvbnNpZGVyZWQgZGVmYXVsdA0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ1dHRvbkNsaWNrKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uQ2xhc3NlcyA9IFsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2ZjLScgKyBidXR0b25OYW1lICsgJy1idXR0b24nLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVtZS5nZXRDbGFzcygnYnV0dG9uJyksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZW1lLmdldENsYXNzKCdzdGF0ZURlZmF1bHQnKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ1dHRvblRleHQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uSW5uZXJIdG1sID0gdXRpbF8xLmh0bWxFc2NhcGUoYnV0dG9uVGV4dCk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbkFyaWFBdHRyID0gJyc7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGJ1dHRvbkljb24pIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uSW5uZXJIdG1sID0gIjxzcGFuIGNsYXNzPSciICsgYnV0dG9uSWNvbiArICInPjwvc3Bhbj4iOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25BcmlhQXR0ciA9ICcgYXJpYS1sYWJlbD0iJyArIGJ1dHRvbk5hbWUgKyAnIic7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbkVsID0gJCgvLyB0eXBlPSJidXR0b24iIHNvIHRoYXQgaXQgZG9lc24ndCBzdWJtaXQgYSBmb3JtDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxidXR0b24gdHlwZT0iYnV0dG9uIiBjbGFzcz0iJyArIGJ1dHRvbkNsYXNzZXMuam9pbignICcpICsgJyInICsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uQXJpYUF0dHIgKw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPicgKyBidXR0b25Jbm5lckh0bWwgKyAnPC9idXR0b24+JykNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNsaWNrKGZ1bmN0aW9uIChldikgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkb24ndCBwcm9jZXNzIGNsaWNrcyBmb3IgZGlzYWJsZWQgYnV0dG9ucw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWJ1dHRvbkVsLmhhc0NsYXNzKHRoZW1lLmdldENsYXNzKCdzdGF0ZURpc2FibGVkJykpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25DbGljayhldik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhZnRlciB0aGUgY2xpY2sgYWN0aW9uLCBpZiB0aGUgYnV0dG9uIGJlY29tZXMgdGhlICJhY3RpdmUiIHRhYiwgb3IgZGlzYWJsZWQsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpdCBzaG91bGQgbmV2ZXIgaGF2ZSBhIGhvdmVyIGNsYXNzLCBzbyByZW1vdmUgaXQgbm93Lg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ1dHRvbkVsLmhhc0NsYXNzKHRoZW1lLmdldENsYXNzKCdzdGF0ZUFjdGl2ZScpKSB8fA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbkVsLmhhc0NsYXNzKHRoZW1lLmdldENsYXNzKCdzdGF0ZURpc2FibGVkJykpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uRWwucmVtb3ZlQ2xhc3ModGhlbWUuZ2V0Q2xhc3MoJ3N0YXRlSG92ZXInKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAubW91c2Vkb3duKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlICpkb3duKiBlZmZlY3QgKG1vdXNlIHByZXNzZWQgaW4pLg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBvbmx5IG9uIGJ1dHRvbnMgdGhhdCBhcmUgbm90IHRoZSAiYWN0aXZlIiB0YWIsIG9yIGRpc2FibGVkDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbkVsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAubm90KCcuJyArIHRoZW1lLmdldENsYXNzKCdzdGF0ZUFjdGl2ZScpKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm5vdCgnLicgKyB0aGVtZS5nZXRDbGFzcygnc3RhdGVEaXNhYmxlZCcpKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKHRoZW1lLmdldENsYXNzKCdzdGF0ZURvd24nKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1vdXNldXAoZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB1bmRvIHRoZSAqZG93biogZWZmZWN0DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbkVsLnJlbW92ZUNsYXNzKHRoZW1lLmdldENsYXNzKCdzdGF0ZURvd24nKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmhvdmVyKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlICpob3ZlciogZWZmZWN0Lg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBvbmx5IG9uIGJ1dHRvbnMgdGhhdCBhcmUgbm90IHRoZSAiYWN0aXZlIiB0YWIsIG9yIGRpc2FibGVkDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbkVsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAubm90KCcuJyArIHRoZW1lLmdldENsYXNzKCdzdGF0ZUFjdGl2ZScpKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm5vdCgnLicgKyB0aGVtZS5nZXRDbGFzcygnc3RhdGVEaXNhYmxlZCcpKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKHRoZW1lLmdldENsYXNzKCdzdGF0ZUhvdmVyJykpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdW5kbyB0aGUgKmhvdmVyKiBlZmZlY3QNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uRWwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZW1vdmVDbGFzcyh0aGVtZS5nZXRDbGFzcygnc3RhdGVIb3ZlcicpKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlbW92ZUNsYXNzKHRoZW1lLmdldENsYXNzKCdzdGF0ZURvd24nKSk7IC8vIGlmIG1vdXNlbGVhdmUgaGFwcGVucyBiZWZvcmUgbW91c2V1cA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwQ2hpbGRyZW4gPSBncm91cENoaWxkcmVuLmFkZChidXR0b25FbCk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICBpZiAoaXNPbmx5QnV0dG9ucykgew0KICAgICAgICAgICAgICAgICAgICBncm91cENoaWxkcmVuDQogICAgICAgICAgICAgICAgICAgICAgICAuZmlyc3QoKS5hZGRDbGFzcyh0aGVtZS5nZXRDbGFzcygnY29ybmVyTGVmdCcpKS5lbmQoKQ0KICAgICAgICAgICAgICAgICAgICAgICAgLmxhc3QoKS5hZGRDbGFzcyh0aGVtZS5nZXRDbGFzcygnY29ybmVyUmlnaHQnKSkuZW5kKCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmIChncm91cENoaWxkcmVuLmxlbmd0aCA+IDEpIHsNCiAgICAgICAgICAgICAgICAgICAgZ3JvdXBFbCA9ICQoJzxkaXYvPicpOw0KICAgICAgICAgICAgICAgICAgICBpZiAoaXNPbmx5QnV0dG9ucykgew0KICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBFbC5hZGRDbGFzcyh0aGVtZS5nZXRDbGFzcygnYnV0dG9uR3JvdXAnKSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgZ3JvdXBFbC5hcHBlbmQoZ3JvdXBDaGlsZHJlbik7DQogICAgICAgICAgICAgICAgICAgIHNlY3Rpb25FbC5hcHBlbmQoZ3JvdXBFbCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBzZWN0aW9uRWwuYXBwZW5kKGdyb3VwQ2hpbGRyZW4pOyAvLyAxIG9yIDAgY2hpbGRyZW4NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gc2VjdGlvbkVsOw0KICAgIH07DQogICAgVG9vbGJhci5wcm90b3R5cGUudXBkYXRlVGl0bGUgPSBmdW5jdGlvbiAodGV4dCkgew0KICAgICAgICBpZiAodGhpcy5lbCkgew0KICAgICAgICAgICAgdGhpcy5lbC5maW5kKCdoMicpLnRleHQodGV4dCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIFRvb2xiYXIucHJvdG90eXBlLmFjdGl2YXRlQnV0dG9uID0gZnVuY3Rpb24gKGJ1dHRvbk5hbWUpIHsNCiAgICAgICAgaWYgKHRoaXMuZWwpIHsNCiAgICAgICAgICAgIHRoaXMuZWwuZmluZCgnLmZjLScgKyBidXR0b25OYW1lICsgJy1idXR0b24nKQ0KICAgICAgICAgICAgICAgIC5hZGRDbGFzcyh0aGlzLmNhbGVuZGFyLnRoZW1lLmdldENsYXNzKCdzdGF0ZUFjdGl2ZScpKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgVG9vbGJhci5wcm90b3R5cGUuZGVhY3RpdmF0ZUJ1dHRvbiA9IGZ1bmN0aW9uIChidXR0b25OYW1lKSB7DQogICAgICAgIGlmICh0aGlzLmVsKSB7DQogICAgICAgICAgICB0aGlzLmVsLmZpbmQoJy5mYy0nICsgYnV0dG9uTmFtZSArICctYnV0dG9uJykNCiAgICAgICAgICAgICAgICAucmVtb3ZlQ2xhc3ModGhpcy5jYWxlbmRhci50aGVtZS5nZXRDbGFzcygnc3RhdGVBY3RpdmUnKSk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIFRvb2xiYXIucHJvdG90eXBlLmRpc2FibGVCdXR0b24gPSBmdW5jdGlvbiAoYnV0dG9uTmFtZSkgew0KICAgICAgICBpZiAodGhpcy5lbCkgew0KICAgICAgICAgICAgdGhpcy5lbC5maW5kKCcuZmMtJyArIGJ1dHRvbk5hbWUgKyAnLWJ1dHRvbicpDQogICAgICAgICAgICAgICAgLnByb3AoJ2Rpc2FibGVkJywgdHJ1ZSkNCiAgICAgICAgICAgICAgICAuYWRkQ2xhc3ModGhpcy5jYWxlbmRhci50aGVtZS5nZXRDbGFzcygnc3RhdGVEaXNhYmxlZCcpKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgVG9vbGJhci5wcm90b3R5cGUuZW5hYmxlQnV0dG9uID0gZnVuY3Rpb24gKGJ1dHRvbk5hbWUpIHsNCiAgICAgICAgaWYgKHRoaXMuZWwpIHsNCiAgICAgICAgICAgIHRoaXMuZWwuZmluZCgnLmZjLScgKyBidXR0b25OYW1lICsgJy1idXR0b24nKQ0KICAgICAgICAgICAgICAgIC5wcm9wKCdkaXNhYmxlZCcsIGZhbHNlKQ0KICAgICAgICAgICAgICAgIC5yZW1vdmVDbGFzcyh0aGlzLmNhbGVuZGFyLnRoZW1lLmdldENsYXNzKCdzdGF0ZURpc2FibGVkJykpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBUb29sYmFyLnByb3RvdHlwZS5nZXRWaWV3c1dpdGhCdXR0b25zID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gdGhpcy52aWV3c1dpdGhCdXR0b25zOw0KICAgIH07DQogICAgcmV0dXJuIFRvb2xiYXI7DQp9KCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gVG9vbGJhcjsNCgoKLyoqKi8gfSksCi8qIDI0MCAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIHRzbGliXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIpOw0KdmFyICQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgb3B0aW9uc18xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzMSk7DQp2YXIgbG9jYWxlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMwKTsNCnZhciBNb2RlbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0OCk7DQp2YXIgT3B0aW9uc01hbmFnZXIgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoT3B0aW9uc01hbmFnZXIsIF9zdXBlcik7DQogICAgZnVuY3Rpb24gT3B0aW9uc01hbmFnZXIoX2NhbGVuZGFyLCBvdmVycmlkZXMpIHsNCiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcykgfHwgdGhpczsNCiAgICAgICAgX3RoaXMuX2NhbGVuZGFyID0gX2NhbGVuZGFyOw0KICAgICAgICBfdGhpcy5vdmVycmlkZXMgPSAkLmV4dGVuZCh7fSwgb3ZlcnJpZGVzKTsgLy8gbWFrZSBhIGNvcHkNCiAgICAgICAgX3RoaXMuZHluYW1pY092ZXJyaWRlcyA9IHt9Ow0KICAgICAgICBfdGhpcy5jb21wdXRlKCk7DQogICAgICAgIHJldHVybiBfdGhpczsNCiAgICB9DQogICAgT3B0aW9uc01hbmFnZXIucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uIChuZXdPcHRpb25IYXNoKSB7DQogICAgICAgIHZhciBvcHRpb25DbnQgPSAwOw0KICAgICAgICB2YXIgb3B0aW9uTmFtZTsNCiAgICAgICAgdGhpcy5yZWNvcmRPdmVycmlkZXMobmV3T3B0aW9uSGFzaCk7IC8vIHdpbGwgdHJpZ2dlciB0aGlzIG1vZGVsJ3Mgd2F0Y2hlcnMNCiAgICAgICAgZm9yIChvcHRpb25OYW1lIGluIG5ld09wdGlvbkhhc2gpIHsNCiAgICAgICAgICAgIG9wdGlvbkNudCsrOw0KICAgICAgICB9DQogICAgICAgIC8vIHNwZWNpYWwtY2FzZSBoYW5kbGluZyBvZiBzaW5nbGUgb3B0aW9uIGNoYW5nZS4NCiAgICAgICAgLy8gaWYgb25seSBvbmUgb3B0aW9uIGNoYW5nZSwgYG9wdGlvbk5hbWVgIHdpbGwgYmUgaXRzIG5hbWUuDQogICAgICAgIGlmIChvcHRpb25DbnQgPT09IDEpIHsNCiAgICAgICAgICAgIGlmIChvcHRpb25OYW1lID09PSAnaGVpZ2h0JyB8fCBvcHRpb25OYW1lID09PSAnY29udGVudEhlaWdodCcgfHwgb3B0aW9uTmFtZSA9PT0gJ2FzcGVjdFJhdGlvJykgew0KICAgICAgICAgICAgICAgIHRoaXMuX2NhbGVuZGFyLnVwZGF0ZVZpZXdTaXplKHRydWUpOyAvLyBpc1Jlc2l6ZT10cnVlDQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAob3B0aW9uTmFtZSA9PT0gJ2RlZmF1bHREYXRlJykgew0KICAgICAgICAgICAgICAgIHJldHVybjsgLy8gY2FuJ3QgY2hhbmdlIGRhdGUgdGhpcyB3YXkuIHVzZSBnb3RvRGF0ZSBpbnN0ZWFkDQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIGlmIChvcHRpb25OYW1lID09PSAnYnVzaW5lc3NIb3VycycpIHsNCiAgICAgICAgICAgICAgICByZXR1cm47IC8vIHRoaXMgbW9kZWwgYWxyZWFkeSByZWFjdHMgdG8gdGhpcw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAoL14oZXZlbnR8c2VsZWN0KShPdmVybGFwfENvbnN0cmFpbnR8QWxsb3cpJC8udGVzdChvcHRpb25OYW1lKSkgew0KICAgICAgICAgICAgICAgIHJldHVybjsgLy8gZG9lc24ndCBhZmZlY3QgcmVuZGVyaW5nLiBvbmx5IGludGVyYWN0aW9ucy4NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2UgaWYgKG9wdGlvbk5hbWUgPT09ICd0aW1lem9uZScpIHsNCiAgICAgICAgICAgICAgICB0aGlzLl9jYWxlbmRhci52aWV3LmZsYXNoKCdpbml0aWFsRXZlbnRzJyk7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIC8vIGNhdGNoLWFsbC4gcmVyZW5kZXIgdGhlIGhlYWRlciBhbmQgZm9vdGVyIGFuZCByZWJ1aWxkL3JlcmVuZGVyIHRoZSBjdXJyZW50IHZpZXcNCiAgICAgICAgdGhpcy5fY2FsZW5kYXIucmVuZGVySGVhZGVyKCk7DQogICAgICAgIHRoaXMuX2NhbGVuZGFyLnJlbmRlckZvb3RlcigpOw0KICAgICAgICAvLyBldmVuIG5vbi1jdXJyZW50IHZpZXdzIHdpbGwgYmUgYWZmZWN0ZWQgYnkgdGhpcyBvcHRpb24gY2hhbmdlLiBkbyBiZWZvcmUgcmVyZW5kZXINCiAgICAgICAgLy8gVE9ETzogZGV0YW5nbGUNCiAgICAgICAgdGhpcy5fY2FsZW5kYXIudmlld3NCeVR5cGUgPSB7fTsNCiAgICAgICAgdGhpcy5fY2FsZW5kYXIucmVpbml0VmlldygpOw0KICAgIH07DQogICAgLy8gQ29tcHV0ZXMgdGhlIGZsYXR0ZW5lZCBvcHRpb25zIGhhc2ggZm9yIHRoZSBjYWxlbmRhciBhbmQgYXNzaWducyB0byBgdGhpcy5vcHRpb25zYC4NCiAgICAvLyBBc3N1bWVzIHRoaXMub3ZlcnJpZGVzIGFuZCB0aGlzLmR5bmFtaWNPdmVycmlkZXMgaGF2ZSBhbHJlYWR5IGJlZW4gaW5pdGlhbGl6ZWQuDQogICAgT3B0aW9uc01hbmFnZXIucHJvdG90eXBlLmNvbXB1dGUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBsb2NhbGU7DQogICAgICAgIHZhciBsb2NhbGVEZWZhdWx0czsNCiAgICAgICAgdmFyIGlzUlRMOw0KICAgICAgICB2YXIgZGlyRGVmYXVsdHM7DQogICAgICAgIHZhciByYXdPcHRpb25zOw0KICAgICAgICBsb2NhbGUgPSB1dGlsXzEuZmlyc3REZWZpbmVkKC8vIGV4cGxpY2l0IGxvY2FsZSBvcHRpb24gZ2l2ZW4/DQogICAgICAgIHRoaXMuZHluYW1pY092ZXJyaWRlcy5sb2NhbGUsIHRoaXMub3ZlcnJpZGVzLmxvY2FsZSk7DQogICAgICAgIGxvY2FsZURlZmF1bHRzID0gbG9jYWxlXzEubG9jYWxlT3B0aW9uSGFzaFtsb2NhbGVdOw0KICAgICAgICBpZiAoIWxvY2FsZURlZmF1bHRzKSB7DQogICAgICAgICAgICBsb2NhbGUgPSBvcHRpb25zXzEuZ2xvYmFsRGVmYXVsdHMubG9jYWxlOw0KICAgICAgICAgICAgbG9jYWxlRGVmYXVsdHMgPSBsb2NhbGVfMS5sb2NhbGVPcHRpb25IYXNoW2xvY2FsZV0gfHwge307DQogICAgICAgIH0NCiAgICAgICAgaXNSVEwgPSB1dGlsXzEuZmlyc3REZWZpbmVkKC8vIGJhc2VkIG9uIG9wdGlvbnMgY29tcHV0ZWQgc28gZmFyLCBpcyBkaXJlY3Rpb24gUlRMPw0KICAgICAgICB0aGlzLmR5bmFtaWNPdmVycmlkZXMuaXNSVEwsIHRoaXMub3ZlcnJpZGVzLmlzUlRMLCBsb2NhbGVEZWZhdWx0cy5pc1JUTCwgb3B0aW9uc18xLmdsb2JhbERlZmF1bHRzLmlzUlRMKTsNCiAgICAgICAgZGlyRGVmYXVsdHMgPSBpc1JUTCA/IG9wdGlvbnNfMS5ydGxEZWZhdWx0cyA6IHt9Ow0KICAgICAgICB0aGlzLmRpckRlZmF1bHRzID0gZGlyRGVmYXVsdHM7DQogICAgICAgIHRoaXMubG9jYWxlRGVmYXVsdHMgPSBsb2NhbGVEZWZhdWx0czsNCiAgICAgICAgcmF3T3B0aW9ucyA9IG9wdGlvbnNfMS5tZXJnZU9wdGlvbnMoWw0KICAgICAgICAgICAgb3B0aW9uc18xLmdsb2JhbERlZmF1bHRzLA0KICAgICAgICAgICAgZGlyRGVmYXVsdHMsDQogICAgICAgICAgICBsb2NhbGVEZWZhdWx0cywNCiAgICAgICAgICAgIHRoaXMub3ZlcnJpZGVzLA0KICAgICAgICAgICAgdGhpcy5keW5hbWljT3ZlcnJpZGVzDQogICAgICAgIF0pOw0KICAgICAgICBsb2NhbGVfMS5wb3B1bGF0ZUluc3RhbmNlQ29tcHV0YWJsZU9wdGlvbnMocmF3T3B0aW9ucyk7IC8vIGZpbGwgaW4gZ2FwcyB3aXRoIGNvbXB1dGVkIG9wdGlvbnMNCiAgICAgICAgdGhpcy5yZXNldChyYXdPcHRpb25zKTsNCiAgICB9Ow0KICAgIC8vIHN0b3JlcyB0aGUgbmV3IG9wdGlvbnMgaW50ZXJuYWxseSwgYnV0IGRvZXMgbm90IHJlcmVuZGVyIGFueXRoaW5nLg0KICAgIE9wdGlvbnNNYW5hZ2VyLnByb3RvdHlwZS5yZWNvcmRPdmVycmlkZXMgPSBmdW5jdGlvbiAobmV3T3B0aW9uSGFzaCkgew0KICAgICAgICB2YXIgb3B0aW9uTmFtZTsNCiAgICAgICAgZm9yIChvcHRpb25OYW1lIGluIG5ld09wdGlvbkhhc2gpIHsNCiAgICAgICAgICAgIHRoaXMuZHluYW1pY092ZXJyaWRlc1tvcHRpb25OYW1lXSA9IG5ld09wdGlvbkhhc2hbb3B0aW9uTmFtZV07DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5fY2FsZW5kYXIudmlld1NwZWNNYW5hZ2VyLmNsZWFyQ2FjaGUoKTsgLy8gdGhlIGR5bmFtaWMgb3ZlcnJpZGUgaW52YWxpZGF0ZXMgdGhlIG9wdGlvbnMgaW4gdGhpcyBjYWNoZSwgc28ganVzdCBjbGVhciBpdA0KICAgICAgICB0aGlzLmNvbXB1dGUoKTsgLy8gdGhpcy5vcHRpb25zIG5lZWRzIHRvIGJlIHJlY29tcHV0ZWQgYWZ0ZXIgdGhlIGR5bmFtaWMgb3ZlcnJpZGUNCiAgICB9Ow0KICAgIHJldHVybiBPcHRpb25zTWFuYWdlcjsNCn0oTW9kZWxfMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBPcHRpb25zTWFuYWdlcjsNCgoKLyoqKi8gfSksCi8qIDI0MSAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIG1vbWVudCA9IF9fd2VicGFja19yZXF1aXJlX18oMCk7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgVmlld1JlZ2lzdHJ5XzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIxKTsNCnZhciB1dGlsXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQpOw0KdmFyIG9wdGlvbnNfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMzEpOw0KdmFyIGxvY2FsZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzMCk7DQp2YXIgVmlld1NwZWNNYW5hZ2VyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgew0KICAgIGZ1bmN0aW9uIFZpZXdTcGVjTWFuYWdlcihvcHRpb25zTWFuYWdlciwgX2NhbGVuZGFyKSB7DQogICAgICAgIHRoaXMub3B0aW9uc01hbmFnZXIgPSBvcHRpb25zTWFuYWdlcjsNCiAgICAgICAgdGhpcy5fY2FsZW5kYXIgPSBfY2FsZW5kYXI7DQogICAgICAgIHRoaXMuY2xlYXJDYWNoZSgpOw0KICAgIH0NCiAgICBWaWV3U3BlY01hbmFnZXIucHJvdG90eXBlLmNsZWFyQ2FjaGUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHRoaXMudmlld1NwZWNDYWNoZSA9IHt9Ow0KICAgIH07DQogICAgLy8gR2V0cyBpbmZvcm1hdGlvbiBhYm91dCBob3cgdG8gY3JlYXRlIGEgdmlldy4gV2lsbCB1c2UgYSBjYWNoZS4NCiAgICBWaWV3U3BlY01hbmFnZXIucHJvdG90eXBlLmdldFZpZXdTcGVjID0gZnVuY3Rpb24gKHZpZXdUeXBlKSB7DQogICAgICAgIHZhciBjYWNoZSA9IHRoaXMudmlld1NwZWNDYWNoZTsNCiAgICAgICAgcmV0dXJuIGNhY2hlW3ZpZXdUeXBlXSB8fCAoY2FjaGVbdmlld1R5cGVdID0gdGhpcy5idWlsZFZpZXdTcGVjKHZpZXdUeXBlKSk7DQogICAgfTsNCiAgICAvLyBHaXZlbiBhIGR1cmF0aW9uIHNpbmd1bGFyIHVuaXQsIGxpa2UgIndlZWsiIG9yICJkYXkiLCBmaW5kcyBhIG1hdGNoaW5nIHZpZXcgc3BlYy4NCiAgICAvLyBQcmVmZXJlbmNlIGlzIGdpdmVuIHRvIHZpZXdzIHRoYXQgaGF2ZSBjb3JyZXNwb25kaW5nIGJ1dHRvbnMuDQogICAgVmlld1NwZWNNYW5hZ2VyLnByb3RvdHlwZS5nZXRVbml0Vmlld1NwZWMgPSBmdW5jdGlvbiAodW5pdCkgew0KICAgICAgICB2YXIgdmlld1R5cGVzOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgdmFyIHNwZWM7DQogICAgICAgIGlmICgkLmluQXJyYXkodW5pdCwgdXRpbF8xLnVuaXRzRGVzYykgIT09IC0xKSB7DQogICAgICAgICAgICAvLyBwdXQgdmlld3MgdGhhdCBoYXZlIGJ1dHRvbnMgZmlyc3QuIHRoZXJlIHdpbGwgYmUgZHVwbGljYXRlcywgYnV0IG9oIHdlbGwNCiAgICAgICAgICAgIHZpZXdUeXBlcyA9IHRoaXMuX2NhbGVuZGFyLmhlYWRlci5nZXRWaWV3c1dpdGhCdXR0b25zKCk7IC8vIFRPRE86IGluY2x1ZGUgZm9vdGVyIGFzIHdlbGw/DQogICAgICAgICAgICAkLmVhY2goVmlld1JlZ2lzdHJ5XzEudmlld0hhc2gsIGZ1bmN0aW9uICh2aWV3VHlwZSkgew0KICAgICAgICAgICAgICAgIHZpZXdUeXBlcy5wdXNoKHZpZXdUeXBlKTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHZpZXdUeXBlcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgIHNwZWMgPSB0aGlzLmdldFZpZXdTcGVjKHZpZXdUeXBlc1tpXSk7DQogICAgICAgICAgICAgICAgaWYgKHNwZWMpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKHNwZWMuc2luZ2xlVW5pdCA9PT0gdW5pdCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNwZWM7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIEJ1aWxkcyBhbiBvYmplY3Qgd2l0aCBpbmZvcm1hdGlvbiBvbiBob3cgdG8gY3JlYXRlIGEgZ2l2ZW4gdmlldw0KICAgIFZpZXdTcGVjTWFuYWdlci5wcm90b3R5cGUuYnVpbGRWaWV3U3BlYyA9IGZ1bmN0aW9uIChyZXF1ZXN0ZWRWaWV3VHlwZSkgew0KICAgICAgICB2YXIgdmlld092ZXJyaWRlcyA9IHRoaXMub3B0aW9uc01hbmFnZXIub3ZlcnJpZGVzLnZpZXdzIHx8IHt9Ow0KICAgICAgICB2YXIgc3BlY0NoYWluID0gW107IC8vIGZvciB0aGUgdmlldy4gbG93ZXN0IHRvIGhpZ2hlc3QgcHJpb3JpdHkNCiAgICAgICAgdmFyIGRlZmF1bHRzQ2hhaW4gPSBbXTsgLy8gZm9yIHRoZSB2aWV3LiBsb3dlc3QgdG8gaGlnaGVzdCBwcmlvcml0eQ0KICAgICAgICB2YXIgb3ZlcnJpZGVzQ2hhaW4gPSBbXTsgLy8gZm9yIHRoZSB2aWV3LiBsb3dlc3QgdG8gaGlnaGVzdCBwcmlvcml0eQ0KICAgICAgICB2YXIgdmlld1R5cGUgPSByZXF1ZXN0ZWRWaWV3VHlwZTsNCiAgICAgICAgdmFyIHNwZWM7IC8vIGZvciB0aGUgdmlldw0KICAgICAgICB2YXIgb3ZlcnJpZGVzOyAvLyBmb3IgdGhlIHZpZXcNCiAgICAgICAgdmFyIGR1cmF0aW9uSW5wdXQ7DQogICAgICAgIHZhciBkdXJhdGlvbjsNCiAgICAgICAgdmFyIHVuaXQ7DQogICAgICAgIC8vIGl0ZXJhdGUgZnJvbSB0aGUgc3BlY2lmaWMgdmlldyBkZWZpbml0aW9uIHRvIGEgbW9yZSBnZW5lcmFsIG9uZSB1bnRpbCB3ZSBoaXQgYW4gYWN0dWFsIFZpZXcgY2xhc3MNCiAgICAgICAgd2hpbGUgKHZpZXdUeXBlKSB7DQogICAgICAgICAgICBzcGVjID0gVmlld1JlZ2lzdHJ5XzEudmlld0hhc2hbdmlld1R5cGVdOw0KICAgICAgICAgICAgb3ZlcnJpZGVzID0gdmlld092ZXJyaWRlc1t2aWV3VHlwZV07DQogICAgICAgICAgICB2aWV3VHlwZSA9IG51bGw7IC8vIGNsZWFyLiBtaWdodCByZXBvcHVsYXRlIGZvciBhbm90aGVyIGl0ZXJhdGlvbg0KICAgICAgICAgICAgaWYgKHR5cGVvZiBzcGVjID09PSAnZnVuY3Rpb24nKSB7DQogICAgICAgICAgICAgICAgc3BlYyA9IHsgJ2NsYXNzJzogc3BlYyB9Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKHNwZWMpIHsNCiAgICAgICAgICAgICAgICBzcGVjQ2hhaW4udW5zaGlmdChzcGVjKTsNCiAgICAgICAgICAgICAgICBkZWZhdWx0c0NoYWluLnVuc2hpZnQoc3BlYy5kZWZhdWx0cyB8fCB7fSk7DQogICAgICAgICAgICAgICAgZHVyYXRpb25JbnB1dCA9IGR1cmF0aW9uSW5wdXQgfHwgc3BlYy5kdXJhdGlvbjsNCiAgICAgICAgICAgICAgICB2aWV3VHlwZSA9IHZpZXdUeXBlIHx8IHNwZWMudHlwZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChvdmVycmlkZXMpIHsNCiAgICAgICAgICAgICAgICBvdmVycmlkZXNDaGFpbi51bnNoaWZ0KG92ZXJyaWRlcyk7IC8vIHZpZXctc3BlY2lmaWMgb3B0aW9uIGhhc2hlcyBoYXZlIG9wdGlvbnMgYXQgemVyby1sZXZlbA0KICAgICAgICAgICAgICAgIGR1cmF0aW9uSW5wdXQgPSBkdXJhdGlvbklucHV0IHx8IG92ZXJyaWRlcy5kdXJhdGlvbjsNCiAgICAgICAgICAgICAgICB2aWV3VHlwZSA9IHZpZXdUeXBlIHx8IG92ZXJyaWRlcy50eXBlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHNwZWMgPSB1dGlsXzEubWVyZ2VQcm9wcyhzcGVjQ2hhaW4pOw0KICAgICAgICBzcGVjLnR5cGUgPSByZXF1ZXN0ZWRWaWV3VHlwZTsNCiAgICAgICAgaWYgKCFzcGVjWydjbGFzcyddKSB7DQogICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0NCiAgICAgICAgLy8gZmFsbCBiYWNrIHRvIHRvcC1sZXZlbCBgZHVyYXRpb25gIG9wdGlvbg0KICAgICAgICBkdXJhdGlvbklucHV0ID0gZHVyYXRpb25JbnB1dCB8fA0KICAgICAgICAgICAgdGhpcy5vcHRpb25zTWFuYWdlci5keW5hbWljT3ZlcnJpZGVzLmR1cmF0aW9uIHx8DQogICAgICAgICAgICB0aGlzLm9wdGlvbnNNYW5hZ2VyLm92ZXJyaWRlcy5kdXJhdGlvbjsNCiAgICAgICAgaWYgKGR1cmF0aW9uSW5wdXQpIHsNCiAgICAgICAgICAgIGR1cmF0aW9uID0gbW9tZW50LmR1cmF0aW9uKGR1cmF0aW9uSW5wdXQpOw0KICAgICAgICAgICAgaWYgKGR1cmF0aW9uLnZhbHVlT2YoKSkgew0KICAgICAgICAgICAgICAgIHVuaXQgPSB1dGlsXzEuY29tcHV0ZUR1cmF0aW9uR3JlYXRlc3RVbml0KGR1cmF0aW9uLCBkdXJhdGlvbklucHV0KTsNCiAgICAgICAgICAgICAgICBzcGVjLmR1cmF0aW9uID0gZHVyYXRpb247DQogICAgICAgICAgICAgICAgc3BlYy5kdXJhdGlvblVuaXQgPSB1bml0Ow0KICAgICAgICAgICAgICAgIC8vIHZpZXcgaXMgYSBzaW5nbGUtdW5pdCBkdXJhdGlvbiwgbGlrZSAid2VlayIgb3IgImRheSINCiAgICAgICAgICAgICAgICAvLyBpbmNvcnBvcmF0ZSBvcHRpb25zIGZvciB0aGlzLiBsb3dlc3QgcHJpb3JpdHkNCiAgICAgICAgICAgICAgICBpZiAoZHVyYXRpb24uYXModW5pdCkgPT09IDEpIHsNCiAgICAgICAgICAgICAgICAgICAgc3BlYy5zaW5nbGVVbml0ID0gdW5pdDsNCiAgICAgICAgICAgICAgICAgICAgb3ZlcnJpZGVzQ2hhaW4udW5zaGlmdCh2aWV3T3ZlcnJpZGVzW3VuaXRdIHx8IHt9KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgc3BlYy5kZWZhdWx0cyA9IG9wdGlvbnNfMS5tZXJnZU9wdGlvbnMoZGVmYXVsdHNDaGFpbik7DQogICAgICAgIHNwZWMub3ZlcnJpZGVzID0gb3B0aW9uc18xLm1lcmdlT3B0aW9ucyhvdmVycmlkZXNDaGFpbik7DQogICAgICAgIHRoaXMuYnVpbGRWaWV3U3BlY09wdGlvbnMoc3BlYyk7DQogICAgICAgIHRoaXMuYnVpbGRWaWV3U3BlY0J1dHRvblRleHQoc3BlYywgcmVxdWVzdGVkVmlld1R5cGUpOw0KICAgICAgICByZXR1cm4gc3BlYzsNCiAgICB9Ow0KICAgIC8vIEJ1aWxkcyBhbmQgYXNzaWducyBhIHZpZXcgc3BlYydzIG9wdGlvbnMgb2JqZWN0IGZyb20gaXRzIGFscmVhZHktYXNzaWduZWQgZGVmYXVsdHMgYW5kIG92ZXJyaWRlcw0KICAgIFZpZXdTcGVjTWFuYWdlci5wcm90b3R5cGUuYnVpbGRWaWV3U3BlY09wdGlvbnMgPSBmdW5jdGlvbiAoc3BlYykgew0KICAgICAgICB2YXIgb3B0aW9uc01hbmFnZXIgPSB0aGlzLm9wdGlvbnNNYW5hZ2VyOw0KICAgICAgICBzcGVjLm9wdGlvbnMgPSBvcHRpb25zXzEubWVyZ2VPcHRpb25zKFsNCiAgICAgICAgICAgIG9wdGlvbnNfMS5nbG9iYWxEZWZhdWx0cywNCiAgICAgICAgICAgIHNwZWMuZGVmYXVsdHMsDQogICAgICAgICAgICBvcHRpb25zTWFuYWdlci5kaXJEZWZhdWx0cywNCiAgICAgICAgICAgIG9wdGlvbnNNYW5hZ2VyLmxvY2FsZURlZmF1bHRzLA0KICAgICAgICAgICAgb3B0aW9uc01hbmFnZXIub3ZlcnJpZGVzLA0KICAgICAgICAgICAgc3BlYy5vdmVycmlkZXMsDQogICAgICAgICAgICBvcHRpb25zTWFuYWdlci5keW5hbWljT3ZlcnJpZGVzIC8vIGR5bmFtaWNhbGx5IHNldCB2aWEgc2V0dGVyLiBoaWdoZXN0IHByZWNlZGVuY2UNCiAgICAgICAgXSk7DQogICAgICAgIGxvY2FsZV8xLnBvcHVsYXRlSW5zdGFuY2VDb21wdXRhYmxlT3B0aW9ucyhzcGVjLm9wdGlvbnMpOw0KICAgIH07DQogICAgLy8gQ29tcHV0ZXMgYW5kIGFzc2lnbnMgYSB2aWV3IHNwZWMncyBidXR0b25UZXh0LXJlbGF0ZWQgb3B0aW9ucw0KICAgIFZpZXdTcGVjTWFuYWdlci5wcm90b3R5cGUuYnVpbGRWaWV3U3BlY0J1dHRvblRleHQgPSBmdW5jdGlvbiAoc3BlYywgcmVxdWVzdGVkVmlld1R5cGUpIHsNCiAgICAgICAgdmFyIG9wdGlvbnNNYW5hZ2VyID0gdGhpcy5vcHRpb25zTWFuYWdlcjsNCiAgICAgICAgLy8gZ2l2ZW4gYW4gb3B0aW9ucyBvYmplY3Qgd2l0aCBhIHBvc3NpYmxlIGBidXR0b25UZXh0YCBoYXNoLCBsb29rdXAgdGhlIGJ1dHRvblRleHQgZm9yIHRoZQ0KICAgICAgICAvLyByZXF1ZXN0ZWQgdmlldywgZmFsbGluZyBiYWNrIHRvIGEgZ2VuZXJpYyB1bml0IGVudHJ5IGxpa2UgIndlZWsiIG9yICJkYXkiDQogICAgICAgIGZ1bmN0aW9uIHF1ZXJ5QnV0dG9uVGV4dChvcHRpb25zKSB7DQogICAgICAgICAgICB2YXIgYnV0dG9uVGV4dCA9IG9wdGlvbnMuYnV0dG9uVGV4dCB8fCB7fTsNCiAgICAgICAgICAgIHJldHVybiBidXR0b25UZXh0W3JlcXVlc3RlZFZpZXdUeXBlXSB8fA0KICAgICAgICAgICAgICAgIC8vIHZpZXcgY2FuIGRlY2lkZSB0byBsb29rIHVwIGEgY2VydGFpbiBrZXkNCiAgICAgICAgICAgICAgICAoc3BlYy5idXR0b25UZXh0S2V5ID8gYnV0dG9uVGV4dFtzcGVjLmJ1dHRvblRleHRLZXldIDogbnVsbCkgfHwNCiAgICAgICAgICAgICAgICAvLyBhIGtleSBsaWtlICJtb250aCINCiAgICAgICAgICAgICAgICAoc3BlYy5zaW5nbGVVbml0ID8gYnV0dG9uVGV4dFtzcGVjLnNpbmdsZVVuaXRdIDogbnVsbCk7DQogICAgICAgIH0NCiAgICAgICAgLy8gaGlnaGVzdCB0byBsb3dlc3QgcHJpb3JpdHkNCiAgICAgICAgc3BlYy5idXR0b25UZXh0T3ZlcnJpZGUgPQ0KICAgICAgICAgICAgcXVlcnlCdXR0b25UZXh0KG9wdGlvbnNNYW5hZ2VyLmR5bmFtaWNPdmVycmlkZXMpIHx8DQogICAgICAgICAgICAgICAgcXVlcnlCdXR0b25UZXh0KG9wdGlvbnNNYW5hZ2VyLm92ZXJyaWRlcykgfHwgLy8gY29uc3RydWN0b3Itc3BlY2lmaWVkIGJ1dHRvblRleHQgbG9va3VwIGhhc2ggdGFrZXMgcHJlY2VkZW5jZQ0KICAgICAgICAgICAgICAgIHNwZWMub3ZlcnJpZGVzLmJ1dHRvblRleHQ7IC8vIGBidXR0b25UZXh0YCBmb3Igdmlldy1zcGVjaWZpYyBvcHRpb25zIGlzIGEgc3RyaW5nDQogICAgICAgIC8vIGhpZ2hlc3QgdG8gbG93ZXN0IHByaW9yaXR5LiBtaXJyb3JzIGJ1aWxkVmlld1NwZWNPcHRpb25zDQogICAgICAgIHNwZWMuYnV0dG9uVGV4dERlZmF1bHQgPQ0KICAgICAgICAgICAgcXVlcnlCdXR0b25UZXh0KG9wdGlvbnNNYW5hZ2VyLmxvY2FsZURlZmF1bHRzKSB8fA0KICAgICAgICAgICAgICAgIHF1ZXJ5QnV0dG9uVGV4dChvcHRpb25zTWFuYWdlci5kaXJEZWZhdWx0cykgfHwNCiAgICAgICAgICAgICAgICBzcGVjLmRlZmF1bHRzLmJ1dHRvblRleHQgfHwgLy8gYSBzaW5nbGUgc3RyaW5nLiBmcm9tIFZpZXdTdWJjbGFzcy5kZWZhdWx0cw0KICAgICAgICAgICAgICAgIHF1ZXJ5QnV0dG9uVGV4dChvcHRpb25zXzEuZ2xvYmFsRGVmYXVsdHMpIHx8DQogICAgICAgICAgICAgICAgKHNwZWMuZHVyYXRpb24gPyB0aGlzLl9jYWxlbmRhci5odW1hbml6ZUR1cmF0aW9uKHNwZWMuZHVyYXRpb24pIDogbnVsbCkgfHwgLy8gbGlrZSAiMyBkYXlzIg0KICAgICAgICAgICAgICAgIHJlcXVlc3RlZFZpZXdUeXBlOyAvLyBmYWxsIGJhY2sgdG8gZ2l2ZW4gdmlldyBuYW1lDQogICAgfTsNCiAgICByZXR1cm4gVmlld1NwZWNNYW5hZ2VyOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IFZpZXdTcGVjTWFuYWdlcjsNCgoKLyoqKi8gfSksCi8qIDI0MiAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyICQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgRXZlbnRQZXJpb2RfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjQzKTsNCnZhciBBcnJheUV2ZW50U291cmNlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUyKTsNCnZhciBFdmVudFNvdXJjZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg2KTsNCnZhciBFdmVudFNvdXJjZVBhcnNlcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzNyk7DQp2YXIgU2luZ2xlRXZlbnREZWZfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTMpOw0KdmFyIEV2ZW50SW5zdGFuY2VHcm91cF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxOSk7DQp2YXIgRW1pdHRlck1peGluXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDExKTsNCnZhciBMaXN0ZW5lck1peGluXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDcpOw0KdmFyIEV2ZW50TWFuYWdlciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsNCiAgICBmdW5jdGlvbiBFdmVudE1hbmFnZXIoY2FsZW5kYXIpIHsNCiAgICAgICAgdGhpcy5jYWxlbmRhciA9IGNhbGVuZGFyOw0KICAgICAgICB0aGlzLnN0aWNreVNvdXJjZSA9IG5ldyBBcnJheUV2ZW50U291cmNlXzEuZGVmYXVsdChjYWxlbmRhcik7DQogICAgICAgIHRoaXMub3RoZXJTb3VyY2VzID0gW107DQogICAgfQ0KICAgIEV2ZW50TWFuYWdlci5wcm90b3R5cGUucmVxdWVzdEV2ZW50cyA9IGZ1bmN0aW9uIChzdGFydCwgZW5kLCB0aW1lem9uZSwgZm9yY2UpIHsNCiAgICAgICAgaWYgKGZvcmNlIHx8DQogICAgICAgICAgICAhdGhpcy5jdXJyZW50UGVyaW9kIHx8DQogICAgICAgICAgICAhdGhpcy5jdXJyZW50UGVyaW9kLmlzV2l0aGluUmFuZ2Uoc3RhcnQsIGVuZCkgfHwNCiAgICAgICAgICAgIHRpbWV6b25lICE9PSB0aGlzLmN1cnJlbnRQZXJpb2QudGltZXpvbmUpIHsNCiAgICAgICAgICAgIHRoaXMuc2V0UGVyaW9kKC8vIHdpbGwgY2hhbmdlIHRoaXMuY3VycmVudFBlcmlvZA0KICAgICAgICAgICAgbmV3IEV2ZW50UGVyaW9kXzEuZGVmYXVsdChzdGFydCwgZW5kLCB0aW1lem9uZSkpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRQZXJpb2Qud2hlblJlbGVhc2VkKCk7DQogICAgfTsNCiAgICAvLyBTb3VyY2UgQWRkaW5nL1JlbW92aW5nDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICBFdmVudE1hbmFnZXIucHJvdG90eXBlLmFkZFNvdXJjZSA9IGZ1bmN0aW9uIChldmVudFNvdXJjZSkgew0KICAgICAgICB0aGlzLm90aGVyU291cmNlcy5wdXNoKGV2ZW50U291cmNlKTsNCiAgICAgICAgaWYgKHRoaXMuY3VycmVudFBlcmlvZCkgew0KICAgICAgICAgICAgdGhpcy5jdXJyZW50UGVyaW9kLnJlcXVlc3RTb3VyY2UoZXZlbnRTb3VyY2UpOyAvLyBtaWdodCByZWxlYXNlDQogICAgICAgIH0NCiAgICB9Ow0KICAgIEV2ZW50TWFuYWdlci5wcm90b3R5cGUucmVtb3ZlU291cmNlID0gZnVuY3Rpb24gKGRvb21lZFNvdXJjZSkgew0KICAgICAgICB1dGlsXzEucmVtb3ZlRXhhY3QodGhpcy5vdGhlclNvdXJjZXMsIGRvb21lZFNvdXJjZSk7DQogICAgICAgIGlmICh0aGlzLmN1cnJlbnRQZXJpb2QpIHsNCiAgICAgICAgICAgIHRoaXMuY3VycmVudFBlcmlvZC5wdXJnZVNvdXJjZShkb29tZWRTb3VyY2UpOyAvLyBtaWdodCByZWxlYXNlDQogICAgICAgIH0NCiAgICB9Ow0KICAgIEV2ZW50TWFuYWdlci5wcm90b3R5cGUucmVtb3ZlQWxsU291cmNlcyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5vdGhlclNvdXJjZXMgPSBbXTsNCiAgICAgICAgaWYgKHRoaXMuY3VycmVudFBlcmlvZCkgew0KICAgICAgICAgICAgdGhpcy5jdXJyZW50UGVyaW9kLnB1cmdlQWxsU291cmNlcygpOyAvLyBtaWdodCByZWxlYXNlDQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIFNvdXJjZSBSZWZldGNoaW5nDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICBFdmVudE1hbmFnZXIucHJvdG90eXBlLnJlZmV0Y2hTb3VyY2UgPSBmdW5jdGlvbiAoZXZlbnRTb3VyY2UpIHsNCiAgICAgICAgdmFyIGN1cnJlbnRQZXJpb2QgPSB0aGlzLmN1cnJlbnRQZXJpb2Q7DQogICAgICAgIGlmIChjdXJyZW50UGVyaW9kKSB7DQogICAgICAgICAgICBjdXJyZW50UGVyaW9kLmZyZWV6ZSgpOw0KICAgICAgICAgICAgY3VycmVudFBlcmlvZC5wdXJnZVNvdXJjZShldmVudFNvdXJjZSk7DQogICAgICAgICAgICBjdXJyZW50UGVyaW9kLnJlcXVlc3RTb3VyY2UoZXZlbnRTb3VyY2UpOw0KICAgICAgICAgICAgY3VycmVudFBlcmlvZC50aGF3KCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIEV2ZW50TWFuYWdlci5wcm90b3R5cGUucmVmZXRjaEFsbFNvdXJjZXMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBjdXJyZW50UGVyaW9kID0gdGhpcy5jdXJyZW50UGVyaW9kOw0KICAgICAgICBpZiAoY3VycmVudFBlcmlvZCkgew0KICAgICAgICAgICAgY3VycmVudFBlcmlvZC5mcmVlemUoKTsNCiAgICAgICAgICAgIGN1cnJlbnRQZXJpb2QucHVyZ2VBbGxTb3VyY2VzKCk7DQogICAgICAgICAgICBjdXJyZW50UGVyaW9kLnJlcXVlc3RTb3VyY2VzKHRoaXMuZ2V0U291cmNlcygpKTsNCiAgICAgICAgICAgIGN1cnJlbnRQZXJpb2QudGhhdygpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBTb3VyY2UgUXVlcnlpbmcNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIEV2ZW50TWFuYWdlci5wcm90b3R5cGUuZ2V0U291cmNlcyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIFt0aGlzLnN0aWNreVNvdXJjZV0uY29uY2F0KHRoaXMub3RoZXJTb3VyY2VzKTsNCiAgICB9Ow0KICAgIC8vIGxpa2UgcXVlcnlTb3VyY2VzLCBidXQgYWNjZXB0cyBtdWx0cGxlIG1hdGNoIGNyaXRlcmlhIChsaWtlIG11bHRpcGxlIElEcykNCiAgICBFdmVudE1hbmFnZXIucHJvdG90eXBlLm11bHRpUXVlcnlTb3VyY2VzID0gZnVuY3Rpb24gKG1hdGNoSW5wdXRzKSB7DQogICAgICAgIC8vIGNvZXJjZSBpbnRvIGFuIGFycmF5DQogICAgICAgIGlmICghbWF0Y2hJbnB1dHMpIHsNCiAgICAgICAgICAgIG1hdGNoSW5wdXRzID0gW107DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAoISQuaXNBcnJheShtYXRjaElucHV0cykpIHsNCiAgICAgICAgICAgIG1hdGNoSW5wdXRzID0gW21hdGNoSW5wdXRzXTsNCiAgICAgICAgfQ0KICAgICAgICB2YXIgbWF0Y2hpbmdTb3VyY2VzID0gW107DQogICAgICAgIHZhciBpOw0KICAgICAgICAvLyByZXNvbHZlIHJhdyBpbnB1dHMgdG8gcmVhbCBldmVudCBzb3VyY2Ugb2JqZWN0cw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbWF0Y2hJbnB1dHMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIG1hdGNoaW5nU291cmNlcy5wdXNoLmFwcGx5KC8vIGFwcGVuZA0KICAgICAgICAgICAgbWF0Y2hpbmdTb3VyY2VzLCB0aGlzLnF1ZXJ5U291cmNlcyhtYXRjaElucHV0c1tpXSkpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBtYXRjaGluZ1NvdXJjZXM7DQogICAgfTsNCiAgICAvLyBtYXRjaElucHV0IGNhbiBlaXRoZXIgYnkgYSByZWFsIGV2ZW50IHNvdXJjZSBvYmplY3QsIGFuIElELCBvciB0aGUgZnVuY3Rpb24vVVJMIGZvciB0aGUgc291cmNlLg0KICAgIC8vIHJldHVybnMgYW4gYXJyYXkgb2YgbWF0Y2hpbmcgc291cmNlIG9iamVjdHMuDQogICAgRXZlbnRNYW5hZ2VyLnByb3RvdHlwZS5xdWVyeVNvdXJjZXMgPSBmdW5jdGlvbiAobWF0Y2hJbnB1dCkgew0KICAgICAgICB2YXIgc291cmNlcyA9IHRoaXMub3RoZXJTb3VyY2VzOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgdmFyIHNvdXJjZTsNCiAgICAgICAgLy8gZ2l2ZW4gYSBwcm9wZXIgZXZlbnQgc291cmNlIG9iamVjdA0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc291cmNlcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgc291cmNlID0gc291cmNlc1tpXTsNCiAgICAgICAgICAgIGlmIChzb3VyY2UgPT09IG1hdGNoSW5wdXQpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gW3NvdXJjZV07DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgLy8gYW4gSUQgbWF0Y2gNCiAgICAgICAgc291cmNlID0gdGhpcy5nZXRTb3VyY2VCeUlkKEV2ZW50U291cmNlXzEuZGVmYXVsdC5ub3JtYWxpemVJZChtYXRjaElucHV0KSk7DQogICAgICAgIGlmIChzb3VyY2UpIHsNCiAgICAgICAgICAgIHJldHVybiBbc291cmNlXTsNCiAgICAgICAgfQ0KICAgICAgICAvLyBwYXJzZSBhcyBhbiBldmVudCBzb3VyY2UNCiAgICAgICAgbWF0Y2hJbnB1dCA9IEV2ZW50U291cmNlUGFyc2VyXzEuZGVmYXVsdC5wYXJzZShtYXRjaElucHV0LCB0aGlzLmNhbGVuZGFyKTsNCiAgICAgICAgaWYgKG1hdGNoSW5wdXQpIHsNCiAgICAgICAgICAgIHJldHVybiAkLmdyZXAoc291cmNlcywgZnVuY3Rpb24gKHNvdXJjZSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBpc1NvdXJjZXNFcXVpdmFsZW50KG1hdGNoSW5wdXQsIHNvdXJjZSk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLyoNCiAgICBJRCBhc3N1bWVkIHRvIGFscmVhZHkgYmUgbm9ybWFsaXplZA0KICAgICovDQogICAgRXZlbnRNYW5hZ2VyLnByb3RvdHlwZS5nZXRTb3VyY2VCeUlkID0gZnVuY3Rpb24gKGlkKSB7DQogICAgICAgIHJldHVybiAkLmdyZXAodGhpcy5vdGhlclNvdXJjZXMsIGZ1bmN0aW9uIChzb3VyY2UpIHsNCiAgICAgICAgICAgIHJldHVybiBzb3VyY2UuaWQgJiYgc291cmNlLmlkID09PSBpZDsNCiAgICAgICAgfSlbMF07DQogICAgfTsNCiAgICAvLyBFdmVudC1QZXJpb2QNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIEV2ZW50TWFuYWdlci5wcm90b3R5cGUuc2V0UGVyaW9kID0gZnVuY3Rpb24gKGV2ZW50UGVyaW9kKSB7DQogICAgICAgIGlmICh0aGlzLmN1cnJlbnRQZXJpb2QpIHsNCiAgICAgICAgICAgIHRoaXMudW5iaW5kUGVyaW9kKHRoaXMuY3VycmVudFBlcmlvZCk7DQogICAgICAgICAgICB0aGlzLmN1cnJlbnRQZXJpb2QgPSBudWxsOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuY3VycmVudFBlcmlvZCA9IGV2ZW50UGVyaW9kOw0KICAgICAgICB0aGlzLmJpbmRQZXJpb2QoZXZlbnRQZXJpb2QpOw0KICAgICAgICBldmVudFBlcmlvZC5yZXF1ZXN0U291cmNlcyh0aGlzLmdldFNvdXJjZXMoKSk7DQogICAgfTsNCiAgICBFdmVudE1hbmFnZXIucHJvdG90eXBlLmJpbmRQZXJpb2QgPSBmdW5jdGlvbiAoZXZlbnRQZXJpb2QpIHsNCiAgICAgICAgdGhpcy5saXN0ZW5UbyhldmVudFBlcmlvZCwgJ3JlbGVhc2UnLCBmdW5jdGlvbiAoZXZlbnRzUGF5bG9hZCkgew0KICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdyZWxlYXNlJywgZXZlbnRzUGF5bG9hZCk7DQogICAgICAgIH0pOw0KICAgIH07DQogICAgRXZlbnRNYW5hZ2VyLnByb3RvdHlwZS51bmJpbmRQZXJpb2QgPSBmdW5jdGlvbiAoZXZlbnRQZXJpb2QpIHsNCiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nVG8oZXZlbnRQZXJpb2QpOw0KICAgIH07DQogICAgLy8gRXZlbnQgR2V0dGluZy9BZGRpbmcvUmVtb3ZpbmcNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIEV2ZW50TWFuYWdlci5wcm90b3R5cGUuZ2V0RXZlbnREZWZCeVVpZCA9IGZ1bmN0aW9uICh1aWQpIHsNCiAgICAgICAgaWYgKHRoaXMuY3VycmVudFBlcmlvZCkgew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFBlcmlvZC5nZXRFdmVudERlZkJ5VWlkKHVpZCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIEV2ZW50TWFuYWdlci5wcm90b3R5cGUuYWRkRXZlbnREZWYgPSBmdW5jdGlvbiAoZXZlbnREZWYsIGlzU3RpY2t5KSB7DQogICAgICAgIGlmIChpc1N0aWNreSkgew0KICAgICAgICAgICAgdGhpcy5zdGlja3lTb3VyY2UuYWRkRXZlbnREZWYoZXZlbnREZWYpOw0KICAgICAgICB9DQogICAgICAgIGlmICh0aGlzLmN1cnJlbnRQZXJpb2QpIHsNCiAgICAgICAgICAgIHRoaXMuY3VycmVudFBlcmlvZC5hZGRFdmVudERlZihldmVudERlZik7IC8vIG1pZ2h0IHJlbGVhc2UNCiAgICAgICAgfQ0KICAgIH07DQogICAgRXZlbnRNYW5hZ2VyLnByb3RvdHlwZS5yZW1vdmVFdmVudERlZnNCeUlkID0gZnVuY3Rpb24gKGV2ZW50SWQpIHsNCiAgICAgICAgdGhpcy5nZXRTb3VyY2VzKCkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnRTb3VyY2UpIHsNCiAgICAgICAgICAgIGV2ZW50U291cmNlLnJlbW92ZUV2ZW50RGVmc0J5SWQoZXZlbnRJZCk7DQogICAgICAgIH0pOw0KICAgICAgICBpZiAodGhpcy5jdXJyZW50UGVyaW9kKSB7DQogICAgICAgICAgICB0aGlzLmN1cnJlbnRQZXJpb2QucmVtb3ZlRXZlbnREZWZzQnlJZChldmVudElkKTsgLy8gbWlnaHQgcmVsZWFzZQ0KICAgICAgICB9DQogICAgfTsNCiAgICBFdmVudE1hbmFnZXIucHJvdG90eXBlLnJlbW92ZUFsbEV2ZW50RGVmcyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5nZXRTb3VyY2VzKCkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnRTb3VyY2UpIHsNCiAgICAgICAgICAgIGV2ZW50U291cmNlLnJlbW92ZUFsbEV2ZW50RGVmcygpOw0KICAgICAgICB9KTsNCiAgICAgICAgaWYgKHRoaXMuY3VycmVudFBlcmlvZCkgew0KICAgICAgICAgICAgdGhpcy5jdXJyZW50UGVyaW9kLnJlbW92ZUFsbEV2ZW50RGVmcygpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBFdmVudCBNdXRhdGluZw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgLyoNCiAgICBSZXR1cm5zIGFuIHVuZG8gZnVuY3Rpb24uDQogICAgKi8NCiAgICBFdmVudE1hbmFnZXIucHJvdG90eXBlLm11dGF0ZUV2ZW50c1dpdGhJZCA9IGZ1bmN0aW9uIChldmVudERlZklkLCBldmVudERlZk11dGF0aW9uKSB7DQogICAgICAgIHZhciBjdXJyZW50UGVyaW9kID0gdGhpcy5jdXJyZW50UGVyaW9kOw0KICAgICAgICB2YXIgZXZlbnREZWZzOw0KICAgICAgICB2YXIgdW5kb0Z1bmNzID0gW107DQogICAgICAgIGlmIChjdXJyZW50UGVyaW9kKSB7DQogICAgICAgICAgICBjdXJyZW50UGVyaW9kLmZyZWV6ZSgpOw0KICAgICAgICAgICAgZXZlbnREZWZzID0gY3VycmVudFBlcmlvZC5nZXRFdmVudERlZnNCeUlkKGV2ZW50RGVmSWQpOw0KICAgICAgICAgICAgZXZlbnREZWZzLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50RGVmKSB7DQogICAgICAgICAgICAgICAgLy8gYWRkL3JlbW92ZSBlc3AgYmVjYXVzZSBpZCBtaWdodCBjaGFuZ2UNCiAgICAgICAgICAgICAgICBjdXJyZW50UGVyaW9kLnJlbW92ZUV2ZW50RGVmKGV2ZW50RGVmKTsNCiAgICAgICAgICAgICAgICB1bmRvRnVuY3MucHVzaChldmVudERlZk11dGF0aW9uLm11dGF0ZVNpbmdsZShldmVudERlZikpOw0KICAgICAgICAgICAgICAgIGN1cnJlbnRQZXJpb2QuYWRkRXZlbnREZWYoZXZlbnREZWYpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICBjdXJyZW50UGVyaW9kLnRoYXcoKTsNCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgY3VycmVudFBlcmlvZC5mcmVlemUoKTsNCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50RGVmcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGVyaW9kLnJlbW92ZUV2ZW50RGVmKGV2ZW50RGVmc1tpXSk7DQogICAgICAgICAgICAgICAgICAgIHVuZG9GdW5jc1tpXSgpOw0KICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGVyaW9kLmFkZEV2ZW50RGVmKGV2ZW50RGVmc1tpXSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGN1cnJlbnRQZXJpb2QudGhhdygpOw0KICAgICAgICAgICAgfTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgeyB9Ow0KICAgIH07DQogICAgLyoNCiAgICBjb3BpZXMgYW5kIHRoZW4gbXV0YXRlcw0KICAgICovDQogICAgRXZlbnRNYW5hZ2VyLnByb3RvdHlwZS5idWlsZE11dGF0ZWRFdmVudEluc3RhbmNlR3JvdXAgPSBmdW5jdGlvbiAoZXZlbnREZWZJZCwgZXZlbnREZWZNdXRhdGlvbikgew0KICAgICAgICB2YXIgZXZlbnREZWZzID0gdGhpcy5nZXRFdmVudERlZnNCeUlkKGV2ZW50RGVmSWQpOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgdmFyIGRlZkNvcHk7DQogICAgICAgIHZhciBhbGxJbnN0YW5jZXMgPSBbXTsNCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGV2ZW50RGVmcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgZGVmQ29weSA9IGV2ZW50RGVmc1tpXS5jbG9uZSgpOw0KICAgICAgICAgICAgaWYgKGRlZkNvcHkgaW5zdGFuY2VvZiBTaW5nbGVFdmVudERlZl8xLmRlZmF1bHQpIHsNCiAgICAgICAgICAgICAgICBldmVudERlZk11dGF0aW9uLm11dGF0ZVNpbmdsZShkZWZDb3B5KTsNCiAgICAgICAgICAgICAgICBhbGxJbnN0YW5jZXMucHVzaC5hcHBseShhbGxJbnN0YW5jZXMsIC8vIGFwcGVuZA0KICAgICAgICAgICAgICAgIGRlZkNvcHkuYnVpbGRJbnN0YW5jZXMoKSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIG5ldyBFdmVudEluc3RhbmNlR3JvdXBfMS5kZWZhdWx0KGFsbEluc3RhbmNlcyk7DQogICAgfTsNCiAgICAvLyBGcmVlemluZw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgRXZlbnRNYW5hZ2VyLnByb3RvdHlwZS5mcmVlemUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICh0aGlzLmN1cnJlbnRQZXJpb2QpIHsNCiAgICAgICAgICAgIHRoaXMuY3VycmVudFBlcmlvZC5mcmVlemUoKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgRXZlbnRNYW5hZ2VyLnByb3RvdHlwZS50aGF3ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5jdXJyZW50UGVyaW9kKSB7DQogICAgICAgICAgICB0aGlzLmN1cnJlbnRQZXJpb2QudGhhdygpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBtZXRob2RzIHRoYXQgc2ltcGx5IGZvcndhcmQgdG8gRXZlbnRQZXJpb2QNCiAgICBFdmVudE1hbmFnZXIucHJvdG90eXBlLmdldEV2ZW50RGVmc0J5SWQgPSBmdW5jdGlvbiAoZXZlbnREZWZJZCkgew0KICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50UGVyaW9kLmdldEV2ZW50RGVmc0J5SWQoZXZlbnREZWZJZCk7DQogICAgfTsNCiAgICBFdmVudE1hbmFnZXIucHJvdG90eXBlLmdldEV2ZW50SW5zdGFuY2VzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50UGVyaW9kLmdldEV2ZW50SW5zdGFuY2VzKCk7DQogICAgfTsNCiAgICBFdmVudE1hbmFnZXIucHJvdG90eXBlLmdldEV2ZW50SW5zdGFuY2VzV2l0aElkID0gZnVuY3Rpb24gKGV2ZW50RGVmSWQpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFBlcmlvZC5nZXRFdmVudEluc3RhbmNlc1dpdGhJZChldmVudERlZklkKTsNCiAgICB9Ow0KICAgIEV2ZW50TWFuYWdlci5wcm90b3R5cGUuZ2V0RXZlbnRJbnN0YW5jZXNXaXRob3V0SWQgPSBmdW5jdGlvbiAoZXZlbnREZWZJZCkgew0KICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50UGVyaW9kLmdldEV2ZW50SW5zdGFuY2VzV2l0aG91dElkKGV2ZW50RGVmSWQpOw0KICAgIH07DQogICAgcmV0dXJuIEV2ZW50TWFuYWdlcjsNCn0oKSk7DQpleHBvcnRzLmRlZmF1bHQgPSBFdmVudE1hbmFnZXI7DQpFbWl0dGVyTWl4aW5fMS5kZWZhdWx0Lm1peEludG8oRXZlbnRNYW5hZ2VyKTsNCkxpc3RlbmVyTWl4aW5fMS5kZWZhdWx0Lm1peEludG8oRXZlbnRNYW5hZ2VyKTsNCmZ1bmN0aW9uIGlzU291cmNlc0VxdWl2YWxlbnQoc291cmNlMCwgc291cmNlMSkgew0KICAgIHJldHVybiBzb3VyY2UwLmdldFByaW1pdGl2ZSgpID09PSBzb3VyY2UxLmdldFByaW1pdGl2ZSgpOw0KfQ0KCgovKioqLyB9KSwKLyogMjQzICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCnZhciBQcm9taXNlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIwKTsNCnZhciBFbWl0dGVyTWl4aW5fMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTEpOw0KdmFyIFVuem9uZWRSYW5nZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1KTsNCnZhciBFdmVudEluc3RhbmNlR3JvdXBfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMTkpOw0KdmFyIEV2ZW50UGVyaW9kID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgew0KICAgIGZ1bmN0aW9uIEV2ZW50UGVyaW9kKHN0YXJ0LCBlbmQsIHRpbWV6b25lKSB7DQogICAgICAgIHRoaXMucGVuZGluZ0NudCA9IDA7DQogICAgICAgIHRoaXMuZnJlZXplRGVwdGggPSAwOw0KICAgICAgICB0aGlzLnN0dW50ZWRSZWxlYXNlQ250ID0gMDsNCiAgICAgICAgdGhpcy5yZWxlYXNlQ250ID0gMDsNCiAgICAgICAgdGhpcy5zdGFydCA9IHN0YXJ0Ow0KICAgICAgICB0aGlzLmVuZCA9IGVuZDsNCiAgICAgICAgdGhpcy50aW1lem9uZSA9IHRpbWV6b25lOw0KICAgICAgICB0aGlzLnVuem9uZWRSYW5nZSA9IG5ldyBVbnpvbmVkUmFuZ2VfMS5kZWZhdWx0KHN0YXJ0LmNsb25lKCkuc3RyaXBab25lKCksIGVuZC5jbG9uZSgpLnN0cmlwWm9uZSgpKTsNCiAgICAgICAgdGhpcy5yZXF1ZXN0c0J5VWlkID0ge307DQogICAgICAgIHRoaXMuZXZlbnREZWZzQnlVaWQgPSB7fTsNCiAgICAgICAgdGhpcy5ldmVudERlZnNCeUlkID0ge307DQogICAgICAgIHRoaXMuZXZlbnRJbnN0YW5jZUdyb3Vwc0J5SWQgPSB7fTsNCiAgICB9DQogICAgRXZlbnRQZXJpb2QucHJvdG90eXBlLmlzV2l0aGluUmFuZ2UgPSBmdW5jdGlvbiAoc3RhcnQsIGVuZCkgew0KICAgICAgICAvLyBUT0RPOiB1c2UgYSByYW5nZSB1dGlsIGZ1bmN0aW9uPw0KICAgICAgICByZXR1cm4gIXN0YXJ0LmlzQmVmb3JlKHRoaXMuc3RhcnQpICYmICFlbmQuaXNBZnRlcih0aGlzLmVuZCk7DQogICAgfTsNCiAgICAvLyBSZXF1ZXN0aW5nIGFuZCBQdXJnaW5nDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICBFdmVudFBlcmlvZC5wcm90b3R5cGUucmVxdWVzdFNvdXJjZXMgPSBmdW5jdGlvbiAoc291cmNlcykgew0KICAgICAgICB0aGlzLmZyZWV6ZSgpOw0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNvdXJjZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIHRoaXMucmVxdWVzdFNvdXJjZShzb3VyY2VzW2ldKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLnRoYXcoKTsNCiAgICB9Ow0KICAgIEV2ZW50UGVyaW9kLnByb3RvdHlwZS5yZXF1ZXN0U291cmNlID0gZnVuY3Rpb24gKHNvdXJjZSkgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICB2YXIgcmVxdWVzdCA9IHsgc291cmNlOiBzb3VyY2UsIHN0YXR1czogJ3BlbmRpbmcnLCBldmVudERlZnM6IG51bGwgfTsNCiAgICAgICAgdGhpcy5yZXF1ZXN0c0J5VWlkW3NvdXJjZS51aWRdID0gcmVxdWVzdDsNCiAgICAgICAgdGhpcy5wZW5kaW5nQ250ICs9IDE7DQogICAgICAgIHNvdXJjZS5mZXRjaCh0aGlzLnN0YXJ0LCB0aGlzLmVuZCwgdGhpcy50aW1lem9uZSkudGhlbihmdW5jdGlvbiAoZXZlbnREZWZzKSB7DQogICAgICAgICAgICBpZiAocmVxdWVzdC5zdGF0dXMgIT09ICdjYW5jZWxsZWQnKSB7DQogICAgICAgICAgICAgICAgcmVxdWVzdC5zdGF0dXMgPSAnY29tcGxldGVkJzsNCiAgICAgICAgICAgICAgICByZXF1ZXN0LmV2ZW50RGVmcyA9IGV2ZW50RGVmczsNCiAgICAgICAgICAgICAgICBfdGhpcy5hZGRFdmVudERlZnMoZXZlbnREZWZzKTsNCiAgICAgICAgICAgICAgICBfdGhpcy5wZW5kaW5nQ250LS07DQogICAgICAgICAgICAgICAgX3RoaXMudHJ5UmVsZWFzZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9LCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICBpZiAocmVxdWVzdC5zdGF0dXMgIT09ICdjYW5jZWxsZWQnKSB7DQogICAgICAgICAgICAgICAgcmVxdWVzdC5zdGF0dXMgPSAnZmFpbGVkJzsNCiAgICAgICAgICAgICAgICBfdGhpcy5wZW5kaW5nQ250LS07DQogICAgICAgICAgICAgICAgX3RoaXMudHJ5UmVsZWFzZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIEV2ZW50UGVyaW9kLnByb3RvdHlwZS5wdXJnZVNvdXJjZSA9IGZ1bmN0aW9uIChzb3VyY2UpIHsNCiAgICAgICAgdmFyIHJlcXVlc3QgPSB0aGlzLnJlcXVlc3RzQnlVaWRbc291cmNlLnVpZF07DQogICAgICAgIGlmIChyZXF1ZXN0KSB7DQogICAgICAgICAgICBkZWxldGUgdGhpcy5yZXF1ZXN0c0J5VWlkW3NvdXJjZS51aWRdOw0KICAgICAgICAgICAgaWYgKHJlcXVlc3Quc3RhdHVzID09PSAncGVuZGluZycpIHsNCiAgICAgICAgICAgICAgICByZXF1ZXN0LnN0YXR1cyA9ICdjYW5jZWxsZWQnOw0KICAgICAgICAgICAgICAgIHRoaXMucGVuZGluZ0NudC0tOw0KICAgICAgICAgICAgICAgIHRoaXMudHJ5UmVsZWFzZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAocmVxdWVzdC5zdGF0dXMgPT09ICdjb21wbGV0ZWQnKSB7DQogICAgICAgICAgICAgICAgcmVxdWVzdC5ldmVudERlZnMuZm9yRWFjaCh0aGlzLnJlbW92ZUV2ZW50RGVmLmJpbmQodGhpcykpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfTsNCiAgICBFdmVudFBlcmlvZC5wcm90b3R5cGUucHVyZ2VBbGxTb3VyY2VzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgcmVxdWVzdHNCeVVpZCA9IHRoaXMucmVxdWVzdHNCeVVpZDsNCiAgICAgICAgdmFyIHVpZDsNCiAgICAgICAgdmFyIHJlcXVlc3Q7DQogICAgICAgIHZhciBjb21wbGV0ZWRDbnQgPSAwOw0KICAgICAgICBmb3IgKHVpZCBpbiByZXF1ZXN0c0J5VWlkKSB7DQogICAgICAgICAgICByZXF1ZXN0ID0gcmVxdWVzdHNCeVVpZFt1aWRdOw0KICAgICAgICAgICAgaWYgKHJlcXVlc3Quc3RhdHVzID09PSAncGVuZGluZycpIHsNCiAgICAgICAgICAgICAgICByZXF1ZXN0LnN0YXR1cyA9ICdjYW5jZWxsZWQnOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAocmVxdWVzdC5zdGF0dXMgPT09ICdjb21wbGV0ZWQnKSB7DQogICAgICAgICAgICAgICAgY29tcGxldGVkQ250Kys7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5yZXF1ZXN0c0J5VWlkID0ge307DQogICAgICAgIHRoaXMucGVuZGluZ0NudCA9IDA7DQogICAgICAgIGlmIChjb21wbGV0ZWRDbnQpIHsNCiAgICAgICAgICAgIHRoaXMucmVtb3ZlQWxsRXZlbnREZWZzKCk7IC8vIG1pZ2h0IHJlbGVhc2UNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gRXZlbnQgRGVmaW5pdGlvbnMNCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgIEV2ZW50UGVyaW9kLnByb3RvdHlwZS5nZXRFdmVudERlZkJ5VWlkID0gZnVuY3Rpb24gKGV2ZW50RGVmVWlkKSB7DQogICAgICAgIHJldHVybiB0aGlzLmV2ZW50RGVmc0J5VWlkW2V2ZW50RGVmVWlkXTsNCiAgICB9Ow0KICAgIEV2ZW50UGVyaW9kLnByb3RvdHlwZS5nZXRFdmVudERlZnNCeUlkID0gZnVuY3Rpb24gKGV2ZW50RGVmSWQpIHsNCiAgICAgICAgdmFyIGEgPSB0aGlzLmV2ZW50RGVmc0J5SWRbZXZlbnREZWZJZF07DQogICAgICAgIGlmIChhKSB7DQogICAgICAgICAgICByZXR1cm4gYS5zbGljZSgpOyAvLyBjbG9uZQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiBbXTsNCiAgICB9Ow0KICAgIEV2ZW50UGVyaW9kLnByb3RvdHlwZS5hZGRFdmVudERlZnMgPSBmdW5jdGlvbiAoZXZlbnREZWZzKSB7DQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnREZWZzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICB0aGlzLmFkZEV2ZW50RGVmKGV2ZW50RGVmc1tpXSk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIEV2ZW50UGVyaW9kLnByb3RvdHlwZS5hZGRFdmVudERlZiA9IGZ1bmN0aW9uIChldmVudERlZikgew0KICAgICAgICB2YXIgZXZlbnREZWZzQnlJZCA9IHRoaXMuZXZlbnREZWZzQnlJZDsNCiAgICAgICAgdmFyIGV2ZW50RGVmSWQgPSBldmVudERlZi5pZDsNCiAgICAgICAgdmFyIGV2ZW50RGVmcyA9IGV2ZW50RGVmc0J5SWRbZXZlbnREZWZJZF0gfHwgKGV2ZW50RGVmc0J5SWRbZXZlbnREZWZJZF0gPSBbXSk7DQogICAgICAgIHZhciBldmVudEluc3RhbmNlcyA9IGV2ZW50RGVmLmJ1aWxkSW5zdGFuY2VzKHRoaXMudW56b25lZFJhbmdlKTsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIGV2ZW50RGVmcy5wdXNoKGV2ZW50RGVmKTsNCiAgICAgICAgdGhpcy5ldmVudERlZnNCeVVpZFtldmVudERlZi51aWRdID0gZXZlbnREZWY7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBldmVudEluc3RhbmNlcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgdGhpcy5hZGRFdmVudEluc3RhbmNlKGV2ZW50SW5zdGFuY2VzW2ldLCBldmVudERlZklkKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgRXZlbnRQZXJpb2QucHJvdG90eXBlLnJlbW92ZUV2ZW50RGVmc0J5SWQgPSBmdW5jdGlvbiAoZXZlbnREZWZJZCkgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICB0aGlzLmdldEV2ZW50RGVmc0J5SWQoZXZlbnREZWZJZCkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnREZWYpIHsNCiAgICAgICAgICAgIF90aGlzLnJlbW92ZUV2ZW50RGVmKGV2ZW50RGVmKTsNCiAgICAgICAgfSk7DQogICAgfTsNCiAgICBFdmVudFBlcmlvZC5wcm90b3R5cGUucmVtb3ZlQWxsRXZlbnREZWZzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgaXNFbXB0eSA9ICQuaXNFbXB0eU9iamVjdCh0aGlzLmV2ZW50RGVmc0J5VWlkKTsNCiAgICAgICAgdGhpcy5ldmVudERlZnNCeVVpZCA9IHt9Ow0KICAgICAgICB0aGlzLmV2ZW50RGVmc0J5SWQgPSB7fTsNCiAgICAgICAgdGhpcy5ldmVudEluc3RhbmNlR3JvdXBzQnlJZCA9IHt9Ow0KICAgICAgICBpZiAoIWlzRW1wdHkpIHsNCiAgICAgICAgICAgIHRoaXMudHJ5UmVsZWFzZSgpOw0KICAgICAgICB9DQogICAgfTsNCiAgICBFdmVudFBlcmlvZC5wcm90b3R5cGUucmVtb3ZlRXZlbnREZWYgPSBmdW5jdGlvbiAoZXZlbnREZWYpIHsNCiAgICAgICAgdmFyIGV2ZW50RGVmc0J5SWQgPSB0aGlzLmV2ZW50RGVmc0J5SWQ7DQogICAgICAgIHZhciBldmVudERlZnMgPSBldmVudERlZnNCeUlkW2V2ZW50RGVmLmlkXTsNCiAgICAgICAgZGVsZXRlIHRoaXMuZXZlbnREZWZzQnlVaWRbZXZlbnREZWYudWlkXTsNCiAgICAgICAgaWYgKGV2ZW50RGVmcykgew0KICAgICAgICAgICAgdXRpbF8xLnJlbW92ZUV4YWN0KGV2ZW50RGVmcywgZXZlbnREZWYpOw0KICAgICAgICAgICAgaWYgKCFldmVudERlZnMubGVuZ3RoKSB7DQogICAgICAgICAgICAgICAgZGVsZXRlIGV2ZW50RGVmc0J5SWRbZXZlbnREZWYuaWRdOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdGhpcy5yZW1vdmVFdmVudEluc3RhbmNlc0ZvckRlZihldmVudERlZik7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIEV2ZW50IEluc3RhbmNlcw0KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgRXZlbnRQZXJpb2QucHJvdG90eXBlLmdldEV2ZW50SW5zdGFuY2VzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgZXZlbnRJbnN0YW5jZUdyb3Vwc0J5SWQgPSB0aGlzLmV2ZW50SW5zdGFuY2VHcm91cHNCeUlkOw0KICAgICAgICB2YXIgZXZlbnRJbnN0YW5jZXMgPSBbXTsNCiAgICAgICAgdmFyIGlkOw0KICAgICAgICBmb3IgKGlkIGluIGV2ZW50SW5zdGFuY2VHcm91cHNCeUlkKSB7DQogICAgICAgICAgICBldmVudEluc3RhbmNlcy5wdXNoLmFwcGx5KGV2ZW50SW5zdGFuY2VzLCAvLyBhcHBlbmQNCiAgICAgICAgICAgIGV2ZW50SW5zdGFuY2VHcm91cHNCeUlkW2lkXS5ldmVudEluc3RhbmNlcyk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGV2ZW50SW5zdGFuY2VzOw0KICAgIH07DQogICAgRXZlbnRQZXJpb2QucHJvdG90eXBlLmdldEV2ZW50SW5zdGFuY2VzV2l0aElkID0gZnVuY3Rpb24gKGV2ZW50RGVmSWQpIHsNCiAgICAgICAgdmFyIGV2ZW50SW5zdGFuY2VHcm91cCA9IHRoaXMuZXZlbnRJbnN0YW5jZUdyb3Vwc0J5SWRbZXZlbnREZWZJZF07DQogICAgICAgIGlmIChldmVudEluc3RhbmNlR3JvdXApIHsNCiAgICAgICAgICAgIHJldHVybiBldmVudEluc3RhbmNlR3JvdXAuZXZlbnRJbnN0YW5jZXMuc2xpY2UoKTsgLy8gY2xvbmUNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gW107DQogICAgfTsNCiAgICBFdmVudFBlcmlvZC5wcm90b3R5cGUuZ2V0RXZlbnRJbnN0YW5jZXNXaXRob3V0SWQgPSBmdW5jdGlvbiAoZXZlbnREZWZJZCkgew0KICAgICAgICB2YXIgZXZlbnRJbnN0YW5jZUdyb3Vwc0J5SWQgPSB0aGlzLmV2ZW50SW5zdGFuY2VHcm91cHNCeUlkOw0KICAgICAgICB2YXIgbWF0Y2hpbmdJbnN0YW5jZXMgPSBbXTsNCiAgICAgICAgdmFyIGlkOw0KICAgICAgICBmb3IgKGlkIGluIGV2ZW50SW5zdGFuY2VHcm91cHNCeUlkKSB7DQogICAgICAgICAgICBpZiAoaWQgIT09IGV2ZW50RGVmSWQpIHsNCiAgICAgICAgICAgICAgICBtYXRjaGluZ0luc3RhbmNlcy5wdXNoLmFwcGx5KG1hdGNoaW5nSW5zdGFuY2VzLCAvLyBhcHBlbmQNCiAgICAgICAgICAgICAgICBldmVudEluc3RhbmNlR3JvdXBzQnlJZFtpZF0uZXZlbnRJbnN0YW5jZXMpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiBtYXRjaGluZ0luc3RhbmNlczsNCiAgICB9Ow0KICAgIEV2ZW50UGVyaW9kLnByb3RvdHlwZS5hZGRFdmVudEluc3RhbmNlID0gZnVuY3Rpb24gKGV2ZW50SW5zdGFuY2UsIGV2ZW50RGVmSWQpIHsNCiAgICAgICAgdmFyIGV2ZW50SW5zdGFuY2VHcm91cHNCeUlkID0gdGhpcy5ldmVudEluc3RhbmNlR3JvdXBzQnlJZDsNCiAgICAgICAgdmFyIGV2ZW50SW5zdGFuY2VHcm91cCA9IGV2ZW50SW5zdGFuY2VHcm91cHNCeUlkW2V2ZW50RGVmSWRdIHx8DQogICAgICAgICAgICAoZXZlbnRJbnN0YW5jZUdyb3Vwc0J5SWRbZXZlbnREZWZJZF0gPSBuZXcgRXZlbnRJbnN0YW5jZUdyb3VwXzEuZGVmYXVsdCgpKTsNCiAgICAgICAgZXZlbnRJbnN0YW5jZUdyb3VwLmV2ZW50SW5zdGFuY2VzLnB1c2goZXZlbnRJbnN0YW5jZSk7DQogICAgICAgIHRoaXMudHJ5UmVsZWFzZSgpOw0KICAgIH07DQogICAgRXZlbnRQZXJpb2QucHJvdG90eXBlLnJlbW92ZUV2ZW50SW5zdGFuY2VzRm9yRGVmID0gZnVuY3Rpb24gKGV2ZW50RGVmKSB7DQogICAgICAgIHZhciBldmVudEluc3RhbmNlR3JvdXBzQnlJZCA9IHRoaXMuZXZlbnRJbnN0YW5jZUdyb3Vwc0J5SWQ7DQogICAgICAgIHZhciBldmVudEluc3RhbmNlR3JvdXAgPSBldmVudEluc3RhbmNlR3JvdXBzQnlJZFtldmVudERlZi5pZF07DQogICAgICAgIHZhciByZW1vdmVDbnQ7DQogICAgICAgIGlmIChldmVudEluc3RhbmNlR3JvdXApIHsNCiAgICAgICAgICAgIHJlbW92ZUNudCA9IHV0aWxfMS5yZW1vdmVNYXRjaGluZyhldmVudEluc3RhbmNlR3JvdXAuZXZlbnRJbnN0YW5jZXMsIGZ1bmN0aW9uIChjdXJyZW50RXZlbnRJbnN0YW5jZSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRJbnN0YW5jZS5kZWYgPT09IGV2ZW50RGVmOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICBpZiAoIWV2ZW50SW5zdGFuY2VHcm91cC5ldmVudEluc3RhbmNlcy5sZW5ndGgpIHsNCiAgICAgICAgICAgICAgICBkZWxldGUgZXZlbnRJbnN0YW5jZUdyb3Vwc0J5SWRbZXZlbnREZWYuaWRdOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKHJlbW92ZUNudCkgew0KICAgICAgICAgICAgICAgIHRoaXMudHJ5UmVsZWFzZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBSZWxlYXNpbmcgYW5kIEZyZWV6aW5nDQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICBFdmVudFBlcmlvZC5wcm90b3R5cGUudHJ5UmVsZWFzZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKCF0aGlzLnBlbmRpbmdDbnQpIHsNCiAgICAgICAgICAgIGlmICghdGhpcy5mcmVlemVEZXB0aCkgew0KICAgICAgICAgICAgICAgIHRoaXMucmVsZWFzZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgdGhpcy5zdHVudGVkUmVsZWFzZUNudCsrOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfTsNCiAgICBFdmVudFBlcmlvZC5wcm90b3R5cGUucmVsZWFzZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5yZWxlYXNlQ250Kys7DQogICAgICAgIHRoaXMudHJpZ2dlcigncmVsZWFzZScsIHRoaXMuZXZlbnRJbnN0YW5jZUdyb3Vwc0J5SWQpOw0KICAgIH07DQogICAgRXZlbnRQZXJpb2QucHJvdG90eXBlLndoZW5SZWxlYXNlZCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgaWYgKHRoaXMucmVsZWFzZUNudCkgew0KICAgICAgICAgICAgcmV0dXJuIFByb21pc2VfMS5kZWZhdWx0LnJlc29sdmUodGhpcy5ldmVudEluc3RhbmNlR3JvdXBzQnlJZCk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICByZXR1cm4gUHJvbWlzZV8xLmRlZmF1bHQuY29uc3RydWN0KGZ1bmN0aW9uIChvblJlc29sdmUpIHsNCiAgICAgICAgICAgICAgICBfdGhpcy5vbmUoJ3JlbGVhc2UnLCBvblJlc29sdmUpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIEV2ZW50UGVyaW9kLnByb3RvdHlwZS5mcmVlemUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICghKHRoaXMuZnJlZXplRGVwdGgrKykpIHsNCiAgICAgICAgICAgIHRoaXMuc3R1bnRlZFJlbGVhc2VDbnQgPSAwOw0KICAgICAgICB9DQogICAgfTsNCiAgICBFdmVudFBlcmlvZC5wcm90b3R5cGUudGhhdyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKCEoLS10aGlzLmZyZWV6ZURlcHRoKSAmJiB0aGlzLnN0dW50ZWRSZWxlYXNlQ250ICYmICF0aGlzLnBlbmRpbmdDbnQpIHsNCiAgICAgICAgICAgIHRoaXMucmVsZWFzZSgpOw0KICAgICAgICB9DQogICAgfTsNCiAgICByZXR1cm4gRXZlbnRQZXJpb2Q7DQp9KCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gRXZlbnRQZXJpb2Q7DQpFbWl0dGVyTWl4aW5fMS5kZWZhdWx0Lm1peEludG8oRXZlbnRQZXJpb2QpOw0KCgovKioqLyB9KSwKLyogMjQ0ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgdXRpbF8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCnZhciBMaXN0ZW5lck1peGluXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDcpOw0KLyogQ3JlYXRlcyBhIGNsb25lIG9mIGFuIGVsZW1lbnQgYW5kIGxldHMgaXQgdHJhY2sgdGhlIG1vdXNlIGFzIGl0IG1vdmVzDQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCnZhciBNb3VzZUZvbGxvd2VyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgew0KICAgIGZ1bmN0aW9uIE1vdXNlRm9sbG93ZXIoc291cmNlRWwsIG9wdGlvbnMpIHsNCiAgICAgICAgdGhpcy5pc0ZvbGxvd2luZyA9IGZhbHNlOw0KICAgICAgICB0aGlzLmlzSGlkZGVuID0gZmFsc2U7DQogICAgICAgIHRoaXMuaXNBbmltYXRpbmcgPSBmYWxzZTsgLy8gZG9pbmcgdGhlIHJldmVydCBhbmltYXRpb24/DQogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9Ow0KICAgICAgICB0aGlzLnNvdXJjZUVsID0gc291cmNlRWw7DQogICAgICAgIHRoaXMucGFyZW50RWwgPSBvcHRpb25zLnBhcmVudEVsID8gJChvcHRpb25zLnBhcmVudEVsKSA6IHNvdXJjZUVsLnBhcmVudCgpOyAvLyBkZWZhdWx0IHRvIHNvdXJjZUVsJ3MgcGFyZW50DQogICAgfQ0KICAgIC8vIENhdXNlcyB0aGUgZWxlbWVudCB0byBzdGFydCBmb2xsb3dpbmcgdGhlIG1vdXNlDQogICAgTW91c2VGb2xsb3dlci5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgaWYgKCF0aGlzLmlzRm9sbG93aW5nKSB7DQogICAgICAgICAgICB0aGlzLmlzRm9sbG93aW5nID0gdHJ1ZTsNCiAgICAgICAgICAgIHRoaXMueTAgPSB1dGlsXzEuZ2V0RXZZKGV2KTsNCiAgICAgICAgICAgIHRoaXMueDAgPSB1dGlsXzEuZ2V0RXZYKGV2KTsNCiAgICAgICAgICAgIHRoaXMudG9wRGVsdGEgPSAwOw0KICAgICAgICAgICAgdGhpcy5sZWZ0RGVsdGEgPSAwOw0KICAgICAgICAgICAgaWYgKCF0aGlzLmlzSGlkZGVuKSB7DQogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVQb3NpdGlvbigpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKHV0aWxfMS5nZXRFdklzVG91Y2goZXYpKSB7DQogICAgICAgICAgICAgICAgdGhpcy5saXN0ZW5UbygkKGRvY3VtZW50KSwgJ3RvdWNobW92ZScsIHRoaXMuaGFuZGxlTW92ZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICB0aGlzLmxpc3RlblRvKCQoZG9jdW1lbnQpLCAnbW91c2Vtb3ZlJywgdGhpcy5oYW5kbGVNb3ZlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gQ2F1c2VzIHRoZSBlbGVtZW50IHRvIHN0b3AgZm9sbG93aW5nIHRoZSBtb3VzZS4gSWYgc2hvdWxkUmV2ZXJ0IGlzIHRydWUsIHdpbGwgYW5pbWF0ZSBiYWNrIHRvIG9yaWdpbmFsIHBvc2l0aW9uLg0KICAgIC8vIGBjYWxsYmFja2AgZ2V0cyBpbnZva2VkIHdoZW4gdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZS4gSWYgbm8gYW5pbWF0aW9uLCBpdCBpcyBpbnZva2VkIGltbWVkaWF0ZWx5Lg0KICAgIE1vdXNlRm9sbG93ZXIucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbiAoc2hvdWxkUmV2ZXJ0LCBjYWxsYmFjaykgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICB2YXIgcmV2ZXJ0RHVyYXRpb24gPSB0aGlzLm9wdGlvbnMucmV2ZXJ0RHVyYXRpb247DQogICAgICAgIHZhciBjb21wbGV0ZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIF90aGlzLmlzQW5pbWF0aW5nID0gZmFsc2U7DQogICAgICAgICAgICBfdGhpcy5yZW1vdmVFbGVtZW50KCk7DQogICAgICAgICAgICBfdGhpcy50b3AwID0gX3RoaXMubGVmdDAgPSBudWxsOyAvLyByZXNldCBzdGF0ZSBmb3IgZnV0dXJlIHVwZGF0ZVBvc2l0aW9uIGNhbGxzDQogICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsNCiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICBpZiAodGhpcy5pc0ZvbGxvd2luZyAmJiAhdGhpcy5pc0FuaW1hdGluZykgew0KICAgICAgICAgICAgdGhpcy5pc0ZvbGxvd2luZyA9IGZhbHNlOw0KICAgICAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nVG8oJChkb2N1bWVudCkpOw0KICAgICAgICAgICAgaWYgKHNob3VsZFJldmVydCAmJiByZXZlcnREdXJhdGlvbiAmJiAhdGhpcy5pc0hpZGRlbikgew0KICAgICAgICAgICAgICAgIHRoaXMuaXNBbmltYXRpbmcgPSB0cnVlOw0KICAgICAgICAgICAgICAgIHRoaXMuZWwuYW5pbWF0ZSh7DQogICAgICAgICAgICAgICAgICAgIHRvcDogdGhpcy50b3AwLA0KICAgICAgICAgICAgICAgICAgICBsZWZ0OiB0aGlzLmxlZnQwDQogICAgICAgICAgICAgICAgfSwgew0KICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogcmV2ZXJ0RHVyYXRpb24sDQogICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlOiBjb21wbGV0ZQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgY29tcGxldGUoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gR2V0cyB0aGUgdHJhY2tpbmcgZWxlbWVudC4gQ3JlYXRlIGl0IGlmIG5lY2Vzc2FyeQ0KICAgIE1vdXNlRm9sbG93ZXIucHJvdG90eXBlLmdldEVsID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgZWwgPSB0aGlzLmVsOw0KICAgICAgICBpZiAoIWVsKSB7DQogICAgICAgICAgICBlbCA9IHRoaXMuZWwgPSB0aGlzLnNvdXJjZUVsLmNsb25lKCkNCiAgICAgICAgICAgICAgICAuYWRkQ2xhc3ModGhpcy5vcHRpb25zLmFkZGl0aW9uYWxDbGFzcyB8fCAnJykNCiAgICAgICAgICAgICAgICAuY3NzKHsNCiAgICAgICAgICAgICAgICBwb3NpdGlvbjogJ2Fic29sdXRlJywNCiAgICAgICAgICAgICAgICB2aXNpYmlsaXR5OiAnJywNCiAgICAgICAgICAgICAgICBkaXNwbGF5OiB0aGlzLmlzSGlkZGVuID8gJ25vbmUnIDogJycsDQogICAgICAgICAgICAgICAgbWFyZ2luOiAwLA0KICAgICAgICAgICAgICAgIHJpZ2h0OiAnYXV0bycsDQogICAgICAgICAgICAgICAgYm90dG9tOiAnYXV0bycsDQogICAgICAgICAgICAgICAgd2lkdGg6IHRoaXMuc291cmNlRWwud2lkdGgoKSwNCiAgICAgICAgICAgICAgICBoZWlnaHQ6IHRoaXMuc291cmNlRWwuaGVpZ2h0KCksDQogICAgICAgICAgICAgICAgb3BhY2l0eTogdGhpcy5vcHRpb25zLm9wYWNpdHkgfHwgJycsDQogICAgICAgICAgICAgICAgekluZGV4OiB0aGlzLm9wdGlvbnMuekluZGV4DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIC8vIHdlIGRvbid0IHdhbnQgbG9uZyB0YXBzIG9yIGFueSBtb3VzZSBpbnRlcmFjdGlvbiBjYXVzaW5nIHNlbGVjdGlvbi9tZW51cy4NCiAgICAgICAgICAgIC8vIHdvdWxkIHVzZSBwcmV2ZW50U2VsZWN0aW9uKCksIGJ1dCB0aGF0IHByZXZlbnRzIHNlbGVjdHN0YXJ0LCBjYXVzaW5nIHByb2JsZW1zLg0KICAgICAgICAgICAgZWwuYWRkQ2xhc3MoJ2ZjLXVuc2VsZWN0YWJsZScpOw0KICAgICAgICAgICAgZWwuYXBwZW5kVG8odGhpcy5wYXJlbnRFbCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGVsOw0KICAgIH07DQogICAgLy8gUmVtb3ZlcyB0aGUgdHJhY2tpbmcgZWxlbWVudCBpZiBpdCBoYXMgYWxyZWFkeSBiZWVuIGNyZWF0ZWQNCiAgICBNb3VzZUZvbGxvd2VyLnByb3RvdHlwZS5yZW1vdmVFbGVtZW50ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICBpZiAodGhpcy5lbCkgew0KICAgICAgICAgICAgdGhpcy5lbC5yZW1vdmUoKTsNCiAgICAgICAgICAgIHRoaXMuZWwgPSBudWxsOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBVcGRhdGUgdGhlIENTUyBwb3NpdGlvbiBvZiB0aGUgdHJhY2tpbmcgZWxlbWVudA0KICAgIE1vdXNlRm9sbG93ZXIucHJvdG90eXBlLnVwZGF0ZVBvc2l0aW9uID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgc291cmNlT2Zmc2V0Ow0KICAgICAgICB2YXIgb3JpZ2luOw0KICAgICAgICB0aGlzLmdldEVsKCk7IC8vIGVuc3VyZSB0aGlzLmVsDQogICAgICAgIC8vIG1ha2Ugc3VyZSBvcmlnaW4gaW5mbyB3YXMgY29tcHV0ZWQNCiAgICAgICAgaWYgKHRoaXMudG9wMCA9PSBudWxsKSB7DQogICAgICAgICAgICBzb3VyY2VPZmZzZXQgPSB0aGlzLnNvdXJjZUVsLm9mZnNldCgpOw0KICAgICAgICAgICAgb3JpZ2luID0gdGhpcy5lbC5vZmZzZXRQYXJlbnQoKS5vZmZzZXQoKTsNCiAgICAgICAgICAgIHRoaXMudG9wMCA9IHNvdXJjZU9mZnNldC50b3AgLSBvcmlnaW4udG9wOw0KICAgICAgICAgICAgdGhpcy5sZWZ0MCA9IHNvdXJjZU9mZnNldC5sZWZ0IC0gb3JpZ2luLmxlZnQ7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5lbC5jc3Moew0KICAgICAgICAgICAgdG9wOiB0aGlzLnRvcDAgKyB0aGlzLnRvcERlbHRhLA0KICAgICAgICAgICAgbGVmdDogdGhpcy5sZWZ0MCArIHRoaXMubGVmdERlbHRhDQogICAgICAgIH0pOw0KICAgIH07DQogICAgLy8gR2V0cyBjYWxsZWQgd2hlbiB0aGUgdXNlciBtb3ZlcyB0aGUgbW91c2UNCiAgICBNb3VzZUZvbGxvd2VyLnByb3RvdHlwZS5oYW5kbGVNb3ZlID0gZnVuY3Rpb24gKGV2KSB7DQogICAgICAgIHRoaXMudG9wRGVsdGEgPSB1dGlsXzEuZ2V0RXZZKGV2KSAtIHRoaXMueTA7DQogICAgICAgIHRoaXMubGVmdERlbHRhID0gdXRpbF8xLmdldEV2WChldikgLSB0aGlzLngwOw0KICAgICAgICBpZiAoIXRoaXMuaXNIaWRkZW4pIHsNCiAgICAgICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24oKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgLy8gVGVtcG9yYXJpbHkgbWFrZXMgdGhlIHRyYWNraW5nIGVsZW1lbnQgaW52aXNpYmxlLiBDYW4gYmUgY2FsbGVkIGJlZm9yZSBmb2xsb3dpbmcgc3RhcnRzDQogICAgTW91c2VGb2xsb3dlci5wcm90b3R5cGUuaGlkZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKCF0aGlzLmlzSGlkZGVuKSB7DQogICAgICAgICAgICB0aGlzLmlzSGlkZGVuID0gdHJ1ZTsNCiAgICAgICAgICAgIGlmICh0aGlzLmVsKSB7DQogICAgICAgICAgICAgICAgdGhpcy5lbC5oaWRlKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIFNob3cgdGhlIHRyYWNraW5nIGVsZW1lbnQgYWZ0ZXIgaXQgaGFzIGJlZW4gdGVtcG9yYXJpbHkgaGlkZGVuDQogICAgTW91c2VGb2xsb3dlci5wcm90b3R5cGUuc2hvdyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMuaXNIaWRkZW4pIHsNCiAgICAgICAgICAgIHRoaXMuaXNIaWRkZW4gPSBmYWxzZTsNCiAgICAgICAgICAgIHRoaXMudXBkYXRlUG9zaXRpb24oKTsNCiAgICAgICAgICAgIHRoaXMuZ2V0RWwoKS5zaG93KCk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIHJldHVybiBNb3VzZUZvbGxvd2VyOw0KfSgpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IE1vdXNlRm9sbG93ZXI7DQpMaXN0ZW5lck1peGluXzEuZGVmYXVsdC5taXhJbnRvKE1vdXNlRm9sbG93ZXIpOw0KCgovKioqLyB9KSwKLyogMjQ1ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdHNsaWJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7DQp2YXIgSGl0RHJhZ0xpc3RlbmVyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIyKTsNCnZhciBJbnRlcmFjdGlvbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygxNik7DQp2YXIgRGF0ZUNsaWNraW5nID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKERhdGVDbGlja2luZywgX3N1cGVyKTsNCiAgICAvKg0KICAgIGNvbXBvbmVudCBtdXN0IGltcGxlbWVudDoNCiAgICAgIC0gYmluZERhdGVIYW5kbGVyVG9FbA0KICAgICAgLSBnZXRTYWZlSGl0Rm9vdHByaW50DQogICAgICAtIGdldEhpdEVsDQogICAgKi8NCiAgICBmdW5jdGlvbiBEYXRlQ2xpY2tpbmcoY29tcG9uZW50KSB7DQogICAgICAgIHZhciBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMsIGNvbXBvbmVudCkgfHwgdGhpczsNCiAgICAgICAgX3RoaXMuZHJhZ0xpc3RlbmVyID0gX3RoaXMuYnVpbGREcmFnTGlzdGVuZXIoKTsNCiAgICAgICAgcmV0dXJuIF90aGlzOw0KICAgIH0NCiAgICBEYXRlQ2xpY2tpbmcucHJvdG90eXBlLmVuZCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5kcmFnTGlzdGVuZXIuZW5kSW50ZXJhY3Rpb24oKTsNCiAgICB9Ow0KICAgIERhdGVDbGlja2luZy5wcm90b3R5cGUuYmluZFRvRWwgPSBmdW5jdGlvbiAoZWwpIHsNCiAgICAgICAgdmFyIGNvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50Ow0KICAgICAgICB2YXIgZHJhZ0xpc3RlbmVyID0gdGhpcy5kcmFnTGlzdGVuZXI7DQogICAgICAgIGNvbXBvbmVudC5iaW5kRGF0ZUhhbmRsZXJUb0VsKGVsLCAnbW91c2Vkb3duJywgZnVuY3Rpb24gKGV2KSB7DQogICAgICAgICAgICBpZiAoIWNvbXBvbmVudC5zaG91bGRJZ25vcmVNb3VzZSgpKSB7DQogICAgICAgICAgICAgICAgZHJhZ0xpc3RlbmVyLnN0YXJ0SW50ZXJhY3Rpb24oZXYpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgY29tcG9uZW50LmJpbmREYXRlSGFuZGxlclRvRWwoZWwsICd0b3VjaHN0YXJ0JywgZnVuY3Rpb24gKGV2KSB7DQogICAgICAgICAgICBpZiAoIWNvbXBvbmVudC5zaG91bGRJZ25vcmVUb3VjaCgpKSB7DQogICAgICAgICAgICAgICAgZHJhZ0xpc3RlbmVyLnN0YXJ0SW50ZXJhY3Rpb24oZXYpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIC8vIENyZWF0ZXMgYSBsaXN0ZW5lciB0aGF0IHRyYWNrcyB0aGUgdXNlcidzIGRyYWcgYWNyb3NzIGRheSBlbGVtZW50cywgZm9yIGRheSBjbGlja2luZy4NCiAgICBEYXRlQ2xpY2tpbmcucHJvdG90eXBlLmJ1aWxkRHJhZ0xpc3RlbmVyID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICB2YXIgY29tcG9uZW50ID0gdGhpcy5jb21wb25lbnQ7DQogICAgICAgIHZhciBkYXlDbGlja0hpdDsgLy8gbnVsbCBpZiBpbnZhbGlkIGRheUNsaWNrDQogICAgICAgIHZhciBkcmFnTGlzdGVuZXIgPSBuZXcgSGl0RHJhZ0xpc3RlbmVyXzEuZGVmYXVsdChjb21wb25lbnQsIHsNCiAgICAgICAgICAgIHNjcm9sbDogdGhpcy5vcHQoJ2RyYWdTY3JvbGwnKSwNCiAgICAgICAgICAgIGludGVyYWN0aW9uU3RhcnQ6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICBkYXlDbGlja0hpdCA9IGRyYWdMaXN0ZW5lci5vcmlnSGl0Ow0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGhpdE92ZXI6IGZ1bmN0aW9uIChoaXQsIGlzT3JpZywgb3JpZ0hpdCkgew0KICAgICAgICAgICAgICAgIC8vIGlmIHVzZXIgZHJhZ2dlZCB0byBhbm90aGVyIGNlbGwgYXQgYW55IHBvaW50LCBpdCBjYW4gbm8gbG9uZ2VyIGJlIGEgZGF5Q2xpY2sNCiAgICAgICAgICAgICAgICBpZiAoIWlzT3JpZykgew0KICAgICAgICAgICAgICAgICAgICBkYXlDbGlja0hpdCA9IG51bGw7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGhpdE91dDogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIGRheUNsaWNrSGl0ID0gbnVsbDsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBpbnRlcmFjdGlvbkVuZDogZnVuY3Rpb24gKGV2LCBpc0NhbmNlbGxlZCkgew0KICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnRGb290cHJpbnQ7DQogICAgICAgICAgICAgICAgaWYgKCFpc0NhbmNlbGxlZCAmJiBkYXlDbGlja0hpdCkgew0KICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRGb290cHJpbnQgPSBjb21wb25lbnQuZ2V0U2FmZUhpdEZvb3RwcmludChkYXlDbGlja0hpdCk7DQogICAgICAgICAgICAgICAgICAgIGlmIChjb21wb25lbnRGb290cHJpbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnZpZXcudHJpZ2dlckRheUNsaWNrKGNvbXBvbmVudEZvb3RwcmludCwgY29tcG9uZW50LmdldEhpdEVsKGRheUNsaWNrSGl0KSwgZXYpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgICAgLy8gYmVjYXVzZSBkcmFnTGlzdGVuZXIgd29uJ3QgYmUgY2FsbGVkIHdpdGggYW55IHRpbWUgZGVsYXksICJkcmFnZ2luZyIgd2lsbCBiZWdpbiBpbW1lZGlhdGVseSwNCiAgICAgICAgLy8gd2hpY2ggd2lsbCBraWxsIGFueSB0b3VjaG1vdmluZy9zY3JvbGxpbmcuIFByZXZlbnQgdGhpcy4NCiAgICAgICAgZHJhZ0xpc3RlbmVyLnNob3VsZENhbmNlbFRvdWNoU2Nyb2xsID0gZmFsc2U7DQogICAgICAgIGRyYWdMaXN0ZW5lci5zY3JvbGxBbHdheXNLaWxscyA9IHRydWU7DQogICAgICAgIHJldHVybiBkcmFnTGlzdGVuZXI7DQogICAgfTsNCiAgICByZXR1cm4gRGF0ZUNsaWNraW5nOw0KfShJbnRlcmFjdGlvbl8xLmRlZmF1bHQpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IERhdGVDbGlja2luZzsNCgoKLyoqKi8gfSksCi8qIDI0NiAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIHRzbGliXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIpOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgRXZlbnRSZW5kZXJlcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0Mik7DQovKg0KT25seSBoYW5kbGVzIGZvcmVncm91bmQgc2Vncy4NCkRvZXMgbm90IG93biByZW5kZXJpbmcuIFVzZSBmb3IgbG93LWxldmVsIHV0aWwgbWV0aG9kcyBieSBUaW1lR3JpZC4NCiovDQp2YXIgVGltZUdyaWRFdmVudFJlbmRlcmVyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKFRpbWVHcmlkRXZlbnRSZW5kZXJlciwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBUaW1lR3JpZEV2ZW50UmVuZGVyZXIodGltZUdyaWQsIGZpbGxSZW5kZXJlcikgew0KICAgICAgICB2YXIgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzLCB0aW1lR3JpZCwgZmlsbFJlbmRlcmVyKSB8fCB0aGlzOw0KICAgICAgICBfdGhpcy50aW1lR3JpZCA9IHRpbWVHcmlkOw0KICAgICAgICByZXR1cm4gX3RoaXM7DQogICAgfQ0KICAgIFRpbWVHcmlkRXZlbnRSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyRmdTZWdzID0gZnVuY3Rpb24gKHNlZ3MpIHsNCiAgICAgICAgdGhpcy5yZW5kZXJGZ1NlZ3NJbnRvQ29udGFpbmVycyhzZWdzLCB0aGlzLnRpbWVHcmlkLmZnQ29udGFpbmVyRWxzKTsNCiAgICB9Ow0KICAgIC8vIEdpdmVuIGFuIGFycmF5IG9mIGZvcmVncm91bmQgc2VnbWVudHMsIHJlbmRlciBhIERPTSBlbGVtZW50IGZvciBlYWNoLCBjb21wdXRlcyBwb3NpdGlvbiwNCiAgICAvLyBhbmQgYXR0YWNoZXMgdG8gdGhlIGNvbHVtbiBpbm5lci1jb250YWluZXIgZWxlbWVudHMuDQogICAgVGltZUdyaWRFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJGZ1NlZ3NJbnRvQ29udGFpbmVycyA9IGZ1bmN0aW9uIChzZWdzLCBjb250YWluZXJFbHMpIHsNCiAgICAgICAgdmFyIHNlZ3NCeUNvbDsNCiAgICAgICAgdmFyIGNvbDsNCiAgICAgICAgc2Vnc0J5Q29sID0gdGhpcy50aW1lR3JpZC5ncm91cFNlZ3NCeUNvbChzZWdzKTsNCiAgICAgICAgZm9yIChjb2wgPSAwOyBjb2wgPCB0aGlzLnRpbWVHcmlkLmNvbENudDsgY29sKyspIHsNCiAgICAgICAgICAgIHRoaXMudXBkYXRlRmdTZWdDb29yZHMoc2Vnc0J5Q29sW2NvbF0pOw0KICAgICAgICB9DQogICAgICAgIHRoaXMudGltZUdyaWQuYXR0YWNoU2Vnc0J5Q29sKHNlZ3NCeUNvbCwgY29udGFpbmVyRWxzKTsNCiAgICB9Ow0KICAgIFRpbWVHcmlkRXZlbnRSZW5kZXJlci5wcm90b3R5cGUudW5yZW5kZXJGZ1NlZ3MgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICh0aGlzLmZnU2Vncykgew0KICAgICAgICAgICAgdGhpcy5mZ1NlZ3MuZm9yRWFjaChmdW5jdGlvbiAoc2VnKSB7DQogICAgICAgICAgICAgICAgc2VnLmVsLnJlbW92ZSgpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIENvbXB1dGVzIGEgZGVmYXVsdCBldmVudCB0aW1lIGZvcm1hdHRpbmcgc3RyaW5nIGlmIGB0aW1lRm9ybWF0YCBpcyBub3QgZXhwbGljaXRseSBkZWZpbmVkDQogICAgVGltZUdyaWRFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5jb21wdXRlRXZlbnRUaW1lRm9ybWF0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gdGhpcy5vcHQoJ25vTWVyaWRpZW1UaW1lRm9ybWF0Jyk7IC8vIGxpa2UgIjY6MzAiIChubyBBTS9QTSkNCiAgICB9Ow0KICAgIC8vIENvbXB1dGVzIGEgZGVmYXVsdCBgZGlzcGxheUV2ZW50RW5kYCB2YWx1ZSBpZiBvbmUgaXMgbm90IGV4cGxpY2x0eSBkZWZpbmVkDQogICAgVGltZUdyaWRFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5jb21wdXRlRGlzcGxheUV2ZW50RW5kID0gZnVuY3Rpb24gKCkgew0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9Ow0KICAgIC8vIFJlbmRlcnMgdGhlIEhUTUwgZm9yIGEgc2luZ2xlIGV2ZW50IHNlZ21lbnQncyBkZWZhdWx0IHJlbmRlcmluZw0KICAgIFRpbWVHcmlkRXZlbnRSZW5kZXJlci5wcm90b3R5cGUuZmdTZWdIdG1sID0gZnVuY3Rpb24gKHNlZywgZGlzYWJsZVJlc2l6aW5nKSB7DQogICAgICAgIHZhciB2aWV3ID0gdGhpcy52aWV3Ow0KICAgICAgICB2YXIgY2FsZW5kYXIgPSB2aWV3LmNhbGVuZGFyOw0KICAgICAgICB2YXIgY29tcG9uZW50Rm9vdHByaW50ID0gc2VnLmZvb3RwcmludC5jb21wb25lbnRGb290cHJpbnQ7DQogICAgICAgIHZhciBpc0FsbERheSA9IGNvbXBvbmVudEZvb3RwcmludC5pc0FsbERheTsNCiAgICAgICAgdmFyIGV2ZW50RGVmID0gc2VnLmZvb3RwcmludC5ldmVudERlZjsNCiAgICAgICAgdmFyIGlzRHJhZ2dhYmxlID0gdmlldy5pc0V2ZW50RGVmRHJhZ2dhYmxlKGV2ZW50RGVmKTsNCiAgICAgICAgdmFyIGlzUmVzaXphYmxlRnJvbVN0YXJ0ID0gIWRpc2FibGVSZXNpemluZyAmJiBzZWcuaXNTdGFydCAmJiB2aWV3LmlzRXZlbnREZWZSZXNpemFibGVGcm9tU3RhcnQoZXZlbnREZWYpOw0KICAgICAgICB2YXIgaXNSZXNpemFibGVGcm9tRW5kID0gIWRpc2FibGVSZXNpemluZyAmJiBzZWcuaXNFbmQgJiYgdmlldy5pc0V2ZW50RGVmUmVzaXphYmxlRnJvbUVuZChldmVudERlZik7DQogICAgICAgIHZhciBjbGFzc2VzID0gdGhpcy5nZXRTZWdDbGFzc2VzKHNlZywgaXNEcmFnZ2FibGUsIGlzUmVzaXphYmxlRnJvbVN0YXJ0IHx8IGlzUmVzaXphYmxlRnJvbUVuZCk7DQogICAgICAgIHZhciBza2luQ3NzID0gdXRpbF8xLmNzc1RvU3RyKHRoaXMuZ2V0U2tpbkNzcyhldmVudERlZikpOw0KICAgICAgICB2YXIgdGltZVRleHQ7DQogICAgICAgIHZhciBmdWxsVGltZVRleHQ7IC8vIG1vcmUgdmVyYm9zZSB0aW1lIHRleHQuIGZvciB0aGUgcHJpbnQgc3R5bGVzaGVldA0KICAgICAgICB2YXIgc3RhcnRUaW1lVGV4dDsgLy8ganVzdCB0aGUgc3RhcnQgdGltZSB0ZXh0DQogICAgICAgIGNsYXNzZXMudW5zaGlmdCgnZmMtdGltZS1ncmlkLWV2ZW50JywgJ2ZjLXYtZXZlbnQnKTsNCiAgICAgICAgLy8gaWYgdGhlIGV2ZW50IGFwcGVhcnMgdG8gc3BhbiBtb3JlIHRoYW4gb25lIGRheS4uLg0KICAgICAgICBpZiAodmlldy5pc011bHRpRGF5UmFuZ2UoY29tcG9uZW50Rm9vdHByaW50LnVuem9uZWRSYW5nZSkpIHsNCiAgICAgICAgICAgIC8vIERvbid0IGRpc3BsYXkgdGltZSB0ZXh0IG9uIHNlZ21lbnRzIHRoYXQgcnVuIGVudGlyZWx5IHRocm91Z2ggYSBkYXkuDQogICAgICAgICAgICAvLyBUaGF0IHdvdWxkIGFwcGVhciBhcyBtaWRuaWdodC1taWRuaWdodCBhbmQgd291bGQgbG9vayBkdW1iLg0KICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBkaXNwbGF5IHRoZSB0aW1lIHRleHQgZm9yIHRoZSAqc2VnbWVudCdzKiB0aW1lcyAobGlrZSA2cG0tbWlkbmlnaHQgb3IgbWlkbmlnaHQtMTBhbSkNCiAgICAgICAgICAgIGlmIChzZWcuaXNTdGFydCB8fCBzZWcuaXNFbmQpIHsNCiAgICAgICAgICAgICAgICB2YXIgem9uZWRTdGFydCA9IGNhbGVuZGFyLm1zVG9Nb21lbnQoc2VnLnN0YXJ0TXMpOw0KICAgICAgICAgICAgICAgIHZhciB6b25lZEVuZCA9IGNhbGVuZGFyLm1zVG9Nb21lbnQoc2VnLmVuZE1zKTsNCiAgICAgICAgICAgICAgICB0aW1lVGV4dCA9IHRoaXMuX2dldFRpbWVUZXh0KHpvbmVkU3RhcnQsIHpvbmVkRW5kLCBpc0FsbERheSk7DQogICAgICAgICAgICAgICAgZnVsbFRpbWVUZXh0ID0gdGhpcy5fZ2V0VGltZVRleHQoem9uZWRTdGFydCwgem9uZWRFbmQsIGlzQWxsRGF5LCAnTFQnKTsNCiAgICAgICAgICAgICAgICBzdGFydFRpbWVUZXh0ID0gdGhpcy5fZ2V0VGltZVRleHQoem9uZWRTdGFydCwgem9uZWRFbmQsIGlzQWxsRGF5LCBudWxsLCBmYWxzZSk7IC8vIGRpc3BsYXlFbmQ9ZmFsc2UNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIC8vIERpc3BsYXkgdGhlIG5vcm1hbCB0aW1lIHRleHQgZm9yIHRoZSAqZXZlbnQncyogdGltZXMNCiAgICAgICAgICAgIHRpbWVUZXh0ID0gdGhpcy5nZXRUaW1lVGV4dChzZWcuZm9vdHByaW50KTsNCiAgICAgICAgICAgIGZ1bGxUaW1lVGV4dCA9IHRoaXMuZ2V0VGltZVRleHQoc2VnLmZvb3RwcmludCwgJ0xUJyk7DQogICAgICAgICAgICBzdGFydFRpbWVUZXh0ID0gdGhpcy5nZXRUaW1lVGV4dChzZWcuZm9vdHByaW50LCBudWxsLCBmYWxzZSk7IC8vIGRpc3BsYXlFbmQ9ZmFsc2UNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gJzxhIGNsYXNzPSInICsgY2xhc3Nlcy5qb2luKCcgJykgKyAnIicgKw0KICAgICAgICAgICAgKGV2ZW50RGVmLnVybCA/DQogICAgICAgICAgICAgICAgJyBocmVmPSInICsgdXRpbF8xLmh0bWxFc2NhcGUoZXZlbnREZWYudXJsKSArICciJyA6DQogICAgICAgICAgICAgICAgJycpICsNCiAgICAgICAgICAgIChza2luQ3NzID8NCiAgICAgICAgICAgICAgICAnIHN0eWxlPSInICsgc2tpbkNzcyArICciJyA6DQogICAgICAgICAgICAgICAgJycpICsNCiAgICAgICAgICAgICc+JyArDQogICAgICAgICAgICAnPGRpdiBjbGFzcz0iZmMtY29udGVudCI+JyArDQogICAgICAgICAgICAodGltZVRleHQgPw0KICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJmYy10aW1lIicgKw0KICAgICAgICAgICAgICAgICAgICAnIGRhdGEtc3RhcnQ9IicgKyB1dGlsXzEuaHRtbEVzY2FwZShzdGFydFRpbWVUZXh0KSArICciJyArDQogICAgICAgICAgICAgICAgICAgICcgZGF0YS1mdWxsPSInICsgdXRpbF8xLmh0bWxFc2NhcGUoZnVsbFRpbWVUZXh0KSArICciJyArDQogICAgICAgICAgICAgICAgICAgICc+JyArDQogICAgICAgICAgICAgICAgICAgICc8c3Bhbj4nICsgdXRpbF8xLmh0bWxFc2NhcGUodGltZVRleHQpICsgJzwvc3Bhbj4nICsNCiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgOg0KICAgICAgICAgICAgICAgICcnKSArDQogICAgICAgICAgICAoZXZlbnREZWYudGl0bGUgPw0KICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJmYy10aXRsZSI+JyArDQogICAgICAgICAgICAgICAgICAgIHV0aWxfMS5odG1sRXNjYXBlKGV2ZW50RGVmLnRpdGxlKSArDQogICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nIDoNCiAgICAgICAgICAgICAgICAnJykgKw0KICAgICAgICAgICAgJzwvZGl2PicgKw0KICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImZjLWJnIi8+JyArDQogICAgICAgICAgICAvKiBUT0RPOiB3cml0ZSBDU1MgZm9yIHRoaXMNCiAgICAgICAgICAgIChpc1Jlc2l6YWJsZUZyb21TdGFydCA/DQogICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJmYy1yZXNpemVyIGZjLXN0YXJ0LXJlc2l6ZXIiIC8+JyA6DQogICAgICAgICAgICAgICcnDQogICAgICAgICAgICAgICkgKw0KICAgICAgICAgICAgKi8NCiAgICAgICAgICAgIChpc1Jlc2l6YWJsZUZyb21FbmQgPw0KICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJmYy1yZXNpemVyIGZjLWVuZC1yZXNpemVyIiAvPicgOg0KICAgICAgICAgICAgICAgICcnKSArDQogICAgICAgICAgICAnPC9hPic7DQogICAgfTsNCiAgICAvLyBHaXZlbiBzZWdtZW50cyB0aGF0IGFyZSBhc3N1bWVkIHRvIGFsbCBsaXZlIGluIHRoZSAqc2FtZSBjb2x1bW4qLA0KICAgIC8vIGNvbXB1dGUgdGhlaXIgdmVyaWNhbC9ob3Jpem9udGFsIGNvb3JkaW5hdGVzIGFuZCBhc3NpZ24gdG8gdGhlaXIgZWxlbWVudHMuDQogICAgVGltZUdyaWRFdmVudFJlbmRlcmVyLnByb3RvdHlwZS51cGRhdGVGZ1NlZ0Nvb3JkcyA9IGZ1bmN0aW9uIChzZWdzKSB7DQogICAgICAgIHRoaXMudGltZUdyaWQuY29tcHV0ZVNlZ1ZlcnRpY2FscyhzZWdzKTsgLy8gaG9yaXpvbnRhbHMgcmVsaWVzIG9uIHRoaXMNCiAgICAgICAgdGhpcy5jb21wdXRlRmdTZWdIb3Jpem9udGFscyhzZWdzKTsgLy8gY29tcHV0ZSBob3Jpem9udGFsIGNvb3JkaW5hdGVzLCB6LWluZGV4J3MsIGFuZCByZW9yZGVyIHRoZSBhcnJheQ0KICAgICAgICB0aGlzLnRpbWVHcmlkLmFzc2lnblNlZ1ZlcnRpY2FscyhzZWdzKTsNCiAgICAgICAgdGhpcy5hc3NpZ25GZ1NlZ0hvcml6b250YWxzKHNlZ3MpOw0KICAgIH07DQogICAgLy8gR2l2ZW4gYW4gYXJyYXkgb2Ygc2VnbWVudHMgdGhhdCBhcmUgYWxsIGluIHRoZSBzYW1lIGNvbHVtbiwgc2V0cyB0aGUgYmFja3dhcmRDb29yZCBhbmQgZm9yd2FyZENvb3JkIG9uIGVhY2guDQogICAgLy8gTk9URTogQWxzbyByZW9yZGVycyB0aGUgZ2l2ZW4gYXJyYXkgYnkgZGF0ZSENCiAgICBUaW1lR3JpZEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLmNvbXB1dGVGZ1NlZ0hvcml6b250YWxzID0gZnVuY3Rpb24gKHNlZ3MpIHsNCiAgICAgICAgdmFyIGxldmVsczsNCiAgICAgICAgdmFyIGxldmVsMDsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIHRoaXMuc29ydEV2ZW50U2VncyhzZWdzKTsgLy8gb3JkZXIgYnkgY2VydGFpbiBjcml0ZXJpYQ0KICAgICAgICBsZXZlbHMgPSBidWlsZFNsb3RTZWdMZXZlbHMoc2Vncyk7DQogICAgICAgIGNvbXB1dGVGb3J3YXJkU2xvdFNlZ3MobGV2ZWxzKTsNCiAgICAgICAgaWYgKChsZXZlbDAgPSBsZXZlbHNbMF0pKSB7DQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGV2ZWwwLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgICAgY29tcHV0ZVNsb3RTZWdQcmVzc3VyZXMobGV2ZWwwW2ldKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZXZlbDAubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICB0aGlzLmNvbXB1dGVGZ1NlZ0ZvcndhcmRCYWNrKGxldmVsMFtpXSwgMCwgMCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIENhbGN1bGF0ZSBzZWcuZm9yd2FyZENvb3JkIGFuZCBzZWcuYmFja3dhcmRDb29yZCBmb3IgdGhlIHNlZ21lbnQsIHdoZXJlIGJvdGggdmFsdWVzIHJhbmdlDQogICAgLy8gZnJvbSAwIHRvIDEuIElmIHRoZSBjYWxlbmRhciBpcyBsZWZ0LXRvLXJpZ2h0LCB0aGUgc2VnLmJhY2t3YXJkQ29vcmQgbWFwcyB0byAibGVmdCIgYW5kDQogICAgLy8gc2VnLmZvcndhcmRDb29yZCBtYXBzIHRvICJyaWdodCIgKHZpYSBwZXJjZW50YWdlKS4gVmljZS12ZXJzYSBpZiB0aGUgY2FsZW5kYXIgaXMgcmlnaHQtdG8tbGVmdC4NCiAgICAvLw0KICAgIC8vIFRoZSBzZWdtZW50IG1pZ2h0IGJlIHBhcnQgb2YgYSAic2VyaWVzIiwgd2hpY2ggbWVhbnMgY29uc2VjdXRpdmUgc2VnbWVudHMgd2l0aCB0aGUgc2FtZSBwcmVzc3VyZQ0KICAgIC8vIHdobydzIHdpZHRoIGlzIHVua25vd24gdW50aWwgYW4gZWRnZSBoYXMgYmVlbiBoaXQuIGBzZXJpZXNCYWNrd2FyZFByZXNzdXJlYCBpcyB0aGUgbnVtYmVyIG9mDQogICAgLy8gc2VnbWVudHMgYmVoaW5kIHRoaXMgb25lIGluIHRoZSBjdXJyZW50IHNlcmllcywgYW5kIGBzZXJpZXNCYWNrd2FyZENvb3JkYCBpcyB0aGUgc3RhcnRpbmcNCiAgICAvLyBjb29yZGluYXRlIG9mIHRoZSBmaXJzdCBzZWdtZW50IGluIHRoZSBzZXJpZXMuDQogICAgVGltZUdyaWRFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5jb21wdXRlRmdTZWdGb3J3YXJkQmFjayA9IGZ1bmN0aW9uIChzZWcsIHNlcmllc0JhY2t3YXJkUHJlc3N1cmUsIHNlcmllc0JhY2t3YXJkQ29vcmQpIHsNCiAgICAgICAgdmFyIGZvcndhcmRTZWdzID0gc2VnLmZvcndhcmRTZWdzOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgaWYgKHNlZy5mb3J3YXJkQ29vcmQgPT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgaWYgKCFmb3J3YXJkU2Vncy5sZW5ndGgpIHsNCiAgICAgICAgICAgICAgICAvLyBpZiB0aGVyZSBhcmUgbm8gZm9yd2FyZCBzZWdtZW50cywgdGhpcyBzZWdtZW50IHNob3VsZCBidXR0IHVwIGFnYWluc3QgdGhlIGVkZ2UNCiAgICAgICAgICAgICAgICBzZWcuZm9yd2FyZENvb3JkID0gMTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIC8vIHNvcnQgaGlnaGVzdCBwcmVzc3VyZSBmaXJzdA0KICAgICAgICAgICAgICAgIHRoaXMuc29ydEZvcndhcmRTZWdzKGZvcndhcmRTZWdzKTsNCiAgICAgICAgICAgICAgICAvLyB0aGlzIHNlZ21lbnQncyBmb3J3YXJkQ29vcmQgd2lsbCBiZSBjYWxjdWxhdGVkIGZyb20gdGhlIGJhY2t3YXJkQ29vcmQgb2YgdGhlDQogICAgICAgICAgICAgICAgLy8gaGlnaGVzdC1wcmVzc3VyZSBmb3J3YXJkIHNlZ21lbnQuDQogICAgICAgICAgICAgICAgdGhpcy5jb21wdXRlRmdTZWdGb3J3YXJkQmFjayhmb3J3YXJkU2Vnc1swXSwgc2VyaWVzQmFja3dhcmRQcmVzc3VyZSArIDEsIHNlcmllc0JhY2t3YXJkQ29vcmQpOw0KICAgICAgICAgICAgICAgIHNlZy5mb3J3YXJkQ29vcmQgPSBmb3J3YXJkU2Vnc1swXS5iYWNrd2FyZENvb3JkOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgLy8gY2FsY3VsYXRlIHRoZSBiYWNrd2FyZENvb3JkIGZyb20gdGhlIGZvcndhcmRDb29yZC4gY29uc2lkZXIgdGhlIHNlcmllcw0KICAgICAgICAgICAgc2VnLmJhY2t3YXJkQ29vcmQgPSBzZWcuZm9yd2FyZENvb3JkIC0NCiAgICAgICAgICAgICAgICAoc2VnLmZvcndhcmRDb29yZCAtIHNlcmllc0JhY2t3YXJkQ29vcmQpIC8gLy8gYXZhaWxhYmxlIHdpZHRoIGZvciBzZXJpZXMNCiAgICAgICAgICAgICAgICAgICAgKHNlcmllc0JhY2t3YXJkUHJlc3N1cmUgKyAxKTsgLy8gIyBvZiBzZWdtZW50cyBpbiB0aGUgc2VyaWVzDQogICAgICAgICAgICAvLyB1c2UgdGhpcyBzZWdtZW50J3MgY29vcmRpbmF0ZXMgdG8gY29tcHV0ZWQgdGhlIGNvb3JkaW5hdGVzIG9mIHRoZSBsZXNzLXByZXNzdXJpemVkDQogICAgICAgICAgICAvLyBmb3J3YXJkIHNlZ21lbnRzDQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZm9yd2FyZFNlZ3MubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICB0aGlzLmNvbXB1dGVGZ1NlZ0ZvcndhcmRCYWNrKGZvcndhcmRTZWdzW2ldLCAwLCBzZWcuZm9yd2FyZENvb3JkKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH07DQogICAgVGltZUdyaWRFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5zb3J0Rm9yd2FyZFNlZ3MgPSBmdW5jdGlvbiAoZm9yd2FyZFNlZ3MpIHsNCiAgICAgICAgZm9yd2FyZFNlZ3Muc29ydCh1dGlsXzEucHJveHkodGhpcywgJ2NvbXBhcmVGb3J3YXJkU2VncycpKTsNCiAgICB9Ow0KICAgIC8vIEEgY21wIGZ1bmN0aW9uIGZvciBkZXRlcm1pbmluZyB3aGljaCBmb3J3YXJkIHNlZ21lbnQgdG8gcmVseSBvbiBtb3JlIHdoZW4gY29tcHV0aW5nIGNvb3JkaW5hdGVzLg0KICAgIFRpbWVHcmlkRXZlbnRSZW5kZXJlci5wcm90b3R5cGUuY29tcGFyZUZvcndhcmRTZWdzID0gZnVuY3Rpb24gKHNlZzEsIHNlZzIpIHsNCiAgICAgICAgLy8gcHV0IGhpZ2hlci1wcmVzc3VyZSBmaXJzdA0KICAgICAgICByZXR1cm4gc2VnMi5mb3J3YXJkUHJlc3N1cmUgLSBzZWcxLmZvcndhcmRQcmVzc3VyZSB8fA0KICAgICAgICAgICAgLy8gcHV0IHNlZ21lbnRzIHRoYXQgYXJlIGNsb3NlciB0byBpbml0aWFsIGVkZ2UgZmlyc3QgKGFuZCBmYXZvciBvbmVzIHdpdGggbm8gY29vcmRzIHlldCkNCiAgICAgICAgICAgIChzZWcxLmJhY2t3YXJkQ29vcmQgfHwgMCkgLSAoc2VnMi5iYWNrd2FyZENvb3JkIHx8IDApIHx8DQogICAgICAgICAgICAvLyBkbyBub3JtYWwgc29ydGluZy4uLg0KICAgICAgICAgICAgdGhpcy5jb21wYXJlRXZlbnRTZWdzKHNlZzEsIHNlZzIpOw0KICAgIH07DQogICAgLy8gR2l2ZW4gZm9yZWdyb3VuZCBldmVudCBzZWdtZW50cyB0aGF0IGhhdmUgYWxyZWFkeSBoYWQgdGhlaXIgcG9zaXRpb24gY29vcmRpbmF0ZXMgY29tcHV0ZWQsDQogICAgLy8gYXNzaWducyBwb3NpdGlvbi1yZWxhdGVkIENTUyB2YWx1ZXMgdG8gdGhlaXIgZWxlbWVudHMuDQogICAgVGltZUdyaWRFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5hc3NpZ25GZ1NlZ0hvcml6b250YWxzID0gZnVuY3Rpb24gKHNlZ3MpIHsNCiAgICAgICAgdmFyIGk7DQogICAgICAgIHZhciBzZWc7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZWdzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBzZWcgPSBzZWdzW2ldOw0KICAgICAgICAgICAgc2VnLmVsLmNzcyh0aGlzLmdlbmVyYXRlRmdTZWdIb3Jpem9udGFsQ3NzKHNlZykpOw0KICAgICAgICAgICAgLy8gaWYgdGhlIGhlaWdodCBpcyBzaG9ydCwgYWRkIGEgY2xhc3NOYW1lIGZvciBhbHRlcm5hdGUgc3R5bGluZw0KICAgICAgICAgICAgaWYgKHNlZy5ib3R0b20gLSBzZWcudG9wIDwgMzApIHsNCiAgICAgICAgICAgICAgICBzZWcuZWwuYWRkQ2xhc3MoJ2ZjLXNob3J0Jyk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIEdlbmVyYXRlcyBhbiBvYmplY3Qgd2l0aCBDU1MgcHJvcGVydGllcy92YWx1ZXMgdGhhdCBzaG91bGQgYmUgYXBwbGllZCB0byBhbiBldmVudCBzZWdtZW50IGVsZW1lbnQuDQogICAgLy8gQ29udGFpbnMgaW1wb3J0YW50IHBvc2l0aW9uaW5nLXJlbGF0ZWQgcHJvcGVydGllcyB0aGF0IHNob3VsZCBiZSBhcHBsaWVkIHRvIGFueSBldmVudCBlbGVtZW50LCBjdXN0b21pemVkIG9yIG5vdC4NCiAgICBUaW1lR3JpZEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLmdlbmVyYXRlRmdTZWdIb3Jpem9udGFsQ3NzID0gZnVuY3Rpb24gKHNlZykgew0KICAgICAgICB2YXIgc2hvdWxkT3ZlcmxhcCA9IHRoaXMub3B0KCdzbG90RXZlbnRPdmVybGFwJyk7DQogICAgICAgIHZhciBiYWNrd2FyZENvb3JkID0gc2VnLmJhY2t3YXJkQ29vcmQ7IC8vIHRoZSBsZWZ0IHNpZGUgaWYgTFRSLiB0aGUgcmlnaHQgc2lkZSBpZiBSVEwuIGZsb2F0aW5nLXBvaW50DQogICAgICAgIHZhciBmb3J3YXJkQ29vcmQgPSBzZWcuZm9yd2FyZENvb3JkOyAvLyB0aGUgcmlnaHQgc2lkZSBpZiBMVFIuIHRoZSBsZWZ0IHNpZGUgaWYgUlRMLiBmbG9hdGluZy1wb2ludA0KICAgICAgICB2YXIgcHJvcHMgPSB0aGlzLnRpbWVHcmlkLmdlbmVyYXRlU2VnVmVydGljYWxDc3Moc2VnKTsgLy8gZ2V0IHRvcC9ib3R0b20gZmlyc3QNCiAgICAgICAgdmFyIGlzUlRMID0gdGhpcy50aW1lR3JpZC5pc1JUTDsNCiAgICAgICAgdmFyIGxlZnQ7IC8vIGFtb3VudCBvZiBzcGFjZSBmcm9tIGxlZnQgZWRnZSwgYSBmcmFjdGlvbiBvZiB0aGUgdG90YWwgd2lkdGgNCiAgICAgICAgdmFyIHJpZ2h0OyAvLyBhbW91bnQgb2Ygc3BhY2UgZnJvbSByaWdodCBlZGdlLCBhIGZyYWN0aW9uIG9mIHRoZSB0b3RhbCB3aWR0aA0KICAgICAgICBpZiAoc2hvdWxkT3ZlcmxhcCkgew0KICAgICAgICAgICAgLy8gZG91YmxlIHRoZSB3aWR0aCwgYnV0IGRvbid0IGdvIGJleW9uZCB0aGUgbWF4aW11bSBmb3J3YXJkIGNvb3JkaW5hdGUgKDEuMCkNCiAgICAgICAgICAgIGZvcndhcmRDb29yZCA9IE1hdGgubWluKDEsIGJhY2t3YXJkQ29vcmQgKyAoZm9yd2FyZENvb3JkIC0gYmFja3dhcmRDb29yZCkgKiAyKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoaXNSVEwpIHsNCiAgICAgICAgICAgIGxlZnQgPSAxIC0gZm9yd2FyZENvb3JkOw0KICAgICAgICAgICAgcmlnaHQgPSBiYWNrd2FyZENvb3JkOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgbGVmdCA9IGJhY2t3YXJkQ29vcmQ7DQogICAgICAgICAgICByaWdodCA9IDEgLSBmb3J3YXJkQ29vcmQ7DQogICAgICAgIH0NCiAgICAgICAgcHJvcHMuekluZGV4ID0gc2VnLmxldmVsICsgMTsgLy8gY29udmVydCBmcm9tIDAtYmFzZSB0byAxLWJhc2VkDQogICAgICAgIHByb3BzLmxlZnQgPSBsZWZ0ICogMTAwICsgJyUnOw0KICAgICAgICBwcm9wcy5yaWdodCA9IHJpZ2h0ICogMTAwICsgJyUnOw0KICAgICAgICBpZiAoc2hvdWxkT3ZlcmxhcCAmJiBzZWcuZm9yd2FyZFByZXNzdXJlKSB7DQogICAgICAgICAgICAvLyBhZGQgcGFkZGluZyB0byB0aGUgZWRnZSBzbyB0aGF0IGZvcndhcmQgc3RhY2tlZCBldmVudHMgZG9uJ3QgY292ZXIgdGhlIHJlc2l6ZXIncyBpY29uDQogICAgICAgICAgICBwcm9wc1tpc1JUTCA/ICdtYXJnaW5MZWZ0JyA6ICdtYXJnaW5SaWdodCddID0gMTAgKiAyOyAvLyAxMCBpcyBhIGd1ZXNzdGltYXRlIG9mIHRoZSBpY29uJ3Mgd2lkdGgNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcHJvcHM7DQogICAgfTsNCiAgICByZXR1cm4gVGltZUdyaWRFdmVudFJlbmRlcmVyOw0KfShFdmVudFJlbmRlcmVyXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gVGltZUdyaWRFdmVudFJlbmRlcmVyOw0KLy8gQnVpbGRzIGFuIGFycmF5IG9mIHNlZ21lbnRzICJsZXZlbHMiLiBUaGUgZmlyc3QgbGV2ZWwgd2lsbCBiZSB0aGUgbGVmdG1vc3QgdGllciBvZiBzZWdtZW50cyBpZiB0aGUgY2FsZW5kYXIgaXMNCi8vIGxlZnQtdG8tcmlnaHQsIG9yIHRoZSByaWdodG1vc3QgaWYgdGhlIGNhbGVuZGFyIGlzIHJpZ2h0LXRvLWxlZnQuIEFzc3VtZXMgdGhlIHNlZ21lbnRzIGFyZSBhbHJlYWR5IG9yZGVyZWQgYnkgZGF0ZS4NCmZ1bmN0aW9uIGJ1aWxkU2xvdFNlZ0xldmVscyhzZWdzKSB7DQogICAgdmFyIGxldmVscyA9IFtdOw0KICAgIHZhciBpOw0KICAgIHZhciBzZWc7DQogICAgdmFyIGo7DQogICAgZm9yIChpID0gMDsgaSA8IHNlZ3MubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgc2VnID0gc2Vnc1tpXTsNCiAgICAgICAgLy8gZ28gdGhyb3VnaCBhbGwgdGhlIGxldmVscyBhbmQgc3RvcCBvbiB0aGUgZmlyc3QgbGV2ZWwgd2hlcmUgdGhlcmUgYXJlIG5vIGNvbGxpc2lvbnMNCiAgICAgICAgZm9yIChqID0gMDsgaiA8IGxldmVscy5sZW5ndGg7IGorKykgew0KICAgICAgICAgICAgaWYgKCFjb21wdXRlU2xvdFNlZ0NvbGxpc2lvbnMoc2VnLCBsZXZlbHNbal0pLmxlbmd0aCkgew0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHNlZy5sZXZlbCA9IGo7DQogICAgICAgIChsZXZlbHNbal0gfHwgKGxldmVsc1tqXSA9IFtdKSkucHVzaChzZWcpOw0KICAgIH0NCiAgICByZXR1cm4gbGV2ZWxzOw0KfQ0KLy8gRm9yIGV2ZXJ5IHNlZ21lbnQsIGZpZ3VyZSBvdXQgdGhlIG90aGVyIHNlZ21lbnRzIHRoYXQgYXJlIGluIHN1YnNlcXVlbnQNCi8vIGxldmVscyB0aGF0IGFsc28gb2NjdXB5IHRoZSBzYW1lIHZlcnRpY2FsIHNwYWNlLiBBY2N1bXVsYXRlIGluIHNlZy5mb3J3YXJkU2Vncw0KZnVuY3Rpb24gY29tcHV0ZUZvcndhcmRTbG90U2VncyhsZXZlbHMpIHsNCiAgICB2YXIgaTsNCiAgICB2YXIgbGV2ZWw7DQogICAgdmFyIGo7DQogICAgdmFyIHNlZzsNCiAgICB2YXIgazsNCiAgICBmb3IgKGkgPSAwOyBpIDwgbGV2ZWxzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgIGxldmVsID0gbGV2ZWxzW2ldOw0KICAgICAgICBmb3IgKGogPSAwOyBqIDwgbGV2ZWwubGVuZ3RoOyBqKyspIHsNCiAgICAgICAgICAgIHNlZyA9IGxldmVsW2pdOw0KICAgICAgICAgICAgc2VnLmZvcndhcmRTZWdzID0gW107DQogICAgICAgICAgICBmb3IgKGsgPSBpICsgMTsgayA8IGxldmVscy5sZW5ndGg7IGsrKykgew0KICAgICAgICAgICAgICAgIGNvbXB1dGVTbG90U2VnQ29sbGlzaW9ucyhzZWcsIGxldmVsc1trXSwgc2VnLmZvcndhcmRTZWdzKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCn0NCi8vIEZpZ3VyZSBvdXQgd2hpY2ggcGF0aCBmb3J3YXJkICh2aWEgc2VnLmZvcndhcmRTZWdzKSByZXN1bHRzIGluIHRoZSBsb25nZXN0IHBhdGggdW50aWwNCi8vIHRoZSBmdXJ0aGVzdCBlZGdlIGlzIHJlYWNoZWQuIFRoZSBudW1iZXIgb2Ygc2VnbWVudHMgaW4gdGhpcyBwYXRoIHdpbGwgYmUgc2VnLmZvcndhcmRQcmVzc3VyZQ0KZnVuY3Rpb24gY29tcHV0ZVNsb3RTZWdQcmVzc3VyZXMoc2VnKSB7DQogICAgdmFyIGZvcndhcmRTZWdzID0gc2VnLmZvcndhcmRTZWdzOw0KICAgIHZhciBmb3J3YXJkUHJlc3N1cmUgPSAwOw0KICAgIHZhciBpOw0KICAgIHZhciBmb3J3YXJkU2VnOw0KICAgIGlmIChzZWcuZm9yd2FyZFByZXNzdXJlID09PSB1bmRlZmluZWQpIHsNCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGZvcndhcmRTZWdzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBmb3J3YXJkU2VnID0gZm9yd2FyZFNlZ3NbaV07DQogICAgICAgICAgICAvLyBmaWd1cmUgb3V0IHRoZSBjaGlsZCdzIG1heGltdW0gZm9yd2FyZCBwYXRoDQogICAgICAgICAgICBjb21wdXRlU2xvdFNlZ1ByZXNzdXJlcyhmb3J3YXJkU2VnKTsNCiAgICAgICAgICAgIC8vIGVpdGhlciB1c2UgdGhlIGV4aXN0aW5nIG1heGltdW0sIG9yIHVzZSB0aGUgY2hpbGQncyBmb3J3YXJkIHByZXNzdXJlDQogICAgICAgICAgICAvLyBwbHVzIG9uZSAoZm9yIHRoZSBmb3J3YXJkU2VnIGl0c2VsZikNCiAgICAgICAgICAgIGZvcndhcmRQcmVzc3VyZSA9IE1hdGgubWF4KGZvcndhcmRQcmVzc3VyZSwgMSArIGZvcndhcmRTZWcuZm9yd2FyZFByZXNzdXJlKTsNCiAgICAgICAgfQ0KICAgICAgICBzZWcuZm9yd2FyZFByZXNzdXJlID0gZm9yd2FyZFByZXNzdXJlOw0KICAgIH0NCn0NCi8vIEZpbmQgYWxsIHRoZSBzZWdtZW50cyBpbiBgb3RoZXJTZWdzYCB0aGF0IHZlcnRpY2FsbHkgY29sbGlkZSB3aXRoIGBzZWdgLg0KLy8gQXBwZW5kIGludG8gYW4gb3B0aW9uYWxseS1zdXBwbGllZCBgcmVzdWx0c2AgYXJyYXkgYW5kIHJldHVybi4NCmZ1bmN0aW9uIGNvbXB1dGVTbG90U2VnQ29sbGlzaW9ucyhzZWcsIG90aGVyU2VncywgcmVzdWx0cykgew0KICAgIGlmIChyZXN1bHRzID09PSB2b2lkIDApIHsgcmVzdWx0cyA9IFtdOyB9DQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvdGhlclNlZ3MubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgaWYgKGlzU2xvdFNlZ0NvbGxpc2lvbihzZWcsIG90aGVyU2Vnc1tpXSkpIHsNCiAgICAgICAgICAgIHJlc3VsdHMucHVzaChvdGhlclNlZ3NbaV0pOw0KICAgICAgICB9DQogICAgfQ0KICAgIHJldHVybiByZXN1bHRzOw0KfQ0KLy8gRG8gdGhlc2Ugc2VnbWVudHMgb2NjdXB5IHRoZSBzYW1lIHZlcnRpY2FsIHNwYWNlPw0KZnVuY3Rpb24gaXNTbG90U2VnQ29sbGlzaW9uKHNlZzEsIHNlZzIpIHsNCiAgICByZXR1cm4gc2VnMS5ib3R0b20gPiBzZWcyLnRvcCAmJiBzZWcxLnRvcCA8IHNlZzIuYm90dG9tOw0KfQ0KCgovKioqLyB9KSwKLyogMjQ3ICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdHNsaWJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgSGVscGVyUmVuZGVyZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNTgpOw0KdmFyIFRpbWVHcmlkSGVscGVyUmVuZGVyZXIgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoVGltZUdyaWRIZWxwZXJSZW5kZXJlciwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBUaW1lR3JpZEhlbHBlclJlbmRlcmVyKCkgew0KICAgICAgICByZXR1cm4gX3N1cGVyICE9PSBudWxsICYmIF9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7DQogICAgfQ0KICAgIFRpbWVHcmlkSGVscGVyUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlclNlZ3MgPSBmdW5jdGlvbiAoc2Vncywgc291cmNlU2VnKSB7DQogICAgICAgIHZhciBoZWxwZXJOb2RlcyA9IFtdOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgdmFyIHNlZzsNCiAgICAgICAgdmFyIHNvdXJjZUVsOw0KICAgICAgICAvLyBUT0RPOiBub3QgZ29vZCB0byBjYWxsIGV2ZW50UmVuZGVyZXIgdGhpcyB3YXkNCiAgICAgICAgdGhpcy5ldmVudFJlbmRlcmVyLnJlbmRlckZnU2Vnc0ludG9Db250YWluZXJzKHNlZ3MsIHRoaXMuY29tcG9uZW50LmhlbHBlckNvbnRhaW5lckVscyk7DQogICAgICAgIC8vIFRyeSB0byBtYWtlIHRoZSBzZWdtZW50IHRoYXQgaXMgaW4gdGhlIHNhbWUgcm93IGFzIHNvdXJjZVNlZyBsb29rIHRoZSBzYW1lDQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZWdzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBzZWcgPSBzZWdzW2ldOw0KICAgICAgICAgICAgaWYgKHNvdXJjZVNlZyAmJiBzb3VyY2VTZWcuY29sID09PSBzZWcuY29sKSB7DQogICAgICAgICAgICAgICAgc291cmNlRWwgPSBzb3VyY2VTZWcuZWw7DQogICAgICAgICAgICAgICAgc2VnLmVsLmNzcyh7DQogICAgICAgICAgICAgICAgICAgIGxlZnQ6IHNvdXJjZUVsLmNzcygnbGVmdCcpLA0KICAgICAgICAgICAgICAgICAgICByaWdodDogc291cmNlRWwuY3NzKCdyaWdodCcpLA0KICAgICAgICAgICAgICAgICAgICAnbWFyZ2luLWxlZnQnOiBzb3VyY2VFbC5jc3MoJ21hcmdpbi1sZWZ0JyksDQogICAgICAgICAgICAgICAgICAgICdtYXJnaW4tcmlnaHQnOiBzb3VyY2VFbC5jc3MoJ21hcmdpbi1yaWdodCcpDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBoZWxwZXJOb2Rlcy5wdXNoKHNlZy5lbFswXSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuICQoaGVscGVyTm9kZXMpOyAvLyBtdXN0IHJldHVybiB0aGUgZWxlbWVudHMgcmVuZGVyZWQNCiAgICB9Ow0KICAgIHJldHVybiBUaW1lR3JpZEhlbHBlclJlbmRlcmVyOw0KfShIZWxwZXJSZW5kZXJlcl8xLmRlZmF1bHQpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IFRpbWVHcmlkSGVscGVyUmVuZGVyZXI7DQoKCi8qKiovIH0pLAovKiAyNDggKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciBGaWxsUmVuZGVyZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNTcpOw0KdmFyIFRpbWVHcmlkRmlsbFJlbmRlcmVyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKFRpbWVHcmlkRmlsbFJlbmRlcmVyLCBfc3VwZXIpOw0KICAgIGZ1bmN0aW9uIFRpbWVHcmlkRmlsbFJlbmRlcmVyKCkgew0KICAgICAgICByZXR1cm4gX3N1cGVyICE9PSBudWxsICYmIF9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7DQogICAgfQ0KICAgIFRpbWVHcmlkRmlsbFJlbmRlcmVyLnByb3RvdHlwZS5hdHRhY2hTZWdFbHMgPSBmdW5jdGlvbiAodHlwZSwgc2Vncykgew0KICAgICAgICB2YXIgdGltZUdyaWQgPSB0aGlzLmNvbXBvbmVudDsNCiAgICAgICAgdmFyIGNvbnRhaW5lckVsczsNCiAgICAgICAgLy8gVE9ETzogbW9yZSBlZmZpY2llbnQgbG9va3VwDQogICAgICAgIGlmICh0eXBlID09PSAnYmdFdmVudCcpIHsNCiAgICAgICAgICAgIGNvbnRhaW5lckVscyA9IHRpbWVHcmlkLmJnQ29udGFpbmVyRWxzOw0KICAgICAgICB9DQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT09ICdidXNpbmVzc0hvdXJzJykgew0KICAgICAgICAgICAgY29udGFpbmVyRWxzID0gdGltZUdyaWQuYnVzaW5lc3NDb250YWluZXJFbHM7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gJ2hpZ2hsaWdodCcpIHsNCiAgICAgICAgICAgIGNvbnRhaW5lckVscyA9IHRpbWVHcmlkLmhpZ2hsaWdodENvbnRhaW5lckVsczsNCiAgICAgICAgfQ0KICAgICAgICB0aW1lR3JpZC51cGRhdGVTZWdWZXJ0aWNhbHMoc2Vncyk7DQogICAgICAgIHRpbWVHcmlkLmF0dGFjaFNlZ3NCeUNvbCh0aW1lR3JpZC5ncm91cFNlZ3NCeUNvbChzZWdzKSwgY29udGFpbmVyRWxzKTsNCiAgICAgICAgcmV0dXJuIHNlZ3MubWFwKGZ1bmN0aW9uIChzZWcpIHsNCiAgICAgICAgICAgIHJldHVybiBzZWcuZWxbMF07DQogICAgICAgIH0pOw0KICAgIH07DQogICAgcmV0dXJuIFRpbWVHcmlkRmlsbFJlbmRlcmVyOw0KfShGaWxsUmVuZGVyZXJfMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBUaW1lR3JpZEZpbGxSZW5kZXJlcjsNCgoKLyoqKi8gfSksCi8qIDI0OSAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgovKiBBIHJlY3Rhbmd1bGFyIHBhbmVsIHRoYXQgaXMgYWJzb2x1dGVseSBwb3NpdGlvbmVkIG92ZXIgb3RoZXIgY29udGVudA0KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQpPcHRpb25zOg0KICAtIGNsYXNzTmFtZSAoc3RyaW5nKQ0KICAtIGNvbnRlbnQgKEhUTUwgc3RyaW5nIG9yIGpRdWVyeSBlbGVtZW50IHNldCkNCiAgLSBwYXJlbnRFbA0KICAtIHRvcA0KICAtIGxlZnQNCiAgLSByaWdodCAodGhlIHggY29vcmQgb2Ygd2hlcmUgdGhlIHJpZ2h0IGVkZ2Ugc2hvdWxkIGJlLiBub3QgYSAiQ1NTIiByaWdodCkNCiAgLSBhdXRvSGlkZSAoYm9vbGVhbikNCiAgLSBzaG93IChjYWxsYmFjaykNCiAgLSBoaWRlIChjYWxsYmFjaykNCiovDQpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyICQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOw0KdmFyIHV0aWxfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7DQp2YXIgTGlzdGVuZXJNaXhpbl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg3KTsNCnZhciBQb3BvdmVyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgew0KICAgIGZ1bmN0aW9uIFBvcG92ZXIob3B0aW9ucykgew0KICAgICAgICB0aGlzLmlzSGlkZGVuID0gdHJ1ZTsNCiAgICAgICAgdGhpcy5tYXJnaW4gPSAxMDsgLy8gdGhlIHNwYWNlIHJlcXVpcmVkIGJldHdlZW4gdGhlIHBvcG92ZXIgYW5kIHRoZSBlZGdlcyBvZiB0aGUgc2Nyb2xsIGNvbnRhaW5lcg0KICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9Ow0KICAgIH0NCiAgICAvLyBTaG93cyB0aGUgcG9wb3ZlciBvbiB0aGUgc3BlY2lmaWVkIHBvc2l0aW9uLiBSZW5kZXJzIGl0IGlmIG5vdCBhbHJlYWR5DQogICAgUG9wb3Zlci5wcm90b3R5cGUuc2hvdyA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKHRoaXMuaXNIaWRkZW4pIHsNCiAgICAgICAgICAgIGlmICghdGhpcy5lbCkgew0KICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyKCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLmVsLnNob3coKTsNCiAgICAgICAgICAgIHRoaXMucG9zaXRpb24oKTsNCiAgICAgICAgICAgIHRoaXMuaXNIaWRkZW4gPSBmYWxzZTsNCiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignc2hvdycpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBIaWRlcyB0aGUgcG9wb3ZlciwgdGhyb3VnaCBDU1MsIGJ1dCBkb2VzIG5vdCByZW1vdmUgaXQgZnJvbSB0aGUgRE9NDQogICAgUG9wb3Zlci5wcm90b3R5cGUuaGlkZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYgKCF0aGlzLmlzSGlkZGVuKSB7DQogICAgICAgICAgICB0aGlzLmVsLmhpZGUoKTsNCiAgICAgICAgICAgIHRoaXMuaXNIaWRkZW4gPSB0cnVlOw0KICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdoaWRlJyk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIENyZWF0ZXMgYHRoaXMuZWxgIGFuZCByZW5kZXJzIGNvbnRlbnQgaW5zaWRlIG9mIGl0DQogICAgUG9wb3Zlci5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICB2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsNCiAgICAgICAgdGhpcy5lbCA9ICQoJzxkaXYgY2xhc3M9ImZjLXBvcG92ZXIiLz4nKQ0KICAgICAgICAgICAgLmFkZENsYXNzKG9wdGlvbnMuY2xhc3NOYW1lIHx8ICcnKQ0KICAgICAgICAgICAgLmNzcyh7DQogICAgICAgICAgICAvLyBwb3NpdGlvbiBpbml0aWFsbHkgdG8gdGhlIHRvcCBsZWZ0IHRvIGF2b2lkIGNyZWF0aW5nIHNjcm9sbGJhcnMNCiAgICAgICAgICAgIHRvcDogMCwNCiAgICAgICAgICAgIGxlZnQ6IDANCiAgICAgICAgfSkNCiAgICAgICAgICAgIC5hcHBlbmQob3B0aW9ucy5jb250ZW50KQ0KICAgICAgICAgICAgLmFwcGVuZFRvKG9wdGlvbnMucGFyZW50RWwpOw0KICAgICAgICAvLyB3aGVuIGEgY2xpY2sgaGFwcGVucyBvbiBhbnl0aGluZyBpbnNpZGUgd2l0aCBhICdmYy1jbG9zZScgY2xhc3NOYW1lLCBoaWRlIHRoZSBwb3BvdmVyDQogICAgICAgIHRoaXMuZWwub24oJ2NsaWNrJywgJy5mYy1jbG9zZScsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIF90aGlzLmhpZGUoKTsNCiAgICAgICAgfSk7DQogICAgICAgIGlmIChvcHRpb25zLmF1dG9IaWRlKSB7DQogICAgICAgICAgICB0aGlzLmxpc3RlblRvKCQoZG9jdW1lbnQpLCAnbW91c2Vkb3duJywgdGhpcy5kb2N1bWVudE1vdXNlZG93bik7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIFRyaWdnZXJlZCB3aGVuIHRoZSB1c2VyIGNsaWNrcyAqYW55d2hlcmUqIGluIHRoZSBkb2N1bWVudCwgZm9yIHRoZSBhdXRvSGlkZSBmZWF0dXJlDQogICAgUG9wb3Zlci5wcm90b3R5cGUuZG9jdW1lbnRNb3VzZWRvd24gPSBmdW5jdGlvbiAoZXYpIHsNCiAgICAgICAgLy8gb25seSBoaWRlIHRoZSBwb3BvdmVyIGlmIHRoZSBjbGljayBoYXBwZW5lZCBvdXRzaWRlIHRoZSBwb3BvdmVyDQogICAgICAgIGlmICh0aGlzLmVsICYmICEkKGV2LnRhcmdldCkuY2xvc2VzdCh0aGlzLmVsKS5sZW5ndGgpIHsNCiAgICAgICAgICAgIHRoaXMuaGlkZSgpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvLyBIaWRlcyBhbmQgdW5yZWdpc3RlcnMgYW55IGhhbmRsZXJzDQogICAgUG9wb3Zlci5wcm90b3R5cGUucmVtb3ZlRWxlbWVudCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdGhpcy5oaWRlKCk7DQogICAgICAgIGlmICh0aGlzLmVsKSB7DQogICAgICAgICAgICB0aGlzLmVsLnJlbW92ZSgpOw0KICAgICAgICAgICAgdGhpcy5lbCA9IG51bGw7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nVG8oJChkb2N1bWVudCksICdtb3VzZWRvd24nKTsNCiAgICB9Ow0KICAgIC8vIFBvc2l0aW9ucyB0aGUgcG9wb3ZlciBvcHRpbWFsbHksIHVzaW5nIHRoZSB0b3AvbGVmdC9yaWdodCBvcHRpb25zDQogICAgUG9wb3Zlci5wcm90b3R5cGUucG9zaXRpb24gPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOw0KICAgICAgICB2YXIgb3JpZ2luID0gdGhpcy5lbC5vZmZzZXRQYXJlbnQoKS5vZmZzZXQoKTsNCiAgICAgICAgdmFyIHdpZHRoID0gdGhpcy5lbC5vdXRlcldpZHRoKCk7DQogICAgICAgIHZhciBoZWlnaHQgPSB0aGlzLmVsLm91dGVySGVpZ2h0KCk7DQogICAgICAgIHZhciB3aW5kb3dFbCA9ICQod2luZG93KTsNCiAgICAgICAgdmFyIHZpZXdwb3J0RWwgPSB1dGlsXzEuZ2V0U2Nyb2xsUGFyZW50KHRoaXMuZWwpOw0KICAgICAgICB2YXIgdmlld3BvcnRUb3A7DQogICAgICAgIHZhciB2aWV3cG9ydExlZnQ7DQogICAgICAgIHZhciB2aWV3cG9ydE9mZnNldDsNCiAgICAgICAgdmFyIHRvcDsgLy8gdGhlICJwb3NpdGlvbiIgKG5vdCAib2Zmc2V0IikgdmFsdWVzIGZvciB0aGUgcG9wb3Zlcg0KICAgICAgICB2YXIgbGVmdDsgLy8NCiAgICAgICAgLy8gY29tcHV0ZSB0b3AgYW5kIGxlZnQNCiAgICAgICAgdG9wID0gb3B0aW9ucy50b3AgfHwgMDsNCiAgICAgICAgaWYgKG9wdGlvbnMubGVmdCAhPT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICBsZWZ0ID0gb3B0aW9ucy5sZWZ0Ow0KICAgICAgICB9DQogICAgICAgIGVsc2UgaWYgKG9wdGlvbnMucmlnaHQgIT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgbGVmdCA9IG9wdGlvbnMucmlnaHQgLSB3aWR0aDsgLy8gZGVyaXZlIHRoZSBsZWZ0IHZhbHVlIGZyb20gdGhlIHJpZ2h0IHZhbHVlDQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBsZWZ0ID0gMDsNCiAgICAgICAgfQ0KICAgICAgICBpZiAodmlld3BvcnRFbC5pcyh3aW5kb3cpIHx8IHZpZXdwb3J0RWwuaXMoZG9jdW1lbnQpKSB7DQogICAgICAgICAgICB2aWV3cG9ydEVsID0gd2luZG93RWw7DQogICAgICAgICAgICB2aWV3cG9ydFRvcCA9IDA7IC8vIHRoZSB3aW5kb3cgaXMgYWx3YXlzIGF0IHRoZSB0b3AgbGVmdA0KICAgICAgICAgICAgdmlld3BvcnRMZWZ0ID0gMDsgLy8gKGFuZCAub2Zmc2V0KCkgd29uJ3Qgd29yayBpZiBjYWxsZWQgaGVyZSkNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHZpZXdwb3J0T2Zmc2V0ID0gdmlld3BvcnRFbC5vZmZzZXQoKTsNCiAgICAgICAgICAgIHZpZXdwb3J0VG9wID0gdmlld3BvcnRPZmZzZXQudG9wOw0KICAgICAgICAgICAgdmlld3BvcnRMZWZ0ID0gdmlld3BvcnRPZmZzZXQubGVmdDsNCiAgICAgICAgfQ0KICAgICAgICAvLyBpZiB0aGUgd2luZG93IGlzIHNjcm9sbGVkLCBpdCBjYXVzZXMgdGhlIHZpc2libGUgYXJlYSB0byBiZSBmdXJ0aGVyIGRvd24NCiAgICAgICAgdmlld3BvcnRUb3AgKz0gd2luZG93RWwuc2Nyb2xsVG9wKCk7DQogICAgICAgIHZpZXdwb3J0TGVmdCArPSB3aW5kb3dFbC5zY3JvbGxMZWZ0KCk7DQogICAgICAgIC8vIGNvbnN0cmFpbiB0byB0aGUgdmlldyBwb3J0LiBpZiBjb25zdHJhaW5lZCBieSB0d28gZWRnZXMsIGdpdmUgcHJlY2VkZW5jZSB0byB0b3AvbGVmdA0KICAgICAgICBpZiAob3B0aW9ucy52aWV3cG9ydENvbnN0cmFpbiAhPT0gZmFsc2UpIHsNCiAgICAgICAgICAgIHRvcCA9IE1hdGgubWluKHRvcCwgdmlld3BvcnRUb3AgKyB2aWV3cG9ydEVsLm91dGVySGVpZ2h0KCkgLSBoZWlnaHQgLSB0aGlzLm1hcmdpbik7DQogICAgICAgICAgICB0b3AgPSBNYXRoLm1heCh0b3AsIHZpZXdwb3J0VG9wICsgdGhpcy5tYXJnaW4pOw0KICAgICAgICAgICAgbGVmdCA9IE1hdGgubWluKGxlZnQsIHZpZXdwb3J0TGVmdCArIHZpZXdwb3J0RWwub3V0ZXJXaWR0aCgpIC0gd2lkdGggLSB0aGlzLm1hcmdpbik7DQogICAgICAgICAgICBsZWZ0ID0gTWF0aC5tYXgobGVmdCwgdmlld3BvcnRMZWZ0ICsgdGhpcy5tYXJnaW4pOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuZWwuY3NzKHsNCiAgICAgICAgICAgIHRvcDogdG9wIC0gb3JpZ2luLnRvcCwNCiAgICAgICAgICAgIGxlZnQ6IGxlZnQgLSBvcmlnaW4ubGVmdA0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIC8vIFRyaWdnZXJzIGEgY2FsbGJhY2suIENhbGxzIGEgZnVuY3Rpb24gaW4gdGhlIG9wdGlvbiBoYXNoIG9mIHRoZSBzYW1lIG5hbWUuDQogICAgLy8gQXJndW1lbnRzIGJleW9uZCB0aGUgZmlyc3QgYG5hbWVgIGFyZSBmb3J3YXJkZWQgb24uDQogICAgLy8gVE9ETzogYmV0dGVyIGNvZGUgcmV1c2UgZm9yIHRoaXMuIFJlcGVhdCBjb2RlDQogICAgUG9wb3Zlci5wcm90b3R5cGUudHJpZ2dlciA9IGZ1bmN0aW9uIChuYW1lKSB7DQogICAgICAgIGlmICh0aGlzLm9wdGlvbnNbbmFtZV0pIHsNCiAgICAgICAgICAgIHRoaXMub3B0aW9uc1tuYW1lXS5hcHBseSh0aGlzLCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsNCiAgICAgICAgfQ0KICAgIH07DQogICAgcmV0dXJuIFBvcG92ZXI7DQp9KCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gUG9wb3ZlcjsNCkxpc3RlbmVyTWl4aW5fMS5kZWZhdWx0Lm1peEludG8oUG9wb3Zlcik7DQoKCi8qKiovIH0pLAovKiAyNTAgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciAkID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsNCnZhciB1dGlsXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQpOw0KdmFyIEV2ZW50UmVuZGVyZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNDIpOw0KLyogRXZlbnQtcmVuZGVyaW5nIG1ldGhvZHMgZm9yIHRoZSBEYXlHcmlkIGNsYXNzDQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8NCnZhciBEYXlHcmlkRXZlbnRSZW5kZXJlciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHsNCiAgICB0c2xpYl8xLl9fZXh0ZW5kcyhEYXlHcmlkRXZlbnRSZW5kZXJlciwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBEYXlHcmlkRXZlbnRSZW5kZXJlcihkYXlHcmlkLCBmaWxsUmVuZGVyZXIpIHsNCiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgZGF5R3JpZCwgZmlsbFJlbmRlcmVyKSB8fCB0aGlzOw0KICAgICAgICBfdGhpcy5kYXlHcmlkID0gZGF5R3JpZDsNCiAgICAgICAgcmV0dXJuIF90aGlzOw0KICAgIH0NCiAgICBEYXlHcmlkRXZlbnRSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyQmdSYW5nZXMgPSBmdW5jdGlvbiAoZXZlbnRSYW5nZXMpIHsNCiAgICAgICAgLy8gZG9uJ3QgcmVuZGVyIHRpbWVkIGJhY2tncm91bmQgZXZlbnRzDQogICAgICAgIGV2ZW50UmFuZ2VzID0gJC5ncmVwKGV2ZW50UmFuZ2VzLCBmdW5jdGlvbiAoZXZlbnRSYW5nZSkgew0KICAgICAgICAgICAgcmV0dXJuIGV2ZW50UmFuZ2UuZXZlbnREZWYuaXNBbGxEYXkoKTsNCiAgICAgICAgfSk7DQogICAgICAgIF9zdXBlci5wcm90b3R5cGUucmVuZGVyQmdSYW5nZXMuY2FsbCh0aGlzLCBldmVudFJhbmdlcyk7DQogICAgfTsNCiAgICAvLyBSZW5kZXJzIHRoZSBnaXZlbiBmb3JlZ3JvdW5kIGV2ZW50IHNlZ21lbnRzIG9udG8gdGhlIGdyaWQNCiAgICBEYXlHcmlkRXZlbnRSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyRmdTZWdzID0gZnVuY3Rpb24gKHNlZ3MpIHsNCiAgICAgICAgdmFyIHJvd1N0cnVjdHMgPSB0aGlzLnJvd1N0cnVjdHMgPSB0aGlzLnJlbmRlclNlZ1Jvd3Moc2Vncyk7DQogICAgICAgIC8vIGFwcGVuZCB0byBlYWNoIHJvdydzIGNvbnRlbnQgc2tlbGV0b24NCiAgICAgICAgdGhpcy5kYXlHcmlkLnJvd0Vscy5lYWNoKGZ1bmN0aW9uIChpLCByb3dOb2RlKSB7DQogICAgICAgICAgICAkKHJvd05vZGUpLmZpbmQoJy5mYy1jb250ZW50LXNrZWxldG9uID4gdGFibGUnKS5hcHBlbmQocm93U3RydWN0c1tpXS50Ym9keUVsKTsNCiAgICAgICAgfSk7DQogICAgfTsNCiAgICAvLyBVbnJlbmRlcnMgYWxsIGN1cnJlbnRseSByZW5kZXJlZCBmb3JlZ3JvdW5kIGV2ZW50IHNlZ21lbnRzDQogICAgRGF5R3JpZEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLnVucmVuZGVyRmdTZWdzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgcm93U3RydWN0cyA9IHRoaXMucm93U3RydWN0cyB8fCBbXTsNCiAgICAgICAgdmFyIHJvd1N0cnVjdDsNCiAgICAgICAgd2hpbGUgKChyb3dTdHJ1Y3QgPSByb3dTdHJ1Y3RzLnBvcCgpKSkgew0KICAgICAgICAgICAgcm93U3RydWN0LnRib2R5RWwucmVtb3ZlKCk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5yb3dTdHJ1Y3RzID0gbnVsbDsNCiAgICB9Ow0KICAgIC8vIFVzZXMgdGhlIGdpdmVuIGV2ZW50cyBhcnJheSB0byBnZW5lcmF0ZSA8dGJvZHk+IGVsZW1lbnRzIHRoYXQgc2hvdWxkIGJlIGFwcGVuZGVkIHRvIGVhY2ggcm93J3MgY29udGVudCBza2VsZXRvbi4NCiAgICAvLyBSZXR1cm5zIGFuIGFycmF5IG9mIHJvd1N0cnVjdCBvYmplY3RzIChzZWUgdGhlIGJvdHRvbSBvZiBgcmVuZGVyU2VnUm93YCkuDQogICAgLy8gUFJFQ09ORElUSU9OOiBlYWNoIHNlZ21lbnQgc2hvdWQgYWxyZWFkeSBoYXZlIGEgcmVuZGVyZWQgYW5kIGFzc2lnbmVkIGAuZWxgDQogICAgRGF5R3JpZEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLnJlbmRlclNlZ1Jvd3MgPSBmdW5jdGlvbiAoc2Vncykgew0KICAgICAgICB2YXIgcm93U3RydWN0cyA9IFtdOw0KICAgICAgICB2YXIgc2VnUm93czsNCiAgICAgICAgdmFyIHJvdzsNCiAgICAgICAgc2VnUm93cyA9IHRoaXMuZ3JvdXBTZWdSb3dzKHNlZ3MpOyAvLyBncm91cCBpbnRvIG5lc3RlZCBhcnJheXMNCiAgICAgICAgLy8gaXRlcmF0ZSBlYWNoIHJvdyBvZiBzZWdtZW50IGdyb3VwaW5ncw0KICAgICAgICBmb3IgKHJvdyA9IDA7IHJvdyA8IHNlZ1Jvd3MubGVuZ3RoOyByb3crKykgew0KICAgICAgICAgICAgcm93U3RydWN0cy5wdXNoKHRoaXMucmVuZGVyU2VnUm93KHJvdywgc2VnUm93c1tyb3ddKSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHJvd1N0cnVjdHM7DQogICAgfTsNCiAgICAvLyBHaXZlbiBhIHJvdyAjIGFuZCBhbiBhcnJheSBvZiBzZWdtZW50cyBhbGwgaW4gdGhlIHNhbWUgcm93LCByZW5kZXIgYSA8dGJvZHk+IGVsZW1lbnQsIGEgc2tlbGV0b24gdGhhdCBjb250YWlucw0KICAgIC8vIHRoZSBzZWdtZW50cy4gUmV0dXJucyBvYmplY3Qgd2l0aCBhIGJ1bmNoIG9mIGludGVybmFsIGRhdGEgYWJvdXQgaG93IHRoZSByZW5kZXIgd2FzIGNhbGN1bGF0ZWQuDQogICAgLy8gTk9URTogbW9kaWZpZXMgcm93U2Vncw0KICAgIERheUdyaWRFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJTZWdSb3cgPSBmdW5jdGlvbiAocm93LCByb3dTZWdzKSB7DQogICAgICAgIHZhciBjb2xDbnQgPSB0aGlzLmRheUdyaWQuY29sQ250Ow0KICAgICAgICB2YXIgc2VnTGV2ZWxzID0gdGhpcy5idWlsZFNlZ0xldmVscyhyb3dTZWdzKTsgLy8gZ3JvdXAgaW50byBzdWItYXJyYXlzIG9mIGxldmVscw0KICAgICAgICB2YXIgbGV2ZWxDbnQgPSBNYXRoLm1heCgxLCBzZWdMZXZlbHMubGVuZ3RoKTsgLy8gZW5zdXJlIGF0IGxlYXN0IG9uZSBsZXZlbA0KICAgICAgICB2YXIgdGJvZHkgPSAkKCc8dGJvZHkvPicpOw0KICAgICAgICB2YXIgc2VnTWF0cml4ID0gW107IC8vIGxvb2t1cCBmb3Igd2hpY2ggc2VnbWVudHMgYXJlIHJlbmRlcmVkIGludG8gd2hpY2ggbGV2ZWwrY29sIGNlbGxzDQogICAgICAgIHZhciBjZWxsTWF0cml4ID0gW107IC8vIGxvb2t1cCBmb3IgYWxsIDx0ZD4gZWxlbWVudHMgb2YgdGhlIGxldmVsK2NvbCBtYXRyaXgNCiAgICAgICAgdmFyIGxvbmVDZWxsTWF0cml4ID0gW107IC8vIGxvb2t1cCBmb3IgPHRkPiBlbGVtZW50cyB0aGF0IG9ubHkgdGFrZSB1cCBhIHNpbmdsZSBjb2x1bW4NCiAgICAgICAgdmFyIGk7DQogICAgICAgIHZhciBsZXZlbFNlZ3M7DQogICAgICAgIHZhciBjb2w7DQogICAgICAgIHZhciB0cjsNCiAgICAgICAgdmFyIGo7DQogICAgICAgIHZhciBzZWc7DQogICAgICAgIHZhciB0ZDsNCiAgICAgICAgLy8gcG9wdWxhdGVzIGVtcHR5IGNlbGxzIGZyb20gdGhlIGN1cnJlbnQgY29sdW1uIChgY29sYCkgdG8gYGVuZENvbGANCiAgICAgICAgZnVuY3Rpb24gZW1wdHlDZWxsc1VudGlsKGVuZENvbCkgew0KICAgICAgICAgICAgd2hpbGUgKGNvbCA8IGVuZENvbCkgew0KICAgICAgICAgICAgICAgIC8vIHRyeSB0byBncmFiIGEgY2VsbCBmcm9tIHRoZSBsZXZlbCBhYm92ZSBhbmQgZXh0ZW5kIGl0cyByb3dzcGFuLiBvdGhlcndpc2UsIGNyZWF0ZSBhIGZyZXNoIGNlbGwNCiAgICAgICAgICAgICAgICB0ZCA9IChsb25lQ2VsbE1hdHJpeFtpIC0gMV0gfHwgW10pW2NvbF07DQogICAgICAgICAgICAgICAgaWYgKHRkKSB7DQogICAgICAgICAgICAgICAgICAgIHRkLmF0dHIoJ3Jvd3NwYW4nLCBwYXJzZUludCh0ZC5hdHRyKCdyb3dzcGFuJykgfHwgMSwgMTApICsgMSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICB0ZCA9ICQoJzx0ZC8+Jyk7DQogICAgICAgICAgICAgICAgICAgIHRyLmFwcGVuZCh0ZCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGNlbGxNYXRyaXhbaV1bY29sXSA9IHRkOw0KICAgICAgICAgICAgICAgIGxvbmVDZWxsTWF0cml4W2ldW2NvbF0gPSB0ZDsNCiAgICAgICAgICAgICAgICBjb2wrKzsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGV2ZWxDbnQ7IGkrKykgew0KICAgICAgICAgICAgbGV2ZWxTZWdzID0gc2VnTGV2ZWxzW2ldOw0KICAgICAgICAgICAgY29sID0gMDsNCiAgICAgICAgICAgIHRyID0gJCgnPHRyLz4nKTsNCiAgICAgICAgICAgIHNlZ01hdHJpeC5wdXNoKFtdKTsNCiAgICAgICAgICAgIGNlbGxNYXRyaXgucHVzaChbXSk7DQogICAgICAgICAgICBsb25lQ2VsbE1hdHJpeC5wdXNoKFtdKTsNCiAgICAgICAgICAgIC8vIGxldmVsQ250IG1pZ2h0IGJlIDEgZXZlbiB0aG91Z2ggdGhlcmUgYXJlIG5vIGFjdHVhbCBsZXZlbHMuIHByb3RlY3QgYWdhaW5zdCB0aGlzLg0KICAgICAgICAgICAgLy8gdGhpcyBzaW5nbGUgZW1wdHkgcm93IGlzIHVzZWZ1bCBmb3Igc3R5bGluZy4NCiAgICAgICAgICAgIGlmIChsZXZlbFNlZ3MpIHsNCiAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbGV2ZWxTZWdzLmxlbmd0aDsgaisrKSB7DQogICAgICAgICAgICAgICAgICAgIHNlZyA9IGxldmVsU2Vnc1tqXTsNCiAgICAgICAgICAgICAgICAgICAgZW1wdHlDZWxsc1VudGlsKHNlZy5sZWZ0Q29sKTsNCiAgICAgICAgICAgICAgICAgICAgLy8gY3JlYXRlIGEgY29udGFpbmVyIHRoYXQgb2NjdXBpZXMgb3IgbW9yZSBjb2x1bW5zLiBhcHBlbmQgdGhlIGV2ZW50IGVsZW1lbnQuDQogICAgICAgICAgICAgICAgICAgIHRkID0gJCgnPHRkIGNsYXNzPSJmYy1ldmVudC1jb250YWluZXIiLz4nKS5hcHBlbmQoc2VnLmVsKTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKHNlZy5sZWZ0Q29sICE9PSBzZWcucmlnaHRDb2wpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRkLmF0dHIoJ2NvbHNwYW4nLCBzZWcucmlnaHRDb2wgLSBzZWcubGVmdENvbCArIDEpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgbG9uZUNlbGxNYXRyaXhbaV1bY29sXSA9IHRkOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHdoaWxlIChjb2wgPD0gc2VnLnJpZ2h0Q29sKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBjZWxsTWF0cml4W2ldW2NvbF0gPSB0ZDsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlZ01hdHJpeFtpXVtjb2xdID0gc2VnOw0KICAgICAgICAgICAgICAgICAgICAgICAgY29sKys7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgdHIuYXBwZW5kKHRkKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbXB0eUNlbGxzVW50aWwoY29sQ250KTsgLy8gZmluaXNoIG9mZiB0aGUgcm93DQogICAgICAgICAgICB0aGlzLmRheUdyaWQuYm9va2VuZENlbGxzKHRyKTsNCiAgICAgICAgICAgIHRib2R5LmFwcGVuZCh0cik7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgIHJvdzogcm93LA0KICAgICAgICAgICAgdGJvZHlFbDogdGJvZHksDQogICAgICAgICAgICBjZWxsTWF0cml4OiBjZWxsTWF0cml4LA0KICAgICAgICAgICAgc2VnTWF0cml4OiBzZWdNYXRyaXgsDQogICAgICAgICAgICBzZWdMZXZlbHM6IHNlZ0xldmVscywNCiAgICAgICAgICAgIHNlZ3M6IHJvd1NlZ3MNCiAgICAgICAgfTsNCiAgICB9Ow0KICAgIC8vIFN0YWNrcyBhIGZsYXQgYXJyYXkgb2Ygc2VnbWVudHMsIHdoaWNoIGFyZSBhbGwgYXNzdW1lZCB0byBiZSBpbiB0aGUgc2FtZSByb3csIGludG8gc3ViYXJyYXlzIG9mIHZlcnRpY2FsIGxldmVscy4NCiAgICAvLyBOT1RFOiBtb2RpZmllcyBzZWdzDQogICAgRGF5R3JpZEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLmJ1aWxkU2VnTGV2ZWxzID0gZnVuY3Rpb24gKHNlZ3MpIHsNCiAgICAgICAgdmFyIGxldmVscyA9IFtdOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgdmFyIHNlZzsNCiAgICAgICAgdmFyIGo7DQogICAgICAgIC8vIEdpdmUgcHJlZmVyZW5jZSB0byBlbGVtZW50cyB3aXRoIGNlcnRhaW4gY3JpdGVyaWEsIHNvIHRoZXkgaGF2ZQ0KICAgICAgICAvLyBhIGNoYW5jZSB0byBiZSBjbG9zZXIgdG8gdGhlIHRvcC4NCiAgICAgICAgdGhpcy5zb3J0RXZlbnRTZWdzKHNlZ3MpOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2Vncy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgc2VnID0gc2Vnc1tpXTsNCiAgICAgICAgICAgIC8vIGxvb3AgdGhyb3VnaCBsZXZlbHMsIHN0YXJ0aW5nIHdpdGggdGhlIHRvcG1vc3QsIHVudGlsIHRoZSBzZWdtZW50IGRvZXNuJ3QgY29sbGlkZSB3aXRoIG90aGVyIHNlZ21lbnRzDQogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbGV2ZWxzLmxlbmd0aDsgaisrKSB7DQogICAgICAgICAgICAgICAgaWYgKCFpc0RheVNlZ0NvbGxpc2lvbihzZWcsIGxldmVsc1tqXSkpIHsNCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgLy8gYGpgIG5vdyBob2xkcyB0aGUgZGVzaXJlZCBzdWJyb3cgaW5kZXgNCiAgICAgICAgICAgIHNlZy5sZXZlbCA9IGo7DQogICAgICAgICAgICAvLyBjcmVhdGUgbmV3IGxldmVsIGFycmF5IGlmIG5lZWRlZCBhbmQgYXBwZW5kIHNlZ21lbnQNCiAgICAgICAgICAgIChsZXZlbHNbal0gfHwgKGxldmVsc1tqXSA9IFtdKSkucHVzaChzZWcpOw0KICAgICAgICB9DQogICAgICAgIC8vIG9yZGVyIHNlZ21lbnRzIGxlZnQtdG8tcmlnaHQuIHZlcnkgaW1wb3J0YW50IGlmIGNhbGVuZGFyIGlzIFJUTA0KICAgICAgICBmb3IgKGogPSAwOyBqIDwgbGV2ZWxzLmxlbmd0aDsgaisrKSB7DQogICAgICAgICAgICBsZXZlbHNbal0uc29ydChjb21wYXJlRGF5U2VnQ29scyk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGxldmVsczsNCiAgICB9Ow0KICAgIC8vIEdpdmVuIGEgZmxhdCBhcnJheSBvZiBzZWdtZW50cywgcmV0dXJuIGFuIGFycmF5IG9mIHN1Yi1hcnJheXMsIGdyb3VwZWQgYnkgZWFjaCBzZWdtZW50J3Mgcm93DQogICAgRGF5R3JpZEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLmdyb3VwU2VnUm93cyA9IGZ1bmN0aW9uIChzZWdzKSB7DQogICAgICAgIHZhciBzZWdSb3dzID0gW107DQogICAgICAgIHZhciBpOw0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5kYXlHcmlkLnJvd0NudDsgaSsrKSB7DQogICAgICAgICAgICBzZWdSb3dzLnB1c2goW10pOw0KICAgICAgICB9DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZWdzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBzZWdSb3dzW3NlZ3NbaV0ucm93XS5wdXNoKHNlZ3NbaV0pOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBzZWdSb3dzOw0KICAgIH07DQogICAgLy8gQ29tcHV0ZXMgYSBkZWZhdWx0IGV2ZW50IHRpbWUgZm9ybWF0dGluZyBzdHJpbmcgaWYgYHRpbWVGb3JtYXRgIGlzIG5vdCBleHBsaWNpdGx5IGRlZmluZWQNCiAgICBEYXlHcmlkRXZlbnRSZW5kZXJlci5wcm90b3R5cGUuY29tcHV0ZUV2ZW50VGltZUZvcm1hdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMub3B0KCdleHRyYVNtYWxsVGltZUZvcm1hdCcpOyAvLyBsaWtlICI2cCIgb3IgIjY6MzBwIg0KICAgIH07DQogICAgLy8gQ29tcHV0ZXMgYSBkZWZhdWx0IGBkaXNwbGF5RXZlbnRFbmRgIHZhbHVlIGlmIG9uZSBpcyBub3QgZXhwbGljbHR5IGRlZmluZWQNCiAgICBEYXlHcmlkRXZlbnRSZW5kZXJlci5wcm90b3R5cGUuY29tcHV0ZURpc3BsYXlFdmVudEVuZCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZGF5R3JpZC5jb2xDbnQgPT09IDE7IC8vIHdlJ2xsIGxpa2VseSBoYXZlIHNwYWNlIGlmIHRoZXJlJ3Mgb25seSBvbmUgZGF5DQogICAgfTsNCiAgICAvLyBCdWlsZHMgdGhlIEhUTUwgdG8gYmUgdXNlZCBmb3IgdGhlIGRlZmF1bHQgZWxlbWVudCBmb3IgYW4gaW5kaXZpZHVhbCBzZWdtZW50DQogICAgRGF5R3JpZEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLmZnU2VnSHRtbCA9IGZ1bmN0aW9uIChzZWcsIGRpc2FibGVSZXNpemluZykgew0KICAgICAgICB2YXIgdmlldyA9IHRoaXMudmlldzsNCiAgICAgICAgdmFyIGV2ZW50RGVmID0gc2VnLmZvb3RwcmludC5ldmVudERlZjsNCiAgICAgICAgdmFyIGlzQWxsRGF5ID0gc2VnLmZvb3RwcmludC5jb21wb25lbnRGb290cHJpbnQuaXNBbGxEYXk7DQogICAgICAgIHZhciBpc0RyYWdnYWJsZSA9IHZpZXcuaXNFdmVudERlZkRyYWdnYWJsZShldmVudERlZik7DQogICAgICAgIHZhciBpc1Jlc2l6YWJsZUZyb21TdGFydCA9ICFkaXNhYmxlUmVzaXppbmcgJiYgaXNBbGxEYXkgJiYNCiAgICAgICAgICAgIHNlZy5pc1N0YXJ0ICYmIHZpZXcuaXNFdmVudERlZlJlc2l6YWJsZUZyb21TdGFydChldmVudERlZik7DQogICAgICAgIHZhciBpc1Jlc2l6YWJsZUZyb21FbmQgPSAhZGlzYWJsZVJlc2l6aW5nICYmIGlzQWxsRGF5ICYmDQogICAgICAgICAgICBzZWcuaXNFbmQgJiYgdmlldy5pc0V2ZW50RGVmUmVzaXphYmxlRnJvbUVuZChldmVudERlZik7DQogICAgICAgIHZhciBjbGFzc2VzID0gdGhpcy5nZXRTZWdDbGFzc2VzKHNlZywgaXNEcmFnZ2FibGUsIGlzUmVzaXphYmxlRnJvbVN0YXJ0IHx8IGlzUmVzaXphYmxlRnJvbUVuZCk7DQogICAgICAgIHZhciBza2luQ3NzID0gdXRpbF8xLmNzc1RvU3RyKHRoaXMuZ2V0U2tpbkNzcyhldmVudERlZikpOw0KICAgICAgICB2YXIgdGltZUh0bWwgPSAnJzsNCiAgICAgICAgdmFyIHRpbWVUZXh0Ow0KICAgICAgICB2YXIgdGl0bGVIdG1sOw0KICAgICAgICBjbGFzc2VzLnVuc2hpZnQoJ2ZjLWRheS1ncmlkLWV2ZW50JywgJ2ZjLWgtZXZlbnQnKTsNCiAgICAgICAgLy8gT25seSBkaXNwbGF5IGEgdGltZWQgZXZlbnRzIHRpbWUgaWYgaXQgaXMgdGhlIHN0YXJ0aW5nIHNlZ21lbnQNCiAgICAgICAgaWYgKHNlZy5pc1N0YXJ0KSB7DQogICAgICAgICAgICB0aW1lVGV4dCA9IHRoaXMuZ2V0VGltZVRleHQoc2VnLmZvb3RwcmludCk7DQogICAgICAgICAgICBpZiAodGltZVRleHQpIHsNCiAgICAgICAgICAgICAgICB0aW1lSHRtbCA9ICc8c3BhbiBjbGFzcz0iZmMtdGltZSI+JyArIHV0aWxfMS5odG1sRXNjYXBlKHRpbWVUZXh0KSArICc8L3NwYW4+JzsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICB0aXRsZUh0bWwgPQ0KICAgICAgICAgICAgJzxzcGFuIGNsYXNzPSJmYy10aXRsZSI+JyArDQogICAgICAgICAgICAgICAgKHV0aWxfMS5odG1sRXNjYXBlKGV2ZW50RGVmLnRpdGxlIHx8ICcnKSB8fCAnJm5ic3A7JykgKyAvLyB3ZSBhbHdheXMgd2FudCBvbmUgbGluZSBvZiBoZWlnaHQNCiAgICAgICAgICAgICAgICAnPC9zcGFuPic7DQogICAgICAgIHJldHVybiAnPGEgY2xhc3M9IicgKyBjbGFzc2VzLmpvaW4oJyAnKSArICciJyArDQogICAgICAgICAgICAoZXZlbnREZWYudXJsID8NCiAgICAgICAgICAgICAgICAnIGhyZWY9IicgKyB1dGlsXzEuaHRtbEVzY2FwZShldmVudERlZi51cmwpICsgJyInIDoNCiAgICAgICAgICAgICAgICAnJykgKw0KICAgICAgICAgICAgKHNraW5Dc3MgPw0KICAgICAgICAgICAgICAgICcgc3R5bGU9IicgKyBza2luQ3NzICsgJyInIDoNCiAgICAgICAgICAgICAgICAnJykgKw0KICAgICAgICAgICAgJz4nICsNCiAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJmYy1jb250ZW50Ij4nICsNCiAgICAgICAgICAgICh0aGlzLmRheUdyaWQuaXNSVEwgPw0KICAgICAgICAgICAgICAgIHRpdGxlSHRtbCArICcgJyArIHRpbWVIdG1sIDogLy8gcHV0IGEgbmF0dXJhbCBzcGFjZSBpbiBiZXR3ZWVuDQogICAgICAgICAgICAgICAgdGltZUh0bWwgKyAnICcgKyB0aXRsZUh0bWwgLy8NCiAgICAgICAgICAgICkgKw0KICAgICAgICAgICAgJzwvZGl2PicgKw0KICAgICAgICAgICAgKGlzUmVzaXphYmxlRnJvbVN0YXJ0ID8NCiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iZmMtcmVzaXplciBmYy1zdGFydC1yZXNpemVyIiAvPicgOg0KICAgICAgICAgICAgICAgICcnKSArDQogICAgICAgICAgICAoaXNSZXNpemFibGVGcm9tRW5kID8NCiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iZmMtcmVzaXplciBmYy1lbmQtcmVzaXplciIgLz4nIDoNCiAgICAgICAgICAgICAgICAnJykgKw0KICAgICAgICAgICAgJzwvYT4nOw0KICAgIH07DQogICAgcmV0dXJuIERheUdyaWRFdmVudFJlbmRlcmVyOw0KfShFdmVudFJlbmRlcmVyXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gRGF5R3JpZEV2ZW50UmVuZGVyZXI7DQovLyBDb21wdXRlcyB3aGV0aGVyIHR3byBzZWdtZW50cycgY29sdW1ucyBjb2xsaWRlLiBUaGV5IGFyZSBhc3N1bWVkIHRvIGJlIGluIHRoZSBzYW1lIHJvdy4NCmZ1bmN0aW9uIGlzRGF5U2VnQ29sbGlzaW9uKHNlZywgb3RoZXJTZWdzKSB7DQogICAgdmFyIGk7DQogICAgdmFyIG90aGVyU2VnOw0KICAgIGZvciAoaSA9IDA7IGkgPCBvdGhlclNlZ3MubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgb3RoZXJTZWcgPSBvdGhlclNlZ3NbaV07DQogICAgICAgIGlmIChvdGhlclNlZy5sZWZ0Q29sIDw9IHNlZy5yaWdodENvbCAmJg0KICAgICAgICAgICAgb3RoZXJTZWcucmlnaHRDb2wgPj0gc2VnLmxlZnRDb2wpIHsNCiAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9DQogICAgfQ0KICAgIHJldHVybiBmYWxzZTsNCn0NCi8vIEEgY21wIGZ1bmN0aW9uIGZvciBkZXRlcm1pbmluZyB0aGUgbGVmdG1vc3QgZXZlbnQNCmZ1bmN0aW9uIGNvbXBhcmVEYXlTZWdDb2xzKGEsIGIpIHsNCiAgICByZXR1cm4gYS5sZWZ0Q29sIC0gYi5sZWZ0Q29sOw0KfQ0KCgovKioqLyB9KSwKLyogMjUxICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdHNsaWJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgSGVscGVyUmVuZGVyZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNTgpOw0KdmFyIERheUdyaWRIZWxwZXJSZW5kZXJlciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHsNCiAgICB0c2xpYl8xLl9fZXh0ZW5kcyhEYXlHcmlkSGVscGVyUmVuZGVyZXIsIF9zdXBlcik7DQogICAgZnVuY3Rpb24gRGF5R3JpZEhlbHBlclJlbmRlcmVyKCkgew0KICAgICAgICByZXR1cm4gX3N1cGVyICE9PSBudWxsICYmIF9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7DQogICAgfQ0KICAgIC8vIFJlbmRlcnMgYSBtb2NrICJoZWxwZXIiIGV2ZW50LiBgc291cmNlU2VnYCBpcyB0aGUgYXNzb2NpYXRlZCBpbnRlcm5hbCBzZWdtZW50IG9iamVjdC4gSXQgY2FuIGJlIG51bGwuDQogICAgRGF5R3JpZEhlbHBlclJlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJTZWdzID0gZnVuY3Rpb24gKHNlZ3MsIHNvdXJjZVNlZykgew0KICAgICAgICB2YXIgaGVscGVyTm9kZXMgPSBbXTsNCiAgICAgICAgdmFyIHJvd1N0cnVjdHM7DQogICAgICAgIC8vIFRPRE86IG5vdCBnb29kIHRvIGNhbGwgZXZlbnRSZW5kZXJlciB0aGlzIHdheQ0KICAgICAgICByb3dTdHJ1Y3RzID0gdGhpcy5ldmVudFJlbmRlcmVyLnJlbmRlclNlZ1Jvd3Moc2Vncyk7DQogICAgICAgIC8vIGluamVjdCBlYWNoIG5ldyBldmVudCBza2VsZXRvbiBpbnRvIGVhY2ggYXNzb2NpYXRlZCByb3cNCiAgICAgICAgdGhpcy5jb21wb25lbnQucm93RWxzLmVhY2goZnVuY3Rpb24gKHJvdywgcm93Tm9kZSkgew0KICAgICAgICAgICAgdmFyIHJvd0VsID0gJChyb3dOb2RlKTsgLy8gdGhlIC5mYy1yb3cNCiAgICAgICAgICAgIHZhciBza2VsZXRvbkVsID0gJCgnPGRpdiBjbGFzcz0iZmMtaGVscGVyLXNrZWxldG9uIj48dGFibGUvPjwvZGl2PicpOyAvLyB3aWxsIGJlIGFic29sdXRlbHkgcG9zaXRpb25lZA0KICAgICAgICAgICAgdmFyIHNrZWxldG9uVG9wRWw7DQogICAgICAgICAgICB2YXIgc2tlbGV0b25Ub3A7DQogICAgICAgICAgICAvLyBJZiB0aGVyZSBpcyBhbiBvcmlnaW5hbCBzZWdtZW50LCBtYXRjaCB0aGUgdG9wIHBvc2l0aW9uLiBPdGhlcndpc2UsIHB1dCBpdCBhdCB0aGUgcm93J3MgdG9wIGxldmVsDQogICAgICAgICAgICBpZiAoc291cmNlU2VnICYmIHNvdXJjZVNlZy5yb3cgPT09IHJvdykgew0KICAgICAgICAgICAgICAgIHNrZWxldG9uVG9wID0gc291cmNlU2VnLmVsLnBvc2l0aW9uKCkudG9wOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgc2tlbGV0b25Ub3BFbCA9IHJvd0VsLmZpbmQoJy5mYy1jb250ZW50LXNrZWxldG9uIHRib2R5Jyk7DQogICAgICAgICAgICAgICAgaWYgKCFza2VsZXRvblRvcEVsLmxlbmd0aCkgew0KICAgICAgICAgICAgICAgICAgICBza2VsZXRvblRvcEVsID0gcm93RWwuZmluZCgnLmZjLWNvbnRlbnQtc2tlbGV0b24gdGFibGUnKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgc2tlbGV0b25Ub3AgPSBza2VsZXRvblRvcEVsLnBvc2l0aW9uKCkudG9wOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgc2tlbGV0b25FbC5jc3MoJ3RvcCcsIHNrZWxldG9uVG9wKQ0KICAgICAgICAgICAgICAgIC5maW5kKCd0YWJsZScpDQogICAgICAgICAgICAgICAgLmFwcGVuZChyb3dTdHJ1Y3RzW3Jvd10udGJvZHlFbCk7DQogICAgICAgICAgICByb3dFbC5hcHBlbmQoc2tlbGV0b25FbCk7DQogICAgICAgICAgICBoZWxwZXJOb2Rlcy5wdXNoKHNrZWxldG9uRWxbMF0pOw0KICAgICAgICB9KTsNCiAgICAgICAgcmV0dXJuICQoaGVscGVyTm9kZXMpOyAvLyBtdXN0IHJldHVybiB0aGUgZWxlbWVudHMgcmVuZGVyZWQNCiAgICB9Ow0KICAgIHJldHVybiBEYXlHcmlkSGVscGVyUmVuZGVyZXI7DQp9KEhlbHBlclJlbmRlcmVyXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gRGF5R3JpZEhlbHBlclJlbmRlcmVyOw0KCgovKioqLyB9KSwKLyogMjUyICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQp2YXIgdHNsaWJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMik7DQp2YXIgJCA9IF9fd2VicGFja19yZXF1aXJlX18oMyk7DQp2YXIgRmlsbFJlbmRlcmVyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDU3KTsNCnZhciBEYXlHcmlkRmlsbFJlbmRlcmVyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKERheUdyaWRGaWxsUmVuZGVyZXIsIF9zdXBlcik7DQogICAgZnVuY3Rpb24gRGF5R3JpZEZpbGxSZW5kZXJlcigpIHsNCiAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyICE9PSBudWxsICYmIF9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7DQogICAgICAgIF90aGlzLmZpbGxTZWdUYWcgPSAndGQnOyAvLyBvdmVycmlkZSB0aGUgZGVmYXVsdCB0YWcgbmFtZQ0KICAgICAgICByZXR1cm4gX3RoaXM7DQogICAgfQ0KICAgIERheUdyaWRGaWxsUmVuZGVyZXIucHJvdG90eXBlLmF0dGFjaFNlZ0VscyA9IGZ1bmN0aW9uICh0eXBlLCBzZWdzKSB7DQogICAgICAgIHZhciBub2RlcyA9IFtdOw0KICAgICAgICB2YXIgaTsNCiAgICAgICAgdmFyIHNlZzsNCiAgICAgICAgdmFyIHNrZWxldG9uRWw7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZWdzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICBzZWcgPSBzZWdzW2ldOw0KICAgICAgICAgICAgc2tlbGV0b25FbCA9IHRoaXMucmVuZGVyRmlsbFJvdyh0eXBlLCBzZWcpOw0KICAgICAgICAgICAgdGhpcy5jb21wb25lbnQucm93RWxzLmVxKHNlZy5yb3cpLmFwcGVuZChza2VsZXRvbkVsKTsNCiAgICAgICAgICAgIG5vZGVzLnB1c2goc2tlbGV0b25FbFswXSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIG5vZGVzOw0KICAgIH07DQogICAgLy8gR2VuZXJhdGVzIHRoZSBIVE1MIG5lZWRlZCBmb3Igb25lIHJvdyBvZiBhIGZpbGwuIFJlcXVpcmVzIHRoZSBzZWcncyBlbCB0byBiZSByZW5kZXJlZC4NCiAgICBEYXlHcmlkRmlsbFJlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJGaWxsUm93ID0gZnVuY3Rpb24gKHR5cGUsIHNlZykgew0KICAgICAgICB2YXIgY29sQ250ID0gdGhpcy5jb21wb25lbnQuY29sQ250Ow0KICAgICAgICB2YXIgc3RhcnRDb2wgPSBzZWcubGVmdENvbDsNCiAgICAgICAgdmFyIGVuZENvbCA9IHNlZy5yaWdodENvbCArIDE7DQogICAgICAgIHZhciBjbGFzc05hbWU7DQogICAgICAgIHZhciBza2VsZXRvbkVsOw0KICAgICAgICB2YXIgdHJFbDsNCiAgICAgICAgaWYgKHR5cGUgPT09ICdidXNpbmVzc0hvdXJzJykgew0KICAgICAgICAgICAgY2xhc3NOYW1lID0gJ2JnZXZlbnQnOw0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgY2xhc3NOYW1lID0gdHlwZS50b0xvd2VyQ2FzZSgpOw0KICAgICAgICB9DQogICAgICAgIHNrZWxldG9uRWwgPSAkKCc8ZGl2IGNsYXNzPSJmYy0nICsgY2xhc3NOYW1lICsgJy1za2VsZXRvbiI+JyArDQogICAgICAgICAgICAnPHRhYmxlPjx0ci8+PC90YWJsZT4nICsNCiAgICAgICAgICAgICc8L2Rpdj4nKTsNCiAgICAgICAgdHJFbCA9IHNrZWxldG9uRWwuZmluZCgndHInKTsNCiAgICAgICAgaWYgKHN0YXJ0Q29sID4gMCkgew0KICAgICAgICAgICAgdHJFbC5hcHBlbmQoJzx0ZCBjb2xzcGFuPSInICsgc3RhcnRDb2wgKyAnIi8+Jyk7DQogICAgICAgIH0NCiAgICAgICAgdHJFbC5hcHBlbmQoc2VnLmVsLmF0dHIoJ2NvbHNwYW4nLCBlbmRDb2wgLSBzdGFydENvbCkpOw0KICAgICAgICBpZiAoZW5kQ29sIDwgY29sQ250KSB7DQogICAgICAgICAgICB0ckVsLmFwcGVuZCgnPHRkIGNvbHNwYW49IicgKyAoY29sQ250IC0gZW5kQ29sKSArICciLz4nKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLmNvbXBvbmVudC5ib29rZW5kQ2VsbHModHJFbCk7DQogICAgICAgIHJldHVybiBza2VsZXRvbkVsOw0KICAgIH07DQogICAgcmV0dXJuIERheUdyaWRGaWxsUmVuZGVyZXI7DQp9KEZpbGxSZW5kZXJlcl8xLmRlZmF1bHQpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IERheUdyaWRGaWxsUmVuZGVyZXI7DQoKCi8qKiovIH0pLAovKiAyNTMgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciBCYXNpY1ZpZXdEYXRlUHJvZmlsZUdlbmVyYXRvcl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMjgpOw0KdmFyIFVuem9uZWRSYW5nZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1KTsNCnZhciBNb250aFZpZXdEYXRlUHJvZmlsZUdlbmVyYXRvciA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uIChfc3VwZXIpIHsNCiAgICB0c2xpYl8xLl9fZXh0ZW5kcyhNb250aFZpZXdEYXRlUHJvZmlsZUdlbmVyYXRvciwgX3N1cGVyKTsNCiAgICBmdW5jdGlvbiBNb250aFZpZXdEYXRlUHJvZmlsZUdlbmVyYXRvcigpIHsNCiAgICAgICAgcmV0dXJuIF9zdXBlciAhPT0gbnVsbCAmJiBfc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOw0KICAgIH0NCiAgICAvLyBDb21wdXRlcyB0aGUgZGF0ZSByYW5nZSB0aGF0IHdpbGwgYmUgcmVuZGVyZWQuDQogICAgTW9udGhWaWV3RGF0ZVByb2ZpbGVHZW5lcmF0b3IucHJvdG90eXBlLmJ1aWxkUmVuZGVyUmFuZ2UgPSBmdW5jdGlvbiAoY3VycmVudFVuem9uZWRSYW5nZSwgY3VycmVudFJhbmdlVW5pdCwgaXNSYW5nZUFsbERheSkgew0KICAgICAgICB2YXIgcmVuZGVyVW56b25lZFJhbmdlID0gX3N1cGVyLnByb3RvdHlwZS5idWlsZFJlbmRlclJhbmdlLmNhbGwodGhpcywgY3VycmVudFVuem9uZWRSYW5nZSwgY3VycmVudFJhbmdlVW5pdCwgaXNSYW5nZUFsbERheSk7DQogICAgICAgIHZhciBzdGFydCA9IHRoaXMubXNUb1V0Y01vbWVudChyZW5kZXJVbnpvbmVkUmFuZ2Uuc3RhcnRNcywgaXNSYW5nZUFsbERheSk7DQogICAgICAgIHZhciBlbmQgPSB0aGlzLm1zVG9VdGNNb21lbnQocmVuZGVyVW56b25lZFJhbmdlLmVuZE1zLCBpc1JhbmdlQWxsRGF5KTsNCiAgICAgICAgdmFyIHJvd0NudDsNCiAgICAgICAgLy8gZW5zdXJlIDYgd2Vla3MNCiAgICAgICAgaWYgKHRoaXMub3B0KCdmaXhlZFdlZWtDb3VudCcpKSB7DQogICAgICAgICAgICByb3dDbnQgPSBNYXRoLmNlaWwoLy8gY291bGQgYmUgcGFydGlhbCB3ZWVrcyBkdWUgdG8gaGlkZGVuRGF5cw0KICAgICAgICAgICAgZW5kLmRpZmYoc3RhcnQsICd3ZWVrcycsIHRydWUpIC8vIGRvbnRSb3VuZD10cnVlDQogICAgICAgICAgICApOw0KICAgICAgICAgICAgZW5kLmFkZCg2IC0gcm93Q250LCAnd2Vla3MnKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gbmV3IFVuem9uZWRSYW5nZV8xLmRlZmF1bHQoc3RhcnQsIGVuZCk7DQogICAgfTsNCiAgICByZXR1cm4gTW9udGhWaWV3RGF0ZVByb2ZpbGVHZW5lcmF0b3I7DQp9KEJhc2ljVmlld0RhdGVQcm9maWxlR2VuZXJhdG9yXzEuZGVmYXVsdCkpOw0KZXhwb3J0cy5kZWZhdWx0ID0gTW9udGhWaWV3RGF0ZVByb2ZpbGVHZW5lcmF0b3I7DQoKCi8qKiovIH0pLAovKiAyNTQgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciB1dGlsXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDQpOw0KdmFyIEV2ZW50UmVuZGVyZXJfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNDIpOw0KdmFyIExpc3RFdmVudFJlbmRlcmVyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKExpc3RFdmVudFJlbmRlcmVyLCBfc3VwZXIpOw0KICAgIGZ1bmN0aW9uIExpc3RFdmVudFJlbmRlcmVyKCkgew0KICAgICAgICByZXR1cm4gX3N1cGVyICE9PSBudWxsICYmIF9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7DQogICAgfQ0KICAgIExpc3RFdmVudFJlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJGZ1NlZ3MgPSBmdW5jdGlvbiAoc2Vncykgew0KICAgICAgICBpZiAoIXNlZ3MubGVuZ3RoKSB7DQogICAgICAgICAgICB0aGlzLmNvbXBvbmVudC5yZW5kZXJFbXB0eU1lc3NhZ2UoKTsNCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIHRoaXMuY29tcG9uZW50LnJlbmRlclNlZ0xpc3Qoc2Vncyk7DQogICAgICAgIH0NCiAgICB9Ow0KICAgIC8vIGdlbmVyYXRlcyB0aGUgSFRNTCBmb3IgYSBzaW5nbGUgZXZlbnQgcm93DQogICAgTGlzdEV2ZW50UmVuZGVyZXIucHJvdG90eXBlLmZnU2VnSHRtbCA9IGZ1bmN0aW9uIChzZWcpIHsNCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLnZpZXc7DQogICAgICAgIHZhciBjYWxlbmRhciA9IHZpZXcuY2FsZW5kYXI7DQogICAgICAgIHZhciB0aGVtZSA9IGNhbGVuZGFyLnRoZW1lOw0KICAgICAgICB2YXIgZXZlbnRGb290cHJpbnQgPSBzZWcuZm9vdHByaW50Ow0KICAgICAgICB2YXIgZXZlbnREZWYgPSBldmVudEZvb3RwcmludC5ldmVudERlZjsNCiAgICAgICAgdmFyIGNvbXBvbmVudEZvb3RwcmludCA9IGV2ZW50Rm9vdHByaW50LmNvbXBvbmVudEZvb3RwcmludDsNCiAgICAgICAgdmFyIHVybCA9IGV2ZW50RGVmLnVybDsNCiAgICAgICAgdmFyIGNsYXNzZXMgPSBbJ2ZjLWxpc3QtaXRlbSddLmNvbmNhdCh0aGlzLmdldENsYXNzZXMoZXZlbnREZWYpKTsNCiAgICAgICAgdmFyIGJnQ29sb3IgPSB0aGlzLmdldEJnQ29sb3IoZXZlbnREZWYpOw0KICAgICAgICB2YXIgdGltZUh0bWw7DQogICAgICAgIGlmIChjb21wb25lbnRGb290cHJpbnQuaXNBbGxEYXkpIHsNCiAgICAgICAgICAgIHRpbWVIdG1sID0gdmlldy5nZXRBbGxEYXlIdG1sKCk7DQogICAgICAgIH0NCiAgICAgICAgZWxzZSBpZiAodmlldy5pc011bHRpRGF5UmFuZ2UoY29tcG9uZW50Rm9vdHByaW50LnVuem9uZWRSYW5nZSkpIHsNCiAgICAgICAgICAgIGlmIChzZWcuaXNTdGFydCB8fCBzZWcuaXNFbmQpIHsNCiAgICAgICAgICAgICAgICB0aW1lSHRtbCA9IHV0aWxfMS5odG1sRXNjYXBlKHRoaXMuX2dldFRpbWVUZXh0KGNhbGVuZGFyLm1zVG9Nb21lbnQoc2VnLnN0YXJ0TXMpLCBjYWxlbmRhci5tc1RvTW9tZW50KHNlZy5lbmRNcyksIGNvbXBvbmVudEZvb3RwcmludC5pc0FsbERheSkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgdGltZUh0bWwgPSB2aWV3LmdldEFsbERheUh0bWwoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgIC8vIERpc3BsYXkgdGhlIG5vcm1hbCB0aW1lIHRleHQgZm9yIHRoZSAqZXZlbnQncyogdGltZXMNCiAgICAgICAgICAgIHRpbWVIdG1sID0gdXRpbF8xLmh0bWxFc2NhcGUodGhpcy5nZXRUaW1lVGV4dChldmVudEZvb3RwcmludCkpOw0KICAgICAgICB9DQogICAgICAgIGlmICh1cmwpIHsNCiAgICAgICAgICAgIGNsYXNzZXMucHVzaCgnZmMtaGFzLXVybCcpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiAnPHRyIGNsYXNzPSInICsgY2xhc3Nlcy5qb2luKCcgJykgKyAnIj4nICsNCiAgICAgICAgICAgICh0aGlzLmRpc3BsYXlFdmVudFRpbWUgPw0KICAgICAgICAgICAgICAgICc8dGQgY2xhc3M9ImZjLWxpc3QtaXRlbS10aW1lICcgKyB0aGVtZS5nZXRDbGFzcygnd2lkZ2V0Q29udGVudCcpICsgJyI+JyArDQogICAgICAgICAgICAgICAgICAgICh0aW1lSHRtbCB8fCAnJykgKw0KICAgICAgICAgICAgICAgICAgICAnPC90ZD4nIDoNCiAgICAgICAgICAgICAgICAnJykgKw0KICAgICAgICAgICAgJzx0ZCBjbGFzcz0iZmMtbGlzdC1pdGVtLW1hcmtlciAnICsgdGhlbWUuZ2V0Q2xhc3MoJ3dpZGdldENvbnRlbnQnKSArICciPicgKw0KICAgICAgICAgICAgJzxzcGFuIGNsYXNzPSJmYy1ldmVudC1kb3QiJyArDQogICAgICAgICAgICAoYmdDb2xvciA/DQogICAgICAgICAgICAgICAgJyBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjonICsgYmdDb2xvciArICciJyA6DQogICAgICAgICAgICAgICAgJycpICsNCiAgICAgICAgICAgICc+PC9zcGFuPicgKw0KICAgICAgICAgICAgJzwvdGQ+JyArDQogICAgICAgICAgICAnPHRkIGNsYXNzPSJmYy1saXN0LWl0ZW0tdGl0bGUgJyArIHRoZW1lLmdldENsYXNzKCd3aWRnZXRDb250ZW50JykgKyAnIj4nICsNCiAgICAgICAgICAgICc8YScgKyAodXJsID8gJyBocmVmPSInICsgdXRpbF8xLmh0bWxFc2NhcGUodXJsKSArICciJyA6ICcnKSArICc+JyArDQogICAgICAgICAgICB1dGlsXzEuaHRtbEVzY2FwZShldmVudERlZi50aXRsZSB8fCAnJykgKw0KICAgICAgICAgICAgJzwvYT4nICsNCiAgICAgICAgICAgICc8L3RkPicgKw0KICAgICAgICAgICAgJzwvdHI+JzsNCiAgICB9Ow0KICAgIC8vIGxpa2UgIjQ6MDBhbSINCiAgICBMaXN0RXZlbnRSZW5kZXJlci5wcm90b3R5cGUuY29tcHV0ZUV2ZW50VGltZUZvcm1hdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMub3B0KCdtZWRpdW1UaW1lRm9ybWF0Jyk7DQogICAgfTsNCiAgICByZXR1cm4gTGlzdEV2ZW50UmVuZGVyZXI7DQp9KEV2ZW50UmVuZGVyZXJfMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBMaXN0RXZlbnRSZW5kZXJlcjsNCgoKLyoqKi8gfSksCi8qIDI1NSAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIHRzbGliXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIpOw0KdmFyICQgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOw0KdmFyIEV2ZW50UG9pbnRpbmdfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNTkpOw0KdmFyIExpc3RFdmVudFBvaW50aW5nID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKF9zdXBlcikgew0KICAgIHRzbGliXzEuX19leHRlbmRzKExpc3RFdmVudFBvaW50aW5nLCBfc3VwZXIpOw0KICAgIGZ1bmN0aW9uIExpc3RFdmVudFBvaW50aW5nKCkgew0KICAgICAgICByZXR1cm4gX3N1cGVyICE9PSBudWxsICYmIF9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIHx8IHRoaXM7DQogICAgfQ0KICAgIC8vIGZvciBldmVudHMgd2l0aCBhIHVybCwgdGhlIHdob2xlIDx0cj4gc2hvdWxkIGJlIGNsaWNrYWJsZSwNCiAgICAvLyBidXQgaXQncyBpbXBvc3NpYmxlIHRvIHdyYXAgd2l0aCBhbiA8YT4gdGFnLiBzaW11bGF0ZSB0aGlzLg0KICAgIExpc3RFdmVudFBvaW50aW5nLnByb3RvdHlwZS5oYW5kbGVDbGljayA9IGZ1bmN0aW9uIChzZWcsIGV2KSB7DQogICAgICAgIHZhciB1cmw7DQogICAgICAgIF9zdXBlci5wcm90b3R5cGUuaGFuZGxlQ2xpY2suY2FsbCh0aGlzLCBzZWcsIGV2KTsgLy8gbWlnaHQgcHJldmVudCB0aGUgZGVmYXVsdCBhY3Rpb24NCiAgICAgICAgLy8gbm90IGNsaWNraW5nIG9uIG9yIHdpdGhpbiBhbiA8YT4gd2l0aCBhbiBocmVmDQogICAgICAgIGlmICghJChldi50YXJnZXQpLmNsb3Nlc3QoJ2FbaHJlZl0nKS5sZW5ndGgpIHsNCiAgICAgICAgICAgIHVybCA9IHNlZy5mb290cHJpbnQuZXZlbnREZWYudXJsOw0KICAgICAgICAgICAgaWYgKHVybCAmJiAhZXYuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsNCiAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IHVybDsgLy8gc2ltdWxhdGUgbGluayBjbGljaw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfTsNCiAgICByZXR1cm4gTGlzdEV2ZW50UG9pbnRpbmc7DQp9KEV2ZW50UG9pbnRpbmdfMS5kZWZhdWx0KSk7DQpleHBvcnRzLmRlZmF1bHQgPSBMaXN0RXZlbnRQb2ludGluZzsNCgoKLyoqKi8gfSksCi8qIDI1NiAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIEV2ZW50U291cmNlUGFyc2VyXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDM3KTsNCnZhciBBcnJheUV2ZW50U291cmNlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUyKTsNCnZhciBGdW5jRXZlbnRTb3VyY2VfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjE1KTsNCnZhciBKc29uRmVlZEV2ZW50U291cmNlXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIxNik7DQpFdmVudFNvdXJjZVBhcnNlcl8xLmRlZmF1bHQucmVnaXN0ZXJDbGFzcyhBcnJheUV2ZW50U291cmNlXzEuZGVmYXVsdCk7DQpFdmVudFNvdXJjZVBhcnNlcl8xLmRlZmF1bHQucmVnaXN0ZXJDbGFzcyhGdW5jRXZlbnRTb3VyY2VfMS5kZWZhdWx0KTsNCkV2ZW50U291cmNlUGFyc2VyXzEuZGVmYXVsdC5yZWdpc3RlckNsYXNzKEpzb25GZWVkRXZlbnRTb3VyY2VfMS5kZWZhdWx0KTsNCgoKLyoqKi8gfSksCi8qIDI1NyAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIFRoZW1lUmVnaXN0cnlfMSA9IF9fd2VicGFja19yZXF1aXJlX18oNTEpOw0KdmFyIFN0YW5kYXJkVGhlbWVfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjEzKTsNCnZhciBKcXVlcnlVaVRoZW1lXzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIxNCk7DQp2YXIgQm9vdHN0cmFwVGhlbWVfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjU4KTsNClRoZW1lUmVnaXN0cnlfMS5kZWZpbmVUaGVtZVN5c3RlbSgnc3RhbmRhcmQnLCBTdGFuZGFyZFRoZW1lXzEuZGVmYXVsdCk7DQpUaGVtZVJlZ2lzdHJ5XzEuZGVmaW5lVGhlbWVTeXN0ZW0oJ2pxdWVyeS11aScsIEpxdWVyeVVpVGhlbWVfMS5kZWZhdWx0KTsNClRoZW1lUmVnaXN0cnlfMS5kZWZpbmVUaGVtZVN5c3RlbSgnYm9vdHN0cmFwMycsIEJvb3RzdHJhcFRoZW1lXzEuZGVmYXVsdCk7DQoKCi8qKiovIH0pLAovKiAyNTggKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciB0c2xpYl8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCnZhciBUaGVtZV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygzOCk7DQp2YXIgQm9vdHN0cmFwVGhlbWUgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoX3N1cGVyKSB7DQogICAgdHNsaWJfMS5fX2V4dGVuZHMoQm9vdHN0cmFwVGhlbWUsIF9zdXBlcik7DQogICAgZnVuY3Rpb24gQm9vdHN0cmFwVGhlbWUoKSB7DQogICAgICAgIHJldHVybiBfc3VwZXIgIT09IG51bGwgJiYgX3N1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgdGhpczsNCiAgICB9DQogICAgcmV0dXJuIEJvb3RzdHJhcFRoZW1lOw0KfShUaGVtZV8xLmRlZmF1bHQpKTsNCmV4cG9ydHMuZGVmYXVsdCA9IEJvb3RzdHJhcFRoZW1lOw0KQm9vdHN0cmFwVGhlbWUucHJvdG90eXBlLmNsYXNzZXMgPSB7DQogICAgd2lkZ2V0OiAnZmMtYm9vdHN0cmFwMycsDQogICAgdGFibGVHcmlkOiAndGFibGUtYm9yZGVyZWQnLA0KICAgIHRhYmxlTGlzdDogJ3RhYmxlIHRhYmxlLXN0cmlwZWQnLA0KICAgIGJ1dHRvbkdyb3VwOiAnYnRuLWdyb3VwJywNCiAgICBidXR0b246ICdidG4gYnRuLWRlZmF1bHQnLA0KICAgIHN0YXRlQWN0aXZlOiAnYWN0aXZlJywNCiAgICBzdGF0ZURpc2FibGVkOiAnZGlzYWJsZWQnLA0KICAgIHRvZGF5OiAnYWxlcnQgYWxlcnQtaW5mbycsDQogICAgcG9wb3ZlcjogJ3BhbmVsIHBhbmVsLWRlZmF1bHQnLA0KICAgIHBvcG92ZXJIZWFkZXI6ICdwYW5lbC1oZWFkaW5nJywNCiAgICBwb3BvdmVyQ29udGVudDogJ3BhbmVsLWJvZHknLA0KICAgIC8vIGRheSBncmlkDQogICAgaGVhZGVyUm93OiAncGFuZWwtZGVmYXVsdCcsDQogICAgZGF5Um93OiAncGFuZWwtZGVmYXVsdCcsDQogICAgLy8gbGlzdCB2aWV3DQogICAgbGlzdFZpZXc6ICdwYW5lbCBwYW5lbC1kZWZhdWx0Jw0KfTsNCkJvb3RzdHJhcFRoZW1lLnByb3RvdHlwZS5iYXNlSWNvbkNsYXNzID0gJ2dseXBoaWNvbic7DQpCb290c3RyYXBUaGVtZS5wcm90b3R5cGUuaWNvbkNsYXNzZXMgPSB7DQogICAgY2xvc2U6ICdnbHlwaGljb24tcmVtb3ZlJywNCiAgICBwcmV2OiAnZ2x5cGhpY29uLWNoZXZyb24tbGVmdCcsDQogICAgbmV4dDogJ2dseXBoaWNvbi1jaGV2cm9uLXJpZ2h0JywNCiAgICBwcmV2WWVhcjogJ2dseXBoaWNvbi1iYWNrd2FyZCcsDQogICAgbmV4dFllYXI6ICdnbHlwaGljb24tZm9yd2FyZCcNCn07DQpCb290c3RyYXBUaGVtZS5wcm90b3R5cGUuaWNvbk92ZXJyaWRlT3B0aW9uID0gJ2Jvb3RzdHJhcEdseXBoaWNvbnMnOw0KQm9vdHN0cmFwVGhlbWUucHJvdG90eXBlLmljb25PdmVycmlkZUN1c3RvbUJ1dHRvbk9wdGlvbiA9ICdib290c3RyYXBHbHlwaGljb24nOw0KQm9vdHN0cmFwVGhlbWUucHJvdG90eXBlLmljb25PdmVycmlkZVByZWZpeCA9ICdnbHlwaGljb24tJzsNCgoKLyoqKi8gfSksCi8qIDI1OSAqLwovKioqLyAoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOw0KdmFyIFZpZXdSZWdpc3RyeV8xID0gX193ZWJwYWNrX3JlcXVpcmVfXygyMSk7DQp2YXIgQmFzaWNWaWV3XzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYyKTsNCnZhciBNb250aFZpZXdfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjI5KTsNClZpZXdSZWdpc3RyeV8xLmRlZmluZVZpZXcoJ2Jhc2ljJywgew0KICAgICdjbGFzcyc6IEJhc2ljVmlld18xLmRlZmF1bHQNCn0pOw0KVmlld1JlZ2lzdHJ5XzEuZGVmaW5lVmlldygnYmFzaWNEYXknLCB7DQogICAgdHlwZTogJ2Jhc2ljJywNCiAgICBkdXJhdGlvbjogeyBkYXlzOiAxIH0NCn0pOw0KVmlld1JlZ2lzdHJ5XzEuZGVmaW5lVmlldygnYmFzaWNXZWVrJywgew0KICAgIHR5cGU6ICdiYXNpYycsDQogICAgZHVyYXRpb246IHsgd2Vla3M6IDEgfQ0KfSk7DQpWaWV3UmVnaXN0cnlfMS5kZWZpbmVWaWV3KCdtb250aCcsIHsNCiAgICAnY2xhc3MnOiBNb250aFZpZXdfMS5kZWZhdWx0LA0KICAgIGR1cmF0aW9uOiB7IG1vbnRoczogMSB9LA0KICAgIGRlZmF1bHRzOiB7DQogICAgICAgIGZpeGVkV2Vla0NvdW50OiB0cnVlDQogICAgfQ0KfSk7DQoKCi8qKiovIH0pLAovKiAyNjAgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciBWaWV3UmVnaXN0cnlfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjEpOw0KdmFyIEFnZW5kYVZpZXdfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjI2KTsNClZpZXdSZWdpc3RyeV8xLmRlZmluZVZpZXcoJ2FnZW5kYScsIHsNCiAgICAnY2xhc3MnOiBBZ2VuZGFWaWV3XzEuZGVmYXVsdCwNCiAgICBkZWZhdWx0czogew0KICAgICAgICBhbGxEYXlTbG90OiB0cnVlLA0KICAgICAgICBzbG90RHVyYXRpb246ICcwMDozMDowMCcsDQogICAgICAgIHNsb3RFdmVudE92ZXJsYXA6IHRydWUgLy8gYSBiYWQgbmFtZS4gY29uZnVzZWQgd2l0aCBvdmVybGFwL2NvbnN0cmFpbnQgc3lzdGVtDQogICAgfQ0KfSk7DQpWaWV3UmVnaXN0cnlfMS5kZWZpbmVWaWV3KCdhZ2VuZGFEYXknLCB7DQogICAgdHlwZTogJ2FnZW5kYScsDQogICAgZHVyYXRpb246IHsgZGF5czogMSB9DQp9KTsNClZpZXdSZWdpc3RyeV8xLmRlZmluZVZpZXcoJ2FnZW5kYVdlZWsnLCB7DQogICAgdHlwZTogJ2FnZW5kYScsDQogICAgZHVyYXRpb246IHsgd2Vla3M6IDEgfQ0KfSk7DQoKCi8qKiovIH0pLAovKiAyNjEgKi8KLyoqKi8gKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsNCnZhciBWaWV3UmVnaXN0cnlfMSA9IF9fd2VicGFja19yZXF1aXJlX18oMjEpOw0KdmFyIExpc3RWaWV3XzEgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDIzMCk7DQpWaWV3UmVnaXN0cnlfMS5kZWZpbmVWaWV3KCdsaXN0Jywgew0KICAgICdjbGFzcyc6IExpc3RWaWV3XzEuZGVmYXVsdCwNCiAgICBidXR0b25UZXh0S2V5OiAnbGlzdCcsDQogICAgZGVmYXVsdHM6IHsNCiAgICAgICAgYnV0dG9uVGV4dDogJ2xpc3QnLA0KICAgICAgICBsaXN0RGF5Rm9ybWF0OiAnTEwnLA0KICAgICAgICBub0V2ZW50c01lc3NhZ2U6ICdObyBldmVudHMgdG8gZGlzcGxheScNCiAgICB9DQp9KTsNClZpZXdSZWdpc3RyeV8xLmRlZmluZVZpZXcoJ2xpc3REYXknLCB7DQogICAgdHlwZTogJ2xpc3QnLA0KICAgIGR1cmF0aW9uOiB7IGRheXM6IDEgfSwNCiAgICBkZWZhdWx0czogew0KICAgICAgICBsaXN0RGF5Rm9ybWF0OiAnZGRkZCcgLy8gZGF5LW9mLXdlZWsgaXMgYWxsIHdlIG5lZWQuIGZ1bGwgZGF0ZSBpcyBwcm9iYWJseSBpbiBoZWFkZXINCiAgICB9DQp9KTsNClZpZXdSZWdpc3RyeV8xLmRlZmluZVZpZXcoJ2xpc3RXZWVrJywgew0KICAgIHR5cGU6ICdsaXN0JywNCiAgICBkdXJhdGlvbjogeyB3ZWVrczogMSB9LA0KICAgIGRlZmF1bHRzOiB7DQogICAgICAgIGxpc3REYXlGb3JtYXQ6ICdkZGRkJywNCiAgICAgICAgbGlzdERheUFsdEZvcm1hdDogJ0xMJw0KICAgIH0NCn0pOw0KVmlld1JlZ2lzdHJ5XzEuZGVmaW5lVmlldygnbGlzdE1vbnRoJywgew0KICAgIHR5cGU6ICdsaXN0JywNCiAgICBkdXJhdGlvbjogeyBtb250aDogMSB9LA0KICAgIGRlZmF1bHRzOiB7DQogICAgICAgIGxpc3REYXlBbHRGb3JtYXQ6ICdkZGRkJyAvLyBkYXktb2Ytd2VlayBpcyBuaWNlLXRvLWhhdmUNCiAgICB9DQp9KTsNClZpZXdSZWdpc3RyeV8xLmRlZmluZVZpZXcoJ2xpc3RZZWFyJywgew0KICAgIHR5cGU6ICdsaXN0JywNCiAgICBkdXJhdGlvbjogeyB5ZWFyOiAxIH0sDQogICAgZGVmYXVsdHM6IHsNCiAgICAgICAgbGlzdERheUFsdEZvcm1hdDogJ2RkZGQnIC8vIGRheS1vZi13ZWVrIGlzIG5pY2UtdG8taGF2ZQ0KICAgIH0NCn0pOw0KCgovKioqLyB9KSwKLyogMjYyICovCi8qKiovIChmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMpIHsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7DQoKCi8qKiovIH0pCi8qKioqKiovIF0pOwp9KTs=
- ID: "6954b7c7-2487-423f-8600-436cb3b6dc0e"
  Hint: Size
  Value: 621860
- ID: "6f47a0a5-9c94-4b48-abeb-42d38def6054"
  Hint: Mime Type
  Value: "application/x-javascript"
- ID: "ba3f86a2-4a1c-4d78-b63d-91c2779c1b5e"
  Hint: __Sortorder
  Value: 1100
- ID: "c06867fe-9a43-4c7d-b739-48780492d06f"
  Hint: Extension
  Value: js
Languages:
- Language: en
  Versions:
  - Version: 1
    Fields:
    - ID: "25bed78c-4957-4165-998a-ca1b52f67497"
      Hint: __Created
      Value: 20160509T120133Z
