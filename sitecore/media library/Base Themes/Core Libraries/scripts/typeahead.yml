---
ID: "a7be7071-445f-443a-a8d0-d03abf78ac16"
Parent: "e3fbf2bd-14b5-439f-b488-478701f1bae1"
Template: "962b53c4-f93b-4df9-9821-415c867b8903"
Path: /sitecore/media library/Base Themes/Core Libraries/scripts/typeahead
DB: master
SharedFields:
- ID: "06d5295c-ed2f-4a54-9bf2-26228d113318"
  Hint: __Icon
  Value: "-/media/A7BE7071445F443AA8D0D03ABF78AC16.ashx?h=16&thn=1&w=16"
- ID: "40e50ed9-ba07-4702-992e-a912738d32dc"
  Hint: Blob
  Value: LyohCiAqIHR5cGVhaGVhZC5qcyAxLjMuMQogKiBodHRwczovL2dpdGh1Yi5jb20vY29yZWphdmFzY3JpcHQvdHlwZWFoZWFkLmpzCiAqIENvcHlyaWdodCAyMDEzLTIwMjAgVHdpdHRlciwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzOyBMaWNlbnNlZCBNSVQKICovCgoKKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgZGVmaW5lKFsianF1ZXJ5Il0sIGZ1bmN0aW9uIChhMCkgewogICAgICAgICAgICByZXR1cm4gcm9vdFsiQmxvb2Rob3VuZCJdID0gZmFjdG9yeShhMCk7CiAgICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgPT09ICJvYmplY3QiICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmUoImpxdWVyeSIpKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcm9vdFsiQmxvb2Rob3VuZCJdID0gZmFjdG9yeShyb290WyJqUXVlcnkiXSk7CiAgICB9Cn0pKHRoaXMsIGZ1bmN0aW9uICgkKSB7CiAgICB2YXIgXyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaXNNc2llOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gLyhtc2llfHRyaWRlbnQpL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSA/IG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goLyhtc2llIHxydjopKFxkKyguXGQrKT8pL2kpWzJdIDogZmFsc2U7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzQmxhbmtTdHJpbmc6IGZ1bmN0aW9uIChzdHIpIHsKICAgICAgICAgICAgICAgIHJldHVybiAhc3RyIHx8IC9eXHMqJC8udGVzdChzdHIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBlc2NhcGVSZWdFeENoYXJzOiBmdW5jdGlvbiAoc3RyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoL1tcLVxbXF1cL1x7XH1cKFwpXCpcK1w/XC5cXFxeXCRcfF0vZywgIlxcJCYiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNTdHJpbmc6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAic3RyaW5nIjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNOdW1iZXI6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAibnVtYmVyIjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNBcnJheTogJC5pc0FycmF5LAogICAgICAgICAgICBpc0Z1bmN0aW9uOiAkLmlzRnVuY3Rpb24sCiAgICAgICAgICAgIGlzT2JqZWN0OiAkLmlzUGxhaW5PYmplY3QsCiAgICAgICAgICAgIGlzVW5kZWZpbmVkOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gInVuZGVmaW5lZCI7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzRWxlbWVudDogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuICEhKG9iaiAmJiBvYmoubm9kZVR5cGUgPT09IDEpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc0pRdWVyeTogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mICQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvU3RyOiBmdW5jdGlvbiB0b1N0cihzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gXy5pc1VuZGVmaW5lZChzKSB8fCBzID09PSBudWxsID8gIiIgOiBzICsgIiI7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJpbmQ6ICQucHJveHksCiAgICAgICAgICAgIGVhY2g6IGZ1bmN0aW9uIChjb2xsZWN0aW9uLCBjYikgewogICAgICAgICAgICAgICAgJC5lYWNoKGNvbGxlY3Rpb24sIHJldmVyc2VBcmdzKTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJldmVyc2VBcmdzKGluZGV4LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYih2YWx1ZSwgaW5kZXgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBtYXA6ICQubWFwLAogICAgICAgICAgICBmaWx0ZXI6ICQuZ3JlcCwKICAgICAgICAgICAgZXZlcnk6IGZ1bmN0aW9uIChvYmosIHRlc3QpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKCFvYmopIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJC5lYWNoKG9iaiwgZnVuY3Rpb24gKGtleSwgdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEocmVzdWx0ID0gdGVzdC5jYWxsKG51bGwsIHZhbCwga2V5LCBvYmopKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gISFyZXN1bHQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNvbWU6IGZ1bmN0aW9uIChvYmosIHRlc3QpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICghb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICQuZWFjaChvYmosIGZ1bmN0aW9uIChrZXksIHZhbCkgewogICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPSB0ZXN0LmNhbGwobnVsbCwgdmFsLCBrZXksIG9iaikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuICEhcmVzdWx0OwogICAgICAgICAgICB9LAogICAgICAgICAgICBtaXhpbjogJC5leHRlbmQsCiAgICAgICAgICAgIGlkZW50aXR5OiBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHg7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsb25lOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJC5leHRlbmQodHJ1ZSwge30sIG9iaik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldElkR2VuZXJhdG9yOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgY291bnRlciA9IDA7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb3VudGVyKys7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9LAogICAgICAgICAgICB0ZW1wbGF0aWZ5OiBmdW5jdGlvbiB0ZW1wbGF0aWZ5KG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuICQuaXNGdW5jdGlvbihvYmopID8gb2JqIDogdGVtcGxhdGU7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiB0ZW1wbGF0ZSgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKG9iaik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlZmVyOiBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZm4sIDApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkZWJvdW5jZTogZnVuY3Rpb24gKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgewogICAgICAgICAgICAgICAgdmFyIHRpbWVvdXQsIHJlc3VsdDsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0aGlzLCBhcmdzID0gYXJndW1lbnRzLCBsYXRlciwgY2FsbE5vdzsKICAgICAgICAgICAgICAgICAgICBsYXRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaW1tZWRpYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBjYWxsTm93ID0gaW1tZWRpYXRlICYmICF0aW1lb3V0OwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxOb3cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRocm90dGxlOiBmdW5jdGlvbiAoZnVuYywgd2FpdCkgewogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQsIGFyZ3MsIHRpbWVvdXQsIHJlc3VsdCwgcHJldmlvdXMsIGxhdGVyOwogICAgICAgICAgICAgICAgcHJldmlvdXMgPSAwOwogICAgICAgICAgICAgICAgbGF0ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXMgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbm93ID0gbmV3IERhdGUoKSwgcmVtYWluaW5nID0gd2FpdCAtIChub3cgLSBwcmV2aW91cyk7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICAgICAgICAgICAgICBpZiAocmVtYWluaW5nIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXMgPSBub3c7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGltZW91dCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgcmVtYWluaW5nKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0cmluZ2lmeTogZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF8uaXNTdHJpbmcodmFsKSA/IHZhbCA6IEpTT04uc3RyaW5naWZ5KHZhbCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGd1aWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIF9wOChzKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHAgPSAoTWF0aC5yYW5kb20oKS50b1N0cmluZygxNikgKyAiMDAwMDAwMDAwIikuc3Vic3RyKDIsIDgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzID8gIi0iICsgcC5zdWJzdHIoMCwgNCkgKyAiLSIgKyBwLnN1YnN0cig0LCA0KSA6IHA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gInR0LSIgKyBfcDgoKSArIF9wOCh0cnVlKSArIF9wOCh0cnVlKSArIF9wOCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBub29wOiBmdW5jdGlvbiAoKSB7IH0KICAgICAgICB9OwogICAgfSgpOwogICAgdmFyIFZFUlNJT04gPSAiMS4zLjEiOwogICAgdmFyIHRva2VuaXplcnMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG5vbndvcmQ6IG5vbndvcmQsCiAgICAgICAgICAgIHdoaXRlc3BhY2U6IHdoaXRlc3BhY2UsCiAgICAgICAgICAgIG5ncmFtOiBuZ3JhbSwKICAgICAgICAgICAgb2JqOiB7CiAgICAgICAgICAgICAgICBub253b3JkOiBnZXRPYmpUb2tlbml6ZXIobm9ud29yZCksCiAgICAgICAgICAgICAgICB3aGl0ZXNwYWNlOiBnZXRPYmpUb2tlbml6ZXIod2hpdGVzcGFjZSksCiAgICAgICAgICAgICAgICBuZ3JhbTogZ2V0T2JqVG9rZW5pemVyKG5ncmFtKQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiB3aGl0ZXNwYWNlKHN0cikgewogICAgICAgICAgICBzdHIgPSBfLnRvU3RyKHN0cik7CiAgICAgICAgICAgIHJldHVybiBzdHIgPyBzdHIuc3BsaXQoL1xzKy8pIDogW107CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5vbndvcmQoc3RyKSB7CiAgICAgICAgICAgIHN0ciA9IF8udG9TdHIoc3RyKTsKICAgICAgICAgICAgcmV0dXJuIHN0ciA/IHN0ci5zcGxpdCgvXFcrLykgOiBbXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbmdyYW0oc3RyKSB7CiAgICAgICAgICAgIHN0ciA9IF8udG9TdHIoc3RyKTsKICAgICAgICAgICAgdmFyIHRva2VucyA9IFtdLCB3b3JkID0gIiI7CiAgICAgICAgICAgIF8uZWFjaChzdHIuc3BsaXQoIiIpLCBmdW5jdGlvbiAoY2hhcikgewogICAgICAgICAgICAgICAgaWYgKGNoYXIubWF0Y2goL1xzKy8pKSB7CiAgICAgICAgICAgICAgICAgICAgd29yZCA9ICIiOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh3b3JkICsgY2hhcik7CiAgICAgICAgICAgICAgICAgICAgd29yZCArPSBjaGFyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRva2VuczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0T2JqVG9rZW5pemVyKHRva2VuaXplcikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gc2V0S2V5KGtleXMpIHsKICAgICAgICAgICAgICAgIGtleXMgPSBfLmlzQXJyYXkoa2V5cykgPyBrZXlzIDogW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHRva2VuaXplKG8pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW5zID0gW107CiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGtleXMsIGZ1bmN0aW9uIChrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2VucyA9IHRva2Vucy5jb25jYXQodG9rZW5pemVyKF8udG9TdHIob1trXSkpKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdG9rZW5zOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KCk7CiAgICB2YXIgTHJ1Q2FjaGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGZ1bmN0aW9uIExydUNhY2hlKG1heFNpemUpIHsKICAgICAgICAgICAgdGhpcy5tYXhTaXplID0gXy5pc051bWJlcihtYXhTaXplKSA/IG1heFNpemUgOiAxMDA7CiAgICAgICAgICAgIHRoaXMucmVzZXQoKTsKICAgICAgICAgICAgaWYgKHRoaXMubWF4U2l6ZSA8PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldCA9IHRoaXMuZ2V0ID0gJC5ub29wOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIF8ubWl4aW4oTHJ1Q2FjaGUucHJvdG90eXBlLCB7CiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gc2V0KGtleSwgdmFsKSB7CiAgICAgICAgICAgICAgICB2YXIgdGFpbEl0ZW0gPSB0aGlzLmxpc3QudGFpbCwgbm9kZTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNpemUgPj0gdGhpcy5tYXhTaXplKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5saXN0LnJlbW92ZSh0YWlsSXRlbSk7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuaGFzaFt0YWlsSXRlbS5rZXldOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2l6ZS0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG5vZGUgPSB0aGlzLmhhc2hba2V5XSkgewogICAgICAgICAgICAgICAgICAgIG5vZGUudmFsID0gdmFsOwogICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdC5tb3ZlVG9Gcm9udChub2RlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG5ldyBOb2RlKGtleSwgdmFsKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxpc3QuYWRkKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFzaFtrZXldID0gbm9kZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNpemUrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoa2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMuaGFzaFtrZXldOwogICAgICAgICAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxpc3QubW92ZVRvRnJvbnQobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUudmFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICByZXNldDogZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNpemUgPSAwOwogICAgICAgICAgICAgICAgdGhpcy5oYXNoID0ge307CiAgICAgICAgICAgICAgICB0aGlzLmxpc3QgPSBuZXcgTGlzdCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgZnVuY3Rpb24gTGlzdCgpIHsKICAgICAgICAgICAgdGhpcy5oZWFkID0gdGhpcy50YWlsID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgXy5taXhpbihMaXN0LnByb3RvdHlwZSwgewogICAgICAgICAgICBhZGQ6IGZ1bmN0aW9uIGFkZChub2RlKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5oZWFkKSB7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5uZXh0ID0gdGhpcy5oZWFkOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaGVhZC5wcmV2ID0gbm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuaGVhZCA9IG5vZGU7CiAgICAgICAgICAgICAgICB0aGlzLnRhaWwgPSB0aGlzLnRhaWwgfHwgbm9kZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiByZW1vdmUobm9kZSkgewogICAgICAgICAgICAgICAgbm9kZS5wcmV2ID8gbm9kZS5wcmV2Lm5leHQgPSBub2RlLm5leHQgOiB0aGlzLmhlYWQgPSBub2RlLm5leHQ7CiAgICAgICAgICAgICAgICBub2RlLm5leHQgPyBub2RlLm5leHQucHJldiA9IG5vZGUucHJldiA6IHRoaXMudGFpbCA9IG5vZGUucHJldjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbW92ZVRvRnJvbnQ6IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShub2RlKTsKICAgICAgICAgICAgICAgIHRoaXMuYWRkKG5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgZnVuY3Rpb24gTm9kZShrZXksIHZhbCkgewogICAgICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICAgICAgdGhpcy52YWwgPSB2YWw7CiAgICAgICAgICAgIHRoaXMucHJldiA9IHRoaXMubmV4dCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHJldHVybiBMcnVDYWNoZTsKICAgIH0oKTsKICAgIHZhciBQZXJzaXN0ZW50U3RvcmFnZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIExPQ0FMX1NUT1JBR0U7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgTE9DQUxfU1RPUkFHRSA9IHdpbmRvdy5sb2NhbFN0b3JhZ2U7CiAgICAgICAgICAgIExPQ0FMX1NUT1JBR0Uuc2V0SXRlbSgifn5+IiwgIiEiKTsKICAgICAgICAgICAgTE9DQUxfU1RPUkFHRS5yZW1vdmVJdGVtKCJ+fn4iKTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgTE9DQUxfU1RPUkFHRSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIFBlcnNpc3RlbnRTdG9yYWdlKG5hbWVzcGFjZSwgb3ZlcnJpZGUpIHsKICAgICAgICAgICAgdGhpcy5wcmVmaXggPSBbIl9fIiwgbmFtZXNwYWNlLCAiX18iXS5qb2luKCIiKTsKICAgICAgICAgICAgdGhpcy50dGxLZXkgPSAiX190dGxfXyI7CiAgICAgICAgICAgIHRoaXMua2V5TWF0Y2hlciA9IG5ldyBSZWdFeHAoIl4iICsgXy5lc2NhcGVSZWdFeENoYXJzKHRoaXMucHJlZml4KSk7CiAgICAgICAgICAgIHRoaXMubHMgPSBvdmVycmlkZSB8fCBMT0NBTF9TVE9SQUdFOwogICAgICAgICAgICAhdGhpcy5scyAmJiB0aGlzLl9ub29wKCk7CiAgICAgICAgfQogICAgICAgIF8ubWl4aW4oUGVyc2lzdGVudFN0b3JhZ2UucHJvdG90eXBlLCB7CiAgICAgICAgICAgIF9wcmVmaXg6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnByZWZpeCArIGtleTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX3R0bEtleTogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3ByZWZpeChrZXkpICsgdGhpcy50dGxLZXk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9ub29wOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmdldCA9IHRoaXMuc2V0ID0gdGhpcy5yZW1vdmUgPSB0aGlzLmNsZWFyID0gdGhpcy5pc0V4cGlyZWQgPSBfLm5vb3A7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9zYWZlU2V0OiBmdW5jdGlvbiAoa2V5LCB2YWwpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5scy5zZXRJdGVtKGtleSwgdmFsKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgICAgIGlmIChlcnIubmFtZSA9PT0gIlF1b3RhRXhjZWVkZWRFcnJvciIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9ub29wKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzRXhwaXJlZChrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoa2V5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBkZWNvZGUodGhpcy5scy5nZXRJdGVtKHRoaXMuX3ByZWZpeChrZXkpKSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKGtleSwgdmFsLCB0dGwpIHsKICAgICAgICAgICAgICAgIGlmIChfLmlzTnVtYmVyKHR0bCkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zYWZlU2V0KHRoaXMuX3R0bEtleShrZXkpLCBlbmNvZGUobm93KCkgKyB0dGwpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5scy5yZW1vdmVJdGVtKHRoaXMuX3R0bEtleShrZXkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9zYWZlU2V0KHRoaXMuX3ByZWZpeChrZXkpLCBlbmNvZGUodmFsKSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgdGhpcy5scy5yZW1vdmVJdGVtKHRoaXMuX3R0bEtleShrZXkpKTsKICAgICAgICAgICAgICAgIHRoaXMubHMucmVtb3ZlSXRlbSh0aGlzLl9wcmVmaXgoa2V5KSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2xlYXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBpLCBrZXlzID0gZ2F0aGVyTWF0Y2hpbmdLZXlzKHRoaXMua2V5TWF0Y2hlcik7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSBrZXlzLmxlbmd0aDsgaS0tOykgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlKGtleXNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzRXhwaXJlZDogZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgICAgdmFyIHR0bCA9IGRlY29kZSh0aGlzLmxzLmdldEl0ZW0odGhpcy5fdHRsS2V5KGtleSkpKTsKICAgICAgICAgICAgICAgIHJldHVybiBfLmlzTnVtYmVyKHR0bCkgJiYgbm93KCkgPiB0dGwgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gUGVyc2lzdGVudFN0b3JhZ2U7CiAgICAgICAgZnVuY3Rpb24gbm93KCkgewogICAgICAgICAgICByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVuY29kZSh2YWwpIHsKICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KF8uaXNVbmRlZmluZWQodmFsKSA/IG51bGwgOiB2YWwpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWNvZGUodmFsKSB7CiAgICAgICAgICAgIHJldHVybiAkLnBhcnNlSlNPTih2YWwpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnYXRoZXJNYXRjaGluZ0tleXMoa2V5TWF0Y2hlcikgewogICAgICAgICAgICB2YXIgaSwga2V5LCBrZXlzID0gW10sIGxlbiA9IExPQ0FMX1NUT1JBR0UubGVuZ3RoOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICgoa2V5ID0gTE9DQUxfU1RPUkFHRS5rZXkoaSkpLm1hdGNoKGtleU1hdGNoZXIpKSB7CiAgICAgICAgICAgICAgICAgICAga2V5cy5wdXNoKGtleS5yZXBsYWNlKGtleU1hdGNoZXIsICIiKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGtleXM7CiAgICAgICAgfQogICAgfSgpOwogICAgdmFyIFRyYW5zcG9ydCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIHBlbmRpbmdSZXF1ZXN0c0NvdW50ID0gMCwgcGVuZGluZ1JlcXVlc3RzID0ge30sIHNoYXJlZENhY2hlID0gbmV3IExydUNhY2hlKDEwKTsKICAgICAgICBmdW5jdGlvbiBUcmFuc3BvcnQobykgewogICAgICAgICAgICBvID0gbyB8fCB7fTsKICAgICAgICAgICAgdGhpcy5tYXhQZW5kaW5nUmVxdWVzdHMgPSBvLm1heFBlbmRpbmdSZXF1ZXN0cyB8fCA2OwogICAgICAgICAgICB0aGlzLmNhbmNlbGxlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmxhc3RSZXEgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9zZW5kID0gby50cmFuc3BvcnQ7CiAgICAgICAgICAgIHRoaXMuX2dldCA9IG8ubGltaXRlciA/IG8ubGltaXRlcih0aGlzLl9nZXQpIDogdGhpcy5fZ2V0OwogICAgICAgICAgICB0aGlzLl9jYWNoZSA9IG8uY2FjaGUgPT09IGZhbHNlID8gbmV3IExydUNhY2hlKDApIDogc2hhcmVkQ2FjaGU7CiAgICAgICAgfQogICAgICAgIFRyYW5zcG9ydC5zZXRNYXhQZW5kaW5nUmVxdWVzdHMgPSBmdW5jdGlvbiBzZXRNYXhQZW5kaW5nUmVxdWVzdHMobnVtKSB7CiAgICAgICAgICAgIHRoaXMubWF4UGVuZGluZ1JlcXVlc3RzID0gbnVtOwogICAgICAgIH07CiAgICAgICAgVHJhbnNwb3J0LnJlc2V0Q2FjaGUgPSBmdW5jdGlvbiByZXNldENhY2hlKCkgewogICAgICAgICAgICBzaGFyZWRDYWNoZS5yZXNldCgpOwogICAgICAgIH07CiAgICAgICAgXy5taXhpbihUcmFuc3BvcnQucHJvdG90eXBlLCB7CiAgICAgICAgICAgIF9maW5nZXJwcmludDogZnVuY3Rpb24gZmluZ2VycHJpbnQobykgewogICAgICAgICAgICAgICAgbyA9IG8gfHwge307CiAgICAgICAgICAgICAgICByZXR1cm4gby51cmwgKyBvLnR5cGUgKyAkLnBhcmFtKG8uZGF0YSB8fCB7fSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9nZXQ6IGZ1bmN0aW9uIChvLCBjYikgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBmaW5nZXJwcmludCwganFYaHI7CiAgICAgICAgICAgICAgICBmaW5nZXJwcmludCA9IHRoaXMuX2ZpbmdlcnByaW50KG8pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FuY2VsbGVkIHx8IGZpbmdlcnByaW50ICE9PSB0aGlzLmxhc3RSZXEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoanFYaHIgPSBwZW5kaW5nUmVxdWVzdHNbZmluZ2VycHJpbnRdKSB7CiAgICAgICAgICAgICAgICAgICAganFYaHIuZG9uZShkb25lKS5mYWlsKGZhaWwpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwZW5kaW5nUmVxdWVzdHNDb3VudCA8IHRoaXMubWF4UGVuZGluZ1JlcXVlc3RzKSB7CiAgICAgICAgICAgICAgICAgICAgcGVuZGluZ1JlcXVlc3RzQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICBwZW5kaW5nUmVxdWVzdHNbZmluZ2VycHJpbnRdID0gdGhpcy5fc2VuZChvKS5kb25lKGRvbmUpLmZhaWwoZmFpbCkuYWx3YXlzKGFsd2F5cyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMub25EZWNrUmVxdWVzdEFyZ3MgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBkb25lKHJlc3ApIHsKICAgICAgICAgICAgICAgICAgICBjYihudWxsLCByZXNwKTsKICAgICAgICAgICAgICAgICAgICB0aGF0Ll9jYWNoZS5zZXQoZmluZ2VycHJpbnQsIHJlc3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZnVuY3Rpb24gZmFpbCgpIHsKICAgICAgICAgICAgICAgICAgICBjYih0cnVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFsd2F5cygpIHsKICAgICAgICAgICAgICAgICAgICBwZW5kaW5nUmVxdWVzdHNDb3VudC0tOwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBwZW5kaW5nUmVxdWVzdHNbZmluZ2VycHJpbnRdOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGF0Lm9uRGVja1JlcXVlc3RBcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuX2dldC5hcHBseSh0aGF0LCB0aGF0Lm9uRGVja1JlcXVlc3RBcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5vbkRlY2tSZXF1ZXN0QXJncyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIChvLCBjYikgewogICAgICAgICAgICAgICAgdmFyIHJlc3AsIGZpbmdlcnByaW50OwogICAgICAgICAgICAgICAgY2IgPSBjYiB8fCAkLm5vb3A7CiAgICAgICAgICAgICAgICBvID0gXy5pc1N0cmluZyhvKSA/IHsKICAgICAgICAgICAgICAgICAgICB1cmw6IG8KICAgICAgICAgICAgICAgIH0gOiBvIHx8IHt9OwogICAgICAgICAgICAgICAgZmluZ2VycHJpbnQgPSB0aGlzLl9maW5nZXJwcmludChvKTsKICAgICAgICAgICAgICAgIHRoaXMuY2FuY2VsbGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmxhc3RSZXEgPSBmaW5nZXJwcmludDsKICAgICAgICAgICAgICAgIGlmIChyZXNwID0gdGhpcy5fY2FjaGUuZ2V0KGZpbmdlcnByaW50KSkgewogICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIHJlc3ApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9nZXQobywgY2IpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBjYW5jZWw6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2FuY2VsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBUcmFuc3BvcnQ7CiAgICB9KCk7CiAgICB2YXIgU2VhcmNoSW5kZXggPSB3aW5kb3cuU2VhcmNoSW5kZXggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBDSElMRFJFTiA9ICJjIiwgSURTID0gImkiOwogICAgICAgIGZ1bmN0aW9uIFNlYXJjaEluZGV4KG8pIHsKICAgICAgICAgICAgbyA9IG8gfHwge307CiAgICAgICAgICAgIGlmICghby5kYXR1bVRva2VuaXplciB8fCAhby5xdWVyeVRva2VuaXplcikgewogICAgICAgICAgICAgICAgJC5lcnJvcigiZGF0dW1Ub2tlbml6ZXIgYW5kIHF1ZXJ5VG9rZW5pemVyIGFyZSBib3RoIHJlcXVpcmVkIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pZGVudGlmeSA9IG8uaWRlbnRpZnkgfHwgXy5zdHJpbmdpZnk7CiAgICAgICAgICAgIHRoaXMuZGF0dW1Ub2tlbml6ZXIgPSBvLmRhdHVtVG9rZW5pemVyOwogICAgICAgICAgICB0aGlzLnF1ZXJ5VG9rZW5pemVyID0gby5xdWVyeVRva2VuaXplcjsKICAgICAgICAgICAgdGhpcy5tYXRjaEFueVF1ZXJ5VG9rZW4gPSBvLm1hdGNoQW55UXVlcnlUb2tlbjsKICAgICAgICAgICAgdGhpcy5yZXNldCgpOwogICAgICAgIH0KICAgICAgICBfLm1peGluKFNlYXJjaEluZGV4LnByb3RvdHlwZSwgewogICAgICAgICAgICBib290c3RyYXA6IGZ1bmN0aW9uIGJvb3RzdHJhcChvKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRhdHVtcyA9IG8uZGF0dW1zOwogICAgICAgICAgICAgICAgdGhpcy50cmllID0gby50cmllOwogICAgICAgICAgICB9LAogICAgICAgICAgICBhZGQ6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICBkYXRhID0gXy5pc0FycmF5KGRhdGEpID8gZGF0YSA6IFtkYXRhXTsKICAgICAgICAgICAgICAgIF8uZWFjaChkYXRhLCBmdW5jdGlvbiAoZGF0dW0pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaWQsIHRva2VuczsKICAgICAgICAgICAgICAgICAgICB0aGF0LmRhdHVtc1tpZCA9IHRoYXQuaWRlbnRpZnkoZGF0dW0pXSA9IGRhdHVtOwogICAgICAgICAgICAgICAgICAgIHRva2VucyA9IG5vcm1hbGl6ZVRva2Vucyh0aGF0LmRhdHVtVG9rZW5pemVyKGRhdHVtKSk7CiAgICAgICAgICAgICAgICAgICAgXy5lYWNoKHRva2VucywgZnVuY3Rpb24gKHRva2VuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlLCBjaGFycywgY2g7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSB0aGF0LnRyaWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoYXJzID0gdG9rZW4uc3BsaXQoIiIpOwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoY2ggPSBjaGFycy5zaGlmdCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZVtDSElMRFJFTl1bY2hdIHx8IChub2RlW0NISUxEUkVOXVtjaF0gPSBuZXdOb2RlKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZVtJRFNdLnB1c2goaWQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoaWRzKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICByZXR1cm4gXy5tYXAoaWRzLCBmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5kYXR1bXNbaWRdOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNlYXJjaDogZnVuY3Rpb24gc2VhcmNoKHF1ZXJ5KSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHRva2VucywgbWF0Y2hlczsKICAgICAgICAgICAgICAgIHRva2VucyA9IG5vcm1hbGl6ZVRva2Vucyh0aGlzLnF1ZXJ5VG9rZW5pemVyKHF1ZXJ5KSk7CiAgICAgICAgICAgICAgICBfLmVhY2godG9rZW5zLCBmdW5jdGlvbiAodG9rZW4pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZSwgY2hhcnMsIGNoLCBpZHM7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoZXMgJiYgbWF0Y2hlcy5sZW5ndGggPT09IDAgJiYgIXRoYXQubWF0Y2hBbnlRdWVyeVRva2VuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHRoYXQudHJpZTsKICAgICAgICAgICAgICAgICAgICBjaGFycyA9IHRva2VuLnNwbGl0KCIiKTsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAobm9kZSAmJiAoY2ggPSBjaGFycy5zaGlmdCgpKSkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZVtDSElMRFJFTl1bY2hdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAobm9kZSAmJiBjaGFycy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWRzID0gbm9kZVtJRFNdLnNsaWNlKDApOwogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVzID0gbWF0Y2hlcyA/IGdldEludGVyc2VjdGlvbihtYXRjaGVzLCBpZHMpIDogaWRzOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhhdC5tYXRjaEFueVF1ZXJ5VG9rZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoZXMgPyBfLm1hcCh1bmlxdWUobWF0Y2hlcyksIGZ1bmN0aW9uIChpZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGF0LmRhdHVtc1tpZF07CiAgICAgICAgICAgICAgICB9KSA6IFtdOwogICAgICAgICAgICB9LAogICAgICAgICAgICBhbGw6IGZ1bmN0aW9uIGFsbCgpIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmRhdHVtcykgewogICAgICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHRoaXMuZGF0dW1zW2tleV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVzZXQ6IGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICAgICAgICAgICAgdGhpcy5kYXR1bXMgPSB7fTsKICAgICAgICAgICAgICAgIHRoaXMudHJpZSA9IG5ld05vZGUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2VyaWFsaXplOiBmdW5jdGlvbiBzZXJpYWxpemUoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIGRhdHVtczogdGhpcy5kYXR1bXMsCiAgICAgICAgICAgICAgICAgICAgdHJpZTogdGhpcy50cmllCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIFNlYXJjaEluZGV4OwogICAgICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZVRva2Vucyh0b2tlbnMpIHsKICAgICAgICAgICAgdG9rZW5zID0gXy5maWx0ZXIodG9rZW5zLCBmdW5jdGlvbiAodG9rZW4pIHsKICAgICAgICAgICAgICAgIHJldHVybiAhIXRva2VuOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdG9rZW5zID0gXy5tYXAodG9rZW5zLCBmdW5jdGlvbiAodG9rZW4pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0b2tlbi50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRva2VuczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbmV3Tm9kZSgpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB7fTsKICAgICAgICAgICAgbm9kZVtJRFNdID0gW107CiAgICAgICAgICAgIG5vZGVbQ0hJTERSRU5dID0ge307CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bmlxdWUoYXJyYXkpIHsKICAgICAgICAgICAgdmFyIHNlZW4gPSB7fSwgdW5pcXVlcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gYXJyYXkubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICghc2VlblthcnJheVtpXV0pIHsKICAgICAgICAgICAgICAgICAgICBzZWVuW2FycmF5W2ldXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdW5pcXVlcy5wdXNoKGFycmF5W2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdW5pcXVlczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SW50ZXJzZWN0aW9uKGFycmF5QSwgYXJyYXlCKSB7CiAgICAgICAgICAgIHZhciBhaSA9IDAsIGJpID0gMCwgaW50ZXJzZWN0aW9uID0gW107CiAgICAgICAgICAgIGFycmF5QSA9IGFycmF5QS5zb3J0KCk7CiAgICAgICAgICAgIGFycmF5QiA9IGFycmF5Qi5zb3J0KCk7CiAgICAgICAgICAgIHZhciBsZW5BcnJheUEgPSBhcnJheUEubGVuZ3RoLCBsZW5BcnJheUIgPSBhcnJheUIubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoYWkgPCBsZW5BcnJheUEgJiYgYmkgPCBsZW5BcnJheUIpIHsKICAgICAgICAgICAgICAgIGlmIChhcnJheUFbYWldIDwgYXJyYXlCW2JpXSkgewogICAgICAgICAgICAgICAgICAgIGFpKys7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFycmF5QVthaV0gPiBhcnJheUJbYmldKSB7CiAgICAgICAgICAgICAgICAgICAgYmkrKzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uLnB1c2goYXJyYXlBW2FpXSk7CiAgICAgICAgICAgICAgICAgICAgYWkrKzsKICAgICAgICAgICAgICAgICAgICBiaSsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpbnRlcnNlY3Rpb247CiAgICAgICAgfQogICAgfSgpOwogICAgdmFyIFByZWZldGNoID0gZnVuY3Rpb24gKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIga2V5czsKICAgICAgICBrZXlzID0gewogICAgICAgICAgICBkYXRhOiAiZGF0YSIsCiAgICAgICAgICAgIHByb3RvY29sOiAicHJvdG9jb2wiLAogICAgICAgICAgICB0aHVtYnByaW50OiAidGh1bWJwcmludCIKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIFByZWZldGNoKG8pIHsKICAgICAgICAgICAgdGhpcy51cmwgPSBvLnVybDsKICAgICAgICAgICAgdGhpcy50dGwgPSBvLnR0bDsKICAgICAgICAgICAgdGhpcy5jYWNoZSA9IG8uY2FjaGU7CiAgICAgICAgICAgIHRoaXMucHJlcGFyZSA9IG8ucHJlcGFyZTsKICAgICAgICAgICAgdGhpcy50cmFuc2Zvcm0gPSBvLnRyYW5zZm9ybTsKICAgICAgICAgICAgdGhpcy50cmFuc3BvcnQgPSBvLnRyYW5zcG9ydDsKICAgICAgICAgICAgdGhpcy50aHVtYnByaW50ID0gby50aHVtYnByaW50OwogICAgICAgICAgICB0aGlzLnN0b3JhZ2UgPSBuZXcgUGVyc2lzdGVudFN0b3JhZ2Uoby5jYWNoZUtleSk7CiAgICAgICAgfQogICAgICAgIF8ubWl4aW4oUHJlZmV0Y2gucHJvdG90eXBlLCB7CiAgICAgICAgICAgIF9zZXR0aW5nczogZnVuY3Rpb24gc2V0dGluZ3MoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIHVybDogdGhpcy51cmwsCiAgICAgICAgICAgICAgICAgICAgdHlwZTogIkdFVCIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIgogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3RvcmU6IGZ1bmN0aW9uIHN0b3JlKGRhdGEpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5jYWNoZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuc3RvcmFnZS5zZXQoa2V5cy5kYXRhLCBkYXRhLCB0aGlzLnR0bCk7CiAgICAgICAgICAgICAgICB0aGlzLnN0b3JhZ2Uuc2V0KGtleXMucHJvdG9jb2wsIGxvY2F0aW9uLnByb3RvY29sLCB0aGlzLnR0bCk7CiAgICAgICAgICAgICAgICB0aGlzLnN0b3JhZ2Uuc2V0KGtleXMudGh1bWJwcmludCwgdGhpcy50aHVtYnByaW50LCB0aGlzLnR0bCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZyb21DYWNoZTogZnVuY3Rpb24gZnJvbUNhY2hlKCkgewogICAgICAgICAgICAgICAgdmFyIHN0b3JlZCA9IHt9LCBpc0V4cGlyZWQ7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0b3JlZC5kYXRhID0gdGhpcy5zdG9yYWdlLmdldChrZXlzLmRhdGEpOwogICAgICAgICAgICAgICAgc3RvcmVkLnByb3RvY29sID0gdGhpcy5zdG9yYWdlLmdldChrZXlzLnByb3RvY29sKTsKICAgICAgICAgICAgICAgIHN0b3JlZC50aHVtYnByaW50ID0gdGhpcy5zdG9yYWdlLmdldChrZXlzLnRodW1icHJpbnQpOwogICAgICAgICAgICAgICAgaXNFeHBpcmVkID0gc3RvcmVkLnRodW1icHJpbnQgIT09IHRoaXMudGh1bWJwcmludCB8fCBzdG9yZWQucHJvdG9jb2wgIT09IGxvY2F0aW9uLnByb3RvY29sOwogICAgICAgICAgICAgICAgcmV0dXJuIHN0b3JlZC5kYXRhICYmICFpc0V4cGlyZWQgPyBzdG9yZWQuZGF0YSA6IG51bGw7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZyb21OZXR3b3JrOiBmdW5jdGlvbiAoY2IpIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgc2V0dGluZ3M7CiAgICAgICAgICAgICAgICBpZiAoIWNiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB0aGlzLnByZXBhcmUodGhpcy5fc2V0dGluZ3MoKSk7CiAgICAgICAgICAgICAgICB0aGlzLnRyYW5zcG9ydChzZXR0aW5ncykuZmFpbChvbkVycm9yKS5kb25lKG9uUmVzcG9uc2UpOwogICAgICAgICAgICAgICAgZnVuY3Rpb24gb25FcnJvcigpIHsKICAgICAgICAgICAgICAgICAgICBjYih0cnVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIG9uUmVzcG9uc2UocmVzcCkgewogICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIHRoYXQudHJhbnNmb3JtKHJlc3ApKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICAgICAgICAgICAgdGhpcy5zdG9yYWdlLmNsZWFyKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBQcmVmZXRjaDsKICAgIH0oKTsKICAgIHZhciBSZW1vdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGZ1bmN0aW9uIFJlbW90ZShvKSB7CiAgICAgICAgICAgIHRoaXMudXJsID0gby51cmw7CiAgICAgICAgICAgIHRoaXMucHJlcGFyZSA9IG8ucHJlcGFyZTsKICAgICAgICAgICAgdGhpcy50cmFuc2Zvcm0gPSBvLnRyYW5zZm9ybTsKICAgICAgICAgICAgdGhpcy5pbmRleFJlc3BvbnNlID0gby5pbmRleFJlc3BvbnNlOwogICAgICAgICAgICB0aGlzLnRyYW5zcG9ydCA9IG5ldyBUcmFuc3BvcnQoewogICAgICAgICAgICAgICAgY2FjaGU6IG8uY2FjaGUsCiAgICAgICAgICAgICAgICBsaW1pdGVyOiBvLmxpbWl0ZXIsCiAgICAgICAgICAgICAgICB0cmFuc3BvcnQ6IG8udHJhbnNwb3J0LAogICAgICAgICAgICAgICAgbWF4UGVuZGluZ1JlcXVlc3RzOiBvLm1heFBlbmRpbmdSZXF1ZXN0cwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgXy5taXhpbihSZW1vdGUucHJvdG90eXBlLCB7CiAgICAgICAgICAgIF9zZXR0aW5nczogZnVuY3Rpb24gc2V0dGluZ3MoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIHVybDogdGhpcy51cmwsCiAgICAgICAgICAgICAgICAgICAgdHlwZTogIkdFVCIsCiAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIgogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQocXVlcnksIGNiKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIHNldHRpbmdzOwogICAgICAgICAgICAgICAgaWYgKCFjYikgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHF1ZXJ5ID0gcXVlcnkgfHwgIiI7CiAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IHRoaXMucHJlcGFyZShxdWVyeSwgdGhpcy5fc2V0dGluZ3MoKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy50cmFuc3BvcnQuZ2V0KHNldHRpbmdzLCBvblJlc3BvbnNlKTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIG9uUmVzcG9uc2UoZXJyLCByZXNwKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyID8gY2IoW10pIDogY2IodGhhdC50cmFuc2Zvcm0ocmVzcCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBjYW5jZWxMYXN0UmVxdWVzdDogZnVuY3Rpb24gY2FuY2VsTGFzdFJlcXVlc3QoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRyYW5zcG9ydC5jYW5jZWwoKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBSZW1vdGU7CiAgICB9KCk7CiAgICB2YXIgb1BhcnNlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHBhcnNlKG8pIHsKICAgICAgICAgICAgdmFyIGRlZmF1bHRzLCBzb3J0ZXI7CiAgICAgICAgICAgIGRlZmF1bHRzID0gewogICAgICAgICAgICAgICAgaW5pdGlhbGl6ZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGlkZW50aWZ5OiBfLnN0cmluZ2lmeSwKICAgICAgICAgICAgICAgIGRhdHVtVG9rZW5pemVyOiBudWxsLAogICAgICAgICAgICAgICAgcXVlcnlUb2tlbml6ZXI6IG51bGwsCiAgICAgICAgICAgICAgICBtYXRjaEFueVF1ZXJ5VG9rZW46IGZhbHNlLAogICAgICAgICAgICAgICAgc3VmZmljaWVudDogNSwKICAgICAgICAgICAgICAgIGluZGV4UmVtb3RlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNvcnRlcjogbnVsbCwKICAgICAgICAgICAgICAgIGxvY2FsOiBbXSwKICAgICAgICAgICAgICAgIHByZWZldGNoOiBudWxsLAogICAgICAgICAgICAgICAgcmVtb3RlOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG8gPSBfLm1peGluKGRlZmF1bHRzLCBvIHx8IHt9KTsKICAgICAgICAgICAgIW8uZGF0dW1Ub2tlbml6ZXIgJiYgJC5lcnJvcigiZGF0dW1Ub2tlbml6ZXIgaXMgcmVxdWlyZWQiKTsKICAgICAgICAgICAgIW8ucXVlcnlUb2tlbml6ZXIgJiYgJC5lcnJvcigicXVlcnlUb2tlbml6ZXIgaXMgcmVxdWlyZWQiKTsKICAgICAgICAgICAgc29ydGVyID0gby5zb3J0ZXI7CiAgICAgICAgICAgIG8uc29ydGVyID0gc29ydGVyID8gZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB4LnNvcnQoc29ydGVyKTsKICAgICAgICAgICAgfSA6IF8uaWRlbnRpdHk7CiAgICAgICAgICAgIG8ubG9jYWwgPSBfLmlzRnVuY3Rpb24oby5sb2NhbCkgPyBvLmxvY2FsKCkgOiBvLmxvY2FsOwogICAgICAgICAgICBvLnByZWZldGNoID0gcGFyc2VQcmVmZXRjaChvLnByZWZldGNoKTsKICAgICAgICAgICAgby5yZW1vdGUgPSBwYXJzZVJlbW90ZShvLnJlbW90ZSk7CiAgICAgICAgICAgIHJldHVybiBvOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gcGFyc2VQcmVmZXRjaChvKSB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0czsKICAgICAgICAgICAgaWYgKCFvKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0cyA9IHsKICAgICAgICAgICAgICAgIHVybDogbnVsbCwKICAgICAgICAgICAgICAgIHR0bDogMjQgKiA2MCAqIDYwICogMWUzLAogICAgICAgICAgICAgICAgY2FjaGU6IHRydWUsCiAgICAgICAgICAgICAgICBjYWNoZUtleTogbnVsbCwKICAgICAgICAgICAgICAgIHRodW1icHJpbnQ6ICIiLAogICAgICAgICAgICAgICAgcHJlcGFyZTogXy5pZGVudGl0eSwKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogXy5pZGVudGl0eSwKICAgICAgICAgICAgICAgIHRyYW5zcG9ydDogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICBvID0gXy5pc1N0cmluZyhvKSA/IHsKICAgICAgICAgICAgICAgIHVybDogbwogICAgICAgICAgICB9IDogbzsKICAgICAgICAgICAgbyA9IF8ubWl4aW4oZGVmYXVsdHMsIG8pOwogICAgICAgICAgICAhby51cmwgJiYgJC5lcnJvcigicHJlZmV0Y2ggcmVxdWlyZXMgdXJsIHRvIGJlIHNldCIpOwogICAgICAgICAgICBvLnRyYW5zZm9ybSA9IG8uZmlsdGVyIHx8IG8udHJhbnNmb3JtOwogICAgICAgICAgICBvLmNhY2hlS2V5ID0gby5jYWNoZUtleSB8fCBvLnVybDsKICAgICAgICAgICAgby50aHVtYnByaW50ID0gVkVSU0lPTiArIG8udGh1bWJwcmludDsKICAgICAgICAgICAgby50cmFuc3BvcnQgPSBvLnRyYW5zcG9ydCA/IGNhbGxiYWNrVG9EZWZlcnJlZChvLnRyYW5zcG9ydCkgOiAkLmFqYXg7CiAgICAgICAgICAgIHJldHVybiBvOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwYXJzZVJlbW90ZShvKSB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0czsKICAgICAgICAgICAgaWYgKCFvKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdHMgPSB7CiAgICAgICAgICAgICAgICB1cmw6IG51bGwsCiAgICAgICAgICAgICAgICBjYWNoZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHByZXBhcmU6IG51bGwsCiAgICAgICAgICAgICAgICByZXBsYWNlOiBudWxsLAogICAgICAgICAgICAgICAgd2lsZGNhcmQ6IG51bGwsCiAgICAgICAgICAgICAgICBsaW1pdGVyOiBudWxsLAogICAgICAgICAgICAgICAgcmF0ZUxpbWl0Qnk6ICJkZWJvdW5jZSIsCiAgICAgICAgICAgICAgICByYXRlTGltaXRXYWl0OiAzMDAsCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm06IF8uaWRlbnRpdHksCiAgICAgICAgICAgICAgICB0cmFuc3BvcnQ6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgbyA9IF8uaXNTdHJpbmcobykgPyB7CiAgICAgICAgICAgICAgICB1cmw6IG8KICAgICAgICAgICAgfSA6IG87CiAgICAgICAgICAgIG8gPSBfLm1peGluKGRlZmF1bHRzLCBvKTsKICAgICAgICAgICAgIW8udXJsICYmICQuZXJyb3IoInJlbW90ZSByZXF1aXJlcyB1cmwgdG8gYmUgc2V0Iik7CiAgICAgICAgICAgIG8udHJhbnNmb3JtID0gby5maWx0ZXIgfHwgby50cmFuc2Zvcm07CiAgICAgICAgICAgIG8ucHJlcGFyZSA9IHRvUmVtb3RlUHJlcGFyZShvKTsKICAgICAgICAgICAgby5saW1pdGVyID0gdG9MaW1pdGVyKG8pOwogICAgICAgICAgICBvLnRyYW5zcG9ydCA9IG8udHJhbnNwb3J0ID8gY2FsbGJhY2tUb0RlZmVycmVkKG8udHJhbnNwb3J0KSA6ICQuYWpheDsKICAgICAgICAgICAgZGVsZXRlIG8ucmVwbGFjZTsKICAgICAgICAgICAgZGVsZXRlIG8ud2lsZGNhcmQ7CiAgICAgICAgICAgIGRlbGV0ZSBvLnJhdGVMaW1pdEJ5OwogICAgICAgICAgICBkZWxldGUgby5yYXRlTGltaXRXYWl0OwogICAgICAgICAgICByZXR1cm4gbzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9SZW1vdGVQcmVwYXJlKG8pIHsKICAgICAgICAgICAgdmFyIHByZXBhcmUsIHJlcGxhY2UsIHdpbGRjYXJkOwogICAgICAgICAgICBwcmVwYXJlID0gby5wcmVwYXJlOwogICAgICAgICAgICByZXBsYWNlID0gby5yZXBsYWNlOwogICAgICAgICAgICB3aWxkY2FyZCA9IG8ud2lsZGNhcmQ7CiAgICAgICAgICAgIGlmIChwcmVwYXJlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJlcGFyZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVwbGFjZSkgewogICAgICAgICAgICAgICAgcHJlcGFyZSA9IHByZXBhcmVCeVJlcGxhY2U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoby53aWxkY2FyZCkgewogICAgICAgICAgICAgICAgcHJlcGFyZSA9IHByZXBhcmVCeVdpbGRjYXJkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJlcGFyZSA9IGlkZW50aXR5UHJlcGFyZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJlcGFyZTsKICAgICAgICAgICAgZnVuY3Rpb24gcHJlcGFyZUJ5UmVwbGFjZShxdWVyeSwgc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIHNldHRpbmdzLnVybCA9IHJlcGxhY2Uoc2V0dGluZ3MudXJsLCBxdWVyeSk7CiAgICAgICAgICAgICAgICByZXR1cm4gc2V0dGluZ3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gcHJlcGFyZUJ5V2lsZGNhcmQocXVlcnksIHNldHRpbmdzKSB7CiAgICAgICAgICAgICAgICBzZXR0aW5ncy51cmwgPSBzZXR0aW5ncy51cmwucmVwbGFjZSh3aWxkY2FyZCwgZW5jb2RlVVJJQ29tcG9uZW50KHF1ZXJ5KSk7CiAgICAgICAgICAgICAgICByZXR1cm4gc2V0dGluZ3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gaWRlbnRpdHlQcmVwYXJlKHF1ZXJ5LCBzZXR0aW5ncykgewogICAgICAgICAgICAgICAgcmV0dXJuIHNldHRpbmdzOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRvTGltaXRlcihvKSB7CiAgICAgICAgICAgIHZhciBsaW1pdGVyLCBtZXRob2QsIHdhaXQ7CiAgICAgICAgICAgIGxpbWl0ZXIgPSBvLmxpbWl0ZXI7CiAgICAgICAgICAgIG1ldGhvZCA9IG8ucmF0ZUxpbWl0Qnk7CiAgICAgICAgICAgIHdhaXQgPSBvLnJhdGVMaW1pdFdhaXQ7CiAgICAgICAgICAgIGlmICghbGltaXRlcikgewogICAgICAgICAgICAgICAgbGltaXRlciA9IC9edGhyb3R0bGUkL2kudGVzdChtZXRob2QpID8gdGhyb3R0bGUod2FpdCkgOiBkZWJvdW5jZSh3YWl0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGltaXRlcjsKICAgICAgICAgICAgZnVuY3Rpb24gZGVib3VuY2Uod2FpdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGRlYm91bmNlKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF8uZGVib3VuY2UoZm4sIHdhaXQpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiB0aHJvdHRsZSh3YWl0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gdGhyb3R0bGUoZm4pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gXy50aHJvdHRsZShmbiwgd2FpdCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrVG9EZWZlcnJlZChmbikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gd3JhcHBlcihvKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CiAgICAgICAgICAgICAgICBmbihvLCBvblN1Y2Nlc3MsIG9uRXJyb3IpOwogICAgICAgICAgICAgICAgcmV0dXJuIGRlZmVycmVkOwogICAgICAgICAgICAgICAgZnVuY3Rpb24gb25TdWNjZXNzKHJlc3ApIHsKICAgICAgICAgICAgICAgICAgICBfLmRlZmVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShyZXNwKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIG9uRXJyb3IoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgXy5kZWZlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlcnIpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0oKTsKICAgIHZhciBCbG9vZGhvdW5kID0gZnVuY3Rpb24gKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgb2xkOwogICAgICAgIG9sZCA9IHdpbmRvdyAmJiB3aW5kb3cuQmxvb2Rob3VuZDsKICAgICAgICBmdW5jdGlvbiBCbG9vZGhvdW5kKG8pIHsKICAgICAgICAgICAgbyA9IG9QYXJzZXIobyk7CiAgICAgICAgICAgIHRoaXMuc29ydGVyID0gby5zb3J0ZXI7CiAgICAgICAgICAgIHRoaXMuaWRlbnRpZnkgPSBvLmlkZW50aWZ5OwogICAgICAgICAgICB0aGlzLnN1ZmZpY2llbnQgPSBvLnN1ZmZpY2llbnQ7CiAgICAgICAgICAgIHRoaXMuaW5kZXhSZW1vdGUgPSBvLmluZGV4UmVtb3RlOwogICAgICAgICAgICB0aGlzLmxvY2FsID0gby5sb2NhbDsKICAgICAgICAgICAgdGhpcy5yZW1vdGUgPSBvLnJlbW90ZSA/IG5ldyBSZW1vdGUoby5yZW1vdGUpIDogbnVsbDsKICAgICAgICAgICAgdGhpcy5wcmVmZXRjaCA9IG8ucHJlZmV0Y2ggPyBuZXcgUHJlZmV0Y2goby5wcmVmZXRjaCkgOiBudWxsOwogICAgICAgICAgICB0aGlzLmluZGV4ID0gbmV3IFNlYXJjaEluZGV4KHsKICAgICAgICAgICAgICAgIGlkZW50aWZ5OiB0aGlzLmlkZW50aWZ5LAogICAgICAgICAgICAgICAgZGF0dW1Ub2tlbml6ZXI6IG8uZGF0dW1Ub2tlbml6ZXIsCiAgICAgICAgICAgICAgICBxdWVyeVRva2VuaXplcjogby5xdWVyeVRva2VuaXplcgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgby5pbml0aWFsaXplICE9PSBmYWxzZSAmJiB0aGlzLmluaXRpYWxpemUoKTsKICAgICAgICB9CiAgICAgICAgQmxvb2Rob3VuZC5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gbm9Db25mbGljdCgpIHsKICAgICAgICAgICAgd2luZG93ICYmICh3aW5kb3cuQmxvb2Rob3VuZCA9IG9sZCk7CiAgICAgICAgICAgIHJldHVybiBCbG9vZGhvdW5kOwogICAgICAgIH07CiAgICAgICAgQmxvb2Rob3VuZC50b2tlbml6ZXJzID0gdG9rZW5pemVyczsKICAgICAgICBfLm1peGluKEJsb29kaG91bmQucHJvdG90eXBlLCB7CiAgICAgICAgICAgIF9fdHRBZGFwdGVyOiBmdW5jdGlvbiB0dEFkYXB0ZXIoKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5yZW1vdGUgPyB3aXRoQXN5bmMgOiB3aXRob3V0QXN5bmM7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiB3aXRoQXN5bmMocXVlcnksIHN5bmMsIGFzeW5jKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoYXQuc2VhcmNoKHF1ZXJ5LCBzeW5jLCBhc3luYyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmdW5jdGlvbiB3aXRob3V0QXN5bmMocXVlcnksIHN5bmMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5zZWFyY2gocXVlcnksIHN5bmMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBfbG9hZFByZWZldGNoOiBmdW5jdGlvbiBsb2FkUHJlZmV0Y2goKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGRlZmVycmVkLCBzZXJpYWxpemVkOwogICAgICAgICAgICAgICAgZGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMucHJlZmV0Y2gpIHsKICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNlcmlhbGl6ZWQgPSB0aGlzLnByZWZldGNoLmZyb21DYWNoZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbmRleC5ib290c3RyYXAoc2VyaWFsaXplZCk7CiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnByZWZldGNoLmZyb21OZXR3b3JrKGRvbmUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGRvbmUoZXJyLCBkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucmVqZWN0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoYXQuYWRkKGRhdGEpOwogICAgICAgICAgICAgICAgICAgIHRoYXQucHJlZmV0Y2guc3RvcmUodGhhdC5pbmRleC5zZXJpYWxpemUoKSk7CiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBfaW5pdGlhbGl6ZTogZnVuY3Rpb24gaW5pdGlhbGl6ZSgpIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgZGVmZXJyZWQ7CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICAodGhpcy5pbml0UHJvbWlzZSA9IHRoaXMuX2xvYWRQcmVmZXRjaCgpKS5kb25lKGFkZExvY2FsVG9JbmRleCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbml0UHJvbWlzZTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGFkZExvY2FsVG9JbmRleCgpIHsKICAgICAgICAgICAgICAgICAgICB0aGF0LmFkZCh0aGF0LmxvY2FsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gaW5pdGlhbGl6ZShmb3JjZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICF0aGlzLmluaXRQcm9taXNlIHx8IGZvcmNlID8gdGhpcy5faW5pdGlhbGl6ZSgpIDogdGhpcy5pbml0UHJvbWlzZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgYWRkOiBmdW5jdGlvbiBhZGQoZGF0YSkgewogICAgICAgICAgICAgICAgdGhpcy5pbmRleC5hZGQoZGF0YSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoaWRzKSB7CiAgICAgICAgICAgICAgICBpZHMgPSBfLmlzQXJyYXkoaWRzKSA/IGlkcyA6IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmluZGV4LmdldChpZHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZWFyY2g6IGZ1bmN0aW9uIHNlYXJjaChxdWVyeSwgc3luYywgYXN5bmMpIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgbG9jYWw7CiAgICAgICAgICAgICAgICBzeW5jID0gc3luYyB8fCBfLm5vb3A7CiAgICAgICAgICAgICAgICBhc3luYyA9IGFzeW5jIHx8IF8ubm9vcDsKICAgICAgICAgICAgICAgIGxvY2FsID0gdGhpcy5zb3J0ZXIodGhpcy5pbmRleC5zZWFyY2gocXVlcnkpKTsKICAgICAgICAgICAgICAgIHN5bmModGhpcy5yZW1vdGUgPyBsb2NhbC5zbGljZSgpIDogbG9jYWwpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMucmVtb3RlICYmIGxvY2FsLmxlbmd0aCA8IHRoaXMuc3VmZmljaWVudCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3RlLmdldChxdWVyeSwgcHJvY2Vzc1JlbW90ZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMucmVtb3RlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdGUuY2FuY2VsTGFzdFJlcXVlc3QoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc1JlbW90ZShyZW1vdGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbm9uRHVwbGljYXRlcyA9IFtdOwogICAgICAgICAgICAgICAgICAgIF8uZWFjaChyZW1vdGUsIGZ1bmN0aW9uIChyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICFfLnNvbWUobG9jYWwsIGZ1bmN0aW9uIChsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhhdC5pZGVudGlmeShyKSA9PT0gdGhhdC5pZGVudGlmeShsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkgJiYgbm9uRHVwbGljYXRlcy5wdXNoKHIpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHRoYXQuaW5kZXhSZW1vdGUgJiYgdGhhdC5hZGQobm9uRHVwbGljYXRlcyk7CiAgICAgICAgICAgICAgICAgICAgYXN5bmMobm9uRHVwbGljYXRlcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGFsbDogZnVuY3Rpb24gYWxsKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5kZXguYWxsKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsZWFyOiBmdW5jdGlvbiBjbGVhcigpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5kZXgucmVzZXQoKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjbGVhclByZWZldGNoQ2FjaGU6IGZ1bmN0aW9uIGNsZWFyUHJlZmV0Y2hDYWNoZSgpIHsKICAgICAgICAgICAgICAgIHRoaXMucHJlZmV0Y2ggJiYgdGhpcy5wcmVmZXRjaC5jbGVhcigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsZWFyUmVtb3RlQ2FjaGU6IGZ1bmN0aW9uIGNsZWFyUmVtb3RlQ2FjaGUoKSB7CiAgICAgICAgICAgICAgICBUcmFuc3BvcnQucmVzZXRDYWNoZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHR0QWRhcHRlcjogZnVuY3Rpb24gdHRBZGFwdGVyKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX190dEFkYXB0ZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBCbG9vZGhvdW5kOwogICAgfSgpOwogICAgcmV0dXJuIEJsb29kaG91bmQ7Cn0pOwoKKGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgZGVmaW5lKFsianF1ZXJ5Il0sIGZ1bmN0aW9uIChhMCkgewogICAgICAgICAgICByZXR1cm4gZmFjdG9yeShhMCk7CiAgICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgPT09ICJvYmplY3QiICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KHJlcXVpcmUoImpxdWVyeSIpKTsKICAgIH0gZWxzZSB7CiAgICAgICAgZmFjdG9yeShyb290WyJqUXVlcnkiXSk7CiAgICB9Cn0pKHRoaXMsIGZ1bmN0aW9uICgkKSB7CiAgICB2YXIgXyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaXNNc2llOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gLyhtc2llfHRyaWRlbnQpL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSA/IG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goLyhtc2llIHxydjopKFxkKyguXGQrKT8pL2kpWzJdIDogZmFsc2U7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzQmxhbmtTdHJpbmc6IGZ1bmN0aW9uIChzdHIpIHsKICAgICAgICAgICAgICAgIHJldHVybiAhc3RyIHx8IC9eXHMqJC8udGVzdChzdHIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBlc2NhcGVSZWdFeENoYXJzOiBmdW5jdGlvbiAoc3RyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoL1tcLVxbXF1cL1x7XH1cKFwpXCpcK1w/XC5cXFxeXCRcfF0vZywgIlxcJCYiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNTdHJpbmc6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAic3RyaW5nIjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNOdW1iZXI6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAibnVtYmVyIjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNBcnJheTogJC5pc0FycmF5LAogICAgICAgICAgICBpc0Z1bmN0aW9uOiAkLmlzRnVuY3Rpb24sCiAgICAgICAgICAgIGlzT2JqZWN0OiAkLmlzUGxhaW5PYmplY3QsCiAgICAgICAgICAgIGlzVW5kZWZpbmVkOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gInVuZGVmaW5lZCI7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzRWxlbWVudDogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuICEhKG9iaiAmJiBvYmoubm9kZVR5cGUgPT09IDEpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc0pRdWVyeTogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mICQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvU3RyOiBmdW5jdGlvbiB0b1N0cihzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gXy5pc1VuZGVmaW5lZChzKSB8fCBzID09PSBudWxsID8gIiIgOiBzICsgIiI7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJpbmQ6ICQucHJveHksCiAgICAgICAgICAgIGVhY2g6IGZ1bmN0aW9uIChjb2xsZWN0aW9uLCBjYikgewogICAgICAgICAgICAgICAgJC5lYWNoKGNvbGxlY3Rpb24sIHJldmVyc2VBcmdzKTsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJldmVyc2VBcmdzKGluZGV4LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYih2YWx1ZSwgaW5kZXgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBtYXA6ICQubWFwLAogICAgICAgICAgICBmaWx0ZXI6ICQuZ3JlcCwKICAgICAgICAgICAgZXZlcnk6IGZ1bmN0aW9uIChvYmosIHRlc3QpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKCFvYmopIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJC5lYWNoKG9iaiwgZnVuY3Rpb24gKGtleSwgdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCEocmVzdWx0ID0gdGVzdC5jYWxsKG51bGwsIHZhbCwga2V5LCBvYmopKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gISFyZXN1bHQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNvbWU6IGZ1bmN0aW9uIChvYmosIHRlc3QpIHsKICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICghb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICQuZWFjaChvYmosIGZ1bmN0aW9uIChrZXksIHZhbCkgewogICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPSB0ZXN0LmNhbGwobnVsbCwgdmFsLCBrZXksIG9iaikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuICEhcmVzdWx0OwogICAgICAgICAgICB9LAogICAgICAgICAgICBtaXhpbjogJC5leHRlbmQsCiAgICAgICAgICAgIGlkZW50aXR5OiBmdW5jdGlvbiAoeCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHg7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsb25lOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJC5leHRlbmQodHJ1ZSwge30sIG9iaik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldElkR2VuZXJhdG9yOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgY291bnRlciA9IDA7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb3VudGVyKys7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9LAogICAgICAgICAgICB0ZW1wbGF0aWZ5OiBmdW5jdGlvbiB0ZW1wbGF0aWZ5KG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuICQuaXNGdW5jdGlvbihvYmopID8gb2JqIDogdGVtcGxhdGU7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiB0ZW1wbGF0ZSgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKG9iaik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlZmVyOiBmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZm4sIDApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkZWJvdW5jZTogZnVuY3Rpb24gKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgewogICAgICAgICAgICAgICAgdmFyIHRpbWVvdXQsIHJlc3VsdDsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0aGlzLCBhcmdzID0gYXJndW1lbnRzLCBsYXRlciwgY2FsbE5vdzsKICAgICAgICAgICAgICAgICAgICBsYXRlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaW1tZWRpYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBjYWxsTm93ID0gaW1tZWRpYXRlICYmICF0aW1lb3V0OwogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxOb3cpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRocm90dGxlOiBmdW5jdGlvbiAoZnVuYywgd2FpdCkgewogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQsIGFyZ3MsIHRpbWVvdXQsIHJlc3VsdCwgcHJldmlvdXMsIGxhdGVyOwogICAgICAgICAgICAgICAgcHJldmlvdXMgPSAwOwogICAgICAgICAgICAgICAgbGF0ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXMgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbm93ID0gbmV3IERhdGUoKSwgcmVtYWluaW5nID0gd2FpdCAtIChub3cgLSBwcmV2aW91cyk7CiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICAgICAgICAgICAgICBpZiAocmVtYWluaW5nIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXMgPSBub3c7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGltZW91dCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgcmVtYWluaW5nKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0cmluZ2lmeTogZnVuY3Rpb24gKHZhbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF8uaXNTdHJpbmcodmFsKSA/IHZhbCA6IEpTT04uc3RyaW5naWZ5KHZhbCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGd1aWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIF9wOChzKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHAgPSAoTWF0aC5yYW5kb20oKS50b1N0cmluZygxNikgKyAiMDAwMDAwMDAwIikuc3Vic3RyKDIsIDgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzID8gIi0iICsgcC5zdWJzdHIoMCwgNCkgKyAiLSIgKyBwLnN1YnN0cig0LCA0KSA6IHA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gInR0LSIgKyBfcDgoKSArIF9wOCh0cnVlKSArIF9wOCh0cnVlKSArIF9wOCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBub29wOiBmdW5jdGlvbiAoKSB7IH0KICAgICAgICB9OwogICAgfSgpOwogICAgdmFyIFdXVyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIGRlZmF1bHRDbGFzc05hbWVzID0gewogICAgICAgICAgICB3cmFwcGVyOiAidHdpdHRlci10eXBlYWhlYWQiLAogICAgICAgICAgICBpbnB1dDogInR0LWlucHV0IiwKICAgICAgICAgICAgaGludDogInR0LWhpbnQiLAogICAgICAgICAgICBtZW51OiAidHQtbWVudSIsCiAgICAgICAgICAgIGRhdGFzZXQ6ICJ0dC1kYXRhc2V0IiwKICAgICAgICAgICAgc3VnZ2VzdGlvbjogInR0LXN1Z2dlc3Rpb24iLAogICAgICAgICAgICBzZWxlY3RhYmxlOiAidHQtc2VsZWN0YWJsZSIsCiAgICAgICAgICAgIGVtcHR5OiAidHQtZW1wdHkiLAogICAgICAgICAgICBvcGVuOiAidHQtb3BlbiIsCiAgICAgICAgICAgIGN1cnNvcjogInR0LWN1cnNvciIsCiAgICAgICAgICAgIGhpZ2hsaWdodDogInR0LWhpZ2hsaWdodCIKICAgICAgICB9OwogICAgICAgIHJldHVybiBidWlsZDsKICAgICAgICBmdW5jdGlvbiBidWlsZChvKSB7CiAgICAgICAgICAgIHZhciB3d3csIGNsYXNzZXM7CiAgICAgICAgICAgIGNsYXNzZXMgPSBfLm1peGluKHt9LCBkZWZhdWx0Q2xhc3NOYW1lcywgbyk7CiAgICAgICAgICAgIHd3dyA9IHsKICAgICAgICAgICAgICAgIGNzczogYnVpbGRDc3MoKSwKICAgICAgICAgICAgICAgIGNsYXNzZXM6IGNsYXNzZXMsCiAgICAgICAgICAgICAgICBodG1sOiBidWlsZEh0bWwoY2xhc3NlcyksCiAgICAgICAgICAgICAgICBzZWxlY3RvcnM6IGJ1aWxkU2VsZWN0b3JzKGNsYXNzZXMpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBjc3M6IHd3dy5jc3MsCiAgICAgICAgICAgICAgICBodG1sOiB3d3cuaHRtbCwKICAgICAgICAgICAgICAgIGNsYXNzZXM6IHd3dy5jbGFzc2VzLAogICAgICAgICAgICAgICAgc2VsZWN0b3JzOiB3d3cuc2VsZWN0b3JzLAogICAgICAgICAgICAgICAgbWl4aW46IGZ1bmN0aW9uIChvKSB7CiAgICAgICAgICAgICAgICAgICAgXy5taXhpbihvLCB3d3cpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBidWlsZEh0bWwoYykgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgd3JhcHBlcjogJzxzcGFuIGNsYXNzPSInICsgYy53cmFwcGVyICsgJyI+PC9zcGFuPicsCiAgICAgICAgICAgICAgICBtZW51OiAnPGRpdiByb2xlPSJsaXN0Ym94IiBjbGFzcz0iJyArIGMubWVudSArICciPjwvZGl2PicKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYnVpbGRTZWxlY3RvcnMoY2xhc3NlcykgewogICAgICAgICAgICB2YXIgc2VsZWN0b3JzID0ge307CiAgICAgICAgICAgIF8uZWFjaChjbGFzc2VzLCBmdW5jdGlvbiAodiwgaykgewogICAgICAgICAgICAgICAgc2VsZWN0b3JzW2tdID0gIi4iICsgdjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBzZWxlY3RvcnM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJ1aWxkQ3NzKCkgewogICAgICAgICAgICB2YXIgY3NzID0gewogICAgICAgICAgICAgICAgd3JhcHBlcjogewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAicmVsYXRpdmUiLAogICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJpbmxpbmUtYmxvY2siCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaGludDogewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgICAgICAgICAgICAgIHRvcDogIjAiLAogICAgICAgICAgICAgICAgICAgIGxlZnQ6ICIwIiwKICAgICAgICAgICAgICAgICAgICBib3JkZXJDb2xvcjogInRyYW5zcGFyZW50IiwKICAgICAgICAgICAgICAgICAgICBib3hTaGFkb3c6ICJub25lIiwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAiMSIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbnB1dDogewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAicmVsYXRpdmUiLAogICAgICAgICAgICAgICAgICAgIHZlcnRpY2FsQWxpZ246ICJ0b3AiLAogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInRyYW5zcGFyZW50IgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGlucHV0V2l0aE5vSGludDogewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAicmVsYXRpdmUiLAogICAgICAgICAgICAgICAgICAgIHZlcnRpY2FsQWxpZ246ICJ0b3AiCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgbWVudTogewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgICAgICAgICAgICAgIHRvcDogIjEwMCUiLAogICAgICAgICAgICAgICAgICAgIGxlZnQ6ICIwIiwKICAgICAgICAgICAgICAgICAgICB6SW5kZXg6ICIxMDAiLAogICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJub25lIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGx0cjogewogICAgICAgICAgICAgICAgICAgIGxlZnQ6ICIwIiwKICAgICAgICAgICAgICAgICAgICByaWdodDogImF1dG8iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcnRsOiB7CiAgICAgICAgICAgICAgICAgICAgbGVmdDogImF1dG8iLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAiIDAiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChfLmlzTXNpZSgpKSB7CiAgICAgICAgICAgICAgICBfLm1peGluKGNzcy5pbnB1dCwgewogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRJbWFnZTogInVybChkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQUFBQUFBUC8vL3lINUJBRUFBQUFBTEFBQUFBQUJBQUVBQUFJQlJBQTcpIgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNzczsKICAgICAgICB9CiAgICB9KCk7CiAgICB2YXIgRXZlbnRCdXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBuYW1lc3BhY2UsIGRlcHJlY2F0aW9uTWFwOwogICAgICAgIG5hbWVzcGFjZSA9ICJ0eXBlYWhlYWQ6IjsKICAgICAgICBkZXByZWNhdGlvbk1hcCA9IHsKICAgICAgICAgICAgcmVuZGVyOiAicmVuZGVyZWQiLAogICAgICAgICAgICBjdXJzb3JjaGFuZ2U6ICJjdXJzb3JjaGFuZ2VkIiwKICAgICAgICAgICAgc2VsZWN0OiAic2VsZWN0ZWQiLAogICAgICAgICAgICBhdXRvY29tcGxldGU6ICJhdXRvY29tcGxldGVkIgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gRXZlbnRCdXMobykgewogICAgICAgICAgICBpZiAoIW8gfHwgIW8uZWwpIHsKICAgICAgICAgICAgICAgICQuZXJyb3IoIkV2ZW50QnVzIGluaXRpYWxpemVkIHdpdGhvdXQgZWwiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLiRlbCA9ICQoby5lbCk7CiAgICAgICAgfQogICAgICAgIF8ubWl4aW4oRXZlbnRCdXMucHJvdG90eXBlLCB7CiAgICAgICAgICAgIF90cmlnZ2VyOiBmdW5jdGlvbiAodHlwZSwgYXJncykgewogICAgICAgICAgICAgICAgdmFyICRlID0gJC5FdmVudChuYW1lc3BhY2UgKyB0eXBlKTsKICAgICAgICAgICAgICAgIHRoaXMuJGVsLnRyaWdnZXIuY2FsbCh0aGlzLiRlbCwgJGUsIGFyZ3MgfHwgW10pOwogICAgICAgICAgICAgICAgcmV0dXJuICRlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBiZWZvcmU6IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncywgJGU7CiAgICAgICAgICAgICAgICBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICAgICAgJGUgPSB0aGlzLl90cmlnZ2VyKCJiZWZvcmUiICsgdHlwZSwgYXJncyk7CiAgICAgICAgICAgICAgICByZXR1cm4gJGUuaXNEZWZhdWx0UHJldmVudGVkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVwcmVjYXRlZFR5cGU7CiAgICAgICAgICAgICAgICB0aGlzLl90cmlnZ2VyKHR5cGUsIFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICAgICAgICAgICAgICBpZiAoZGVwcmVjYXRlZFR5cGUgPSBkZXByZWNhdGlvbk1hcFt0eXBlXSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3RyaWdnZXIoZGVwcmVjYXRlZFR5cGUsIFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gRXZlbnRCdXM7CiAgICB9KCk7CiAgICB2YXIgRXZlbnRFbWl0dGVyID0gZnVuY3Rpb24gKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgc3BsaXR0ZXIgPSAvXHMrLywgbmV4dFRpY2sgPSBnZXROZXh0VGljaygpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG9uU3luYzogb25TeW5jLAogICAgICAgICAgICBvbkFzeW5jOiBvbkFzeW5jLAogICAgICAgICAgICBvZmY6IG9mZiwKICAgICAgICAgICAgdHJpZ2dlcjogdHJpZ2dlcgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gb24obWV0aG9kLCB0eXBlcywgY2IsIGNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHR5cGU7CiAgICAgICAgICAgIGlmICghY2IpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHR5cGVzID0gdHlwZXMuc3BsaXQoc3BsaXR0ZXIpOwogICAgICAgICAgICBjYiA9IGNvbnRleHQgPyBiaW5kQ29udGV4dChjYiwgY29udGV4dCkgOiBjYjsKICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzID0gdGhpcy5fY2FsbGJhY2tzIHx8IHt9OwogICAgICAgICAgICB3aGlsZSAodHlwZSA9IHR5cGVzLnNoaWZ0KCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2NhbGxiYWNrc1t0eXBlXSA9IHRoaXMuX2NhbGxiYWNrc1t0eXBlXSB8fCB7CiAgICAgICAgICAgICAgICAgICAgc3luYzogW10sCiAgICAgICAgICAgICAgICAgICAgYXN5bmM6IFtdCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdGhpcy5fY2FsbGJhY2tzW3R5cGVdW21ldGhvZF0ucHVzaChjYik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uQXN5bmModHlwZXMsIGNiLCBjb250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBvbi5jYWxsKHRoaXMsICJhc3luYyIsIHR5cGVzLCBjYiwgY29udGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uU3luYyh0eXBlcywgY2IsIGNvbnRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIG9uLmNhbGwodGhpcywgInN5bmMiLCB0eXBlcywgY2IsIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvZmYodHlwZXMpIHsKICAgICAgICAgICAgdmFyIHR5cGU7CiAgICAgICAgICAgIGlmICghdGhpcy5fY2FsbGJhY2tzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICB0eXBlcyA9IHR5cGVzLnNwbGl0KHNwbGl0dGVyKTsKICAgICAgICAgICAgd2hpbGUgKHR5cGUgPSB0eXBlcy5zaGlmdCgpKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5fY2FsbGJhY2tzW3R5cGVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmlnZ2VyKHR5cGVzKSB7CiAgICAgICAgICAgIHZhciB0eXBlLCBjYWxsYmFja3MsIGFyZ3MsIHN5bmNGbHVzaCwgYXN5bmNGbHVzaDsKICAgICAgICAgICAgaWYgKCF0aGlzLl9jYWxsYmFja3MpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHR5cGVzID0gdHlwZXMuc3BsaXQoc3BsaXR0ZXIpOwogICAgICAgICAgICBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgICB3aGlsZSAoKHR5cGUgPSB0eXBlcy5zaGlmdCgpKSAmJiAoY2FsbGJhY2tzID0gdGhpcy5fY2FsbGJhY2tzW3R5cGVdKSkgewogICAgICAgICAgICAgICAgc3luY0ZsdXNoID0gZ2V0Rmx1c2goY2FsbGJhY2tzLnN5bmMsIHRoaXMsIFt0eXBlXS5jb25jYXQoYXJncykpOwogICAgICAgICAgICAgICAgYXN5bmNGbHVzaCA9IGdldEZsdXNoKGNhbGxiYWNrcy5hc3luYywgdGhpcywgW3R5cGVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgICAgICBzeW5jRmx1c2goKSAmJiBuZXh0VGljayhhc3luY0ZsdXNoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rmx1c2goY2FsbGJhY2tzLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgICAgICAgIHJldHVybiBmbHVzaDsKICAgICAgICAgICAgZnVuY3Rpb24gZmx1c2goKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FuY2VsbGVkOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGNhbGxiYWNrcy5sZW5ndGg7ICFjYW5jZWxsZWQgJiYgaSA8IGxlbjsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgY2FuY2VsbGVkID0gY2FsbGJhY2tzW2ldLmFwcGx5KGNvbnRleHQsIGFyZ3MpID09PSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAhY2FuY2VsbGVkOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5leHRUaWNrKCkgewogICAgICAgICAgICB2YXIgbmV4dFRpY2tGbjsKICAgICAgICAgICAgaWYgKHdpbmRvdy5zZXRJbW1lZGlhdGUpIHsKICAgICAgICAgICAgICAgIG5leHRUaWNrRm4gPSBmdW5jdGlvbiBuZXh0VGlja1NldEltbWVkaWF0ZShmbikgewogICAgICAgICAgICAgICAgICAgIHNldEltbWVkaWF0ZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dFRpY2tGbiA9IGZ1bmN0aW9uIG5leHRUaWNrU2V0VGltZW91dChmbikgewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV4dFRpY2tGbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmluZENvbnRleHQoZm4sIGNvbnRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIGZuLmJpbmQgPyBmbi5iaW5kKGNvbnRleHQpIDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZm4uYXBwbHkoY29udGV4dCwgW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KCk7CiAgICB2YXIgaGlnaGxpZ2h0ID0gZnVuY3Rpb24gKGRvYykgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgZGVmYXVsdHMgPSB7CiAgICAgICAgICAgIG5vZGU6IG51bGwsCiAgICAgICAgICAgIHBhdHRlcm46IG51bGwsCiAgICAgICAgICAgIHRhZ05hbWU6ICJzdHJvbmciLAogICAgICAgICAgICBjbGFzc05hbWU6IG51bGwsCiAgICAgICAgICAgIHdvcmRzT25seTogZmFsc2UsCiAgICAgICAgICAgIGNhc2VTZW5zaXRpdmU6IGZhbHNlLAogICAgICAgICAgICBkaWFjcml0aWNJbnNlbnNpdGl2ZTogZmFsc2UKICAgICAgICB9OwogICAgICAgIHZhciBhY2NlbnRlZCA9IHsKICAgICAgICAgICAgQTogIltBYcKqw4Atw4XDoC3DpcSALcSFx43HjsiALciDyKbIp+G0rOG1g+G4gOG4geG6muG6oC3huqPigpDihIDihIHihLvikpzikrbik5DjjbEt4420446ALeOOhOOOiOOOieOOqS3jjq/jj4Ljj4rjj5/jj7/vvKHvvYFdIiwKICAgICAgICAgICAgQjogIltCYuG0ruG1h+G4gi3huIfihKzikp3ikrfik5HjjbTjjoUt446H44+D44+I44+U44+d77yi772CXSIsCiAgICAgICAgICAgIEM6ICJbQ2PDh8OnxIYtxI3htpzihIDihILihIPihIXihIbihK3iha3ihb3ikp7ikrjik5Ljjbbjjojjjonjjp3jjqDjjqTjj4Qt44+H77yj772DXSIsCiAgICAgICAgICAgIEQ6ICJbRGTEjsSPx4Qtx4bHsS3Hs+G0sOG1iOG4ii3huJPihYXihYbiha7ihb7ikp/ikrnik5Pji4/jjbLjjbct4425446X446tLeOOr+OPheOPiO+8pO+9hF0iLAogICAgICAgICAgICBFOiAiW0Vlw4gtw4vDqC3Dq8SSLcSbyIQtyIfIqMip4bSx4bWJ4biYLeG4m+G6uC3hur3igpHihKHihK/ihLDihYfikqDikrrik5TjiZDji43ji47vvKXvvYVdIiwKICAgICAgICAgICAgRjogIltGZuG2oOG4nuG4n+KEieKEseKEu+KSoeKSu+KTleOOii3jjozjjpnvrIAt76yE77ym772GXSIsCiAgICAgICAgICAgIEc6ICJbR2fEnC3Eo8emx6fHtMe14bSz4bWN4big4bih4oSK4pKi4pK84pOW44uM44uN446H446NLeOOj+OOk+OOrOOPhuOPieOPkuOPv++8p++9h10iLAogICAgICAgICAgICBIOiAiW0hoxKTEpcieyJ/KsOG0tOG4oi3huKvhupbihIst4oSO4pKj4pK94pOX44uM442x446QLeOOlOOPiuOPi+OPl++8qO+9iF0iLAogICAgICAgICAgICBJOiAiW0lpw4wtw4/DrC3Dr8SoLcSwxLLEs8ePx5DIiC3Ii+G0teG1ouG4rOG4reG7iC3hu4vigbHihJDihJHihLnihYjihaAt4oWj4oWlLeKFqOKFquKFq+KFsC3ihbPihbUt4oW44oW64oW74pKk4pK+4pOY442644+M44+V76yB76yD77yp772JXSIsCiAgICAgICAgICAgIEo6ICJbSmrEsi3EtceHLceMx7DKsuG0tuKFieKSpeKSv+KTmeKxvO+8qu+9il0iLAogICAgICAgICAgICBLOiAiW0trxLbEt8eox6nhtLfhtY/huLAt4bi14oSq4pKm4pOA4pOa446E446F446J446P446R446Y446e446i446m446q4464446+44+A44+G44+NLeOPj++8q++9i10iLAogICAgICAgICAgICBMOiAiW0xsxLktxYDHhy3Hicuh4bS44bi24bi34bi6LeG4veKEkuKEk+KEoeKFrOKFvOKSp+KTgeKTm+OLj+OOiOOOieOPkC3jj5Pjj5Xjj5bjj7/vrILvrITvvKzvvYxdIiwKICAgICAgICAgICAgTTogIltNbeG0ueG1kOG4vi3huYPihKDihKLihLPiha/ihb/ikqjik4Lik5zjjbct4425446D446G446O446S446W446ZLeOOqOOOq+OOs+OOt+OOueOOveOOv+OPgeOPguOPjuOPkOOPlC3jj5bjj5jjj5njj57jj5/vvK3vvY1dIiwKICAgICAgICAgICAgTjogIltObsORw7HFgy3FiceKLceMx7jHueG0uuG5hC3huYvigb/ihJXihJbikqnik4Pik53jjoHjjovjjprjjrHjjrXjjrvjj4zjj5HvvK7vvY5dIiwKICAgICAgICAgICAgTzogIltPb8K6w5Itw5bDsi3DtsWMLcWRxqDGoceRx5LHqseryIwtyI/Irsiv4bS84bWS4buMLeG7j+KCkuKEheKEluKEtOKSquKThOKTnuONteOPh+OPkuOPlu+8r++9j10iLAogICAgICAgICAgICBQOiAiW1Bw4bS+4bWW4bmULeG5l+KEmeKSq+KTheKTn+OJkOONseONtuOOgOOOiuOOqS3jjqzjjrDjjrTjjrrjj4vjj5ct44+a77yw772QXSIsCiAgICAgICAgICAgIFE6ICJbUXHihJrikqzik4bik6Djj4PvvLHvvZFdIiwKICAgICAgICAgICAgUjogIltScsWULcWZyJAtyJPKs+G0v+G1o+G5mC3huZvhuZ7huZ/igqjihJst4oSd4pKt4pOH4pOh44uN4420446tLeOOr+OPmuOPm++8su+9kl0iLAogICAgICAgICAgICBTOiAiW1NzxZotxaHFv8iYyJnLouG5oC3huaPigqjihIHihKDikq7ik4jik6Ljjqfjjqjjjq4t446z44+b44+c76yG77yz772TXSIsCiAgICAgICAgICAgIFQ6ICJbVHTFoi3FpciayJvhtYDhtZfhuaot4bmx4bqX4oSh4oSi4pKv4pOJ4pOj44mQ44uP446U44+P76yF76yG77y0772UXSIsCiAgICAgICAgICAgIFU6ICJbVXXDmS3DnMO5LcO8xagtxbPGr8awx5PHlMiULciX4bWB4bWY4bWk4bmyLeG5t+G7pC3hu6fihIbikrDik4rik6TjjbPjjbrvvLXvvZVdIiwKICAgICAgICAgICAgVjogIltWduG1m+G1peG5vC3hub/ihaMt4oWn4oWzLeKFt+KSseKTi+KTpeKxveOLjuONteOOtC3jjrnjj5zjj57vvLbvvZZdIiwKICAgICAgICAgICAgVzogIltXd8W0xbXKt+G1guG6gC3huonhupjikrLik4zik6bjjrot446/44+d77y3772XXSIsCiAgICAgICAgICAgIFg6ICJbWHjLo+G6ii3huo3igpPihLvihagt4oWr4oW4LeKFu+KSs+KTjeKTp+OPk++8uO+9mF0iLAogICAgICAgICAgICBZOiAiW1l5w53DvcO/xbYtxbjIssizyrjhuo7huo/hupnhu7It4bu54pK04pOO4pOo44+J77y5772ZXSIsCiAgICAgICAgICAgIFo6ICJbWnrFuS3FvsexLcez4ba74bqQLeG6leKEpOKEqOKSteKTj+KTqeOOkC3jjpTvvLrvvZpdIgogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGhpZ2h0bGlnaHQobykgewogICAgICAgICAgICB2YXIgcmVnZXg7CiAgICAgICAgICAgIG8gPSBfLm1peGluKHt9LCBkZWZhdWx0cywgbyk7CiAgICAgICAgICAgIGlmICghby5ub2RlIHx8ICFvLnBhdHRlcm4pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBvLnBhdHRlcm4gPSBfLmlzQXJyYXkoby5wYXR0ZXJuKSA/IG8ucGF0dGVybiA6IFtvLnBhdHRlcm5dOwogICAgICAgICAgICByZWdleCA9IGdldFJlZ2V4KG8ucGF0dGVybiwgby5jYXNlU2Vuc2l0aXZlLCBvLndvcmRzT25seSwgby5kaWFjcml0aWNJbnNlbnNpdGl2ZSk7CiAgICAgICAgICAgIHRyYXZlcnNlKG8ubm9kZSwgaGlnaHRsaWdodFRleHROb2RlKTsKICAgICAgICAgICAgZnVuY3Rpb24gaGlnaHRsaWdodFRleHROb2RlKHRleHROb2RlKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2gsIHBhdHRlcm5Ob2RlLCB3cmFwcGVyTm9kZTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaCA9IHJlZ2V4LmV4ZWModGV4dE5vZGUuZGF0YSkpIHsKICAgICAgICAgICAgICAgICAgICB3cmFwcGVyTm9kZSA9IGRvYy5jcmVhdGVFbGVtZW50KG8udGFnTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgby5jbGFzc05hbWUgJiYgKHdyYXBwZXJOb2RlLmNsYXNzTmFtZSA9IG8uY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuTm9kZSA9IHRleHROb2RlLnNwbGl0VGV4dChtYXRjaC5pbmRleCk7CiAgICAgICAgICAgICAgICAgICAgcGF0dGVybk5vZGUuc3BsaXRUZXh0KG1hdGNoWzBdLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgd3JhcHBlck5vZGUuYXBwZW5kQ2hpbGQocGF0dGVybk5vZGUuY2xvbmVOb2RlKHRydWUpKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0Tm9kZS5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZCh3cmFwcGVyTm9kZSwgcGF0dGVybk5vZGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuICEhbWF0Y2g7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gdHJhdmVyc2UoZWwsIGhpZ2h0bGlnaHRUZXh0Tm9kZSkgewogICAgICAgICAgICAgICAgdmFyIGNoaWxkTm9kZSwgVEVYVF9OT0RFX1RZUEUgPSAzOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbC5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY2hpbGROb2RlID0gZWwuY2hpbGROb2Rlc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGROb2RlLm5vZGVUeXBlID09PSBURVhUX05PREVfVFlQRSkgewogICAgICAgICAgICAgICAgICAgICAgICBpICs9IGhpZ2h0bGlnaHRUZXh0Tm9kZShjaGlsZE5vZGUpID8gMSA6IDA7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJhdmVyc2UoY2hpbGROb2RlLCBoaWdodGxpZ2h0VGV4dE5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gYWNjZW50X3JlcGxhY2VyKGNocikgewogICAgICAgICAgICByZXR1cm4gYWNjZW50ZWRbY2hyLnRvVXBwZXJDYXNlKCldIHx8IGNocjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UmVnZXgocGF0dGVybnMsIGNhc2VTZW5zaXRpdmUsIHdvcmRzT25seSwgZGlhY3JpdGljSW5zZW5zaXRpdmUpIHsKICAgICAgICAgICAgdmFyIGVzY2FwZWRQYXR0ZXJucyA9IFtdLCByZWdleFN0cjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHBhdHRlcm5zLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgZXNjYXBlZFdvcmQgPSBfLmVzY2FwZVJlZ0V4Q2hhcnMocGF0dGVybnNbaV0pOwogICAgICAgICAgICAgICAgaWYgKGRpYWNyaXRpY0luc2Vuc2l0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgZXNjYXBlZFdvcmQgPSBlc2NhcGVkV29yZC5yZXBsYWNlKC9cUy9nLCBhY2NlbnRfcmVwbGFjZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXNjYXBlZFBhdHRlcm5zLnB1c2goZXNjYXBlZFdvcmQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlZ2V4U3RyID0gd29yZHNPbmx5ID8gIlxcYigiICsgZXNjYXBlZFBhdHRlcm5zLmpvaW4oInwiKSArICIpXFxiIiA6ICIoIiArIGVzY2FwZWRQYXR0ZXJucy5qb2luKCJ8IikgKyAiKSI7CiAgICAgICAgICAgIHJldHVybiBjYXNlU2Vuc2l0aXZlID8gbmV3IFJlZ0V4cChyZWdleFN0cikgOiBuZXcgUmVnRXhwKHJlZ2V4U3RyLCAiaSIpOwogICAgICAgIH0KICAgIH0od2luZG93LmRvY3VtZW50KTsKICAgIHZhciBJbnB1dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIHNwZWNpYWxLZXlDb2RlTWFwOwogICAgICAgIHNwZWNpYWxLZXlDb2RlTWFwID0gewogICAgICAgICAgICA5OiAidGFiIiwKICAgICAgICAgICAgMjc6ICJlc2MiLAogICAgICAgICAgICAzNzogImxlZnQiLAogICAgICAgICAgICAzOTogInJpZ2h0IiwKICAgICAgICAgICAgMTM6ICJlbnRlciIsCiAgICAgICAgICAgIDM4OiAidXAiLAogICAgICAgICAgICA0MDogImRvd24iCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBJbnB1dChvLCB3d3cpIHsKICAgICAgICAgICAgdmFyIGlkOwogICAgICAgICAgICBvID0gbyB8fCB7fTsKICAgICAgICAgICAgaWYgKCFvLmlucHV0KSB7CiAgICAgICAgICAgICAgICAkLmVycm9yKCJpbnB1dCBpcyBtaXNzaW5nIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd3d3Lm1peGluKHRoaXMpOwogICAgICAgICAgICB0aGlzLiRoaW50ID0gJChvLmhpbnQpOwogICAgICAgICAgICB0aGlzLiRpbnB1dCA9ICQoby5pbnB1dCk7CiAgICAgICAgICAgIHRoaXMuJG1lbnUgPSAkKG8ubWVudSk7CiAgICAgICAgICAgIGlkID0gdGhpcy4kaW5wdXQuYXR0cigiaWQiKSB8fCBfLmd1aWQoKTsKICAgICAgICAgICAgdGhpcy4kbWVudS5hdHRyKCJpZCIsIGlkICsgIl9saXN0Ym94Iik7CiAgICAgICAgICAgIHRoaXMuJGhpbnQuYXR0cih7CiAgICAgICAgICAgICAgICAiYXJpYS1oaWRkZW4iOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLiRpbnB1dC5hdHRyKHsKICAgICAgICAgICAgICAgICJhcmlhLW93bnMiOiBpZCArICJfbGlzdGJveCIsCiAgICAgICAgICAgICAgICByb2xlOiAiY29tYm9ib3giLAogICAgICAgICAgICAgICAgImFyaWEtYXV0b2NvbXBsZXRlIjogImxpc3QiLAogICAgICAgICAgICAgICAgImFyaWEtZXhwYW5kZWQiOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5xdWVyeSA9IHRoaXMuJGlucHV0LnZhbCgpOwogICAgICAgICAgICB0aGlzLnF1ZXJ5V2hlbkZvY3VzZWQgPSB0aGlzLmhhc0ZvY3VzKCkgPyB0aGlzLnF1ZXJ5IDogbnVsbDsKICAgICAgICAgICAgdGhpcy4kb3ZlcmZsb3dIZWxwZXIgPSBidWlsZE92ZXJmbG93SGVscGVyKHRoaXMuJGlucHV0KTsKICAgICAgICAgICAgdGhpcy5fY2hlY2tMYW5ndWFnZURpcmVjdGlvbigpOwogICAgICAgICAgICBpZiAodGhpcy4kaGludC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SGludCA9IHRoaXMuZ2V0SGludCA9IHRoaXMuY2xlYXJIaW50ID0gdGhpcy5jbGVhckhpbnRJZkludmFsaWQgPSBfLm5vb3A7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5vblN5bmMoImN1cnNvcmNoYW5nZSIsIHRoaXMuX3VwZGF0ZURlc2NlbmRlbnQpOwogICAgICAgIH0KICAgICAgICBJbnB1dC5ub3JtYWxpemVRdWVyeSA9IGZ1bmN0aW9uIChzdHIpIHsKICAgICAgICAgICAgcmV0dXJuIF8udG9TdHIoc3RyKS5yZXBsYWNlKC9eXHMqL2csICIiKS5yZXBsYWNlKC9cc3syLH0vZywgIiAiKTsKICAgICAgICB9OwogICAgICAgIF8ubWl4aW4oSW5wdXQucHJvdG90eXBlLCBFdmVudEVtaXR0ZXIsIHsKICAgICAgICAgICAgX29uQmx1cjogZnVuY3Rpb24gb25CbHVyKCkgewogICAgICAgICAgICAgICAgdGhpcy5yZXNldElucHV0VmFsdWUoKTsKICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcigiYmx1cnJlZCIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25Gb2N1czogZnVuY3Rpb24gb25Gb2N1cygpIHsKICAgICAgICAgICAgICAgIHRoaXMucXVlcnlXaGVuRm9jdXNlZCA9IHRoaXMucXVlcnk7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoImZvY3VzZWQiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uS2V5ZG93bjogZnVuY3Rpb24gb25LZXlkb3duKCRlKSB7CiAgICAgICAgICAgICAgICB2YXIga2V5TmFtZSA9IHNwZWNpYWxLZXlDb2RlTWFwWyRlLndoaWNoIHx8ICRlLmtleUNvZGVdOwogICAgICAgICAgICAgICAgdGhpcy5fbWFuYWdlUHJldmVudERlZmF1bHQoa2V5TmFtZSwgJGUpOwogICAgICAgICAgICAgICAgaWYgKGtleU5hbWUgJiYgdGhpcy5fc2hvdWxkVHJpZ2dlcihrZXlOYW1lLCAkZSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoa2V5TmFtZSArICJLZXllZCIsICRlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uSW5wdXQ6IGZ1bmN0aW9uIG9uSW5wdXQoKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zZXRRdWVyeSh0aGlzLmdldElucHV0VmFsdWUoKSk7CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFySGludElmSW52YWxpZCgpOwogICAgICAgICAgICAgICAgdGhpcy5fY2hlY2tMYW5ndWFnZURpcmVjdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfbWFuYWdlUHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uIG1hbmFnZVByZXZlbnREZWZhdWx0KGtleU5hbWUsICRlKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldmVudERlZmF1bHQ7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGtleU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICJ1cCI6CiAgICAgICAgICAgICAgICAgICAgY2FzZSAiZG93biI6CiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0ID0gIXdpdGhNb2RpZmllcigkZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICBwcmV2ZW50RGVmYXVsdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQgJiYgJGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX3Nob3VsZFRyaWdnZXI6IGZ1bmN0aW9uIHNob3VsZFRyaWdnZXIoa2V5TmFtZSwgJGUpIHsKICAgICAgICAgICAgICAgIHZhciB0cmlnZ2VyOwogICAgICAgICAgICAgICAgc3dpdGNoIChrZXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAidGFiIjoKICAgICAgICAgICAgICAgICAgICAgICAgdHJpZ2dlciA9ICF3aXRoTW9kaWZpZXIoJGUpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgdHJpZ2dlciA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJpZ2dlcjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2NoZWNrTGFuZ3VhZ2VEaXJlY3Rpb246IGZ1bmN0aW9uIGNoZWNrTGFuZ3VhZ2VEaXJlY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgZGlyID0gKHRoaXMuJGlucHV0LmNzcygiZGlyZWN0aW9uIikgfHwgImx0ciIpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kaXIgIT09IGRpcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZGlyID0gZGlyOwogICAgICAgICAgICAgICAgICAgIHRoaXMuJGhpbnQuYXR0cigiZGlyIiwgZGlyKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoImxhbmdEaXJDaGFuZ2VkIiwgZGlyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgX3NldFF1ZXJ5OiBmdW5jdGlvbiBzZXRRdWVyeSh2YWwsIHNpbGVudCkgewogICAgICAgICAgICAgICAgdmFyIGFyZUVxdWl2YWxlbnQsIGhhc0RpZmZlcmVudFdoaXRlc3BhY2U7CiAgICAgICAgICAgICAgICBhcmVFcXVpdmFsZW50ID0gYXJlUXVlcmllc0VxdWl2YWxlbnQodmFsLCB0aGlzLnF1ZXJ5KTsKICAgICAgICAgICAgICAgIGhhc0RpZmZlcmVudFdoaXRlc3BhY2UgPSBhcmVFcXVpdmFsZW50ID8gdGhpcy5xdWVyeS5sZW5ndGggIT09IHZhbC5sZW5ndGggOiBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMucXVlcnkgPSB2YWw7CiAgICAgICAgICAgICAgICBpZiAoIXNpbGVudCAmJiAhYXJlRXF1aXZhbGVudCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcigicXVlcnlDaGFuZ2VkIiwgdGhpcy5xdWVyeSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFzaWxlbnQgJiYgaGFzRGlmZmVyZW50V2hpdGVzcGFjZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcigid2hpdGVzcGFjZUNoYW5nZWQiLCB0aGlzLnF1ZXJ5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgX3VwZGF0ZURlc2NlbmRlbnQ6IGZ1bmN0aW9uIHVwZGF0ZURlc2NlbmRlbnQoZXZlbnQsIGlkKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRpbnB1dC5hdHRyKCJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiLCBpZCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJpbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywgb25CbHVyLCBvbkZvY3VzLCBvbktleWRvd24sIG9uSW5wdXQ7CiAgICAgICAgICAgICAgICBvbkJsdXIgPSBfLmJpbmQodGhpcy5fb25CbHVyLCB0aGlzKTsKICAgICAgICAgICAgICAgIG9uRm9jdXMgPSBfLmJpbmQodGhpcy5fb25Gb2N1cywgdGhpcyk7CiAgICAgICAgICAgICAgICBvbktleWRvd24gPSBfLmJpbmQodGhpcy5fb25LZXlkb3duLCB0aGlzKTsKICAgICAgICAgICAgICAgIG9uSW5wdXQgPSBfLmJpbmQodGhpcy5fb25JbnB1dCwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLiRpbnB1dC5vbigiYmx1ci50dCIsIG9uQmx1cikub24oImZvY3VzLnR0Iiwgb25Gb2N1cykub24oImtleWRvd24udHQiLCBvbktleWRvd24pOwogICAgICAgICAgICAgICAgaWYgKCFfLmlzTXNpZSgpIHx8IF8uaXNNc2llKCkgPiA5KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kaW5wdXQub24oImlucHV0LnR0Iiwgb25JbnB1dCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuJGlucHV0Lm9uKCJrZXlkb3duLnR0IGtleXByZXNzLnR0IGN1dC50dCBwYXN0ZS50dCIsIGZ1bmN0aW9uICgkZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BlY2lhbEtleUNvZGVNYXBbJGUud2hpY2ggfHwgJGUua2V5Q29kZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBfLmRlZmVyKF8uYmluZCh0aGF0Ll9vbklucHV0LCB0aGF0LCAkZSkpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZvY3VzOiBmdW5jdGlvbiBmb2N1cygpIHsKICAgICAgICAgICAgICAgIHRoaXMuJGlucHV0LmZvY3VzKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJsdXI6IGZ1bmN0aW9uIGJsdXIoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRpbnB1dC5ibHVyKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldExhbmdEaXI6IGZ1bmN0aW9uIGdldExhbmdEaXIoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kaXI7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldFF1ZXJ5OiBmdW5jdGlvbiBnZXRRdWVyeSgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnF1ZXJ5IHx8ICIiOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRRdWVyeTogZnVuY3Rpb24gc2V0UXVlcnkodmFsLCBzaWxlbnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SW5wdXRWYWx1ZSh2YWwpOwogICAgICAgICAgICAgICAgdGhpcy5fc2V0UXVlcnkodmFsLCBzaWxlbnQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBoYXNRdWVyeUNoYW5nZWRTaW5jZUxhc3RGb2N1czogZnVuY3Rpb24gaGFzUXVlcnlDaGFuZ2VkU2luY2VMYXN0Rm9jdXMoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5xdWVyeSAhPT0gdGhpcy5xdWVyeVdoZW5Gb2N1c2VkOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXRJbnB1dFZhbHVlOiBmdW5jdGlvbiBnZXRJbnB1dFZhbHVlKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJGlucHV0LnZhbCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRJbnB1dFZhbHVlOiBmdW5jdGlvbiBzZXRJbnB1dFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRpbnB1dC52YWwodmFsdWUpOwogICAgICAgICAgICAgICAgdGhpcy5jbGVhckhpbnRJZkludmFsaWQoKTsKICAgICAgICAgICAgICAgIHRoaXMuX2NoZWNrTGFuZ3VhZ2VEaXJlY3Rpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVzZXRJbnB1dFZhbHVlOiBmdW5jdGlvbiByZXNldElucHV0VmFsdWUoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldElucHV0VmFsdWUodGhpcy5xdWVyeSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldEhpbnQ6IGZ1bmN0aW9uIGdldEhpbnQoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kaGludC52YWwoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0SGludDogZnVuY3Rpb24gc2V0SGludCh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy4kaGludC52YWwodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjbGVhckhpbnQ6IGZ1bmN0aW9uIGNsZWFySGludCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SGludCgiIik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsZWFySGludElmSW52YWxpZDogZnVuY3Rpb24gY2xlYXJIaW50SWZJbnZhbGlkKCkgewogICAgICAgICAgICAgICAgdmFyIHZhbCwgaGludCwgdmFsSXNQcmVmaXhPZkhpbnQsIGlzVmFsaWQ7CiAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLmdldElucHV0VmFsdWUoKTsKICAgICAgICAgICAgICAgIGhpbnQgPSB0aGlzLmdldEhpbnQoKTsKICAgICAgICAgICAgICAgIHZhbElzUHJlZml4T2ZIaW50ID0gdmFsICE9PSBoaW50ICYmIGhpbnQuaW5kZXhPZih2YWwpID09PSAwOwogICAgICAgICAgICAgICAgaXNWYWxpZCA9IHZhbCAhPT0gIiIgJiYgdmFsSXNQcmVmaXhPZkhpbnQgJiYgIXRoaXMuaGFzT3ZlcmZsb3coKTsKICAgICAgICAgICAgICAgICFpc1ZhbGlkICYmIHRoaXMuY2xlYXJIaW50KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGhhc0ZvY3VzOiBmdW5jdGlvbiBoYXNGb2N1cygpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRpbnB1dC5pcygiOmZvY3VzIik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGhhc092ZXJmbG93OiBmdW5jdGlvbiBoYXNPdmVyZmxvdygpIHsKICAgICAgICAgICAgICAgIHZhciBjb25zdHJhaW50ID0gdGhpcy4kaW5wdXQud2lkdGgoKSAtIDI7CiAgICAgICAgICAgICAgICB0aGlzLiRvdmVyZmxvd0hlbHBlci50ZXh0KHRoaXMuZ2V0SW5wdXRWYWx1ZSgpKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRvdmVyZmxvd0hlbHBlci53aWR0aCgpID49IGNvbnN0cmFpbnQ7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzQ3Vyc29yQXRFbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZUxlbmd0aCwgc2VsZWN0aW9uU3RhcnQsIHJhbmdlOwogICAgICAgICAgICAgICAgdmFsdWVMZW5ndGggPSB0aGlzLiRpbnB1dC52YWwoKS5sZW5ndGg7CiAgICAgICAgICAgICAgICBzZWxlY3Rpb25TdGFydCA9IHRoaXMuJGlucHV0WzBdLnNlbGVjdGlvblN0YXJ0OwogICAgICAgICAgICAgICAgaWYgKF8uaXNOdW1iZXIoc2VsZWN0aW9uU3RhcnQpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGVjdGlvblN0YXJ0ID09PSB2YWx1ZUxlbmd0aDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuc2VsZWN0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgcmFuZ2UgPSBkb2N1bWVudC5zZWxlY3Rpb24uY3JlYXRlUmFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICByYW5nZS5tb3ZlU3RhcnQoImNoYXJhY3RlciIsIC12YWx1ZUxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlTGVuZ3RoID09PSByYW5nZS50ZXh0Lmxlbmd0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICAgICAgICAgICAgdGhpcy4kaGludC5vZmYoIi50dCIpOwogICAgICAgICAgICAgICAgdGhpcy4kaW5wdXQub2ZmKCIudHQiKTsKICAgICAgICAgICAgICAgIHRoaXMuJG92ZXJmbG93SGVscGVyLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgdGhpcy4kaGludCA9IHRoaXMuJGlucHV0ID0gdGhpcy4kb3ZlcmZsb3dIZWxwZXIgPSAkKCI8ZGl2PiIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRBcmlhRXhwYW5kZWQ6IGZ1bmN0aW9uIHNldEFyaWFFeHBhbmRlZCh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy4kaW5wdXQuYXR0cigiYXJpYS1leHBhbmRlZCIsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBJbnB1dDsKICAgICAgICBmdW5jdGlvbiBidWlsZE92ZXJmbG93SGVscGVyKCRpbnB1dCkgewogICAgICAgICAgICByZXR1cm4gJCgnPHByZSBhcmlhLWhpZGRlbj0idHJ1ZSI+PC9wcmU+JykuY3NzKHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgICAgICAgICAgdmlzaWJpbGl0eTogImhpZGRlbiIsCiAgICAgICAgICAgICAgICB3aGl0ZVNwYWNlOiAicHJlIiwKICAgICAgICAgICAgICAgIGZvbnRGYW1pbHk6ICRpbnB1dC5jc3MoImZvbnQtZmFtaWx5IiksCiAgICAgICAgICAgICAgICBmb250U2l6ZTogJGlucHV0LmNzcygiZm9udC1zaXplIiksCiAgICAgICAgICAgICAgICBmb250U3R5bGU6ICRpbnB1dC5jc3MoImZvbnQtc3R5bGUiKSwKICAgICAgICAgICAgICAgIGZvbnRWYXJpYW50OiAkaW5wdXQuY3NzKCJmb250LXZhcmlhbnQiKSwKICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6ICRpbnB1dC5jc3MoImZvbnQtd2VpZ2h0IiksCiAgICAgICAgICAgICAgICB3b3JkU3BhY2luZzogJGlucHV0LmNzcygid29yZC1zcGFjaW5nIiksCiAgICAgICAgICAgICAgICBsZXR0ZXJTcGFjaW5nOiAkaW5wdXQuY3NzKCJsZXR0ZXItc3BhY2luZyIpLAogICAgICAgICAgICAgICAgdGV4dEluZGVudDogJGlucHV0LmNzcygidGV4dC1pbmRlbnQiKSwKICAgICAgICAgICAgICAgIHRleHRSZW5kZXJpbmc6ICRpbnB1dC5jc3MoInRleHQtcmVuZGVyaW5nIiksCiAgICAgICAgICAgICAgICB0ZXh0VHJhbnNmb3JtOiAkaW5wdXQuY3NzKCJ0ZXh0LXRyYW5zZm9ybSIpCiAgICAgICAgICAgIH0pLmluc2VydEFmdGVyKCRpbnB1dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFyZVF1ZXJpZXNFcXVpdmFsZW50KGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIElucHV0Lm5vcm1hbGl6ZVF1ZXJ5KGEpID09PSBJbnB1dC5ub3JtYWxpemVRdWVyeShiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2l0aE1vZGlmaWVyKCRlKSB7CiAgICAgICAgICAgIHJldHVybiAkZS5hbHRLZXkgfHwgJGUuY3RybEtleSB8fCAkZS5tZXRhS2V5IHx8ICRlLnNoaWZ0S2V5OwogICAgICAgIH0KICAgIH0oKTsKICAgIHZhciBEYXRhc2V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIga2V5cywgbmFtZUdlbmVyYXRvcjsKICAgICAgICBrZXlzID0gewogICAgICAgICAgICBkYXRhc2V0OiAidHQtc2VsZWN0YWJsZS1kYXRhc2V0IiwKICAgICAgICAgICAgdmFsOiAidHQtc2VsZWN0YWJsZS1kaXNwbGF5IiwKICAgICAgICAgICAgb2JqOiAidHQtc2VsZWN0YWJsZS1vYmplY3QiCiAgICAgICAgfTsKICAgICAgICBuYW1lR2VuZXJhdG9yID0gXy5nZXRJZEdlbmVyYXRvcigpOwogICAgICAgIGZ1bmN0aW9uIERhdGFzZXQobywgd3d3KSB7CiAgICAgICAgICAgIG8gPSBvIHx8IHt9OwogICAgICAgICAgICBvLnRlbXBsYXRlcyA9IG8udGVtcGxhdGVzIHx8IHt9OwogICAgICAgICAgICBvLnRlbXBsYXRlcy5ub3RGb3VuZCA9IG8udGVtcGxhdGVzLm5vdEZvdW5kIHx8IG8udGVtcGxhdGVzLmVtcHR5OwogICAgICAgICAgICBpZiAoIW8uc291cmNlKSB7CiAgICAgICAgICAgICAgICAkLmVycm9yKCJtaXNzaW5nIHNvdXJjZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghby5ub2RlKSB7CiAgICAgICAgICAgICAgICAkLmVycm9yKCJtaXNzaW5nIG5vZGUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoby5uYW1lICYmICFpc1ZhbGlkTmFtZShvLm5hbWUpKSB7CiAgICAgICAgICAgICAgICAkLmVycm9yKCJpbnZhbGlkIGRhdGFzZXQgbmFtZTogIiArIG8ubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd3d3Lm1peGluKHRoaXMpOwogICAgICAgICAgICB0aGlzLmhpZ2hsaWdodCA9ICEhby5oaWdobGlnaHQ7CiAgICAgICAgICAgIHRoaXMubmFtZSA9IF8udG9TdHIoby5uYW1lIHx8IG5hbWVHZW5lcmF0b3IoKSk7CiAgICAgICAgICAgIHRoaXMubGltaXQgPSBvLmxpbWl0IHx8IDU7CiAgICAgICAgICAgIHRoaXMuZGlzcGxheUZuID0gZ2V0RGlzcGxheUZuKG8uZGlzcGxheSB8fCBvLmRpc3BsYXlLZXkpOwogICAgICAgICAgICB0aGlzLnRlbXBsYXRlcyA9IGdldFRlbXBsYXRlcyhvLnRlbXBsYXRlcywgdGhpcy5kaXNwbGF5Rm4pOwogICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG8uc291cmNlLl9fdHRBZGFwdGVyID8gby5zb3VyY2UuX190dEFkYXB0ZXIoKSA6IG8uc291cmNlOwogICAgICAgICAgICB0aGlzLmFzeW5jID0gXy5pc1VuZGVmaW5lZChvLmFzeW5jKSA/IHRoaXMuc291cmNlLmxlbmd0aCA+IDIgOiAhIW8uYXN5bmM7CiAgICAgICAgICAgIHRoaXMuX3Jlc2V0TGFzdFN1Z2dlc3Rpb24oKTsKICAgICAgICAgICAgdGhpcy4kZWwgPSAkKG8ubm9kZSkuYXR0cigicm9sZSIsICJwcmVzZW50YXRpb24iKS5hZGRDbGFzcyh0aGlzLmNsYXNzZXMuZGF0YXNldCkuYWRkQ2xhc3ModGhpcy5jbGFzc2VzLmRhdGFzZXQgKyAiLSIgKyB0aGlzLm5hbWUpOwogICAgICAgIH0KICAgICAgICBEYXRhc2V0LmV4dHJhY3REYXRhID0gZnVuY3Rpb24gZXh0cmFjdERhdGEoZWwpIHsKICAgICAgICAgICAgdmFyICRlbCA9ICQoZWwpOwogICAgICAgICAgICBpZiAoJGVsLmRhdGEoa2V5cy5vYmopKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIGRhdGFzZXQ6ICRlbC5kYXRhKGtleXMuZGF0YXNldCkgfHwgIiIsCiAgICAgICAgICAgICAgICAgICAgdmFsOiAkZWwuZGF0YShrZXlzLnZhbCkgfHwgIiIsCiAgICAgICAgICAgICAgICAgICAgb2JqOiAkZWwuZGF0YShrZXlzLm9iaikgfHwgbnVsbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIF8ubWl4aW4oRGF0YXNldC5wcm90b3R5cGUsIEV2ZW50RW1pdHRlciwgewogICAgICAgICAgICBfb3ZlcndyaXRlOiBmdW5jdGlvbiBvdmVyd3JpdGUocXVlcnksIHN1Z2dlc3Rpb25zKSB7CiAgICAgICAgICAgICAgICBzdWdnZXN0aW9ucyA9IHN1Z2dlc3Rpb25zIHx8IFtdOwogICAgICAgICAgICAgICAgaWYgKHN1Z2dlc3Rpb25zLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbmRlclN1Z2dlc3Rpb25zKHF1ZXJ5LCBzdWdnZXN0aW9ucyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYXN5bmMgJiYgdGhpcy50ZW1wbGF0ZXMucGVuZGluZykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbmRlclBlbmRpbmcocXVlcnkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5hc3luYyAmJiB0aGlzLnRlbXBsYXRlcy5ub3RGb3VuZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbmRlck5vdEZvdW5kKHF1ZXJ5KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZW1wdHkoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlcigicmVuZGVyZWQiLCBzdWdnZXN0aW9ucywgZmFsc2UsIHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9hcHBlbmQ6IGZ1bmN0aW9uIGFwcGVuZChxdWVyeSwgc3VnZ2VzdGlvbnMpIHsKICAgICAgICAgICAgICAgIHN1Z2dlc3Rpb25zID0gc3VnZ2VzdGlvbnMgfHwgW107CiAgICAgICAgICAgICAgICBpZiAoc3VnZ2VzdGlvbnMubGVuZ3RoICYmIHRoaXMuJGxhc3RTdWdnZXN0aW9uLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FwcGVuZFN1Z2dlc3Rpb25zKHF1ZXJ5LCBzdWdnZXN0aW9ucyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN1Z2dlc3Rpb25zLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlbmRlclN1Z2dlc3Rpb25zKHF1ZXJ5LCBzdWdnZXN0aW9ucyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLiRsYXN0U3VnZ2VzdGlvbi5sZW5ndGggJiYgdGhpcy50ZW1wbGF0ZXMubm90Rm91bmQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW5kZXJOb3RGb3VuZChxdWVyeSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoInJlbmRlcmVkIiwgc3VnZ2VzdGlvbnMsIHRydWUsIHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9yZW5kZXJTdWdnZXN0aW9uczogZnVuY3Rpb24gcmVuZGVyU3VnZ2VzdGlvbnMocXVlcnksIHN1Z2dlc3Rpb25zKSB7CiAgICAgICAgICAgICAgICB2YXIgJGZyYWdtZW50OwogICAgICAgICAgICAgICAgJGZyYWdtZW50ID0gdGhpcy5fZ2V0U3VnZ2VzdGlvbnNGcmFnbWVudChxdWVyeSwgc3VnZ2VzdGlvbnMpOwogICAgICAgICAgICAgICAgdGhpcy4kbGFzdFN1Z2dlc3Rpb24gPSAkZnJhZ21lbnQuY2hpbGRyZW4oKS5sYXN0KCk7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC5odG1sKCRmcmFnbWVudCkucHJlcGVuZCh0aGlzLl9nZXRIZWFkZXIocXVlcnksIHN1Z2dlc3Rpb25zKSkuYXBwZW5kKHRoaXMuX2dldEZvb3RlcihxdWVyeSwgc3VnZ2VzdGlvbnMpKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2FwcGVuZFN1Z2dlc3Rpb25zOiBmdW5jdGlvbiBhcHBlbmRTdWdnZXN0aW9ucyhxdWVyeSwgc3VnZ2VzdGlvbnMpIHsKICAgICAgICAgICAgICAgIHZhciAkZnJhZ21lbnQsICRsYXN0U3VnZ2VzdGlvbjsKICAgICAgICAgICAgICAgICRmcmFnbWVudCA9IHRoaXMuX2dldFN1Z2dlc3Rpb25zRnJhZ21lbnQocXVlcnksIHN1Z2dlc3Rpb25zKTsKICAgICAgICAgICAgICAgICRsYXN0U3VnZ2VzdGlvbiA9ICRmcmFnbWVudC5jaGlsZHJlbigpLmxhc3QoKTsKICAgICAgICAgICAgICAgIHRoaXMuJGxhc3RTdWdnZXN0aW9uLmFmdGVyKCRmcmFnbWVudCk7CiAgICAgICAgICAgICAgICB0aGlzLiRsYXN0U3VnZ2VzdGlvbiA9ICRsYXN0U3VnZ2VzdGlvbjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX3JlbmRlclBlbmRpbmc6IGZ1bmN0aW9uIHJlbmRlclBlbmRpbmcocXVlcnkpIHsKICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGVzLnBlbmRpbmc7CiAgICAgICAgICAgICAgICB0aGlzLl9yZXNldExhc3RTdWdnZXN0aW9uKCk7CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZSAmJiB0aGlzLiRlbC5odG1sKHRlbXBsYXRlKHsKICAgICAgICAgICAgICAgICAgICBxdWVyeTogcXVlcnksCiAgICAgICAgICAgICAgICAgICAgZGF0YXNldDogdGhpcy5uYW1lCiAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9yZW5kZXJOb3RGb3VuZDogZnVuY3Rpb24gcmVuZGVyTm90Rm91bmQocXVlcnkpIHsKICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGVzLm5vdEZvdW5kOwogICAgICAgICAgICAgICAgdGhpcy5fcmVzZXRMYXN0U3VnZ2VzdGlvbigpOwogICAgICAgICAgICAgICAgdGVtcGxhdGUgJiYgdGhpcy4kZWwuaHRtbCh0ZW1wbGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgcXVlcnk6IHF1ZXJ5LAogICAgICAgICAgICAgICAgICAgIGRhdGFzZXQ6IHRoaXMubmFtZQogICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfZW1wdHk6IGZ1bmN0aW9uIGVtcHR5KCkgewogICAgICAgICAgICAgICAgdGhpcy4kZWwuZW1wdHkoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3Jlc2V0TGFzdFN1Z2dlc3Rpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2dldFN1Z2dlc3Rpb25zRnJhZ21lbnQ6IGZ1bmN0aW9uIGdldFN1Z2dlc3Rpb25zRnJhZ21lbnQocXVlcnksIHN1Z2dlc3Rpb25zKSB7CiAgICAgICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsIGZyYWdtZW50OwogICAgICAgICAgICAgICAgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgICAgICAgICAgICBfLmVhY2goc3VnZ2VzdGlvbnMsIGZ1bmN0aW9uIGdldFN1Z2dlc3Rpb25Ob2RlKHN1Z2dlc3Rpb24pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgJGVsLCBjb250ZXh0OwogICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSB0aGF0Ll9pbmplY3RRdWVyeShxdWVyeSwgc3VnZ2VzdGlvbik7CiAgICAgICAgICAgICAgICAgICAgJGVsID0gJCh0aGF0LnRlbXBsYXRlcy5zdWdnZXN0aW9uKGNvbnRleHQpKS5kYXRhKGtleXMuZGF0YXNldCwgdGhhdC5uYW1lKS5kYXRhKGtleXMub2JqLCBzdWdnZXN0aW9uKS5kYXRhKGtleXMudmFsLCB0aGF0LmRpc3BsYXlGbihzdWdnZXN0aW9uKSkuYWRkQ2xhc3ModGhhdC5jbGFzc2VzLnN1Z2dlc3Rpb24gKyAiICIgKyB0aGF0LmNsYXNzZXMuc2VsZWN0YWJsZSk7CiAgICAgICAgICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoJGVsWzBdKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy5oaWdobGlnaHQgJiYgaGlnaGxpZ2h0KHsKICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6IHRoaXMuY2xhc3Nlcy5oaWdobGlnaHQsCiAgICAgICAgICAgICAgICAgICAgbm9kZTogZnJhZ21lbnQsCiAgICAgICAgICAgICAgICAgICAgcGF0dGVybjogcXVlcnkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuICQoZnJhZ21lbnQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfZ2V0Rm9vdGVyOiBmdW5jdGlvbiBnZXRGb290ZXIocXVlcnksIHN1Z2dlc3Rpb25zKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy50ZW1wbGF0ZXMuZm9vdGVyID8gdGhpcy50ZW1wbGF0ZXMuZm9vdGVyKHsKICAgICAgICAgICAgICAgICAgICBxdWVyeTogcXVlcnksCiAgICAgICAgICAgICAgICAgICAgc3VnZ2VzdGlvbnM6IHN1Z2dlc3Rpb25zLAogICAgICAgICAgICAgICAgICAgIGRhdGFzZXQ6IHRoaXMubmFtZQogICAgICAgICAgICAgICAgfSkgOiBudWxsOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfZ2V0SGVhZGVyOiBmdW5jdGlvbiBnZXRIZWFkZXIocXVlcnksIHN1Z2dlc3Rpb25zKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy50ZW1wbGF0ZXMuaGVhZGVyID8gdGhpcy50ZW1wbGF0ZXMuaGVhZGVyKHsKICAgICAgICAgICAgICAgICAgICBxdWVyeTogcXVlcnksCiAgICAgICAgICAgICAgICAgICAgc3VnZ2VzdGlvbnM6IHN1Z2dlc3Rpb25zLAogICAgICAgICAgICAgICAgICAgIGRhdGFzZXQ6IHRoaXMubmFtZQogICAgICAgICAgICAgICAgfSkgOiBudWxsOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfcmVzZXRMYXN0U3VnZ2VzdGlvbjogZnVuY3Rpb24gcmVzZXRMYXN0U3VnZ2VzdGlvbigpIHsKICAgICAgICAgICAgICAgIHRoaXMuJGxhc3RTdWdnZXN0aW9uID0gJCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfaW5qZWN0UXVlcnk6IGZ1bmN0aW9uIGluamVjdFF1ZXJ5KHF1ZXJ5LCBvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiBfLmlzT2JqZWN0KG9iaikgPyBfLm1peGluKHsKICAgICAgICAgICAgICAgICAgICBfcXVlcnk6IHF1ZXJ5CiAgICAgICAgICAgICAgICB9LCBvYmopIDogb2JqOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShxdWVyeSkgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBjYW5jZWxlZCA9IGZhbHNlLCBzeW5jQ2FsbGVkID0gZmFsc2UsIHJlbmRlcmVkID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuY2FuY2VsKCk7CiAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbCA9IGZ1bmN0aW9uIGNhbmNlbCgpIHsKICAgICAgICAgICAgICAgICAgICBjYW5jZWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5jYW5jZWwgPSAkLm5vb3A7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5hc3luYyAmJiB0aGF0LnRyaWdnZXIoImFzeW5jQ2FuY2VsZWQiLCBxdWVyeSwgdGhhdC5uYW1lKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0aGlzLnNvdXJjZShxdWVyeSwgc3luYywgYXN5bmMpOwogICAgICAgICAgICAgICAgIXN5bmNDYWxsZWQgJiYgc3luYyhbXSk7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzeW5jKHN1Z2dlc3Rpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN5bmNDYWxsZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzeW5jQ2FsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBzdWdnZXN0aW9ucyA9IChzdWdnZXN0aW9ucyB8fCBbXSkuc2xpY2UoMCwgdGhhdC5saW1pdCk7CiAgICAgICAgICAgICAgICAgICAgcmVuZGVyZWQgPSBzdWdnZXN0aW9ucy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5fb3ZlcndyaXRlKHF1ZXJ5LCBzdWdnZXN0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlcmVkIDwgdGhhdC5saW1pdCAmJiB0aGF0LmFzeW5jKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudHJpZ2dlcigiYXN5bmNSZXF1ZXN0ZWQiLCBxdWVyeSwgdGhhdC5uYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhc3luYyhzdWdnZXN0aW9ucykgewogICAgICAgICAgICAgICAgICAgIHN1Z2dlc3Rpb25zID0gc3VnZ2VzdGlvbnMgfHwgW107CiAgICAgICAgICAgICAgICAgICAgaWYgKCFjYW5jZWxlZCAmJiByZW5kZXJlZCA8IHRoYXQubGltaXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5jYW5jZWwgPSAkLm5vb3A7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZHggPSBNYXRoLmFicyhyZW5kZXJlZCAtIHRoYXQubGltaXQpOwogICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJlZCArPSBpZHg7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuX2FwcGVuZChxdWVyeSwgc3VnZ2VzdGlvbnMuc2xpY2UoMCwgaWR4KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuYXN5bmMgJiYgdGhhdC50cmlnZ2VyKCJhc3luY1JlY2VpdmVkIiwgcXVlcnksIHRoYXQubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBjYW5jZWw6ICQubm9vcCwKICAgICAgICAgICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICAgICAgICAgICAgdGhpcy5fZW1wdHkoKTsKICAgICAgICAgICAgICAgIHRoaXMuY2FuY2VsKCk7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoImNsZWFyZWQiKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNFbXB0eTogZnVuY3Rpb24gaXNFbXB0eSgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLiRlbC5pcygiOmVtcHR5Iik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbCA9ICQoIjxkaXY+Iik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gRGF0YXNldDsKICAgICAgICBmdW5jdGlvbiBnZXREaXNwbGF5Rm4oZGlzcGxheSkgewogICAgICAgICAgICBkaXNwbGF5ID0gZGlzcGxheSB8fCBfLnN0cmluZ2lmeTsKICAgICAgICAgICAgcmV0dXJuIF8uaXNGdW5jdGlvbihkaXNwbGF5KSA/IGRpc3BsYXkgOiBkaXNwbGF5Rm47CiAgICAgICAgICAgIGZ1bmN0aW9uIGRpc3BsYXlGbihvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiBvYmpbZGlzcGxheV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGVtcGxhdGVzKHRlbXBsYXRlcywgZGlzcGxheUZuKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBub3RGb3VuZDogdGVtcGxhdGVzLm5vdEZvdW5kICYmIF8udGVtcGxhdGlmeSh0ZW1wbGF0ZXMubm90Rm91bmQpLAogICAgICAgICAgICAgICAgcGVuZGluZzogdGVtcGxhdGVzLnBlbmRpbmcgJiYgXy50ZW1wbGF0aWZ5KHRlbXBsYXRlcy5wZW5kaW5nKSwKICAgICAgICAgICAgICAgIGhlYWRlcjogdGVtcGxhdGVzLmhlYWRlciAmJiBfLnRlbXBsYXRpZnkodGVtcGxhdGVzLmhlYWRlciksCiAgICAgICAgICAgICAgICBmb290ZXI6IHRlbXBsYXRlcy5mb290ZXIgJiYgXy50ZW1wbGF0aWZ5KHRlbXBsYXRlcy5mb290ZXIpLAogICAgICAgICAgICAgICAgc3VnZ2VzdGlvbjogdGVtcGxhdGVzLnN1Z2dlc3Rpb24gPyB1c2VyU3VnZ2VzdGlvblRlbXBsYXRlIDogc3VnZ2VzdGlvblRlbXBsYXRlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGZ1bmN0aW9uIHVzZXJTdWdnZXN0aW9uVGVtcGxhdGUoY29udGV4dCkgewogICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGVtcGxhdGVzLnN1Z2dlc3Rpb247CiAgICAgICAgICAgICAgICByZXR1cm4gJCh0ZW1wbGF0ZShjb250ZXh0KSkuYXR0cigiaWQiLCBfLmd1aWQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gc3VnZ2VzdGlvblRlbXBsYXRlKGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkKCc8ZGl2IHJvbGU9Im9wdGlvbiI+JykuYXR0cigiaWQiLCBfLmd1aWQoKSkudGV4dChkaXNwbGF5Rm4oY29udGV4dCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWROYW1lKHN0cikgewogICAgICAgICAgICByZXR1cm4gL15bX2EtekEtWjAtOS1dKyQvLnRlc3Qoc3RyKTsKICAgICAgICB9CiAgICB9KCk7CiAgICB2YXIgTWVudSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgZnVuY3Rpb24gTWVudShvLCB3d3cpIHsKICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgICBvID0gbyB8fCB7fTsKICAgICAgICAgICAgaWYgKCFvLm5vZGUpIHsKICAgICAgICAgICAgICAgICQuZXJyb3IoIm5vZGUgaXMgcmVxdWlyZWQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3d3cubWl4aW4odGhpcyk7CiAgICAgICAgICAgIHRoaXMuJG5vZGUgPSAkKG8ubm9kZSk7CiAgICAgICAgICAgIHRoaXMucXVlcnkgPSBudWxsOwogICAgICAgICAgICB0aGlzLmRhdGFzZXRzID0gXy5tYXAoby5kYXRhc2V0cywgaW5pdGlhbGl6ZURhdGFzZXQpOwogICAgICAgICAgICBmdW5jdGlvbiBpbml0aWFsaXplRGF0YXNldChvRGF0YXNldCkgewogICAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGF0LiRub2RlLmZpbmQob0RhdGFzZXQubm9kZSkuZmlyc3QoKTsKICAgICAgICAgICAgICAgIG9EYXRhc2V0Lm5vZGUgPSBub2RlLmxlbmd0aCA/IG5vZGUgOiAkKCI8ZGl2PiIpLmFwcGVuZFRvKHRoYXQuJG5vZGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRhc2V0KG9EYXRhc2V0LCB3d3cpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIF8ubWl4aW4oTWVudS5wcm90b3R5cGUsIEV2ZW50RW1pdHRlciwgewogICAgICAgICAgICBfb25TZWxlY3RhYmxlQ2xpY2s6IGZ1bmN0aW9uIG9uU2VsZWN0YWJsZUNsaWNrKCRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoInNlbGVjdGFibGVDbGlja2VkIiwgJCgkZS5jdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vblJlbmRlcmVkOiBmdW5jdGlvbiBvblJlbmRlcmVkKHR5cGUsIGRhdGFzZXQsIHN1Z2dlc3Rpb25zLCBhc3luYykgewogICAgICAgICAgICAgICAgdGhpcy4kbm9kZS50b2dnbGVDbGFzcyh0aGlzLmNsYXNzZXMuZW1wdHksIHRoaXMuX2FsbERhdGFzZXRzRW1wdHkoKSk7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoImRhdGFzZXRSZW5kZXJlZCIsIGRhdGFzZXQsIHN1Z2dlc3Rpb25zLCBhc3luYyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbkNsZWFyZWQ6IGZ1bmN0aW9uIG9uQ2xlYXJlZCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuJG5vZGUudG9nZ2xlQ2xhc3ModGhpcy5jbGFzc2VzLmVtcHR5LCB0aGlzLl9hbGxEYXRhc2V0c0VtcHR5KCkpOwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCJkYXRhc2V0Q2xlYXJlZCIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfcHJvcGFnYXRlOiBmdW5jdGlvbiBwcm9wYWdhdGUoKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX2FsbERhdGFzZXRzRW1wdHk6IGZ1bmN0aW9uIGFsbERhdGFzZXRzRW1wdHkoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gXy5ldmVyeSh0aGlzLmRhdGFzZXRzLCBfLmJpbmQoZnVuY3Rpb24gaXNEYXRhc2V0RW1wdHkoZGF0YXNldCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpc0VtcHR5ID0gZGF0YXNldC5pc0VtcHR5KCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kbm9kZS5hdHRyKCJhcmlhLWV4cGFuZGVkIiwgIWlzRW1wdHkpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBpc0VtcHR5OwogICAgICAgICAgICAgICAgfSwgdGhpcykpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfZ2V0U2VsZWN0YWJsZXM6IGZ1bmN0aW9uIGdldFNlbGVjdGFibGVzKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJG5vZGUuZmluZCh0aGlzLnNlbGVjdG9ycy5zZWxlY3RhYmxlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX3JlbW92ZUN1cnNvcjogZnVuY3Rpb24gX3JlbW92ZUN1cnNvcigpIHsKICAgICAgICAgICAgICAgIHZhciAkc2VsZWN0YWJsZSA9IHRoaXMuZ2V0QWN0aXZlU2VsZWN0YWJsZSgpOwogICAgICAgICAgICAgICAgJHNlbGVjdGFibGUgJiYgJHNlbGVjdGFibGUucmVtb3ZlQ2xhc3ModGhpcy5jbGFzc2VzLmN1cnNvcik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9lbnN1cmVWaXNpYmxlOiBmdW5jdGlvbiBlbnN1cmVWaXNpYmxlKCRlbCkgewogICAgICAgICAgICAgICAgdmFyIGVsVG9wLCBlbEJvdHRvbSwgbm9kZVNjcm9sbFRvcCwgbm9kZUhlaWdodDsKICAgICAgICAgICAgICAgIGVsVG9wID0gJGVsLnBvc2l0aW9uKCkudG9wOwogICAgICAgICAgICAgICAgZWxCb3R0b20gPSBlbFRvcCArICRlbC5vdXRlckhlaWdodCh0cnVlKTsKICAgICAgICAgICAgICAgIG5vZGVTY3JvbGxUb3AgPSB0aGlzLiRub2RlLnNjcm9sbFRvcCgpOwogICAgICAgICAgICAgICAgbm9kZUhlaWdodCA9IHRoaXMuJG5vZGUuaGVpZ2h0KCkgKyBwYXJzZUludCh0aGlzLiRub2RlLmNzcygicGFkZGluZ1RvcCIpLCAxMCkgKyBwYXJzZUludCh0aGlzLiRub2RlLmNzcygicGFkZGluZ0JvdHRvbSIpLCAxMCk7CiAgICAgICAgICAgICAgICBpZiAoZWxUb3AgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kbm9kZS5zY3JvbGxUb3Aobm9kZVNjcm9sbFRvcCArIGVsVG9wKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZUhlaWdodCA8IGVsQm90dG9tKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy4kbm9kZS5zY3JvbGxUb3Aobm9kZVNjcm9sbFRvcCArIChlbEJvdHRvbSAtIG5vZGVIZWlnaHQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgYmluZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLCBvblNlbGVjdGFibGVDbGljazsKICAgICAgICAgICAgICAgIG9uU2VsZWN0YWJsZUNsaWNrID0gXy5iaW5kKHRoaXMuX29uU2VsZWN0YWJsZUNsaWNrLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMuJG5vZGUub24oImNsaWNrLnR0IiwgdGhpcy5zZWxlY3RvcnMuc2VsZWN0YWJsZSwgb25TZWxlY3RhYmxlQ2xpY2spOwogICAgICAgICAgICAgICAgdGhpcy4kbm9kZS5vbigibW91c2VvdmVyIiwgdGhpcy5zZWxlY3RvcnMuc2VsZWN0YWJsZSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHRoYXQuc2V0Q3Vyc29yKCQodGhpcykpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLiRub2RlLm9uKCJtb3VzZWxlYXZlIiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHRoYXQuX3JlbW92ZUN1cnNvcigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBfLmVhY2godGhpcy5kYXRhc2V0cywgZnVuY3Rpb24gKGRhdGFzZXQpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhc2V0Lm9uU3luYygiYXN5bmNSZXF1ZXN0ZWQiLCB0aGF0Ll9wcm9wYWdhdGUsIHRoYXQpLm9uU3luYygiYXN5bmNDYW5jZWxlZCIsIHRoYXQuX3Byb3BhZ2F0ZSwgdGhhdCkub25TeW5jKCJhc3luY1JlY2VpdmVkIiwgdGhhdC5fcHJvcGFnYXRlLCB0aGF0KS5vblN5bmMoInJlbmRlcmVkIiwgdGhhdC5fb25SZW5kZXJlZCwgdGhhdCkub25TeW5jKCJjbGVhcmVkIiwgdGhhdC5fb25DbGVhcmVkLCB0aGF0KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzT3BlbjogZnVuY3Rpb24gaXNPcGVuKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJG5vZGUuaGFzQ2xhc3ModGhpcy5jbGFzc2VzLm9wZW4pOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvcGVuOiBmdW5jdGlvbiBvcGVuKCkgewogICAgICAgICAgICAgICAgdGhpcy4kbm9kZS5zY3JvbGxUb3AoMCk7CiAgICAgICAgICAgICAgICB0aGlzLiRub2RlLmFkZENsYXNzKHRoaXMuY2xhc3Nlcy5vcGVuKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2xvc2U6IGZ1bmN0aW9uIGNsb3NlKCkgewogICAgICAgICAgICAgICAgdGhpcy4kbm9kZS5hdHRyKCJhcmlhLWV4cGFuZGVkIiwgZmFsc2UpOwogICAgICAgICAgICAgICAgdGhpcy4kbm9kZS5yZW1vdmVDbGFzcyh0aGlzLmNsYXNzZXMub3Blbik7CiAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVDdXJzb3IoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0TGFuZ3VhZ2VEaXJlY3Rpb246IGZ1bmN0aW9uIHNldExhbmd1YWdlRGlyZWN0aW9uKGRpcikgewogICAgICAgICAgICAgICAgdGhpcy4kbm9kZS5hdHRyKCJkaXIiLCBkaXIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZWxlY3RhYmxlUmVsYXRpdmVUb0N1cnNvcjogZnVuY3Rpb24gc2VsZWN0YWJsZVJlbGF0aXZlVG9DdXJzb3IoZGVsdGEpIHsKICAgICAgICAgICAgICAgIHZhciAkc2VsZWN0YWJsZXMsICRvbGRDdXJzb3IsIG9sZEluZGV4LCBuZXdJbmRleDsKICAgICAgICAgICAgICAgICRvbGRDdXJzb3IgPSB0aGlzLmdldEFjdGl2ZVNlbGVjdGFibGUoKTsKICAgICAgICAgICAgICAgICRzZWxlY3RhYmxlcyA9IHRoaXMuX2dldFNlbGVjdGFibGVzKCk7CiAgICAgICAgICAgICAgICBvbGRJbmRleCA9ICRvbGRDdXJzb3IgPyAkc2VsZWN0YWJsZXMuaW5kZXgoJG9sZEN1cnNvcikgOiAtMTsKICAgICAgICAgICAgICAgIG5ld0luZGV4ID0gb2xkSW5kZXggKyBkZWx0YTsKICAgICAgICAgICAgICAgIG5ld0luZGV4ID0gKG5ld0luZGV4ICsgMSkgJSAoJHNlbGVjdGFibGVzLmxlbmd0aCArIDEpIC0gMTsKICAgICAgICAgICAgICAgIG5ld0luZGV4ID0gbmV3SW5kZXggPCAtMSA/ICRzZWxlY3RhYmxlcy5sZW5ndGggLSAxIDogbmV3SW5kZXg7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3SW5kZXggPT09IC0xID8gbnVsbCA6ICRzZWxlY3RhYmxlcy5lcShuZXdJbmRleCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldEN1cnNvcjogZnVuY3Rpb24gc2V0Q3Vyc29yKCRzZWxlY3RhYmxlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVDdXJzb3IoKTsKICAgICAgICAgICAgICAgIGlmICgkc2VsZWN0YWJsZSA9ICRzZWxlY3RhYmxlICYmICRzZWxlY3RhYmxlLmZpcnN0KCkpIHsKICAgICAgICAgICAgICAgICAgICAkc2VsZWN0YWJsZS5hZGRDbGFzcyh0aGlzLmNsYXNzZXMuY3Vyc29yKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9lbnN1cmVWaXNpYmxlKCRzZWxlY3RhYmxlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0U2VsZWN0YWJsZURhdGE6IGZ1bmN0aW9uIGdldFNlbGVjdGFibGVEYXRhKCRlbCkgewogICAgICAgICAgICAgICAgcmV0dXJuICRlbCAmJiAkZWwubGVuZ3RoID8gRGF0YXNldC5leHRyYWN0RGF0YSgkZWwpIDogbnVsbDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0QWN0aXZlU2VsZWN0YWJsZTogZnVuY3Rpb24gZ2V0QWN0aXZlU2VsZWN0YWJsZSgpIHsKICAgICAgICAgICAgICAgIHZhciAkc2VsZWN0YWJsZSA9IHRoaXMuX2dldFNlbGVjdGFibGVzKCkuZmlsdGVyKHRoaXMuc2VsZWN0b3JzLmN1cnNvcikuZmlyc3QoKTsKICAgICAgICAgICAgICAgIHJldHVybiAkc2VsZWN0YWJsZS5sZW5ndGggPyAkc2VsZWN0YWJsZSA6IG51bGw7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdldFRvcFNlbGVjdGFibGU6IGZ1bmN0aW9uIGdldFRvcFNlbGVjdGFibGUoKSB7CiAgICAgICAgICAgICAgICB2YXIgJHNlbGVjdGFibGUgPSB0aGlzLl9nZXRTZWxlY3RhYmxlcygpLmZpcnN0KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gJHNlbGVjdGFibGUubGVuZ3RoID8gJHNlbGVjdGFibGUgOiBudWxsOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShxdWVyeSkgewogICAgICAgICAgICAgICAgdmFyIGlzVmFsaWRVcGRhdGUgPSBxdWVyeSAhPT0gdGhpcy5xdWVyeTsKICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkVXBkYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWVyeSA9IHF1ZXJ5OwogICAgICAgICAgICAgICAgICAgIF8uZWFjaCh0aGlzLmRhdGFzZXRzLCB1cGRhdGVEYXRhc2V0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBpc1ZhbGlkVXBkYXRlOwogICAgICAgICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGF0YXNldChkYXRhc2V0KSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YXNldC51cGRhdGUocXVlcnkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBlbXB0eTogZnVuY3Rpb24gZW1wdHkoKSB7CiAgICAgICAgICAgICAgICBfLmVhY2godGhpcy5kYXRhc2V0cywgY2xlYXJEYXRhc2V0KTsKICAgICAgICAgICAgICAgIHRoaXMucXVlcnkgPSBudWxsOwogICAgICAgICAgICAgICAgdGhpcy4kbm9kZS5hZGRDbGFzcyh0aGlzLmNsYXNzZXMuZW1wdHkpOwogICAgICAgICAgICAgICAgZnVuY3Rpb24gY2xlYXJEYXRhc2V0KGRhdGFzZXQpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhc2V0LmNsZWFyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRub2RlLm9mZigiLnR0Iik7CiAgICAgICAgICAgICAgICB0aGlzLiRub2RlID0gJCgiPGRpdj4iKTsKICAgICAgICAgICAgICAgIF8uZWFjaCh0aGlzLmRhdGFzZXRzLCBkZXN0cm95RGF0YXNldCk7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBkZXN0cm95RGF0YXNldChkYXRhc2V0KSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YXNldC5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gTWVudTsKICAgIH0oKTsKICAgIHZhciBTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGZ1bmN0aW9uIFN0YXR1cyhvcHRpb25zKSB7CiAgICAgICAgICAgIHRoaXMuJGVsID0gJCgiPHNwYW4+PC9zcGFuPiIsIHsKICAgICAgICAgICAgICAgIHJvbGU6ICJzdGF0dXMiLAogICAgICAgICAgICAgICAgImFyaWEtbGl2ZSI6ICJwb2xpdGUiCiAgICAgICAgICAgIH0pLmNzcyh7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgICAgICAgICAgIHBhZGRpbmc6ICIwIiwKICAgICAgICAgICAgICAgIGJvcmRlcjogIjAiLAogICAgICAgICAgICAgICAgaGVpZ2h0OiAiMXB4IiwKICAgICAgICAgICAgICAgIHdpZHRoOiAiMXB4IiwKICAgICAgICAgICAgICAgICJtYXJnaW4tYm90dG9tIjogIi0xcHgiLAogICAgICAgICAgICAgICAgIm1hcmdpbi1yaWdodCI6ICItMXB4IiwKICAgICAgICAgICAgICAgIG92ZXJmbG93OiAiaGlkZGVuIiwKICAgICAgICAgICAgICAgIGNsaXA6ICJyZWN0KDAgMCAwIDApIiwKICAgICAgICAgICAgICAgICJ3aGl0ZS1zcGFjZSI6ICJub3dyYXAiCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBvcHRpb25zLiRpbnB1dC5hZnRlcih0aGlzLiRlbCk7CiAgICAgICAgICAgIF8uZWFjaChvcHRpb25zLm1lbnUuZGF0YXNldHMsIF8uYmluZChmdW5jdGlvbiAoZGF0YXNldCkgewogICAgICAgICAgICAgICAgaWYgKGRhdGFzZXQub25TeW5jKSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YXNldC5vblN5bmMoInJlbmRlcmVkIiwgXy5iaW5kKHRoaXMudXBkYXRlLCB0aGlzKSk7CiAgICAgICAgICAgICAgICAgICAgZGF0YXNldC5vblN5bmMoImNsZWFyZWQiLCBfLmJpbmQodGhpcy5jbGVhcmVkLCB0aGlzKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHRoaXMpKTsKICAgICAgICB9CiAgICAgICAgXy5taXhpbihTdGF0dXMucHJvdG90eXBlLCB7CiAgICAgICAgICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKGV2ZW50LCBzdWdnZXN0aW9ucykgewogICAgICAgICAgICAgICAgdmFyIGxlbmd0aCA9IHN1Z2dlc3Rpb25zLmxlbmd0aDsKICAgICAgICAgICAgICAgIHZhciB3b3JkczsKICAgICAgICAgICAgICAgIGlmIChsZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICB3b3JkcyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiAicmVzdWx0IiwKICAgICAgICAgICAgICAgICAgICAgICAgaXM6ICJpcyIKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB3b3JkcyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiAicmVzdWx0cyIsCiAgICAgICAgICAgICAgICAgICAgICAgIGlzOiAiYXJlIgogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLiRlbC50ZXh0KGxlbmd0aCArICIgIiArIHdvcmRzLnJlc3VsdCArICIgIiArIHdvcmRzLmlzICsgIiBhdmFpbGFibGUsIHVzZSB1cCBhbmQgZG93biBhcnJvdyBrZXlzIHRvIG5hdmlnYXRlLiIpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjbGVhcmVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRlbC50ZXh0KCIiKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBTdGF0dXM7CiAgICB9KCk7CiAgICB2YXIgRGVmYXVsdE1lbnUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBzID0gTWVudS5wcm90b3R5cGU7CiAgICAgICAgZnVuY3Rpb24gRGVmYXVsdE1lbnUoKSB7CiAgICAgICAgICAgIE1lbnUuYXBwbHkodGhpcywgW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKTsKICAgICAgICB9CiAgICAgICAgXy5taXhpbihEZWZhdWx0TWVudS5wcm90b3R5cGUsIE1lbnUucHJvdG90eXBlLCB7CiAgICAgICAgICAgIG9wZW46IGZ1bmN0aW9uIG9wZW4oKSB7CiAgICAgICAgICAgICAgICAhdGhpcy5fYWxsRGF0YXNldHNFbXB0eSgpICYmIHRoaXMuX3Nob3coKTsKICAgICAgICAgICAgICAgIHJldHVybiBzLm9wZW4uYXBwbHkodGhpcywgW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2xvc2U6IGZ1bmN0aW9uIGNsb3NlKCkgewogICAgICAgICAgICAgICAgdGhpcy5faGlkZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHMuY2xvc2UuYXBwbHkodGhpcywgW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uUmVuZGVyZWQ6IGZ1bmN0aW9uIG9uUmVuZGVyZWQoKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYWxsRGF0YXNldHNFbXB0eSgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlkZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzT3BlbigpICYmIHRoaXMuX3Nob3coKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBzLl9vblJlbmRlcmVkLmFwcGx5KHRoaXMsIFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbkNsZWFyZWQ6IGZ1bmN0aW9uIG9uQ2xlYXJlZCgpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9hbGxEYXRhc2V0c0VtcHR5KCkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNPcGVuKCkgJiYgdGhpcy5fc2hvdygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHMuX29uQ2xlYXJlZC5hcHBseSh0aGlzLCBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCkpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRMYW5ndWFnZURpcmVjdGlvbjogZnVuY3Rpb24gc2V0TGFuZ3VhZ2VEaXJlY3Rpb24oZGlyKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRub2RlLmNzcyhkaXIgPT09ICJsdHIiID8gdGhpcy5jc3MubHRyIDogdGhpcy5jc3MucnRsKTsKICAgICAgICAgICAgICAgIHJldHVybiBzLnNldExhbmd1YWdlRGlyZWN0aW9uLmFwcGx5KHRoaXMsIFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9oaWRlOiBmdW5jdGlvbiBoaWRlKCkgewogICAgICAgICAgICAgICAgdGhpcy4kbm9kZS5oaWRlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9zaG93OiBmdW5jdGlvbiBzaG93KCkgewogICAgICAgICAgICAgICAgdGhpcy4kbm9kZS5jc3MoImRpc3BsYXkiLCAiYmxvY2siKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBEZWZhdWx0TWVudTsKICAgIH0oKTsKICAgIHZhciBUeXBlYWhlYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGZ1bmN0aW9uIFR5cGVhaGVhZChvLCB3d3cpIHsKICAgICAgICAgICAgdmFyIG9uRm9jdXNlZCwgb25CbHVycmVkLCBvbkVudGVyS2V5ZWQsIG9uVGFiS2V5ZWQsIG9uRXNjS2V5ZWQsIG9uVXBLZXllZCwgb25Eb3duS2V5ZWQsIG9uTGVmdEtleWVkLCBvblJpZ2h0S2V5ZWQsIG9uUXVlcnlDaGFuZ2VkLCBvbldoaXRlc3BhY2VDaGFuZ2VkOwogICAgICAgICAgICBvID0gbyB8fCB7fTsKICAgICAgICAgICAgaWYgKCFvLmlucHV0KSB7CiAgICAgICAgICAgICAgICAkLmVycm9yKCJtaXNzaW5nIGlucHV0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFvLm1lbnUpIHsKICAgICAgICAgICAgICAgICQuZXJyb3IoIm1pc3NpbmcgbWVudSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghby5ldmVudEJ1cykgewogICAgICAgICAgICAgICAgJC5lcnJvcigibWlzc2luZyBldmVudCBidXMiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3d3cubWl4aW4odGhpcyk7CiAgICAgICAgICAgIHRoaXMuZXZlbnRCdXMgPSBvLmV2ZW50QnVzOwogICAgICAgICAgICB0aGlzLm1pbkxlbmd0aCA9IF8uaXNOdW1iZXIoby5taW5MZW5ndGgpID8gby5taW5MZW5ndGggOiAxOwogICAgICAgICAgICB0aGlzLmlucHV0ID0gby5pbnB1dDsKICAgICAgICAgICAgdGhpcy5tZW51ID0gby5tZW51OwogICAgICAgICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmF1dG9zZWxlY3QgPSAhIW8uYXV0b3NlbGVjdDsKICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5pbnB1dC5oYXNGb2N1cygpICYmIHRoaXMuYWN0aXZhdGUoKTsKICAgICAgICAgICAgdGhpcy5kaXIgPSB0aGlzLmlucHV0LmdldExhbmdEaXIoKTsKICAgICAgICAgICAgdGhpcy5faGFja3MoKTsKICAgICAgICAgICAgdGhpcy5tZW51LmJpbmQoKS5vblN5bmMoInNlbGVjdGFibGVDbGlja2VkIiwgdGhpcy5fb25TZWxlY3RhYmxlQ2xpY2tlZCwgdGhpcykub25TeW5jKCJhc3luY1JlcXVlc3RlZCIsIHRoaXMuX29uQXN5bmNSZXF1ZXN0ZWQsIHRoaXMpLm9uU3luYygiYXN5bmNDYW5jZWxlZCIsIHRoaXMuX29uQXN5bmNDYW5jZWxlZCwgdGhpcykub25TeW5jKCJhc3luY1JlY2VpdmVkIiwgdGhpcy5fb25Bc3luY1JlY2VpdmVkLCB0aGlzKS5vblN5bmMoImRhdGFzZXRSZW5kZXJlZCIsIHRoaXMuX29uRGF0YXNldFJlbmRlcmVkLCB0aGlzKS5vblN5bmMoImRhdGFzZXRDbGVhcmVkIiwgdGhpcy5fb25EYXRhc2V0Q2xlYXJlZCwgdGhpcyk7CiAgICAgICAgICAgIG9uRm9jdXNlZCA9IGModGhpcywgImFjdGl2YXRlIiwgIm9wZW4iLCAiX29uRm9jdXNlZCIpOwogICAgICAgICAgICBvbkJsdXJyZWQgPSBjKHRoaXMsICJkZWFjdGl2YXRlIiwgIl9vbkJsdXJyZWQiKTsKICAgICAgICAgICAgb25FbnRlcktleWVkID0gYyh0aGlzLCAiaXNBY3RpdmUiLCAiaXNPcGVuIiwgIl9vbkVudGVyS2V5ZWQiKTsKICAgICAgICAgICAgb25UYWJLZXllZCA9IGModGhpcywgImlzQWN0aXZlIiwgImlzT3BlbiIsICJfb25UYWJLZXllZCIpOwogICAgICAgICAgICBvbkVzY0tleWVkID0gYyh0aGlzLCAiaXNBY3RpdmUiLCAiX29uRXNjS2V5ZWQiKTsKICAgICAgICAgICAgb25VcEtleWVkID0gYyh0aGlzLCAiaXNBY3RpdmUiLCAib3BlbiIsICJfb25VcEtleWVkIik7CiAgICAgICAgICAgIG9uRG93bktleWVkID0gYyh0aGlzLCAiaXNBY3RpdmUiLCAib3BlbiIsICJfb25Eb3duS2V5ZWQiKTsKICAgICAgICAgICAgb25MZWZ0S2V5ZWQgPSBjKHRoaXMsICJpc0FjdGl2ZSIsICJpc09wZW4iLCAiX29uTGVmdEtleWVkIik7CiAgICAgICAgICAgIG9uUmlnaHRLZXllZCA9IGModGhpcywgImlzQWN0aXZlIiwgImlzT3BlbiIsICJfb25SaWdodEtleWVkIik7CiAgICAgICAgICAgIG9uUXVlcnlDaGFuZ2VkID0gYyh0aGlzLCAiX29wZW5JZkFjdGl2ZSIsICJfb25RdWVyeUNoYW5nZWQiKTsKICAgICAgICAgICAgb25XaGl0ZXNwYWNlQ2hhbmdlZCA9IGModGhpcywgIl9vcGVuSWZBY3RpdmUiLCAiX29uV2hpdGVzcGFjZUNoYW5nZWQiKTsKICAgICAgICAgICAgdGhpcy5pbnB1dC5iaW5kKCkub25TeW5jKCJmb2N1c2VkIiwgb25Gb2N1c2VkLCB0aGlzKS5vblN5bmMoImJsdXJyZWQiLCBvbkJsdXJyZWQsIHRoaXMpLm9uU3luYygiZW50ZXJLZXllZCIsIG9uRW50ZXJLZXllZCwgdGhpcykub25TeW5jKCJ0YWJLZXllZCIsIG9uVGFiS2V5ZWQsIHRoaXMpLm9uU3luYygiZXNjS2V5ZWQiLCBvbkVzY0tleWVkLCB0aGlzKS5vblN5bmMoInVwS2V5ZWQiLCBvblVwS2V5ZWQsIHRoaXMpLm9uU3luYygiZG93bktleWVkIiwgb25Eb3duS2V5ZWQsIHRoaXMpLm9uU3luYygibGVmdEtleWVkIiwgb25MZWZ0S2V5ZWQsIHRoaXMpLm9uU3luYygicmlnaHRLZXllZCIsIG9uUmlnaHRLZXllZCwgdGhpcykub25TeW5jKCJxdWVyeUNoYW5nZWQiLCBvblF1ZXJ5Q2hhbmdlZCwgdGhpcykub25TeW5jKCJ3aGl0ZXNwYWNlQ2hhbmdlZCIsIG9uV2hpdGVzcGFjZUNoYW5nZWQsIHRoaXMpLm9uU3luYygibGFuZ0RpckNoYW5nZWQiLCB0aGlzLl9vbkxhbmdEaXJDaGFuZ2VkLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgXy5taXhpbihUeXBlYWhlYWQucHJvdG90eXBlLCB7CiAgICAgICAgICAgIF9oYWNrczogZnVuY3Rpb24gaGFja3MoKSB7CiAgICAgICAgICAgICAgICB2YXIgJGlucHV0LCAkbWVudTsKICAgICAgICAgICAgICAgICRpbnB1dCA9IHRoaXMuaW5wdXQuJGlucHV0IHx8ICQoIjxkaXY+Iik7CiAgICAgICAgICAgICAgICAkbWVudSA9IHRoaXMubWVudS4kbm9kZSB8fCAkKCI8ZGl2PiIpOwogICAgICAgICAgICAgICAgJGlucHV0Lm9uKCJibHVyLnR0IiwgZnVuY3Rpb24gKCRlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGl2ZSwgaXNBY3RpdmUsIGhhc0FjdGl2ZTsKICAgICAgICAgICAgICAgICAgICBhY3RpdmUgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwogICAgICAgICAgICAgICAgICAgIGlzQWN0aXZlID0gJG1lbnUuaXMoYWN0aXZlKTsKICAgICAgICAgICAgICAgICAgICBoYXNBY3RpdmUgPSAkbWVudS5oYXMoYWN0aXZlKS5sZW5ndGggPiAwOwogICAgICAgICAgICAgICAgICAgIGlmIChfLmlzTXNpZSgpICYmIChpc0FjdGl2ZSB8fCBoYXNBY3RpdmUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICRlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgICAgICAgICBfLmRlZmVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRpbnB1dC5mb2N1cygpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICRtZW51Lm9uKCJtb3VzZWRvd24udHQiLCBmdW5jdGlvbiAoJGUpIHsKICAgICAgICAgICAgICAgICAgICAkZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vblNlbGVjdGFibGVDbGlja2VkOiBmdW5jdGlvbiBvblNlbGVjdGFibGVDbGlja2VkKHR5cGUsICRlbCkgewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3QoJGVsKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uRGF0YXNldENsZWFyZWQ6IGZ1bmN0aW9uIG9uRGF0YXNldENsZWFyZWQoKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIaW50KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbkRhdGFzZXRSZW5kZXJlZDogZnVuY3Rpb24gb25EYXRhc2V0UmVuZGVyZWQodHlwZSwgc3VnZ2VzdGlvbnMsIGFzeW5jLCBkYXRhc2V0KSB7CiAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIaW50KCk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdXRvc2VsZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnNvckNsYXNzID0gdGhpcy5zZWxlY3RvcnMuY3Vyc29yLnN1YnN0cigxKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnUuJG5vZGUuZmluZCh0aGlzLnNlbGVjdG9ycy5zdWdnZXN0aW9uKS5maXJzdCgpLmFkZENsYXNzKGN1cnNvckNsYXNzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRCdXMudHJpZ2dlcigicmVuZGVyIiwgc3VnZ2VzdGlvbnMsIGFzeW5jLCBkYXRhc2V0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uQXN5bmNSZXF1ZXN0ZWQ6IGZ1bmN0aW9uIG9uQXN5bmNSZXF1ZXN0ZWQodHlwZSwgZGF0YXNldCwgcXVlcnkpIHsKICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRCdXMudHJpZ2dlcigiYXN5bmNyZXF1ZXN0IiwgcXVlcnksIGRhdGFzZXQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25Bc3luY0NhbmNlbGVkOiBmdW5jdGlvbiBvbkFzeW5jQ2FuY2VsZWQodHlwZSwgZGF0YXNldCwgcXVlcnkpIHsKICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRCdXMudHJpZ2dlcigiYXN5bmNjYW5jZWwiLCBxdWVyeSwgZGF0YXNldCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbkFzeW5jUmVjZWl2ZWQ6IGZ1bmN0aW9uIG9uQXN5bmNSZWNlaXZlZCh0eXBlLCBkYXRhc2V0LCBxdWVyeSkgewogICAgICAgICAgICAgICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKCJhc3luY3JlY2VpdmUiLCBxdWVyeSwgZGF0YXNldCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbkZvY3VzZWQ6IGZ1bmN0aW9uIG9uRm9jdXNlZCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuX21pbkxlbmd0aE1ldCgpICYmIHRoaXMubWVudS51cGRhdGUodGhpcy5pbnB1dC5nZXRRdWVyeSgpKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uQmx1cnJlZDogZnVuY3Rpb24gb25CbHVycmVkKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXQuaGFzUXVlcnlDaGFuZ2VkU2luY2VMYXN0Rm9jdXMoKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRCdXMudHJpZ2dlcigiY2hhbmdlIiwgdGhpcy5pbnB1dC5nZXRRdWVyeSgpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uRW50ZXJLZXllZDogZnVuY3Rpb24gb25FbnRlcktleWVkKHR5cGUsICRlKSB7CiAgICAgICAgICAgICAgICB2YXIgJHNlbGVjdGFibGU7CiAgICAgICAgICAgICAgICBpZiAoJHNlbGVjdGFibGUgPSB0aGlzLm1lbnUuZ2V0QWN0aXZlU2VsZWN0YWJsZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0KCRzZWxlY3RhYmxlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAkZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAkZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYXV0b3NlbGVjdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdCh0aGlzLm1lbnUuZ2V0VG9wU2VsZWN0YWJsZSgpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAkZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAkZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vblRhYktleWVkOiBmdW5jdGlvbiBvblRhYktleWVkKHR5cGUsICRlKSB7CiAgICAgICAgICAgICAgICB2YXIgJHNlbGVjdGFibGU7CiAgICAgICAgICAgICAgICBpZiAoJHNlbGVjdGFibGUgPSB0aGlzLm1lbnUuZ2V0QWN0aXZlU2VsZWN0YWJsZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3QoJHNlbGVjdGFibGUpICYmICRlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYXV0b3NlbGVjdCkgewogICAgICAgICAgICAgICAgICAgIGlmICgkc2VsZWN0YWJsZSA9IHRoaXMubWVudS5nZXRUb3BTZWxlY3RhYmxlKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRvY29tcGxldGUoJHNlbGVjdGFibGUpICYmICRlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25Fc2NLZXllZDogZnVuY3Rpb24gb25Fc2NLZXllZCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uVXBLZXllZDogZnVuY3Rpb24gb25VcEtleWVkKCkgewogICAgICAgICAgICAgICAgdGhpcy5tb3ZlQ3Vyc29yKC0xKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uRG93bktleWVkOiBmdW5jdGlvbiBvbkRvd25LZXllZCgpIHsKICAgICAgICAgICAgICAgIHRoaXMubW92ZUN1cnNvcigrMSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vbkxlZnRLZXllZDogZnVuY3Rpb24gb25MZWZ0S2V5ZWQoKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kaXIgPT09ICJydGwiICYmIHRoaXMuaW5wdXQuaXNDdXJzb3JBdEVuZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRvY29tcGxldGUodGhpcy5tZW51LmdldEFjdGl2ZVNlbGVjdGFibGUoKSB8fCB0aGlzLm1lbnUuZ2V0VG9wU2VsZWN0YWJsZSgpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uUmlnaHRLZXllZDogZnVuY3Rpb24gb25SaWdodEtleWVkKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGlyID09PSAibHRyIiAmJiB0aGlzLmlucHV0LmlzQ3Vyc29yQXRFbmQoKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXV0b2NvbXBsZXRlKHRoaXMubWVudS5nZXRBY3RpdmVTZWxlY3RhYmxlKCkgfHwgdGhpcy5tZW51LmdldFRvcFNlbGVjdGFibGUoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9vblF1ZXJ5Q2hhbmdlZDogZnVuY3Rpb24gb25RdWVyeUNoYW5nZWQoZSwgcXVlcnkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX21pbkxlbmd0aE1ldChxdWVyeSkgPyB0aGlzLm1lbnUudXBkYXRlKHF1ZXJ5KSA6IHRoaXMubWVudS5lbXB0eSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBfb25XaGl0ZXNwYWNlQ2hhbmdlZDogZnVuY3Rpb24gb25XaGl0ZXNwYWNlQ2hhbmdlZCgpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUhpbnQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX29uTGFuZ0RpckNoYW5nZWQ6IGZ1bmN0aW9uIG9uTGFuZ0RpckNoYW5nZWQoZSwgZGlyKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5kaXIgIT09IGRpcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZGlyID0gZGlyOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVudS5zZXRMYW5ndWFnZURpcmVjdGlvbihkaXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBfb3BlbklmQWN0aXZlOiBmdW5jdGlvbiBvcGVuSWZBY3RpdmUoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlzQWN0aXZlKCkgJiYgdGhpcy5vcGVuKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIF9taW5MZW5ndGhNZXQ6IGZ1bmN0aW9uIG1pbkxlbmd0aE1ldChxdWVyeSkgewogICAgICAgICAgICAgICAgcXVlcnkgPSBfLmlzU3RyaW5nKHF1ZXJ5KSA/IHF1ZXJ5IDogdGhpcy5pbnB1dC5nZXRRdWVyeSgpIHx8ICIiOwogICAgICAgICAgICAgICAgcmV0dXJuIHF1ZXJ5Lmxlbmd0aCA+PSB0aGlzLm1pbkxlbmd0aDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgX3VwZGF0ZUhpbnQ6IGZ1bmN0aW9uIHVwZGF0ZUhpbnQoKSB7CiAgICAgICAgICAgICAgICB2YXIgJHNlbGVjdGFibGUsIGRhdGEsIHZhbCwgcXVlcnksIGVzY2FwZWRRdWVyeSwgZnJvbnRNYXRjaFJlZ0V4LCBtYXRjaDsKICAgICAgICAgICAgICAgICRzZWxlY3RhYmxlID0gdGhpcy5tZW51LmdldFRvcFNlbGVjdGFibGUoKTsKICAgICAgICAgICAgICAgIGRhdGEgPSB0aGlzLm1lbnUuZ2V0U2VsZWN0YWJsZURhdGEoJHNlbGVjdGFibGUpOwogICAgICAgICAgICAgICAgdmFsID0gdGhpcy5pbnB1dC5nZXRJbnB1dFZhbHVlKCk7CiAgICAgICAgICAgICAgICBpZiAoZGF0YSAmJiAhXy5pc0JsYW5rU3RyaW5nKHZhbCkgJiYgIXRoaXMuaW5wdXQuaGFzT3ZlcmZsb3coKSkgewogICAgICAgICAgICAgICAgICAgIHF1ZXJ5ID0gSW5wdXQubm9ybWFsaXplUXVlcnkodmFsKTsKICAgICAgICAgICAgICAgICAgICBlc2NhcGVkUXVlcnkgPSBfLmVzY2FwZVJlZ0V4Q2hhcnMocXVlcnkpOwogICAgICAgICAgICAgICAgICAgIGZyb250TWF0Y2hSZWdFeCA9IG5ldyBSZWdFeHAoIl4oPzoiICsgZXNjYXBlZFF1ZXJ5ICsgIikoLiskKSIsICJpIik7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBmcm9udE1hdGNoUmVnRXguZXhlYyhkYXRhLnZhbCk7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggJiYgdGhpcy5pbnB1dC5zZXRIaW50KHZhbCArIG1hdGNoWzFdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5jbGVhckhpbnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNFbmFibGVkOiBmdW5jdGlvbiBpc0VuYWJsZWQoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbmFibGVkOwogICAgICAgICAgICB9LAogICAgICAgICAgICBlbmFibGU6IGZ1bmN0aW9uIGVuYWJsZSgpIHsKICAgICAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRpc2FibGU6IGZ1bmN0aW9uIGRpc2FibGUoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNBY3RpdmU6IGZ1bmN0aW9uIGlzQWN0aXZlKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWN0aXZlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBhY3RpdmF0ZTogZnVuY3Rpb24gYWN0aXZhdGUoKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc0FjdGl2ZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLmlzRW5hYmxlZCgpIHx8IHRoaXMuZXZlbnRCdXMuYmVmb3JlKCJhY3RpdmUiKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRCdXMudHJpZ2dlcigiYWN0aXZlIik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRlYWN0aXZhdGU6IGZ1bmN0aW9uIGRlYWN0aXZhdGUoKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNBY3RpdmUoKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmV2ZW50QnVzLmJlZm9yZSgiaWRsZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV2ZW50QnVzLnRyaWdnZXIoImlkbGUiKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNPcGVuOiBmdW5jdGlvbiBpc09wZW4oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tZW51LmlzT3BlbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvcGVuOiBmdW5jdGlvbiBvcGVuKCkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzT3BlbigpICYmICF0aGlzLmV2ZW50QnVzLmJlZm9yZSgib3BlbiIpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zZXRBcmlhRXhwYW5kZWQodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZW51Lm9wZW4oKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl91cGRhdGVIaW50KCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKCJvcGVuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pc09wZW4oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2xvc2U6IGZ1bmN0aW9uIGNsb3NlKCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNPcGVuKCkgJiYgIXRoaXMuZXZlbnRCdXMuYmVmb3JlKCJjbG9zZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zZXRBcmlhRXhwYW5kZWQoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubWVudS5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuY2xlYXJIaW50KCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5yZXNldElucHV0VmFsdWUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV2ZW50QnVzLnRyaWdnZXIoImNsb3NlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gIXRoaXMuaXNPcGVuKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldFZhbDogZnVuY3Rpb24gc2V0VmFsKHZhbCkgewogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zZXRRdWVyeShfLnRvU3RyKHZhbCkpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXRWYWw6IGZ1bmN0aW9uIGdldFZhbCgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlucHV0LmdldFF1ZXJ5KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNlbGVjdDogZnVuY3Rpb24gc2VsZWN0KCRzZWxlY3RhYmxlKSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IHRoaXMubWVudS5nZXRTZWxlY3RhYmxlRGF0YSgkc2VsZWN0YWJsZSk7CiAgICAgICAgICAgICAgICBpZiAoZGF0YSAmJiAhdGhpcy5ldmVudEJ1cy5iZWZvcmUoInNlbGVjdCIsIGRhdGEub2JqLCBkYXRhLmRhdGFzZXQpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zZXRRdWVyeShkYXRhLnZhbCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ldmVudEJ1cy50cmlnZ2VyKCJzZWxlY3QiLCBkYXRhLm9iaiwgZGF0YS5kYXRhc2V0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGF1dG9jb21wbGV0ZTogZnVuY3Rpb24gYXV0b2NvbXBsZXRlKCRzZWxlY3RhYmxlKSB7CiAgICAgICAgICAgICAgICB2YXIgcXVlcnksIGRhdGEsIGlzVmFsaWQ7CiAgICAgICAgICAgICAgICBxdWVyeSA9IHRoaXMuaW5wdXQuZ2V0UXVlcnkoKTsKICAgICAgICAgICAgICAgIGRhdGEgPSB0aGlzLm1lbnUuZ2V0U2VsZWN0YWJsZURhdGEoJHNlbGVjdGFibGUpOwogICAgICAgICAgICAgICAgaXNWYWxpZCA9IGRhdGEgJiYgcXVlcnkgIT09IGRhdGEudmFsOwogICAgICAgICAgICAgICAgaWYgKGlzVmFsaWQgJiYgIXRoaXMuZXZlbnRCdXMuYmVmb3JlKCJhdXRvY29tcGxldGUiLCBkYXRhLm9iaiwgZGF0YS5kYXRhc2V0KSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuc2V0UXVlcnkoZGF0YS52YWwpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRCdXMudHJpZ2dlcigiYXV0b2NvbXBsZXRlIiwgZGF0YS5vYmosIGRhdGEuZGF0YXNldCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG1vdmVDdXJzb3I6IGZ1bmN0aW9uIG1vdmVDdXJzb3IoZGVsdGEpIHsKICAgICAgICAgICAgICAgIHZhciBxdWVyeSwgJGNhbmRpZGF0ZSwgZGF0YSwgc3VnZ2VzdGlvbiwgZGF0YXNldE5hbWUsIGNhbmNlbE1vdmUsIGlkOwogICAgICAgICAgICAgICAgcXVlcnkgPSB0aGlzLmlucHV0LmdldFF1ZXJ5KCk7CiAgICAgICAgICAgICAgICAkY2FuZGlkYXRlID0gdGhpcy5tZW51LnNlbGVjdGFibGVSZWxhdGl2ZVRvQ3Vyc29yKGRlbHRhKTsKICAgICAgICAgICAgICAgIGRhdGEgPSB0aGlzLm1lbnUuZ2V0U2VsZWN0YWJsZURhdGEoJGNhbmRpZGF0ZSk7CiAgICAgICAgICAgICAgICBzdWdnZXN0aW9uID0gZGF0YSA/IGRhdGEub2JqIDogbnVsbDsKICAgICAgICAgICAgICAgIGRhdGFzZXROYW1lID0gZGF0YSA/IGRhdGEuZGF0YXNldCA6IG51bGw7CiAgICAgICAgICAgICAgICBpZCA9ICRjYW5kaWRhdGUgPyAkY2FuZGlkYXRlLmF0dHIoImlkIikgOiBudWxsOwogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC50cmlnZ2VyKCJjdXJzb3JjaGFuZ2UiLCBpZCk7CiAgICAgICAgICAgICAgICBjYW5jZWxNb3ZlID0gdGhpcy5fbWluTGVuZ3RoTWV0KCkgJiYgdGhpcy5tZW51LnVwZGF0ZShxdWVyeSk7CiAgICAgICAgICAgICAgICBpZiAoIWNhbmNlbE1vdmUgJiYgIXRoaXMuZXZlbnRCdXMuYmVmb3JlKCJjdXJzb3JjaGFuZ2UiLCBzdWdnZXN0aW9uLCBkYXRhc2V0TmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lbnUuc2V0Q3Vyc29yKCRjYW5kaWRhdGUpOwogICAgICAgICAgICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YS52YWwgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucHV0LnNldElucHV0VmFsdWUoZGF0YS52YWwpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5yZXNldElucHV0VmFsdWUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlSGludCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmV2ZW50QnVzLnRyaWdnZXIoImN1cnNvcmNoYW5nZSIsIHN1Z2dlc3Rpb24sIGRhdGFzZXROYW1lKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgdGhpcy5tZW51LmRlc3Ryb3koKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBUeXBlYWhlYWQ7CiAgICAgICAgZnVuY3Rpb24gYyhjdHgpIHsKICAgICAgICAgICAgdmFyIG1ldGhvZHMgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN0eFttZXRob2RdLmFwcGx5KGN0eCwgYXJncyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9KCk7CiAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgb2xkLCBrZXlzLCBtZXRob2RzOwogICAgICAgIG9sZCA9ICQuZm4udHlwZWFoZWFkOwogICAgICAgIGtleXMgPSB7CiAgICAgICAgICAgIHd3dzogInR0LXd3dyIsCiAgICAgICAgICAgIGF0dHJzOiAidHQtYXR0cnMiLAogICAgICAgICAgICB0eXBlYWhlYWQ6ICJ0dC10eXBlYWhlYWQiCiAgICAgICAgfTsKICAgICAgICBtZXRob2RzID0gewogICAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbiBpbml0aWFsaXplKG8sIGRhdGFzZXRzKSB7CiAgICAgICAgICAgICAgICB2YXIgd3d3OwogICAgICAgICAgICAgICAgZGF0YXNldHMgPSBfLmlzQXJyYXkoZGF0YXNldHMpID8gZGF0YXNldHMgOiBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICAgICAgICBvID0gbyB8fCB7fTsKICAgICAgICAgICAgICAgIHd3dyA9IFdXVyhvLmNsYXNzTmFtZXMpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChhdHRhY2gpOwogICAgICAgICAgICAgICAgZnVuY3Rpb24gYXR0YWNoKCkgewogICAgICAgICAgICAgICAgICAgIHZhciAkaW5wdXQsICR3cmFwcGVyLCAkaGludCwgJG1lbnUsIGRlZmF1bHRIaW50LCBkZWZhdWx0TWVudSwgZXZlbnRCdXMsIGlucHV0LCBtZW51LCBzdGF0dXMsIHR5cGVhaGVhZCwgTWVudUNvbnN0cnVjdG9yOwogICAgICAgICAgICAgICAgICAgIF8uZWFjaChkYXRhc2V0cywgZnVuY3Rpb24gKGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZC5oaWdobGlnaHQgPSAhIW8uaGlnaGxpZ2h0OwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICRpbnB1dCA9ICQodGhpcyk7CiAgICAgICAgICAgICAgICAgICAgJHdyYXBwZXIgPSAkKHd3dy5odG1sLndyYXBwZXIpOwogICAgICAgICAgICAgICAgICAgICRoaW50ID0gJGVsT3JOdWxsKG8uaGludCk7CiAgICAgICAgICAgICAgICAgICAgJG1lbnUgPSAkZWxPck51bGwoby5tZW51KTsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0SGludCA9IG8uaGludCAhPT0gZmFsc2UgJiYgISRoaW50OwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHRNZW51ID0gby5tZW51ICE9PSBmYWxzZSAmJiAhJG1lbnU7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdEhpbnQgJiYgKCRoaW50ID0gYnVpbGRIaW50RnJvbUlucHV0KCRpbnB1dCwgd3d3KSk7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdE1lbnUgJiYgKCRtZW51ID0gJCh3d3cuaHRtbC5tZW51KS5jc3Mod3d3LmNzcy5tZW51KSk7CiAgICAgICAgICAgICAgICAgICAgJGhpbnQgJiYgJGhpbnQudmFsKCIiKTsKICAgICAgICAgICAgICAgICAgICAkaW5wdXQgPSBwcmVwSW5wdXQoJGlucHV0LCB3d3cpOwogICAgICAgICAgICAgICAgICAgIGlmIChkZWZhdWx0SGludCB8fCBkZWZhdWx0TWVudSkgewogICAgICAgICAgICAgICAgICAgICAgICAkd3JhcHBlci5jc3Mod3d3LmNzcy53cmFwcGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgJGlucHV0LmNzcyhkZWZhdWx0SGludCA/IHd3dy5jc3MuaW5wdXQgOiB3d3cuY3NzLmlucHV0V2l0aE5vSGludCk7CiAgICAgICAgICAgICAgICAgICAgICAgICRpbnB1dC53cmFwKCR3cmFwcGVyKS5wYXJlbnQoKS5wcmVwZW5kKGRlZmF1bHRIaW50ID8gJGhpbnQgOiBudWxsKS5hcHBlbmQoZGVmYXVsdE1lbnUgPyAkbWVudSA6IG51bGwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBNZW51Q29uc3RydWN0b3IgPSBkZWZhdWx0TWVudSA/IERlZmF1bHRNZW51IDogTWVudTsKICAgICAgICAgICAgICAgICAgICBldmVudEJ1cyA9IG5ldyBFdmVudEJ1cyh7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsOiAkaW5wdXQKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpbnB1dCA9IG5ldyBJbnB1dCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGhpbnQ6ICRoaW50LAogICAgICAgICAgICAgICAgICAgICAgICBpbnB1dDogJGlucHV0LAogICAgICAgICAgICAgICAgICAgICAgICBtZW51OiAkbWVudQogICAgICAgICAgICAgICAgICAgIH0sIHd3dyk7CiAgICAgICAgICAgICAgICAgICAgbWVudSA9IG5ldyBNZW51Q29uc3RydWN0b3IoewogICAgICAgICAgICAgICAgICAgICAgICBub2RlOiAkbWVudSwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YXNldHM6IGRhdGFzZXRzCiAgICAgICAgICAgICAgICAgICAgfSwgd3d3KTsKICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSBuZXcgU3RhdHVzKHsKICAgICAgICAgICAgICAgICAgICAgICAgJGlucHV0OiAkaW5wdXQsCiAgICAgICAgICAgICAgICAgICAgICAgIG1lbnU6IG1lbnUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB0eXBlYWhlYWQgPSBuZXcgVHlwZWFoZWFkKHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQ6IGlucHV0LAogICAgICAgICAgICAgICAgICAgICAgICBtZW51OiBtZW51LAogICAgICAgICAgICAgICAgICAgICAgICBldmVudEJ1czogZXZlbnRCdXMsCiAgICAgICAgICAgICAgICAgICAgICAgIG1pbkxlbmd0aDogby5taW5MZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9zZWxlY3Q6IG8uYXV0b3NlbGVjdAogICAgICAgICAgICAgICAgICAgIH0sIHd3dyk7CiAgICAgICAgICAgICAgICAgICAgJGlucHV0LmRhdGEoa2V5cy53d3csIHd3dyk7CiAgICAgICAgICAgICAgICAgICAgJGlucHV0LmRhdGEoa2V5cy50eXBlYWhlYWQsIHR5cGVhaGVhZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGlzRW5hYmxlZDogZnVuY3Rpb24gaXNFbmFibGVkKCkgewogICAgICAgICAgICAgICAgdmFyIGVuYWJsZWQ7CiAgICAgICAgICAgICAgICB0dEVhY2godGhpcy5maXJzdCgpLCBmdW5jdGlvbiAodCkgewogICAgICAgICAgICAgICAgICAgIGVuYWJsZWQgPSB0LmlzRW5hYmxlZCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZW5hYmxlZDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZW5hYmxlOiBmdW5jdGlvbiBlbmFibGUoKSB7CiAgICAgICAgICAgICAgICB0dEVhY2godGhpcywgZnVuY3Rpb24gKHQpIHsKICAgICAgICAgICAgICAgICAgICB0LmVuYWJsZSgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGlzYWJsZTogZnVuY3Rpb24gZGlzYWJsZSgpIHsKICAgICAgICAgICAgICAgIHR0RWFjaCh0aGlzLCBmdW5jdGlvbiAodCkgewogICAgICAgICAgICAgICAgICAgIHQuZGlzYWJsZSgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaXNBY3RpdmU6IGZ1bmN0aW9uIGlzQWN0aXZlKCkgewogICAgICAgICAgICAgICAgdmFyIGFjdGl2ZTsKICAgICAgICAgICAgICAgIHR0RWFjaCh0aGlzLmZpcnN0KCksIGZ1bmN0aW9uICh0KSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aXZlID0gdC5pc0FjdGl2ZSgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gYWN0aXZlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBhY3RpdmF0ZTogZnVuY3Rpb24gYWN0aXZhdGUoKSB7CiAgICAgICAgICAgICAgICB0dEVhY2godGhpcywgZnVuY3Rpb24gKHQpIHsKICAgICAgICAgICAgICAgICAgICB0LmFjdGl2YXRlKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkZWFjdGl2YXRlOiBmdW5jdGlvbiBkZWFjdGl2YXRlKCkgewogICAgICAgICAgICAgICAgdHRFYWNoKHRoaXMsIGZ1bmN0aW9uICh0KSB7CiAgICAgICAgICAgICAgICAgICAgdC5kZWFjdGl2YXRlKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpc09wZW46IGZ1bmN0aW9uIGlzT3BlbigpIHsKICAgICAgICAgICAgICAgIHZhciBvcGVuOwogICAgICAgICAgICAgICAgdHRFYWNoKHRoaXMuZmlyc3QoKSwgZnVuY3Rpb24gKHQpIHsKICAgICAgICAgICAgICAgICAgICBvcGVuID0gdC5pc09wZW4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIG9wZW47CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9wZW46IGZ1bmN0aW9uIG9wZW4oKSB7CiAgICAgICAgICAgICAgICB0dEVhY2godGhpcywgZnVuY3Rpb24gKHQpIHsKICAgICAgICAgICAgICAgICAgICB0Lm9wZW4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNsb3NlOiBmdW5jdGlvbiBjbG9zZSgpIHsKICAgICAgICAgICAgICAgIHR0RWFjaCh0aGlzLCBmdW5jdGlvbiAodCkgewogICAgICAgICAgICAgICAgICAgIHQuY2xvc2UoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNlbGVjdDogZnVuY3Rpb24gc2VsZWN0KGVsKSB7CiAgICAgICAgICAgICAgICB2YXIgc3VjY2VzcyA9IGZhbHNlLCAkZWwgPSAkKGVsKTsKICAgICAgICAgICAgICAgIHR0RWFjaCh0aGlzLmZpcnN0KCksIGZ1bmN0aW9uICh0KSB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyA9IHQuc2VsZWN0KCRlbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiBzdWNjZXNzOwogICAgICAgICAgICB9LAogICAgICAgICAgICBhdXRvY29tcGxldGU6IGZ1bmN0aW9uIGF1dG9jb21wbGV0ZShlbCkgewogICAgICAgICAgICAgICAgdmFyIHN1Y2Nlc3MgPSBmYWxzZSwgJGVsID0gJChlbCk7CiAgICAgICAgICAgICAgICB0dEVhY2godGhpcy5maXJzdCgpLCBmdW5jdGlvbiAodCkgewogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSB0LmF1dG9jb21wbGV0ZSgkZWwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gc3VjY2VzczsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbW92ZUN1cnNvcjogZnVuY3Rpb24gbW92ZUN1cnNvZShkZWx0YSkgewogICAgICAgICAgICAgICAgdmFyIHN1Y2Nlc3MgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHR0RWFjaCh0aGlzLmZpcnN0KCksIGZ1bmN0aW9uICh0KSB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyA9IHQubW92ZUN1cnNvcihkZWx0YSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiBzdWNjZXNzOwogICAgICAgICAgICB9LAogICAgICAgICAgICB2YWw6IGZ1bmN0aW9uIHZhbChuZXdWYWwpIHsKICAgICAgICAgICAgICAgIHZhciBxdWVyeTsKICAgICAgICAgICAgICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHR0RWFjaCh0aGlzLmZpcnN0KCksIGZ1bmN0aW9uICh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5ID0gdC5nZXRWYWwoKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcXVlcnk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHR0RWFjaCh0aGlzLCBmdW5jdGlvbiAodCkgewogICAgICAgICAgICAgICAgICAgICAgICB0LnNldFZhbChfLnRvU3RyKG5ld1ZhbCkpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICAgICAgICAgICAgdHRFYWNoKHRoaXMsIGZ1bmN0aW9uICh0eXBlYWhlYWQsICRpbnB1dCkgewogICAgICAgICAgICAgICAgICAgIHJldmVydCgkaW5wdXQpOwogICAgICAgICAgICAgICAgICAgIHR5cGVhaGVhZC5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICAkLmZuLnR5cGVhaGVhZCA9IGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgICAgICAgaWYgKG1ldGhvZHNbbWV0aG9kXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1ldGhvZHNbbWV0aG9kXS5hcHBseSh0aGlzLCBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG1ldGhvZHMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICAkLmZuLnR5cGVhaGVhZC5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gbm9Db25mbGljdCgpIHsKICAgICAgICAgICAgJC5mbi50eXBlYWhlYWQgPSBvbGQ7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gdHRFYWNoKCRlbHMsIGZuKSB7CiAgICAgICAgICAgICRlbHMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgJGlucHV0ID0gJCh0aGlzKSwgdHlwZWFoZWFkOwogICAgICAgICAgICAgICAgKHR5cGVhaGVhZCA9ICRpbnB1dC5kYXRhKGtleXMudHlwZWFoZWFkKSkgJiYgZm4odHlwZWFoZWFkLCAkaW5wdXQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYnVpbGRIaW50RnJvbUlucHV0KCRpbnB1dCwgd3d3KSB7CiAgICAgICAgICAgIHJldHVybiAkaW5wdXQuY2xvbmUoKS5hZGRDbGFzcyh3d3cuY2xhc3Nlcy5oaW50KS5yZW1vdmVEYXRhKCkuY3NzKHd3dy5jc3MuaGludCkuY3NzKGdldEJhY2tncm91bmRTdHlsZXMoJGlucHV0KSkucHJvcCh7CiAgICAgICAgICAgICAgICByZWFkb25seTogdHJ1ZSwKICAgICAgICAgICAgICAgIHJlcXVpcmVkOiBmYWxzZQogICAgICAgICAgICB9KS5yZW1vdmVBdHRyKCJpZCBuYW1lIHBsYWNlaG9sZGVyIikucmVtb3ZlQ2xhc3MoInJlcXVpcmVkIikuYXR0cih7CiAgICAgICAgICAgICAgICBzcGVsbGNoZWNrOiAiZmFsc2UiLAogICAgICAgICAgICAgICAgdGFiaW5kZXg6IC0xCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwSW5wdXQoJGlucHV0LCB3d3cpIHsKICAgICAgICAgICAgJGlucHV0LmRhdGEoa2V5cy5hdHRycywgewogICAgICAgICAgICAgICAgZGlyOiAkaW5wdXQuYXR0cigiZGlyIiksCiAgICAgICAgICAgICAgICBhdXRvY29tcGxldGU6ICRpbnB1dC5hdHRyKCJhdXRvY29tcGxldGUiKSwKICAgICAgICAgICAgICAgIHNwZWxsY2hlY2s6ICRpbnB1dC5hdHRyKCJzcGVsbGNoZWNrIiksCiAgICAgICAgICAgICAgICBzdHlsZTogJGlucHV0LmF0dHIoInN0eWxlIikKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICRpbnB1dC5hZGRDbGFzcyh3d3cuY2xhc3Nlcy5pbnB1dCkuYXR0cih7CiAgICAgICAgICAgICAgICBzcGVsbGNoZWNrOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICEkaW5wdXQuYXR0cigiZGlyIikgJiYgJGlucHV0LmF0dHIoImRpciIsICJhdXRvIik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgfQogICAgICAgICAgICByZXR1cm4gJGlucHV0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRCYWNrZ3JvdW5kU3R5bGVzKCRlbCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgYmFja2dyb3VuZEF0dGFjaG1lbnQ6ICRlbC5jc3MoImJhY2tncm91bmQtYXR0YWNobWVudCIpLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENsaXA6ICRlbC5jc3MoImJhY2tncm91bmQtY2xpcCIpLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAkZWwuY3NzKCJiYWNrZ3JvdW5kLWNvbG9yIiksCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kSW1hZ2U6ICRlbC5jc3MoImJhY2tncm91bmQtaW1hZ2UiKSwKICAgICAgICAgICAgICAgIGJhY2tncm91bmRPcmlnaW46ICRlbC5jc3MoImJhY2tncm91bmQtb3JpZ2luIiksCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kUG9zaXRpb246ICRlbC5jc3MoImJhY2tncm91bmQtcG9zaXRpb24iKSwKICAgICAgICAgICAgICAgIGJhY2tncm91bmRSZXBlYXQ6ICRlbC5jc3MoImJhY2tncm91bmQtcmVwZWF0IiksCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kU2l6ZTogJGVsLmNzcygiYmFja2dyb3VuZC1zaXplIikKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV2ZXJ0KCRpbnB1dCkgewogICAgICAgICAgICB2YXIgd3d3LCAkd3JhcHBlcjsKICAgICAgICAgICAgd3d3ID0gJGlucHV0LmRhdGEoa2V5cy53d3cpOwogICAgICAgICAgICAkd3JhcHBlciA9ICRpbnB1dC5wYXJlbnQoKS5maWx0ZXIod3d3LnNlbGVjdG9ycy53cmFwcGVyKTsKICAgICAgICAgICAgXy5lYWNoKCRpbnB1dC5kYXRhKGtleXMuYXR0cnMpLCBmdW5jdGlvbiAodmFsLCBrZXkpIHsKICAgICAgICAgICAgICAgIF8uaXNVbmRlZmluZWQodmFsKSA/ICRpbnB1dC5yZW1vdmVBdHRyKGtleSkgOiAkaW5wdXQuYXR0cihrZXksIHZhbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAkaW5wdXQucmVtb3ZlRGF0YShrZXlzLnR5cGVhaGVhZCkucmVtb3ZlRGF0YShrZXlzLnd3dykucmVtb3ZlRGF0YShrZXlzLmF0dHIpLnJlbW92ZUNsYXNzKHd3dy5jbGFzc2VzLmlucHV0KTsKICAgICAgICAgICAgaWYgKCR3cmFwcGVyLmxlbmd0aCkgewogICAgICAgICAgICAgICAgJGlucHV0LmRldGFjaCgpLmluc2VydEFmdGVyKCR3cmFwcGVyKTsKICAgICAgICAgICAgICAgICR3cmFwcGVyLnJlbW92ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uICRlbE9yTnVsbChvYmopIHsKICAgICAgICAgICAgdmFyIGlzVmFsaWQsICRlbDsKICAgICAgICAgICAgaXNWYWxpZCA9IF8uaXNKUXVlcnkob2JqKSB8fCBfLmlzRWxlbWVudChvYmopOwogICAgICAgICAgICAkZWwgPSBpc1ZhbGlkID8gJChvYmopLmZpcnN0KCkgOiBbXTsKICAgICAgICAgICAgcmV0dXJuICRlbC5sZW5ndGggPyAkZWwgOiBudWxsOwogICAgICAgIH0KICAgIH0pKCk7Cn0pOw==
- ID: "6954b7c7-2487-423f-8600-436cb3b6dc0e"
  Hint: Size
  Value: 105907
- ID: "6f47a0a5-9c94-4b48-abeb-42d38def6054"
  Hint: Mime Type
  Value: "application/x-javascript"
- ID: "ba3f86a2-4a1c-4d78-b63d-91c2779c1b5e"
  Hint: __Sortorder
  Value: 1600
- ID: "c06867fe-9a43-4c7d-b739-48780492d06f"
  Hint: Extension
  Value: js
Languages:
- Language: en
  Versions:
  - Version: 1
    Fields:
    - ID: "25bed78c-4957-4165-998a-ca1b52f67497"
      Hint: __Created
      Value: 20160509T120138Z
