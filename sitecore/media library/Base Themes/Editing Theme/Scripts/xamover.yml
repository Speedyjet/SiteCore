---
ID: "62ee9b3c-e513-4b02-b08e-c7872a9ba575"
Parent: "b0652987-4e54-4675-9dd0-2d112ced361b"
Template: "962b53c4-f93b-4df9-9821-415c867b8903"
Path: /sitecore/media library/Base Themes/Editing Theme/Scripts/xamover
DB: master
SharedFields:
- ID: "06d5295c-ed2f-4a54-9bf2-26228d113318"
  Hint: __Icon
  Value: "-/media/62EE9B3CE5134B02B08EC7872A9BA575.ashx?h=16&thn=1&w=16"
- ID: "40e50ed9-ba07-4702-992e-a912738d32dc"
  Hint: Blob
  Value: dmFyIFNYQTsNCihmdW5jdGlvbiAoU1hBKSB7DQogICAgdmFyIFN4YU1vdmVyID0gKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgZnVuY3Rpb24gU3hhTW92ZXIoc3hhSnF1ZXJ5KSB7DQogICAgICAgICAgICB0aGlzLmFsbG93ZWRSZW5kZXJpbmdzID0gW107DQogICAgICAgICAgICB0aGlzLm5vdGlmeVBsYWNlaG9sZGVyc1Bvc2l0aW9ucyA9IHt9Ow0KICAgICAgICAgICAgdGhpcy5ub3RpZnlCb3hQb3NpdGlvbnMgPSB7fTsNCiAgICAgICAgICAgIHRoaXMuZHJvcHBhYmxlUGxhY2Vob2xkZXJzID0ge307DQogICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVycyA9IHt9Ow0KICAgICAgICAgICAgdGhpcy5kcm9wcGFibGVQbGFjZWhvbGRlcnMgPSBbXTsNCiAgICAgICAgICAgIHRoaXMuaXNUb29sYm94RHJvcCA9IGZhbHNlOw0KICAgICAgICAgICAgdGhpcy5tb3VzZU1hbmFnZXIgPSBuZXcgTW91c2VNYW5hZ2VyKCk7DQogICAgICAgICAgICB0aGlzLmluaXQoKTsNCiAgICAgICAgICAgIHRoaXMuJCA9IHN4YUpxdWVyeTsNCiAgICAgICAgfQ0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuZ2V0T3BlbmVkUGxhY2Vob2xkZXJzQ291bnQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICAgICAgdmFyIG9wZW5lZFBsYWNlaG9sZGVycyA9IHRoaXMuJCgnLnNjcG1bY2hyb21ldHlwZT0icGxhY2Vob2xkZXIiXVtraW5kPSJvcGVuIl0nKSwgY291bnQgPSAwOw0KICAgICAgICAgICAgb3BlbmVkUGxhY2Vob2xkZXJzLmVhY2goZnVuY3Rpb24gKGluZGV4LCBlbG1lbnQpIHsNCiAgICAgICAgICAgICAgICB2YXIgJG9wZW5Db2RlID0gX3RoaXMuJChlbG1lbnQpLCBrZXkgPSAkb3BlbkNvZGUuYXR0cigna2V5JyksIGNocm9tZUtleSwgY2hyb21lLCBpOw0KICAgICAgICAgICAgICAgIGlmICgkb3BlbkNvZGUuc2libGluZ3MoJy5zY0VtcHR5UGxhY2Vob2xkZXJbc2MtcGxhY2Vob2xkZXItaWQ9IicgKyAkb3BlbkNvZGUuYXR0cigiaWQiKSArICJcIl0iKS5sZW5ndGggIT09IDApIHsNCiAgICAgICAgICAgICAgICAgICAgY291bnQrKzsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgX3RoaXMuY2hyb21lcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgICAgICBjaHJvbWUgPSBfdGhpcy5jaHJvbWVzW2ldOw0KICAgICAgICAgICAgICAgICAgICBpZiAoY2hyb21lLl9vcmlnaW5hbERPTUVsZW1lbnQubGVuZ3RoID4gMCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lS2V5ID0gY2hyb21lLl9vcmlnaW5hbERPTUVsZW1lbnRbMF0uYXR0cmlidXRlc1sia2V5Il07DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hyb21lS2V5ICE9PSB1bmRlZmluZWQgJiYNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWVLZXkgIT09IG51bGwgJiYNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWVLZXkudmFsdWUgPT09IGtleSAmJg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS5kYXRhICE9PSB1bmRlZmluZWQgJiYNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWUuZGF0YS5jdXN0b20gIT09IHVuZGVmaW5lZCAmJg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZS5kYXRhLmN1c3RvbS5lZGl0YWJsZSA9PT0gInRydWUiKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnQrKzsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgcmV0dXJuIGNvdW50Ow0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuY2xlYW51cCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHRoaXMuJCgiLnN4YS10b29sYm94LWRpdi50b29sYm94LWRyb3BwaW5nIikucmVtb3ZlKCk7DQogICAgICAgICAgICB0aGlzLiQoIi5zeGEtdG9vbGJveC1kcm9wcGFibGUiKS5yZW1vdmVDbGFzcygic3hhLXRvb2xib3gtZHJvcHBhYmxlIik7DQogICAgICAgICAgICB0aGlzLiQoIi50b29sYm94LWRyb3BwaW5nIikucmVtb3ZlQ2xhc3MoInRvb2xib3gtZHJvcHBpbmciKTsNCiAgICAgICAgICAgIHRoaXMuJCgiLnpnLWhlaWdodC1maXgiKS5yZW1vdmVDbGFzcygiemctaGVpZ2h0LWZpeCIpOw0KICAgICAgICAgICAgdGhpcy4kKCIuc3hhLWRpc2FibGVkLXBsYWNlaG9sZGVyIikucmVtb3ZlQ2xhc3MoInN4YS1kaXNhYmxlZC1wbGFjZWhvbGRlciIpOw0KICAgICAgICAgICAgdGhpcy4kKCIuemctZGVsaWdodGZ1bC1kcm9wcGFibGUiKS5yZW1vdmUoKTsNCiAgICAgICAgICAgIHRoaXMuJCgiLm5vdGlmeS1ib3giKS5yZW1vdmUoKTsNCiAgICAgICAgICAgIHRoaXMuY3VycmVudENocm9tZSA9IG51bGw7DQogICAgICAgICAgICBTaXRlY29yZS5QYWdlTW9kZXMuQ2hyb21lSGlnaGxpZ2h0TWFuYWdlci5oaWdobGlnaHRDaHJvbWVzKCk7DQogICAgICAgICAgICBTaXRlY29yZS5QYWdlTW9kZXMuQ2hyb21lSGlnaGxpZ2h0TWFuYWdlci5wbGFuVXBkYXRlKCk7DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5wcmVwYXJlRHJvcHBhYmxlUGxhY2Vob2xkZXJzID0gZnVuY3Rpb24gKHJlbmRlcmluZywgaW52b2tlcikgew0KICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgICAgIHZhciBvcGVuZWRQbGFjZWhvbGRlcnMgPSB0aGlzLiQoIi5zY3BtW2Nocm9tZXR5cGU9XCJwbGFjZWhvbGRlclwiXVtraW5kPVwib3BlblwiXSIpLCBwbGFjZWhvbGRlcnNSZW5kZXJpbmdzID0gdGhpcy5nZXRQbGFjZWhvbGRlcnNSZW5kZXJpbmdzKCksIGlzTW92aW5nQ29tcG9uZW50ID0gcmVuZGVyaW5nLmRhdGEoIm1vdmluZyIpICE9PSB1bmRlZmluZWQsIGNoZWNrID0gcmVuZGVyaW5nLmRhdGEoImdldFBsYWNlaG9sZGVyUG9zaXRpb25DaGFuZ2UiKSB8fCAoZnVuY3Rpb24gKG8sIG0sIGcpIHsgcmV0dXJuICgtMSk7IH0pLCBjb21wb25lbnRQbGFjZWhvbGRlcjsNCiAgICAgICAgICAgIGlmIChyZW5kZXJpbmcuZGF0YSgiY29tcG9uZW50IikgIT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgICAgIGNvbXBvbmVudFBsYWNlaG9sZGVyID0gdGhpcy4kKHJlbmRlcmluZy5kYXRhKCJjb21wb25lbnQiKS50eXBlLmdldFBsYWNlaG9sZGVyKCkub3BlbmluZ01hcmtlcigpKS5hdHRyKCJrZXkiKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIG9wZW5lZFBsYWNlaG9sZGVycy5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkgew0KICAgICAgICAgICAgICAgIHZhciBwaCA9IF90aGlzLiQoZWxlbWVudCksIHBsYWNlaG9sZGVyUmVuZGVyaW5ncyA9IHBsYWNlaG9sZGVyc1JlbmRlcmluZ3MuZmlsdGVyKGZ1bmN0aW9uIChwaHIpIHsgcmV0dXJuIChwaHIubmFtZSA9PT0gcGguYXR0cigia2V5IikpOyB9KTsNCiAgICAgICAgICAgICAgICBpZiAocGxhY2Vob2xkZXJzUmVuZGVyaW5ncy5sZW5ndGggPiAwKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBkc3RQaCA9IHBoWzBdLmF0dHJpYnV0ZXNbJ2tleSddLnZhbHVlOw0KICAgICAgICAgICAgICAgICAgICB2YXIgc3JjUGggPSBjb21wb25lbnRQbGFjZWhvbGRlcjsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHBoVmFsaWRhdG9yID0gbmV3IFNYQS5GZWF0dXJlLkNvbXBvc2l0ZXMuQ29tcG9zaXRlUGxhY2Vob2xkZXJWYWxpZGF0b3IoKTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKHNyY1BoID09IG51bGwgfHwgcGhWYWxpZGF0b3IudmFsaWRhdGUoZHN0UGgsIHNyY1BoKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY3JlYXRlUGxhY2Vob2xkZXJzLmNhbGwoX3RoaXMsIHBoLCByZW5kZXJpbmcsIGNvbXBvbmVudFBsYWNlaG9sZGVyLCBjaGVjaywgaXNNb3ZpbmdDb21wb25lbnQsIHBsYWNlaG9sZGVyUmVuZGVyaW5nc1swXSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIGlmICh0eXBlb2YgaW52b2tlciAhPT0gInVuZGVmaW5lZCIpIHsNCiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsaWNrKCk7DQogICAgICAgICAgICAgICAgaW52b2tlci5kcm9wcGFibGUoew0KICAgICAgICAgICAgICAgICAgICBkcm9wOiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5pc1Rvb2xib3hEcm9wID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdmFyIGRyb3BQbGFjZXMgPSB0aGlzLmdldFBvc3NpYmxlRHJvcFBsYWNlcygpOw0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkcm9wUGxhY2VzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgICAgdmFyIGVsZW1lbiA9IGRyb3BQbGFjZXNbaV07DQogICAgICAgICAgICAgICAgd2hpbGUgKGVsZW1lbi5hdHRyaWJ1dGVzWydrZXknXSA9PSBudWxsKSB7DQogICAgICAgICAgICAgICAgICAgIGVsZW1lbiA9IGVsZW1lbi5wcmV2aW91c0VsZW1lbnRTaWJsaW5nOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB2YXIgZHN0UGggPSBlbGVtZW4uYXR0cmlidXRlc1sna2V5J10udmFsdWU7DQogICAgICAgICAgICAgICAgdmFyIHNyY1BoID0gY29tcG9uZW50UGxhY2Vob2xkZXI7DQogICAgICAgICAgICAgICAgdmFyIHBoVmFsaWRhdG9yID0gbmV3IFNYQS5GZWF0dXJlLkNvbXBvc2l0ZXMuQ29tcG9zaXRlUGxhY2Vob2xkZXJWYWxpZGF0b3IoKTsNCiAgICAgICAgICAgICAgICBpZiAoc3JjUGggPT0gbnVsbCB8fCBwaFZhbGlkYXRvci52YWxpZGF0ZShkc3RQaCwgc3JjUGgpKSB7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZURyYXBhYmlsaXR5LmNhbGwodGhpcywgdGhpcy4kKGRyb3BQbGFjZXNbaV0pLCByZW5kZXJpbmcsIGNvbXBvbmVudFBsYWNlaG9sZGVyLCBpc01vdmluZ0NvbXBvbmVudCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdGhpcy4kKCIuc2NFbXB0eVBsYWNlaG9sZGVyLnVpLWRyb3BwYWJsZS5zeGEtdG9vbGJveC1kcm9wcGFibGUiKS5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWxlbSkgew0KICAgICAgICAgICAgICAgIHZhciAkZWxlbSA9IF90aGlzLiQoZWxlbSk7DQogICAgICAgICAgICAgICAgaWYgKCRlbGVtLnByZXZBbGwoImNvZGUiKS5hdHRyKCJpZCIpID09PSAkZWxlbS5hdHRyKCJzYy1wbGFjZWhvbGRlci1pZCIpKSB7DQogICAgICAgICAgICAgICAgICAgICRlbGVtLmh0bWwoX3RoaXMuJChlbGVtKS5wcmV2QWxsKCJjb2RlIikuYXR0cigia2V5IikpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgU2l0ZWNvcmUuUGFnZU1vZGVzLkNocm9tZUhpZ2hsaWdodE1hbmFnZXIuaGlnaGxpZ2h0Q2hyb21lcygpOw0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuY2xlYXJEcm9wcGFibGVQbGFjZWhvbGRlcnMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICB2YXIgaTsNCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLmRyb3BwYWJsZVBsYWNlaG9sZGVycy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgIGlmICghdGhpcy5kcm9wcGFibGVQbGFjZWhvbGRlcnNbaV0uaGFzQ2xhc3MoInRvb2xib3gtZHJvcHBpbmciKSkgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLmRyb3BwYWJsZVBsYWNlaG9sZGVyc1tpXS5yZW1vdmUoKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLmRyb3BwYWJsZVBsYWNlaG9sZGVycyA9IFtdOw0KICAgICAgICAgICAgdGhpcy4kKCIuc3hhLXRvb2xib3gtZGl2LnVpLWRyb3BwYWJsZSwuc2NFbXB0eVBsYWNlaG9sZGVyLnN4YS10b29sYm94LWRyb3BwYWJsZSIpLm5vdCgiLnRvb2xib3gtZHJvcHBpbmciKS5yZW1vdmVDbGFzcygic3hhLXRvb2xib3gtZHJvcHBhYmxlIikuaHRtbCgiIik7DQogICAgICAgICAgICB0aGlzLiQoIi56Zy1oZWlnaHQtZml4IikucmVtb3ZlQ2xhc3MoInpnLWhlaWdodC1maXgiKTsNCiAgICAgICAgICAgIHRoaXMuJCgiLnN4YS1kaXNhYmxlZC1wbGFjZWhvbGRlciIpLnJlbW92ZUNsYXNzKCJzeGEtZGlzYWJsZWQtcGxhY2Vob2xkZXIiKTsNCiAgICAgICAgICAgIHRoaXMuJCgiLm5vdGlmeS1ib3giKS5yZW1vdmUoKTsNCiAgICAgICAgICAgIHRoaXMubW91c2VNYW5hZ2VyLnN0b3BUcmFja2luZygpOw0KICAgICAgICAgICAgdGhpcy5ub3RpZnlQbGFjZWhvbGRlcnNQb3NpdGlvbnMgPSB7fTsNCiAgICAgICAgICAgIHRoaXMubm90aWZ5Qm94UG9zaXRpb25zID0ge307DQogICAgICAgICAgICB0aGlzLiQoIi5zY0VtcHR5UGxhY2Vob2xkZXIiKS5jc3MoIndpZHRoIiwgIiIpOw0KICAgICAgICAgICAgdGhpcy4kKCIuemctZGVsaWdodGZ1bC1kcm9wcGFibGUtaW1hZ2UiKS5hdHRyKCJsZWZ0IiwgIi0yM3B4Iik7DQogICAgICAgICAgICBTaXRlY29yZS5QYWdlTW9kZXMuQ2hyb21lSGlnaGxpZ2h0TWFuYWdlci5oaWdobGlnaHRDaHJvbWVzKCk7DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5yZWZyZXNoQ29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHZhciBpLCBqLCBjaHJvbWUsIGNocm9tZUtleTsNCiAgICAgICAgICAgIGlmICghWEEuaGFzUGFnZU1vZGVzKCkpDQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgdGhpcy5hbGxvd2VkUmVuZGVyaW5ncyA9IFtdOw0KICAgICAgICAgICAgdGhpcy5wbGFjZWhvbGRlcnMgPSB7fTsNCiAgICAgICAgICAgIHRoaXMuY2hyb21lcyA9IFNpdGVjb3JlLlBhZ2VNb2Rlcy5DaHJvbWVNYW5hZ2VyLmNocm9tZXMoKTsNCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLmNocm9tZXMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICBjaHJvbWUgPSB0aGlzLmNocm9tZXNbaV07DQogICAgICAgICAgICAgICAgaWYgKGNocm9tZS5kYXRhICE9PSB1bmRlZmluZWQgJiYgY2hyb21lLmRhdGEuY3VzdG9tICE9PSB1bmRlZmluZWQgJiYgY2hyb21lLmRhdGEuY3VzdG9tLmFsbG93ZWRSZW5kZXJpbmdzICE9PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGNocm9tZVJlbmRlcmluZ3MgPSBjaHJvbWUuZGF0YS5jdXN0b20uYWxsb3dlZFJlbmRlcmluZ3M7DQogICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBjaHJvbWVSZW5kZXJpbmdzLmxlbmd0aDsgaisrKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy4kLmluQXJyYXkoY2hyb21lUmVuZGVyaW5nc1tqXSwgdGhpcy5hbGxvd2VkUmVuZGVyaW5ncykgPT09IC0xKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hbGxvd2VkUmVuZGVyaW5ncy5wdXNoKGNocm9tZVJlbmRlcmluZ3Nbal0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGlmIChjaHJvbWUuX29yaWdpbmFsRE9NRWxlbWVudC5sZW5ndGggPiAwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBjaHJvbWVLZXkgPSBjaHJvbWUuX29yaWdpbmFsRE9NRWxlbWVudFswXS5hdHRyaWJ1dGVzWyJrZXkiXTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaHJvbWVLZXkgIT09IHVuZGVmaW5lZCAmJiBjaHJvbWVLZXkgIT09IG51bGwpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYWNlaG9sZGVyc1tjaHJvbWVLZXkudmFsdWVdID0gY2hyb21lUmVuZGVyaW5nczsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLmdldEN1cnJlbnRDaHJvbWUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Q2hyb21lOw0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuZ2V0QWxsb3dlZFJlbmRlcmluZ3MgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5hbGxvd2VkUmVuZGVyaW5nczsNCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLmluaXRNb3ZlQ29tcG9uZW50UGx1Z0luID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzLCBzaXRlY29yZVNvcnRpbmcsIHNjSW5zZXJ0U29ydGluZ0hhbmRsZSwgc3hhSW5zZXJ0U29ydGluZ0hhbmRsZSwgc2NTb3J0aW5nSGFuZGxlcjsNCiAgICAgICAgICAgIGlmICghWEEuaGFzUGFnZU1vZGVzKCkpDQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgc2l0ZWNvcmVTb3J0aW5nID0gU2l0ZWNvcmUuUGFnZU1vZGVzLkNocm9tZVR5cGVzLlBsYWNlaG9sZGVyU29ydGluZy5wcm90b3R5cGU7DQogICAgICAgICAgICBzY0luc2VydFNvcnRpbmdIYW5kbGUgPSBzaXRlY29yZVNvcnRpbmcuaW5zZXJ0U29ydGluZ0hhbmRsZTsNCiAgICAgICAgICAgIHN4YUluc2VydFNvcnRpbmdIYW5kbGUgPSBmdW5jdGlvbiAod2hlcmUsIGNocm9tZSwgaW5zZXJ0UG9zaXRpb24sIHBvc2l0aW9uQ291bnQpIHsNCiAgICAgICAgICAgICAgICB2YXIgY2xpY2tIYW5kbGVycywgbGFzdEhhbmRsZXIsIGJpbmRFdmVudDsNCiAgICAgICAgICAgICAgICBzY1NvcnRpbmdIYW5kbGVyID0gdGhpczsNCiAgICAgICAgICAgICAgICBzY0luc2VydFNvcnRpbmdIYW5kbGUuY2FsbChzY1NvcnRpbmdIYW5kbGVyLCB3aGVyZSwgY2hyb21lLCBpbnNlcnRQb3NpdGlvbiwgcG9zaXRpb25Db3VudCk7DQogICAgICAgICAgICAgICAgY2xpY2tIYW5kbGVycyA9IHNjU29ydGluZ0hhbmRsZXIuaGFuZGxlcy5zcGxpY2UoMCk7DQogICAgICAgICAgICAgICAgbGFzdEhhbmRsZXIgPSAkc2MoY2xpY2tIYW5kbGVyc1tjbGlja0hhbmRsZXJzLmxlbmd0aCAtIDFdKTsNCiAgICAgICAgICAgICAgICBsYXN0SGFuZGxlci51bmJpbmQoImNsaWNrIik7DQogICAgICAgICAgICAgICAgYmluZEV2ZW50ID0gZnVuY3Rpb24gKHApIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHBvc2l0aW9uID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gcDsgfSgpOw0KICAgICAgICAgICAgICAgICAgICBsYXN0SGFuZGxlci5jbGljaygkc2MucHJveHkoZnVuY3Rpb24gKGUpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnRUcmVlID0gc2VsZi5nZXRDb21wb25lbnRUcmVlKHRoaXMucmVuZGVyaW5nKSwgY29tcG9uZW50ID0gdGhpcy5yZW5kZXJpbmc7DQogICAgICAgICAgICAgICAgICAgICAgICBlLnN0b3AoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5EZXNpZ25NYW5hZ2VyLnNvcnRpbmdFbmQoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5EZXNpZ25NYW5hZ2VyLm1vdmVDb250cm9sVG8oY29tcG9uZW50LCB0aGlzLnBsYWNlaG9sZGVyLCBwb3NpdGlvbik7DQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm1vdmVDb21wb25lbnRUcmVlKGNvbXBvbmVudCwgY29tcG9uZW50VHJlZSk7DQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnBvc3RNb3ZlQWN0aW9ucyhjb21wb25lbnQpOw0KICAgICAgICAgICAgICAgICAgICB9LCBzY1NvcnRpbmdIYW5kbGVyKSk7DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICBiaW5kRXZlbnQoaW5zZXJ0UG9zaXRpb24pOw0KICAgICAgICAgICAgICAgIHNjU29ydGluZ0hhbmRsZXIuaGFuZGxlcyA9IGNsaWNrSGFuZGxlcnM7DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICBzaXRlY29yZVNvcnRpbmcuaW5zZXJ0U29ydGluZ0hhbmRsZSA9IHN4YUluc2VydFNvcnRpbmdIYW5kbGU7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXRjaCAoZSkgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuaW5pdERlbGV0ZUNvbXBvbmVudFBsdWdJbiA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgICAgICBpZiAoIVhBLmhhc1BhZ2VNb2RlcygpKQ0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpcywgc2l0ZWNvcmVSZW5kZXJpbmcgPSBTaXRlY29yZS5QYWdlTW9kZXMuQ2hyb21lVHlwZXMuUmVuZGVyaW5nLnByb3RvdHlwZSwgc2l0ZWNvcmVEZWxldGVDb250cm9sID0gc2l0ZWNvcmVSZW5kZXJpbmcuZGVsZXRlQ29udHJvbCwgY3NzQ2xhc3MgPSAiemctY2FzY2FkZS1kZWxldGUiLCBzZXRTdHlsZVZpc2libGUgPSBmdW5jdGlvbiAodmlzaWJsZSwgaHRtbEVsZW1lbnRzKSB7DQogICAgICAgICAgICAgICAgdmFyIHRvU3R5bGUgPSBfdGhpcy4kKGh0bWxFbGVtZW50cykuZmlsdGVyKCIuc2NFbmFibGVkQ2hyb21lIik7DQogICAgICAgICAgICAgICAgaWYgKHZpc2libGUpIHsNCiAgICAgICAgICAgICAgICAgICAgdG9TdHlsZS5hZGRDbGFzcyhjc3NDbGFzcyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICB0b1N0eWxlLnJlbW92ZUNsYXNzKGNzc0NsYXNzKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LCBkb2VzVXNlckNvbmZpcm1DYXNjYWRlRGVsZXRlID0gZnVuY3Rpb24gKGNvbXBvbmVudFRyZWUpIHsNCiAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZSA9ICJUaGlzIG9wZXJhdGlvbiB3aWxsIGRlbGV0ZSB0aGUgZm9sbG93aW5nIG5lc3RlZCBjb21wb25lbnRzOlxuIiwgY3VycmVudCwgaTsNCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29tcG9uZW50VHJlZS5iZnMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGNvbXBvbmVudFRyZWUuYmZzW2ldOw0KICAgICAgICAgICAgICAgICAgICBtZXNzYWdlICs9ICJcdTAwQjcgIiArIGN1cnJlbnQubm9kZS5fZGlzcGxheU5hbWUgKyAiXG4iOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXR1cm4gY29uZmlybShtZXNzYWdlKTsNCiAgICAgICAgICAgIH0sIGRlbGV0ZU5lc3RlZENvbXBvbmVudHMgPSBmdW5jdGlvbiAoY29tcG9uZW50VHJlZSkgew0KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50LCBjb250ZXh0LCBpOw0KICAgICAgICAgICAgICAgIGZvciAoaSA9IGNvbXBvbmVudFRyZWUuYmZzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7DQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjb21wb25lbnRUcmVlLmJmc1tpXS5ub2RlOw0KICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gY3VycmVudC50eXBlOw0KICAgICAgICAgICAgICAgICAgICBzaXRlY29yZURlbGV0ZUNvbnRyb2wuY2FsbChjb250ZXh0LCBjdXJyZW50LnR5cGUuY2hyb21lKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LCB6Z0RlbGV0ZUNvbnRyb2wgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0aGlzLCBjb21wb25lbnQgPSBjb250ZXh0LmNocm9tZSwgaHRtbEVsZW1lbnRzLCBjb21wb25lbnRUcmVlID0gc2VsZi5nZXRDb21wb25lbnRUcmVlKGNvbXBvbmVudCk7DQogICAgICAgICAgICAgICAgaWYgKGNvbXBvbmVudFRyZWUuYmZzLmxlbmd0aCAhPT0gMSkgew0KICAgICAgICAgICAgICAgICAgICBodG1sRWxlbWVudHMgPSBjb21wb25lbnRUcmVlLm5vZGUuZWxlbWVudDsNCiAgICAgICAgICAgICAgICAgICAgc2V0U3R5bGVWaXNpYmxlKHRydWUsIGh0bWxFbGVtZW50cyk7DQogICAgICAgICAgICAgICAgICAgIGlmIChkb2VzVXNlckNvbmZpcm1DYXNjYWRlRGVsZXRlKGNvbXBvbmVudFRyZWUpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGVOZXN0ZWRDb21wb25lbnRzKGNvbXBvbmVudFRyZWUpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHNldFN0eWxlVmlzaWJsZShmYWxzZSwgaHRtbEVsZW1lbnRzKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIHNpdGVjb3JlRGVsZXRlQ29udHJvbC5jYWxsKGNvbnRleHQsIGNvbXBvbmVudCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIHRyeSB7DQogICAgICAgICAgICAgICAgc2l0ZWNvcmVSZW5kZXJpbmcuZGVsZXRlQ29udHJvbCA9IHpnRGVsZXRlQ29udHJvbDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhdGNoIChlKSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5pbml0VG91Y2hEcmFnTkRyb3BQbHVnSW4gPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAhZnVuY3Rpb24gKGEpIHsNCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBmKGEsIGIpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKCEoYS5vcmlnaW5hbEV2ZW50LnRvdWNoZXMubGVuZ3RoID4gMSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGEucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjID0gYS5vcmlnaW5hbEV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLCBkID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIk1vdXNlRXZlbnRzIik7DQogICAgICAgICAgICAgICAgICAgICAgICBkLmluaXRNb3VzZUV2ZW50KGIsICEwLCAhMCwgd2luZG93LCAxLCBjLnNjcmVlblgsIGMuc2NyZWVuWSwgYy5jbGllbnRYLCBjLmNsaWVudFksICExLCAhMSwgITEsICExLCAwLCBudWxsKSwgYS50YXJnZXQuZGlzcGF0Y2hFdmVudChkKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZiAoYS5zdXBwb3J0LnRvdWNoID0gIm9udG91Y2hlbmQiIGluIGRvY3VtZW50LCBhLnN1cHBvcnQudG91Y2gpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGUsIGIgPSBhLnVpLm1vdXNlLnByb3RvdHlwZSwgYyA9IGIuX21vdXNlSW5pdCwgZCA9IGIuX21vdXNlRGVzdHJveTsNCiAgICAgICAgICAgICAgICAgICAgYi5fdG91Y2hTdGFydCA9IGZ1bmN0aW9uIChhKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYiA9IHRoaXM7DQogICAgICAgICAgICAgICAgICAgICAgICAhZSAmJiBiLl9tb3VzZUNhcHR1cmUoYS5vcmlnaW5hbEV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdKSAmJiAoZSA9ICEwLCBiLl90b3VjaE1vdmVkID0gITEsIGYoYSwgIm1vdXNlb3ZlciIpLCBmKGEsICJtb3VzZW1vdmUiKSwgZihhLCAibW91c2Vkb3duIikpOw0KICAgICAgICAgICAgICAgICAgICB9LCBiLl90b3VjaE1vdmUgPSBmdW5jdGlvbiAoYSkgeyBlICYmICh0aGlzLl90b3VjaE1vdmVkID0gITAsIGYoYSwgIm1vdXNlbW92ZSIpKTsgfSwgYi5fdG91Y2hFbmQgPSBmdW5jdGlvbiAoYSkgeyBlICYmIChmKGEsICJtb3VzZXVwIiksIGYoYSwgIm1vdXNlb3V0IiksIHRoaXMuX3RvdWNoTW92ZWQgfHwgZihhLCAiY2xpY2siKSwgZSA9ICExKTsgfSwgYi5fbW91c2VJbml0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGIgPSB0aGlzOw0KICAgICAgICAgICAgICAgICAgICAgICAgYi5lbGVtZW50LmJpbmQoeyB0b3VjaHN0YXJ0OiBhLnByb3h5KGIsICJfdG91Y2hTdGFydCIpLCB0b3VjaG1vdmU6IGEucHJveHkoYiwgIl90b3VjaE1vdmUiKSwgdG91Y2hlbmQ6IGEucHJveHkoYiwgIl90b3VjaEVuZCIpIH0pLCBjLmNhbGwoYik7DQogICAgICAgICAgICAgICAgICAgIH0sIGIuX21vdXNlRGVzdHJveSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiID0gdGhpczsNCiAgICAgICAgICAgICAgICAgICAgICAgIGIuZWxlbWVudC51bmJpbmQoeyB0b3VjaHN0YXJ0OiBhLnByb3h5KGIsICJfdG91Y2hTdGFydCIpLCB0b3VjaG1vdmU6IGEucHJveHkoYiwgIl90b3VjaE1vdmUiKSwgdG91Y2hlbmQ6IGEucHJveHkoYiwgIl90b3VjaEVuZCIpIH0pLCBkLmNhbGwoYik7DQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSh0aGlzLiQpOw0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgICAgICBpZiAoIVhBLmhhc1BhZ2VNb2RlcygpKQ0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5DaHJvbWVNYW5hZ2VyLmNocm9tZXNSZXNldGVkLm9ic2VydmUoJHNjLnByb3h5KGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICBfdGhpcy5jbGVhbnVwKCk7DQogICAgICAgICAgICB9KSk7DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5nZXRQb3NzaWJsZURyb3BQbGFjZXMgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICAgICAgdmFyIGRyb3BQbGFjZXMgPSB0aGlzLiQoIi5zeGEtdG9vbGJveC1kaXYsLnNjRW1wdHlQbGFjZWhvbGRlciIpLm5vdCgiLnVpLWRyb3BwYWJsZSIpLnRvQXJyYXkoKTsNCiAgICAgICAgICAgIGRyb3BQbGFjZXMuc29ydChmdW5jdGlvbiAoZmlyc3QsIHNlY29uZCkgew0KICAgICAgICAgICAgICAgIHZhciBmaXJzdEtleSA9IF90aGlzLiQoZmlyc3QpLmZpbmQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZSIpLmF0dHIoImtleSIpLCBzZWNvbmRLZXkgPSBfdGhpcy4kKHNlY29uZCkuZmluZCgiLnpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlIikuYXR0cigia2V5Iik7DQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmaXJzdEtleSA9PT0gInVuZGVmaW5lZCIpIHsNCiAgICAgICAgICAgICAgICAgICAgZmlyc3RLZXkgPSBfdGhpcy4kKGZpcnN0KS5wcmV2QWxsKCJjb2RlIikNCiAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGluZGV4LCBlbGVtZW50KSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuJChlbGVtZW50KS5hdHRyKCdrZXknKTsNCiAgICAgICAgICAgICAgICAgICAgfSkuYXR0cigia2V5Iik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2Vjb25kS2V5ID09PSAidW5kZWZpbmVkIikgew0KICAgICAgICAgICAgICAgICAgICBzZWNvbmRLZXkgPSBfdGhpcy4kKHNlY29uZCkucHJldkFsbCgiY29kZSIpLmZpbHRlcihmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy4kKGVsZW1lbnQpLmF0dHIoJ2tleScpOw0KICAgICAgICAgICAgICAgICAgICB9KS5hdHRyKCJrZXkiKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLmNvdW50U2xhc2hlcyhmaXJzdEtleSkgLSBfdGhpcy5jb3VudFNsYXNoZXMoc2Vjb25kS2V5KTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgcmV0dXJuIGRyb3BQbGFjZXM7DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5jb3VudFNsYXNoZXMgPSBmdW5jdGlvbiAocGgpIHsNCiAgICAgICAgICAgIHJldHVybiAocGgubWF0Y2goL1wvL2cpIHx8IFtdKS5sZW5ndGg7DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5jcmVhdGVQbGFjZWhvbGRlckh0bWxFbGVtZW50ID0gZnVuY3Rpb24gKHBsYWNlaG9sZGVyLCBwbGhJZCwgZGlzYWJsZWQpIHsNCiAgICAgICAgICAgIGlmIChkaXNhYmxlZCA9PT0gdm9pZCAwKSB7IGRpc2FibGVkID0gdHJ1ZTsgfQ0KICAgICAgICAgICAgaWYgKHBsYWNlaG9sZGVyLm5leHQoKSAhPSBudWxsKSB7DQogICAgICAgICAgICAgICAgdmFyIHRlbXBQaElkID0gcGxhY2Vob2xkZXIubmV4dCgpLmF0dHIoImhpbnRuYW1lIik7DQogICAgICAgICAgICAgICAgdmFyIGluZGV4T2ZMYXN0U2xhc2ggPSBwbGhJZC5sYXN0SW5kZXhPZignLycpOw0KICAgICAgICAgICAgICAgIGlmIChpbmRleE9mTGFzdFNsYXNoID4gMCkgew0KICAgICAgICAgICAgICAgICAgICBwbGhJZCA9IHBsaElkLnN1YnN0cmluZygwLCBpbmRleE9mTGFzdFNsYXNoICsgMSkgKyB0ZW1wUGhJZDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIHBsaElkID0gdGVtcFBoSWQ7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdmFyIGRyb3BQbGFjZSA9IHRoaXMuJCgiPGRpdiBjbGFzcz1cInpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlXCIga2V5PVwiIiArIHBsaElkICsgIlwiIHN0eWxlPVwid2lkdGg6ICIgKyBwbGFjZWhvbGRlci5jc3MoIndpZHRoIikgKyAiOyB2aXNpYmlsaXR5OiBoaWRkZW5cIj4iICsNCiAgICAgICAgICAgICAgICAiPGRpdiBjbGFzcz1cImlubmVyXCI+PC9kaXY+IiArDQogICAgICAgICAgICAgICAgIjwvZGl2PiIpOw0KICAgICAgICAgICAgaWYgKGRpc2FibGVkKSB7DQogICAgICAgICAgICAgICAgcGxhY2Vob2xkZXIuYXBwZW5kKGRyb3BQbGFjZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBwbGFjZWhvbGRlci5hZGRDbGFzcygic3hhLXRvb2xib3gtZHJvcHBhYmxlIik7DQogICAgICAgICAgICBpZiAoIXBsYWNlaG9sZGVyLmhhc0NsYXNzKCJzeGEtdG9vbGJveC1kaXYiKSkgew0KICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyLmNzcygid2lkdGgiLCBwbGFjZWhvbGRlci5wYXJlbnQoKS5jc3MoIndpZHRoIikpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgaWYgKHBsYWNlaG9sZGVyLmhhc0NsYXNzKCJzY0VtcHR5UGxhY2Vob2xkZXIiKSkgew0KICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyLnBhcmVudCgpLmFkZENsYXNzKCJ6Zy1oZWlnaHQtZml4Iik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoIWRpc2FibGVkKSB7DQogICAgICAgICAgICAgICAgcGxhY2Vob2xkZXIucGFyZW50KCkuYWRkQ2xhc3MoInN4YS1kaXNhYmxlZC1wbGFjZWhvbGRlciIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuaW5pdGlhbGl6ZURyYXBhYmlsaXR5ID0gZnVuY3Rpb24gKHBsYWNlaG9sZGVyLCByZW5kZXJpbmcsIGNvbXBvbmVudFBsYWNlaG9sZGVyLCBpc01vdmluZ0NvbXBvbmVudCkgew0KICAgICAgICAgICAgdmFyIHBsaElkID0gcGxhY2Vob2xkZXIuYXR0cigic2MtcGxhY2Vob2xkZXItaWQiKSwgc2VsZiA9IHRoaXM7DQogICAgICAgICAgICBpZiAocGxhY2Vob2xkZXIucHJldkFsbCgiY29kZSIpLmF0dHIoImlkIikgPT09IHBsaElkKSB7DQogICAgICAgICAgICAgICAgcGxoSWQgPSBwbGFjZWhvbGRlci5wcmV2QWxsKCJjb2RlIikuYXR0cigia2V5Iik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoaXNNb3ZpbmdDb21wb25lbnQgJiYgcmVuZGVyaW5nLmRhdGEoImlzUGxhY2Vob2xkZXJOZXN0ZWRJbnNpZGVDb21wb25lbnQiKShjb21wb25lbnRQbGFjZWhvbGRlciwgcGxoSWQsIHJlbmRlcmluZykpIHsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAodGhpcy4kLmluQXJyYXkocmVuZGVyaW5nLmRhdGEoImlkIiksIHRoaXMucGxhY2Vob2xkZXJzW3BsaElkXSkgIT09IC0xKSB7DQogICAgICAgICAgICAgICAgaWYgKHBsYWNlaG9sZGVyLmNoaWxkcmVuKCIuemctZGVsaWdodGZ1bC1kcm9wcGFibGUiKS5sZW5ndGggPT09IDApIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVQbGFjZWhvbGRlckh0bWxFbGVtZW50KHBsYWNlaG9sZGVyLCBwbGhJZCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyLmZpbmQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZSwgLnpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlLWltYWdlIikubm90KCIuaW5uZXIiKS5kcm9wcGFibGUoew0KICAgICAgICAgICAgICAgICAgICB0b2xlcmFuY2U6ICJwb2ludGVyIiwNCiAgICAgICAgICAgICAgICAgICAgb3V0OiBmdW5jdGlvbiAoZXZlbnQsIHVpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi4kKHRoaXMpLmhhc0NsYXNzKCJ6Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZS1pbWFnZSIpIHx8IHNlbGYuJCh0aGlzKS5wYXJlbnQoKS5oYXNDbGFzcygic2NFbXB0eVBsYWNlaG9sZGVyIikpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm5vdGlmeURyb3BQbGFjZS5jYWxsKHNlbGYsIHRydWUsIHNlbGYuJCh0aGlzKSk7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgIG92ZXI6IGZ1bmN0aW9uIChldmVudCwgdWkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi4kKF90aGlzKS5oYXNDbGFzcygiemctZGVsaWdodGZ1bC1kcm9wcGFibGUtaW1hZ2UiKSB8fCBzZWxmLiQoX3RoaXMpLnBhcmVudCgpLmhhc0NsYXNzKCJzY0VtcHR5UGxhY2Vob2xkZXIiKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm5vdGlmeURyb3BQbGFjZS5jYWxsKHNlbGYsIGZhbHNlLCBzZWxmLiQoX3RoaXMpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9LCA1MCk7DQogICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgIGRyb3A6IGZ1bmN0aW9uIChldmVudCwgdWkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucGxhY2Vob2xkZXJEcm9wKHJlbmRlcmluZywgcGxoSWQsIHVpLCBzZWxmLiQodGhpcykucGFyZW50KCkpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgc2VsZi5oYW5kbGVJbWFnZU1vdXNlTW92ZXMuY2FsbChzZWxmLCBwbGFjZWhvbGRlcik7DQogICAgICAgICAgICAgICAgc2VsZi5oYW5kbGVFbXB0eVBsYWNlaG9sZGVycyhwbGFjZWhvbGRlcik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZVBsYWNlaG9sZGVySHRtbEVsZW1lbnQocGxhY2Vob2xkZXIsIHBsaElkLCBmYWxzZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5oYW5kbGVJbWFnZU1vdXNlTW92ZXMgPSBmdW5jdGlvbiAocGxhY2Vob2xkZXIpIHsNCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsNCiAgICAgICAgICAgIHBsYWNlaG9sZGVyLmZpbmQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZS1pbWFnZSIpLm1vdXNlb3ZlcihmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICAgICAgICB2YXIgJGN1cnJlbnRFbGVtZW50ID0gc2VsZi4kKGV2ZW50LmN1cnJlbnRUYXJnZXQpOw0KICAgICAgICAgICAgICAgIGlmICgkY3VycmVudEVsZW1lbnQuYXR0cigicG9zaXRpb24iKSkgew0KICAgICAgICAgICAgICAgICAgICBzZWxmLiQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZVtrZXk9JyIgKyAkY3VycmVudEVsZW1lbnQuYXR0cigia2V5IikgKyAiJ11bcG9zaXRpb249IiArICRjdXJyZW50RWxlbWVudC5hdHRyKCJwb3NpdGlvbiIpICsgIl0iKS5hZGRDbGFzcygiaG92ZXJlZCIpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgc2VsZi4kKCIuemctZGVsaWdodGZ1bC1kcm9wcGFibGVba2V5PSciICsgJGN1cnJlbnRFbGVtZW50LmF0dHIoImtleSIpICsgIiddIikuYWRkQ2xhc3MoImhvdmVyZWQiKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgJGN1cnJlbnRFbGVtZW50LmFkZENsYXNzKCJob3ZlcmVkLWljb24iKTsNCiAgICAgICAgICAgIH0pLm1vdXNlb3V0KGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgICAgICAgICAgIHZhciAkY3VycmVudEVsZW1lbnQgPSBzZWxmLiQoZXZlbnQuY3VycmVudFRhcmdldCk7DQogICAgICAgICAgICAgICAgaWYgKCRjdXJyZW50RWxlbWVudC5hdHRyKCJwb3NpdGlvbiIpKSB7DQogICAgICAgICAgICAgICAgICAgIHNlbGYuJCgiLnpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlW2tleT0nIiArICRjdXJyZW50RWxlbWVudC5hdHRyKCJrZXkiKSArICInXVtwb3NpdGlvbj0iICsgJGN1cnJlbnRFbGVtZW50LmF0dHIoInBvc2l0aW9uIikgKyAiXSIpLnJlbW92ZUNsYXNzKCJob3ZlcmVkIik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBzZWxmLiQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZVtrZXk9JyIgKyAkY3VycmVudEVsZW1lbnQuYXR0cigia2V5IikgKyAiJ10iKS5yZW1vdmVDbGFzcygiaG92ZXJlZCIpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAkY3VycmVudEVsZW1lbnQucmVtb3ZlQ2xhc3MoImhvdmVyZWQtaWNvbiIpOw0KICAgICAgICAgICAgICAgICRjdXJyZW50RWxlbWVudC5jaGlsZHJlbigpLnJlbW92ZSgpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5oYW5kbGVFbXB0eVBsYWNlaG9sZGVycyA9IGZ1bmN0aW9uIChwbGFjZWhvbGRlcikgew0KICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOw0KICAgICAgICAgICAgaWYgKHBsYWNlaG9sZGVyLmhhc0NsYXNzKCJzY0VtcHR5UGxhY2Vob2xkZXIiKSkgew0KICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyLm1vdXNlb3ZlcihmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgc2VsZi4kKGV2ZW50LmN1cnJlbnRUYXJnZXQpLmZpbmQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZSIpLmFkZENsYXNzKCJob3ZlcmVkIikuY3NzKCJ2aXNpYmlsaXR5IiwgInZpc2libGUiKTsNCiAgICAgICAgICAgICAgICB9KS5tb3VzZW91dChmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKCFldmVudC5jdXJyZW50VGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucygidG9vbGJveC1kcm9wcGluZyIpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLiQoZXZlbnQuY3VycmVudFRhcmdldCkuZmluZCgiLnpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlIikuY3NzKCJ2aXNpYmlsaXR5IiwgImhpZGRlbiIpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5wbGFjZWhvbGRlckRyb3AgPSBmdW5jdGlvbiAocmVuZGVyaW5nLCBwbGhJZCwgdWksIHBsYWNlaG9sZGVyKSB7DQogICAgICAgICAgICBpZiAocmVuZGVyaW5nLmRhdGEoIm1vdmluZyIpICE9PSB1bmRlZmluZWQpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tb3ZlQ29tcG9uZW50KHBsaElkLCByZW5kZXJpbmcsIHBsYWNlaG9sZGVyKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRyb3BDb21wb25lbnQodWksIHBsYWNlaG9sZGVyKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLmNyZWF0ZVBsYWNlaG9sZGVycyA9IGZ1bmN0aW9uICgkb3BlbkNvZGUsIHJlbmRlcmluZywgY29tcG9uZW50UGxhY2Vob2xkZXIsIGNoZWNrLCBpc01vdmluZ0NvbXBvbmVudCwgcGxhY2Vob2xkZXJEYXRhKSB7DQogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KICAgICAgICAgICAgdmFyIGtleSA9ICRvcGVuQ29kZS5hdHRyKCJrZXkiKSwgb3BlbmVkID0gZmFsc2UsICRzaWJsaW5nID0gbnVsbCwgaywgcG9zaXRpb24gPSAwLCByZW5kZXJpbmdzLCBhbGxTaWJsaW5ncywgYWxsUmVuZGVyaW5ncywgcG9zaXRpb25DaGFuZ2U7DQogICAgICAgICAgICBpZiAoIXRoaXMuc2hvdWxkQ3JlYXRlUGxhY2Vob2xkZXIocmVuZGVyaW5nLCAkb3BlbkNvZGUpKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgYWxsU2libGluZ3MgPSAkb3BlbkNvZGUubmV4dEFsbCgiOm5vdChbY2hyb21ldHlwZT0nZmllbGQnXSkiKTsNCiAgICAgICAgICAgIGFsbFJlbmRlcmluZ3MgPSAkb3BlbkNvZGUuc2libGluZ3MoImRpdi5jb21wb25lbnQsZGl2Lmpzb24tY29tcG9uZW50LXdyYXBwZXIiKTsNCiAgICAgICAgICAgIGlmIChpc01vdmluZ0NvbXBvbmVudCAmJiByZW5kZXJpbmcuZGF0YSgiaXNQbGFjZWhvbGRlck5lc3RlZEluc2lkZUNvbXBvbmVudCIpKGNvbXBvbmVudFBsYWNlaG9sZGVyLCBrZXksIHJlbmRlcmluZykpIHsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoYWxsUmVuZGVyaW5ncy5sZW5ndGggPiAwKSB7DQogICAgICAgICAgICAgICAgcmVuZGVyaW5ncyA9IHBsYWNlaG9sZGVyRGF0YS5yZW5kZXJpbmdzOw0KICAgICAgICAgICAgICAgIGlmIChyZW5kZXJpbmdzLmxlbmd0aCA8PSAxICYmIGlzTW92aW5nQ29tcG9uZW50ICYmIGNvbXBvbmVudFBsYWNlaG9sZGVyID09PSBwbGFjZWhvbGRlckRhdGEubmFtZSkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCByZW5kZXJpbmdzLmxlbmd0aDsgaysrKSB7DQogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uQ2hhbmdlID0gY2hlY2socmVuZGVyaW5nLCBrLCBhbGxTaWJsaW5ncyk7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlRHJvcHBhYmxlR3JpZFBsYWNlaG9sZGVyKHRoaXMuJChyZW5kZXJpbmdzW2tdKSwgdHJ1ZSwgcG9zaXRpb24sIHBsYWNlaG9sZGVyRGF0YS5uYW1lKTsNCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24rKzsNCiAgICAgICAgICAgICAgICAgICAgaWYgKGsgPT09IHJlbmRlcmluZ3MubGVuZ3RoIC0gMSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVEcm9wcGFibGVHcmlkUGxhY2Vob2xkZXIodGhpcy4kKHJlbmRlcmluZ3Nba10pLCBmYWxzZSwgcG9zaXRpb24sIHBsYWNlaG9sZGVyRGF0YS5uYW1lKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBhbGxTaWJsaW5ncy5sZW5ndGg7IGsrKykgew0KICAgICAgICAgICAgICAgICAgICAkc2libGluZyA9IHRoaXMuJChhbGxTaWJsaW5nc1trXSk7DQogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uQ2hhbmdlID0gY2hlY2socmVuZGVyaW5nLCBrLCBhbGxTaWJsaW5ncyk7DQogICAgICAgICAgICAgICAgICAgIGlmIChpc01vdmluZ0NvbXBvbmVudCAmJiBwb3NpdGlvbkNoYW5nZSA+PSAwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSBwb3NpdGlvbkNoYW5nZTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGlmICgkc2libGluZy5wcm9wKCJ0YWdOYW1lIikgIT09ICJDT0RFIikgew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wZW5lZCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVEcm9wcGFibGVQbGFjZWhvbGRlcigkc2libGluZywgdHJ1ZSwgcG9zaXRpb24sIGtleSk7DQogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbisrOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRzaWJsaW5nLmF0dHIoImtpbmQiKSA9PT0gIm9wZW4iKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3BlbmVkID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZURyb3BwYWJsZVBsYWNlaG9sZGVyKCRzaWJsaW5nLCB0cnVlLCBwb3NpdGlvbiwga2V5KTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbisrOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRzaWJsaW5nLmF0dHIoImtpbmQiKSA9PT0gImNsb3NlIikgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkc2libGluZy5hdHRyKCJrZXkiKSAhPT0ga2V5KSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wZW5lZCA9IGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHZhciBjb25kaXRpb24gPSBhbGxTaWJsaW5ncy5maWx0ZXIoZnVuY3Rpb24gKGlkeCwgZSkgeyByZXR1cm4gKF90aGlzLiQoZSkuYXR0cigia2luZCIpID09PSAib3BlbiIpOyB9KS5sZW5ndGg7DQogICAgICAgICAgICAgICAgaWYgKHBvc2l0aW9uID4gMCAmJiBjb25kaXRpb24gIT09IHBvc2l0aW9uIC0gMSkgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZURyb3BwYWJsZVBsYWNlaG9sZGVyKCRzaWJsaW5nLCBmYWxzZSwgcG9zaXRpb24sIGtleSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUuY3JlYXRlRHJvcHBhYmxlUGxhY2Vob2xkZXIgPSBmdW5jdGlvbiAoJHNpYmxpbmcsIGJlZm9yZSwgcG9zaXRpb24sIHBsYWNlaG9sZGVyS2V5KSB7DQogICAgICAgICAgICB2YXIgJGRpdiA9IHRoaXMuJCgiPGRpdiBjbGFzcz1cInN4YS10b29sYm94LWRpdlwiIHNjLXBsYWNlaG9sZGVyLWlkPVwiIiArIHBsYWNlaG9sZGVyS2V5ICsgIlwiIHBvc2l0aW9uPVwiIiArIHBvc2l0aW9uICsgIlwiID4iICsNCiAgICAgICAgICAgICAgICAiPGRpdiBjbGFzcz0nemctZGVsaWdodGZ1bC1kcm9wcGFibGUtaW1hZ2UnIHBvc2l0aW9uPVwiIiArIHBvc2l0aW9uICsgIlwiIGtleT1cIiIgKyBwbGFjZWhvbGRlcktleSArICJcIj48L2Rpdj4iICsNCiAgICAgICAgICAgICAgICAiPGRpdiBjbGFzcz1cInpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlXCIgcG9zaXRpb249XCIiICsgcG9zaXRpb24gKyAiXCIga2V5PVwiIiArIHBsYWNlaG9sZGVyS2V5ICsgIlwiPjxkaXYgY2xhc3M9XCJpbm5lclwiPjwvZGl2PjwvZGl2PiIgKw0KICAgICAgICAgICAgICAgICI8L2Rpdj4iKTsNCiAgICAgICAgICAgICRkaXYud2lkdGgoJHNpYmxpbmcucGFyZW50KCkud2lkdGgoKSk7DQogICAgICAgICAgICB0aGlzLmRyb3BQbGFjZWhvbGRlcihiZWZvcmUsICRkaXYsICRzaWJsaW5nKTsNCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLmNyZWF0ZURyb3BwYWJsZUdyaWRQbGFjZWhvbGRlciA9IGZ1bmN0aW9uICgkc2libGluZywgYmVmb3JlLCBwb3NpdGlvbiwgcGxhY2Vob2xkZXJLZXkpIHsNCiAgICAgICAgICAgIHZhciAkZGl2ID0gdGhpcy4kKCI8ZGl2IGNsYXNzPVwic3hhLXRvb2xib3gtZGl2XCIgc2MtcGxhY2Vob2xkZXItaWQ9XCIiICsgcGxhY2Vob2xkZXJLZXkgKyAiXCIgcG9zaXRpb249XCIiICsgcG9zaXRpb24gKyAiXCIgPiIgKw0KICAgICAgICAgICAgICAgICI8ZGl2IGNsYXNzPSd6Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZS1pbWFnZScgcG9zaXRpb249XCIiICsgcG9zaXRpb24gKyAiXCIga2V5PVwiIiArIHBsYWNlaG9sZGVyS2V5ICsgIlwiPjwvZGl2PiIgKw0KICAgICAgICAgICAgICAgICI8ZGl2IGNsYXNzPVwiemctZGVsaWdodGZ1bC1kcm9wcGFibGVcIiBwb3NpdGlvbj1cIiIgKyBwb3NpdGlvbiArICJcIiBrZXk9XCIiICsgcGxhY2Vob2xkZXJLZXkgKyAiXCI+PGRpdiBjbGFzcz1cImlubmVyXCI+PC9kaXY+PC9kaXY+IiArDQogICAgICAgICAgICAgICAgIjwvZGl2PiIpLCByZW5kZXJpbmdQb3NpdGlvbiA9ICRzaWJsaW5nLnBvc2l0aW9uKCksIG91dGVySGVpZ2h0ID0gJHNpYmxpbmcub3V0ZXJIZWlnaHQoKTsNCiAgICAgICAgICAgIGlmIChvdXRlckhlaWdodCA8IDIwKSB7DQogICAgICAgICAgICAgICAgb3V0ZXJIZWlnaHQgKz0gODsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICRkaXYuY3NzKHsNCiAgICAgICAgICAgICAgICB3aWR0aDogJHNpYmxpbmcub3V0ZXJXaWR0aCgpLA0KICAgICAgICAgICAgICAgICJwb3NpdGlvbiI6ICJhYnNvbHV0ZSIsDQogICAgICAgICAgICAgICAgdG9wOiBiZWZvcmUgPyByZW5kZXJpbmdQb3NpdGlvbi50b3AgOiAocmVuZGVyaW5nUG9zaXRpb24udG9wICsgb3V0ZXJIZWlnaHQpLA0KICAgICAgICAgICAgICAgIGxlZnQ6IHJlbmRlcmluZ1Bvc2l0aW9uLmxlZnQNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgaWYgKCFiZWZvcmUpIHsNCiAgICAgICAgICAgICAgICAkZGl2LmZpbmQoIi56Zy1kZWxpZ2h0ZnVsLWRyb3BwYWJsZS1pbWFnZSIpLmFkZENsYXNzKCJyb3RhdGVkIik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLmRyb3BQbGFjZWhvbGRlcihiZWZvcmUsICRkaXYsICRzaWJsaW5nKTsNCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLmRyb3BDb21wb25lbnQgPSBmdW5jdGlvbiAodWksICRwbGgpIHsNCiAgICAgICAgICAgIHZhciAkcGxoLCBwbGhJZCwgY2hyb21lLCBpOw0KICAgICAgICAgICAgaWYgKHRoaXMuaXNUb29sYm94RHJvcCkgew0KICAgICAgICAgICAgICAgIHRoaXMuaXNUb29sYm94RHJvcCA9IGZhbHNlOw0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRDaHJvbWUgIT09IG51bGwpIHsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQogICAgICAgICAgICAkcGxoLmFkZENsYXNzKCJ0b29sYm94LWRyb3BwaW5nIik7DQogICAgICAgICAgICBwbGhJZCA9ICRwbGguYXR0cigic2MtcGxhY2Vob2xkZXItaWQiKTsNCiAgICAgICAgICAgIGlmICgkcGxoLnByZXZBbGwoImNvZGUiKS5hdHRyKCJpZCIpID09PSBwbGhJZCkgew0KICAgICAgICAgICAgICAgIHBsaElkID0gJHBsaC5wcmV2QWxsKCJjb2RlIikuYXR0cigia2V5Iik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5jaHJvbWVzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgICAgY2hyb21lID0gdGhpcy5jaHJvbWVzW2ldOw0KICAgICAgICAgICAgICAgIGlmIChjaHJvbWUuX29yaWdpbmFsRE9NRWxlbWVudC5sZW5ndGggPiAwKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBjaHJvbWUuX29yaWdpbmFsRE9NRWxlbWVudFswXS5hdHRyaWJ1dGVzWyJrZXkiXTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKGtleSAhPT0gdW5kZWZpbmVkICYmIGtleSAhPT0gbnVsbCAmJiBrZXkudmFsdWUgPT09IHBsaElkKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRDaHJvbWUgPSBjaHJvbWU7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHBsaC5hdHRyKCJwb3NpdGlvbiIpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLnR5cGUuX2luc2VydFBvc2l0aW9uID0gJHBsaC5hdHRyKCJwb3NpdGlvbiIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hyb21lLnR5cGUuX2luc2VydFBvc2l0aW9uID0gMDsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5QYWdlRWRpdG9yLmxheW91dERlZmluaXRpb25Db250cm9sKCkudmFsdWUgPSBTaXRlY29yZS5QYWdlTW9kZXMuUGFnZUVkaXRvci5sYXlvdXQoKS52YWwoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5QYWdlRWRpdG9yLnBvc3RSZXF1ZXN0KCJ3ZWJlZGl0OmFkZHJlbmRlcmluZyhwbGFjZWhvbGRlcj0iICsgcGxoSWQgKyAiLHRvb2xib3hSZW5kZXJpbmc9IiArIHVpLmRyYWdnYWJsZS5kYXRhKCJpZCIpICsgIikiKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLm1vdmVDb21wb25lbnQgPSBmdW5jdGlvbiAocGxhY2Vob2xkZXJJZCwgcmVuZGVyaW5nLCBwbGFjZWhvbGRlcikgew0KICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOw0KICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICB2YXIgcGxhY2VIbGRyLCBwb3NpdGlvbiwgY29tcG9uZW50LCB0cmVlLCBkZXZpY2VJZCwgc2l0ZWNvcmVDaHJvbWUsIHJlbmRlcmluZ1VpZDsNCiAgICAgICAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICAgICAgICBjb21wb25lbnQgPSByZW5kZXJpbmcuZGF0YSgiY29tcG9uZW50Iik7DQogICAgICAgICAgICAgICAgICAgIHBsYWNlSGxkciA9IHNlbGYuZ2V0UGxhY2Vob2xkZXJGcm9tSWQocGxhY2Vob2xkZXJJZCk7DQogICAgICAgICAgICAgICAgICAgIGlmIChwbGFjZUhsZHIubGVuZ3RoIDwgMSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgIkNhbm5vdCBmaW5kIHBsYWNlaG9sZGVyIjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChwbGFjZUhsZHIubGVuZ3RoID4gMSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIldhcm5pbmchIFlvdSBoYXZlIHR3byBwbGFjZWhvbGRlcnMgd2l0aCB0aGUgc2FtZSBwYXRoIG9uIHRoZSBwYWdlISIpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uID0gcGxhY2Vob2xkZXIuYXR0cigicG9zaXRpb24iKSB8fCAwOw0KICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbmRlcmluZy5kYXRhKCJpc1Bvc2l0aW9uQ2hhbmdlZCIpKGNvbXBvbmVudCwgcG9zaXRpb24sIHBsYWNlaG9sZGVySWQpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgdHJlZSA9IHJlbmRlcmluZy5kYXRhKCJ0cmVlIik7DQogICAgICAgICAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5EZXNpZ25NYW5hZ2VyLm1vdmVDb250cm9sVG8oY29tcG9uZW50LCBwbGFjZUhsZHJbMF0sIHBvc2l0aW9uKTsNCiAgICAgICAgICAgICAgICAgICAgc2VsZi5tb3ZlQ29tcG9uZW50VHJlZShjb21wb25lbnQsIHRyZWUpOw0KICAgICAgICAgICAgICAgICAgICBzZWxmLnBvc3RNb3ZlQWN0aW9ucyhjb21wb25lbnQpOw0KICAgICAgICAgICAgICAgICAgICBkZXZpY2VJZCA9IFNpdGVjb3JlLkxheW91dERlZmluaXRpb24uZ2V0RGV2aWNlSUQoKTsNCiAgICAgICAgICAgICAgICAgICAgc2l0ZWNvcmVDaHJvbWUgPSBTaXRlY29yZS5QYWdlTW9kZXMuQ2hyb21lTWFuYWdlci5zZWxlY3RlZENocm9tZSgpOw0KICAgICAgICAgICAgICAgICAgICByZW5kZXJpbmdVaWQgPSBzaXRlY29yZUNocm9tZS50eXBlLnVuaXF1ZUlkKCk7DQogICAgICAgICAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5QYWdlRWRpdG9yLnBvc3RSZXF1ZXN0KCJ3ZWJlZGl0OnVwZGF0ZWxheW91dChkZXZpY2VJZD0iICsgZGV2aWNlSWQgKyAiLHJlbmRlcmluZ1VpZD0iICsgcmVuZGVyaW5nVWlkICsgIikiLCBudWxsLCBmYWxzZSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7DQogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0oKTsNCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLm1vdmVDb21wb25lbnRUcmVlID0gZnVuY3Rpb24gKGNvbXBvbmVudCwgdHJlZSkgew0KICAgICAgICAgICAgdmFyIGMsIGN1cnJlbnQsIG5ld1Jvb3RQbGFjZWhvbGRlciwgbmV3UGxhY2Vob2xkZXIsIG9sZFBsYWNlaG9sZGVyLCBsYXlvdXREZWZpbml0aW9uLCBwcm9jZXNzZWRQbGFjZWhvbGRlcnMgPSB7fTsNCiAgICAgICAgICAgIHRyZWUgPSB0cmVlLmJmczsNCiAgICAgICAgICAgIGlmICh0cmVlLmxlbmd0aCA9PT0gMSkgew0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIG9sZFBsYWNlaG9sZGVyID0gdHJlZVswXS5wbGFjZWhvbGRlcjsNCiAgICAgICAgICAgIG5ld1Jvb3RQbGFjZWhvbGRlciA9IHRoaXMuZ2V0UGxhY2Vob2xkZXJGdWxsUGF0aCh0cmVlWzBdLm5vZGUpOw0KICAgICAgICAgICAgbGF5b3V0RGVmaW5pdGlvbiA9IFNpdGVjb3JlLkxheW91dERlZmluaXRpb24uZ2V0TGF5b3V0RGVmaW5pdGlvbigpOw0KICAgICAgICAgICAgZm9yIChjID0gMTsgYyA8IHRyZWUubGVuZ3RoOyBjKyspIHsNCiAgICAgICAgICAgICAgICBjdXJyZW50ID0gdHJlZVtjXTsNCiAgICAgICAgICAgICAgICBpZiAoY3VycmVudC5ub2RlLnR5cGUua2V5KCkgIT09ICJyZW5kZXJpbmciKSB7DQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBuZXdQbGFjZWhvbGRlciA9IGN1cnJlbnQucGxhY2Vob2xkZXIucmVwbGFjZShvbGRQbGFjZWhvbGRlciwgbmV3Um9vdFBsYWNlaG9sZGVyKTsNCiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUxheW91dERlZmluaXRpb24oY3VycmVudC5ub2RlLCBuZXdQbGFjZWhvbGRlciwgbGF5b3V0RGVmaW5pdGlvbik7DQogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVQbGFjZWhvbGRlcih0aGlzLmdldFBsYWNlaG9sZGVyRnVsbFBhdGgoY3VycmVudC5ub2RlKSwgbmV3UGxhY2Vob2xkZXIsIHByb2Nlc3NlZFBsYWNlaG9sZGVycyk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBTaXRlY29yZS5MYXlvdXREZWZpbml0aW9uLnNldExheW91dERlZmluaXRpb24obGF5b3V0RGVmaW5pdGlvbik7DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5nZXRDb21wb25lbnRUcmVlID0gZnVuY3Rpb24gKGNvbXBvbmVudCkgew0KICAgICAgICAgICAgdmFyIHF1ZXVlID0gW10sIHJvb3QsIGN1cnJlbnQsIGMsIHBoLCBjaGlsZHJlbiwgcGxhY2Vob2xkZXJzQmVsb3dSb290ID0gW10sIG5vZGUsIGJmcyA9IFtdLCBpc0NvbXBvbmVudCA9IGZ1bmN0aW9uIChub2RlKSB7IHJldHVybiAobm9kZS50eXBlLmtleSgpID09PSAicmVuZGVyaW5nIik7IH0sIGlzUGxhY2Vob2xkZXIgPSBmdW5jdGlvbiAobm9kZSkgeyByZXR1cm4gKG5vZGUudHlwZS5rZXkoKSA9PT0gInBsYWNlaG9sZGVyIik7IH0sIGdldEZ1bGxQbGFjZWhvbGRlclBhdGggPSBmdW5jdGlvbiAocGFyZW50LCBjdXJyZW50KSB7DQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQudHlwZS5nZXRQbGFjZWhvbGRlciAhPT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnQucGxhY2Vob2xkZXIgKyAiLyIgKyBjdXJyZW50LnR5cGUuZ2V0UGxhY2Vob2xkZXIoKS5kaXNwbGF5TmFtZSgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudC5wbGFjZWhvbGRlcjsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LCBnZXRQb3NpdGlvbkluUGxhY2Vob2xkZXIgPSBmdW5jdGlvbiAoY3VycmVudCkgew0KICAgICAgICAgICAgICAgIGlmIChjdXJyZW50LnR5cGUuZ2V0UGxhY2Vob2xkZXIgIT09IHVuZGVmaW5lZCkgew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gU2l0ZWNvcmUuTGF5b3V0RGVmaW5pdGlvbi5nZXRSZW5kZXJpbmdQb3NpdGlvbkluUGxhY2Vob2xkZXIoY3VycmVudC50eXBlLmdldFBsYWNlaG9sZGVyKCkuZGlzcGxheU5hbWUoKSwgY3VycmVudC50eXBlLnVuaXF1ZUlkKCkpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICByZXR1cm4gLTE7DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgcm9vdCA9IHsgcGFyZW50OiBudWxsLCBub2RlOiBjb21wb25lbnQsIHBsYWNlaG9sZGVyOiBjb21wb25lbnQudHlwZS5nZXRQbGFjZWhvbGRlcigpLm9wZW5pbmdNYXJrZXIoKS5hdHRyKCJrZXkiKSwgcG9zaXRpb246IDAgfTsNCiAgICAgICAgICAgIHF1ZXVlLnB1c2gocm9vdCk7DQogICAgICAgICAgICBiZnMucHVzaChyb290KTsNCiAgICAgICAgICAgIHdoaWxlIChxdWV1ZS5sZW5ndGggPiAwKSB7DQogICAgICAgICAgICAgICAgY3VycmVudCA9IHF1ZXVlLnNoaWZ0KCk7DQogICAgICAgICAgICAgICAgY3VycmVudC5jaGlsZHJlbiA9IFtdOw0KICAgICAgICAgICAgICAgIGNoaWxkcmVuID0gY3VycmVudC5ub2RlLmdldENoaWxkQ2hyb21lcygpOw0KICAgICAgICAgICAgICAgIGZvciAoYyA9IDA7IGMgPCBjaGlsZHJlbi5sZW5ndGg7IGMrKykgew0KICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGRyZW5bY10gIT09IGN1cnJlbnQubm9kZSAmJiBpc0NvbXBvbmVudChjaGlsZHJlbltjXSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50OiBjdXJyZW50LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU6IGNoaWxkcmVuW2NdLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiBnZXRGdWxsUGxhY2Vob2xkZXJQYXRoKGN1cnJlbnQsIGNoaWxkcmVuW2NdKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogZ2V0UG9zaXRpb25JblBsYWNlaG9sZGVyKGNoaWxkcmVuW2NdKQ0KICAgICAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXVlLnB1c2gobm9kZSk7DQogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50LmNoaWxkcmVuLnB1c2gobm9kZSk7DQogICAgICAgICAgICAgICAgICAgICAgICBiZnMucHVzaChub2RlKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpc1BsYWNlaG9sZGVyKGNoaWxkcmVuW2NdKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcGggPSAoY3VycmVudC5wbGFjZWhvbGRlcilbMF0gPT09ICIvIiA/IGN1cnJlbnQucGxhY2Vob2xkZXIgOiAiLyIgKyBjdXJyZW50LnBsYWNlaG9sZGVyOw0KICAgICAgICAgICAgICAgICAgICAgICAgcGggKz0gIi8iICsgY2hpbGRyZW5bY10uZGlzcGxheU5hbWUoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyc0JlbG93Um9vdC5wdXNoKHBoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXVlLnB1c2goeyBub2RlOiBjaGlsZHJlbltjXSwgcGxhY2Vob2xkZXI6IGN1cnJlbnQucGxhY2Vob2xkZXIgfSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICByb290LmJmcyA9IGJmczsNCiAgICAgICAgICAgIHJvb3QuZGVzY2VuZGFudFBsYWNlaG9sZGVycyA9IHBsYWNlaG9sZGVyc0JlbG93Um9vdDsNCiAgICAgICAgICAgIHJldHVybiByb290Ow0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUudXBkYXRlUGxhY2Vob2xkZXIgPSBmdW5jdGlvbiAob2xkUGxhY2Vob2xkZXIsIG5ld1BsYWNlaG9sZGVyLCBwcm9jZXNzZWRQbGFjZWhvbGRlcnMpIHsNCiAgICAgICAgICAgIHZhciBwbGFjZWhvbGRlcjsNCiAgICAgICAgICAgIGlmICghcHJvY2Vzc2VkUGxhY2Vob2xkZXJzLmhhc093blByb3BlcnR5KG9sZFBsYWNlaG9sZGVyKSkgew0KICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyID0gdGhpcy4kKHRoaXMuZ2V0UGxhY2Vob2xkZXJGcm9tSWQob2xkUGxhY2Vob2xkZXIpWzBdLm9wZW5pbmdNYXJrZXIoKSk7DQogICAgICAgICAgICAgICAgcGxhY2Vob2xkZXIuYXR0cigia2V5IiwgbmV3UGxhY2Vob2xkZXIpOw0KICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyLmF0dHIoImlkIiwgbmV3UGxhY2Vob2xkZXIucmVwbGFjZSgvXC8vZywgIl8iKS5yZXBsYWNlKC8tL2csICJfIikpOw0KICAgICAgICAgICAgICAgIHByb2Nlc3NlZFBsYWNlaG9sZGVyc1tvbGRQbGFjZWhvbGRlcl0gPSBuZXdQbGFjZWhvbGRlcjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLnVwZGF0ZUxheW91dERlZmluaXRpb24gPSBmdW5jdGlvbiAoY29tcG9uZW50LCBuZXdQbGFjZWhvbGRlciwgbGF5b3V0RGVmaW5pdGlvbikgew0KICAgICAgICAgICAgdmFyIHVpZCA9IGNvbXBvbmVudC50eXBlLnVuaXF1ZUlkKCksIHJlbmRlcmluZzsNCiAgICAgICAgICAgIHJlbmRlcmluZyA9IHRoaXMuJC5ncmVwKGxheW91dERlZmluaXRpb24uci5kWzBdLnIsIGZ1bmN0aW9uIChlbGVtZW50LCBpZHgpIHsgcmV0dXJuIChTaXRlY29yZS5MYXlvdXREZWZpbml0aW9uLmdldFNob3J0SUQoZWxlbWVudFsiQHVpZCJdKSA9PT0gdWlkKTsgfSk7DQogICAgICAgICAgICBpZiAocmVuZGVyaW5nLmxlbmd0aCA9PT0gMSkgew0KICAgICAgICAgICAgICAgIHJlbmRlcmluZyA9IHJlbmRlcmluZ1swXTsNCiAgICAgICAgICAgICAgICByZW5kZXJpbmdbIkBwaCJdID0gbmV3UGxhY2Vob2xkZXI7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5kcm9wUGxhY2Vob2xkZXIgPSBmdW5jdGlvbiAoYmVmb3JlLCAkZGl2LCAkc2libGluZykgew0KICAgICAgICAgICAgaWYgKCRkaXYud2lkdGgoKSA9PT0gMCAmJiAkc2libGluZy5wYXJlbnQoKS5pcygic3BhbiIpKSB7DQogICAgICAgICAgICAgICAgJGRpdi53aWR0aCgiMTAwJSIpOw0KICAgICAgICAgICAgICAgICRkaXYuaGVpZ2h0KDIwKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICRkaXYuY3NzKCJ2aXNpYmlsaXR5IiwgImhpZGRlbiIpOw0KICAgICAgICAgICAgaWYgKGJlZm9yZSkgew0KICAgICAgICAgICAgICAgICRzaWJsaW5nLmJlZm9yZSgkZGl2KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICRzaWJsaW5nLmFmdGVyKCRkaXYpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdGhpcy5kcm9wcGFibGVQbGFjZWhvbGRlcnMucHVzaCgkZGl2KTsNCiAgICAgICAgICAgIHRoaXMubW91c2VNYW5hZ2VyLnRyYWNrRHJvcFBsYWNlKCRkaXYuZmluZCgiLnpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlLWltYWdlIikpOw0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUubm90aWZ5RHJvcFBsYWNlID0gZnVuY3Rpb24gKGlzVmlzaWJsZSwgcGxhY2Vob2xkZXIpIHsNCiAgICAgICAgICAgIHZhciBwbGFjZWhvbGRlclRleHQsIHBsYWNlaG9sZGVyLCBwb3NpdGlvbiwgb2xkLCAkd3JhcHBlciA9IHRoaXMuJCgiI3dyYXBwZXIiKSwgbm90aWZ5Qm94LCBub3RpZnlJY29uLCBub3RpZnlUZXh0Ow0KICAgICAgICAgICAgcGxhY2Vob2xkZXJUZXh0ID0gcGxhY2Vob2xkZXIuYXR0cigia2V5Iik7DQogICAgICAgICAgICBpZiAocGxhY2Vob2xkZXIuYXR0cigicG9zaXRpb24iKSkgew0KICAgICAgICAgICAgICAgIHBvc2l0aW9uID0gcGFyc2VJbnQocGxhY2Vob2xkZXIuYXR0cigicG9zaXRpb24iKSkgKyAxOw0KICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyVGV4dCArPSAiICgiICsgcG9zaXRpb24gKyAiKSI7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBvbGQgPSAkd3JhcHBlci5maW5kKCIubm90aWZ5LWJveCIpOw0KICAgICAgICAgICAgb2xkLnJlbW92ZSgpOw0KICAgICAgICAgICAgbm90aWZ5Qm94ID0gdGhpcy4kKCI8ZGl2IC8+Iik7DQogICAgICAgICAgICBub3RpZnlJY29uID0gdGhpcy4kKCI8c3BhbiAvPiIpLmFkZENsYXNzKCJub3RpZnktaWNvbiIpOw0KICAgICAgICAgICAgbm90aWZ5VGV4dCA9IHRoaXMuJCgiPHNwYW4gLz4iKS5hZGRDbGFzcygibm90aWZ5LXRleHQiKTsNCiAgICAgICAgICAgIG5vdGlmeUJveC5hZGRDbGFzcygibm90aWZ5LWJveCIpOw0KICAgICAgICAgICAgaWYgKHRoaXMuJCgiLnRvdWNoLXZlcnNpb24iKS5sZW5ndGggIT09IDApIHsNCiAgICAgICAgICAgICAgICBub3RpZnlCb3guYWRkQ2xhc3MoInRvdWNoLXZlcnNpb24iKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmICghJHdyYXBwZXIuZmluZCgiLm5vdGlmeS1ib3giKS5sZW5ndGgpIHsNCiAgICAgICAgICAgICAgICAkd3JhcHBlci5wcmVwZW5kKG5vdGlmeUJveCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoIWlzVmlzaWJsZSkgew0KICAgICAgICAgICAgICAgIG5vdGlmeUJveC5hZGRDbGFzcygidmlzaWJsZSIpOw0KICAgICAgICAgICAgICAgIG5vdGlmeUJveC5hcHBlbmQobm90aWZ5SWNvbikuYXBwZW5kKG5vdGlmeVRleHQpOw0KICAgICAgICAgICAgICAgIG5vdGlmeVRleHQudGV4dChwbGFjZWhvbGRlclRleHQpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgbm90aWZ5Qm94LnJlbW92ZUNsYXNzKCJ2aXNpYmxlIik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICB0aGlzLnVwZGF0ZU5vdGlmeUJveFBvc2l0aW9uKG5vdGlmeUJveCwgcGxhY2Vob2xkZXIpOw0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUudXBkYXRlTm90aWZ5Qm94UG9zaXRpb24gPSBmdW5jdGlvbiAobm90aWZ5Qm94LCBwbGFjZWhvbGRlcikgew0KICAgICAgICAgICAgdmFyIGltYWdlID0gcGxhY2Vob2xkZXIucGFyZW50KCkuZmluZCgiLnpnLWRlbGlnaHRmdWwtZHJvcHBhYmxlLWltYWdlIiksIG5vdGlmeUJveFJlY3QsIHBsYWNlaG9sZGVyUmVjdCwga2V5Ow0KICAgICAgICAgICAgaWYgKGltYWdlLmxlbmd0aCA+IDApIHsNCiAgICAgICAgICAgICAgICBrZXkgPSBpbWFnZS5hdHRyKCJrZXkiKSArICIjIiArIGltYWdlLmF0dHIoInBvc2l0aW9uIik7DQogICAgICAgICAgICAgICAgaWYgKHRoaXMubm90aWZ5UGxhY2Vob2xkZXJzUG9zaXRpb25zLmhhc093blByb3BlcnR5KGtleSkpIHsNCiAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXJSZWN0ID0gdGhpcy5ub3RpZnlQbGFjZWhvbGRlcnNQb3NpdGlvbnNba2V5XTsNCiAgICAgICAgICAgICAgICAgICAgbm90aWZ5Qm94UmVjdCA9IHRoaXMubm90aWZ5Qm94UG9zaXRpb25zW2tleV07DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlclJlY3QgPSBpbWFnZVswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsNCiAgICAgICAgICAgICAgICAgICAgbm90aWZ5Qm94UmVjdCA9IG5vdGlmeUJveFswXS5nZXRDbGllbnRSZWN0cygpWzBdOw0KICAgICAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeVBsYWNlaG9sZGVyc1Bvc2l0aW9uc1trZXldID0gcGxhY2Vob2xkZXJSZWN0Ow0KICAgICAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeUJveFBvc2l0aW9uc1trZXldID0gbm90aWZ5Qm94UmVjdDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgbm90aWZ5Qm94LmNzcygibGVmdCIsIChwbGFjZWhvbGRlclJlY3QubGVmdCAtIG5vdGlmeUJveFJlY3Qud2lkdGggLyAyKSArICJweCIpOw0KICAgICAgICAgICAgICAgIG5vdGlmeUJveC5jc3MoInRvcCIsIChwbGFjZWhvbGRlclJlY3QudG9wIC0gbm90aWZ5Qm94LmhlaWdodCgpICogMykgKyAicHgiKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyUmVjdCA9IHBsYWNlaG9sZGVyWzBdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOw0KICAgICAgICAgICAgICAgIG5vdGlmeUJveC5jc3MoImxlZnQiLCBwbGFjZWhvbGRlclJlY3QubGVmdCAtIDEwICsgInB4Iik7DQogICAgICAgICAgICAgICAgbm90aWZ5Qm94LmNzcygidG9wIiwgcGxhY2Vob2xkZXJSZWN0LnRvcCAtIDEwICsgInB4Iik7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5zaG91bGRDcmVhdGVQbGFjZWhvbGRlciA9IGZ1bmN0aW9uIChyZW5kZXJpbmcsICRvcGVuQ29kZSkgew0KICAgICAgICAgICAgdmFyIGtleSA9ICRvcGVuQ29kZS5hdHRyKCJrZXkiKSwgY2hyb21lS2V5LCBjaHJvbWUsIGk7DQogICAgICAgICAgICBpZiAoJG9wZW5Db2RlLnNpYmxpbmdzKCIuc2NFbXB0eVBsYWNlaG9sZGVyW3NjLXBsYWNlaG9sZGVyLWlkPVwiIiArICRvcGVuQ29kZS5hdHRyKCJpZCIpICsgIlwiXSIpLmxlbmd0aCAhPT0gMCkgew0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmICh0aGlzLiQuaW5BcnJheShyZW5kZXJpbmcuZGF0YSgiaWQiKSwgdGhpcy5wbGFjZWhvbGRlcnNba2V5XSkgPT09IC0xKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMuY2hyb21lcy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgIGNocm9tZSA9IHRoaXMuY2hyb21lc1tpXTsNCiAgICAgICAgICAgICAgICBpZiAoY2hyb21lLl9vcmlnaW5hbERPTUVsZW1lbnQubGVuZ3RoID4gMCkgew0KICAgICAgICAgICAgICAgICAgICBjaHJvbWVLZXkgPSBjaHJvbWUuX29yaWdpbmFsRE9NRWxlbWVudFswXS5hdHRyaWJ1dGVzWyJrZXkiXTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKGNocm9tZUtleSAhPT0gdW5kZWZpbmVkICYmIGNocm9tZUtleSAhPT0gbnVsbCAmJiBjaHJvbWVLZXkudmFsdWUgPT09IGtleSAmJiBjaHJvbWUuZGF0YSAhPT0gdW5kZWZpbmVkICYmIGNocm9tZS5kYXRhLmN1c3RvbSAhPT0gdW5kZWZpbmVkICYmIGNocm9tZS5kYXRhLmN1c3RvbS5lZGl0YWJsZSA9PT0gImZhbHNlIikgew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5nZXRQbGFjZWhvbGRlcnNSZW5kZXJpbmdzID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCiAgICAgICAgICAgIHJldHVybiBTaXRlY29yZS5QYWdlTW9kZXMuRGVzaWduTWFuYWdlci5wbGFjZWhvbGRlcnMoKS5tYXAoZnVuY3Rpb24gKHBoKSB7DQogICAgICAgICAgICAgICAgdmFyIHJlbmRlcmluZ3MgPSBbXSwgaTsNCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcGguZWxlbWVudC5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMuJChwaC5lbGVtZW50W2ldKS5pcygiLmNvbXBvbmVudCwuanNvbi1jb21wb25lbnQtd3JhcHBlciIpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJpbmdzLnB1c2gocGguZWxlbWVudFtpXSk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgICAgICAgICAgbmFtZTogcGgudHlwZS5wbGFjZWhvbGRlcktleSgpLA0KICAgICAgICAgICAgICAgICAgICByZW5kZXJpbmdzOiByZW5kZXJpbmdzDQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9Ow0KICAgICAgICBTeGFNb3Zlci5wcm90b3R5cGUucG9zdE1vdmVBY3Rpb25zID0gZnVuY3Rpb24gKGNvbXBvbmVudCkgew0KICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50SUQgPSBjb21wb25lbnQub3BlbmluZ01hcmtlcigpLmF0dHIoImlkIik7DQogICAgICAgICAgICAgICAgU2l0ZWNvcmUuUGFnZU1vZGVzLlBhZ2VFZGl0b3IubGF5b3V0RGVmaW5pdGlvbkNvbnRyb2woKS52YWx1ZSA9IFNpdGVjb3JlLlBhZ2VNb2Rlcy5QYWdlRWRpdG9yLmxheW91dCgpLnZhbCgpOw0KICAgICAgICAgICAgICAgIFNpdGVjb3JlLlBhZ2VNb2Rlcy5DaHJvbWVNYW5hZ2VyLmhhbmRsZU1lc3NhZ2UoImNocm9tZTpyZW5kZXJpbmc6cHJvcGVydGllc2NvbXBsZXRlZCIsIHsgY29udHJvbElkOiBjb21wb25lbnRJRCB9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhdGNoIChlKSB7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIFN4YU1vdmVyLnByb3RvdHlwZS5nZXRQbGFjZWhvbGRlckZ1bGxQYXRoID0gZnVuY3Rpb24gKGNvbXBvbmVudCkgew0KICAgICAgICAgICAgdmFyIHBoID0gU2l0ZWNvcmUuTGF5b3V0RGVmaW5pdGlvbi5nZXRSZW5kZXJpbmcoY29tcG9uZW50LnR5cGUudW5pcXVlSWQoKSlbIkBwaCJdOw0KICAgICAgICAgICAgaWYgKHBoLmluZGV4T2YoIi8iKSA9PT0gMCkgew0KICAgICAgICAgICAgICAgIHJldHVybiBwaDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIHJldHVybiAiLyIgKyBwaDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICAgICAgU3hhTW92ZXIucHJvdG90eXBlLmdldFBsYWNlaG9sZGVyRnJvbUlkID0gZnVuY3Rpb24gKHBoSWQpIHsNCiAgICAgICAgICAgIHJldHVybiBTaXRlY29yZS5QYWdlTW9kZXMuRGVzaWduTWFuYWdlci5wbGFjZWhvbGRlcnMoKS5maWx0ZXIoZnVuY3Rpb24gKHApIHsgcmV0dXJuIChwLm9wZW5pbmdNYXJrZXIoKVswXS5pZCA9PT0gcGhJZC5yZXBsYWNlKC9cLy9nLCAiXyIpLnJlcGxhY2UoLy0vZywgIl8iKSk7IH0pOw0KICAgICAgICB9Ow0KICAgICAgICByZXR1cm4gU3hhTW92ZXI7DQogICAgfSgpKTsNCiAgICBTWEEuU3hhTW92ZXIgPSBTeGFNb3ZlcjsNCiAgICB2YXIgTW91c2VNYW5hZ2VyID0gKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgZnVuY3Rpb24gTW91c2VNYW5hZ2VyKCkgew0KICAgICAgICAgICAgdGhpcy5kcm9wUGxhY2VzID0gW107DQogICAgICAgICAgICB0aGlzLmRyb3BQbGFjZXNQb3NpdGlvbnMgPSB7fTsNCiAgICAgICAgICAgIHRoaXMudG9sbGVyYW5jZVggPSAxMDsNCiAgICAgICAgICAgIHRoaXMudG9sbGVyYW5jZVkgPSA1MDsNCiAgICAgICAgICAgIHRoaXMucmVmcmVzaFRpbWUgPSA1Ow0KICAgICAgICAgICAgdGhpcy5pbml0aWFsaXplZCA9IGZhbHNlOw0KICAgICAgICAgICAgdGhpcy5wcm9jZXNzZWRQbGFjZWhvbGRlckljb25zID0gW107DQogICAgICAgICAgICB0aGlzLnVzZUxpbmVQcm94aW1pdHkgPSB0cnVlOw0KICAgICAgICAgICAgdGhpcy4kID0galF1ZXJ5Ow0KICAgICAgICAgICAgdGhpcy5pbml0KCk7DQogICAgICAgIH0NCiAgICAgICAgTW91c2VNYW5hZ2VyLnByb3RvdHlwZS50cmFja0Ryb3BQbGFjZSA9IGZ1bmN0aW9uIChkcm9wUGxhY2UpIHsNCiAgICAgICAgICAgIHZhciBrZXkgPSBkcm9wUGxhY2UuYXR0cigia2V5IikgKyAiIyIgKyBkcm9wUGxhY2UuYXR0cigicG9zaXRpb24iKSwgc2Nyb2xsVG9wID0gZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCwgcmVjdCwgdGhhdCA9IHRoaXM7DQogICAgICAgICAgICBpZiAodGhpcy51c2VMaW5lUHJveGltaXR5KSB7DQogICAgICAgICAgICAgICAgZHJvcFBsYWNlID0gZHJvcFBsYWNlLm5leHQoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgIHRoaXMudG9sbGVyYW5jZVggPSAxMDA7DQogICAgICAgICAgICAgICAgdGhpcy50b2xsZXJhbmNlWSA9IDEwMDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMuaW5pdCgpOw0KICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgaWYgKHRoYXQuZHJvcFBsYWNlc1Bvc2l0aW9ucy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7DQogICAgICAgICAgICAgICAgICAgIHJlY3QgPSB0aGF0LmRyb3BQbGFjZXNQb3NpdGlvbnNba2V5XTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIHJlY3QgPSBkcm9wUGxhY2VbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7DQogICAgICAgICAgICAgICAgICAgIHRoYXQuZHJvcFBsYWNlc1Bvc2l0aW9uc1trZXldID0gcmVjdDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgdGhhdC5kcm9wUGxhY2VzLnB1c2goew0KICAgICAgICAgICAgICAgICAgICAiZHJvcFBsYWNlIjogZHJvcFBsYWNlLA0KICAgICAgICAgICAgICAgICAgICAidG9wIjogcmVjdC50b3AgKyBzY3JvbGxUb3AgLSB0aGF0LnRvbGxlcmFuY2VZLA0KICAgICAgICAgICAgICAgICAgICAiYm90dG9tIjogcmVjdC5ib3R0b20gKyBzY3JvbGxUb3AgKyB0aGF0LnRvbGxlcmFuY2VZLA0KICAgICAgICAgICAgICAgICAgICAibGVmdCI6IHJlY3QubGVmdCAtIHRoYXQudG9sbGVyYW5jZVgsDQogICAgICAgICAgICAgICAgICAgICJyaWdodCI6IHJlY3QucmlnaHQgKyB0aGF0LnRvbGxlcmFuY2VYDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9LCAwKTsNCiAgICAgICAgfTsNCiAgICAgICAgTW91c2VNYW5hZ2VyLnByb3RvdHlwZS5zdG9wVHJhY2tpbmcgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICB0aGlzLmRyb3BQbGFjZXMgPSBbXTsNCiAgICAgICAgICAgIHRoaXMuJChkb2N1bWVudCkudW5iaW5kKCJtb3VzZW1vdmUiKTsNCiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSBmYWxzZTsNCiAgICAgICAgICAgIHRoaXMucHJvY2Vzc2VkUGxhY2Vob2xkZXJJY29ucyA9IFtdOw0KICAgICAgICAgICAgdGhpcy5kcm9wUGxhY2VzUG9zaXRpb25zID0ge307DQogICAgICAgIH07DQogICAgICAgIE1vdXNlTWFuYWdlci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQogICAgICAgICAgICBpZiAoIXRoaXMuaW5pdGlhbGl6ZWQpIHsNCiAgICAgICAgICAgICAgICB0aGlzLiQoZG9jdW1lbnQpLm1vdXNlbW92ZShmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLnRpbWVyKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoX3RoaXMudGltZXIpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIF90aGlzLnRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy50cmFja01vdXNlUG9zaXRpb24oZXZlbnQpOw0KICAgICAgICAgICAgICAgICAgICB9LCBfdGhpcy5yZWZyZXNoVGltZSk7DQogICAgICAgICAgICAgICAgICAgIF90aGlzLmluaXRpYWxpemVkID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB0aGlzLiQod2luZG93KS5yZXNpemUoZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICBfdGhpcy5kcm9wUGxhY2VzUG9zaXRpb25zID0ge307DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgIE1vdXNlTWFuYWdlci5wcm90b3R5cGUudHJhY2tNb3VzZVBvc2l0aW9uID0gZnVuY3Rpb24gKGV2ZW50KSB7DQogICAgICAgICAgICB2YXIgZHJvcFBsYWNlRGF0YSwgc2hvd0VsZW1lbnRzID0gW10sIG5leHRUb0Ryb3BQbGFjZSwgbGVuZ3RoID0gdGhpcy5kcm9wUGxhY2VzLmxlbmd0aCwgaTsNCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgIGRyb3BQbGFjZURhdGEgPSB0aGlzLmRyb3BQbGFjZXNbaV07DQogICAgICAgICAgICAgICAgbmV4dFRvRHJvcFBsYWNlID0gdGhpcy51c2VMaW5lUHJveGltaXR5ID8gZHJvcFBsYWNlRGF0YS5kcm9wUGxhY2UucHJldigpIDogZHJvcFBsYWNlRGF0YS5kcm9wUGxhY2UubmV4dCgpOw0KICAgICAgICAgICAgICAgIGlmIChldmVudC5wYWdlWSA8IGRyb3BQbGFjZURhdGEuYm90dG9tICYmIGV2ZW50LnBhZ2VZID4gZHJvcFBsYWNlRGF0YS50b3AgJiYgZXZlbnQucGFnZVggPiBkcm9wUGxhY2VEYXRhLmxlZnQgJiYgZXZlbnQucGFnZVggPCBkcm9wUGxhY2VEYXRhLnJpZ2h0KSB7DQogICAgICAgICAgICAgICAgICAgIGRyb3BQbGFjZURhdGEuZHJvcFBsYWNlLmNzcygidmlzaWJpbGl0eSIsICJ2aXNpYmxlIik7DQogICAgICAgICAgICAgICAgICAgIG5leHRUb0Ryb3BQbGFjZS5jc3MoInZpc2liaWxpdHkiLCAidmlzaWJsZSIpOw0KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy51c2VMaW5lUHJveGltaXR5ICYmIG5leHRUb0Ryb3BQbGFjZS5sZW5ndGggPiAwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBzaG93RWxlbWVudHMucHVzaChuZXh0VG9Ecm9wUGxhY2UpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgc2hvd0VsZW1lbnRzLnB1c2goZHJvcFBsYWNlRGF0YS5kcm9wUGxhY2UpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGRyb3BQbGFjZURhdGEuZHJvcFBsYWNlLmNzcygidmlzaWJpbGl0eSIpID09PSAidmlzaWJsZSIpIHsNCiAgICAgICAgICAgICAgICAgICAgZHJvcFBsYWNlRGF0YS5kcm9wUGxhY2UuY3NzKCJ2aXNpYmlsaXR5IiwgImhpZGRlbiIpOw0KICAgICAgICAgICAgICAgICAgICBuZXh0VG9Ecm9wUGxhY2UuY3NzKCJ2aXNpYmlsaXR5IiwgImhpZGRlbiIpOw0KICAgICAgICAgICAgICAgICAgICBzaG93RWxlbWVudHMgPSBzaG93RWxlbWVudHMuZmlsdGVyKGZ1bmN0aW9uIChkcm9wUGxhY2UpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkcm9wUGxhY2UuYXR0cigia2V5IikgPT09ICh0aGlzLnVzZUxpbmVQcm94aW1pdHkgPyBkcm9wUGxhY2VEYXRhLmRyb3BQbGFjZS5wcmV2KCkuYXR0cigia2V5IikgOiBkcm9wUGxhY2VEYXRhLmRyb3BQbGFjZS5hdHRyKCJrZXkiKSk7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHRoaXMubW92ZURyb3BQbGFjZXMoc2hvd0VsZW1lbnRzKTsNCiAgICAgICAgfTsNCiAgICAgICAgTW91c2VNYW5hZ2VyLnByb3RvdHlwZS5jb2xsaWRlID0gZnVuY3Rpb24gKGdyb3VwRWxlbWVudHMsIGVsZW1lbnQpIHsNCiAgICAgICAgICAgIHZhciBpLCBlbGVtZW50VG9DaGVjazsNCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBncm91cEVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgICAgZWxlbWVudFRvQ2hlY2sgPSBncm91cEVsZW1lbnRzW2ldOw0KICAgICAgICAgICAgICAgIGlmIChlbGVtZW50VG9DaGVjay5oYXNDbGFzcygicG9zaXRpb24tdXBkYXRlZCIpIHx8IChlbGVtZW50VG9DaGVjay5hdHRyKCJrZXkiKSA9PT0gZWxlbWVudC5hdHRyKCJrZXkiKSAmJiBlbGVtZW50VG9DaGVjay5hdHRyKCJwb3NpdGlvbiIpID09PSBlbGVtZW50LmF0dHIoInBvc2l0aW9uIikpKSB7DQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBpZiAodGhpcy55SW5zdGVyc2VjdGlvbihlbGVtZW50VG9DaGVjaywgZWxlbWVudCkgJiYgdGhpcy54SW5zdGVyc2VjdGlvbihlbGVtZW50VG9DaGVjaywgZWxlbWVudCkpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICB9Ow0KICAgICAgICBNb3VzZU1hbmFnZXIucHJvdG90eXBlLmZpbmRTbWFsbGVzdFkgPSBmdW5jdGlvbiAoZGl2MCwgZGl2MSkgew0KICAgICAgICAgICAgcmV0dXJuIChkaXYwLm9mZnNldCgpLnRvcCA8IGRpdjEub2Zmc2V0KCkudG9wKSA/IGRpdjAgOiBkaXYxOw0KICAgICAgICB9Ow0KICAgICAgICBNb3VzZU1hbmFnZXIucHJvdG90eXBlLnlJbnN0ZXJzZWN0aW9uID0gZnVuY3Rpb24gKGRpdjAsIGRpdjEpIHsNCiAgICAgICAgICAgIHZhciBkaXZZMCA9IHRoaXMuZmluZFNtYWxsZXN0WShkaXYwLCBkaXYxKSwgZGl2WTEgPSAoZGl2MCAhPT0gZGl2WTApID8gZGl2MCA6IGRpdjE7DQogICAgICAgICAgICByZXR1cm4gKGRpdlkwLm9mZnNldCgpLnRvcCArIGRpdlkwLmhlaWdodCgpKSAtIGRpdlkxLm9mZnNldCgpLnRvcCA+IDA7DQogICAgICAgIH07DQogICAgICAgIE1vdXNlTWFuYWdlci5wcm90b3R5cGUuZmluZFNtYWxsZXN0WCA9IGZ1bmN0aW9uIChkaXYwLCBkaXYxKSB7DQogICAgICAgICAgICByZXR1cm4gKGRpdjAub2Zmc2V0KCkubGVmdCA8IGRpdjEub2Zmc2V0KCkubGVmdCkgPyBkaXYwIDogZGl2MTsNCiAgICAgICAgfTsNCiAgICAgICAgTW91c2VNYW5hZ2VyLnByb3RvdHlwZS54SW5zdGVyc2VjdGlvbiA9IGZ1bmN0aW9uIChkaXYwLCBkaXYxKSB7DQogICAgICAgICAgICB2YXIgZGl2WDAgPSB0aGlzLmZpbmRTbWFsbGVzdFgoZGl2MCwgZGl2MSksIGRpdlgxID0gKGRpdjAgIT09IGRpdlgwKSA/IGRpdjAgOiBkaXYxOw0KICAgICAgICAgICAgcmV0dXJuIChkaXZYMC5vZmZzZXQoKS5sZWZ0ICsgZGl2WDAud2lkdGgoKSkgLSBkaXZYMS5vZmZzZXQoKS5sZWZ0ID4gMDsNCiAgICAgICAgfTsNCiAgICAgICAgTW91c2VNYW5hZ2VyLnByb3RvdHlwZS5tb3ZlRHJvcFBsYWNlcyA9IGZ1bmN0aW9uIChzaG93RWxlbWVudHMpIHsNCiAgICAgICAgICAgIHZhciBpLCBrZXksIHBsYWNlaG9sZGVyS2V5LCBncm91cHMgPSB7fSwgZ3JvdXBFbGVtZW50cywgZ3JvdXBFbGVtZW50LCBwb3NpdGlvbiwgcG9zaXRpb25zLCBzaG93RWxlbWVudDsNCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzaG93RWxlbWVudHMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICBzaG93RWxlbWVudCA9IHNob3dFbGVtZW50c1tpXTsNCiAgICAgICAgICAgICAgICBrZXkgPSB0aGlzLm5vcm1hbGl6ZUtleShzaG93RWxlbWVudC5hdHRyKCJrZXkiKSk7DQogICAgICAgICAgICAgICAgaWYgKGdyb3Vwcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7DQogICAgICAgICAgICAgICAgICAgIGdyb3Vwc1trZXldLnB1c2goc2hvd0VsZW1lbnQpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgZ3JvdXBzW2tleV0gPSBbc2hvd0VsZW1lbnRdOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChzaG93RWxlbWVudHMubGVuZ3RoID4gMSkgew0KICAgICAgICAgICAgICAgIGZvciAocGxhY2Vob2xkZXJLZXkgaW4gZ3JvdXBzKSB7DQogICAgICAgICAgICAgICAgICAgIGlmIChncm91cHMuaGFzT3duUHJvcGVydHkocGxhY2Vob2xkZXJLZXkpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBncm91cEVsZW1lbnRzID0gZ3JvdXBzW3BsYWNlaG9sZGVyS2V5XTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucG9zaXRpb25zID0gW107DQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgZ3JvdXBFbGVtZW50cy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwRWxlbWVudCA9IGdyb3VwRWxlbWVudHNbaV07DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFncm91cEVsZW1lbnQuaGFzQ2xhc3MoInBvc2l0aW9uLXVwZGF0ZWQiKSAmJiB0aGlzLmNvbGxpZGUoZ3JvdXBFbGVtZW50cywgZ3JvdXBFbGVtZW50KSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uID0gcGFyc2VJbnQoZ3JvdXBFbGVtZW50c1swXS5jc3MoImxlZnQiKSkgLSAzNTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucG9zaXRpb25zLmluZGV4T2YodGhpcy5wb3NpdGlvbikgIT09IC0xKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uID0gdGhpcy5wb3NpdGlvbnNbdGhpcy5wb3NpdGlvbnMubGVuZ3RoIC0gMV0gLSAzNTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEVsZW1lbnQuY3NzKCJsZWZ0IiwgdGhpcy5wb3NpdGlvbik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwRWxlbWVudC5hZGRDbGFzcygicG9zaXRpb24tdXBkYXRlZCIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9ucy5wdXNoKHRoaXMucG9zaXRpb24pOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCiAgICAgICAgTW91c2VNYW5hZ2VyLnByb3RvdHlwZS5ub3JtYWxpemVLZXkgPSBmdW5jdGlvbiAoa2V5KSB7DQogICAgICAgICAgICBpZiAoa2V5LmluZGV4T2YoIi8iKSA9PT0gMCkgew0KICAgICAgICAgICAgICAgIGtleSA9IGtleS5zdWJzdHIoMSwga2V5Lmxlbmd0aCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoa2V5LmluZGV4T2YoIi8iKSAhPT0gLTEpIHsNCiAgICAgICAgICAgICAgICBrZXkgPSBrZXkuc3Vic3RyKDAsIGtleS5pbmRleE9mKCIvIikpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmV0dXJuIGtleTsNCiAgICAgICAgfTsNCiAgICAgICAgcmV0dXJuIE1vdXNlTWFuYWdlcjsNCiAgICB9KCkpOw0KfSkoU1hBIHx8IChTWEEgPSB7fSkpOw0KKGZ1bmN0aW9uIChTWEEpIHsNCiAgICB2YXIgRmVhdHVyZTsNCiAgICAoZnVuY3Rpb24gKEZlYXR1cmUpIHsNCiAgICAgICAgdmFyIENvbXBvc2l0ZXM7DQogICAgICAgIChmdW5jdGlvbiAoQ29tcG9zaXRlcykgew0KICAgICAgICAgICAgdmFyIENvbXBvc2l0ZVBsYWNlaG9sZGVyVmFsaWRhdG9yID0gKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBDb21wb3NpdGVQbGFjZWhvbGRlclZhbGlkYXRvcigpIHsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgQ29tcG9zaXRlUGxhY2Vob2xkZXJWYWxpZGF0b3IucHJvdG90eXBlLkdldENvbXBvc2l0ZUlkID0gZnVuY3Rpb24gKHBsYWNlaG9sZGVyKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBzZWN0aW9uID0gbmV3IFBsYWNlaG9sZGVyKHBsYWNlaG9sZGVyKS5HZXRDb21wb3NpdGVTZWN0aW9uUGxhY2Vob2xkZXIoKTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKHNlY3Rpb24gIT0gbnVsbCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXAgPSBzZWN0aW9uLm1hdGNoKC8oc2VjdGlvbi1bXHddKy0pXGQrLVxkKy9nKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZGVudGlmaWVycyA9IHRlbXBbMF0ucmVwbGFjZSgvc2VjdGlvbi1bXHddKy0vZywgIiIpLnNwbGl0KCctJyk7DQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZHNJdGVtSW5kZXggPSBpZGVudGlmaWVyc1swXTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkeW5hbWljUGhJRCA9IGlkZW50aWZpZXJzWzFdOw0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbXBvc2l0ZVBsYWNlaG9sZGVyTmFtZSA9IG5ldyBQbGFjZWhvbGRlcihwbGFjZWhvbGRlcikuR2V0Q29tcG9zaXRlUGxhY2Vob2xkZXJOYW1lKCk7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29tcG9zaXRlUGxhY2Vob2xkZXJOYW1lICsgIi0iICsgZHNJdGVtSW5kZXggKyBkeW5hbWljUGhJRDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gIiI7DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICBDb21wb3NpdGVQbGFjZWhvbGRlclZhbGlkYXRvci5wcm90b3R5cGUudmFsaWRhdGUgPSBmdW5jdGlvbiAocGhYLCBwaFkpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHBhZ2VFZGl0b3IgPSBTaXRlY29yZS5QYWdlTW9kZXMuUGFnZUVkaXRvcjsNCiAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2VFZGl0b3IgPT0gbnVsbCB8fCBwYWdlRWRpdG9yLm9uUGFnZUVkaXRpbmdPZkNvbXBvc2l0ZXMgPT0gbnVsbCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICh0aGlzLkdldENvbXBvc2l0ZUlkKHBoWCkgPT0gdGhpcy5HZXRDb21wb3NpdGVJZChwaFkpKTsNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIHJldHVybiBDb21wb3NpdGVQbGFjZWhvbGRlclZhbGlkYXRvcjsNCiAgICAgICAgICAgIH0oKSk7DQogICAgICAgICAgICBDb21wb3NpdGVzLkNvbXBvc2l0ZVBsYWNlaG9sZGVyVmFsaWRhdG9yID0gQ29tcG9zaXRlUGxhY2Vob2xkZXJWYWxpZGF0b3I7DQogICAgICAgICAgICB2YXIgUGxhY2Vob2xkZXIgPSAoZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIFBsYWNlaG9sZGVyKHBsYWNlaG9sZGVyKSB7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuUGFydHMgPSBwbGFjZWhvbGRlci5zcGxpdCgnLycpOw0KICAgICAgICAgICAgICAgICAgICB0aGlzLlBhcnRzID0gdGhpcy5QYXJ0cy5maWx0ZXIoZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHYgIT09ICcnOyB9KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgUGxhY2Vob2xkZXIucHJvdG90eXBlLkdldExhc3RQbGFjZWhvbGRlck5hbWUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLlBhcnRzLnNsaWNlKC0xKVswXTsNCiAgICAgICAgICAgICAgICB9Ow0KICAgICAgICAgICAgICAgIFBsYWNlaG9sZGVyLnByb3RvdHlwZS5HZXRQYXJlbnRQbGFjZWhvbGRlck5hbWUgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgIGlmICgodGhpcy5QYXJ0cy5sZW5ndGggPiAxKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuUGFydHNbKHRoaXMuUGFydHMubGVuZ3RoIC0gMildOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLlBhcnRzWzBdOw0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgUGxhY2Vob2xkZXIucHJvdG90eXBlLkdldFBhcmVudFBsYWNlaG9sZGVyUGF0aCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKCh0aGlzLlBhcnRzLmxlbmd0aCA+IDEpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFydHMgPSB0aGlzLlBhcnRzLnNsaWNlKDAsICh0aGlzLlBhcnRzLmxlbmd0aCAtIDEpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgocGFydHMubGVuZ3RoID09IDEpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oIi8iKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAiLyIgKyBwYXJ0cy5qb2luKCIvIik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuUGFydHNbMF07DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICBQbGFjZWhvbGRlci5wcm90b3R5cGUuR2V0UGxhY2Vob2xkZXJQYXRoID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICBpZiAoKHRoaXMuUGFydHMgIT0gbnVsbCkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodGhpcy5QYXJ0cy5sZW5ndGggPT0gMSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5QYXJ0c1swXTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAiLyIgKyB0aGlzLlBhcnRzLmpvaW4oIi8iKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gIiI7DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICBQbGFjZWhvbGRlci5wcm90b3R5cGUuR2V0Q29tcG9zaXRlU2VjdGlvblBsYWNlaG9sZGVyTmFtZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzSW5TaGFwZVR5cGU7DQogICAgICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuUGFydHMubGVuZ3RoIC0gMTsNCiAgICAgICAgICAgICAgICAgICAgZm9yICg7IGluZGV4ID49IDA7IGluZGV4LS0pIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLlBhcnRzW2luZGV4XS5tYXRjaCgvc2VjdGlvbi1bdGl0bGV8Y29udGVudF0rLVxkKy1cZCsvZykpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0luU2hhcGVUeXBlID0gdGhpcy5QYXJ0c1tpbmRleF07DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByZXZpb3VzSW5TaGFwZVR5cGU7DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICBQbGFjZWhvbGRlci5wcm90b3R5cGUuR2V0Q29tcG9zaXRlU2VjdGlvblBsYWNlaG9sZGVyID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcCA9IG5ldyBQbGFjZWhvbGRlcigiIik7DQogICAgICAgICAgICAgICAgICAgIHRoaXMuUGFydHMuZm9yRWFjaChmdW5jdGlvbiAoZSkgeyB0ZW1wLlBhcnRzLnB1c2goZSk7IH0pOw0KICAgICAgICAgICAgICAgICAgICB2YXIgc2VjdGlvbiA9IHRlbXAuR2V0Q29tcG9zaXRlU2VjdGlvblBsYWNlaG9sZGVyTmFtZSgpOw0KICAgICAgICAgICAgICAgICAgICBpZiAoKHNlY3Rpb24gIT0gbnVsbCkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHRlbXAuUGFydHMubGFzdEluZGV4T2Yoc2VjdGlvbik7DQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgKGkgPCBpbmRleCk7IGkrKykgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXAuUGFydHMuc2hpZnQoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0ZW1wLkdldFBsYWNlaG9sZGVyUGF0aCgpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOw0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgUGxhY2Vob2xkZXIucHJvdG90eXBlLkdldENvbXBvc2l0ZVBsYWNlaG9sZGVyTmFtZSA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIG5lYXJlc3RDb21wb3NpdGVTZWN0aW9uUGxhY2Vob2xkZXIgPSB0aGlzLkdldENvbXBvc2l0ZVNlY3Rpb25QbGFjZWhvbGRlck5hbWUoKTsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHNlY3Rpb25JbmRleCA9IHRoaXMuUGFydHMubGFzdEluZGV4T2YobmVhcmVzdENvbXBvc2l0ZVNlY3Rpb25QbGFjZWhvbGRlcik7DQogICAgICAgICAgICAgICAgICAgIGlmICgoc2VjdGlvbkluZGV4ID49IDEpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5QYXJ0c1soc2VjdGlvbkluZGV4IC0gMSldOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOw0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgcmV0dXJuIFBsYWNlaG9sZGVyOw0KICAgICAgICAgICAgfSgpKTsNCiAgICAgICAgICAgIENvbXBvc2l0ZXMuUGxhY2Vob2xkZXIgPSBQbGFjZWhvbGRlcjsNCiAgICAgICAgfSkoQ29tcG9zaXRlcyA9IEZlYXR1cmUuQ29tcG9zaXRlcyB8fCAoRmVhdHVyZS5Db21wb3NpdGVzID0ge30pKTsNCiAgICB9KShGZWF0dXJlID0gU1hBLkZlYXR1cmUgfHwgKFNYQS5GZWF0dXJlID0ge30pKTsNCn0pKFNYQSB8fCAoU1hBID0ge30pKTsNCg==
- ID: "6954b7c7-2487-423f-8600-436cb3b6dc0e"
  Hint: Size
  Value: 54844
- ID: "6f47a0a5-9c94-4b48-abeb-42d38def6054"
  Hint: Mime Type
  Value: "application/x-javascript"
- ID: "ba3f86a2-4a1c-4d78-b63d-91c2779c1b5e"
  Hint: __Sortorder
  Value: 0
- ID: "c06867fe-9a43-4c7d-b739-48780492d06f"
  Hint: Extension
  Value: js
Languages:
- Language: en
  Versions:
  - Version: 1
    Fields:
    - ID: "25bed78c-4957-4165-998a-ca1b52f67497"
      Hint: __Created
      Value: 20160509T085812Z
